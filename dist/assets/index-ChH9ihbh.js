function kw(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const i in n)if(i!=="default"&&!(i in r)){const a=Object.getOwnPropertyDescriptor(n,i);a&&Object.defineProperty(r,i,a.get?a:{enumerable:!0,get:()=>n[i]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();var Pw=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ad(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var $S={exports:{}},Dd={},WS={exports:{}},Le={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var hl=Symbol.for("react.element"),Mw=Symbol.for("react.portal"),Aw=Symbol.for("react.fragment"),Dw=Symbol.for("react.strict_mode"),xw=Symbol.for("react.profiler"),Nw=Symbol.for("react.provider"),Lw=Symbol.for("react.context"),Uw=Symbol.for("react.forward_ref"),jw=Symbol.for("react.suspense"),Fw=Symbol.for("react.memo"),Bw=Symbol.for("react.lazy"),fm=Symbol.iterator;function $w(r){return r===null||typeof r!="object"?null:(r=fm&&r[fm]||r["@@iterator"],typeof r=="function"?r:null)}var KS={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},VS=Object.assign,GS={};function Rs(r,e,t){this.props=r,this.context=e,this.refs=GS,this.updater=t||KS}Rs.prototype.isReactComponent={};Rs.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")};Rs.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function qS(){}qS.prototype=Rs.prototype;function Uv(r,e,t){this.props=r,this.context=e,this.refs=GS,this.updater=t||KS}var jv=Uv.prototype=new qS;jv.constructor=Uv;VS(jv,Rs.prototype);jv.isPureReactComponent=!0;var vm=Array.isArray,HS=Object.prototype.hasOwnProperty,Fv={current:null},zS={key:!0,ref:!0,__self:!0,__source:!0};function JS(r,e,t){var n,i={},a=null,s=null;if(e!=null)for(n in e.ref!==void 0&&(s=e.ref),e.key!==void 0&&(a=""+e.key),e)HS.call(e,n)&&!zS.hasOwnProperty(n)&&(i[n]=e[n]);var o=arguments.length-2;if(o===1)i.children=t;else if(1<o){for(var l=Array(o),u=0;u<o;u++)l[u]=arguments[u+2];i.children=l}if(r&&r.defaultProps)for(n in o=r.defaultProps,o)i[n]===void 0&&(i[n]=o[n]);return{$$typeof:hl,type:r,key:a,ref:s,props:i,_owner:Fv.current}}function Ww(r,e){return{$$typeof:hl,type:r.type,key:e,ref:r.ref,props:r.props,_owner:r._owner}}function Bv(r){return typeof r=="object"&&r!==null&&r.$$typeof===hl}function Kw(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}var pm=/\/+/g;function Tc(r,e){return typeof r=="object"&&r!==null&&r.key!=null?Kw(""+r.key):e.toString(36)}function hu(r,e,t,n,i){var a=typeof r;(a==="undefined"||a==="boolean")&&(r=null);var s=!1;if(r===null)s=!0;else switch(a){case"string":case"number":s=!0;break;case"object":switch(r.$$typeof){case hl:case Mw:s=!0}}if(s)return s=r,i=i(s),r=n===""?"."+Tc(s,0):n,vm(i)?(t="",r!=null&&(t=r.replace(pm,"$&/")+"/"),hu(i,e,t,"",function(u){return u})):i!=null&&(Bv(i)&&(i=Ww(i,t+(!i.key||s&&s.key===i.key?"":(""+i.key).replace(pm,"$&/")+"/")+r)),e.push(i)),1;if(s=0,n=n===""?".":n+":",vm(r))for(var o=0;o<r.length;o++){a=r[o];var l=n+Tc(a,o);s+=hu(a,e,t,l,i)}else if(l=$w(r),typeof l=="function")for(r=l.call(r),o=0;!(a=r.next()).done;)a=a.value,l=n+Tc(a,o++),s+=hu(a,e,t,l,i);else if(a==="object")throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return s}function Nl(r,e,t){if(r==null)return r;var n=[],i=0;return hu(r,n,"","",function(a){return e.call(t,a,i++)}),n}function Vw(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}var tr={current:null},fu={transition:null},Gw={ReactCurrentDispatcher:tr,ReactCurrentBatchConfig:fu,ReactCurrentOwner:Fv};function YS(){throw Error("act(...) is not supported in production builds of React.")}Le.Children={map:Nl,forEach:function(r,e,t){Nl(r,function(){e.apply(this,arguments)},t)},count:function(r){var e=0;return Nl(r,function(){e++}),e},toArray:function(r){return Nl(r,function(e){return e})||[]},only:function(r){if(!Bv(r))throw Error("React.Children.only expected to receive a single React element child.");return r}};Le.Component=Rs;Le.Fragment=Aw;Le.Profiler=xw;Le.PureComponent=Uv;Le.StrictMode=Dw;Le.Suspense=jw;Le.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Gw;Le.act=YS;Le.cloneElement=function(r,e,t){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var n=VS({},r.props),i=r.key,a=r.ref,s=r._owner;if(e!=null){if(e.ref!==void 0&&(a=e.ref,s=Fv.current),e.key!==void 0&&(i=""+e.key),r.type&&r.type.defaultProps)var o=r.type.defaultProps;for(l in e)HS.call(e,l)&&!zS.hasOwnProperty(l)&&(n[l]=e[l]===void 0&&o!==void 0?o[l]:e[l])}var l=arguments.length-2;if(l===1)n.children=t;else if(1<l){o=Array(l);for(var u=0;u<l;u++)o[u]=arguments[u+2];n.children=o}return{$$typeof:hl,type:r.type,key:i,ref:a,props:n,_owner:s}};Le.createContext=function(r){return r={$$typeof:Lw,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:Nw,_context:r},r.Consumer=r};Le.createElement=JS;Le.createFactory=function(r){var e=JS.bind(null,r);return e.type=r,e};Le.createRef=function(){return{current:null}};Le.forwardRef=function(r){return{$$typeof:Uw,render:r}};Le.isValidElement=Bv;Le.lazy=function(r){return{$$typeof:Bw,_payload:{_status:-1,_result:r},_init:Vw}};Le.memo=function(r,e){return{$$typeof:Fw,type:r,compare:e===void 0?null:e}};Le.startTransition=function(r){var e=fu.transition;fu.transition={};try{r()}finally{fu.transition=e}};Le.unstable_act=YS;Le.useCallback=function(r,e){return tr.current.useCallback(r,e)};Le.useContext=function(r){return tr.current.useContext(r)};Le.useDebugValue=function(){};Le.useDeferredValue=function(r){return tr.current.useDeferredValue(r)};Le.useEffect=function(r,e){return tr.current.useEffect(r,e)};Le.useId=function(){return tr.current.useId()};Le.useImperativeHandle=function(r,e,t){return tr.current.useImperativeHandle(r,e,t)};Le.useInsertionEffect=function(r,e){return tr.current.useInsertionEffect(r,e)};Le.useLayoutEffect=function(r,e){return tr.current.useLayoutEffect(r,e)};Le.useMemo=function(r,e){return tr.current.useMemo(r,e)};Le.useReducer=function(r,e,t){return tr.current.useReducer(r,e,t)};Le.useRef=function(r){return tr.current.useRef(r)};Le.useState=function(r){return tr.current.useState(r)};Le.useSyncExternalStore=function(r,e,t){return tr.current.useSyncExternalStore(r,e,t)};Le.useTransition=function(){return tr.current.useTransition()};Le.version="18.3.1";WS.exports=Le;var G=WS.exports;const $v=Ad(G),qw=kw({__proto__:null,default:$v},[G]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Hw=G,zw=Symbol.for("react.element"),Jw=Symbol.for("react.fragment"),Yw=Object.prototype.hasOwnProperty,Qw=Hw.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Xw={key:!0,ref:!0,__self:!0,__source:!0};function QS(r,e,t){var n,i={},a=null,s=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(s=e.ref);for(n in e)Yw.call(e,n)&&!Xw.hasOwnProperty(n)&&(i[n]=e[n]);if(r&&r.defaultProps)for(n in e=r.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:zw,type:r,key:a,ref:s,props:i,_owner:Qw.current}}Dd.Fragment=Jw;Dd.jsx=QS;Dd.jsxs=QS;$S.exports=Dd;var _=$S.exports,XS={exports:{}},Tr={},ZS={exports:{}},eE={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(r){function e(re,he){var ye=re.length;re.push(he);e:for(;0<ye;){var Ne=ye-1>>>1,J=re[Ne];if(0<i(J,he))re[Ne]=he,re[ye]=J,ye=Ne;else break e}}function t(re){return re.length===0?null:re[0]}function n(re){if(re.length===0)return null;var he=re[0],ye=re.pop();if(ye!==he){re[0]=ye;e:for(var Ne=0,J=re.length,te=J>>>1;Ne<te;){var L=2*(Ne+1)-1,D=re[L],A=L+1,M=re[A];if(0>i(D,ye))A<J&&0>i(M,D)?(re[Ne]=M,re[A]=ye,Ne=A):(re[Ne]=D,re[L]=ye,Ne=L);else if(A<J&&0>i(M,ye))re[Ne]=M,re[A]=ye,Ne=A;else break e}}return he}function i(re,he){var ye=re.sortIndex-he.sortIndex;return ye!==0?ye:re.id-he.id}if(typeof performance=="object"&&typeof performance.now=="function"){var a=performance;r.unstable_now=function(){return a.now()}}else{var s=Date,o=s.now();r.unstable_now=function(){return s.now()-o}}var l=[],u=[],d=1,h=null,f=3,m=!1,v=!1,y=!1,I=typeof setTimeout=="function"?setTimeout:null,g=typeof clearTimeout=="function"?clearTimeout:null,p=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function b(re){for(var he=t(u);he!==null;){if(he.callback===null)n(u);else if(he.startTime<=re)n(u),he.sortIndex=he.expirationTime,e(l,he);else break;he=t(u)}}function R(re){if(y=!1,b(re),!v)if(t(l)!==null)v=!0,Me(P);else{var he=t(u);he!==null&&je(R,he.startTime-re)}}function P(re,he){v=!1,y&&(y=!1,g(S),S=-1),m=!0;var ye=f;try{for(b(he),h=t(l);h!==null&&(!(h.expirationTime>he)||re&&!z());){var Ne=h.callback;if(typeof Ne=="function"){h.callback=null,f=h.priorityLevel;var J=Ne(h.expirationTime<=he);he=r.unstable_now(),typeof J=="function"?h.callback=J:h===t(l)&&n(l),b(he)}else n(l);h=t(l)}if(h!==null)var te=!0;else{var L=t(u);L!==null&&je(R,L.startTime-he),te=!1}return te}finally{h=null,f=ye,m=!1}}var E=!1,C=null,S=-1,x=5,K=-1;function z(){return!(r.unstable_now()-K<x)}function oe(){if(C!==null){var re=r.unstable_now();K=re;var he=!0;try{he=C(!0,re)}finally{he?ge():(E=!1,C=null)}}else E=!1}var ge;if(typeof p=="function")ge=function(){p(oe)};else if(typeof MessageChannel<"u"){var xe=new MessageChannel,_e=xe.port2;xe.port1.onmessage=oe,ge=function(){_e.postMessage(null)}}else ge=function(){I(oe,0)};function Me(re){C=re,E||(E=!0,ge())}function je(re,he){S=I(function(){re(r.unstable_now())},he)}r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(re){re.callback=null},r.unstable_continueExecution=function(){v||m||(v=!0,Me(P))},r.unstable_forceFrameRate=function(re){0>re||125<re?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):x=0<re?Math.floor(1e3/re):5},r.unstable_getCurrentPriorityLevel=function(){return f},r.unstable_getFirstCallbackNode=function(){return t(l)},r.unstable_next=function(re){switch(f){case 1:case 2:case 3:var he=3;break;default:he=f}var ye=f;f=he;try{return re()}finally{f=ye}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(re,he){switch(re){case 1:case 2:case 3:case 4:case 5:break;default:re=3}var ye=f;f=re;try{return he()}finally{f=ye}},r.unstable_scheduleCallback=function(re,he,ye){var Ne=r.unstable_now();switch(typeof ye=="object"&&ye!==null?(ye=ye.delay,ye=typeof ye=="number"&&0<ye?Ne+ye:Ne):ye=Ne,re){case 1:var J=-1;break;case 2:J=250;break;case 5:J=1073741823;break;case 4:J=1e4;break;default:J=5e3}return J=ye+J,re={id:d++,callback:he,priorityLevel:re,startTime:ye,expirationTime:J,sortIndex:-1},ye>Ne?(re.sortIndex=ye,e(u,re),t(l)===null&&re===t(u)&&(y?(g(S),S=-1):y=!0,je(R,ye-Ne))):(re.sortIndex=J,e(l,re),v||m||(v=!0,Me(P))),re},r.unstable_shouldYield=z,r.unstable_wrapCallback=function(re){var he=f;return function(){var ye=f;f=he;try{return re.apply(this,arguments)}finally{f=ye}}}})(eE);ZS.exports=eE;var Zw=ZS.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eT=G,wr=Zw;function ne(r){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+r,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+r+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var tE=new Set,Ao={};function fa(r,e){os(r,e),os(r+"Capture",e)}function os(r,e){for(Ao[r]=e,r=0;r<e.length;r++)tE.add(e[r])}var Un=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Oh=Object.prototype.hasOwnProperty,tT=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,mm={},gm={};function rT(r){return Oh.call(gm,r)?!0:Oh.call(mm,r)?!1:tT.test(r)?gm[r]=!0:(mm[r]=!0,!1)}function nT(r,e,t,n){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:t!==null?!t.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}function iT(r,e,t,n){if(e===null||typeof e>"u"||nT(r,e,t,n))return!0;if(n)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function rr(r,e,t,n,i,a,s){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=r,this.type=e,this.sanitizeURL=a,this.removeEmptyString=s}var $t={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){$t[r]=new rr(r,0,!1,r,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var e=r[0];$t[e]=new rr(e,1,!1,r[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(r){$t[r]=new rr(r,2,!1,r.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){$t[r]=new rr(r,2,!1,r,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){$t[r]=new rr(r,3,!1,r.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(r){$t[r]=new rr(r,3,!0,r,null,!1,!1)});["capture","download"].forEach(function(r){$t[r]=new rr(r,4,!1,r,null,!1,!1)});["cols","rows","size","span"].forEach(function(r){$t[r]=new rr(r,6,!1,r,null,!1,!1)});["rowSpan","start"].forEach(function(r){$t[r]=new rr(r,5,!1,r.toLowerCase(),null,!1,!1)});var Wv=/[\-:]([a-z])/g;function Kv(r){return r[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var e=r.replace(Wv,Kv);$t[e]=new rr(e,1,!1,r,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var e=r.replace(Wv,Kv);$t[e]=new rr(e,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(r){var e=r.replace(Wv,Kv);$t[e]=new rr(e,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(r){$t[r]=new rr(r,1,!1,r.toLowerCase(),null,!1,!1)});$t.xlinkHref=new rr("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(r){$t[r]=new rr(r,1,!1,r.toLowerCase(),null,!0,!0)});function Vv(r,e,t,n){var i=$t.hasOwnProperty(e)?$t[e]:null;(i!==null?i.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(iT(e,t,i,n)&&(t=null),n||i===null?rT(e)&&(t===null?r.removeAttribute(e):r.setAttribute(e,""+t)):i.mustUseProperty?r[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,n=i.attributeNamespace,t===null?r.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,n?r.setAttributeNS(n,e,t):r.setAttribute(e,t))))}var $n=eT.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Ll=Symbol.for("react.element"),Pa=Symbol.for("react.portal"),Ma=Symbol.for("react.fragment"),Gv=Symbol.for("react.strict_mode"),kh=Symbol.for("react.profiler"),rE=Symbol.for("react.provider"),nE=Symbol.for("react.context"),qv=Symbol.for("react.forward_ref"),Ph=Symbol.for("react.suspense"),Mh=Symbol.for("react.suspense_list"),Hv=Symbol.for("react.memo"),ti=Symbol.for("react.lazy"),iE=Symbol.for("react.offscreen"),ym=Symbol.iterator;function Us(r){return r===null||typeof r!="object"?null:(r=ym&&r[ym]||r["@@iterator"],typeof r=="function"?r:null)}var ft=Object.assign,Rc;function io(r){if(Rc===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);Rc=e&&e[1]||""}return`
`+Rc+r}var Ic=!1;function Cc(r,e){if(!r||Ic)return"";Ic=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(u){var n=u}Reflect.construct(r,[],e)}else{try{e.call()}catch(u){n=u}r.call(e.prototype)}else{try{throw Error()}catch(u){n=u}r()}}catch(u){if(u&&n&&typeof u.stack=="string"){for(var i=u.stack.split(`
`),a=n.stack.split(`
`),s=i.length-1,o=a.length-1;1<=s&&0<=o&&i[s]!==a[o];)o--;for(;1<=s&&0<=o;s--,o--)if(i[s]!==a[o]){if(s!==1||o!==1)do if(s--,o--,0>o||i[s]!==a[o]){var l=`
`+i[s].replace(" at new "," at ");return r.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",r.displayName)),l}while(1<=s&&0<=o);break}}}finally{Ic=!1,Error.prepareStackTrace=t}return(r=r?r.displayName||r.name:"")?io(r):""}function aT(r){switch(r.tag){case 5:return io(r.type);case 16:return io("Lazy");case 13:return io("Suspense");case 19:return io("SuspenseList");case 0:case 2:case 15:return r=Cc(r.type,!1),r;case 11:return r=Cc(r.type.render,!1),r;case 1:return r=Cc(r.type,!0),r;default:return""}}function Ah(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case Ma:return"Fragment";case Pa:return"Portal";case kh:return"Profiler";case Gv:return"StrictMode";case Ph:return"Suspense";case Mh:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case nE:return(r.displayName||"Context")+".Consumer";case rE:return(r._context.displayName||"Context")+".Provider";case qv:var e=r.render;return r=r.displayName,r||(r=e.displayName||e.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case Hv:return e=r.displayName||null,e!==null?e:Ah(r.type)||"Memo";case ti:e=r._payload,r=r._init;try{return Ah(r(e))}catch{}}return null}function sT(r){var e=r.type;switch(r.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=e.render,r=r.displayName||r.name||"",e.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return Ah(e);case 8:return e===Gv?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function Ti(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function aE(r){var e=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function oT(r){var e=aE(r)?"checked":"value",t=Object.getOwnPropertyDescriptor(r.constructor.prototype,e),n=""+r[e];if(!r.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,a=t.set;return Object.defineProperty(r,e,{configurable:!0,get:function(){return i.call(this)},set:function(s){n=""+s,a.call(this,s)}}),Object.defineProperty(r,e,{enumerable:t.enumerable}),{getValue:function(){return n},setValue:function(s){n=""+s},stopTracking:function(){r._valueTracker=null,delete r[e]}}}}function Ul(r){r._valueTracker||(r._valueTracker=oT(r))}function sE(r){if(!r)return!1;var e=r._valueTracker;if(!e)return!0;var t=e.getValue(),n="";return r&&(n=aE(r)?r.checked?"true":"false":r.value),r=n,r!==t?(e.setValue(r),!0):!1}function Fu(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}function Dh(r,e){var t=e.checked;return ft({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??r._wrapperState.initialChecked})}function Sm(r,e){var t=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;t=Ti(e.value!=null?e.value:t),r._wrapperState={initialChecked:n,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function oE(r,e){e=e.checked,e!=null&&Vv(r,"checked",e,!1)}function xh(r,e){oE(r,e);var t=Ti(e.value),n=e.type;if(t!=null)n==="number"?(t===0&&r.value===""||r.value!=t)&&(r.value=""+t):r.value!==""+t&&(r.value=""+t);else if(n==="submit"||n==="reset"){r.removeAttribute("value");return}e.hasOwnProperty("value")?Nh(r,e.type,t):e.hasOwnProperty("defaultValue")&&Nh(r,e.type,Ti(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(r.defaultChecked=!!e.defaultChecked)}function Em(r,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+r._wrapperState.initialValue,t||e===r.value||(r.value=e),r.defaultValue=e}t=r.name,t!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,t!==""&&(r.name=t)}function Nh(r,e,t){(e!=="number"||Fu(r.ownerDocument)!==r)&&(t==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+t&&(r.defaultValue=""+t))}var ao=Array.isArray;function Ga(r,e,t,n){if(r=r.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<r.length;t++)i=e.hasOwnProperty("$"+r[t].value),r[t].selected!==i&&(r[t].selected=i),i&&n&&(r[t].defaultSelected=!0)}else{for(t=""+Ti(t),e=null,i=0;i<r.length;i++){if(r[i].value===t){r[i].selected=!0,n&&(r[i].defaultSelected=!0);return}e!==null||r[i].disabled||(e=r[i])}e!==null&&(e.selected=!0)}}function Lh(r,e){if(e.dangerouslySetInnerHTML!=null)throw Error(ne(91));return ft({},e,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}function _m(r,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(ne(92));if(ao(t)){if(1<t.length)throw Error(ne(93));t=t[0]}e=t}e==null&&(e=""),t=e}r._wrapperState={initialValue:Ti(t)}}function lE(r,e){var t=Ti(e.value),n=Ti(e.defaultValue);t!=null&&(t=""+t,t!==r.value&&(r.value=t),e.defaultValue==null&&r.defaultValue!==t&&(r.defaultValue=t)),n!=null&&(r.defaultValue=""+n)}function bm(r){var e=r.textContent;e===r._wrapperState.initialValue&&e!==""&&e!==null&&(r.value=e)}function uE(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Uh(r,e){return r==null||r==="http://www.w3.org/1999/xhtml"?uE(e):r==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":r}var jl,dE=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction(function(){return r(e,t,n,i)})}:r}(function(r,e){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=e;else{for(jl=jl||document.createElement("div"),jl.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=jl.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;e.firstChild;)r.appendChild(e.firstChild)}});function Do(r,e){if(e){var t=r.firstChild;if(t&&t===r.lastChild&&t.nodeType===3){t.nodeValue=e;return}}r.textContent=e}var fo={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},lT=["Webkit","ms","Moz","O"];Object.keys(fo).forEach(function(r){lT.forEach(function(e){e=e+r.charAt(0).toUpperCase()+r.substring(1),fo[e]=fo[r]})});function cE(r,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||fo.hasOwnProperty(r)&&fo[r]?(""+e).trim():e+"px"}function hE(r,e){r=r.style;for(var t in e)if(e.hasOwnProperty(t)){var n=t.indexOf("--")===0,i=cE(t,e[t],n);t==="float"&&(t="cssFloat"),n?r.setProperty(t,i):r[t]=i}}var uT=ft({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function jh(r,e){if(e){if(uT[r]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(ne(137,r));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(ne(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(ne(61))}if(e.style!=null&&typeof e.style!="object")throw Error(ne(62))}}function Fh(r,e){if(r.indexOf("-")===-1)return typeof e.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Bh=null;function zv(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var $h=null,qa=null,Ha=null;function wm(r){if(r=pl(r)){if(typeof $h!="function")throw Error(ne(280));var e=r.stateNode;e&&(e=jd(e),$h(r.stateNode,r.type,e))}}function fE(r){qa?Ha?Ha.push(r):Ha=[r]:qa=r}function vE(){if(qa){var r=qa,e=Ha;if(Ha=qa=null,wm(r),e)for(r=0;r<e.length;r++)wm(e[r])}}function pE(r,e){return r(e)}function mE(){}var Oc=!1;function gE(r,e,t){if(Oc)return r(e,t);Oc=!0;try{return pE(r,e,t)}finally{Oc=!1,(qa!==null||Ha!==null)&&(mE(),vE())}}function xo(r,e){var t=r.stateNode;if(t===null)return null;var n=jd(t);if(n===null)return null;t=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(r=r.type,n=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!n;break e;default:r=!1}if(r)return null;if(t&&typeof t!="function")throw Error(ne(231,e,typeof t));return t}var Wh=!1;if(Un)try{var js={};Object.defineProperty(js,"passive",{get:function(){Wh=!0}}),window.addEventListener("test",js,js),window.removeEventListener("test",js,js)}catch{Wh=!1}function dT(r,e,t,n,i,a,s,o,l){var u=Array.prototype.slice.call(arguments,3);try{e.apply(t,u)}catch(d){this.onError(d)}}var vo=!1,Bu=null,$u=!1,Kh=null,cT={onError:function(r){vo=!0,Bu=r}};function hT(r,e,t,n,i,a,s,o,l){vo=!1,Bu=null,dT.apply(cT,arguments)}function fT(r,e,t,n,i,a,s,o,l){if(hT.apply(this,arguments),vo){if(vo){var u=Bu;vo=!1,Bu=null}else throw Error(ne(198));$u||($u=!0,Kh=u)}}function va(r){var e=r,t=r;if(r.alternate)for(;e.return;)e=e.return;else{r=e;do e=r,e.flags&4098&&(t=e.return),r=e.return;while(r)}return e.tag===3?t:null}function yE(r){if(r.tag===13){var e=r.memoizedState;if(e===null&&(r=r.alternate,r!==null&&(e=r.memoizedState)),e!==null)return e.dehydrated}return null}function Tm(r){if(va(r)!==r)throw Error(ne(188))}function vT(r){var e=r.alternate;if(!e){if(e=va(r),e===null)throw Error(ne(188));return e!==r?null:r}for(var t=r,n=e;;){var i=t.return;if(i===null)break;var a=i.alternate;if(a===null){if(n=i.return,n!==null){t=n;continue}break}if(i.child===a.child){for(a=i.child;a;){if(a===t)return Tm(i),r;if(a===n)return Tm(i),e;a=a.sibling}throw Error(ne(188))}if(t.return!==n.return)t=i,n=a;else{for(var s=!1,o=i.child;o;){if(o===t){s=!0,t=i,n=a;break}if(o===n){s=!0,n=i,t=a;break}o=o.sibling}if(!s){for(o=a.child;o;){if(o===t){s=!0,t=a,n=i;break}if(o===n){s=!0,n=a,t=i;break}o=o.sibling}if(!s)throw Error(ne(189))}}if(t.alternate!==n)throw Error(ne(190))}if(t.tag!==3)throw Error(ne(188));return t.stateNode.current===t?r:e}function SE(r){return r=vT(r),r!==null?EE(r):null}function EE(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var e=EE(r);if(e!==null)return e;r=r.sibling}return null}var _E=wr.unstable_scheduleCallback,Rm=wr.unstable_cancelCallback,pT=wr.unstable_shouldYield,mT=wr.unstable_requestPaint,gt=wr.unstable_now,gT=wr.unstable_getCurrentPriorityLevel,Jv=wr.unstable_ImmediatePriority,bE=wr.unstable_UserBlockingPriority,Wu=wr.unstable_NormalPriority,yT=wr.unstable_LowPriority,wE=wr.unstable_IdlePriority,xd=null,vn=null;function ST(r){if(vn&&typeof vn.onCommitFiberRoot=="function")try{vn.onCommitFiberRoot(xd,r,void 0,(r.current.flags&128)===128)}catch{}}var zr=Math.clz32?Math.clz32:bT,ET=Math.log,_T=Math.LN2;function bT(r){return r>>>=0,r===0?32:31-(ET(r)/_T|0)|0}var Fl=64,Bl=4194304;function so(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}function Ku(r,e){var t=r.pendingLanes;if(t===0)return 0;var n=0,i=r.suspendedLanes,a=r.pingedLanes,s=t&268435455;if(s!==0){var o=s&~i;o!==0?n=so(o):(a&=s,a!==0&&(n=so(a)))}else s=t&~i,s!==0?n=so(s):a!==0&&(n=so(a));if(n===0)return 0;if(e!==0&&e!==n&&!(e&i)&&(i=n&-n,a=e&-e,i>=a||i===16&&(a&4194240)!==0))return e;if(n&4&&(n|=t&16),e=r.entangledLanes,e!==0)for(r=r.entanglements,e&=n;0<e;)t=31-zr(e),i=1<<t,n|=r[t],e&=~i;return n}function wT(r,e){switch(r){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function TT(r,e){for(var t=r.suspendedLanes,n=r.pingedLanes,i=r.expirationTimes,a=r.pendingLanes;0<a;){var s=31-zr(a),o=1<<s,l=i[s];l===-1?(!(o&t)||o&n)&&(i[s]=wT(o,e)):l<=e&&(r.expiredLanes|=o),a&=~o}}function Vh(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}function TE(){var r=Fl;return Fl<<=1,!(Fl&4194240)&&(Fl=64),r}function kc(r){for(var e=[],t=0;31>t;t++)e.push(r);return e}function fl(r,e,t){r.pendingLanes|=e,e!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,e=31-zr(e),r[e]=t}function RT(r,e){var t=r.pendingLanes&~e;r.pendingLanes=e,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=e,r.mutableReadLanes&=e,r.entangledLanes&=e,e=r.entanglements;var n=r.eventTimes;for(r=r.expirationTimes;0<t;){var i=31-zr(t),a=1<<i;e[i]=0,n[i]=-1,r[i]=-1,t&=~a}}function Yv(r,e){var t=r.entangledLanes|=e;for(r=r.entanglements;t;){var n=31-zr(t),i=1<<n;i&e|r[n]&e&&(r[n]|=e),t&=~i}}var He=0;function RE(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}var IE,Qv,CE,OE,kE,Gh=!1,$l=[],fi=null,vi=null,pi=null,No=new Map,Lo=new Map,ai=[],IT="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Im(r,e){switch(r){case"focusin":case"focusout":fi=null;break;case"dragenter":case"dragleave":vi=null;break;case"mouseover":case"mouseout":pi=null;break;case"pointerover":case"pointerout":No.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Lo.delete(e.pointerId)}}function Fs(r,e,t,n,i,a){return r===null||r.nativeEvent!==a?(r={blockedOn:e,domEventName:t,eventSystemFlags:n,nativeEvent:a,targetContainers:[i]},e!==null&&(e=pl(e),e!==null&&Qv(e)),r):(r.eventSystemFlags|=n,e=r.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),r)}function CT(r,e,t,n,i){switch(e){case"focusin":return fi=Fs(fi,r,e,t,n,i),!0;case"dragenter":return vi=Fs(vi,r,e,t,n,i),!0;case"mouseover":return pi=Fs(pi,r,e,t,n,i),!0;case"pointerover":var a=i.pointerId;return No.set(a,Fs(No.get(a)||null,r,e,t,n,i)),!0;case"gotpointercapture":return a=i.pointerId,Lo.set(a,Fs(Lo.get(a)||null,r,e,t,n,i)),!0}return!1}function PE(r){var e=zi(r.target);if(e!==null){var t=va(e);if(t!==null){if(e=t.tag,e===13){if(e=yE(t),e!==null){r.blockedOn=e,kE(r.priority,function(){CE(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){r.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}r.blockedOn=null}function vu(r){if(r.blockedOn!==null)return!1;for(var e=r.targetContainers;0<e.length;){var t=qh(r.domEventName,r.eventSystemFlags,e[0],r.nativeEvent);if(t===null){t=r.nativeEvent;var n=new t.constructor(t.type,t);Bh=n,t.target.dispatchEvent(n),Bh=null}else return e=pl(t),e!==null&&Qv(e),r.blockedOn=t,!1;e.shift()}return!0}function Cm(r,e,t){vu(r)&&t.delete(e)}function OT(){Gh=!1,fi!==null&&vu(fi)&&(fi=null),vi!==null&&vu(vi)&&(vi=null),pi!==null&&vu(pi)&&(pi=null),No.forEach(Cm),Lo.forEach(Cm)}function Bs(r,e){r.blockedOn===e&&(r.blockedOn=null,Gh||(Gh=!0,wr.unstable_scheduleCallback(wr.unstable_NormalPriority,OT)))}function Uo(r){function e(i){return Bs(i,r)}if(0<$l.length){Bs($l[0],r);for(var t=1;t<$l.length;t++){var n=$l[t];n.blockedOn===r&&(n.blockedOn=null)}}for(fi!==null&&Bs(fi,r),vi!==null&&Bs(vi,r),pi!==null&&Bs(pi,r),No.forEach(e),Lo.forEach(e),t=0;t<ai.length;t++)n=ai[t],n.blockedOn===r&&(n.blockedOn=null);for(;0<ai.length&&(t=ai[0],t.blockedOn===null);)PE(t),t.blockedOn===null&&ai.shift()}var za=$n.ReactCurrentBatchConfig,Vu=!0;function kT(r,e,t,n){var i=He,a=za.transition;za.transition=null;try{He=1,Xv(r,e,t,n)}finally{He=i,za.transition=a}}function PT(r,e,t,n){var i=He,a=za.transition;za.transition=null;try{He=4,Xv(r,e,t,n)}finally{He=i,za.transition=a}}function Xv(r,e,t,n){if(Vu){var i=qh(r,e,t,n);if(i===null)Fc(r,e,n,Gu,t),Im(r,n);else if(CT(i,r,e,t,n))n.stopPropagation();else if(Im(r,n),e&4&&-1<IT.indexOf(r)){for(;i!==null;){var a=pl(i);if(a!==null&&IE(a),a=qh(r,e,t,n),a===null&&Fc(r,e,n,Gu,t),a===i)break;i=a}i!==null&&n.stopPropagation()}else Fc(r,e,n,null,t)}}var Gu=null;function qh(r,e,t,n){if(Gu=null,r=zv(n),r=zi(r),r!==null)if(e=va(r),e===null)r=null;else if(t=e.tag,t===13){if(r=yE(e),r!==null)return r;r=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;r=null}else e!==r&&(r=null);return Gu=r,null}function ME(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(gT()){case Jv:return 1;case bE:return 4;case Wu:case yT:return 16;case wE:return 536870912;default:return 16}default:return 16}}var oi=null,Zv=null,pu=null;function AE(){if(pu)return pu;var r,e=Zv,t=e.length,n,i="value"in oi?oi.value:oi.textContent,a=i.length;for(r=0;r<t&&e[r]===i[r];r++);var s=t-r;for(n=1;n<=s&&e[t-n]===i[a-n];n++);return pu=i.slice(r,1<n?1-n:void 0)}function mu(r){var e=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&e===13&&(r=13)):r=e,r===10&&(r=13),32<=r||r===13?r:0}function Wl(){return!0}function Om(){return!1}function Rr(r){function e(t,n,i,a,s){this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=a,this.target=s,this.currentTarget=null;for(var o in r)r.hasOwnProperty(o)&&(t=r[o],this[o]=t?t(a):a[o]);return this.isDefaultPrevented=(a.defaultPrevented!=null?a.defaultPrevented:a.returnValue===!1)?Wl:Om,this.isPropagationStopped=Om,this}return ft(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=Wl)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=Wl)},persist:function(){},isPersistent:Wl}),e}var Is={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},ep=Rr(Is),vl=ft({},Is,{view:0,detail:0}),MT=Rr(vl),Pc,Mc,$s,Nd=ft({},vl,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:tp,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==$s&&($s&&r.type==="mousemove"?(Pc=r.screenX-$s.screenX,Mc=r.screenY-$s.screenY):Mc=Pc=0,$s=r),Pc)},movementY:function(r){return"movementY"in r?r.movementY:Mc}}),km=Rr(Nd),AT=ft({},Nd,{dataTransfer:0}),DT=Rr(AT),xT=ft({},vl,{relatedTarget:0}),Ac=Rr(xT),NT=ft({},Is,{animationName:0,elapsedTime:0,pseudoElement:0}),LT=Rr(NT),UT=ft({},Is,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),jT=Rr(UT),FT=ft({},Is,{data:0}),Pm=Rr(FT),BT={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},$T={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},WT={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function KT(r){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(r):(r=WT[r])?!!e[r]:!1}function tp(){return KT}var VT=ft({},vl,{key:function(r){if(r.key){var e=BT[r.key]||r.key;if(e!=="Unidentified")return e}return r.type==="keypress"?(r=mu(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?$T[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:tp,charCode:function(r){return r.type==="keypress"?mu(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?mu(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),GT=Rr(VT),qT=ft({},Nd,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Mm=Rr(qT),HT=ft({},vl,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:tp}),zT=Rr(HT),JT=ft({},Is,{propertyName:0,elapsedTime:0,pseudoElement:0}),YT=Rr(JT),QT=ft({},Nd,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),XT=Rr(QT),ZT=[9,13,27,32],rp=Un&&"CompositionEvent"in window,po=null;Un&&"documentMode"in document&&(po=document.documentMode);var eR=Un&&"TextEvent"in window&&!po,DE=Un&&(!rp||po&&8<po&&11>=po),Am=" ",Dm=!1;function xE(r,e){switch(r){case"keyup":return ZT.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function NE(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var Aa=!1;function tR(r,e){switch(r){case"compositionend":return NE(e);case"keypress":return e.which!==32?null:(Dm=!0,Am);case"textInput":return r=e.data,r===Am&&Dm?null:r;default:return null}}function rR(r,e){if(Aa)return r==="compositionend"||!rp&&xE(r,e)?(r=AE(),pu=Zv=oi=null,Aa=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return DE&&e.locale!=="ko"?null:e.data;default:return null}}var nR={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function xm(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e==="input"?!!nR[r.type]:e==="textarea"}function LE(r,e,t,n){fE(n),e=qu(e,"onChange"),0<e.length&&(t=new ep("onChange","change",null,t,n),r.push({event:t,listeners:e}))}var mo=null,jo=null;function iR(r){HE(r,0)}function Ld(r){var e=Na(r);if(sE(e))return r}function aR(r,e){if(r==="change")return e}var UE=!1;if(Un){var Dc;if(Un){var xc="oninput"in document;if(!xc){var Nm=document.createElement("div");Nm.setAttribute("oninput","return;"),xc=typeof Nm.oninput=="function"}Dc=xc}else Dc=!1;UE=Dc&&(!document.documentMode||9<document.documentMode)}function Lm(){mo&&(mo.detachEvent("onpropertychange",jE),jo=mo=null)}function jE(r){if(r.propertyName==="value"&&Ld(jo)){var e=[];LE(e,jo,r,zv(r)),gE(iR,e)}}function sR(r,e,t){r==="focusin"?(Lm(),mo=e,jo=t,mo.attachEvent("onpropertychange",jE)):r==="focusout"&&Lm()}function oR(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return Ld(jo)}function lR(r,e){if(r==="click")return Ld(e)}function uR(r,e){if(r==="input"||r==="change")return Ld(e)}function dR(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}var Xr=typeof Object.is=="function"?Object.is:dR;function Fo(r,e){if(Xr(r,e))return!0;if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;var t=Object.keys(r),n=Object.keys(e);if(t.length!==n.length)return!1;for(n=0;n<t.length;n++){var i=t[n];if(!Oh.call(e,i)||!Xr(r[i],e[i]))return!1}return!0}function Um(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function jm(r,e){var t=Um(r);r=0;for(var n;t;){if(t.nodeType===3){if(n=r+t.textContent.length,r<=e&&n>=e)return{node:t,offset:e-r};r=n}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=Um(t)}}function FE(r,e){return r&&e?r===e?!0:r&&r.nodeType===3?!1:e&&e.nodeType===3?FE(r,e.parentNode):"contains"in r?r.contains(e):r.compareDocumentPosition?!!(r.compareDocumentPosition(e)&16):!1:!1}function BE(){for(var r=window,e=Fu();e instanceof r.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)r=e.contentWindow;else break;e=Fu(r.document)}return e}function np(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e&&(e==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||e==="textarea"||r.contentEditable==="true")}function cR(r){var e=BE(),t=r.focusedElem,n=r.selectionRange;if(e!==t&&t&&t.ownerDocument&&FE(t.ownerDocument.documentElement,t)){if(n!==null&&np(t)){if(e=n.start,r=n.end,r===void 0&&(r=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(r,t.value.length);else if(r=(e=t.ownerDocument||document)&&e.defaultView||window,r.getSelection){r=r.getSelection();var i=t.textContent.length,a=Math.min(n.start,i);n=n.end===void 0?a:Math.min(n.end,i),!r.extend&&a>n&&(i=n,n=a,a=i),i=jm(t,a);var s=jm(t,n);i&&s&&(r.rangeCount!==1||r.anchorNode!==i.node||r.anchorOffset!==i.offset||r.focusNode!==s.node||r.focusOffset!==s.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),r.removeAllRanges(),a>n?(r.addRange(e),r.extend(s.node,s.offset)):(e.setEnd(s.node,s.offset),r.addRange(e)))}}for(e=[],r=t;r=r.parentNode;)r.nodeType===1&&e.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)r=e[t],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}var hR=Un&&"documentMode"in document&&11>=document.documentMode,Da=null,Hh=null,go=null,zh=!1;function Fm(r,e,t){var n=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;zh||Da==null||Da!==Fu(n)||(n=Da,"selectionStart"in n&&np(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),go&&Fo(go,n)||(go=n,n=qu(Hh,"onSelect"),0<n.length&&(e=new ep("onSelect","select",null,e,t),r.push({event:e,listeners:n}),e.target=Da)))}function Kl(r,e){var t={};return t[r.toLowerCase()]=e.toLowerCase(),t["Webkit"+r]="webkit"+e,t["Moz"+r]="moz"+e,t}var xa={animationend:Kl("Animation","AnimationEnd"),animationiteration:Kl("Animation","AnimationIteration"),animationstart:Kl("Animation","AnimationStart"),transitionend:Kl("Transition","TransitionEnd")},Nc={},$E={};Un&&($E=document.createElement("div").style,"AnimationEvent"in window||(delete xa.animationend.animation,delete xa.animationiteration.animation,delete xa.animationstart.animation),"TransitionEvent"in window||delete xa.transitionend.transition);function Ud(r){if(Nc[r])return Nc[r];if(!xa[r])return r;var e=xa[r],t;for(t in e)if(e.hasOwnProperty(t)&&t in $E)return Nc[r]=e[t];return r}var WE=Ud("animationend"),KE=Ud("animationiteration"),VE=Ud("animationstart"),GE=Ud("transitionend"),qE=new Map,Bm="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Oi(r,e){qE.set(r,e),fa(e,[r])}for(var Lc=0;Lc<Bm.length;Lc++){var Uc=Bm[Lc],fR=Uc.toLowerCase(),vR=Uc[0].toUpperCase()+Uc.slice(1);Oi(fR,"on"+vR)}Oi(WE,"onAnimationEnd");Oi(KE,"onAnimationIteration");Oi(VE,"onAnimationStart");Oi("dblclick","onDoubleClick");Oi("focusin","onFocus");Oi("focusout","onBlur");Oi(GE,"onTransitionEnd");os("onMouseEnter",["mouseout","mouseover"]);os("onMouseLeave",["mouseout","mouseover"]);os("onPointerEnter",["pointerout","pointerover"]);os("onPointerLeave",["pointerout","pointerover"]);fa("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));fa("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));fa("onBeforeInput",["compositionend","keypress","textInput","paste"]);fa("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));fa("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));fa("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var oo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),pR=new Set("cancel close invalid load scroll toggle".split(" ").concat(oo));function $m(r,e,t){var n=r.type||"unknown-event";r.currentTarget=t,fT(n,e,void 0,r),r.currentTarget=null}function HE(r,e){e=(e&4)!==0;for(var t=0;t<r.length;t++){var n=r[t],i=n.event;n=n.listeners;e:{var a=void 0;if(e)for(var s=n.length-1;0<=s;s--){var o=n[s],l=o.instance,u=o.currentTarget;if(o=o.listener,l!==a&&i.isPropagationStopped())break e;$m(i,o,u),a=l}else for(s=0;s<n.length;s++){if(o=n[s],l=o.instance,u=o.currentTarget,o=o.listener,l!==a&&i.isPropagationStopped())break e;$m(i,o,u),a=l}}}if($u)throw r=Kh,$u=!1,Kh=null,r}function et(r,e){var t=e[Zh];t===void 0&&(t=e[Zh]=new Set);var n=r+"__bubble";t.has(n)||(zE(e,r,2,!1),t.add(n))}function jc(r,e,t){var n=0;e&&(n|=4),zE(t,r,n,e)}var Vl="_reactListening"+Math.random().toString(36).slice(2);function Bo(r){if(!r[Vl]){r[Vl]=!0,tE.forEach(function(t){t!=="selectionchange"&&(pR.has(t)||jc(t,!1,r),jc(t,!0,r))});var e=r.nodeType===9?r:r.ownerDocument;e===null||e[Vl]||(e[Vl]=!0,jc("selectionchange",!1,e))}}function zE(r,e,t,n){switch(ME(e)){case 1:var i=kT;break;case 4:i=PT;break;default:i=Xv}t=i.bind(null,e,t,r),i=void 0,!Wh||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),n?i!==void 0?r.addEventListener(e,t,{capture:!0,passive:i}):r.addEventListener(e,t,!0):i!==void 0?r.addEventListener(e,t,{passive:i}):r.addEventListener(e,t,!1)}function Fc(r,e,t,n,i){var a=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var s=n.tag;if(s===3||s===4){var o=n.stateNode.containerInfo;if(o===i||o.nodeType===8&&o.parentNode===i)break;if(s===4)for(s=n.return;s!==null;){var l=s.tag;if((l===3||l===4)&&(l=s.stateNode.containerInfo,l===i||l.nodeType===8&&l.parentNode===i))return;s=s.return}for(;o!==null;){if(s=zi(o),s===null)return;if(l=s.tag,l===5||l===6){n=a=s;continue e}o=o.parentNode}}n=n.return}gE(function(){var u=a,d=zv(t),h=[];e:{var f=qE.get(r);if(f!==void 0){var m=ep,v=r;switch(r){case"keypress":if(mu(t)===0)break e;case"keydown":case"keyup":m=GT;break;case"focusin":v="focus",m=Ac;break;case"focusout":v="blur",m=Ac;break;case"beforeblur":case"afterblur":m=Ac;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":m=km;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":m=DT;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":m=zT;break;case WE:case KE:case VE:m=LT;break;case GE:m=YT;break;case"scroll":m=MT;break;case"wheel":m=XT;break;case"copy":case"cut":case"paste":m=jT;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":m=Mm}var y=(e&4)!==0,I=!y&&r==="scroll",g=y?f!==null?f+"Capture":null:f;y=[];for(var p=u,b;p!==null;){b=p;var R=b.stateNode;if(b.tag===5&&R!==null&&(b=R,g!==null&&(R=xo(p,g),R!=null&&y.push($o(p,R,b)))),I)break;p=p.return}0<y.length&&(f=new m(f,v,null,t,d),h.push({event:f,listeners:y}))}}if(!(e&7)){e:{if(f=r==="mouseover"||r==="pointerover",m=r==="mouseout"||r==="pointerout",f&&t!==Bh&&(v=t.relatedTarget||t.fromElement)&&(zi(v)||v[jn]))break e;if((m||f)&&(f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window,m?(v=t.relatedTarget||t.toElement,m=u,v=v?zi(v):null,v!==null&&(I=va(v),v!==I||v.tag!==5&&v.tag!==6)&&(v=null)):(m=null,v=u),m!==v)){if(y=km,R="onMouseLeave",g="onMouseEnter",p="mouse",(r==="pointerout"||r==="pointerover")&&(y=Mm,R="onPointerLeave",g="onPointerEnter",p="pointer"),I=m==null?f:Na(m),b=v==null?f:Na(v),f=new y(R,p+"leave",m,t,d),f.target=I,f.relatedTarget=b,R=null,zi(d)===u&&(y=new y(g,p+"enter",v,t,d),y.target=b,y.relatedTarget=I,R=y),I=R,m&&v)t:{for(y=m,g=v,p=0,b=y;b;b=Ea(b))p++;for(b=0,R=g;R;R=Ea(R))b++;for(;0<p-b;)y=Ea(y),p--;for(;0<b-p;)g=Ea(g),b--;for(;p--;){if(y===g||g!==null&&y===g.alternate)break t;y=Ea(y),g=Ea(g)}y=null}else y=null;m!==null&&Wm(h,f,m,y,!1),v!==null&&I!==null&&Wm(h,I,v,y,!0)}}e:{if(f=u?Na(u):window,m=f.nodeName&&f.nodeName.toLowerCase(),m==="select"||m==="input"&&f.type==="file")var P=aR;else if(xm(f))if(UE)P=uR;else{P=oR;var E=sR}else(m=f.nodeName)&&m.toLowerCase()==="input"&&(f.type==="checkbox"||f.type==="radio")&&(P=lR);if(P&&(P=P(r,u))){LE(h,P,t,d);break e}E&&E(r,f,u),r==="focusout"&&(E=f._wrapperState)&&E.controlled&&f.type==="number"&&Nh(f,"number",f.value)}switch(E=u?Na(u):window,r){case"focusin":(xm(E)||E.contentEditable==="true")&&(Da=E,Hh=u,go=null);break;case"focusout":go=Hh=Da=null;break;case"mousedown":zh=!0;break;case"contextmenu":case"mouseup":case"dragend":zh=!1,Fm(h,t,d);break;case"selectionchange":if(hR)break;case"keydown":case"keyup":Fm(h,t,d)}var C;if(rp)e:{switch(r){case"compositionstart":var S="onCompositionStart";break e;case"compositionend":S="onCompositionEnd";break e;case"compositionupdate":S="onCompositionUpdate";break e}S=void 0}else Aa?xE(r,t)&&(S="onCompositionEnd"):r==="keydown"&&t.keyCode===229&&(S="onCompositionStart");S&&(DE&&t.locale!=="ko"&&(Aa||S!=="onCompositionStart"?S==="onCompositionEnd"&&Aa&&(C=AE()):(oi=d,Zv="value"in oi?oi.value:oi.textContent,Aa=!0)),E=qu(u,S),0<E.length&&(S=new Pm(S,r,null,t,d),h.push({event:S,listeners:E}),C?S.data=C:(C=NE(t),C!==null&&(S.data=C)))),(C=eR?tR(r,t):rR(r,t))&&(u=qu(u,"onBeforeInput"),0<u.length&&(d=new Pm("onBeforeInput","beforeinput",null,t,d),h.push({event:d,listeners:u}),d.data=C))}HE(h,e)})}function $o(r,e,t){return{instance:r,listener:e,currentTarget:t}}function qu(r,e){for(var t=e+"Capture",n=[];r!==null;){var i=r,a=i.stateNode;i.tag===5&&a!==null&&(i=a,a=xo(r,t),a!=null&&n.unshift($o(r,a,i)),a=xo(r,e),a!=null&&n.push($o(r,a,i))),r=r.return}return n}function Ea(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}function Wm(r,e,t,n,i){for(var a=e._reactName,s=[];t!==null&&t!==n;){var o=t,l=o.alternate,u=o.stateNode;if(l!==null&&l===n)break;o.tag===5&&u!==null&&(o=u,i?(l=xo(t,a),l!=null&&s.unshift($o(t,l,o))):i||(l=xo(t,a),l!=null&&s.push($o(t,l,o)))),t=t.return}s.length!==0&&r.push({event:e,listeners:s})}var mR=/\r\n?/g,gR=/\u0000|\uFFFD/g;function Km(r){return(typeof r=="string"?r:""+r).replace(mR,`
`).replace(gR,"")}function Gl(r,e,t){if(e=Km(e),Km(r)!==e&&t)throw Error(ne(425))}function Hu(){}var Jh=null,Yh=null;function Qh(r,e){return r==="textarea"||r==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var Xh=typeof setTimeout=="function"?setTimeout:void 0,yR=typeof clearTimeout=="function"?clearTimeout:void 0,Vm=typeof Promise=="function"?Promise:void 0,SR=typeof queueMicrotask=="function"?queueMicrotask:typeof Vm<"u"?function(r){return Vm.resolve(null).then(r).catch(ER)}:Xh;function ER(r){setTimeout(function(){throw r})}function Bc(r,e){var t=e,n=0;do{var i=t.nextSibling;if(r.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(n===0){r.removeChild(i),Uo(e);return}n--}else t!=="$"&&t!=="$?"&&t!=="$!"||n++;t=i}while(t);Uo(e)}function mi(r){for(;r!=null;r=r.nextSibling){var e=r.nodeType;if(e===1||e===3)break;if(e===8){if(e=r.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return r}function Gm(r){r=r.previousSibling;for(var e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return r;e--}else t==="/$"&&e++}r=r.previousSibling}return null}var Cs=Math.random().toString(36).slice(2),hn="__reactFiber$"+Cs,Wo="__reactProps$"+Cs,jn="__reactContainer$"+Cs,Zh="__reactEvents$"+Cs,_R="__reactListeners$"+Cs,bR="__reactHandles$"+Cs;function zi(r){var e=r[hn];if(e)return e;for(var t=r.parentNode;t;){if(e=t[jn]||t[hn]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(r=Gm(r);r!==null;){if(t=r[hn])return t;r=Gm(r)}return e}r=t,t=r.parentNode}return null}function pl(r){return r=r[hn]||r[jn],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}function Na(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(ne(33))}function jd(r){return r[Wo]||null}var ef=[],La=-1;function ki(r){return{current:r}}function rt(r){0>La||(r.current=ef[La],ef[La]=null,La--)}function Ze(r,e){La++,ef[La]=r.current,r.current=e}var Ri={},Jt=ki(Ri),dr=ki(!1),ia=Ri;function ls(r,e){var t=r.type.contextTypes;if(!t)return Ri;var n=r.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var i={},a;for(a in t)i[a]=e[a];return n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=e,r.__reactInternalMemoizedMaskedChildContext=i),i}function cr(r){return r=r.childContextTypes,r!=null}function zu(){rt(dr),rt(Jt)}function qm(r,e,t){if(Jt.current!==Ri)throw Error(ne(168));Ze(Jt,e),Ze(dr,t)}function JE(r,e,t){var n=r.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return t;n=n.getChildContext();for(var i in n)if(!(i in e))throw Error(ne(108,sT(r)||"Unknown",i));return ft({},t,n)}function Ju(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||Ri,ia=Jt.current,Ze(Jt,r),Ze(dr,dr.current),!0}function Hm(r,e,t){var n=r.stateNode;if(!n)throw Error(ne(169));t?(r=JE(r,e,ia),n.__reactInternalMemoizedMergedChildContext=r,rt(dr),rt(Jt),Ze(Jt,r)):rt(dr),Ze(dr,t)}var In=null,Fd=!1,$c=!1;function YE(r){In===null?In=[r]:In.push(r)}function wR(r){Fd=!0,YE(r)}function Pi(){if(!$c&&In!==null){$c=!0;var r=0,e=He;try{var t=In;for(He=1;r<t.length;r++){var n=t[r];do n=n(!0);while(n!==null)}In=null,Fd=!1}catch(i){throw In!==null&&(In=In.slice(r+1)),_E(Jv,Pi),i}finally{He=e,$c=!1}}return null}var Ua=[],ja=0,Yu=null,Qu=0,Mr=[],Ar=0,aa=null,kn=1,Pn="";function Bi(r,e){Ua[ja++]=Qu,Ua[ja++]=Yu,Yu=r,Qu=e}function QE(r,e,t){Mr[Ar++]=kn,Mr[Ar++]=Pn,Mr[Ar++]=aa,aa=r;var n=kn;r=Pn;var i=32-zr(n)-1;n&=~(1<<i),t+=1;var a=32-zr(e)+i;if(30<a){var s=i-i%5;a=(n&(1<<s)-1).toString(32),n>>=s,i-=s,kn=1<<32-zr(e)+i|t<<i|n,Pn=a+r}else kn=1<<a|t<<i|n,Pn=r}function ip(r){r.return!==null&&(Bi(r,1),QE(r,1,0))}function ap(r){for(;r===Yu;)Yu=Ua[--ja],Ua[ja]=null,Qu=Ua[--ja],Ua[ja]=null;for(;r===aa;)aa=Mr[--Ar],Mr[Ar]=null,Pn=Mr[--Ar],Mr[Ar]=null,kn=Mr[--Ar],Mr[Ar]=null}var br=null,_r=null,at=!1,qr=null;function XE(r,e){var t=Dr(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=r,e=r.deletions,e===null?(r.deletions=[t],r.flags|=16):e.push(t)}function zm(r,e){switch(r.tag){case 5:var t=r.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(r.stateNode=e,br=r,_r=mi(e.firstChild),!0):!1;case 6:return e=r.pendingProps===""||e.nodeType!==3?null:e,e!==null?(r.stateNode=e,br=r,_r=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=aa!==null?{id:kn,overflow:Pn}:null,r.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=Dr(18,null,null,0),t.stateNode=e,t.return=r,r.child=t,br=r,_r=null,!0):!1;default:return!1}}function tf(r){return(r.mode&1)!==0&&(r.flags&128)===0}function rf(r){if(at){var e=_r;if(e){var t=e;if(!zm(r,e)){if(tf(r))throw Error(ne(418));e=mi(t.nextSibling);var n=br;e&&zm(r,e)?XE(n,t):(r.flags=r.flags&-4097|2,at=!1,br=r)}}else{if(tf(r))throw Error(ne(418));r.flags=r.flags&-4097|2,at=!1,br=r}}}function Jm(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;br=r}function ql(r){if(r!==br)return!1;if(!at)return Jm(r),at=!0,!1;var e;if((e=r.tag!==3)&&!(e=r.tag!==5)&&(e=r.type,e=e!=="head"&&e!=="body"&&!Qh(r.type,r.memoizedProps)),e&&(e=_r)){if(tf(r))throw ZE(),Error(ne(418));for(;e;)XE(r,e),e=mi(e.nextSibling)}if(Jm(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(ne(317));e:{for(r=r.nextSibling,e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="/$"){if(e===0){_r=mi(r.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}r=r.nextSibling}_r=null}}else _r=br?mi(r.stateNode.nextSibling):null;return!0}function ZE(){for(var r=_r;r;)r=mi(r.nextSibling)}function us(){_r=br=null,at=!1}function sp(r){qr===null?qr=[r]:qr.push(r)}var TR=$n.ReactCurrentBatchConfig;function Ws(r,e,t){if(r=t.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(ne(309));var n=t.stateNode}if(!n)throw Error(ne(147,r));var i=n,a=""+r;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===a?e.ref:(e=function(s){var o=i.refs;s===null?delete o[a]:o[a]=s},e._stringRef=a,e)}if(typeof r!="string")throw Error(ne(284));if(!t._owner)throw Error(ne(290,r))}return r}function Hl(r,e){throw r=Object.prototype.toString.call(e),Error(ne(31,r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r))}function Ym(r){var e=r._init;return e(r._payload)}function e_(r){function e(g,p){if(r){var b=g.deletions;b===null?(g.deletions=[p],g.flags|=16):b.push(p)}}function t(g,p){if(!r)return null;for(;p!==null;)e(g,p),p=p.sibling;return null}function n(g,p){for(g=new Map;p!==null;)p.key!==null?g.set(p.key,p):g.set(p.index,p),p=p.sibling;return g}function i(g,p){return g=Ei(g,p),g.index=0,g.sibling=null,g}function a(g,p,b){return g.index=b,r?(b=g.alternate,b!==null?(b=b.index,b<p?(g.flags|=2,p):b):(g.flags|=2,p)):(g.flags|=1048576,p)}function s(g){return r&&g.alternate===null&&(g.flags|=2),g}function o(g,p,b,R){return p===null||p.tag!==6?(p=zc(b,g.mode,R),p.return=g,p):(p=i(p,b),p.return=g,p)}function l(g,p,b,R){var P=b.type;return P===Ma?d(g,p,b.props.children,R,b.key):p!==null&&(p.elementType===P||typeof P=="object"&&P!==null&&P.$$typeof===ti&&Ym(P)===p.type)?(R=i(p,b.props),R.ref=Ws(g,p,b),R.return=g,R):(R=wu(b.type,b.key,b.props,null,g.mode,R),R.ref=Ws(g,p,b),R.return=g,R)}function u(g,p,b,R){return p===null||p.tag!==4||p.stateNode.containerInfo!==b.containerInfo||p.stateNode.implementation!==b.implementation?(p=Jc(b,g.mode,R),p.return=g,p):(p=i(p,b.children||[]),p.return=g,p)}function d(g,p,b,R,P){return p===null||p.tag!==7?(p=ea(b,g.mode,R,P),p.return=g,p):(p=i(p,b),p.return=g,p)}function h(g,p,b){if(typeof p=="string"&&p!==""||typeof p=="number")return p=zc(""+p,g.mode,b),p.return=g,p;if(typeof p=="object"&&p!==null){switch(p.$$typeof){case Ll:return b=wu(p.type,p.key,p.props,null,g.mode,b),b.ref=Ws(g,null,p),b.return=g,b;case Pa:return p=Jc(p,g.mode,b),p.return=g,p;case ti:var R=p._init;return h(g,R(p._payload),b)}if(ao(p)||Us(p))return p=ea(p,g.mode,b,null),p.return=g,p;Hl(g,p)}return null}function f(g,p,b,R){var P=p!==null?p.key:null;if(typeof b=="string"&&b!==""||typeof b=="number")return P!==null?null:o(g,p,""+b,R);if(typeof b=="object"&&b!==null){switch(b.$$typeof){case Ll:return b.key===P?l(g,p,b,R):null;case Pa:return b.key===P?u(g,p,b,R):null;case ti:return P=b._init,f(g,p,P(b._payload),R)}if(ao(b)||Us(b))return P!==null?null:d(g,p,b,R,null);Hl(g,b)}return null}function m(g,p,b,R,P){if(typeof R=="string"&&R!==""||typeof R=="number")return g=g.get(b)||null,o(p,g,""+R,P);if(typeof R=="object"&&R!==null){switch(R.$$typeof){case Ll:return g=g.get(R.key===null?b:R.key)||null,l(p,g,R,P);case Pa:return g=g.get(R.key===null?b:R.key)||null,u(p,g,R,P);case ti:var E=R._init;return m(g,p,b,E(R._payload),P)}if(ao(R)||Us(R))return g=g.get(b)||null,d(p,g,R,P,null);Hl(p,R)}return null}function v(g,p,b,R){for(var P=null,E=null,C=p,S=p=0,x=null;C!==null&&S<b.length;S++){C.index>S?(x=C,C=null):x=C.sibling;var K=f(g,C,b[S],R);if(K===null){C===null&&(C=x);break}r&&C&&K.alternate===null&&e(g,C),p=a(K,p,S),E===null?P=K:E.sibling=K,E=K,C=x}if(S===b.length)return t(g,C),at&&Bi(g,S),P;if(C===null){for(;S<b.length;S++)C=h(g,b[S],R),C!==null&&(p=a(C,p,S),E===null?P=C:E.sibling=C,E=C);return at&&Bi(g,S),P}for(C=n(g,C);S<b.length;S++)x=m(C,g,S,b[S],R),x!==null&&(r&&x.alternate!==null&&C.delete(x.key===null?S:x.key),p=a(x,p,S),E===null?P=x:E.sibling=x,E=x);return r&&C.forEach(function(z){return e(g,z)}),at&&Bi(g,S),P}function y(g,p,b,R){var P=Us(b);if(typeof P!="function")throw Error(ne(150));if(b=P.call(b),b==null)throw Error(ne(151));for(var E=P=null,C=p,S=p=0,x=null,K=b.next();C!==null&&!K.done;S++,K=b.next()){C.index>S?(x=C,C=null):x=C.sibling;var z=f(g,C,K.value,R);if(z===null){C===null&&(C=x);break}r&&C&&z.alternate===null&&e(g,C),p=a(z,p,S),E===null?P=z:E.sibling=z,E=z,C=x}if(K.done)return t(g,C),at&&Bi(g,S),P;if(C===null){for(;!K.done;S++,K=b.next())K=h(g,K.value,R),K!==null&&(p=a(K,p,S),E===null?P=K:E.sibling=K,E=K);return at&&Bi(g,S),P}for(C=n(g,C);!K.done;S++,K=b.next())K=m(C,g,S,K.value,R),K!==null&&(r&&K.alternate!==null&&C.delete(K.key===null?S:K.key),p=a(K,p,S),E===null?P=K:E.sibling=K,E=K);return r&&C.forEach(function(oe){return e(g,oe)}),at&&Bi(g,S),P}function I(g,p,b,R){if(typeof b=="object"&&b!==null&&b.type===Ma&&b.key===null&&(b=b.props.children),typeof b=="object"&&b!==null){switch(b.$$typeof){case Ll:e:{for(var P=b.key,E=p;E!==null;){if(E.key===P){if(P=b.type,P===Ma){if(E.tag===7){t(g,E.sibling),p=i(E,b.props.children),p.return=g,g=p;break e}}else if(E.elementType===P||typeof P=="object"&&P!==null&&P.$$typeof===ti&&Ym(P)===E.type){t(g,E.sibling),p=i(E,b.props),p.ref=Ws(g,E,b),p.return=g,g=p;break e}t(g,E);break}else e(g,E);E=E.sibling}b.type===Ma?(p=ea(b.props.children,g.mode,R,b.key),p.return=g,g=p):(R=wu(b.type,b.key,b.props,null,g.mode,R),R.ref=Ws(g,p,b),R.return=g,g=R)}return s(g);case Pa:e:{for(E=b.key;p!==null;){if(p.key===E)if(p.tag===4&&p.stateNode.containerInfo===b.containerInfo&&p.stateNode.implementation===b.implementation){t(g,p.sibling),p=i(p,b.children||[]),p.return=g,g=p;break e}else{t(g,p);break}else e(g,p);p=p.sibling}p=Jc(b,g.mode,R),p.return=g,g=p}return s(g);case ti:return E=b._init,I(g,p,E(b._payload),R)}if(ao(b))return v(g,p,b,R);if(Us(b))return y(g,p,b,R);Hl(g,b)}return typeof b=="string"&&b!==""||typeof b=="number"?(b=""+b,p!==null&&p.tag===6?(t(g,p.sibling),p=i(p,b),p.return=g,g=p):(t(g,p),p=zc(b,g.mode,R),p.return=g,g=p),s(g)):t(g,p)}return I}var ds=e_(!0),t_=e_(!1),Xu=ki(null),Zu=null,Fa=null,op=null;function lp(){op=Fa=Zu=null}function up(r){var e=Xu.current;rt(Xu),r._currentValue=e}function nf(r,e,t){for(;r!==null;){var n=r.alternate;if((r.childLanes&e)!==e?(r.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),r===t)break;r=r.return}}function Ja(r,e){Zu=r,op=Fa=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&e&&(lr=!0),r.firstContext=null)}function Lr(r){var e=r._currentValue;if(op!==r)if(r={context:r,memoizedValue:e,next:null},Fa===null){if(Zu===null)throw Error(ne(308));Fa=r,Zu.dependencies={lanes:0,firstContext:r}}else Fa=Fa.next=r;return e}var Ji=null;function dp(r){Ji===null?Ji=[r]:Ji.push(r)}function r_(r,e,t,n){var i=e.interleaved;return i===null?(t.next=t,dp(e)):(t.next=i.next,i.next=t),e.interleaved=t,Fn(r,n)}function Fn(r,e){r.lanes|=e;var t=r.alternate;for(t!==null&&(t.lanes|=e),t=r,r=r.return;r!==null;)r.childLanes|=e,t=r.alternate,t!==null&&(t.childLanes|=e),t=r,r=r.return;return t.tag===3?t.stateNode:null}var ri=!1;function cp(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function n_(r,e){r=r.updateQueue,e.updateQueue===r&&(e.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}function xn(r,e){return{eventTime:r,lane:e,tag:0,payload:null,callback:null,next:null}}function gi(r,e,t){var n=r.updateQueue;if(n===null)return null;if(n=n.shared,$e&2){var i=n.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),n.pending=e,Fn(r,t)}return i=n.interleaved,i===null?(e.next=e,dp(n)):(e.next=i.next,i.next=e),n.interleaved=e,Fn(r,t)}function gu(r,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,Yv(r,t)}}function Qm(r,e){var t=r.updateQueue,n=r.alternate;if(n!==null&&(n=n.updateQueue,t===n)){var i=null,a=null;if(t=t.firstBaseUpdate,t!==null){do{var s={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};a===null?i=a=s:a=a.next=s,t=t.next}while(t!==null);a===null?i=a=e:a=a.next=e}else i=a=e;t={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:a,shared:n.shared,effects:n.effects},r.updateQueue=t;return}r=t.lastBaseUpdate,r===null?t.firstBaseUpdate=e:r.next=e,t.lastBaseUpdate=e}function ed(r,e,t,n){var i=r.updateQueue;ri=!1;var a=i.firstBaseUpdate,s=i.lastBaseUpdate,o=i.shared.pending;if(o!==null){i.shared.pending=null;var l=o,u=l.next;l.next=null,s===null?a=u:s.next=u,s=l;var d=r.alternate;d!==null&&(d=d.updateQueue,o=d.lastBaseUpdate,o!==s&&(o===null?d.firstBaseUpdate=u:o.next=u,d.lastBaseUpdate=l))}if(a!==null){var h=i.baseState;s=0,d=u=l=null,o=a;do{var f=o.lane,m=o.eventTime;if((n&f)===f){d!==null&&(d=d.next={eventTime:m,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var v=r,y=o;switch(f=e,m=t,y.tag){case 1:if(v=y.payload,typeof v=="function"){h=v.call(m,h,f);break e}h=v;break e;case 3:v.flags=v.flags&-65537|128;case 0:if(v=y.payload,f=typeof v=="function"?v.call(m,h,f):v,f==null)break e;h=ft({},h,f);break e;case 2:ri=!0}}o.callback!==null&&o.lane!==0&&(r.flags|=64,f=i.effects,f===null?i.effects=[o]:f.push(o))}else m={eventTime:m,lane:f,tag:o.tag,payload:o.payload,callback:o.callback,next:null},d===null?(u=d=m,l=h):d=d.next=m,s|=f;if(o=o.next,o===null){if(o=i.shared.pending,o===null)break;f=o,o=f.next,f.next=null,i.lastBaseUpdate=f,i.shared.pending=null}}while(!0);if(d===null&&(l=h),i.baseState=l,i.firstBaseUpdate=u,i.lastBaseUpdate=d,e=i.shared.interleaved,e!==null){i=e;do s|=i.lane,i=i.next;while(i!==e)}else a===null&&(i.shared.lanes=0);oa|=s,r.lanes=s,r.memoizedState=h}}function Xm(r,e,t){if(r=e.effects,e.effects=null,r!==null)for(e=0;e<r.length;e++){var n=r[e],i=n.callback;if(i!==null){if(n.callback=null,n=t,typeof i!="function")throw Error(ne(191,i));i.call(n)}}}var ml={},pn=ki(ml),Ko=ki(ml),Vo=ki(ml);function Yi(r){if(r===ml)throw Error(ne(174));return r}function hp(r,e){switch(Ze(Vo,e),Ze(Ko,r),Ze(pn,ml),r=e.nodeType,r){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:Uh(null,"");break;default:r=r===8?e.parentNode:e,e=r.namespaceURI||null,r=r.tagName,e=Uh(e,r)}rt(pn),Ze(pn,e)}function cs(){rt(pn),rt(Ko),rt(Vo)}function i_(r){Yi(Vo.current);var e=Yi(pn.current),t=Uh(e,r.type);e!==t&&(Ze(Ko,r),Ze(pn,t))}function fp(r){Ko.current===r&&(rt(pn),rt(Ko))}var dt=ki(0);function td(r){for(var e=r;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var Wc=[];function vp(){for(var r=0;r<Wc.length;r++)Wc[r]._workInProgressVersionPrimary=null;Wc.length=0}var yu=$n.ReactCurrentDispatcher,Kc=$n.ReactCurrentBatchConfig,sa=0,ct=null,Ot=null,Dt=null,rd=!1,yo=!1,Go=0,RR=0;function Wt(){throw Error(ne(321))}function pp(r,e){if(e===null)return!1;for(var t=0;t<e.length&&t<r.length;t++)if(!Xr(r[t],e[t]))return!1;return!0}function mp(r,e,t,n,i,a){if(sa=a,ct=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,yu.current=r===null||r.memoizedState===null?kR:PR,r=t(n,i),yo){a=0;do{if(yo=!1,Go=0,25<=a)throw Error(ne(301));a+=1,Dt=Ot=null,e.updateQueue=null,yu.current=MR,r=t(n,i)}while(yo)}if(yu.current=nd,e=Ot!==null&&Ot.next!==null,sa=0,Dt=Ot=ct=null,rd=!1,e)throw Error(ne(300));return r}function gp(){var r=Go!==0;return Go=0,r}function ln(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Dt===null?ct.memoizedState=Dt=r:Dt=Dt.next=r,Dt}function Ur(){if(Ot===null){var r=ct.alternate;r=r!==null?r.memoizedState:null}else r=Ot.next;var e=Dt===null?ct.memoizedState:Dt.next;if(e!==null)Dt=e,Ot=r;else{if(r===null)throw Error(ne(310));Ot=r,r={memoizedState:Ot.memoizedState,baseState:Ot.baseState,baseQueue:Ot.baseQueue,queue:Ot.queue,next:null},Dt===null?ct.memoizedState=Dt=r:Dt=Dt.next=r}return Dt}function qo(r,e){return typeof e=="function"?e(r):e}function Vc(r){var e=Ur(),t=e.queue;if(t===null)throw Error(ne(311));t.lastRenderedReducer=r;var n=Ot,i=n.baseQueue,a=t.pending;if(a!==null){if(i!==null){var s=i.next;i.next=a.next,a.next=s}n.baseQueue=i=a,t.pending=null}if(i!==null){a=i.next,n=n.baseState;var o=s=null,l=null,u=a;do{var d=u.lane;if((sa&d)===d)l!==null&&(l=l.next={lane:0,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null}),n=u.hasEagerState?u.eagerState:r(n,u.action);else{var h={lane:d,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null};l===null?(o=l=h,s=n):l=l.next=h,ct.lanes|=d,oa|=d}u=u.next}while(u!==null&&u!==a);l===null?s=n:l.next=o,Xr(n,e.memoizedState)||(lr=!0),e.memoizedState=n,e.baseState=s,e.baseQueue=l,t.lastRenderedState=n}if(r=t.interleaved,r!==null){i=r;do a=i.lane,ct.lanes|=a,oa|=a,i=i.next;while(i!==r)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}function Gc(r){var e=Ur(),t=e.queue;if(t===null)throw Error(ne(311));t.lastRenderedReducer=r;var n=t.dispatch,i=t.pending,a=e.memoizedState;if(i!==null){t.pending=null;var s=i=i.next;do a=r(a,s.action),s=s.next;while(s!==i);Xr(a,e.memoizedState)||(lr=!0),e.memoizedState=a,e.baseQueue===null&&(e.baseState=a),t.lastRenderedState=a}return[a,n]}function a_(){}function s_(r,e){var t=ct,n=Ur(),i=e(),a=!Xr(n.memoizedState,i);if(a&&(n.memoizedState=i,lr=!0),n=n.queue,yp(u_.bind(null,t,n,r),[r]),n.getSnapshot!==e||a||Dt!==null&&Dt.memoizedState.tag&1){if(t.flags|=2048,Ho(9,l_.bind(null,t,n,i,e),void 0,null),Nt===null)throw Error(ne(349));sa&30||o_(t,e,i)}return i}function o_(r,e,t){r.flags|=16384,r={getSnapshot:e,value:t},e=ct.updateQueue,e===null?(e={lastEffect:null,stores:null},ct.updateQueue=e,e.stores=[r]):(t=e.stores,t===null?e.stores=[r]:t.push(r))}function l_(r,e,t,n){e.value=t,e.getSnapshot=n,d_(e)&&c_(r)}function u_(r,e,t){return t(function(){d_(e)&&c_(r)})}function d_(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!Xr(r,t)}catch{return!0}}function c_(r){var e=Fn(r,1);e!==null&&Jr(e,r,1,-1)}function Zm(r){var e=ln();return typeof r=="function"&&(r=r()),e.memoizedState=e.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:qo,lastRenderedState:r},e.queue=r,r=r.dispatch=OR.bind(null,ct,r),[e.memoizedState,r]}function Ho(r,e,t,n){return r={tag:r,create:e,destroy:t,deps:n,next:null},e=ct.updateQueue,e===null?(e={lastEffect:null,stores:null},ct.updateQueue=e,e.lastEffect=r.next=r):(t=e.lastEffect,t===null?e.lastEffect=r.next=r:(n=t.next,t.next=r,r.next=n,e.lastEffect=r)),r}function h_(){return Ur().memoizedState}function Su(r,e,t,n){var i=ln();ct.flags|=r,i.memoizedState=Ho(1|e,t,void 0,n===void 0?null:n)}function Bd(r,e,t,n){var i=Ur();n=n===void 0?null:n;var a=void 0;if(Ot!==null){var s=Ot.memoizedState;if(a=s.destroy,n!==null&&pp(n,s.deps)){i.memoizedState=Ho(e,t,a,n);return}}ct.flags|=r,i.memoizedState=Ho(1|e,t,a,n)}function eg(r,e){return Su(8390656,8,r,e)}function yp(r,e){return Bd(2048,8,r,e)}function f_(r,e){return Bd(4,2,r,e)}function v_(r,e){return Bd(4,4,r,e)}function p_(r,e){if(typeof e=="function")return r=r(),e(r),function(){e(null)};if(e!=null)return r=r(),e.current=r,function(){e.current=null}}function m_(r,e,t){return t=t!=null?t.concat([r]):null,Bd(4,4,p_.bind(null,e,r),t)}function Sp(){}function g_(r,e){var t=Ur();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&pp(e,n[1])?n[0]:(t.memoizedState=[r,e],r)}function y_(r,e){var t=Ur();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&pp(e,n[1])?n[0]:(r=r(),t.memoizedState=[r,e],r)}function S_(r,e,t){return sa&21?(Xr(t,e)||(t=TE(),ct.lanes|=t,oa|=t,r.baseState=!0),e):(r.baseState&&(r.baseState=!1,lr=!0),r.memoizedState=t)}function IR(r,e){var t=He;He=t!==0&&4>t?t:4,r(!0);var n=Kc.transition;Kc.transition={};try{r(!1),e()}finally{He=t,Kc.transition=n}}function E_(){return Ur().memoizedState}function CR(r,e,t){var n=Si(r);if(t={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null},__(r))b_(e,t);else if(t=r_(r,e,t,n),t!==null){var i=er();Jr(t,r,n,i),w_(t,e,n)}}function OR(r,e,t){var n=Si(r),i={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null};if(__(r))b_(e,i);else{var a=r.alternate;if(r.lanes===0&&(a===null||a.lanes===0)&&(a=e.lastRenderedReducer,a!==null))try{var s=e.lastRenderedState,o=a(s,t);if(i.hasEagerState=!0,i.eagerState=o,Xr(o,s)){var l=e.interleaved;l===null?(i.next=i,dp(e)):(i.next=l.next,l.next=i),e.interleaved=i;return}}catch{}finally{}t=r_(r,e,i,n),t!==null&&(i=er(),Jr(t,r,n,i),w_(t,e,n))}}function __(r){var e=r.alternate;return r===ct||e!==null&&e===ct}function b_(r,e){yo=rd=!0;var t=r.pending;t===null?e.next=e:(e.next=t.next,t.next=e),r.pending=e}function w_(r,e,t){if(t&4194240){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,Yv(r,t)}}var nd={readContext:Lr,useCallback:Wt,useContext:Wt,useEffect:Wt,useImperativeHandle:Wt,useInsertionEffect:Wt,useLayoutEffect:Wt,useMemo:Wt,useReducer:Wt,useRef:Wt,useState:Wt,useDebugValue:Wt,useDeferredValue:Wt,useTransition:Wt,useMutableSource:Wt,useSyncExternalStore:Wt,useId:Wt,unstable_isNewReconciler:!1},kR={readContext:Lr,useCallback:function(r,e){return ln().memoizedState=[r,e===void 0?null:e],r},useContext:Lr,useEffect:eg,useImperativeHandle:function(r,e,t){return t=t!=null?t.concat([r]):null,Su(4194308,4,p_.bind(null,e,r),t)},useLayoutEffect:function(r,e){return Su(4194308,4,r,e)},useInsertionEffect:function(r,e){return Su(4,2,r,e)},useMemo:function(r,e){var t=ln();return e=e===void 0?null:e,r=r(),t.memoizedState=[r,e],r},useReducer:function(r,e,t){var n=ln();return e=t!==void 0?t(e):e,n.memoizedState=n.baseState=e,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:e},n.queue=r,r=r.dispatch=CR.bind(null,ct,r),[n.memoizedState,r]},useRef:function(r){var e=ln();return r={current:r},e.memoizedState=r},useState:Zm,useDebugValue:Sp,useDeferredValue:function(r){return ln().memoizedState=r},useTransition:function(){var r=Zm(!1),e=r[0];return r=IR.bind(null,r[1]),ln().memoizedState=r,[e,r]},useMutableSource:function(){},useSyncExternalStore:function(r,e,t){var n=ct,i=ln();if(at){if(t===void 0)throw Error(ne(407));t=t()}else{if(t=e(),Nt===null)throw Error(ne(349));sa&30||o_(n,e,t)}i.memoizedState=t;var a={value:t,getSnapshot:e};return i.queue=a,eg(u_.bind(null,n,a,r),[r]),n.flags|=2048,Ho(9,l_.bind(null,n,a,t,e),void 0,null),t},useId:function(){var r=ln(),e=Nt.identifierPrefix;if(at){var t=Pn,n=kn;t=(n&~(1<<32-zr(n)-1)).toString(32)+t,e=":"+e+"R"+t,t=Go++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=RR++,e=":"+e+"r"+t.toString(32)+":";return r.memoizedState=e},unstable_isNewReconciler:!1},PR={readContext:Lr,useCallback:g_,useContext:Lr,useEffect:yp,useImperativeHandle:m_,useInsertionEffect:f_,useLayoutEffect:v_,useMemo:y_,useReducer:Vc,useRef:h_,useState:function(){return Vc(qo)},useDebugValue:Sp,useDeferredValue:function(r){var e=Ur();return S_(e,Ot.memoizedState,r)},useTransition:function(){var r=Vc(qo)[0],e=Ur().memoizedState;return[r,e]},useMutableSource:a_,useSyncExternalStore:s_,useId:E_,unstable_isNewReconciler:!1},MR={readContext:Lr,useCallback:g_,useContext:Lr,useEffect:yp,useImperativeHandle:m_,useInsertionEffect:f_,useLayoutEffect:v_,useMemo:y_,useReducer:Gc,useRef:h_,useState:function(){return Gc(qo)},useDebugValue:Sp,useDeferredValue:function(r){var e=Ur();return Ot===null?e.memoizedState=r:S_(e,Ot.memoizedState,r)},useTransition:function(){var r=Gc(qo)[0],e=Ur().memoizedState;return[r,e]},useMutableSource:a_,useSyncExternalStore:s_,useId:E_,unstable_isNewReconciler:!1};function Wr(r,e){if(r&&r.defaultProps){e=ft({},e),r=r.defaultProps;for(var t in r)e[t]===void 0&&(e[t]=r[t]);return e}return e}function af(r,e,t,n){e=r.memoizedState,t=t(n,e),t=t==null?e:ft({},e,t),r.memoizedState=t,r.lanes===0&&(r.updateQueue.baseState=t)}var $d={isMounted:function(r){return(r=r._reactInternals)?va(r)===r:!1},enqueueSetState:function(r,e,t){r=r._reactInternals;var n=er(),i=Si(r),a=xn(n,i);a.payload=e,t!=null&&(a.callback=t),e=gi(r,a,i),e!==null&&(Jr(e,r,i,n),gu(e,r,i))},enqueueReplaceState:function(r,e,t){r=r._reactInternals;var n=er(),i=Si(r),a=xn(n,i);a.tag=1,a.payload=e,t!=null&&(a.callback=t),e=gi(r,a,i),e!==null&&(Jr(e,r,i,n),gu(e,r,i))},enqueueForceUpdate:function(r,e){r=r._reactInternals;var t=er(),n=Si(r),i=xn(t,n);i.tag=2,e!=null&&(i.callback=e),e=gi(r,i,n),e!==null&&(Jr(e,r,n,t),gu(e,r,n))}};function tg(r,e,t,n,i,a,s){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(n,a,s):e.prototype&&e.prototype.isPureReactComponent?!Fo(t,n)||!Fo(i,a):!0}function T_(r,e,t){var n=!1,i=Ri,a=e.contextType;return typeof a=="object"&&a!==null?a=Lr(a):(i=cr(e)?ia:Jt.current,n=e.contextTypes,a=(n=n!=null)?ls(r,i):Ri),e=new e(t,a),r.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=$d,r.stateNode=e,e._reactInternals=r,n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=i,r.__reactInternalMemoizedMaskedChildContext=a),e}function rg(r,e,t,n){r=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,n),e.state!==r&&$d.enqueueReplaceState(e,e.state,null)}function sf(r,e,t,n){var i=r.stateNode;i.props=t,i.state=r.memoizedState,i.refs={},cp(r);var a=e.contextType;typeof a=="object"&&a!==null?i.context=Lr(a):(a=cr(e)?ia:Jt.current,i.context=ls(r,a)),i.state=r.memoizedState,a=e.getDerivedStateFromProps,typeof a=="function"&&(af(r,e,a,t),i.state=r.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&$d.enqueueReplaceState(i,i.state,null),ed(r,t,i,n),i.state=r.memoizedState),typeof i.componentDidMount=="function"&&(r.flags|=4194308)}function hs(r,e){try{var t="",n=e;do t+=aT(n),n=n.return;while(n);var i=t}catch(a){i=`
Error generating stack: `+a.message+`
`+a.stack}return{value:r,source:e,stack:i,digest:null}}function qc(r,e,t){return{value:r,source:null,stack:t??null,digest:e??null}}function of(r,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var AR=typeof WeakMap=="function"?WeakMap:Map;function R_(r,e,t){t=xn(-1,t),t.tag=3,t.payload={element:null};var n=e.value;return t.callback=function(){ad||(ad=!0,gf=n),of(r,e)},t}function I_(r,e,t){t=xn(-1,t),t.tag=3;var n=r.type.getDerivedStateFromError;if(typeof n=="function"){var i=e.value;t.payload=function(){return n(i)},t.callback=function(){of(r,e)}}var a=r.stateNode;return a!==null&&typeof a.componentDidCatch=="function"&&(t.callback=function(){of(r,e),typeof n!="function"&&(yi===null?yi=new Set([this]):yi.add(this));var s=e.stack;this.componentDidCatch(e.value,{componentStack:s!==null?s:""})}),t}function ng(r,e,t){var n=r.pingCache;if(n===null){n=r.pingCache=new AR;var i=new Set;n.set(e,i)}else i=n.get(e),i===void 0&&(i=new Set,n.set(e,i));i.has(t)||(i.add(t),r=qR.bind(null,r,e,t),e.then(r,r))}function ig(r){do{var e;if((e=r.tag===13)&&(e=r.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return r;r=r.return}while(r!==null);return null}function ag(r,e,t,n,i){return r.mode&1?(r.flags|=65536,r.lanes=i,r):(r===e?r.flags|=65536:(r.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=xn(-1,1),e.tag=2,gi(t,e,1))),t.lanes|=1),r)}var DR=$n.ReactCurrentOwner,lr=!1;function Qt(r,e,t,n){e.child=r===null?t_(e,null,t,n):ds(e,r.child,t,n)}function sg(r,e,t,n,i){t=t.render;var a=e.ref;return Ja(e,i),n=mp(r,e,t,n,a,i),t=gp(),r!==null&&!lr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Bn(r,e,i)):(at&&t&&ip(e),e.flags|=1,Qt(r,e,n,i),e.child)}function og(r,e,t,n,i){if(r===null){var a=t.type;return typeof a=="function"&&!Cp(a)&&a.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=a,C_(r,e,a,n,i)):(r=wu(t.type,null,n,e,e.mode,i),r.ref=e.ref,r.return=e,e.child=r)}if(a=r.child,!(r.lanes&i)){var s=a.memoizedProps;if(t=t.compare,t=t!==null?t:Fo,t(s,n)&&r.ref===e.ref)return Bn(r,e,i)}return e.flags|=1,r=Ei(a,n),r.ref=e.ref,r.return=e,e.child=r}function C_(r,e,t,n,i){if(r!==null){var a=r.memoizedProps;if(Fo(a,n)&&r.ref===e.ref)if(lr=!1,e.pendingProps=n=a,(r.lanes&i)!==0)r.flags&131072&&(lr=!0);else return e.lanes=r.lanes,Bn(r,e,i)}return lf(r,e,t,n,i)}function O_(r,e,t){var n=e.pendingProps,i=n.children,a=r!==null?r.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ze($a,Sr),Sr|=t;else{if(!(t&1073741824))return r=a!==null?a.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:r,cachePool:null,transitions:null},e.updateQueue=null,Ze($a,Sr),Sr|=r,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=a!==null?a.baseLanes:t,Ze($a,Sr),Sr|=n}else a!==null?(n=a.baseLanes|t,e.memoizedState=null):n=t,Ze($a,Sr),Sr|=n;return Qt(r,e,i,t),e.child}function k_(r,e){var t=e.ref;(r===null&&t!==null||r!==null&&r.ref!==t)&&(e.flags|=512,e.flags|=2097152)}function lf(r,e,t,n,i){var a=cr(t)?ia:Jt.current;return a=ls(e,a),Ja(e,i),t=mp(r,e,t,n,a,i),n=gp(),r!==null&&!lr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Bn(r,e,i)):(at&&n&&ip(e),e.flags|=1,Qt(r,e,t,i),e.child)}function lg(r,e,t,n,i){if(cr(t)){var a=!0;Ju(e)}else a=!1;if(Ja(e,i),e.stateNode===null)Eu(r,e),T_(e,t,n),sf(e,t,n,i),n=!0;else if(r===null){var s=e.stateNode,o=e.memoizedProps;s.props=o;var l=s.context,u=t.contextType;typeof u=="object"&&u!==null?u=Lr(u):(u=cr(t)?ia:Jt.current,u=ls(e,u));var d=t.getDerivedStateFromProps,h=typeof d=="function"||typeof s.getSnapshotBeforeUpdate=="function";h||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(o!==n||l!==u)&&rg(e,s,n,u),ri=!1;var f=e.memoizedState;s.state=f,ed(e,n,s,i),l=e.memoizedState,o!==n||f!==l||dr.current||ri?(typeof d=="function"&&(af(e,t,d,n),l=e.memoizedState),(o=ri||tg(e,t,o,n,f,l,u))?(h||typeof s.UNSAFE_componentWillMount!="function"&&typeof s.componentWillMount!="function"||(typeof s.componentWillMount=="function"&&s.componentWillMount(),typeof s.UNSAFE_componentWillMount=="function"&&s.UNSAFE_componentWillMount()),typeof s.componentDidMount=="function"&&(e.flags|=4194308)):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=l),s.props=n,s.state=l,s.context=u,n=o):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{s=e.stateNode,n_(r,e),o=e.memoizedProps,u=e.type===e.elementType?o:Wr(e.type,o),s.props=u,h=e.pendingProps,f=s.context,l=t.contextType,typeof l=="object"&&l!==null?l=Lr(l):(l=cr(t)?ia:Jt.current,l=ls(e,l));var m=t.getDerivedStateFromProps;(d=typeof m=="function"||typeof s.getSnapshotBeforeUpdate=="function")||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(o!==h||f!==l)&&rg(e,s,n,l),ri=!1,f=e.memoizedState,s.state=f,ed(e,n,s,i);var v=e.memoizedState;o!==h||f!==v||dr.current||ri?(typeof m=="function"&&(af(e,t,m,n),v=e.memoizedState),(u=ri||tg(e,t,u,n,f,v,l)||!1)?(d||typeof s.UNSAFE_componentWillUpdate!="function"&&typeof s.componentWillUpdate!="function"||(typeof s.componentWillUpdate=="function"&&s.componentWillUpdate(n,v,l),typeof s.UNSAFE_componentWillUpdate=="function"&&s.UNSAFE_componentWillUpdate(n,v,l)),typeof s.componentDidUpdate=="function"&&(e.flags|=4),typeof s.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof s.componentDidUpdate!="function"||o===r.memoizedProps&&f===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||o===r.memoizedProps&&f===r.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=v),s.props=n,s.state=v,s.context=l,n=u):(typeof s.componentDidUpdate!="function"||o===r.memoizedProps&&f===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||o===r.memoizedProps&&f===r.memoizedState||(e.flags|=1024),n=!1)}return uf(r,e,t,n,a,i)}function uf(r,e,t,n,i,a){k_(r,e);var s=(e.flags&128)!==0;if(!n&&!s)return i&&Hm(e,t,!1),Bn(r,e,a);n=e.stateNode,DR.current=e;var o=s&&typeof t.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,r!==null&&s?(e.child=ds(e,r.child,null,a),e.child=ds(e,null,o,a)):Qt(r,e,o,a),e.memoizedState=n.state,i&&Hm(e,t,!0),e.child}function P_(r){var e=r.stateNode;e.pendingContext?qm(r,e.pendingContext,e.pendingContext!==e.context):e.context&&qm(r,e.context,!1),hp(r,e.containerInfo)}function ug(r,e,t,n,i){return us(),sp(i),e.flags|=256,Qt(r,e,t,n),e.child}var df={dehydrated:null,treeContext:null,retryLane:0};function cf(r){return{baseLanes:r,cachePool:null,transitions:null}}function M_(r,e,t){var n=e.pendingProps,i=dt.current,a=!1,s=(e.flags&128)!==0,o;if((o=s)||(o=r!==null&&r.memoizedState===null?!1:(i&2)!==0),o?(a=!0,e.flags&=-129):(r===null||r.memoizedState!==null)&&(i|=1),Ze(dt,i&1),r===null)return rf(e),r=e.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(e.mode&1?r.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(s=n.children,r=n.fallback,a?(n=e.mode,a=e.child,s={mode:"hidden",children:s},!(n&1)&&a!==null?(a.childLanes=0,a.pendingProps=s):a=Vd(s,n,0,null),r=ea(r,n,t,null),a.return=e,r.return=e,a.sibling=r,e.child=a,e.child.memoizedState=cf(t),e.memoizedState=df,r):Ep(e,s));if(i=r.memoizedState,i!==null&&(o=i.dehydrated,o!==null))return xR(r,e,s,n,o,i,t);if(a){a=n.fallback,s=e.mode,i=r.child,o=i.sibling;var l={mode:"hidden",children:n.children};return!(s&1)&&e.child!==i?(n=e.child,n.childLanes=0,n.pendingProps=l,e.deletions=null):(n=Ei(i,l),n.subtreeFlags=i.subtreeFlags&14680064),o!==null?a=Ei(o,a):(a=ea(a,s,t,null),a.flags|=2),a.return=e,n.return=e,n.sibling=a,e.child=n,n=a,a=e.child,s=r.child.memoizedState,s=s===null?cf(t):{baseLanes:s.baseLanes|t,cachePool:null,transitions:s.transitions},a.memoizedState=s,a.childLanes=r.childLanes&~t,e.memoizedState=df,n}return a=r.child,r=a.sibling,n=Ei(a,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=t),n.return=e,n.sibling=null,r!==null&&(t=e.deletions,t===null?(e.deletions=[r],e.flags|=16):t.push(r)),e.child=n,e.memoizedState=null,n}function Ep(r,e){return e=Vd({mode:"visible",children:e},r.mode,0,null),e.return=r,r.child=e}function zl(r,e,t,n){return n!==null&&sp(n),ds(e,r.child,null,t),r=Ep(e,e.pendingProps.children),r.flags|=2,e.memoizedState=null,r}function xR(r,e,t,n,i,a,s){if(t)return e.flags&256?(e.flags&=-257,n=qc(Error(ne(422))),zl(r,e,s,n)):e.memoizedState!==null?(e.child=r.child,e.flags|=128,null):(a=n.fallback,i=e.mode,n=Vd({mode:"visible",children:n.children},i,0,null),a=ea(a,i,s,null),a.flags|=2,n.return=e,a.return=e,n.sibling=a,e.child=n,e.mode&1&&ds(e,r.child,null,s),e.child.memoizedState=cf(s),e.memoizedState=df,a);if(!(e.mode&1))return zl(r,e,s,null);if(i.data==="$!"){if(n=i.nextSibling&&i.nextSibling.dataset,n)var o=n.dgst;return n=o,a=Error(ne(419)),n=qc(a,n,void 0),zl(r,e,s,n)}if(o=(s&r.childLanes)!==0,lr||o){if(n=Nt,n!==null){switch(s&-s){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(n.suspendedLanes|s)?0:i,i!==0&&i!==a.retryLane&&(a.retryLane=i,Fn(r,i),Jr(n,r,i,-1))}return Ip(),n=qc(Error(ne(421))),zl(r,e,s,n)}return i.data==="$?"?(e.flags|=128,e.child=r.child,e=HR.bind(null,r),i._reactRetry=e,null):(r=a.treeContext,_r=mi(i.nextSibling),br=e,at=!0,qr=null,r!==null&&(Mr[Ar++]=kn,Mr[Ar++]=Pn,Mr[Ar++]=aa,kn=r.id,Pn=r.overflow,aa=e),e=Ep(e,n.children),e.flags|=4096,e)}function dg(r,e,t){r.lanes|=e;var n=r.alternate;n!==null&&(n.lanes|=e),nf(r.return,e,t)}function Hc(r,e,t,n,i){var a=r.memoizedState;a===null?r.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:t,tailMode:i}:(a.isBackwards=e,a.rendering=null,a.renderingStartTime=0,a.last=n,a.tail=t,a.tailMode=i)}function A_(r,e,t){var n=e.pendingProps,i=n.revealOrder,a=n.tail;if(Qt(r,e,n.children,t),n=dt.current,n&2)n=n&1|2,e.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=e.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&dg(r,t,e);else if(r.tag===19)dg(r,t,e);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break e;for(;r.sibling===null;){if(r.return===null||r.return===e)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}n&=1}if(Ze(dt,n),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)r=t.alternate,r!==null&&td(r)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),Hc(e,!1,i,t,a);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(r=i.alternate,r!==null&&td(r)===null){e.child=i;break}r=i.sibling,i.sibling=t,t=i,i=r}Hc(e,!0,t,null,a);break;case"together":Hc(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function Eu(r,e){!(e.mode&1)&&r!==null&&(r.alternate=null,e.alternate=null,e.flags|=2)}function Bn(r,e,t){if(r!==null&&(e.dependencies=r.dependencies),oa|=e.lanes,!(t&e.childLanes))return null;if(r!==null&&e.child!==r.child)throw Error(ne(153));if(e.child!==null){for(r=e.child,t=Ei(r,r.pendingProps),e.child=t,t.return=e;r.sibling!==null;)r=r.sibling,t=t.sibling=Ei(r,r.pendingProps),t.return=e;t.sibling=null}return e.child}function NR(r,e,t){switch(e.tag){case 3:P_(e),us();break;case 5:i_(e);break;case 1:cr(e.type)&&Ju(e);break;case 4:hp(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,i=e.memoizedProps.value;Ze(Xu,n._currentValue),n._currentValue=i;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(Ze(dt,dt.current&1),e.flags|=128,null):t&e.child.childLanes?M_(r,e,t):(Ze(dt,dt.current&1),r=Bn(r,e,t),r!==null?r.sibling:null);Ze(dt,dt.current&1);break;case 19:if(n=(t&e.childLanes)!==0,r.flags&128){if(n)return A_(r,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),Ze(dt,dt.current),n)break;return null;case 22:case 23:return e.lanes=0,O_(r,e,t)}return Bn(r,e,t)}var D_,hf,x_,N_;D_=function(r,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)r.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};hf=function(){};x_=function(r,e,t,n){var i=r.memoizedProps;if(i!==n){r=e.stateNode,Yi(pn.current);var a=null;switch(t){case"input":i=Dh(r,i),n=Dh(r,n),a=[];break;case"select":i=ft({},i,{value:void 0}),n=ft({},n,{value:void 0}),a=[];break;case"textarea":i=Lh(r,i),n=Lh(r,n),a=[];break;default:typeof i.onClick!="function"&&typeof n.onClick=="function"&&(r.onclick=Hu)}jh(t,n);var s;t=null;for(u in i)if(!n.hasOwnProperty(u)&&i.hasOwnProperty(u)&&i[u]!=null)if(u==="style"){var o=i[u];for(s in o)o.hasOwnProperty(s)&&(t||(t={}),t[s]="")}else u!=="dangerouslySetInnerHTML"&&u!=="children"&&u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&u!=="autoFocus"&&(Ao.hasOwnProperty(u)?a||(a=[]):(a=a||[]).push(u,null));for(u in n){var l=n[u];if(o=i!=null?i[u]:void 0,n.hasOwnProperty(u)&&l!==o&&(l!=null||o!=null))if(u==="style")if(o){for(s in o)!o.hasOwnProperty(s)||l&&l.hasOwnProperty(s)||(t||(t={}),t[s]="");for(s in l)l.hasOwnProperty(s)&&o[s]!==l[s]&&(t||(t={}),t[s]=l[s])}else t||(a||(a=[]),a.push(u,t)),t=l;else u==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,o=o?o.__html:void 0,l!=null&&o!==l&&(a=a||[]).push(u,l)):u==="children"?typeof l!="string"&&typeof l!="number"||(a=a||[]).push(u,""+l):u!=="suppressContentEditableWarning"&&u!=="suppressHydrationWarning"&&(Ao.hasOwnProperty(u)?(l!=null&&u==="onScroll"&&et("scroll",r),a||o===l||(a=[])):(a=a||[]).push(u,l))}t&&(a=a||[]).push("style",t);var u=a;(e.updateQueue=u)&&(e.flags|=4)}};N_=function(r,e,t,n){t!==n&&(e.flags|=4)};function Ks(r,e){if(!at)switch(r.tailMode){case"hidden":e=r.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?r.tail=null:t.sibling=null;break;case"collapsed":t=r.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e||r.tail===null?r.tail=null:r.tail.sibling=null:n.sibling=null}}function Kt(r){var e=r.alternate!==null&&r.alternate.child===r.child,t=0,n=0;if(e)for(var i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags&14680064,n|=i.flags&14680064,i.return=r,i=i.sibling;else for(i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=r,i=i.sibling;return r.subtreeFlags|=n,r.childLanes=t,e}function LR(r,e,t){var n=e.pendingProps;switch(ap(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Kt(e),null;case 1:return cr(e.type)&&zu(),Kt(e),null;case 3:return n=e.stateNode,cs(),rt(dr),rt(Jt),vp(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(r===null||r.child===null)&&(ql(e)?e.flags|=4:r===null||r.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,qr!==null&&(Ef(qr),qr=null))),hf(r,e),Kt(e),null;case 5:fp(e);var i=Yi(Vo.current);if(t=e.type,r!==null&&e.stateNode!=null)x_(r,e,t,n,i),r.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(ne(166));return Kt(e),null}if(r=Yi(pn.current),ql(e)){n=e.stateNode,t=e.type;var a=e.memoizedProps;switch(n[hn]=e,n[Wo]=a,r=(e.mode&1)!==0,t){case"dialog":et("cancel",n),et("close",n);break;case"iframe":case"object":case"embed":et("load",n);break;case"video":case"audio":for(i=0;i<oo.length;i++)et(oo[i],n);break;case"source":et("error",n);break;case"img":case"image":case"link":et("error",n),et("load",n);break;case"details":et("toggle",n);break;case"input":Sm(n,a),et("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!a.multiple},et("invalid",n);break;case"textarea":_m(n,a),et("invalid",n)}jh(t,a),i=null;for(var s in a)if(a.hasOwnProperty(s)){var o=a[s];s==="children"?typeof o=="string"?n.textContent!==o&&(a.suppressHydrationWarning!==!0&&Gl(n.textContent,o,r),i=["children",o]):typeof o=="number"&&n.textContent!==""+o&&(a.suppressHydrationWarning!==!0&&Gl(n.textContent,o,r),i=["children",""+o]):Ao.hasOwnProperty(s)&&o!=null&&s==="onScroll"&&et("scroll",n)}switch(t){case"input":Ul(n),Em(n,a,!0);break;case"textarea":Ul(n),bm(n);break;case"select":case"option":break;default:typeof a.onClick=="function"&&(n.onclick=Hu)}n=i,e.updateQueue=n,n!==null&&(e.flags|=4)}else{s=i.nodeType===9?i:i.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=uE(t)),r==="http://www.w3.org/1999/xhtml"?t==="script"?(r=s.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof n.is=="string"?r=s.createElement(t,{is:n.is}):(r=s.createElement(t),t==="select"&&(s=r,n.multiple?s.multiple=!0:n.size&&(s.size=n.size))):r=s.createElementNS(r,t),r[hn]=e,r[Wo]=n,D_(r,e,!1,!1),e.stateNode=r;e:{switch(s=Fh(t,n),t){case"dialog":et("cancel",r),et("close",r),i=n;break;case"iframe":case"object":case"embed":et("load",r),i=n;break;case"video":case"audio":for(i=0;i<oo.length;i++)et(oo[i],r);i=n;break;case"source":et("error",r),i=n;break;case"img":case"image":case"link":et("error",r),et("load",r),i=n;break;case"details":et("toggle",r),i=n;break;case"input":Sm(r,n),i=Dh(r,n),et("invalid",r);break;case"option":i=n;break;case"select":r._wrapperState={wasMultiple:!!n.multiple},i=ft({},n,{value:void 0}),et("invalid",r);break;case"textarea":_m(r,n),i=Lh(r,n),et("invalid",r);break;default:i=n}jh(t,i),o=i;for(a in o)if(o.hasOwnProperty(a)){var l=o[a];a==="style"?hE(r,l):a==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,l!=null&&dE(r,l)):a==="children"?typeof l=="string"?(t!=="textarea"||l!=="")&&Do(r,l):typeof l=="number"&&Do(r,""+l):a!=="suppressContentEditableWarning"&&a!=="suppressHydrationWarning"&&a!=="autoFocus"&&(Ao.hasOwnProperty(a)?l!=null&&a==="onScroll"&&et("scroll",r):l!=null&&Vv(r,a,l,s))}switch(t){case"input":Ul(r),Em(r,n,!1);break;case"textarea":Ul(r),bm(r);break;case"option":n.value!=null&&r.setAttribute("value",""+Ti(n.value));break;case"select":r.multiple=!!n.multiple,a=n.value,a!=null?Ga(r,!!n.multiple,a,!1):n.defaultValue!=null&&Ga(r,!!n.multiple,n.defaultValue,!0);break;default:typeof i.onClick=="function"&&(r.onclick=Hu)}switch(t){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Kt(e),null;case 6:if(r&&e.stateNode!=null)N_(r,e,r.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(ne(166));if(t=Yi(Vo.current),Yi(pn.current),ql(e)){if(n=e.stateNode,t=e.memoizedProps,n[hn]=e,(a=n.nodeValue!==t)&&(r=br,r!==null))switch(r.tag){case 3:Gl(n.nodeValue,t,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&Gl(n.nodeValue,t,(r.mode&1)!==0)}a&&(e.flags|=4)}else n=(t.nodeType===9?t:t.ownerDocument).createTextNode(n),n[hn]=e,e.stateNode=n}return Kt(e),null;case 13:if(rt(dt),n=e.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(at&&_r!==null&&e.mode&1&&!(e.flags&128))ZE(),us(),e.flags|=98560,a=!1;else if(a=ql(e),n!==null&&n.dehydrated!==null){if(r===null){if(!a)throw Error(ne(318));if(a=e.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(ne(317));a[hn]=e}else us(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Kt(e),a=!1}else qr!==null&&(Ef(qr),qr=null),a=!0;if(!a)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(n=n!==null,n!==(r!==null&&r.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(r===null||dt.current&1?Pt===0&&(Pt=3):Ip())),e.updateQueue!==null&&(e.flags|=4),Kt(e),null);case 4:return cs(),hf(r,e),r===null&&Bo(e.stateNode.containerInfo),Kt(e),null;case 10:return up(e.type._context),Kt(e),null;case 17:return cr(e.type)&&zu(),Kt(e),null;case 19:if(rt(dt),a=e.memoizedState,a===null)return Kt(e),null;if(n=(e.flags&128)!==0,s=a.rendering,s===null)if(n)Ks(a,!1);else{if(Pt!==0||r!==null&&r.flags&128)for(r=e.child;r!==null;){if(s=td(r),s!==null){for(e.flags|=128,Ks(a,!1),n=s.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=t,t=e.child;t!==null;)a=t,r=n,a.flags&=14680066,s=a.alternate,s===null?(a.childLanes=0,a.lanes=r,a.child=null,a.subtreeFlags=0,a.memoizedProps=null,a.memoizedState=null,a.updateQueue=null,a.dependencies=null,a.stateNode=null):(a.childLanes=s.childLanes,a.lanes=s.lanes,a.child=s.child,a.subtreeFlags=0,a.deletions=null,a.memoizedProps=s.memoizedProps,a.memoizedState=s.memoizedState,a.updateQueue=s.updateQueue,a.type=s.type,r=s.dependencies,a.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),t=t.sibling;return Ze(dt,dt.current&1|2),e.child}r=r.sibling}a.tail!==null&&gt()>fs&&(e.flags|=128,n=!0,Ks(a,!1),e.lanes=4194304)}else{if(!n)if(r=td(s),r!==null){if(e.flags|=128,n=!0,t=r.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),Ks(a,!0),a.tail===null&&a.tailMode==="hidden"&&!s.alternate&&!at)return Kt(e),null}else 2*gt()-a.renderingStartTime>fs&&t!==1073741824&&(e.flags|=128,n=!0,Ks(a,!1),e.lanes=4194304);a.isBackwards?(s.sibling=e.child,e.child=s):(t=a.last,t!==null?t.sibling=s:e.child=s,a.last=s)}return a.tail!==null?(e=a.tail,a.rendering=e,a.tail=e.sibling,a.renderingStartTime=gt(),e.sibling=null,t=dt.current,Ze(dt,n?t&1|2:t&1),e):(Kt(e),null);case 22:case 23:return Rp(),n=e.memoizedState!==null,r!==null&&r.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?Sr&1073741824&&(Kt(e),e.subtreeFlags&6&&(e.flags|=8192)):Kt(e),null;case 24:return null;case 25:return null}throw Error(ne(156,e.tag))}function UR(r,e){switch(ap(e),e.tag){case 1:return cr(e.type)&&zu(),r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 3:return cs(),rt(dr),rt(Jt),vp(),r=e.flags,r&65536&&!(r&128)?(e.flags=r&-65537|128,e):null;case 5:return fp(e),null;case 13:if(rt(dt),r=e.memoizedState,r!==null&&r.dehydrated!==null){if(e.alternate===null)throw Error(ne(340));us()}return r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 19:return rt(dt),null;case 4:return cs(),null;case 10:return up(e.type._context),null;case 22:case 23:return Rp(),null;case 24:return null;default:return null}}var Jl=!1,qt=!1,jR=typeof WeakSet=="function"?WeakSet:Set,pe=null;function Ba(r,e){var t=r.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(n){pt(r,e,n)}else t.current=null}function ff(r,e,t){try{t()}catch(n){pt(r,e,n)}}var cg=!1;function FR(r,e){if(Jh=Vu,r=BE(),np(r)){if("selectionStart"in r)var t={start:r.selectionStart,end:r.selectionEnd};else e:{t=(t=r.ownerDocument)&&t.defaultView||window;var n=t.getSelection&&t.getSelection();if(n&&n.rangeCount!==0){t=n.anchorNode;var i=n.anchorOffset,a=n.focusNode;n=n.focusOffset;try{t.nodeType,a.nodeType}catch{t=null;break e}var s=0,o=-1,l=-1,u=0,d=0,h=r,f=null;t:for(;;){for(var m;h!==t||i!==0&&h.nodeType!==3||(o=s+i),h!==a||n!==0&&h.nodeType!==3||(l=s+n),h.nodeType===3&&(s+=h.nodeValue.length),(m=h.firstChild)!==null;)f=h,h=m;for(;;){if(h===r)break t;if(f===t&&++u===i&&(o=s),f===a&&++d===n&&(l=s),(m=h.nextSibling)!==null)break;h=f,f=h.parentNode}h=m}t=o===-1||l===-1?null:{start:o,end:l}}else t=null}t=t||{start:0,end:0}}else t=null;for(Yh={focusedElem:r,selectionRange:t},Vu=!1,pe=e;pe!==null;)if(e=pe,r=e.child,(e.subtreeFlags&1028)!==0&&r!==null)r.return=e,pe=r;else for(;pe!==null;){e=pe;try{var v=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(v!==null){var y=v.memoizedProps,I=v.memoizedState,g=e.stateNode,p=g.getSnapshotBeforeUpdate(e.elementType===e.type?y:Wr(e.type,y),I);g.__reactInternalSnapshotBeforeUpdate=p}break;case 3:var b=e.stateNode.containerInfo;b.nodeType===1?b.textContent="":b.nodeType===9&&b.documentElement&&b.removeChild(b.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ne(163))}}catch(R){pt(e,e.return,R)}if(r=e.sibling,r!==null){r.return=e.return,pe=r;break}pe=e.return}return v=cg,cg=!1,v}function So(r,e,t){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var i=n=n.next;do{if((i.tag&r)===r){var a=i.destroy;i.destroy=void 0,a!==void 0&&ff(e,t,a)}i=i.next}while(i!==n)}}function Wd(r,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&r)===r){var n=t.create;t.destroy=n()}t=t.next}while(t!==e)}}function vf(r){var e=r.ref;if(e!==null){var t=r.stateNode;switch(r.tag){case 5:r=t;break;default:r=t}typeof e=="function"?e(r):e.current=r}}function L_(r){var e=r.alternate;e!==null&&(r.alternate=null,L_(e)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(e=r.stateNode,e!==null&&(delete e[hn],delete e[Wo],delete e[Zh],delete e[_R],delete e[bR])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}function U_(r){return r.tag===5||r.tag===3||r.tag===4}function hg(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||U_(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function pf(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(r,e):t.insertBefore(r,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(r,t)):(e=t,e.appendChild(r)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=Hu));else if(n!==4&&(r=r.child,r!==null))for(pf(r,e,t),r=r.sibling;r!==null;)pf(r,e,t),r=r.sibling}function mf(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.insertBefore(r,e):t.appendChild(r);else if(n!==4&&(r=r.child,r!==null))for(mf(r,e,t),r=r.sibling;r!==null;)mf(r,e,t),r=r.sibling}var jt=null,Vr=!1;function qn(r,e,t){for(t=t.child;t!==null;)j_(r,e,t),t=t.sibling}function j_(r,e,t){if(vn&&typeof vn.onCommitFiberUnmount=="function")try{vn.onCommitFiberUnmount(xd,t)}catch{}switch(t.tag){case 5:qt||Ba(t,e);case 6:var n=jt,i=Vr;jt=null,qn(r,e,t),jt=n,Vr=i,jt!==null&&(Vr?(r=jt,t=t.stateNode,r.nodeType===8?r.parentNode.removeChild(t):r.removeChild(t)):jt.removeChild(t.stateNode));break;case 18:jt!==null&&(Vr?(r=jt,t=t.stateNode,r.nodeType===8?Bc(r.parentNode,t):r.nodeType===1&&Bc(r,t),Uo(r)):Bc(jt,t.stateNode));break;case 4:n=jt,i=Vr,jt=t.stateNode.containerInfo,Vr=!0,qn(r,e,t),jt=n,Vr=i;break;case 0:case 11:case 14:case 15:if(!qt&&(n=t.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){i=n=n.next;do{var a=i,s=a.destroy;a=a.tag,s!==void 0&&(a&2||a&4)&&ff(t,e,s),i=i.next}while(i!==n)}qn(r,e,t);break;case 1:if(!qt&&(Ba(t,e),n=t.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=t.memoizedProps,n.state=t.memoizedState,n.componentWillUnmount()}catch(o){pt(t,e,o)}qn(r,e,t);break;case 21:qn(r,e,t);break;case 22:t.mode&1?(qt=(n=qt)||t.memoizedState!==null,qn(r,e,t),qt=n):qn(r,e,t);break;default:qn(r,e,t)}}function fg(r){var e=r.updateQueue;if(e!==null){r.updateQueue=null;var t=r.stateNode;t===null&&(t=r.stateNode=new jR),e.forEach(function(n){var i=zR.bind(null,r,n);t.has(n)||(t.add(n),n.then(i,i))})}}function Br(r,e){var t=e.deletions;if(t!==null)for(var n=0;n<t.length;n++){var i=t[n];try{var a=r,s=e,o=s;e:for(;o!==null;){switch(o.tag){case 5:jt=o.stateNode,Vr=!1;break e;case 3:jt=o.stateNode.containerInfo,Vr=!0;break e;case 4:jt=o.stateNode.containerInfo,Vr=!0;break e}o=o.return}if(jt===null)throw Error(ne(160));j_(a,s,i),jt=null,Vr=!1;var l=i.alternate;l!==null&&(l.return=null),i.return=null}catch(u){pt(i,e,u)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)F_(e,r),e=e.sibling}function F_(r,e){var t=r.alternate,n=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if(Br(e,r),en(r),n&4){try{So(3,r,r.return),Wd(3,r)}catch(y){pt(r,r.return,y)}try{So(5,r,r.return)}catch(y){pt(r,r.return,y)}}break;case 1:Br(e,r),en(r),n&512&&t!==null&&Ba(t,t.return);break;case 5:if(Br(e,r),en(r),n&512&&t!==null&&Ba(t,t.return),r.flags&32){var i=r.stateNode;try{Do(i,"")}catch(y){pt(r,r.return,y)}}if(n&4&&(i=r.stateNode,i!=null)){var a=r.memoizedProps,s=t!==null?t.memoizedProps:a,o=r.type,l=r.updateQueue;if(r.updateQueue=null,l!==null)try{o==="input"&&a.type==="radio"&&a.name!=null&&oE(i,a),Fh(o,s);var u=Fh(o,a);for(s=0;s<l.length;s+=2){var d=l[s],h=l[s+1];d==="style"?hE(i,h):d==="dangerouslySetInnerHTML"?dE(i,h):d==="children"?Do(i,h):Vv(i,d,h,u)}switch(o){case"input":xh(i,a);break;case"textarea":lE(i,a);break;case"select":var f=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!a.multiple;var m=a.value;m!=null?Ga(i,!!a.multiple,m,!1):f!==!!a.multiple&&(a.defaultValue!=null?Ga(i,!!a.multiple,a.defaultValue,!0):Ga(i,!!a.multiple,a.multiple?[]:"",!1))}i[Wo]=a}catch(y){pt(r,r.return,y)}}break;case 6:if(Br(e,r),en(r),n&4){if(r.stateNode===null)throw Error(ne(162));i=r.stateNode,a=r.memoizedProps;try{i.nodeValue=a}catch(y){pt(r,r.return,y)}}break;case 3:if(Br(e,r),en(r),n&4&&t!==null&&t.memoizedState.isDehydrated)try{Uo(e.containerInfo)}catch(y){pt(r,r.return,y)}break;case 4:Br(e,r),en(r);break;case 13:Br(e,r),en(r),i=r.child,i.flags&8192&&(a=i.memoizedState!==null,i.stateNode.isHidden=a,!a||i.alternate!==null&&i.alternate.memoizedState!==null||(wp=gt())),n&4&&fg(r);break;case 22:if(d=t!==null&&t.memoizedState!==null,r.mode&1?(qt=(u=qt)||d,Br(e,r),qt=u):Br(e,r),en(r),n&8192){if(u=r.memoizedState!==null,(r.stateNode.isHidden=u)&&!d&&r.mode&1)for(pe=r,d=r.child;d!==null;){for(h=pe=d;pe!==null;){switch(f=pe,m=f.child,f.tag){case 0:case 11:case 14:case 15:So(4,f,f.return);break;case 1:Ba(f,f.return);var v=f.stateNode;if(typeof v.componentWillUnmount=="function"){n=f,t=f.return;try{e=n,v.props=e.memoizedProps,v.state=e.memoizedState,v.componentWillUnmount()}catch(y){pt(n,t,y)}}break;case 5:Ba(f,f.return);break;case 22:if(f.memoizedState!==null){pg(h);continue}}m!==null?(m.return=f,pe=m):pg(h)}d=d.sibling}e:for(d=null,h=r;;){if(h.tag===5){if(d===null){d=h;try{i=h.stateNode,u?(a=i.style,typeof a.setProperty=="function"?a.setProperty("display","none","important"):a.display="none"):(o=h.stateNode,l=h.memoizedProps.style,s=l!=null&&l.hasOwnProperty("display")?l.display:null,o.style.display=cE("display",s))}catch(y){pt(r,r.return,y)}}}else if(h.tag===6){if(d===null)try{h.stateNode.nodeValue=u?"":h.memoizedProps}catch(y){pt(r,r.return,y)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===r)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===r)break e;for(;h.sibling===null;){if(h.return===null||h.return===r)break e;d===h&&(d=null),h=h.return}d===h&&(d=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:Br(e,r),en(r),n&4&&fg(r);break;case 21:break;default:Br(e,r),en(r)}}function en(r){var e=r.flags;if(e&2){try{e:{for(var t=r.return;t!==null;){if(U_(t)){var n=t;break e}t=t.return}throw Error(ne(160))}switch(n.tag){case 5:var i=n.stateNode;n.flags&32&&(Do(i,""),n.flags&=-33);var a=hg(r);mf(r,a,i);break;case 3:case 4:var s=n.stateNode.containerInfo,o=hg(r);pf(r,o,s);break;default:throw Error(ne(161))}}catch(l){pt(r,r.return,l)}r.flags&=-3}e&4096&&(r.flags&=-4097)}function BR(r,e,t){pe=r,B_(r)}function B_(r,e,t){for(var n=(r.mode&1)!==0;pe!==null;){var i=pe,a=i.child;if(i.tag===22&&n){var s=i.memoizedState!==null||Jl;if(!s){var o=i.alternate,l=o!==null&&o.memoizedState!==null||qt;o=Jl;var u=qt;if(Jl=s,(qt=l)&&!u)for(pe=i;pe!==null;)s=pe,l=s.child,s.tag===22&&s.memoizedState!==null?mg(i):l!==null?(l.return=s,pe=l):mg(i);for(;a!==null;)pe=a,B_(a),a=a.sibling;pe=i,Jl=o,qt=u}vg(r)}else i.subtreeFlags&8772&&a!==null?(a.return=i,pe=a):vg(r)}}function vg(r){for(;pe!==null;){var e=pe;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:qt||Wd(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!qt)if(t===null)n.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:Wr(e.type,t.memoizedProps);n.componentDidUpdate(i,t.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=e.updateQueue;a!==null&&Xm(e,a,n);break;case 3:var s=e.updateQueue;if(s!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}Xm(e,s,t)}break;case 5:var o=e.stateNode;if(t===null&&e.flags&4){t=o;var l=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&t.focus();break;case"img":l.src&&(t.src=l.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var u=e.alternate;if(u!==null){var d=u.memoizedState;if(d!==null){var h=d.dehydrated;h!==null&&Uo(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ne(163))}qt||e.flags&512&&vf(e)}catch(f){pt(e,e.return,f)}}if(e===r){pe=null;break}if(t=e.sibling,t!==null){t.return=e.return,pe=t;break}pe=e.return}}function pg(r){for(;pe!==null;){var e=pe;if(e===r){pe=null;break}var t=e.sibling;if(t!==null){t.return=e.return,pe=t;break}pe=e.return}}function mg(r){for(;pe!==null;){var e=pe;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{Wd(4,e)}catch(l){pt(e,t,l)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var i=e.return;try{n.componentDidMount()}catch(l){pt(e,i,l)}}var a=e.return;try{vf(e)}catch(l){pt(e,a,l)}break;case 5:var s=e.return;try{vf(e)}catch(l){pt(e,s,l)}}}catch(l){pt(e,e.return,l)}if(e===r){pe=null;break}var o=e.sibling;if(o!==null){o.return=e.return,pe=o;break}pe=e.return}}var $R=Math.ceil,id=$n.ReactCurrentDispatcher,_p=$n.ReactCurrentOwner,xr=$n.ReactCurrentBatchConfig,$e=0,Nt=null,Tt=null,Bt=0,Sr=0,$a=ki(0),Pt=0,zo=null,oa=0,Kd=0,bp=0,Eo=null,or=null,wp=0,fs=1/0,Tn=null,ad=!1,gf=null,yi=null,Yl=!1,li=null,sd=0,_o=0,yf=null,_u=-1,bu=0;function er(){return $e&6?gt():_u!==-1?_u:_u=gt()}function Si(r){return r.mode&1?$e&2&&Bt!==0?Bt&-Bt:TR.transition!==null?(bu===0&&(bu=TE()),bu):(r=He,r!==0||(r=window.event,r=r===void 0?16:ME(r.type)),r):1}function Jr(r,e,t,n){if(50<_o)throw _o=0,yf=null,Error(ne(185));fl(r,t,n),(!($e&2)||r!==Nt)&&(r===Nt&&(!($e&2)&&(Kd|=t),Pt===4&&si(r,Bt)),hr(r,n),t===1&&$e===0&&!(e.mode&1)&&(fs=gt()+500,Fd&&Pi()))}function hr(r,e){var t=r.callbackNode;TT(r,e);var n=Ku(r,r===Nt?Bt:0);if(n===0)t!==null&&Rm(t),r.callbackNode=null,r.callbackPriority=0;else if(e=n&-n,r.callbackPriority!==e){if(t!=null&&Rm(t),e===1)r.tag===0?wR(gg.bind(null,r)):YE(gg.bind(null,r)),SR(function(){!($e&6)&&Pi()}),t=null;else{switch(RE(n)){case 1:t=Jv;break;case 4:t=bE;break;case 16:t=Wu;break;case 536870912:t=wE;break;default:t=Wu}t=z_(t,$_.bind(null,r))}r.callbackPriority=e,r.callbackNode=t}}function $_(r,e){if(_u=-1,bu=0,$e&6)throw Error(ne(327));var t=r.callbackNode;if(Ya()&&r.callbackNode!==t)return null;var n=Ku(r,r===Nt?Bt:0);if(n===0)return null;if(n&30||n&r.expiredLanes||e)e=od(r,n);else{e=n;var i=$e;$e|=2;var a=K_();(Nt!==r||Bt!==e)&&(Tn=null,fs=gt()+500,Zi(r,e));do try{VR();break}catch(o){W_(r,o)}while(!0);lp(),id.current=a,$e=i,Tt!==null?e=0:(Nt=null,Bt=0,e=Pt)}if(e!==0){if(e===2&&(i=Vh(r),i!==0&&(n=i,e=Sf(r,i))),e===1)throw t=zo,Zi(r,0),si(r,n),hr(r,gt()),t;if(e===6)si(r,n);else{if(i=r.current.alternate,!(n&30)&&!WR(i)&&(e=od(r,n),e===2&&(a=Vh(r),a!==0&&(n=a,e=Sf(r,a))),e===1))throw t=zo,Zi(r,0),si(r,n),hr(r,gt()),t;switch(r.finishedWork=i,r.finishedLanes=n,e){case 0:case 1:throw Error(ne(345));case 2:$i(r,or,Tn);break;case 3:if(si(r,n),(n&130023424)===n&&(e=wp+500-gt(),10<e)){if(Ku(r,0)!==0)break;if(i=r.suspendedLanes,(i&n)!==n){er(),r.pingedLanes|=r.suspendedLanes&i;break}r.timeoutHandle=Xh($i.bind(null,r,or,Tn),e);break}$i(r,or,Tn);break;case 4:if(si(r,n),(n&4194240)===n)break;for(e=r.eventTimes,i=-1;0<n;){var s=31-zr(n);a=1<<s,s=e[s],s>i&&(i=s),n&=~a}if(n=i,n=gt()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*$R(n/1960))-n,10<n){r.timeoutHandle=Xh($i.bind(null,r,or,Tn),n);break}$i(r,or,Tn);break;case 5:$i(r,or,Tn);break;default:throw Error(ne(329))}}}return hr(r,gt()),r.callbackNode===t?$_.bind(null,r):null}function Sf(r,e){var t=Eo;return r.current.memoizedState.isDehydrated&&(Zi(r,e).flags|=256),r=od(r,e),r!==2&&(e=or,or=t,e!==null&&Ef(e)),r}function Ef(r){or===null?or=r:or.push.apply(or,r)}function WR(r){for(var e=r;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var n=0;n<t.length;n++){var i=t[n],a=i.getSnapshot;i=i.value;try{if(!Xr(a(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function si(r,e){for(e&=~bp,e&=~Kd,r.suspendedLanes|=e,r.pingedLanes&=~e,r=r.expirationTimes;0<e;){var t=31-zr(e),n=1<<t;r[t]=-1,e&=~n}}function gg(r){if($e&6)throw Error(ne(327));Ya();var e=Ku(r,0);if(!(e&1))return hr(r,gt()),null;var t=od(r,e);if(r.tag!==0&&t===2){var n=Vh(r);n!==0&&(e=n,t=Sf(r,n))}if(t===1)throw t=zo,Zi(r,0),si(r,e),hr(r,gt()),t;if(t===6)throw Error(ne(345));return r.finishedWork=r.current.alternate,r.finishedLanes=e,$i(r,or,Tn),hr(r,gt()),null}function Tp(r,e){var t=$e;$e|=1;try{return r(e)}finally{$e=t,$e===0&&(fs=gt()+500,Fd&&Pi())}}function la(r){li!==null&&li.tag===0&&!($e&6)&&Ya();var e=$e;$e|=1;var t=xr.transition,n=He;try{if(xr.transition=null,He=1,r)return r()}finally{He=n,xr.transition=t,$e=e,!($e&6)&&Pi()}}function Rp(){Sr=$a.current,rt($a)}function Zi(r,e){r.finishedWork=null,r.finishedLanes=0;var t=r.timeoutHandle;if(t!==-1&&(r.timeoutHandle=-1,yR(t)),Tt!==null)for(t=Tt.return;t!==null;){var n=t;switch(ap(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&zu();break;case 3:cs(),rt(dr),rt(Jt),vp();break;case 5:fp(n);break;case 4:cs();break;case 13:rt(dt);break;case 19:rt(dt);break;case 10:up(n.type._context);break;case 22:case 23:Rp()}t=t.return}if(Nt=r,Tt=r=Ei(r.current,null),Bt=Sr=e,Pt=0,zo=null,bp=Kd=oa=0,or=Eo=null,Ji!==null){for(e=0;e<Ji.length;e++)if(t=Ji[e],n=t.interleaved,n!==null){t.interleaved=null;var i=n.next,a=t.pending;if(a!==null){var s=a.next;a.next=i,n.next=s}t.pending=n}Ji=null}return r}function W_(r,e){do{var t=Tt;try{if(lp(),yu.current=nd,rd){for(var n=ct.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}rd=!1}if(sa=0,Dt=Ot=ct=null,yo=!1,Go=0,_p.current=null,t===null||t.return===null){Pt=1,zo=e,Tt=null;break}e:{var a=r,s=t.return,o=t,l=e;if(e=Bt,o.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){var u=l,d=o,h=d.tag;if(!(d.mode&1)&&(h===0||h===11||h===15)){var f=d.alternate;f?(d.updateQueue=f.updateQueue,d.memoizedState=f.memoizedState,d.lanes=f.lanes):(d.updateQueue=null,d.memoizedState=null)}var m=ig(s);if(m!==null){m.flags&=-257,ag(m,s,o,a,e),m.mode&1&&ng(a,u,e),e=m,l=u;var v=e.updateQueue;if(v===null){var y=new Set;y.add(l),e.updateQueue=y}else v.add(l);break e}else{if(!(e&1)){ng(a,u,e),Ip();break e}l=Error(ne(426))}}else if(at&&o.mode&1){var I=ig(s);if(I!==null){!(I.flags&65536)&&(I.flags|=256),ag(I,s,o,a,e),sp(hs(l,o));break e}}a=l=hs(l,o),Pt!==4&&(Pt=2),Eo===null?Eo=[a]:Eo.push(a),a=s;do{switch(a.tag){case 3:a.flags|=65536,e&=-e,a.lanes|=e;var g=R_(a,l,e);Qm(a,g);break e;case 1:o=l;var p=a.type,b=a.stateNode;if(!(a.flags&128)&&(typeof p.getDerivedStateFromError=="function"||b!==null&&typeof b.componentDidCatch=="function"&&(yi===null||!yi.has(b)))){a.flags|=65536,e&=-e,a.lanes|=e;var R=I_(a,o,e);Qm(a,R);break e}}a=a.return}while(a!==null)}G_(t)}catch(P){e=P,Tt===t&&t!==null&&(Tt=t=t.return);continue}break}while(!0)}function K_(){var r=id.current;return id.current=nd,r===null?nd:r}function Ip(){(Pt===0||Pt===3||Pt===2)&&(Pt=4),Nt===null||!(oa&268435455)&&!(Kd&268435455)||si(Nt,Bt)}function od(r,e){var t=$e;$e|=2;var n=K_();(Nt!==r||Bt!==e)&&(Tn=null,Zi(r,e));do try{KR();break}catch(i){W_(r,i)}while(!0);if(lp(),$e=t,id.current=n,Tt!==null)throw Error(ne(261));return Nt=null,Bt=0,Pt}function KR(){for(;Tt!==null;)V_(Tt)}function VR(){for(;Tt!==null&&!pT();)V_(Tt)}function V_(r){var e=H_(r.alternate,r,Sr);r.memoizedProps=r.pendingProps,e===null?G_(r):Tt=e,_p.current=null}function G_(r){var e=r;do{var t=e.alternate;if(r=e.return,e.flags&32768){if(t=UR(t,e),t!==null){t.flags&=32767,Tt=t;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{Pt=6,Tt=null;return}}else if(t=LR(t,e,Sr),t!==null){Tt=t;return}if(e=e.sibling,e!==null){Tt=e;return}Tt=e=r}while(e!==null);Pt===0&&(Pt=5)}function $i(r,e,t){var n=He,i=xr.transition;try{xr.transition=null,He=1,GR(r,e,t,n)}finally{xr.transition=i,He=n}return null}function GR(r,e,t,n){do Ya();while(li!==null);if($e&6)throw Error(ne(327));t=r.finishedWork;var i=r.finishedLanes;if(t===null)return null;if(r.finishedWork=null,r.finishedLanes=0,t===r.current)throw Error(ne(177));r.callbackNode=null,r.callbackPriority=0;var a=t.lanes|t.childLanes;if(RT(r,a),r===Nt&&(Tt=Nt=null,Bt=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||Yl||(Yl=!0,z_(Wu,function(){return Ya(),null})),a=(t.flags&15990)!==0,t.subtreeFlags&15990||a){a=xr.transition,xr.transition=null;var s=He;He=1;var o=$e;$e|=4,_p.current=null,FR(r,t),F_(t,r),cR(Yh),Vu=!!Jh,Yh=Jh=null,r.current=t,BR(t),mT(),$e=o,He=s,xr.transition=a}else r.current=t;if(Yl&&(Yl=!1,li=r,sd=i),a=r.pendingLanes,a===0&&(yi=null),ST(t.stateNode),hr(r,gt()),e!==null)for(n=r.onRecoverableError,t=0;t<e.length;t++)i=e[t],n(i.value,{componentStack:i.stack,digest:i.digest});if(ad)throw ad=!1,r=gf,gf=null,r;return sd&1&&r.tag!==0&&Ya(),a=r.pendingLanes,a&1?r===yf?_o++:(_o=0,yf=r):_o=0,Pi(),null}function Ya(){if(li!==null){var r=RE(sd),e=xr.transition,t=He;try{if(xr.transition=null,He=16>r?16:r,li===null)var n=!1;else{if(r=li,li=null,sd=0,$e&6)throw Error(ne(331));var i=$e;for($e|=4,pe=r.current;pe!==null;){var a=pe,s=a.child;if(pe.flags&16){var o=a.deletions;if(o!==null){for(var l=0;l<o.length;l++){var u=o[l];for(pe=u;pe!==null;){var d=pe;switch(d.tag){case 0:case 11:case 15:So(8,d,a)}var h=d.child;if(h!==null)h.return=d,pe=h;else for(;pe!==null;){d=pe;var f=d.sibling,m=d.return;if(L_(d),d===u){pe=null;break}if(f!==null){f.return=m,pe=f;break}pe=m}}}var v=a.alternate;if(v!==null){var y=v.child;if(y!==null){v.child=null;do{var I=y.sibling;y.sibling=null,y=I}while(y!==null)}}pe=a}}if(a.subtreeFlags&2064&&s!==null)s.return=a,pe=s;else e:for(;pe!==null;){if(a=pe,a.flags&2048)switch(a.tag){case 0:case 11:case 15:So(9,a,a.return)}var g=a.sibling;if(g!==null){g.return=a.return,pe=g;break e}pe=a.return}}var p=r.current;for(pe=p;pe!==null;){s=pe;var b=s.child;if(s.subtreeFlags&2064&&b!==null)b.return=s,pe=b;else e:for(s=p;pe!==null;){if(o=pe,o.flags&2048)try{switch(o.tag){case 0:case 11:case 15:Wd(9,o)}}catch(P){pt(o,o.return,P)}if(o===s){pe=null;break e}var R=o.sibling;if(R!==null){R.return=o.return,pe=R;break e}pe=o.return}}if($e=i,Pi(),vn&&typeof vn.onPostCommitFiberRoot=="function")try{vn.onPostCommitFiberRoot(xd,r)}catch{}n=!0}return n}finally{He=t,xr.transition=e}}return!1}function yg(r,e,t){e=hs(t,e),e=R_(r,e,1),r=gi(r,e,1),e=er(),r!==null&&(fl(r,1,e),hr(r,e))}function pt(r,e,t){if(r.tag===3)yg(r,r,t);else for(;e!==null;){if(e.tag===3){yg(e,r,t);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(yi===null||!yi.has(n))){r=hs(t,r),r=I_(e,r,1),e=gi(e,r,1),r=er(),e!==null&&(fl(e,1,r),hr(e,r));break}}e=e.return}}function qR(r,e,t){var n=r.pingCache;n!==null&&n.delete(e),e=er(),r.pingedLanes|=r.suspendedLanes&t,Nt===r&&(Bt&t)===t&&(Pt===4||Pt===3&&(Bt&130023424)===Bt&&500>gt()-wp?Zi(r,0):bp|=t),hr(r,e)}function q_(r,e){e===0&&(r.mode&1?(e=Bl,Bl<<=1,!(Bl&130023424)&&(Bl=4194304)):e=1);var t=er();r=Fn(r,e),r!==null&&(fl(r,e,t),hr(r,t))}function HR(r){var e=r.memoizedState,t=0;e!==null&&(t=e.retryLane),q_(r,t)}function zR(r,e){var t=0;switch(r.tag){case 13:var n=r.stateNode,i=r.memoizedState;i!==null&&(t=i.retryLane);break;case 19:n=r.stateNode;break;default:throw Error(ne(314))}n!==null&&n.delete(e),q_(r,t)}var H_;H_=function(r,e,t){if(r!==null)if(r.memoizedProps!==e.pendingProps||dr.current)lr=!0;else{if(!(r.lanes&t)&&!(e.flags&128))return lr=!1,NR(r,e,t);lr=!!(r.flags&131072)}else lr=!1,at&&e.flags&1048576&&QE(e,Qu,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;Eu(r,e),r=e.pendingProps;var i=ls(e,Jt.current);Ja(e,t),i=mp(null,e,n,r,i,t);var a=gp();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,cr(n)?(a=!0,Ju(e)):a=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,cp(e),i.updater=$d,e.stateNode=i,i._reactInternals=e,sf(e,n,r,t),e=uf(null,e,n,!0,a,t)):(e.tag=0,at&&a&&ip(e),Qt(null,e,i,t),e=e.child),e;case 16:n=e.elementType;e:{switch(Eu(r,e),r=e.pendingProps,i=n._init,n=i(n._payload),e.type=n,i=e.tag=YR(n),r=Wr(n,r),i){case 0:e=lf(null,e,n,r,t);break e;case 1:e=lg(null,e,n,r,t);break e;case 11:e=sg(null,e,n,r,t);break e;case 14:e=og(null,e,n,Wr(n.type,r),t);break e}throw Error(ne(306,n,""))}return e;case 0:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Wr(n,i),lf(r,e,n,i,t);case 1:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Wr(n,i),lg(r,e,n,i,t);case 3:e:{if(P_(e),r===null)throw Error(ne(387));n=e.pendingProps,a=e.memoizedState,i=a.element,n_(r,e),ed(e,n,null,t);var s=e.memoizedState;if(n=s.element,a.isDehydrated)if(a={element:n,isDehydrated:!1,cache:s.cache,pendingSuspenseBoundaries:s.pendingSuspenseBoundaries,transitions:s.transitions},e.updateQueue.baseState=a,e.memoizedState=a,e.flags&256){i=hs(Error(ne(423)),e),e=ug(r,e,n,t,i);break e}else if(n!==i){i=hs(Error(ne(424)),e),e=ug(r,e,n,t,i);break e}else for(_r=mi(e.stateNode.containerInfo.firstChild),br=e,at=!0,qr=null,t=t_(e,null,n,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(us(),n===i){e=Bn(r,e,t);break e}Qt(r,e,n,t)}e=e.child}return e;case 5:return i_(e),r===null&&rf(e),n=e.type,i=e.pendingProps,a=r!==null?r.memoizedProps:null,s=i.children,Qh(n,i)?s=null:a!==null&&Qh(n,a)&&(e.flags|=32),k_(r,e),Qt(r,e,s,t),e.child;case 6:return r===null&&rf(e),null;case 13:return M_(r,e,t);case 4:return hp(e,e.stateNode.containerInfo),n=e.pendingProps,r===null?e.child=ds(e,null,n,t):Qt(r,e,n,t),e.child;case 11:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Wr(n,i),sg(r,e,n,i,t);case 7:return Qt(r,e,e.pendingProps,t),e.child;case 8:return Qt(r,e,e.pendingProps.children,t),e.child;case 12:return Qt(r,e,e.pendingProps.children,t),e.child;case 10:e:{if(n=e.type._context,i=e.pendingProps,a=e.memoizedProps,s=i.value,Ze(Xu,n._currentValue),n._currentValue=s,a!==null)if(Xr(a.value,s)){if(a.children===i.children&&!dr.current){e=Bn(r,e,t);break e}}else for(a=e.child,a!==null&&(a.return=e);a!==null;){var o=a.dependencies;if(o!==null){s=a.child;for(var l=o.firstContext;l!==null;){if(l.context===n){if(a.tag===1){l=xn(-1,t&-t),l.tag=2;var u=a.updateQueue;if(u!==null){u=u.shared;var d=u.pending;d===null?l.next=l:(l.next=d.next,d.next=l),u.pending=l}}a.lanes|=t,l=a.alternate,l!==null&&(l.lanes|=t),nf(a.return,t,e),o.lanes|=t;break}l=l.next}}else if(a.tag===10)s=a.type===e.type?null:a.child;else if(a.tag===18){if(s=a.return,s===null)throw Error(ne(341));s.lanes|=t,o=s.alternate,o!==null&&(o.lanes|=t),nf(s,t,e),s=a.sibling}else s=a.child;if(s!==null)s.return=a;else for(s=a;s!==null;){if(s===e){s=null;break}if(a=s.sibling,a!==null){a.return=s.return,s=a;break}s=s.return}a=s}Qt(r,e,i.children,t),e=e.child}return e;case 9:return i=e.type,n=e.pendingProps.children,Ja(e,t),i=Lr(i),n=n(i),e.flags|=1,Qt(r,e,n,t),e.child;case 14:return n=e.type,i=Wr(n,e.pendingProps),i=Wr(n.type,i),og(r,e,n,i,t);case 15:return C_(r,e,e.type,e.pendingProps,t);case 17:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Wr(n,i),Eu(r,e),e.tag=1,cr(n)?(r=!0,Ju(e)):r=!1,Ja(e,t),T_(e,n,i),sf(e,n,i,t),uf(null,e,n,!0,r,t);case 19:return A_(r,e,t);case 22:return O_(r,e,t)}throw Error(ne(156,e.tag))};function z_(r,e){return _E(r,e)}function JR(r,e,t,n){this.tag=r,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Dr(r,e,t,n){return new JR(r,e,t,n)}function Cp(r){return r=r.prototype,!(!r||!r.isReactComponent)}function YR(r){if(typeof r=="function")return Cp(r)?1:0;if(r!=null){if(r=r.$$typeof,r===qv)return 11;if(r===Hv)return 14}return 2}function Ei(r,e){var t=r.alternate;return t===null?(t=Dr(r.tag,e,r.key,r.mode),t.elementType=r.elementType,t.type=r.type,t.stateNode=r.stateNode,t.alternate=r,r.alternate=t):(t.pendingProps=e,t.type=r.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=r.flags&14680064,t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,e=r.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=r.sibling,t.index=r.index,t.ref=r.ref,t}function wu(r,e,t,n,i,a){var s=2;if(n=r,typeof r=="function")Cp(r)&&(s=1);else if(typeof r=="string")s=5;else e:switch(r){case Ma:return ea(t.children,i,a,e);case Gv:s=8,i|=8;break;case kh:return r=Dr(12,t,e,i|2),r.elementType=kh,r.lanes=a,r;case Ph:return r=Dr(13,t,e,i),r.elementType=Ph,r.lanes=a,r;case Mh:return r=Dr(19,t,e,i),r.elementType=Mh,r.lanes=a,r;case iE:return Vd(t,i,a,e);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case rE:s=10;break e;case nE:s=9;break e;case qv:s=11;break e;case Hv:s=14;break e;case ti:s=16,n=null;break e}throw Error(ne(130,r==null?r:typeof r,""))}return e=Dr(s,t,e,i),e.elementType=r,e.type=n,e.lanes=a,e}function ea(r,e,t,n){return r=Dr(7,r,n,e),r.lanes=t,r}function Vd(r,e,t,n){return r=Dr(22,r,n,e),r.elementType=iE,r.lanes=t,r.stateNode={isHidden:!1},r}function zc(r,e,t){return r=Dr(6,r,null,e),r.lanes=t,r}function Jc(r,e,t){return e=Dr(4,r.children!==null?r.children:[],r.key,e),e.lanes=t,e.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},e}function QR(r,e,t,n,i){this.tag=e,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=kc(0),this.expirationTimes=kc(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=kc(0),this.identifierPrefix=n,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function Op(r,e,t,n,i,a,s,o,l){return r=new QR(r,e,t,o,l),e===1?(e=1,a===!0&&(e|=8)):e=0,a=Dr(3,null,null,e),r.current=a,a.stateNode=r,a.memoizedState={element:n,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},cp(a),r}function XR(r,e,t){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Pa,key:n==null?null:""+n,children:r,containerInfo:e,implementation:t}}function J_(r){if(!r)return Ri;r=r._reactInternals;e:{if(va(r)!==r||r.tag!==1)throw Error(ne(170));var e=r;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(cr(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(ne(171))}if(r.tag===1){var t=r.type;if(cr(t))return JE(r,t,e)}return e}function Y_(r,e,t,n,i,a,s,o,l){return r=Op(t,n,!0,r,i,a,s,o,l),r.context=J_(null),t=r.current,n=er(),i=Si(t),a=xn(n,i),a.callback=e??null,gi(t,a,i),r.current.lanes=i,fl(r,i,n),hr(r,n),r}function Gd(r,e,t,n){var i=e.current,a=er(),s=Si(i);return t=J_(t),e.context===null?e.context=t:e.pendingContext=t,e=xn(a,s),e.payload={element:r},n=n===void 0?null:n,n!==null&&(e.callback=n),r=gi(i,e,s),r!==null&&(Jr(r,i,s,a),gu(r,i,s)),s}function ld(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}function Sg(r,e){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var t=r.retryLane;r.retryLane=t!==0&&t<e?t:e}}function kp(r,e){Sg(r,e),(r=r.alternate)&&Sg(r,e)}function ZR(){return null}var Q_=typeof reportError=="function"?reportError:function(r){console.error(r)};function Pp(r){this._internalRoot=r}qd.prototype.render=Pp.prototype.render=function(r){var e=this._internalRoot;if(e===null)throw Error(ne(409));Gd(r,e,null,null)};qd.prototype.unmount=Pp.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var e=r.containerInfo;la(function(){Gd(null,r,null,null)}),e[jn]=null}};function qd(r){this._internalRoot=r}qd.prototype.unstable_scheduleHydration=function(r){if(r){var e=OE();r={blockedOn:null,target:r,priority:e};for(var t=0;t<ai.length&&e!==0&&e<ai[t].priority;t++);ai.splice(t,0,r),t===0&&PE(r)}};function Mp(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function Hd(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}function Eg(){}function eI(r,e,t,n,i){if(i){if(typeof n=="function"){var a=n;n=function(){var u=ld(s);a.call(u)}}var s=Y_(e,n,r,0,null,!1,!1,"",Eg);return r._reactRootContainer=s,r[jn]=s.current,Bo(r.nodeType===8?r.parentNode:r),la(),s}for(;i=r.lastChild;)r.removeChild(i);if(typeof n=="function"){var o=n;n=function(){var u=ld(l);o.call(u)}}var l=Op(r,0,!1,null,null,!1,!1,"",Eg);return r._reactRootContainer=l,r[jn]=l.current,Bo(r.nodeType===8?r.parentNode:r),la(function(){Gd(e,l,t,n)}),l}function zd(r,e,t,n,i){var a=t._reactRootContainer;if(a){var s=a;if(typeof i=="function"){var o=i;i=function(){var l=ld(s);o.call(l)}}Gd(e,s,r,i)}else s=eI(t,e,r,i,n);return ld(s)}IE=function(r){switch(r.tag){case 3:var e=r.stateNode;if(e.current.memoizedState.isDehydrated){var t=so(e.pendingLanes);t!==0&&(Yv(e,t|1),hr(e,gt()),!($e&6)&&(fs=gt()+500,Pi()))}break;case 13:la(function(){var n=Fn(r,1);if(n!==null){var i=er();Jr(n,r,1,i)}}),kp(r,1)}};Qv=function(r){if(r.tag===13){var e=Fn(r,134217728);if(e!==null){var t=er();Jr(e,r,134217728,t)}kp(r,134217728)}};CE=function(r){if(r.tag===13){var e=Si(r),t=Fn(r,e);if(t!==null){var n=er();Jr(t,r,e,n)}kp(r,e)}};OE=function(){return He};kE=function(r,e){var t=He;try{return He=r,e()}finally{He=t}};$h=function(r,e,t){switch(e){case"input":if(xh(r,t),e=t.name,t.type==="radio"&&e!=null){for(t=r;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var n=t[e];if(n!==r&&n.form===r.form){var i=jd(n);if(!i)throw Error(ne(90));sE(n),xh(n,i)}}}break;case"textarea":lE(r,t);break;case"select":e=t.value,e!=null&&Ga(r,!!t.multiple,e,!1)}};pE=Tp;mE=la;var tI={usingClientEntryPoint:!1,Events:[pl,Na,jd,fE,vE,Tp]},Vs={findFiberByHostInstance:zi,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},rI={bundleType:Vs.bundleType,version:Vs.version,rendererPackageName:Vs.rendererPackageName,rendererConfig:Vs.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:$n.ReactCurrentDispatcher,findHostInstanceByFiber:function(r){return r=SE(r),r===null?null:r.stateNode},findFiberByHostInstance:Vs.findFiberByHostInstance||ZR,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Ql=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Ql.isDisabled&&Ql.supportsFiber)try{xd=Ql.inject(rI),vn=Ql}catch{}}Tr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=tI;Tr.createPortal=function(r,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Mp(e))throw Error(ne(200));return XR(r,e,null,t)};Tr.createRoot=function(r,e){if(!Mp(r))throw Error(ne(299));var t=!1,n="",i=Q_;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=Op(r,1,!1,null,null,t,!1,n,i),r[jn]=e.current,Bo(r.nodeType===8?r.parentNode:r),new Pp(e)};Tr.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var e=r._reactInternals;if(e===void 0)throw typeof r.render=="function"?Error(ne(188)):(r=Object.keys(r).join(","),Error(ne(268,r)));return r=SE(e),r=r===null?null:r.stateNode,r};Tr.flushSync=function(r){return la(r)};Tr.hydrate=function(r,e,t){if(!Hd(e))throw Error(ne(200));return zd(null,r,e,!0,t)};Tr.hydrateRoot=function(r,e,t){if(!Mp(r))throw Error(ne(405));var n=t!=null&&t.hydratedSources||null,i=!1,a="",s=Q_;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(a=t.identifierPrefix),t.onRecoverableError!==void 0&&(s=t.onRecoverableError)),e=Y_(e,null,r,1,t??null,i,!1,a,s),r[jn]=e.current,Bo(r),n)for(r=0;r<n.length;r++)t=n[r],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new qd(e)};Tr.render=function(r,e,t){if(!Hd(e))throw Error(ne(200));return zd(null,r,e,!1,t)};Tr.unmountComponentAtNode=function(r){if(!Hd(r))throw Error(ne(40));return r._reactRootContainer?(la(function(){zd(null,null,r,!1,function(){r._reactRootContainer=null,r[jn]=null})}),!0):!1};Tr.unstable_batchedUpdates=Tp;Tr.unstable_renderSubtreeIntoContainer=function(r,e,t,n){if(!Hd(t))throw Error(ne(200));if(r==null||r._reactInternals===void 0)throw Error(ne(38));return zd(r,e,t,!1,n)};Tr.version="18.3.1-next-f1338f8080-20240426";function X_(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(X_)}catch(r){console.error(r)}}X_(),XS.exports=Tr;var nI=XS.exports,Z_,_g=nI;Z_=_g.createRoot,_g.hydrateRoot;/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Jo(){return Jo=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Jo.apply(this,arguments)}var ui;(function(r){r.Pop="POP",r.Push="PUSH",r.Replace="REPLACE"})(ui||(ui={}));const bg="popstate";function iI(r){r===void 0&&(r={});function e(i,a){let{pathname:s="/",search:o="",hash:l=""}=pa(i.location.hash.substr(1));return!s.startsWith("/")&&!s.startsWith(".")&&(s="/"+s),_f("",{pathname:s,search:o,hash:l},a.state&&a.state.usr||null,a.state&&a.state.key||"default")}function t(i,a){let s=i.document.querySelector("base"),o="";if(s&&s.getAttribute("href")){let l=i.location.href,u=l.indexOf("#");o=u===-1?l:l.slice(0,u)}return o+"#"+(typeof a=="string"?a:ud(a))}function n(i,a){Ap(i.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(a)+")")}return sI(e,t,n,r)}function ht(r,e){if(r===!1||r===null||typeof r>"u")throw new Error(e)}function Ap(r,e){if(!r){typeof console<"u"&&console.warn(e);try{throw new Error(e)}catch{}}}function aI(){return Math.random().toString(36).substr(2,8)}function wg(r,e){return{usr:r.state,key:r.key,idx:e}}function _f(r,e,t,n){return t===void 0&&(t=null),Jo({pathname:typeof r=="string"?r:r.pathname,search:"",hash:""},typeof e=="string"?pa(e):e,{state:t,key:e&&e.key||n||aI()})}function ud(r){let{pathname:e="/",search:t="",hash:n=""}=r;return t&&t!=="?"&&(e+=t.charAt(0)==="?"?t:"?"+t),n&&n!=="#"&&(e+=n.charAt(0)==="#"?n:"#"+n),e}function pa(r){let e={};if(r){let t=r.indexOf("#");t>=0&&(e.hash=r.substr(t),r=r.substr(0,t));let n=r.indexOf("?");n>=0&&(e.search=r.substr(n),r=r.substr(0,n)),r&&(e.pathname=r)}return e}function sI(r,e,t,n){n===void 0&&(n={});let{window:i=document.defaultView,v5Compat:a=!1}=n,s=i.history,o=ui.Pop,l=null,u=d();u==null&&(u=0,s.replaceState(Jo({},s.state,{idx:u}),""));function d(){return(s.state||{idx:null}).idx}function h(){o=ui.Pop;let I=d(),g=I==null?null:I-u;u=I,l&&l({action:o,location:y.location,delta:g})}function f(I,g){o=ui.Push;let p=_f(y.location,I,g);t&&t(p,I),u=d()+1;let b=wg(p,u),R=y.createHref(p);try{s.pushState(b,"",R)}catch(P){if(P instanceof DOMException&&P.name==="DataCloneError")throw P;i.location.assign(R)}a&&l&&l({action:o,location:y.location,delta:1})}function m(I,g){o=ui.Replace;let p=_f(y.location,I,g);t&&t(p,I),u=d();let b=wg(p,u),R=y.createHref(p);s.replaceState(b,"",R),a&&l&&l({action:o,location:y.location,delta:0})}function v(I){let g=i.location.origin!=="null"?i.location.origin:i.location.href,p=typeof I=="string"?I:ud(I);return p=p.replace(/ $/,"%20"),ht(g,"No window.location.(origin|href) available to create URL for href: "+p),new URL(p,g)}let y={get action(){return o},get location(){return r(i,s)},listen(I){if(l)throw new Error("A history only accepts one active listener");return i.addEventListener(bg,h),l=I,()=>{i.removeEventListener(bg,h),l=null}},createHref(I){return e(i,I)},createURL:v,encodeLocation(I){let g=v(I);return{pathname:g.pathname,search:g.search,hash:g.hash}},push:f,replace:m,go(I){return s.go(I)}};return y}var Tg;(function(r){r.data="data",r.deferred="deferred",r.redirect="redirect",r.error="error"})(Tg||(Tg={}));function oI(r,e,t){return t===void 0&&(t="/"),lI(r,e,t)}function lI(r,e,t,n){let i=typeof e=="string"?pa(e):e,a=vs(i.pathname||"/",t);if(a==null)return null;let s=eb(r);uI(s);let o=null;for(let l=0;o==null&&l<s.length;++l){let u=EI(a);o=yI(s[l],u)}return o}function eb(r,e,t,n){e===void 0&&(e=[]),t===void 0&&(t=[]),n===void 0&&(n="");let i=(a,s,o)=>{let l={relativePath:o===void 0?a.path||"":o,caseSensitive:a.caseSensitive===!0,childrenIndex:s,route:a};l.relativePath.startsWith("/")&&(ht(l.relativePath.startsWith(n),'Absolute route path "'+l.relativePath+'" nested under path '+('"'+n+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),l.relativePath=l.relativePath.slice(n.length));let u=_i([n,l.relativePath]),d=t.concat(l);a.children&&a.children.length>0&&(ht(a.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+u+'".')),eb(a.children,e,d,u)),!(a.path==null&&!a.index)&&e.push({path:u,score:mI(u,a.index),routesMeta:d})};return r.forEach((a,s)=>{var o;if(a.path===""||!((o=a.path)!=null&&o.includes("?")))i(a,s);else for(let l of tb(a.path))i(a,s,l)}),e}function tb(r){let e=r.split("/");if(e.length===0)return[];let[t,...n]=e,i=t.endsWith("?"),a=t.replace(/\?$/,"");if(n.length===0)return i?[a,""]:[a];let s=tb(n.join("/")),o=[];return o.push(...s.map(l=>l===""?a:[a,l].join("/"))),i&&o.push(...s),o.map(l=>r.startsWith("/")&&l===""?"/":l)}function uI(r){r.sort((e,t)=>e.score!==t.score?t.score-e.score:gI(e.routesMeta.map(n=>n.childrenIndex),t.routesMeta.map(n=>n.childrenIndex)))}const dI=/^:[\w-]+$/,cI=3,hI=2,fI=1,vI=10,pI=-2,Rg=r=>r==="*";function mI(r,e){let t=r.split("/"),n=t.length;return t.some(Rg)&&(n+=pI),e&&(n+=hI),t.filter(i=>!Rg(i)).reduce((i,a)=>i+(dI.test(a)?cI:a===""?fI:vI),n)}function gI(r,e){return r.length===e.length&&r.slice(0,-1).every((n,i)=>n===e[i])?r[r.length-1]-e[e.length-1]:0}function yI(r,e,t){let{routesMeta:n}=r,i={},a="/",s=[];for(let o=0;o<n.length;++o){let l=n[o],u=o===n.length-1,d=a==="/"?e:e.slice(a.length)||"/",h=bf({path:l.relativePath,caseSensitive:l.caseSensitive,end:u},d),f=l.route;if(!h)return null;Object.assign(i,h.params),s.push({params:i,pathname:_i([a,h.pathname]),pathnameBase:TI(_i([a,h.pathnameBase])),route:f}),h.pathnameBase!=="/"&&(a=_i([a,h.pathnameBase]))}return s}function bf(r,e){typeof r=="string"&&(r={path:r,caseSensitive:!1,end:!0});let[t,n]=SI(r.path,r.caseSensitive,r.end),i=e.match(t);if(!i)return null;let a=i[0],s=a.replace(/(.)\/+$/,"$1"),o=i.slice(1);return{params:n.reduce((u,d,h)=>{let{paramName:f,isOptional:m}=d;if(f==="*"){let y=o[h]||"";s=a.slice(0,a.length-y.length).replace(/(.)\/+$/,"$1")}const v=o[h];return m&&!v?u[f]=void 0:u[f]=(v||"").replace(/%2F/g,"/"),u},{}),pathname:a,pathnameBase:s,pattern:r}}function SI(r,e,t){e===void 0&&(e=!1),t===void 0&&(t=!0),Ap(r==="*"||!r.endsWith("*")||r.endsWith("/*"),'Route path "'+r+'" will be treated as if it were '+('"'+r.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+r.replace(/\*$/,"/*")+'".'));let n=[],i="^"+r.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(s,o,l)=>(n.push({paramName:o,isOptional:l!=null}),l?"/?([^\\/]+)?":"/([^\\/]+)"));return r.endsWith("*")?(n.push({paramName:"*"}),i+=r==="*"||r==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):t?i+="\\/*$":r!==""&&r!=="/"&&(i+="(?:(?=\\/|$))"),[new RegExp(i,e?void 0:"i"),n]}function EI(r){try{return r.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(e){return Ap(!1,'The URL path "'+r+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+e+").")),r}}function vs(r,e){if(e==="/")return r;if(!r.toLowerCase().startsWith(e.toLowerCase()))return null;let t=e.endsWith("/")?e.length-1:e.length,n=r.charAt(t);return n&&n!=="/"?null:r.slice(t)||"/"}function _I(r,e){e===void 0&&(e="/");let{pathname:t,search:n="",hash:i=""}=typeof r=="string"?pa(r):r;return{pathname:t?t.startsWith("/")?t:bI(t,e):e,search:RI(n),hash:II(i)}}function bI(r,e){let t=e.replace(/\/+$/,"").split("/");return r.split("/").forEach(i=>{i===".."?t.length>1&&t.pop():i!=="."&&t.push(i)}),t.length>1?t.join("/"):"/"}function Yc(r,e,t,n){return"Cannot include a '"+r+"' character in a manually specified "+("`to."+e+"` field ["+JSON.stringify(n)+"].  Please separate it out to the ")+("`to."+t+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function wI(r){return r.filter((e,t)=>t===0||e.route.path&&e.route.path.length>0)}function Dp(r,e){let t=wI(r);return e?t.map((n,i)=>i===t.length-1?n.pathname:n.pathnameBase):t.map(n=>n.pathnameBase)}function xp(r,e,t,n){n===void 0&&(n=!1);let i;typeof r=="string"?i=pa(r):(i=Jo({},r),ht(!i.pathname||!i.pathname.includes("?"),Yc("?","pathname","search",i)),ht(!i.pathname||!i.pathname.includes("#"),Yc("#","pathname","hash",i)),ht(!i.search||!i.search.includes("#"),Yc("#","search","hash",i)));let a=r===""||i.pathname==="",s=a?"/":i.pathname,o;if(s==null)o=t;else{let h=e.length-1;if(!n&&s.startsWith("..")){let f=s.split("/");for(;f[0]==="..";)f.shift(),h-=1;i.pathname=f.join("/")}o=h>=0?e[h]:"/"}let l=_I(i,o),u=s&&s!=="/"&&s.endsWith("/"),d=(a||s===".")&&t.endsWith("/");return!l.pathname.endsWith("/")&&(u||d)&&(l.pathname+="/"),l}const _i=r=>r.join("/").replace(/\/\/+/g,"/"),TI=r=>r.replace(/\/+$/,"").replace(/^\/*/,"/"),RI=r=>!r||r==="?"?"":r.startsWith("?")?r:"?"+r,II=r=>!r||r==="#"?"":r.startsWith("#")?r:"#"+r;function CI(r){return r!=null&&typeof r.status=="number"&&typeof r.statusText=="string"&&typeof r.internal=="boolean"&&"data"in r}const rb=["post","put","patch","delete"];new Set(rb);const OI=["get",...rb];new Set(OI);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Yo(){return Yo=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Yo.apply(this,arguments)}const Jd=G.createContext(null),nb=G.createContext(null),Wn=G.createContext(null),Yd=G.createContext(null),yn=G.createContext({outlet:null,matches:[],isDataRoute:!1}),ib=G.createContext(null);function kI(r,e){let{relative:t}=e===void 0?{}:e;Os()||ht(!1);let{basename:n,navigator:i}=G.useContext(Wn),{hash:a,pathname:s,search:o}=Qd(r,{relative:t}),l=s;return n!=="/"&&(l=s==="/"?n:_i([n,s])),i.createHref({pathname:l,search:o,hash:a})}function Os(){return G.useContext(Yd)!=null}function ma(){return Os()||ht(!1),G.useContext(Yd).location}function ab(r){G.useContext(Wn).static||G.useLayoutEffect(r)}function Np(){let{isDataRoute:r}=G.useContext(yn);return r?VI():PI()}function PI(){Os()||ht(!1);let r=G.useContext(Jd),{basename:e,future:t,navigator:n}=G.useContext(Wn),{matches:i}=G.useContext(yn),{pathname:a}=ma(),s=JSON.stringify(Dp(i,t.v7_relativeSplatPath)),o=G.useRef(!1);return ab(()=>{o.current=!0}),G.useCallback(function(u,d){if(d===void 0&&(d={}),!o.current)return;if(typeof u=="number"){n.go(u);return}let h=xp(u,JSON.parse(s),a,d.relative==="path");r==null&&e!=="/"&&(h.pathname=h.pathname==="/"?e:_i([e,h.pathname])),(d.replace?n.replace:n.push)(h,d.state,d)},[e,n,s,a,r])}const MI=G.createContext(null);function AI(r){let e=G.useContext(yn).outlet;return e&&G.createElement(MI.Provider,{value:r},e)}function gl(){let{matches:r}=G.useContext(yn),e=r[r.length-1];return e?e.params:{}}function Qd(r,e){let{relative:t}=e===void 0?{}:e,{future:n}=G.useContext(Wn),{matches:i}=G.useContext(yn),{pathname:a}=ma(),s=JSON.stringify(Dp(i,n.v7_relativeSplatPath));return G.useMemo(()=>xp(r,JSON.parse(s),a,t==="path"),[r,s,a,t])}function DI(r,e){return xI(r,e)}function xI(r,e,t,n){Os()||ht(!1);let{navigator:i}=G.useContext(Wn),{matches:a}=G.useContext(yn),s=a[a.length-1],o=s?s.params:{};s&&s.pathname;let l=s?s.pathnameBase:"/";s&&s.route;let u=ma(),d;if(e){var h;let I=typeof e=="string"?pa(e):e;l==="/"||(h=I.pathname)!=null&&h.startsWith(l)||ht(!1),d=I}else d=u;let f=d.pathname||"/",m=f;if(l!=="/"){let I=l.replace(/^\//,"").split("/");m="/"+f.replace(/^\//,"").split("/").slice(I.length).join("/")}let v=oI(r,{pathname:m}),y=FI(v&&v.map(I=>Object.assign({},I,{params:Object.assign({},o,I.params),pathname:_i([l,i.encodeLocation?i.encodeLocation(I.pathname).pathname:I.pathname]),pathnameBase:I.pathnameBase==="/"?l:_i([l,i.encodeLocation?i.encodeLocation(I.pathnameBase).pathname:I.pathnameBase])})),a,t,n);return e&&y?G.createElement(Yd.Provider,{value:{location:Yo({pathname:"/",search:"",hash:"",state:null,key:"default"},d),navigationType:ui.Pop}},y):y}function NI(){let r=KI(),e=CI(r)?r.status+" "+r.statusText:r instanceof Error?r.message:JSON.stringify(r),t=r instanceof Error?r.stack:null,i={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return G.createElement(G.Fragment,null,G.createElement("h2",null,"Unexpected Application Error!"),G.createElement("h3",{style:{fontStyle:"italic"}},e),t?G.createElement("pre",{style:i},t):null,null)}const LI=G.createElement(NI,null);class UI extends G.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||t.revalidation!=="idle"&&e.revalidation==="idle"?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:e.error!==void 0?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){console.error("React Router caught the following error during render",e,t)}render(){return this.state.error!==void 0?G.createElement(yn.Provider,{value:this.props.routeContext},G.createElement(ib.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function jI(r){let{routeContext:e,match:t,children:n}=r,i=G.useContext(Jd);return i&&i.static&&i.staticContext&&(t.route.errorElement||t.route.ErrorBoundary)&&(i.staticContext._deepestRenderedBoundaryId=t.route.id),G.createElement(yn.Provider,{value:e},n)}function FI(r,e,t,n){var i;if(e===void 0&&(e=[]),t===void 0&&(t=null),n===void 0&&(n=null),r==null){var a;if(!t)return null;if(t.errors)r=t.matches;else if((a=n)!=null&&a.v7_partialHydration&&e.length===0&&!t.initialized&&t.matches.length>0)r=t.matches;else return null}let s=r,o=(i=t)==null?void 0:i.errors;if(o!=null){let d=s.findIndex(h=>h.route.id&&(o==null?void 0:o[h.route.id])!==void 0);d>=0||ht(!1),s=s.slice(0,Math.min(s.length,d+1))}let l=!1,u=-1;if(t&&n&&n.v7_partialHydration)for(let d=0;d<s.length;d++){let h=s[d];if((h.route.HydrateFallback||h.route.hydrateFallbackElement)&&(u=d),h.route.id){let{loaderData:f,errors:m}=t,v=h.route.loader&&f[h.route.id]===void 0&&(!m||m[h.route.id]===void 0);if(h.route.lazy||v){l=!0,u>=0?s=s.slice(0,u+1):s=[s[0]];break}}}return s.reduceRight((d,h,f)=>{let m,v=!1,y=null,I=null;t&&(m=o&&h.route.id?o[h.route.id]:void 0,y=h.route.errorElement||LI,l&&(u<0&&f===0?(GI("route-fallback"),v=!0,I=null):u===f&&(v=!0,I=h.route.hydrateFallbackElement||null)));let g=e.concat(s.slice(0,f+1)),p=()=>{let b;return m?b=y:v?b=I:h.route.Component?b=G.createElement(h.route.Component,null):h.route.element?b=h.route.element:b=d,G.createElement(jI,{match:h,routeContext:{outlet:d,matches:g,isDataRoute:t!=null},children:b})};return t&&(h.route.ErrorBoundary||h.route.errorElement||f===0)?G.createElement(UI,{location:t.location,revalidation:t.revalidation,component:y,error:m,children:p(),routeContext:{outlet:null,matches:g,isDataRoute:!0}}):p()},null)}var sb=function(r){return r.UseBlocker="useBlocker",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r}(sb||{}),ob=function(r){return r.UseBlocker="useBlocker",r.UseLoaderData="useLoaderData",r.UseActionData="useActionData",r.UseRouteError="useRouteError",r.UseNavigation="useNavigation",r.UseRouteLoaderData="useRouteLoaderData",r.UseMatches="useMatches",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r.UseRouteId="useRouteId",r}(ob||{});function BI(r){let e=G.useContext(Jd);return e||ht(!1),e}function $I(r){let e=G.useContext(nb);return e||ht(!1),e}function WI(r){let e=G.useContext(yn);return e||ht(!1),e}function lb(r){let e=WI(),t=e.matches[e.matches.length-1];return t.route.id||ht(!1),t.route.id}function KI(){var r;let e=G.useContext(ib),t=$I(),n=lb();return e!==void 0?e:(r=t.errors)==null?void 0:r[n]}function VI(){let{router:r}=BI(sb.UseNavigateStable),e=lb(ob.UseNavigateStable),t=G.useRef(!1);return ab(()=>{t.current=!0}),G.useCallback(function(i,a){a===void 0&&(a={}),t.current&&(typeof i=="number"?r.navigate(i):r.navigate(i,Yo({fromRouteId:e},a)))},[r,e])}const Ig={};function GI(r,e,t){Ig[r]||(Ig[r]=!0)}function qI(r,e){r==null||r.v7_startTransition,r==null||r.v7_relativeSplatPath}function ub(r){let{to:e,replace:t,state:n,relative:i}=r;Os()||ht(!1);let{future:a,static:s}=G.useContext(Wn),{matches:o}=G.useContext(yn),{pathname:l}=ma(),u=Np(),d=xp(e,Dp(o,a.v7_relativeSplatPath),l,i==="path"),h=JSON.stringify(d);return G.useEffect(()=>u(JSON.parse(h),{replace:t,state:n,relative:i}),[u,h,i,t,n]),null}function HI(r){return AI(r.context)}function Vt(r){ht(!1)}function zI(r){let{basename:e="/",children:t=null,location:n,navigationType:i=ui.Pop,navigator:a,static:s=!1,future:o}=r;Os()&&ht(!1);let l=e.replace(/^\/*/,"/"),u=G.useMemo(()=>({basename:l,navigator:a,static:s,future:Yo({v7_relativeSplatPath:!1},o)}),[l,o,a,s]);typeof n=="string"&&(n=pa(n));let{pathname:d="/",search:h="",hash:f="",state:m=null,key:v="default"}=n,y=G.useMemo(()=>{let I=vs(d,l);return I==null?null:{location:{pathname:I,search:h,hash:f,state:m,key:v},navigationType:i}},[l,d,h,f,m,v,i]);return y==null?null:G.createElement(Wn.Provider,{value:u},G.createElement(Yd.Provider,{children:t,value:y}))}function JI(r){let{children:e,location:t}=r;return DI(wf(e),t)}new Promise(()=>{});function wf(r,e){e===void 0&&(e=[]);let t=[];return G.Children.forEach(r,(n,i)=>{if(!G.isValidElement(n))return;let a=[...e,i];if(n.type===G.Fragment){t.push.apply(t,wf(n.props.children,a));return}n.type!==Vt&&ht(!1),!n.props.index||!n.props.children||ht(!1);let s={id:n.props.id||a.join("-"),caseSensitive:n.props.caseSensitive,element:n.props.element,Component:n.props.Component,index:n.props.index,path:n.props.path,loader:n.props.loader,action:n.props.action,errorElement:n.props.errorElement,ErrorBoundary:n.props.ErrorBoundary,hasErrorBoundary:n.props.ErrorBoundary!=null||n.props.errorElement!=null,shouldRevalidate:n.props.shouldRevalidate,handle:n.props.handle,lazy:n.props.lazy};n.props.children&&(s.children=wf(n.props.children,a)),t.push(s)}),t}/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function dd(){return dd=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},dd.apply(this,arguments)}function db(r,e){if(r==null)return{};var t={},n=Object.keys(r),i,a;for(a=0;a<n.length;a++)i=n[a],!(e.indexOf(i)>=0)&&(t[i]=r[i]);return t}function YI(r){return!!(r.metaKey||r.altKey||r.ctrlKey||r.shiftKey)}function QI(r,e){return r.button===0&&(!e||e==="_self")&&!YI(r)}const XI=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],ZI=["aria-current","caseSensitive","className","end","style","to","viewTransition","children"],eC="6";try{window.__reactRouterVersion=eC}catch{}const tC=G.createContext({isTransitioning:!1}),rC="startTransition",Cg=qw[rC];function nC(r){let{basename:e,children:t,future:n,window:i}=r,a=G.useRef();a.current==null&&(a.current=iI({window:i,v5Compat:!0}));let s=a.current,[o,l]=G.useState({action:s.action,location:s.location}),{v7_startTransition:u}=n||{},d=G.useCallback(h=>{u&&Cg?Cg(()=>l(h)):l(h)},[l,u]);return G.useLayoutEffect(()=>s.listen(d),[s,d]),G.useEffect(()=>qI(n),[n]),G.createElement(zI,{basename:e,children:t,location:o.location,navigationType:o.action,navigator:s,future:n})}const iC=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",aC=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Wa=G.forwardRef(function(e,t){let{onClick:n,relative:i,reloadDocument:a,replace:s,state:o,target:l,to:u,preventScrollReset:d,viewTransition:h}=e,f=db(e,XI),{basename:m}=G.useContext(Wn),v,y=!1;if(typeof u=="string"&&aC.test(u)&&(v=u,iC))try{let b=new URL(window.location.href),R=u.startsWith("//")?new URL(b.protocol+u):new URL(u),P=vs(R.pathname,m);R.origin===b.origin&&P!=null?u=P+R.search+R.hash:y=!0}catch{}let I=kI(u,{relative:i}),g=oC(u,{replace:s,state:o,target:l,preventScrollReset:d,relative:i,viewTransition:h});function p(b){n&&n(b),b.defaultPrevented||g(b)}return G.createElement("a",dd({},f,{href:v||I,onClick:y||a?n:p,ref:t,target:l}))}),Hn=G.forwardRef(function(e,t){let{"aria-current":n="page",caseSensitive:i=!1,className:a="",end:s=!1,style:o,to:l,viewTransition:u,children:d}=e,h=db(e,ZI),f=Qd(l,{relative:h.relative}),m=ma(),v=G.useContext(nb),{navigator:y,basename:I}=G.useContext(Wn),g=v!=null&&lC(f)&&u===!0,p=y.encodeLocation?y.encodeLocation(f).pathname:f.pathname,b=m.pathname,R=v&&v.navigation&&v.navigation.location?v.navigation.location.pathname:null;i||(b=b.toLowerCase(),R=R?R.toLowerCase():null,p=p.toLowerCase()),R&&I&&(R=vs(R,I)||R);const P=p!=="/"&&p.endsWith("/")?p.length-1:p.length;let E=b===p||!s&&b.startsWith(p)&&b.charAt(P)==="/",C=R!=null&&(R===p||!s&&R.startsWith(p)&&R.charAt(p.length)==="/"),S={isActive:E,isPending:C,isTransitioning:g},x=E?n:void 0,K;typeof a=="function"?K=a(S):K=[a,E?"active":null,C?"pending":null,g?"transitioning":null].filter(Boolean).join(" ");let z=typeof o=="function"?o(S):o;return G.createElement(Wa,dd({},h,{"aria-current":x,className:K,ref:t,style:z,to:l,viewTransition:u}),typeof d=="function"?d(S):d)});var Tf;(function(r){r.UseScrollRestoration="useScrollRestoration",r.UseSubmit="useSubmit",r.UseSubmitFetcher="useSubmitFetcher",r.UseFetcher="useFetcher",r.useViewTransitionState="useViewTransitionState"})(Tf||(Tf={}));var Og;(function(r){r.UseFetcher="useFetcher",r.UseFetchers="useFetchers",r.UseScrollRestoration="useScrollRestoration"})(Og||(Og={}));function sC(r){let e=G.useContext(Jd);return e||ht(!1),e}function oC(r,e){let{target:t,replace:n,state:i,preventScrollReset:a,relative:s,viewTransition:o}=e===void 0?{}:e,l=Np(),u=ma(),d=Qd(r,{relative:s});return G.useCallback(h=>{if(QI(h,t)){h.preventDefault();let f=n!==void 0?n:ud(u)===ud(d);l(r,{replace:f,state:i,preventScrollReset:a,relative:s,viewTransition:o})}},[u,l,d,n,i,t,r,a,s,o])}function lC(r,e){e===void 0&&(e={});let t=G.useContext(tC);t==null&&ht(!1);let{basename:n}=sC(Tf.useViewTransitionState),i=Qd(r,{relative:e.relative});if(!t.isTransitioning)return!1;let a=vs(t.currentLocation.pathname,n)||t.currentLocation.pathname,s=vs(t.nextLocation.pathname,n)||t.nextLocation.pathname;return bf(i.pathname,s)!=null||bf(i.pathname,a)!=null}const uC="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function Qa(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}function dC(r){try{const e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}"),n=JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{};return{name:e.name||n.name||"Org",logo:e.logoDataUrl||e.logoUrl||n.logoDataUrl||n.logoUrl||null}}catch{return{name:"Org",logo:null}}}function cC(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)\/public/i);return r?decodeURIComponent(r[1]):null}function hC(r){const e=Qa(`bf_org_settings_${r}`,{}),t=Qa(`bf_public_cfg_${r}`,null)||Qa(`bf_public_${r}`,null)||null,n=(t==null?void 0:t.title)||(e==null?void 0:e.name)||"Your Organization",i=(t==null?void 0:t.about)||"",a=Array.isArray(t==null?void 0:t.features)?t.features:[],s=Array.isArray(t==null?void 0:t.links)?t.links:[],o=(t==null?void 0:t.logoDataUrl)||(t==null?void 0:t.logoUrl)||(e==null?void 0:e.logoDataUrl)||(e==null?void 0:e.logoUrl)||null;return{title:n,about:i,features:a,links:s,logo:o,enabled:!0}}function kg(r){const e=Qa("bf_state",null)||{inventory:[],needs:[],pledges:[],newsletters:[]},t=n=>Array.isArray(n)&&n.some(i=>i&&Object.prototype.hasOwnProperty.call(i,"org"))?n.filter(i=>(i==null?void 0:i.org)===r):n;return{inventory:t(e.inventory||[]),needs:t(e.needs||[]),pledges:e.pledges||[],newsletters:e.newsletters||[]}}function fC(r){const e=Qa("bf_pledges",[]);e.push({...r,id:crypto.randomUUID(),created:Date.now()}),localStorage.setItem("bf_pledges",JSON.stringify(e))}function vC(r){const e=Qa("bf_newsletters",[]);e.some(t=>{var n;return((n=t.email)==null?void 0:n.toLowerCase())===r.toLowerCase()})||(e.push({email:r,created:Date.now()}),localStorage.setItem("bf_newsletters",JSON.stringify(e)))}function cd(r){const e=(r==null?void 0:r.data)||null,{slug:t}=gl(),[n,i]=G.useState(()=>e?{loading:!1,error:"",data:e}:t?{loading:!0,error:"",data:null}:{loading:!1,error:"",data:null});G.useEffect(()=>{if(!t||e)return;let p=!0;return(async()=>{try{const b=await fetch(`${uC}/api/public/${encodeURIComponent(t)}`),R=await b.json().catch(()=>({}));if(!p)return;!b.ok||R.ok===!1?i({loading:!1,error:R.error||`HTTP ${b.status}`,data:null}):i({loading:!1,error:"",data:R})}catch(b){p&&i({loading:!1,error:b.message,data:null})}})(),()=>{p=!1}},[t,e]);const{pubCfg:a,orgId:s,local:o}=G.useMemo(()=>{var R;if(t&&((R=n.data)!=null&&R.public)){const P=n.data.public,E=n.data.orgId||null;return{pubCfg:{title:P.title||t,about:P.about||"",features:Array.isArray(P.features)?P.features:[],links:Array.isArray(P.links)?P.links:[],logo:P.logoDataUrl||P.logoUrl||null,enabled:!0},orgId:E,local:kg(E)}}const p=cC();return{pubCfg:e!=null&&e.public?{title:e.public.title||"Your Organization",about:e.public.about||"",features:Array.isArray(e.public.features)?e.public.features:[],links:Array.isArray(e.public.links)?e.public.links:[],logo:e.public.logoDataUrl||e.public.logoUrl||null,enabled:!0}:hC(p),orgId:p,local:kg(p)}},[t,n.data,e]),l=G.useMemo(()=>s?dC(s):{name:"Org",logo:null},[s]),[u,d]=G.useState(""),[h,f]=G.useState(""),m=G.useMemo(()=>{const p=new Set((o.inventory||[]).filter(b=>b==null?void 0:b.public).map(b=>b==null?void 0:b.category).filter(Boolean));return Array.from(p)},[o.inventory]),v=G.useMemo(()=>{const p=(o.inventory||[]).filter(R=>R==null?void 0:R.public),b=u.toLowerCase();return p.filter(R=>(!b||`${(R==null?void 0:R.name)||""} ${(R==null?void 0:R.category)||""} ${(R==null?void 0:R.location)||""}`.toLowerCase().includes(b))&&(!h||(R==null?void 0:R.category)===h))},[o.inventory,u,h]),y=G.useMemo(()=>(o.needs||[]).filter(p=>((p==null?void 0:p.status)??"open")==="open"),[o.needs]),I=p=>{var C,S,x;p.preventDefault();const b=new FormData(p.currentTarget),R=((C=b.get("name"))==null?void 0:C.toString().trim())||"Anonymous",P=((S=b.get("contact"))==null?void 0:S.toString().trim())||"",E=((x=b.get("message"))==null?void 0:x.toString().trim())||"";fC({name:R,contact:P,message:E,orgId:s}),p.currentTarget.reset(),alert("Thanks  we saved your pledge.")},g=p=>{var P;p.preventDefault();const R=((P=new FormData(p.currentTarget).get("email"))==null?void 0:P.toString().trim())||"";R&&(vC(R),p.currentTarget.reset(),alert("You are on the list."))};return n.loading?_.jsx("div",{style:{padding:16},children:"Loading"}):n.error?_.jsxs("div",{style:{padding:16,color:"crimson"},children:["Error: ",n.error]}):_.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[_.jsxs("header",{style:{display:"flex",alignItems:"center",gap:12,marginTop:0,borderBottom:"1px solid #eee",paddingBottom:12},children:[l.logo&&_.jsx("img",{src:l.logo,alt:"Org logo",style:{height:48,width:48,borderRadius:8,objectFit:"cover"}}),_.jsx("h1",{style:{margin:0,fontSize:24},children:(a==null?void 0:a.title)||l.name||t||"Public Page"})]}),(a==null?void 0:a.about)&&_.jsx("p",{style:{lineHeight:1.6,marginTop:12},children:a.about}),Array.isArray(a==null?void 0:a.features)&&a.features.length>0&&_.jsxs("div",{className:"card",style:{marginTop:16,padding:12},children:[_.jsx("h3",{className:"section-title",style:{margin:0},children:"What we do"}),_.jsx("ul",{style:{paddingLeft:18,marginTop:8},children:a.features.map((p,b)=>_.jsx("li",{children:p},b))})]}),_.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:12,marginTop:12},children:[_.jsxs("section",{className:"card",style:{padding:12},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Inventory (public)"}),_.jsxs("div",{className:"row",style:{gap:8,marginTop:8},children:[_.jsx("input",{className:"input",placeholder:"Search items",value:u,onChange:p=>d(p.target.value),style:{flex:1}}),_.jsxs("select",{className:"input",value:h,onChange:p=>f(p.target.value),style:{width:120},children:[_.jsx("option",{value:"",children:"All"}),m.map(p=>_.jsx("option",{value:p,children:p},p))]})]}),_.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[v.map(p=>_.jsxs("li",{children:[_.jsx("strong",{children:p.name}),p.qty?`  ${p.qty}`:""," ",p.unit||""," ",p.category?`  ${p.category}`:""]},p.id||p.name)),v.length===0&&_.jsx("li",{className:"helper",children:"No public items."})]})]}),_.jsxs("section",{className:"card",style:{padding:12},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Open needs"}),_.jsxs("ul",{style:{paddingLeft:18,marginTop:8},children:[y.map(p=>_.jsxs("li",{children:[_.jsx("strong",{children:p.title||"Untitled"}),p.status?`  ${p.status}`:""]},p.id||p.title)),y.length===0&&_.jsx("li",{className:"helper",children:"No open needs right now."})]}),_.jsxs("details",{style:{marginTop:12},children:[_.jsx("summary",{className:"section-title",style:{fontSize:16},children:"I can help"}),_.jsxs("form",{onSubmit:I,className:"grid",style:{gap:8},children:[_.jsx("input",{className:"input",name:"name",placeholder:"Your name"}),_.jsx("input",{className:"input",name:"contact",placeholder:"Email or phone",required:!0}),_.jsx("textarea",{className:"textarea",name:"message",placeholder:"How you can help"}),_.jsx("button",{className:"btn",children:"Send"})]})]})]}),_.jsxs("section",{className:"card",style:{padding:12},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Stay in touch"}),_.jsxs("form",{onSubmit:g,className:"grid",style:{gap:8},children:[_.jsx("input",{className:"input",name:"email",type:"email",placeholder:"you@example.org",required:!0}),_.jsx("button",{className:"btn",children:"Join Newsletter"})]}),Array.isArray(a==null?void 0:a.links)&&a.links.length>0&&_.jsxs("div",{style:{marginTop:16},children:[_.jsx("h4",{className:"section-title",style:{marginTop:0},children:"Links"}),_.jsx("ul",{style:{paddingLeft:18},children:a.links.map((p,b)=>_.jsx("li",{children:_.jsx("a",{href:p.url,target:"_blank",rel:"noreferrer",children:p.text||p.url})},b))})]})]})]})]})}function pC(r){let e={};try{e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}")}catch{}try{e={...JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{},...e}}catch{}return e||{}}function mC(r){return Array.isArray(r)?r.filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>e.trim()).filter(Boolean):[]}function gC(r){return Array.isArray(r)?r.map(e=>e&&e.url?{text:e.text||e.url,url:e.url}:null).filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>{const[t,n]=e.split("|").map(i=>(i||"").trim());return n?{text:t||n,url:n}:null}).filter(Boolean):[]}function yC(){const{orgId:r}=gl(),e=pC(r),t=(e.publicTitle||e.title||e.name||"Public page").trim(),n=(e.publicAbout||e.about||"This is a live preview of your public page.").trim(),i=mC(e.publicFeatures??e.features),a=gC(e.publicLinks??e.links),s={public:{title:t,about:n,features:i.length?i:["Mutual aid & community support","Donations & supplies","Volunteer coordination"],links:a.length?a:[{text:"Website",url:"https://example.org"},{text:"Email",url:"mailto:hello@example.org"}]}};return _.jsx("div",{style:{margin:16},children:_.jsx(cd,{data:s})})}const SC=G.createContext(null),ps=()=>G.useContext(SC),cb="bf_store_v2",Pg=()=>({orgs:[{id:"crman",name:"Chehalis River Mutual Aid Network",slug:"crman",color:"#8a1111",logoDataUrl:null},{id:"bondfire",name:"Bondfire",slug:"bondfire",color:"#8a1111",logoDataUrl:null}],currentOrgId:"crman",people:[],inventory:[],needs:[],meetings:[],pledges:[],newsletters:[],requests:[],files:{}});function Mg(r){return localStorage.setItem(cb,JSON.stringify(r)),r}function EC(){try{return JSON.parse(localStorage.getItem(cb))||Mg(Pg())}catch{return Mg(Pg())}}let _C=EC();function bo(){return _C}function bC(){const e=((typeof ps=="function"?ps():null)||{}).orgName||null,t=G.useMemo(()=>{var a;try{const o=(window.location.hash||"#/org/org-demo-a").match(/#\/org\/([^/]+)/);if(o&&o[1])return decodeURIComponent(o[1]);const l=bo();return l.currentOrgId||l.orgs&&((a=l.orgs[0])==null?void 0:a.id)||"org-demo-a"}catch{return bo().currentOrgId||"org-demo-a"}},[]),n={position:"sticky",top:0,zIndex:1e3,background:"var(--bg)",borderBottom:"1px solid var(--border)",padding:"8px 12px"},i={display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,maxWidth:1100,margin:"0 auto"};return _.jsx("header",{style:n,"data-app-header":!0,children:_.jsxs("div",{style:i,children:[_.jsxs("div",{className:"brand",style:{display:"flex",alignItems:"center",gap:10},children:[_.jsxs(Wa,{to:"/orgs",style:{textDecoration:"none",color:"inherit",display:"flex",alignItems:"center",gap:8},title:"Back to all orgs",children:[_.jsx("img",{src:"/logo.png",alt:"Bondfire",style:{height:28,width:28,objectFit:"contain",borderRadius:6}}),_.jsx("strong",{children:"Bondfire"})]}),e&&_.jsxs("span",{style:{opacity:.9},children:[" ",e]})]}),_.jsxs("nav",{className:"topnav",style:{display:"flex",gap:8,flexWrap:"wrap"},children:[_.jsx(Hn,{to:`/org/${t}`,end:!0,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Dashboard"}),_.jsx(Hn,{to:`/org/${t}/people`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"People"}),_.jsx(Hn,{to:`/org/${t}/inventory`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Inventory"}),_.jsx(Hn,{to:`/org/${t}/needs`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Needs"}),_.jsx(Hn,{to:`/org/${t}/meetings`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Meetings"}),_.jsx(Hn,{to:`/org/${t}/settings`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Settings"}),_.jsx(Hn,{to:`/org/${t}/public`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"Public"}),_.jsx(Hn,{to:`/org/${t}/chat`,className:({isActive:a})=>a?"btn-red active":"btn-red",children:"BambiChat"})]})]})})}function wC(r){try{const e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}"),n=JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{};return{name:e.name||n.name||"Org",logo:e.logoDataUrl||e.logoUrl||n.logoDataUrl||n.logoUrl||null}}catch{return{name:"Org",logo:null}}}function Ag(){const e=((typeof ps=="function"?ps():null)||{}).orgName||null,t=G.useMemo(()=>{var v;try{const I=(window.location.hash||"#/org/org-demo-a").match(/#\/org\/([^/]+)/);if(I&&I[1])return decodeURIComponent(I[1]);const g=bo();return g.currentOrgId||g.orgs&&((v=g.orgs[0])==null?void 0:v.id)||"org-demo-a"}catch{return bo().currentOrgId||"org-demo-a"}},[]),{name:n,logo:i}=wC(t),a=bo()||{},s=v=>Array.isArray(v)?v:[],o=s(a.people).filter(v=>!v.org||v.org===t),l=s(a.inventory).filter(v=>!v.org||v.org===t),u=s(a.needs).filter(v=>!v.org||v.org===t),d=s(a.meetings).filter(v=>!v.org||v.org===t),h=s(a.activity).filter(v=>!v.org||v.org===t),f={display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(260px, 1fr))",gap:12,margin:16},m=({title:v,right:y,children:I})=>_.jsxs("div",{className:"card",style:{padding:12},children:[_.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between"},children:[_.jsx("strong",{children:v}),y]}),_.jsx("div",{style:{marginTop:8},children:I})]});return _.jsxs(_.Fragment,{children:[_.jsxs("div",{className:"card",style:{margin:16,padding:12},children:[_.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[i&&_.jsx("img",{src:i,alt:"Org Logo",style:{width:80,height:80,borderRadius:12,objectFit:"cover"}}),_.jsxs("h2",{className:"section-title",style:{margin:0,flex:1},children:[e||n,"  Dashboard"]})]}),_.jsxs("div",{style:{marginTop:8},children:[_.jsx("strong",{children:"Announcements"}),_.jsx("p",{className:"helper",style:{marginTop:6},children:"Pin important updates for members here."})]})]}),_.jsxs("div",{style:f,children:[_.jsxs(m,{title:"People",right:_.jsx(Wa,{className:"btn-red",to:`/org/${t}/people`,children:"View all"}),children:[_.jsxs("div",{className:"helper",children:[o.length," member",o.length===1?"":"s"]}),_.jsxs("ul",{style:{marginTop:6,paddingLeft:16},children:[o.slice(0,5).map((v,y)=>_.jsxs("li",{children:[(v==null?void 0:v.name)??"Unnamed",v!=null&&v.role?`  ${v.role}`:""]},(v==null?void 0:v.id)||(v==null?void 0:v.name)||y)),!o.length&&_.jsx("li",{children:"No people yet."})]})]}),_.jsxs(m,{title:"Inventory",right:_.jsx(Wa,{className:"btn-red",to:`/org/${t}/inventory`,children:"View all"}),children:[_.jsxs("div",{className:"helper",children:[l.length," item",l.length===1?"":"s"]}),!l.length&&_.jsx("p",{className:"helper",children:"No items yet."})]}),_.jsxs(m,{title:"Needs",right:_.jsx(Wa,{className:"btn-red",to:`/org/${t}/needs`,children:"View all"}),children:[_.jsxs("div",{className:"helper",children:[u.length," total"]}),!u.length&&_.jsx("p",{className:"helper",children:"No needs yet."})]}),_.jsx(m,{title:"Meetings",right:_.jsx(Wa,{className:"btn-red",to:`/org/${t}/meetings`,children:"View all"}),children:!d.length&&_.jsx("p",{className:"helper",children:"No meetings scheduled."})}),_.jsx(m,{title:"Recent Activity",children:!h.length&&_.jsx("p",{className:"helper",children:"No recent activity."})})]})]})}const TC=()=>{try{return JSON.parse(localStorage.getItem("bf_orgs")||"[]")}catch{return[]}},Dg=r=>localStorage.setItem("bf_orgs",JSON.stringify(r));function xg(){const[r,e]=G.useState(""),[t,n]=G.useState(""),[i,a]=G.useState(TC()),s=Np(),o=u=>{u.preventDefault();const d=r.trim();if(!d)return;const h={id:"org_"+Math.random().toString(36).slice(2,8),name:d,role:"owner"},f=[...i,h];a(f),Dg(f),e("")},l=u=>{u.preventDefault();const d=t.trim();if(!d)return;const h={id:d,name:`Org ${d.slice(-4)}`,role:"member"},f=[...i,h];a(f),Dg(f),n("")};return _.jsxs("div",{className:"grid",style:{gap:12},children:[_.jsxs("div",{className:"card",children:[_.jsx("h1",{style:{margin:"4px 0 8px"},children:"Org Dashboard"}),_.jsx("p",{className:"helper",children:"Choose an organization to enter its workspace, or create/join one."})]}),_.jsx("div",{style:{marginTop:8},children:_.jsx("button",{className:"primary",type:"button",onClick:()=>window.location.assign("/#/mfa"),children:"Set up 2FA (recommended)"})}),_.jsxs("div",{className:"grid cols-2",children:[_.jsxs("div",{className:"card",children:[_.jsx("h3",{children:"Create a new org"}),_.jsxs("form",{onSubmit:o,className:"grid",style:{gap:8},children:[_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Organization name"}),_.jsx("input",{value:r,onChange:u=>e(u.target.value),placeholder:"e.g. Bondfire Team"})]}),_.jsx("button",{className:"primary",type:"submit",children:"Create"})]})]}),_.jsxs("div",{className:"card",children:[_.jsx("h3",{children:"Join with an invite code"}),_.jsxs("form",{onSubmit:l,className:"grid",style:{gap:8},children:[_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Invite code"}),_.jsx("input",{value:t,onChange:u=>n(u.target.value),placeholder:"Paste invite code"})]}),_.jsx("button",{className:"primary",type:"submit",children:"Join"})]})]})]}),_.jsxs("div",{className:"card",children:[_.jsx("h3",{children:"Your orgs"}),i.length?_.jsx("ul",{style:{display:"grid",gap:8,marginTop:8,listStyle:"none",padding:0},children:i.map(u=>_.jsxs("li",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[_.jsxs("div",{children:[_.jsx("div",{style:{fontWeight:600},children:u.name}),_.jsxs("div",{className:"helper",children:["Role: ",u.role]})]}),_.jsx("button",{className:"btn",onClick:()=>s(`/org/${u.id}/overview`),children:"Open"})]},u.id))}):_.jsx("p",{className:"helper",style:{marginTop:6},children:"You dont belong to any orgs yet."})]})]})}function RC(){const{orgId:r}=gl();return((typeof ps=="function"?ps():{})||{}).orgName,_.jsx("div",{style:{padding:0},children:_.jsx(HI,{})})}const hb="bondfire:data:v2",Xl={org:{id:"crman",name:"Chehalis River Mutual Aid Network",color:"#8a1111",logoDataUrl:null},people:[],inventory:[],needs:[],meetings:[],pledges:[],newsletter:[],files:{}};function IC(){try{const r=localStorage.getItem(hb);if(!r)return structuredClone(Xl);const e=JSON.parse(r);return{...structuredClone(Xl),...e,org:{...Xl.org,...e.org||{}}}}catch(r){return console.error("store load error",r),structuredClone(Xl)}}function CC(r){try{localStorage.setItem(hb,JSON.stringify(r))}catch(e){console.error("store save error",e)}}let st=IC();const Rf=new Set;function OC(){return st}function kC(r){return Rf.add(r),()=>Rf.delete(r)}function Ir(){for(const r of Rf)r(st);CC(st)}function PC(r){st.people.push({id:crypto.randomUUID(),...r}),Ir()}function Zl(r,e){st.people=st.people.map(t=>t.id===r?{...t,...e}:t),Ir()}function MC(r){st.people=st.people.filter(e=>e.id!==r),Ir()}function AC(r){st.inventory.push({id:crypto.randomUUID(),public:!0,...r}),Ir()}function xi(r,e){st.inventory=st.inventory.map(t=>t.id===r?{...t,...e}:t),Ir()}function DC(r){st.inventory=st.inventory.filter(e=>e.id!==r),Ir()}function xC(r){st.needs.push({id:crypto.randomUUID(),status:"open",...r}),Ir()}function Gs(r,e){st.needs=st.needs.map(t=>t.id===r?{...t,...e}:t),Ir()}function NC(r){st.needs=st.needs.filter(e=>e.id!==r),Ir()}function LC(r){st.meetings.push({id:crypto.randomUUID(),files:[],...r}),Ir()}function Qc(r,e){st.meetings=st.meetings.map(t=>t.id===r?{...t,...e}:t),Ir()}function UC(r,e){st.meetings=st.meetings.map(t=>t.id===r?{...t,files:[...t.files,e]}:t),Ir()}async function jC(r){const e=await r.arrayBuffer(),t=btoa(String.fromCharCode(...new Uint8Array(e))),n=`data:${r.type||"application/octet-stream"};base64,${t}`,i=crypto.randomUUID();return st.files[i]={id:i,name:r.name,type:r.type,size:r.size,dataUrl:n,createdAt:Date.now()},Ir(),i}function Qo(r=e=>e){return G.useSyncExternalStore(kC,()=>r(OC()))}function FC(){const r=Qo(a=>a.people),[e,t]=G.useState(""),n=G.useMemo(()=>r.filter(a=>[a.name,a.role,a.skills].join(" ").toLowerCase().includes(e.toLowerCase())),[r,e]);function i(a){a.preventDefault();const s=new FormData(a.currentTarget);PC({name:s.get("name"),role:s.get("role"),phone:s.get("phone"),skills:s.get("skills")}),a.currentTarget.reset()}return _.jsx("div",{children:_.jsxs("div",{className:"card",style:{margin:16},children:[_.jsx("h2",{className:"section-title",children:"People"}),_.jsx("input",{className:"input",value:e,onChange:a=>t(a.target.value),placeholder:"Search by name, role, skills"}),_.jsxs("table",{className:"table",style:{marginTop:12},children:[_.jsx("thead",{children:_.jsxs("tr",{children:[_.jsx("th",{children:"Name"}),_.jsx("th",{children:"Role"}),_.jsx("th",{children:"Phone"}),_.jsx("th",{children:"Skills"}),_.jsx("th",{})]})}),_.jsx("tbody",{children:n.map(a=>_.jsxs("tr",{children:[_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:a.name,onBlur:s=>Zl(a.id,{name:s.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:a.role,onBlur:s=>Zl(a.id,{role:s.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:a.phone,onBlur:s=>Zl(a.id,{phone:s.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:a.skills,onBlur:s=>Zl(a.id,{skills:s.target.value})})}),_.jsx("td",{children:_.jsx("button",{className:"btn",onClick:()=>MC(a.id),children:"Delete"})})]},a.id))})]}),_.jsxs("form",{onSubmit:i,className:"grid cols-3",style:{marginTop:12},children:[_.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),_.jsx("input",{className:"input",name:"role",placeholder:"Role"}),_.jsx("input",{className:"input",name:"phone",placeholder:"Phone"}),_.jsx("input",{className:"input",name:"skills",placeholder:"Skills"}),_.jsx("div",{}),_.jsx("div",{}),_.jsx("button",{className:"btn",children:"Add Person"})]})]})})}function BC(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}function $C(){const r=BC(),e=Qo(o=>o.inventory||[]),t=G.useMemo(()=>r&&e.some(o=>o&&Object.prototype.hasOwnProperty.call(o,"org"))?e.filter(o=>(o==null?void 0:o.org)===r):e,[e,r]),[n,i]=G.useState(""),a=G.useMemo(()=>{const o=n.toLowerCase();return t.filter(l=>[l.name,l.category,l.location].filter(Boolean).join(" ").toLowerCase().includes(o))},[t,n]);function s(o){o.preventDefault();const l=new FormData(o.currentTarget);AC({id:crypto.randomUUID(),name:l.get("name"),qty:+(l.get("qty")||0),unit:l.get("unit")||"ea",category:l.get("category")||"",location:l.get("location")||"",public:l.get("public")==="on",low:+(l.get("low")||0),org:r||void 0}),o.currentTarget.reset()}return _.jsx("div",{children:_.jsxs("div",{className:"card",style:{margin:16},children:[_.jsx("h2",{className:"section-title",children:"Inventory"}),_.jsx("input",{className:"input",value:n,onChange:o=>i(o.target.value),placeholder:"Search by name, category, location"}),_.jsxs("table",{className:"table",style:{marginTop:12},children:[_.jsx("thead",{children:_.jsxs("tr",{children:[_.jsx("th",{children:"Name"}),_.jsx("th",{children:"Qty"}),_.jsx("th",{children:"Unit"}),_.jsx("th",{children:"Category"}),_.jsx("th",{children:"Location"}),_.jsx("th",{children:"Public"}),_.jsx("th",{children:"Low"}),_.jsx("th",{})]})}),_.jsxs("tbody",{children:[a.map(o=>_.jsxs("tr",{children:[_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.name,onBlur:l=>xi(o.id,{name:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",type:"number",defaultValue:o.qty,onBlur:l=>xi(o.id,{qty:+l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.unit,onBlur:l=>xi(o.id,{unit:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.category,onBlur:l=>xi(o.id,{category:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.location,onBlur:l=>xi(o.id,{location:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{type:"checkbox",defaultChecked:!!o.public,onChange:l=>xi(o.id,{public:l.target.checked})})}),_.jsx("td",{children:_.jsx("input",{className:"input",type:"number",defaultValue:o.low,onBlur:l=>xi(o.id,{low:+l.target.value})})}),_.jsx("td",{children:_.jsx("button",{className:"btn",onClick:()=>DC(o.id),children:"Delete"})})]},o.id)),a.length===0&&_.jsx("tr",{children:_.jsx("td",{colSpan:8,className:"helper",children:"No items match."})})]})]}),_.jsxs("form",{onSubmit:s,className:"grid cols-3",style:{marginTop:12},children:[_.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),_.jsx("input",{className:"input",name:"qty",type:"number",placeholder:"Qty",required:!0}),_.jsx("input",{className:"input",name:"unit",placeholder:"Unit"}),_.jsx("input",{className:"input",name:"category",placeholder:"Category"}),_.jsx("input",{className:"input",name:"location",placeholder:"Location"}),_.jsxs("label",{children:[_.jsx("input",{type:"checkbox",name:"public"})," Public"]}),_.jsx("input",{className:"input",name:"low",type:"number",placeholder:"Low threshold"}),_.jsx("div",{}),_.jsx("button",{className:"btn",children:"Add Item"})]})]})})}function WC({file:r}){if(!r)return null;const{name:e,type:t,dataUrl:n}=r;return t.startsWith("image/")?_.jsx("img",{src:n,alt:e,style:{maxWidth:"100%",borderRadius:10}}):t==="application/pdf"?_.jsx("iframe",{title:e,src:n,style:{width:"100%",height:400,border:"1px solid #222",borderRadius:10}}):t.startsWith("audio/")?_.jsx("audio",{controls:!0,src:n,style:{width:"100%"}}):t.startsWith("video/")?_.jsx("video",{controls:!0,src:n,style:{width:"100%",borderRadius:10}}):_.jsxs("a",{className:"btn",href:n,download:e,children:["Download ",e]})}function KC(){const r=Qo(l=>l.meetings),e=Qo(l=>l.files),[t,n]=G.useState(""),[i,a]=G.useState("");async function s(l,u){var f;const d=(f=l.target.files)==null?void 0:f[0];if(!d)return;const h=await jC(d);UC(u,h),l.target.value=""}function o(l){l.preventDefault(),LC({title:t,when:i,notes:""}),n(""),a("")}return _.jsx("div",{children:_.jsxs("div",{className:"card",style:{margin:16},children:[_.jsx("h2",{className:"section-title",children:"Meetings"}),_.jsxs("form",{onSubmit:o,className:"grid cols-3",children:[_.jsx("input",{className:"input",value:t,onChange:l=>n(l.target.value),placeholder:"Title",required:!0}),_.jsx("input",{className:"input",value:i,onChange:l=>a(l.target.value),placeholder:"When"}),_.jsx("button",{className:"btn",children:"Add Meeting"})]}),_.jsx("div",{className:"grid",style:{marginTop:12},children:r.map(l=>{var u;return _.jsxs("div",{className:"card",children:[_.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10},children:[_.jsx("input",{className:"input",defaultValue:l.title,onBlur:d=>Qc(l.id,{title:d.target.value})}),_.jsx("input",{className:"input",defaultValue:l.when,onBlur:d=>Qc(l.id,{when:d.target.value})}),_.jsxs("label",{className:"btn",style:{display:"inline-block"},children:["Upload file",_.jsx("input",{type:"file",style:{display:"none"},onChange:d=>s(d,l.id)})]})]}),((u=l.files)==null?void 0:u.length)>0&&_.jsx("div",{className:"grid",style:{marginTop:10},children:l.files.map(d=>_.jsx(WC,{file:e[d]},d))}),_.jsx("textarea",{className:"textarea",style:{marginTop:10},defaultValue:l.notes,onBlur:d=>Qc(l.id,{notes:d.target.value})})]},l.id)})})]})})}function VC(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}function GC(){const r=VC(),e=Qo(o=>o.needs||[]),t=G.useMemo(()=>r&&e.some(o=>o&&Object.prototype.hasOwnProperty.call(o,"org"))?e.filter(o=>(o==null?void 0:o.org)===r):e,[e,r]),[n,i]=G.useState(""),a=G.useMemo(()=>{const o=n.toLowerCase();return t.filter(l=>[l.title,l.description,l.urgency,l.status].filter(Boolean).join(" ").toLowerCase().includes(o))},[t,n]);function s(o){o.preventDefault();const l=new FormData(o.currentTarget);xC({id:crypto.randomUUID(),title:l.get("title"),description:l.get("description")||"",urgency:l.get("urgency")||"",status:l.get("status")||"open",public:l.get("public")==="on",created:Date.now(),org:r||void 0}),o.currentTarget.reset()}return _.jsx("div",{children:_.jsxs("div",{className:"card",style:{margin:16},children:[_.jsx("h2",{className:"section-title",children:"Needs"}),_.jsx("input",{className:"input",value:n,onChange:o=>i(o.target.value),placeholder:"Search needs"}),_.jsxs("table",{className:"table",style:{marginTop:12},children:[_.jsx("thead",{children:_.jsxs("tr",{children:[_.jsx("th",{children:"Title"}),_.jsx("th",{children:"Description"}),_.jsx("th",{children:"Urgency"}),_.jsx("th",{children:"Status"}),_.jsx("th",{children:"Public"}),_.jsx("th",{})]})}),_.jsxs("tbody",{children:[a.map(o=>_.jsxs("tr",{children:[_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.title,onBlur:l=>Gs(o.id,{title:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.description,onBlur:l=>Gs(o.id,{description:l.target.value})})}),_.jsx("td",{children:_.jsx("input",{className:"input",defaultValue:o.urgency,onBlur:l=>Gs(o.id,{urgency:l.target.value})})}),_.jsx("td",{children:_.jsxs("select",{className:"input",defaultValue:o.status||"open",onChange:l=>Gs(o.id,{status:l.target.value}),children:[_.jsx("option",{value:"open",children:"open"}),_.jsx("option",{value:"in-progress",children:"inprogress"}),_.jsx("option",{value:"resolved",children:"resolved"})]})}),_.jsx("td",{children:_.jsx("input",{type:"checkbox",defaultChecked:!!o.public,onChange:l=>Gs(o.id,{public:l.target.checked})})}),_.jsx("td",{children:_.jsx("button",{className:"btn",onClick:()=>NC(o.id),children:"Delete"})})]},o.id)),a.length===0&&_.jsx("tr",{children:_.jsx("td",{colSpan:6,className:"helper",children:"No needs match."})})]})]}),_.jsxs("form",{onSubmit:s,className:"grid cols-3",style:{marginTop:12},children:[_.jsx("input",{className:"input",name:"title",placeholder:"Title",required:!0}),_.jsx("input",{className:"input",name:"description",placeholder:"Description"}),_.jsx("input",{className:"input",name:"urgency",placeholder:"Urgency (e.g. high)"}),_.jsxs("select",{className:"input",name:"status",defaultValue:"open",children:[_.jsx("option",{value:"open",children:"open"}),_.jsx("option",{value:"in-progress",children:"inprogress"}),_.jsx("option",{value:"resolved",children:"resolved"})]}),_.jsxs("label",{children:[_.jsx("input",{type:"checkbox",name:"public"})," Public"]}),_.jsx("div",{}),_.jsx("button",{className:"btn",children:"Add Need"})]})]})})}const qC="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function Ng(r,e={}){const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=r.startsWith("http")?r:`${qC}${r.startsWith("/")?"":"/"}${r}`,i={"Content-Type":"application/json",...e.headers||{}};return t&&(i.Authorization=`Bearer ${t}`),fetch(n,{...e,headers:i,body:e.body?JSON.stringify(e.body):void 0}).then(async a=>{const s=await a.json().catch(()=>({}));if(!a.ok||s.ok===!1)throw new Error(s.error||s.message||`HTTP ${a.status}`);return s})}const Lg=r=>`bf_org_settings_${r}`,Ug=(r,e={})=>{try{return JSON.parse(localStorage.getItem(r)||JSON.stringify(e))}catch{return e}},HC=(r,e)=>localStorage.setItem(r,JSON.stringify(e));function zC(){const{orgId:r}=gl(),[e,t]=G.useState(""),[n,i]=G.useState(null);G.useEffect(()=>{const S=Ug(Lg(r));S.name&&t(S.name),(S.logoDataUrl||S.logoUrl)&&i(S.logoDataUrl||S.logoUrl)},[r]);const a=S=>{var z;const x=(z=S.target.files)==null?void 0:z[0];if(!x)return;const K=new FileReader;K.onload=()=>i(K.result),K.readAsDataURL(x)},s=()=>{const S=Lg(r),x=Ug(S);HC(S,{...x,name:(e||"").trim(),logoDataUrl:n}),window.dispatchEvent(new CustomEvent("bf:org_settings_changed",{detail:{orgId:r}})),alert("Organization settings saved.")},[o,l]=G.useState(!1),[u,d]=G.useState(""),[h,f]=G.useState(""),[m,v]=G.useState(""),[y,I]=G.useState(""),[g,p]=G.useState(""),[b,R]=G.useState(""),P=async()=>{var S;R("");try{const x=await Ng(`/api/orgs/${encodeURIComponent(r)}/public/generate`,{method:"POST"});d(((S=x.public)==null?void 0:S.slug)||""),R("Generated new link."),setTimeout(()=>R(""),1200)}catch(x){R(x.message)}},E=async S=>{var x,K,z,oe,ge,xe;S==null||S.preventDefault(),R("");try{const _e={enabled:o,slug:(u||"").trim(),title:(h||"").trim(),about:(m||"").trim(),features:(y||"").split(`
`).map(je=>je.trim()).filter(Boolean),links:(g||"").split(`
`).map(je=>{const[re,he]=je.split("|").map(ye=>(ye||"").trim());return he?{text:re||he,url:he}:null}).filter(Boolean)},Me=await Ng(`/api/orgs/${encodeURIComponent(r)}/public/save`,{method:"POST",body:_e});d(((x=Me.public)==null?void 0:x.slug)||_e.slug),f(((K=Me.public)==null?void 0:K.title)??_e.title),v(((z=Me.public)==null?void 0:z.about)??_e.about),I(Array.isArray((oe=Me.public)==null?void 0:oe.features)?Me.public.features.join(`
`):y),p(Array.isArray((ge=Me.public)==null?void 0:ge.links)?Me.public.links.map(je=>`${je.text||je.url} | ${je.url}`).join(`
`):g),l(!!((xe=Me.public)!=null&&xe.enabled)),R("Saved."),setTimeout(()=>R(""),1200)}catch(_e){R(_e.message)}},C=u?`${location.origin}/#/p/${u}`:"";return _.jsxs("div",{className:"grid",style:{gap:16,padding:16},children:[_.jsxs("div",{className:"card",style:{padding:16},children:[_.jsx("h2",{style:{marginTop:0},children:"Organization"}),_.jsxs("div",{className:"grid",style:{gap:10},children:[_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Name"}),_.jsx("input",{className:"input",value:e,onChange:S=>t(S.target.value),placeholder:"Your org name"})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Logo"}),_.jsx("input",{className:"input",type:"file",accept:"image/*",onChange:a}),n&&_.jsx("img",{src:n,alt:"Logo preview",style:{width:96,height:96,borderRadius:12,objectFit:"cover",marginTop:8}})]}),_.jsx("div",{children:_.jsx("button",{className:"btn-red",onClick:s,children:"Save"})})]})]}),_.jsxs("div",{className:"card",style:{padding:16},children:[_.jsx("h2",{style:{marginTop:0},children:"Public Page"}),_.jsx("p",{className:"helper",children:"Share a readonly page for your org. Only what you enable is shown."}),_.jsxs("form",{onSubmit:E,className:"grid",style:{gap:10,marginTop:8},children:[_.jsxs("label",{className:"row",style:{gap:8,alignItems:"center"},children:[_.jsx("input",{type:"checkbox",checked:o,onChange:S=>l(S.target.checked)}),_.jsx("span",{children:"Enable public page"})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Share URL (slug)"}),_.jsxs("div",{className:"row",style:{gap:8},children:[_.jsx("input",{className:"input",style:{flex:1},value:u,onChange:S=>d(S.target.value),placeholder:"e.g. bondfire-team"}),_.jsx("button",{type:"button",className:"btn",onClick:P,title:"Generate a nice slug",children:"Generate"})]}),u&&_.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",marginTop:8},children:[_.jsx("span",{className:"helper",children:"Public link:"}),_.jsx("a",{className:"helper",href:`/#/p/${encodeURIComponent(u)}`,target:"_blank",rel:"noreferrer",children:C})]})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Title"}),_.jsx("input",{className:"input",value:h,onChange:S=>f(S.target.value),placeholder:"Public page title"})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"About"}),_.jsx("textarea",{className:"textarea",rows:3,value:m,onChange:S=>v(S.target.value),placeholder:"Short description"})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Features (one per line)"}),_.jsx("textarea",{className:"textarea",rows:3,value:y,onChange:S=>I(S.target.value),placeholder:`Donations tracker
Volunteers
Events`})]}),_.jsxs("label",{className:"grid",style:{gap:6},children:[_.jsx("span",{className:"helper",children:"Links (Text | URL per line)"}),_.jsx("textarea",{className:"textarea",rows:3,value:g,onChange:S=>p(S.target.value),placeholder:`Website | https://example.org
Twitter | https://x.com/yourorg`})]}),_.jsxs("div",{className:"row",style:{gap:8,alignItems:"center"},children:[_.jsx("button",{className:"btn-red",type:"submit",children:"Save"}),b&&_.jsx("span",{className:b.includes("Saved")?"success":"error",children:b})]})]}),o&&_.jsxs("div",{style:{marginTop:16},children:[_.jsx("h3",{style:{margin:"8px 0"},children:"Preview"}),_.jsx(cd,{data:{public:{title:(h||e||"Public page").trim(),about:(m||"").trim(),features:(y||"").split(`
`).map(S=>S.trim()).filter(Boolean),links:(g||"").split(`
`).map(S=>{const[x,K]=S.split("|").map(z=>(z||"").trim());return K?{text:x||K,url:K}:null}).filter(Boolean)}}})]})]})]})}function jg(r,e,t,n,i,a,s){try{var o=r[a](s),l=o.value}catch(u){return void t(u)}o.done?e(l):Promise.resolve(l).then(n,i)}function w(r){return function(){var e=this,t=arguments;return new Promise(function(n,i){var a=r.apply(e,t);function s(l){jg(a,n,i,s,o,"next",l)}function o(l){jg(a,n,i,s,o,"throw",l)}s(void 0)})}}function Xo(r){"@babel/helpers - typeof";return Xo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Xo(r)}function JC(r,e){if(Xo(r)!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Xo(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function YC(r){var e=JC(r,"string");return Xo(e)=="symbol"?e:e+""}function c(r,e,t){return(e=YC(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}const QC="l",XC="rn",ZC={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:QC,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:XC,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var fb=ZC;function eO(r){return r.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var tO=RegExp(Object.keys(fb).map(eO).join("|"),"g");function rO(r){return fb[r]}function nO(r){return r.replace(tO,rO)}var iO=nO;const aO=Ad(iO);var Xd={exports:{}},vb={};function jr(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var sO=jr;jr.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};jr.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};jr.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};jr.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};jr.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};jr.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};jr.prototype.start=jr.prototype.try;jr.prototype.errors=function(){return this._errors};jr.prototype.attempts=function(){return this._attempts};jr.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],a=i.message,s=(r[a]||0)+1;r[a]=s,s>=t&&(e=i,t=s)}return e};(function(r){var e=sO;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<n.retries;s++)a.push(this.createTimeout(s,n));return t&&t.forever&&!a.length&&a.push(this.createTimeout(s,n)),a.sort(function(o,l){return o-l}),a},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,a=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return a=Math.min(a,n.maxTimeout),a},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var a in t)typeof t[a]=="function"&&i.push(a)}for(var s=0;s<i.length;s++){var o=i[s],l=t[o];t[o]=(function(d){var h=r.operation(n),f=Array.prototype.slice.call(arguments,1),m=f.pop();f.push(function(v){h.retry(v)||(v&&(arguments[0]=h.mainError()),m.apply(this,arguments))}),h.attempt(function(){d.apply(t,f)})}).bind(t,l),t[o].options=n}}})(vb);var oO=vb;const lO=oO,uO=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class pb extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const dO=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},cO=r=>uO.includes(r),mb=(r,e)=>new Promise((t,n)=>{e={onFailedAttempt:()=>{},retries:10,...e};const i=lO.operation(e);i.attempt(async a=>{try{t(await r(a))}catch(s){if(!(s instanceof Error)){n(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));return}if(s instanceof pb)i.stop(),n(s.originalError);else if(s instanceof TypeError&&!cO(s.message))i.stop(),n(s);else{dO(s,a,e);try{await e.onFailedAttempt(s)}catch(o){n(o);return}i.retry(s)||n(i.mainError())}}})});Xd.exports=mb;Xd.exports.default=mb;var hO=Xd.exports.AbortError=pb,fO=Xd.exports;const gb=Ad(fO);let yl=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Zd extends yl{constructor(){super(...arguments),c(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}let Et=class extends yl{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}};var ms=function(r){return r.Self="m.self",r.Pin="m.pin",r}({}),Sl=new Et("m.asset","org.matrix.msc3488.asset"),Mi=new Et("m.ts","org.matrix.msc3488.ts"),El=new Et("m.location","org.matrix.msc3488.location"),Xt=function(r){return r.Read="m.read",r.FullyRead="m.fully_read",r.ReadPrivate="m.read.private",r}({}),_l="main";function Fg(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Bg(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Fg(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Fg(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var Xc=new Map;function Zc(r){return r instanceof String&&(r=r.toString()),Xc.has(r)||Xc.set(r,r),Xc.get(r)}function If(r,e){var t=e??new URLSearchParams,n=function(o){a!=null&&(Array.isArray(a)?a.forEach(l=>{t.append(o,String(l))}):t.append(o,String(a)))};for(var[i,a]of Object.entries(r))n(i);return t}function $g(r,e,t){var n=Bg(Bg({},t),{},{[e]:t[r]});return delete n[r],n}function ie(r,e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n!=null&&(r=r.replace(t,encodeURIComponent(n)))}return r}function hd(r,e,t){var n;if(t){for(n=r.length-1;n>=0;n--)if(e(r[n],n,r))return r.splice(n,1),!0}else for(n=0;n<r.length;n++)if(e(r[n],n,r))return r.splice(n,1),!0;return!1}function yb(r,e){for(var t of e)if(!r.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function bl(r){return JSON.parse(JSON.stringify(r))}function gs(r,e){if(r===e)return!0;if(typeof r!=typeof e)return!1;if(typeof r=="number"&&isNaN(r)&&isNaN(e))return!0;if(r===null||e===null)return r===e;if(!(r instanceof Object)||r.constructor!==e.constructor||r.prototype!==e.prototype)return!1;if(r instanceof RegExp||r instanceof Date)return r.toString()===e.toString();if(Array.isArray(r)){if(r.length!==e.length)return!1;for(var t=0;t<r.length;t++)if(!gs(r[t],e[t]))return!1}else{for(var n in e)if(e.hasOwnProperty(n)!==r.hasOwnProperty(n))return!1;for(var i in r)if(e.hasOwnProperty(i)!==r.hasOwnProperty(i)||!gs(r[i],e[i]))return!1}return!0}function Cf(r){if(typeof r!="object"||r==null||Array.isArray(r))return r;var e=[];for(var[t,n]of Object.entries(r))e.push([t,Cf(n)]);return e.sort((i,a)=>Tu(i[0],a[0])),e}function Wg(r){return typeof r=="number"&&isFinite(r)}function ta(r){return typeof r=="string"?aO(r.normalize("NFD").replace(pO,"")):""}function Of(r){return typeof r=="string"?r.replace(/[\u202d-\u202e]/g,""):""}function vO(r){return ta(r.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var pO=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function Sb(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Eb(r){return Sb(r).replace(/\\\*/g,".*").replace(/\?/g,".")}function eh(r){return r!=null&&r.endsWith("/")?r.slice(0,-1):r}function wl(r,e){return new Promise(t=>{setTimeout(t,r,e)})}function JN(r,e,t){return kf.apply(this,arguments)}function kf(){return kf=w(function*(r,e,t){var n=Date.now();try{return yield t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}),kf.apply(this,arguments)}function mO(r,e,t){var n=Date.now();try{return t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}function _b(r){return r==null}function Ka(r,e){return Pf.apply(this,arguments)}function Pf(){return Pf=w(function*(r,e){for(var t of r)yield e(yield t)}),Pf.apply(this,arguments)}function _a(r){return Promise.resolve(r())}function gO(r){return gb(e=>r(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Ii=(()=>{for(var r="",e=32;e<=126;e++)r+=String.fromCharCode(e);return r})();function Kg(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ii;return r.padEnd(e,t[0])}function Zo(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ii,t=BigInt(e.length);if(r<=t){var n;return(n=e[Number(r)-1])!==null&&n!==void 0?n:""}var i=r/t,a=Number(r%t)-1;return a<0&&(i-=BigInt(Math.abs(a)),a=Number(t)-1),Zo(i,e)+e[a]}function fd(r){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ii,t=BigInt(e.length),n=BigInt(0),i=r.length-1,a=BigInt(0);i>=0;i--,a++){var s=r.charCodeAt(i)-e.charCodeAt(0);n+=BigInt(1+s)*t**a}return n}function yO(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ii,n=Math.max(r.length,e.length),i=fd(Kg(r,n,t),t),a=fd(Kg(e,n,t),t),s=(i+a)/BigInt(2);return s===i||s==a?Zo(s,t)+t[0]:Zo(s,t)}function qs(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ii;return Zo(fd(r,e)+BigInt(1),e)}function Vg(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ii;return Zo(fd(r,e)-BigInt(1),e)}function Tu(r,e){return r<e?-1:r>e?1:0}function bb(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[n,i]of Object.entries(e)){if(r[n]instanceof Object&&i){bb(r[n],i);continue}if(i!=null||!t){vd(r,n,i);continue}}return r}function Gg(r){var e;return(e=Mi.findIn(r.getContent()))!==null&&e!==void 0?e:-1}function SO(r,e){return Gg(e)-Gg(r)}function Lp(r){return[Xt.Read,Xt.ReadPrivate].includes(r)}function qg(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,o)=>s===o;if(r.size!==e.size)return!1;for(var[n,i]of r){var a=e.get(n);if(a===void 0||!t(i,a))return!1}return!0}function wb(r){return r instanceof Map?Qi(r):Array.isArray(r)?r.map(e=>wb(e)):r}function Qi(r){var e=new Map;for(var[t,n]of r)e.set(t,wb(n));return Object.fromEntries(e.entries())}function wo(r){return r==="__proto__"||r==="prototype"||r==="constructor"}function vd(r,e,t){if(wo(e))throw new Error("Trying to modify prototype or constructor");r[e]=t}function Hr(r){return!(wo(r.room_id)||wo(r.sender)||wo(r.event_id))}class Nn extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var Mf="migrationState",ys=function(r){return r[r.NOT_STARTED=0]="NOT_STARTED",r[r.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",r[r.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",r[r.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",r[r.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",r[r.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",r}({}),Ss=50;function Hg(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function zg(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hg(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Hg(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function eu(r,e){return encodeURIComponent(r)+"/"+encodeURIComponent(e)}function EO(r){var e=r.split("/"),t=decodeURIComponent(e[0]),n=decodeURIComponent(e[1]);return{senderKey:t,sessionId:n}}class ec{constructor(){c(this,"migrationState",ys.NOT_STARTED),c(this,"account",null),c(this,"crossSigningKeys",null),c(this,"privateKeys",{}),c(this,"sessions",{}),c(this,"inboundGroupSessions",{}),c(this,"inboundGroupSessionsWithheld",{}),c(this,"rooms",{}),c(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return w(function*(){return e.account!==null})()}startup(){var e=this;return w(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return w(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return w(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){var i=this.privateKeys[n];t(i||null)}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){var n=0;for(var i of Object.values(this.sessions))n+=Object.keys(i).length;t(n)}getEndToEndSession(e,t,n,i){var a=this.sessions[e]||{};i(a[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}storeEndToEndSession(e,t,n,i){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),vd(a,t,n)}getEndToEndSessionsBatch(){var e=this;return w(function*(){var t=[];for(var n of Object.values(e.sessions))for(var i of Object.values(n))if(t.push(i),t.length>=Ss)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return w(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t.sessions[n]||{};delete a[i],Object.keys(a).length===0&&delete t.sessions[n]}})()}getEndToEndInboundGroupSession(e,t,n,i){var a=eu(e,t);i(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,n,i){var a=eu(e,t);this.inboundGroupSessions[a]=n}countEndToEndInboundGroupSessions(){var e=this;return w(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return w(function*(){var t=[];for(var[n,i]of Object.entries(e.inboundGroupSessions))if(t.push(zg(zg({},EO(n)),{},{sessionData:i,needsBackup:n in e.sessionsNeedingBackup})),t.length>=Ss)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return w(function*(){for(var{senderKey:n,sessionId:i}of e){var a=eu(n,i);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var n=eu(t.senderKey,t.sessionId);this.sessionsNeedingBackup[n]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}}var _O=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function bO(r){var e=_O.exec(r);return(e==null?void 0:e[0])===r}var wO=/^[\w-]+$/;function TO(r){var e=wO.exec(r);return(e==null?void 0:e[0])===r}function tc(r,e,t,n,i){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,s=arguments.length>6?arguments[6]:void 0,o=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[l,u,...d]=e.slice(6).split("/");if(d.length>0||!bO(l)||!TO(u))return"";o&&(s=!0);var h,f=!!t||!!n||!!i,m=f?"thumbnail":"download";o?h="/_matrix/client/v1/media/".concat(m):h="/_matrix/media/v3/".concat(m);var v=new URL("".concat(h,"/").concat(l,"/").concat(u),r);return t&&v.searchParams.set("width",Math.round(t).toString()),n&&v.searchParams.set("height",Math.round(n).toString()),i&&v.searchParams.set("method",i),typeof s=="boolean"&&v.searchParams.set("allow_redirect",JSON.stringify(s)),v.href}var Tb={exports:{}};(function(r){(function(e,t){r.exports?r.exports=t():e.log=t()})(Pw,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],a={},s=null;function o(y,I){var g=y[I];if(typeof g.bind=="function")return g.bind(y);try{return Function.prototype.bind.call(g,y)}catch{return function(){return Function.prototype.apply.apply(g,[y,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(y){return y==="debug"&&(y="log"),typeof console===t?!1:y==="trace"&&n?l:console[y]!==void 0?o(console,y):console.log!==void 0?o(console,"log"):e}function d(){for(var y=this.getLevel(),I=0;I<i.length;I++){var g=i[I];this[g]=I<y?e:this.methodFactory(g,y,this.name)}if(this.log=this.debug,typeof console===t&&y<this.levels.SILENT)return"No console available for logging"}function h(y){return function(){typeof console!==t&&(d.call(this),this[y].apply(this,arguments))}}function f(y,I,g){return u(y)||h.apply(this,arguments)}function m(y,I){var g=this,p,b,R,P="loglevel";typeof y=="string"?P+=":"+y:typeof y=="symbol"&&(P=void 0);function E(z){var oe=(i[z]||"silent").toUpperCase();if(!(typeof window===t||!P)){try{window.localStorage[P]=oe;return}catch{}try{window.document.cookie=encodeURIComponent(P)+"="+oe+";"}catch{}}}function C(){var z;if(!(typeof window===t||!P)){try{z=window.localStorage[P]}catch{}if(typeof z===t)try{var oe=window.document.cookie,ge=encodeURIComponent(P),xe=oe.indexOf(ge+"=");xe!==-1&&(z=/^([^;]+)/.exec(oe.slice(xe+ge.length+1))[1])}catch{}return g.levels[z]===void 0&&(z=void 0),z}}function S(){if(!(typeof window===t||!P)){try{window.localStorage.removeItem(P)}catch{}try{window.document.cookie=encodeURIComponent(P)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function x(z){var oe=z;if(typeof oe=="string"&&g.levels[oe.toUpperCase()]!==void 0&&(oe=g.levels[oe.toUpperCase()]),typeof oe=="number"&&oe>=0&&oe<=g.levels.SILENT)return oe;throw new TypeError("log.setLevel() called with invalid level: "+z)}g.name=y,g.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},g.methodFactory=I||f,g.getLevel=function(){return R??b??p},g.setLevel=function(z,oe){return R=x(z),oe!==!1&&E(R),d.call(g)},g.setDefaultLevel=function(z){b=x(z),C()||g.setLevel(z,!1)},g.resetLevel=function(){R=null,S(),d.call(g)},g.enableAll=function(z){g.setLevel(g.levels.TRACE,z)},g.disableAll=function(z){g.setLevel(g.levels.SILENT,z)},g.rebuild=function(){if(s!==g&&(p=x(s.getLevel())),d.call(g),s===g)for(var z in a)a[z].rebuild()},p=x(s?s.getLevel():"WARN");var K=C();K!=null&&(R=x(K)),d.call(g)}s=new m,s.getLogger=function(I){if(typeof I!="symbol"&&typeof I!="string"||I==="")throw new TypeError("You must supply a name when creating a logger.");var g=a[I];return g||(g=a[I]=new m(I,s.methodFactory)),g};var v=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=v),s},s.getLoggers=function(){return a},s.default=s,s})})(Tb);var RO=Tb.exports;const Af=Ad(RO);var IO="matrix";Af.methodFactory=function(r,e,t){return function(){for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];this.prefix&&i.unshift(this.prefix);var s=r==="error"||r==="warn"||r==="trace"||r==="info"||r==="debug";return s?console[r](...i):console.log(...i)}};function Rb(r){var e=IO+(r===void 0?"":"-".concat(r)),t=Af.getLogger(e);return t.getChild===void 0&&(t.prefix=r,t.getChild=n=>{var i=Rb((r??"")+n);return i.methodFactory=t.methodFactory,i.rebuild(),i},t.setLevel(Af.levels.DEBUG,!1)),t}var T=Rb();class YN{constructor(e,t){this.parent=e,c(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.error(this.name,...t)}}class Up{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new Up(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];if(i.length===0)t="";else if(i[0]instanceof Error){var s=i.shift();t=s.stack||s.message}else typeof i[0]=="string"?t=i.shift():t="%O";this.debugInstance(e+" "+t,...i)}}var jp={exports:{}},Xa=typeof Reflect=="object"?Reflect:null,Jg=Xa&&typeof Xa.apply=="function"?Xa.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Ru;Xa&&typeof Xa.ownKeys=="function"?Ru=Xa.ownKeys:Object.getOwnPropertySymbols?Ru=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ru=function(e){return Object.getOwnPropertyNames(e)};function CO(r){console&&console.warn&&console.warn(r)}var Ib=Number.isNaN||function(e){return e!==e};function Je(){Je.init.call(this)}jp.exports=Je;jp.exports.once=MO;Je.EventEmitter=Je;Je.prototype._events=void 0;Je.prototype._eventsCount=0;Je.prototype._maxListeners=void 0;var Yg=10;function rc(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(Je,"defaultMaxListeners",{enumerable:!0,get:function(){return Yg},set:function(r){if(typeof r!="number"||r<0||Ib(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Yg=r}});Je.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Je.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Ib(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Cb(r){return r._maxListeners===void 0?Je.defaultMaxListeners:r._maxListeners}Je.prototype.getMaxListeners=function(){return Cb(this)};Je.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",a=this._events;if(a!==void 0)i=i&&a.error===void 0;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var o=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw o.context=s,o}var l=a[e];if(l===void 0)return!1;if(typeof l=="function")Jg(l,this,t);else for(var u=l.length,d=Ab(l,u),n=0;n<u;++n)Jg(d[n],this,t);return!0};function Ob(r,e,t,n){var i,a,s;if(rc(t),a=r._events,a===void 0?(a=r._events=Object.create(null),r._eventsCount=0):(a.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),a=r._events),s=a[e]),s===void 0)s=a[e]=t,++r._eventsCount;else if(typeof s=="function"?s=a[e]=n?[t,s]:[s,t]:n?s.unshift(t):s.push(t),i=Cb(r),i>0&&s.length>i&&!s.warned){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=s.length,CO(o)}return r}Je.prototype.addListener=function(e,t){return Ob(this,e,t,!1)};Je.prototype.on=Je.prototype.addListener;Je.prototype.prependListener=function(e,t){return Ob(this,e,t,!0)};function OO(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function kb(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=OO.bind(n);return i.listener=t,n.wrapFn=i,i}Je.prototype.once=function(e,t){return rc(t),this.on(e,kb(this,e,t)),this};Je.prototype.prependOnceListener=function(e,t){return rc(t),this.prependListener(e,kb(this,e,t)),this};Je.prototype.removeListener=function(e,t){var n,i,a,s,o;if(rc(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(a=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,a=s;break}if(a<0)return this;a===0?n.shift():kO(n,a),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};Je.prototype.off=Je.prototype.removeListener;Je.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var a=Object.keys(n),s;for(i=0;i<a.length;++i)s=a[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Pb(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?PO(i):Ab(i,i.length)}Je.prototype.listeners=function(e){return Pb(this,e,!0)};Je.prototype.rawListeners=function(e){return Pb(this,e,!1)};Je.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):Mb.call(r,e)};Je.prototype.listenerCount=Mb;function Mb(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}Je.prototype.eventNames=function(){return this._eventsCount>0?Ru(this._events):[]};function Ab(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function kO(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function PO(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function MO(r,e){return new Promise(function(t,n){function i(s){r.removeListener(e,a),n(s)}function a(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}Db(r,e,a,{once:!0}),e!=="error"&&AO(r,i,{once:!0})})}function AO(r,e,t){typeof r.on=="function"&&Db(r,"error",e,t)}function Db(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(a){n.once&&r.removeEventListener(e,i),t(a)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var nc=jp.exports,xb=function(r){return r.NewListener="newListener",r.RemoveListener="removeListener",r.Error="error",r}({});class nt extends nc.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}emitPromised(e){var t=arguments,n=this;return w(function*(){for(var i=t.length,a=new Array(i>1?i-1:0),s=1;s<i;s++)a[s-1]=t[s];var o=n.listeners(e);return Promise.allSettled(o.map(l=>l(...a))).then(()=>o.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var j=function(r){return r.RoomCanonicalAlias="m.room.canonical_alias",r.RoomCreate="m.room.create",r.RoomJoinRules="m.room.join_rules",r.RoomMember="m.room.member",r.RoomThirdPartyInvite="m.room.third_party_invite",r.RoomPowerLevels="m.room.power_levels",r.RoomName="m.room.name",r.RoomTopic="m.room.topic",r.RoomAvatar="m.room.avatar",r.RoomPinnedEvents="m.room.pinned_events",r.RoomEncryption="m.room.encryption",r.RoomHistoryVisibility="m.room.history_visibility",r.RoomGuestAccess="m.room.guest_access",r.RoomServerAcl="m.room.server_acl",r.RoomTombstone="m.room.tombstone",r.RoomPredecessor="org.matrix.msc3946.room_predecessor",r.PolicyRuleUser="m.policy.rule.user",r.PolicyRuleRoom="m.policy.rule.room",r.PolicyRuleServer="m.policy.rule.server",r.SpaceChild="m.space.child",r.SpaceParent="m.space.parent",r.RoomRedaction="m.room.redaction",r.RoomMessage="m.room.message",r.RoomMessageEncrypted="m.room.encrypted",r.Sticker="m.sticker",r.CallInvite="m.call.invite",r.CallCandidates="m.call.candidates",r.CallAnswer="m.call.answer",r.CallHangup="m.call.hangup",r.CallReject="m.call.reject",r.CallSelectAnswer="m.call.select_answer",r.CallNegotiate="m.call.negotiate",r.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",r.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",r.CallReplaces="m.call.replaces",r.CallAssertedIdentity="m.call.asserted_identity",r.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",r.CallEncryptionKeysPrefix="io.element.call.encryption_keys",r.KeyVerificationRequest="m.key.verification.request",r.KeyVerificationStart="m.key.verification.start",r.KeyVerificationCancel="m.key.verification.cancel",r.KeyVerificationMac="m.key.verification.mac",r.KeyVerificationDone="m.key.verification.done",r.KeyVerificationKey="m.key.verification.key",r.KeyVerificationAccept="m.key.verification.accept",r.KeyVerificationReady="m.key.verification.ready",r.RoomMessageFeedback="m.room.message.feedback",r.Reaction="m.reaction",r.PollStart="org.matrix.msc3381.poll.start",r.Typing="m.typing",r.Receipt="m.receipt",r.Presence="m.presence",r.FullyRead="m.fully_read",r.Tag="m.tag",r.SpaceOrder="org.matrix.msc3230.space_order",r.PushRules="m.push_rules",r.Direct="m.direct",r.IgnoredUserList="m.ignored_user_list",r.RoomKey="m.room_key",r.RoomKeyRequest="m.room_key_request",r.ForwardedRoomKey="m.forwarded_room_key",r.Dummy="m.dummy",r.SecretRequest="m.secret.request",r.SecretSend="m.secret.send",r.GroupCallPrefix="org.matrix.msc3401.call",r.GroupCallMemberPrefix="org.matrix.msc3401.call.member",r.CallNotify="org.matrix.msc4075.call.notify",r.RTCNotification="org.matrix.msc4075.rtc.notification",r}({}),it=function(r){return r.Annotation="m.annotation",r.Replace="m.replace",r.Reference="m.reference",r.Thread="m.thread",r.unstable_RTCNotificationParent="org.matrix.msc4075.rtc.notification.parent",r}({}),Sn=function(r){return r.Text="m.text",r.Emote="m.emote",r.Notice="m.notice",r.Image="m.image",r.File="m.file",r.Audio="m.audio",r.Location="m.location",r.Video="m.video",r.KeyVerificationRequest="m.key.verification.request",r}({}),pd="type",Za=function(r){return r.Space="m.space",r.UnstableCall="org.matrix.msc3417.call",r.ElementVideo="io.element.video",r}({}),ic="org.matrix.msgid",Df=new Et("m.room.purpose","org.matrix.msc3088.purpose"),xf=new Et("m.enabled","org.matrix.msc3088.enabled"),Nf=new Et("m.data_tree","org.matrix.msc3089.data_tree"),Nb=new Et("m.leaf","org.matrix.msc3089.leaf"),Cn=new Et("m.branch","org.matrix.msc3089.branch"),Lb=new Et("m.room.marker","org.matrix.msc2716.marker"),Lf=new Et("with_rel_types","org.matrix.msc3912.with_relations"),Ub=new Et("io.element.functional_members","io.element.functional_members"),Xi=new Et("m.visibility","org.matrix.msc3531.visibility"),Uf=new Et("enabled","org.matrix.msc3881.enabled"),DO=new Et("device_id","org.matrix.msc3881.device_id"),jb=new Et("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),md=new Et("thread_id","org.matrix.msc4023.thread_id"),Fb=new yl("membership","io.element.msc4115.membership"),Ie=function(r){return r.Ban="ban",r.Invite="invite",r.Join="join",r.Knock="knock",r.Leave="leave",r}({}),ur=function(r){return r.Membership="RoomMember.membership",r.Name="RoomMember.name",r.PowerLevel="RoomMember.powerLevel",r.Typing="RoomMember.typing",r}({});class el extends nt{constructor(e,t){super(),this.roomId=e,this.userId=t,c(this,"_isOutOfBand",!1),c(this,"modified",-1),c(this,"requestedProfileInfo",!1),c(this,"typing",!1),c(this,"name",void 0),c(this,"rawDisplayName",void 0),c(this,"powerLevel",0),c(this,"user",void 0),c(this,"membership",void 0),c(this,"disambiguate",!1),c(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,i,a=(n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:"";if(e.getType()===j.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&T.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=LO(this.userId,a,t);var o=this.name;this.name=UO(this.userId,a,this.disambiguate),this.rawDisplayName=Of((i=e.getDirectionalContent().displayname)!==null&&i!==void 0?i:""),(!this.rawDisplayName||!ta(this.rawDisplayName))&&(this.rawDisplayName=this.userId),s!==this.membership&&(this.updateModifiedTime(),this.emit(ur.Membership,e,this,s)),o!==this.name&&(this.updateModifiedTime(),this.emit(ur.Name,e,this,o))}}setPowerLevel(e,t){var n=this.powerLevel;this.powerLevel=e,n!==this.powerLevel&&(this.updateModifiedTime(),this.emit(ur.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;Array.isArray(n)&&(n.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(ur.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Ie.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),n=e.getSender();if(t.membership===Ie.Join&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),t.membership===Ie.Invite&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,l=this.getMxcAvatarUrl();if(!l&&!a)return null;var u=tc(e,l,t,n,i,s,void 0,o);return u||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var xO=/@.+:.+/,NO=/[\u200E\u200F\u202A-\u202F]/;function LO(r,e,t){if(!e||e===r||!t)return!1;var n=ta(e);if(!n)return!1;if(xO.test(n)||NO.test(e))return!0;var i=t.getUserIdsWithDisplayName(e);return!!i.some(a=>a!==r)}function UO(r,e,t){return!e||e===r?r:t?Of(e)+" ("+r+")":ta(e)?Of(e):r}var nr={},ac={},Tl={};Object.defineProperty(Tl,"__esModule",{value:!0});Tl.NamespacedMap=void 0;function jO(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=FO(r))||e){t&&(r=t);var n=0,i=function(){};return{s:i,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(u){throw u},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,o;return{s:function(){t=t.call(r)},n:function(){var u=t.next();return a=u.done,u},e:function(u){s=!0,o=u},f:function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw o}}}}function FO(r,e){if(r){if(typeof r=="string")return Qg(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Qg(r,e)}}function Qg(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function BO(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function $O(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function WO(r,e,t){return e&&$O(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function KO(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var VO=function(){function r(e){if(BO(this,r),KO(this,"internalMap",new Map),e){var t=jO(e),n;try{for(t.s();!(n=t.n()).done;){var i=n.value;this.set(i[0],i[1])}}catch(a){t.e(a)}finally{t.f()}}}return WO(r,[{key:"get",value:function(t){return t.name&&this.internalMap.has(t.name)?this.internalMap.get(t.name):t.altName&&this.internalMap.has(t.altName)?this.internalMap.get(t.altName):null}},{key:"set",value:function(t,n){t.name&&this.internalMap.set(t.name,n),t.altName&&this.internalMap.set(t.altName,n)}},{key:"has",value:function(t){return!!this.get(t)}},{key:"delete",value:function(t){t.name&&this.internalMap.delete(t.name),t.altName&&this.internalMap.delete(t.altName)}},{key:"hasNamespaced",value:function(t){return this.internalMap.has(t)}},{key:"getNamespaced",value:function(t){return this.internalMap.get(t)}}]),r}();Tl.NamespacedMap=VO;var Kn={};function jf(r){"@babel/helpers - typeof";return jf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jf(r)}Object.defineProperty(Kn,"__esModule",{value:!0});Kn.InvalidEventError=void 0;function GO(r,e,t){return Object.defineProperty(r,"prototype",{writable:!1}),r}function qO(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function HO(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&tl(r,e)}function zO(r){var e=Bb();return function(){var n=rl(r),i;if(e){var a=rl(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return JO(this,i)}}function JO(r,e){if(e&&(jf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return YO(r)}function YO(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Ff(r){var e=typeof Map=="function"?new Map:void 0;return Ff=function(n){if(n===null||!QO(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,i)}function i(){return Iu(n,arguments,rl(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),tl(i,n)},Ff(r)}function Iu(r,e,t){return Bb()?Iu=Reflect.construct:Iu=function(i,a,s){var o=[null];o.push.apply(o,a);var l=Function.bind.apply(i,o),u=new l;return s&&tl(u,s.prototype),u},Iu.apply(null,arguments)}function Bb(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function QO(r){return Function.toString.call(r).indexOf("[native code]")!==-1}function tl(r,e){return tl=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},tl(r,e)}function rl(r){return rl=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},rl(r)}var XO=function(r){HO(t,r);var e=zO(t);function t(n){return qO(this,t),e.call(this,n)}return GO(t)}(Ff(Error));Kn.InvalidEventError=XO;var ks={},En={},Ai={};Object.defineProperty(Ai,"__esModule",{value:!0});Ai.ExtensibleEvent=void 0;function ZO(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function ek(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function tk(r,e,t){return e&&ek(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}var rk=function(){function r(e){ZO(this,r),this.wireFormat=e}return tk(r,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),r}();Ai.ExtensibleEvent=rk;var Rl={};Object.defineProperty(Rl,"__esModule",{value:!0});Rl.isOptionalAString=nk;Rl.isProvided=$b;function nk(r){return $b(r)&&typeof r=="string"}function $b(r){return r!=null}var yt={},Zr={};function Bf(r){"@babel/helpers - typeof";return Bf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Bf(r)}Object.defineProperty(Zr,"__esModule",{value:!0});Zr.UnstableValue=Zr.NamespacedValue=void 0;function ik(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&$f(r,e)}function $f(r,e){return $f=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},$f(r,e)}function ak(r){var e=lk();return function(){var n=gd(r),i;if(e){var a=gd(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return sk(this,i)}}function sk(r,e){if(e&&(Bf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ok(r)}function ok(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function lk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function gd(r){return gd=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},gd(r)}function Wb(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function uk(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Kb(r,e,t){return e&&uk(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}var Vb=function(){function r(e,t){if(Wb(this,r),this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return Kb(r,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(t){return!!this.name&&this.name===t||!!this.altName&&this.altName===t}},{key:"findIn",value:function(t){var n;return this.name&&(n=t==null?void 0:t[this.name]),!n&&this.altName&&(n=t==null?void 0:t[this.altName]),n}},{key:"includedIn",value:function(t){var n=!1;return this.name&&(n=t.includes(this.name)),!n&&this.altName&&(n=t.includes(this.altName)),n}}]),r}();Zr.NamespacedValue=Vb;var dk=function(r){ik(t,r);var e=ak(t);function t(n,i){var a;if(Wb(this,t),a=e.call(this,n,i),!a.unstable)throw new Error("Unstable value must be supplied");return a}return Kb(t,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),t}(Vb);Zr.UnstableValue=dk;Object.defineProperty(yt,"__esModule",{value:!0});yt.M_TEXT=yt.M_NOTICE=yt.M_MESSAGE=yt.M_HTML=yt.M_EMOTE=void 0;var Il=Zr,ck=new Il.UnstableValue("m.message","org.matrix.msc1767.message");yt.M_MESSAGE=ck;var hk=new Il.UnstableValue("m.text","org.matrix.msc1767.text");yt.M_TEXT=hk;var fk=new Il.UnstableValue("m.html","org.matrix.msc1767.html");yt.M_HTML=fk;var vk=new Il.UnstableValue("m.emote","org.matrix.msc1767.emote");yt.M_EMOTE=vk;var pk=new Il.UnstableValue("m.notice","org.matrix.msc1767.notice");yt.M_NOTICE=pk;var Vn={};Object.defineProperty(Vn,"__esModule",{value:!0});Vn.isEventTypeSame=mk;function mk(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||t.matches(n.altName)}function Wf(r){"@babel/helpers - typeof";return Wf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wf(r)}Object.defineProperty(En,"__esModule",{value:!0});En.MessageEvent=void 0;var gk=Ai,Hs=Rl,th=Kn,fr=yt,yk=Vn;function Xg(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Zg(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Xg(Object(t),!0).forEach(function(n){Xn(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Xg(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function Sk(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function ey(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Ek(r,e,t){return e&&ey(r.prototype,e),t&&ey(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function _k(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Kf(r,e)}function Kf(r,e){return Kf=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},Kf(r,e)}function bk(r){var e=Tk();return function(){var n=yd(r),i;if(e){var a=yd(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return wk(this,i)}}function wk(r,e){if(e&&(Wf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Cu(r)}function Cu(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Tk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function yd(r){return yd=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},yd(r)}function Xn(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var Rk=function(r){_k(t,r);var e=bk(t);function t(n){var i;Sk(this,t),i=e.call(this,n),Xn(Cu(i),"text",void 0),Xn(Cu(i),"html",void 0),Xn(Cu(i),"renderings",void 0);var a=fr.M_MESSAGE.findIn(i.wireContent),s=fr.M_TEXT.findIn(i.wireContent),o=fr.M_HTML.findIn(i.wireContent);if((0,Hs.isProvided)(a)){if(!Array.isArray(a))throw new th.InvalidEventError("m.message contents must be an array");var l=a.find(function(d){return!(0,Hs.isProvided)(d.mimetype)||d.mimetype==="text/plain"}),u=a.find(function(d){return d.mimetype==="text/html"});if(!l)throw new th.InvalidEventError("m.message is missing a plain text representation");i.text=l.body,i.html=u==null?void 0:u.body,i.renderings=a}else if((0,Hs.isOptionalAString)(s))i.text=s,i.html=o,i.renderings=[{body:s,mimetype:"text/plain"}],i.html&&i.renderings.push({body:i.html,mimetype:"text/html"});else throw new th.InvalidEventError("Missing textual representation for event");return i}return Ek(t,[{key:"isEmote",get:function(){return fr.M_EMOTE.matches(this.wireFormat.type)||(0,Hs.isProvided)(fr.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return fr.M_NOTICE.matches(this.wireFormat.type)||(0,Hs.isProvided)(fr.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(i){return(0,yk.isEventTypeSame)(i,fr.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var i=Xn({},fr.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var a=this.renderings[0].mimetype;(a===void 0||a==="text/plain")&&(i=Xn({},fr.M_TEXT.name,this.renderings[0].body))}return i}},{key:"serialize",value:function(){var i;return{type:"m.room.message",content:Zg(Zg({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(i=this.html)!==null&&i!==void 0?i:void 0})}}}],[{key:"from",value:function(i,a){var s;return new t({type:fr.M_MESSAGE.name,content:(s={},Xn(s,fr.M_TEXT.name,i),Xn(s,fr.M_HTML.name,a),s)})}}]),t}(gk.ExtensibleEvent);En.MessageEvent=Rk;var Ps={};function Vf(r){"@babel/helpers - typeof";return Vf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Vf(r)}Object.defineProperty(Ps,"__esModule",{value:!0});Ps.NoticeEvent=void 0;var Ik=En,tu=yt,Ck=Vn;function ty(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Ok(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function ry(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function kk(r,e,t){return e&&ry(r.prototype,e),t&&ry(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function To(){return typeof Reflect<"u"&&Reflect.get?To=Reflect.get:To=function(e,t,n){var i=Pk(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},To.apply(this,arguments)}function Pk(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=ua(r),r!==null););return r}function Mk(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Gf(r,e)}function Gf(r,e){return Gf=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},Gf(r,e)}function Ak(r){var e=Nk();return function(){var n=ua(r),i;if(e){var a=ua(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Dk(this,i)}}function Dk(r,e){if(e&&(Vf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return xk(r)}function xk(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Nk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ua(r){return ua=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},ua(r)}var Lk=function(r){Mk(t,r);var e=Ak(t);function t(n){return Ok(this,t),e.call(this,n)}return kk(t,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(i){return(0,Ck.isEventTypeSame)(i,tu.M_NOTICE)||To(ua(t.prototype),"isEquivalentTo",this).call(this,i)}},{key:"serialize",value:function(){var i=To(ua(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.notice",i}}],[{key:"from",value:function(i,a){var s;return new t({type:tu.M_NOTICE.name,content:(s={},ty(s,tu.M_TEXT.name,i),ty(s,tu.M_HTML.name,a),s)})}}]),t}(Ik.MessageEvent);Ps.NoticeEvent=Lk;var Ms={};function qf(r){"@babel/helpers - typeof";return qf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qf(r)}Object.defineProperty(Ms,"__esModule",{value:!0});Ms.EmoteEvent=void 0;var Uk=En,ru=yt,jk=Vn;function ny(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Fk(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function iy(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Bk(r,e,t){return e&&iy(r.prototype,e),t&&iy(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function Ro(){return typeof Reflect<"u"&&Reflect.get?Ro=Reflect.get:Ro=function(e,t,n){var i=$k(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},Ro.apply(this,arguments)}function $k(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=da(r),r!==null););return r}function Wk(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Hf(r,e)}function Hf(r,e){return Hf=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},Hf(r,e)}function Kk(r){var e=qk();return function(){var n=da(r),i;if(e){var a=da(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Vk(this,i)}}function Vk(r,e){if(e&&(qf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Gk(r)}function Gk(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function qk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function da(r){return da=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},da(r)}var Hk=function(r){Wk(t,r);var e=Kk(t);function t(n){return Fk(this,t),e.call(this,n)}return Bk(t,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(i){return(0,jk.isEventTypeSame)(i,ru.M_EMOTE)||Ro(da(t.prototype),"isEquivalentTo",this).call(this,i)}},{key:"serialize",value:function(){var i=Ro(da(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.emote",i}}],[{key:"from",value:function(i,a){var s;return new t({type:ru.M_EMOTE.name,content:(s={},ny(s,ru.M_TEXT.name,i),ny(s,ru.M_HTML.name,a),s)})}}]),t}(Uk.MessageEvent);Ms.EmoteEvent=Hk;Object.defineProperty(ks,"__esModule",{value:!0});ks.LEGACY_M_ROOM_MESSAGE=void 0;ks.parseMRoomMessage=Xk;var ay=En,zk=Ps,Jk=Ms,Yk=Zr,zn=yt;function sy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Cr(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?sy(Object(t),!0).forEach(function(n){Wi(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):sy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function Wi(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var Qk=new Yk.NamespacedValue("m.room.message");ks.LEGACY_M_ROOM_MESSAGE=Qk;function Xk(r){var e,t,n;if(zn.M_MESSAGE.findIn(r.content)||zn.M_TEXT.findIn(r.content))return new ay.MessageEvent(r);var i=(e=r.content)===null||e===void 0?void 0:e.msgtype,a=(t=r.content)===null||t===void 0?void 0:t.body,s=((n=r.content)===null||n===void 0?void 0:n.format)==="org.matrix.custom.html"?r.content.formatted_body:null;if(i==="m.text"){var o;return new ay.MessageEvent(Cr(Cr({},r),{},{content:Cr(Cr({},r.content),{},(o={},Wi(o,zn.M_TEXT.name,a),Wi(o,zn.M_HTML.name,s),o))}))}else if(i==="m.notice"){var l;return new zk.NoticeEvent(Cr(Cr({},r),{},{content:Cr(Cr({},r.content),{},(l={},Wi(l,zn.M_TEXT.name,a),Wi(l,zn.M_HTML.name,s),l))}))}else if(i==="m.emote"){var u;return new Jk.EmoteEvent(Cr(Cr({},r),{},{content:Cr(Cr({},r.content),{},(u={},Wi(u,zn.M_TEXT.name,a),Wi(u,zn.M_HTML.name,s),u))}))}else return null}var sc={};Object.defineProperty(sc,"__esModule",{value:!0});sc.parseMMessage=rP;var Zk=En,oy=yt,eP=Ms,tP=Ps;function rP(r){return oy.M_EMOTE.matches(r.type)?new eP.EmoteEvent(r):oy.M_NOTICE.matches(r.type)?new tP.NoticeEvent(r):new Zk.MessageEvent(r)}var Ft={};Object.defineProperty(Ft,"__esModule",{value:!0});Ft.M_POLL_START=Ft.M_POLL_RESPONSE=Ft.M_POLL_KIND_UNDISCLOSED=Ft.M_POLL_KIND_DISCLOSED=Ft.M_POLL_END=void 0;var Cl=Zr,nP=new Cl.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");Ft.M_POLL_KIND_DISCLOSED=nP;var iP=new Cl.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");Ft.M_POLL_KIND_UNDISCLOSED=iP;var aP=new Cl.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");Ft.M_POLL_START=aP;var sP=new Cl.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");Ft.M_POLL_RESPONSE=sP;var oP=new Cl.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");Ft.M_POLL_END=oP;var oc={},ca={};function zf(r){"@babel/helpers - typeof";return zf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},zf(r)}Object.defineProperty(ca,"__esModule",{value:!0});ca.PollStartEvent=ca.PollAnswerSubevent=void 0;var _n=Ft,Gb=En,lo=yt,Ou=Kn,lP=Zr,uP=Vn,dP=Ai;function cP(r){return pP(r)||vP(r)||fP(r)||hP()}function hP(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function fP(r,e){if(r){if(typeof r=="string")return Jf(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Jf(r,e)}}function vP(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function pP(r){if(Array.isArray(r))return Jf(r)}function Jf(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function ly(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function mP(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ly(Object(t),!0).forEach(function(n){ar(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ly(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function qb(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function uy(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Hb(r,e,t){return e&&uy(r.prototype,e),t&&uy(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function zb(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Yf(r,e)}function Yf(r,e){return Yf=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},Yf(r,e)}function Jb(r){var e=yP();return function(){var n=Sd(r),i;if(e){var a=Sd(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return gP(this,i)}}function gP(r,e){if(e&&(zf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Hi(r)}function Hi(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function yP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Sd(r){return Sd=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Sd(r)}function ar(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var Yb=function(r){zb(t,r);var e=Jb(t);function t(n){var i;qb(this,t),i=e.call(this,n),ar(Hi(i),"id",void 0);var a=n.content.id;if(!a||typeof a!="string")throw new Ou.InvalidEventError("Answer ID must be a non-empty string");return i.id=a,i}return Hb(t,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:mP({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(i,a){return new t({type:"org.matrix.sdk.poll.answer",content:ar({id:i},lo.M_TEXT.name,a)})}}]),t}(Gb.MessageEvent);ca.PollAnswerSubevent=Yb;var SP=function(r){zb(t,r);var e=Jb(t);function t(n){var i;qb(this,t),i=e.call(this,n),ar(Hi(i),"question",void 0),ar(Hi(i),"kind",void 0),ar(Hi(i),"rawKind",void 0),ar(Hi(i),"maxSelections",void 0),ar(Hi(i),"answers",void 0);var a=_n.M_POLL_START.findIn(i.wireContent);if(!a.question)throw new Ou.InvalidEventError("A question is required");if(i.question=new Gb.MessageEvent({type:"org.matrix.sdk.poll.question",content:a.question}),i.rawKind=a.kind,_n.M_POLL_KIND_DISCLOSED.matches(i.rawKind)?i.kind=_n.M_POLL_KIND_DISCLOSED:i.kind=_n.M_POLL_KIND_UNDISCLOSED,i.maxSelections=Number.isFinite(a.max_selections)&&a.max_selections>0?a.max_selections:1,!Array.isArray(a.answers))throw new Ou.InvalidEventError("Poll answers must be an array");var s=a.answers.slice(0,20).map(function(o){return new Yb({type:"org.matrix.sdk.poll.answer",content:o})});if(s.length<=0)throw new Ou.InvalidEventError("No answers available");return i.answers=s,i}return Hb(t,[{key:"isEquivalentTo",value:function(i){return(0,uP.isEventTypeSame)(i,_n.M_POLL_START)}},{key:"serialize",value:function(){var i;return{type:_n.M_POLL_START.name,content:(i={},ar(i,_n.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(a){return a.serialize().content})}),ar(i,lo.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(a,s){return"".concat(s+1,". ").concat(a.text)}).join(`
`))),i)}}}],[{key:"from",value:function(i,a,s){var o,l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new t({type:_n.M_POLL_START.name,content:(o={},ar(o,lo.M_TEXT.name,i),ar(o,_n.M_POLL_START.name,{question:ar({},lo.M_TEXT.name,i),kind:s instanceof lP.NamespacedValue?s.name:s,max_selections:l,answers:a.map(function(u){return ar({id:EP()},lo.M_TEXT.name,u)})}),o)})}}]),t}(dP.ExtensibleEvent);ca.PollStartEvent=SP;var dy="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function EP(){return cP(Array(16)).map(function(){return dy.charAt(Math.floor(Math.random()*dy.length))}).join("")}var Ol={},As={};Object.defineProperty(As,"__esModule",{value:!0});As.REFERENCE_RELATION=void 0;var _P=Zr,bP=new _P.NamespacedValue("m.reference");As.REFERENCE_RELATION=bP;function Qf(r){"@babel/helpers - typeof";return Qf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Qf(r)}Object.defineProperty(Ol,"__esModule",{value:!0});Ol.PollResponseEvent=void 0;var wP=Ai,ba=Ft,TP=Kn,rh=As,RP=Vn;function IP(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function cy(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function CP(r,e,t){return e&&cy(r.prototype,e),t&&cy(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function OP(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Xf(r,e)}function Xf(r,e){return Xf=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},Xf(r,e)}function kP(r){var e=MP();return function(){var n=Ed(r),i;if(e){var a=Ed(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return PP(this,i)}}function PP(r,e){if(e&&(Qf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ku(r)}function ku(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function MP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ed(r){return Ed=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Ed(r)}function zs(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var AP=function(r){OP(t,r);var e=kP(t);function t(n){var i;IP(this,t),i=e.call(this,n),zs(ku(i),"internalAnswerIds",void 0),zs(ku(i),"internalSpoiled",void 0),zs(ku(i),"pollEventId",void 0);var a=i.wireContent["m.relates_to"];if(!rh.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new TP.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.validateAgainst(null),i}return CP(t,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(i){var a=ba.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(a==null?void 0:a.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var s=a.answers;if(s.some(function(o){return typeof o!="string"})||s.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(i){if(s.some(function(o){return!i.answers.some(function(l){return l.id===o})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}s=s.slice(0,i.maxSelections)}this.internalAnswerIds=s,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(i){return(0,RP.isEventTypeSame)(i,ba.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:ba.M_POLL_RESPONSE.name,content:zs({"m.relates_to":{rel_type:rh.REFERENCE_RELATION.name,event_id:this.pollEventId}},ba.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(i,a){return new t({type:ba.M_POLL_RESPONSE.name,content:zs({"m.relates_to":{rel_type:rh.REFERENCE_RELATION.name,event_id:a}},ba.M_POLL_RESPONSE.name,{answers:i})})}}]),t}(wP.ExtensibleEvent);Ol.PollResponseEvent=AP;var kl={};function Zf(r){"@babel/helpers - typeof";return Zf=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Zf(r)}Object.defineProperty(kl,"__esModule",{value:!0});kl.PollEndEvent=void 0;var Js=Ft,DP=Kn,nh=As,xP=En,NP=yt,LP=Vn,UP=Ai;function hy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function jP(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hy(Object(t),!0).forEach(function(n){Oa(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):hy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function FP(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function fy(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function BP(r,e,t){return e&&fy(r.prototype,e),t&&fy(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function $P(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&ev(r,e)}function ev(r,e){return ev=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},ev(r,e)}function WP(r){var e=VP();return function(){var n=_d(r),i;if(e){var a=_d(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return KP(this,i)}}function KP(r,e){if(e&&(Zf(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return tv(r)}function tv(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function VP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function _d(r){return _d=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},_d(r)}function Oa(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var GP=function(r){$P(t,r);var e=WP(t);function t(n){var i;FP(this,t),i=e.call(this,n),Oa(tv(i),"pollEventId",void 0),Oa(tv(i),"closingMessage",void 0);var a=i.wireContent["m.relates_to"];if(!nh.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new DP.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.closingMessage=new xP.MessageEvent(i.wireFormat),i}return BP(t,[{key:"isEquivalentTo",value:function(i){return(0,LP.isEventTypeSame)(i,Js.M_POLL_END)}},{key:"serialize",value:function(){return{type:Js.M_POLL_END.name,content:jP(Oa({"m.relates_to":{rel_type:nh.REFERENCE_RELATION.name,event_id:this.pollEventId}},Js.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(i,a){var s;return new t({type:Js.M_POLL_END.name,content:(s={"m.relates_to":{rel_type:nh.REFERENCE_RELATION.name,event_id:i}},Oa(s,Js.M_POLL_END.name,{}),Oa(s,NP.M_TEXT.name,a),s)})}}]),t}(UP.ExtensibleEvent);kl.PollEndEvent=GP;Object.defineProperty(oc,"__esModule",{value:!0});oc.parseMPoll=JP;var ih=Ft,qP=ca,HP=Ol,zP=kl;function JP(r){return ih.M_POLL_START.matches(r.type)?new qP.PollStartEvent(r):ih.M_POLL_RESPONSE.matches(r.type)?new HP.PollResponseEvent(r):ih.M_POLL_END.matches(r.type)?new zP.PollEndEvent(r):null}Object.defineProperty(ac,"__esModule",{value:!0});ac.ExtensibleEvents=void 0;var YP=Tl,QP=Kn,vy=ks,ah=sc,nu=yt,sh=Ft,oh=oc;function XP(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=ZP(r))||e){t&&(r=t);var n=0,i=function(){};return{s:i,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(u){throw u},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,o;return{s:function(){t=t.call(r)},n:function(){var u=t.next();return a=u.done,u},e:function(u){s=!0,o=u},f:function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw o}}}}function ZP(r,e){if(r){if(typeof r=="string")return py(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return py(r,e)}}function py(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function eM(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function my(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function tM(r,e,t){return e&&my(r.prototype,e),t&&my(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function rv(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var nv=function(){function r(){eM(this,r),rv(this,"interpreters",new YP.NamespacedMap([[vy.LEGACY_M_ROOM_MESSAGE,vy.parseMRoomMessage],[nu.M_MESSAGE,ah.parseMMessage],[nu.M_EMOTE,ah.parseMMessage],[nu.M_NOTICE,ah.parseMMessage],[sh.M_POLL_START,oh.parseMPoll],[sh.M_POLL_RESPONSE,oh.parseMPoll],[sh.M_POLL_END,oh.parseMPoll]])),rv(this,"_unknownInterpretOrder",[nu.M_MESSAGE])}return tM(r,[{key:"unknownInterpretOrder",get:function(){var t;return(t=this._unknownInterpretOrder)!==null&&t!==void 0?t:[]},set:function(t){this._unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,n){this.interpreters.set(t,n)}},{key:"parse",value:function(t){try{if(this.interpreters.hasNamespaced(t.type))return this.interpreters.getNamespaced(t.type)(t);var n=XP(this.unknownInterpretOrder),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;if(this.interpreters.has(a)){var s=this.interpreters.get(a)(t);if(s)return s}}}catch(o){n.e(o)}finally{n.f()}return null}catch(o){if(o instanceof QP.InvalidEventError)return null;throw o}}}],[{key:"defaultInstance",get:function(){return r._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return r.defaultInstance.unknownInterpretOrder},set:function(t){r.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,n){r.defaultInstance.registerInterpreter(t,n)}},{key:"parse",value:function(t){return r.defaultInstance.parse(t)}}]),r}();ac.ExtensibleEvents=nv;rv(nv,"_defaultInstance",new nv);var Qb={};Object.defineProperty(Qb,"__esModule",{value:!0});var Ds={};Object.defineProperty(Ds,"__esModule",{value:!0});Ds.LegacyMsgType=void 0;Ds.isEventLike=rM;var lh=yt,es;Ds.LegacyMsgType=es;(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(es||(Ds.LegacyMsgType=es={}));function rM(r,e){var t=r.content;return e===es.Text?lh.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.text":e===es.Emote?lh.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.emote":e===es.Notice?lh.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.notice":!1}(function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=ac;Object.keys(e).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===e[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return e[E]}})});var t=Qb;Object.keys(t).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===t[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return t[E]}})});var n=Kn;Object.keys(n).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===n[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return n[E]}})});var i=Zr;Object.keys(i).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===i[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return i[E]}})});var a=Tl;Object.keys(a).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===a[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return a[E]}})});var s=Rl;Object.keys(s).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===s[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return s[E]}})});var o=Ds;Object.keys(o).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===o[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return o[E]}})});var l=Vn;Object.keys(l).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===l[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return l[E]}})});var u=ks;Object.keys(u).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===u[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return u[E]}})});var d=sc;Object.keys(d).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===d[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return d[E]}})});var h=oc;Object.keys(h).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===h[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return h[E]}})});var f=As;Object.keys(f).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===f[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return f[E]}})});var m=Ai;Object.keys(m).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===m[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return m[E]}})});var v=yt;Object.keys(v).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===v[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return v[E]}})});var y=En;Object.keys(y).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===y[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return y[E]}})});var I=Ms;Object.keys(I).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===I[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return I[E]}})});var g=Ps;Object.keys(g).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===g[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return g[E]}})});var p=Ft;Object.keys(p).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===p[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return p[E]}})});var b=ca;Object.keys(b).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===b[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return b[E]}})});var R=Ol;Object.keys(R).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===R[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return R[E]}})});var P=kl;Object.keys(P).forEach(function(E){E==="default"||E==="__esModule"||E in r&&r[E]===P[E]||Object.defineProperty(r,E,{enumerable:!0,get:function(){return P[E]}})})})(nr);const nM="modulepreload",iM=function(r){return"/app/"+r},gy={},aM=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),o=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=Promise.allSettled(t.map(l=>{if(l=iM(l),l in gy)return;gy[l]=!0;const u=l.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":nM,u||(h.as="script"),h.crossOrigin="",h.href=l,o&&h.setAttribute("nonce",o),document.head.appendChild(h),u)return new Promise((f,m)=>{h.addEventListener("load",f),h.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(s){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s}return i.then(s=>{for(const o of s||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};function sM(r,e){if(r==null)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.indexOf(n)!==-1)continue;t[n]=r[n]}return t}function oM(r,e){if(r==null)return{};var t,n,i=sM(r,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);for(n=0;n<a.length;n++)t=a[n],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(r,t)&&(i[t]=r[t])}return i}var yr=function(r){return r.DisplayName="User.displayName",r.AvatarUrl="User.avatarUrl",r.Presence="User.presence",r.CurrentlyActive="User.currentlyActive",r.LastPresenceTs="User.lastPresenceTs",r}({});class Ln extends nt{constructor(e){super(),this.userId=e,c(this,"modified",-1),c(this,"displayName",void 0),c(this,"rawDisplayName",void 0),c(this,"avatarUrl",void 0),c(this,"presenceStatusMsg",void 0),c(this,"presence","offline"),c(this,"lastActiveAgo",0),c(this,"lastPresenceTs",0),c(this,"currentlyActive",!1),c(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var n=new Ln(e);return t.reEmitter.reEmit(n,[yr.AvatarUrl,yr.DisplayName,yr.Presence,yr.CurrentlyActive,yr.LastPresenceTs]),n}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push(yr.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(yr.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(yr.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&n.push(yr.CurrentlyActive),this.presence=e.getContent().presence,n.push(yr.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var i of n)this.emit(i,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var ke=function(r){return r.Backward="b",r.Forward="f",r}({});class se{static setEventMetadata(e,t,n){e.setMetadata(t,n)}constructor(e){var t,n;this.eventTimelineSet=e,c(this,"roomId",void 0),c(this,"name",void 0),c(this,"events",[]),c(this,"baseIndex",0),c(this,"startState",void 0),c(this,"endState",void 0),c(this,"startToken",null),c(this,"endToken",null),c(this,"prevTimeline",null),c(this,"nextTimeline",null),c(this,"paginationRequests",{[ke.Backward]:null,[ke.Forward]:null}),this.roomId=(t=(n=e.room)===null||n===void 0?void 0:n.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new ul(this.roomId),this.endState=new ul(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,n,{timelineWasEmpty:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:i}),(n=this.endState)===null||n===void 0||n.setStateEvents(e,{timelineWasEmpty:i})}forkLive(e){var t=this.getState(e),n=new se(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t,this.endState=t==null?void 0:t.clone(),n}fork(e){var t=this.getState(e),n=new se(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t==null?void 0:t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==se.BACKWARDS)return this.startState;if(e==se.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===ke.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===ke.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==se.BACKWARDS)return this.prevTimeline;if(e==se.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==se.BACKWARDS)this.prevTimeline=e;else if(t==se.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:n,roomState:i,timelineWasEmpty:a,addToState:s}=t;i||(i=n?this.startState:this.endState);var o=this.getTimelineSet();if(o.room&&(se.setEventMetadata(e,i,n),s&&e.isState()&&o.room.getUnfilteredTimelineSet()===o)){var l;(l=i)===null||l===void 0||l.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===j.RoomMember&&!n)&&se.setEventMetadata(e,i,n)}var u;n?u=0:u=this.events.length,this.events.splice(u,0,e),n&&this.baseIndex++}insertEvent(e,t,n,i){var a=this.getTimelineSet();a.room&&(se.setEventMetadata(e,n,!1),i&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(n.setStateEvents([e],{}),(!e.sender||e.getType()===j.RoomMember)&&se.setEventMetadata(e,n,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}}c(se,"BACKWARDS",ke.Backward);c(se,"FORWARDS",ke.Forward);var Pu=function(r){return r.Add="Relations.add",r.Remove="Relations.remove",r.Redaction="Relations.redaction",r}({}),lM=function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...n].includes(e)};class Fp extends nt{constructor(e,t,n,i){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=i,c(this,"relationEventIds",new Set),c(this,"relations",new Set),c(this,"annotationsByKey",{}),c(this,"annotationsBySender",{}),c(this,"sortedAnnotationsByKey",[]),c(this,"targetEvent",null),c(this,"creationEmitted",!1),c(this,"client",void 0),c(this,"onEventStatus",(s,o)=>{if(!s.isSending()){s.removeListener(Ve.Status,this.onEventStatus);return}o===Se.CANCELLED&&(s.removeListener(Ve.Status,this.onEventStatus),this.removeEvent(s))}),c(this,"onBeforeRedaction",function(){var s=w(function*(o){if(a.relations.has(o)){if(a.relations.delete(o),a.relationType===it.Annotation)a.removeAnnotationFromAggregation(o);else if(a.relationType===it.Replace&&a.targetEvent&&!a.targetEvent.isState()){var l=yield a.getLastReplacement();a.targetEvent.makeReplaced(l)}o.removeListener(Ve.BeforeRedaction,a.onBeforeRedaction),a.emit(Pu.Redaction,o)}});return function(o){return s.apply(this,arguments)}}()),this.client=n instanceof uc?n.client:n}addEvent(e){var t=this;return w(function*(){if(!t.relationEventIds.has(e.getId())){var n=e.getRelation();if(!n){T.error("Event must have relation info");return}var i=n.rel_type,a=e.getType();if(t.relationType!==i||!lM(a,t.eventType,t.altEventTypes)){T.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(Ve.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===it.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===it.Replace&&t.targetEvent&&!t.targetEvent.isState()){var s=yield t.getLastReplacement();t.targetEvent.makeReplaced(s)}e.on(Ve.BeforeRedaction,t.onBeforeRedaction),t.emit(Pu.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return w(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===it.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===it.Replace&&t.targetEvent&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();t.targetEvent.makeReplaced(n)}t.emit(Pu.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i||(i=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,i])),i.add(e),this.sortedAnnotationsByKey.sort((o,l)=>{var u=o[1],d=l[1];return d.size-u.size});var a=e.getSender(),s=this.annotationsBySender[a];s||(s=this.annotationsBySender[a]=new Set),s.add(e)}}removeAnnotationFromAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i&&(i.delete(e),this.sortedAnnotationsByKey.sort((o,l)=>{var u=o[1],d=l[1];return d.size-u.size}));var a=e.getSender(),s=this.annotationsBySender[a];s&&s.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==it.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==it.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return w(function*(){if(e.relationType!==it.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(it.Replace),n=t==null?void 0:t.origin_server_ts,i=e.getRelations().reduce((a,s)=>s.getSender()!==e.targetEvent.getSender()||n&&n>s.getTs()||a&&a.getTs()>s.getTs()?a:s,null);return i!=null&&i.shouldAttemptDecryption()&&e.client.getCrypto()?yield i.attemptDecryption(e.client.getCrypto()):i!=null&&i.isBeingDecrypted()&&(yield i.getDecryptionPromise()),i})()}setTargetEvent(e){var t=this;return w(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===it.Replace&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();n&&t.targetEvent.makeReplaced(n)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(Ve.RelationsCreated,this.relationType,this.eventType))}}class Xb{constructor(e,t){this.client=e,this.room=t,c(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var i;return(i=this.relations.get(e))===null||i===void 0||(i=i.get(t))===null||i===void 0?void 0:i.get(n)}getAllChildEventsForEvent(e){var t,n=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,i=[];for(var a of n.values())for(var s of a.values())i.push(...s.getRelations());return i}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var n of t.values())for(var i of n.values())i.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===Se.CANCELLED)){var n=e.getRelation();if(n){var i=()=>{if(e.isDecryptionFailure()){e.once(Ve.Decrypted,i);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(Ve.Decrypted,i);return}var{event_id:a,rel_type:s}=n,o=e.getType(),l=this.relations.get(a);l||(l=new Map,this.relations.set(a,l));var u=l.get(s);u||(u=new Map,l.set(s,u));var d=u.get(o);if(!d){var h,f,m;d=new Fp(s,o,this.client),u.set(o,d);var v=(h=this.room)!==null&&h!==void 0?h:t==null?void 0:t.room,y=(f=(m=t==null?void 0:t.findEventById(a))!==null&&m!==void 0?m:v==null?void 0:v.findEventById(a))!==null&&f!==void 0?f:v==null?void 0:v.getPendingEvent(a);y&&d.setTargetEvent(y)}d.addEvent(e)}}}}var ka;ka=T.log.bind(T);var Io=function(r){return r.Ignore="ignore",r.Replace="replace",r}({});class Va extends nt{constructor(e){var t,n,i,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=o,this.threadListType=l,c(this,"relations",void 0),c(this,"timelineSupport",void 0),c(this,"displayPendingEvents",void 0),c(this,"liveTimeline",void 0),c(this,"timelines",void 0),c(this,"_eventIdToTimeline",new Map),c(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new se(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(n=this.room)===null||n===void 0?void 0:n.relations)!==null&&t!==void 0?t:new Xb((i=e==null?void 0:e.client)!==null&&i!==void 0?i:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){var n=!this.timelineSupport||!t,i=this.liveTimeline,a=n?i.forkLive(se.FORWARDS):i.fork(se.FORWARDS);n?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&i.setPaginationToken(t,se.FORWARDS),a.setPaginationToken(e??null,se.BACKWARDS),this.liveTimeline=a,this.emit(le.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(n){return n.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new se(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i,a){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?se.BACKWARDS:se.FORWARDS,o=t?se.FORWARDS:se.BACKWARDS,l=!1,u=!1;for(var d of e){var h=d.getId(),f=this._eventIdToTimeline.get(h);if(!f){this.addEventToTimeline(d,i,{toStartOfTimeline:t,addToState:n}),u=!0,l=!0;continue}if(u=!1,f==i){ka("Event "+h+" already in timeline "+i);continue}var m=i.getNeighbouringTimeline(s);if(m){f==m?ka("Event "+h+" in neighbouring timeline - switching to "+f):ka("Event "+h+" already in a different timeline "+f),i=f;continue}T.info("Already have timeline for "+h+" - joining timeline "+i+" to "+f);var v=f===this.liveTimeline,y=i===this.liveTimeline,I=s===se.BACKWARDS&&v,g=s===se.FORWARDS&&y;if(I||g){I&&T.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+f+")"),g&&T.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(f,s),f.setNeighbouringTimeline(i,o),i=f,l=!0}if(u||!l){if(s===se.FORWARDS&&i===this.liveTimeline){T.warn({lastEventWasNew:u,didUpdate:l}),T.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(a));return}i.setPaginationToken(a??null,s)}}}addLiveEvent(e,t){var{duplicateStrategy:n,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:o}=t;if(this.filter){var l=this.filter.filterRoomTimeline([e]);if(!l.length)return}var u=this._eventIdToTimeline.get(e.getId());if(u){if(n===Io.Replace){ka("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var d=u.getEvents(),h=0;h<d.length;h++)if(d[h].getId()===e.getId()){a||(a=u.getState(se.FORWARDS)),se.setEventMetadata(e,a,!1),d[h]=e;break}}else ka("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:o})}addEventToTimeline(e,t,n){var{toStartOfTimeline:i,fromCache:a=!1,roomState:s,timelineWasEmpty:o,addToState:l}=n;if(t.getTimelineSet()!==this){var u;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((u=this.thread)===null||u===void 0?void 0:u.id,")"))}var d=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,f="event=".concat(d);e.threadRootId&&(f+="(belongs to thread=".concat(e.threadRootId,")")),T.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(f," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((h=this.thread)===null||h===void 0?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:i,roomState:s,timelineWasEmpty:o,addToState:l}),this._eventIdToTimeline.set(d,t);var m={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!a};this.emit(le.Timeline,e,this.room,!!i,!1,m)}insertEventIntoTimeline(e,t,n,i){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var o,l="event=".concat(s);e.threadRootId&&(l+="(belongs to thread=".concat(e.threadRootId,")")),T.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(l," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((o=this.thread)===null||o===void 0?void 0:o.id,")"));return}var u=e.relationEventId;if(!u){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:n,addToState:i});return}for(var d=this.findEventById(u),h=t.getEvents(),f=d!==void 0?h.indexOf(d):0,m=f;m<h.length;m++){var v=h[m];if(v.getTs()>e.getTs())break}t.insertEvent(e,m,n,i),this._eventIdToTimeline.set(s,t);var y={timeline:t,liveEvent:!1};this.emit(le.Timeline,e,this.room,!1,!1,y)}handleRemoteEcho(e,t,n){var i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,i)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);var i={timeline:t};this.emit(le.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;var n=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(n===void 0||i===void 0)return null;if(n===i){for(var a=void 0,s=void 0,o=n.getEvents(),l=0;l<o.length&&(a===void 0||s===void 0);l++){var u=o[l].getId();u==e&&(a=l),u==t&&(s=l)}var d=a-s;return d<0?-1:d>0?1:0}for(var h=n;h;){if(h===i)return-1;h=h.getNeighbouringTimeline(se.FORWARDS)}for(h=n;h;){if(h===i)return 1;h=h.getNeighbouringTimeline(se.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!n&&!i){var a;T.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return n}}var Se=function(r){return r.NOT_SENT="not_sent",r.ENCRYPTING="encrypting",r.SENDING="sending",r.QUEUED="queued",r.SENT="sent",r.CANCELLED="cancelled",r}({});class Zb{constructor(e,t){this.roomId=e}}class e0{constructor(e){this.target=e,c(this,"reEmitters",new WeakMap)}reEmit(e,t){var n=this,i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));var a=function(l){if(i.has(l))return 1;var u=function(){if(!(l==="error"&&n.target.listenerCount("error")===0)){for(var h=arguments.length,f=new Array(h),m=0;m<h;m++)f[m]=arguments[m];n.target.emit(l,...f,e)}};e.on(l,u),i.set(l,u)};for(var s of t)a(s)}stopReEmitting(e,t){var n=this.reEmitters.get(e);if(n){for(var i of t)e.off(i,n.get(i)),n.delete(i);n.size===0&&this.reEmitters.delete(e)}}}class xs extends e0{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var nl=new Zd("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function uM(r,e){if(e.endsWith("*")){var t=e.slice(0,-1);return r.slice(0,t.length)===t}else return r===e}class yy{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n,i=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(i),s=[];return this.userId&&i!==null&&i!==void 0&&(n=i[ze.name])!==null&&n!==void 0&&n.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,s)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[as.name]:this.filterJson[as.name],[ss.name]:this.filterJson[ss.name]}).filter(e=>{var[t,n]=e;return n}))}checkFields(e,t,n,i,a,s){var o={rooms:function(g){return e===g},senders:function(g){return t===g},types:function(g){return uM(n,g)}};for(var l in o){var u=o[l],d="not_"+l,h=this.filterJson[d];if(h!=null&&h.some(u))return!1;var f=this.filterJson[l];if(f&&!f.some(u))return!1}var m=this.filterJson.contains_url;if(m!==void 0&&m!==i)return!1;var v=this.filterJson[ss.name];if(v!==void 0&&!this.arrayMatchesFilter(v,a))return!1;var y=this.filterJson[as.name];return!(y!==void 0&&!this.arrayMatchesFilter(y,s))}arrayMatchesFilter(e,t){return t.length>0&&e.every(n=>t.includes(n))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function Sy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function wa(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Sy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function uh(r,e,t){for(var n=e.split("."),i=r,a=0;a<n.length-1;a++)i[n[a]]||(i[n[a]]={}),i=i[n[a]];i[n[n.length-1]]=t}class sr{static fromJson(e,t,n){var i=new sr(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,c(this,"definition",{}),c(this,"roomFilter",void 0),c(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new yy(n,this.userId),this.roomTimelineFilter=new yy((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){uh(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n;this.definition=wa(wa({},this.definition),{},{room:wa(wa({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:wa(wa({},(n=this.definition)===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.timeline),{},{[nl.name]:e})})})}setLazyLoadMembers(e){uh(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){uh(this.definition,"room.include_leave",e)}}c(sr,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function bd(r){return r!=null}var dM=new nr.UnstableValue("m.message","org.matrix.msc1767.message"),Bp=new nr.UnstableValue("m.text","org.matrix.msc1767.text"),cM=new nr.UnstableValue("m.html","org.matrix.msc1767.html"),t0=new nr.NamespacedValue("m.reference");function hM(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||bd(n.altName)&&t.matches(n.altName)}var $p=new yl("m.topic");function Ey(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function fM(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ey(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ey(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function r0(r,e){return{msgtype:Sn.Text,format:"org.matrix.custom.html",body:r,formatted_body:e}}function n0(r,e){return{msgtype:Sn.Notice,format:"org.matrix.custom.html",body:r,formatted_body:e}}function i0(r,e){return{msgtype:Sn.Emote,format:"org.matrix.custom.html",body:r,formatted_body:e}}function a0(r){return{msgtype:Sn.Text,body:r}}function s0(r){return{msgtype:Sn.Notice,body:r}}function o0(r){return{msgtype:Sn.Emote,body:r}}var l0=(r,e,t,n)=>{var i="at ".concat(new Date(t).toISOString()),a=e===ms.Self?"User":void 0,s=n?'"'.concat(n,'"'):void 0;return[a,"Location",s,r,i].filter(Boolean).join(" ")},u0=(r,e,t,n,i)=>{var a=r??l0(e,i||ms.Self,t,n),s=t?{[Mi.name]:t}:{};return fM({msgtype:Sn.Location,body:a,geo_uri:e,[El.name]:{description:n,uri:e},[Sl.name]:{type:i||ms.Self},[Bp.name]:a},s)},vM=r=>{var e,t,n=El.findIn(r),i=Sl.findIn(r),a=Mi.findIn(r),s=Bp.findIn(r),o=(e=n==null?void 0:n.uri)!==null&&e!==void 0?e:r==null?void 0:r.geo_uri,l=n==null?void 0:n.description,u=(t=i==null?void 0:i.type)!==null&&t!==void 0?t:ms.Self,d=s??r.body;return u0(d,o,a??void 0,l,u)},d0=(r,e)=>{var t=[];return bd(e)&&t.push({body:e,mimetype:"text/html"}),bd(r)&&t.push({body:r,mimetype:"text/plain"}),{topic:r,[$p.name]:t}},pM=r=>{var e,t,n,i,a=$p.findIn(r);if(!Array.isArray(a)){var s;return{text:(s=r.topic)!==null&&s!==void 0?s:void 0}}var o=(e=(t=a==null||(n=a.find(u=>!bd(u.mimetype)||u.mimetype==="text/plain"))===null||n===void 0?void 0:n.body)!==null&&t!==void 0?t:r.topic)!==null&&e!==void 0?e:void 0,l=a==null||(i=a.find(u=>u.mimetype==="text/html"))===null||i===void 0?void 0:i.body;return{text:o,html:l}},mM=(r,e,t,n,i)=>({description:t,timeout:r,live:e,[Mi.name]:i||Date.now(),[Sl.name]:{type:n??ms.Self}}),c0=r=>{var e,{description:t,timeout:n,live:i}=r,a=(e=Mi.findIn(r))!==null&&e!==void 0?e:void 0,s=Sl.findIn(r);return{description:t,timeout:n,live:i,assetType:s==null?void 0:s.type,timestamp:a}},gM=(r,e,t,n)=>({[El.name]:{description:n,uri:r},[Mi.name]:e,"m.relates_to":{rel_type:t0.name,event_id:t}}),iv=r=>{var e,t=El.findIn(r),n=(e=Mi.findIn(r))!==null&&e!==void 0?e:void 0;return{description:t==null?void 0:t.description,uri:t==null?void 0:t.uri,timestamp:n}};const yM=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:l0,makeBeaconContent:gM,makeBeaconInfoContent:mM,makeEmoteMessage:o0,makeHtmlEmote:i0,makeHtmlMessage:r0,makeHtmlNotice:n0,makeLocationContent:u0,makeNotice:s0,makeTextMessage:a0,makeTopicContent:d0,parseBeaconContent:iv,parseBeaconInfoContent:c0,parseLocationEvent:vM,parseTopicContent:pM},Symbol.toStringTag,{value:"Module"}));var tt=function(r){return r.New="Beacon.new",r.Update="Beacon.update",r.LivenessChange="Beacon.LivenessChange",r.Destroy="Beacon.Destroy",r.LocationUpdate="Beacon.LocationUpdate",r}({}),av=(r,e,t)=>t>=r&&r+e>=t,wd=r=>"".concat(r.getRoomId(),"_").concat(r.getStateKey());class h0 extends nt{constructor(e){super(),this.rootEvent=e,c(this,"roomId",void 0),c(this,"_beaconInfo",void 0),c(this,"_isLive",void 0),c(this,"livenessWatchTimeout",void 0),c(this,"_latestLocationEvent",void 0),c(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(tt.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return wd(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&iv(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(wd(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(tt.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(tt.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var n=e.filter(a=>{var s=a.getContent(),o=iv(s);if(!o.uri||!o.timestamp)return!1;var{timestamp:l}=o;return this._beaconInfo.timestamp&&av(this._beaconInfo.timestamp,this._beaconInfo.timeout,l)&&(!this.latestLocationState||l>this.latestLocationState.timestamp)}),i=(t=n.sort(SO))===null||t===void 0?void 0:t[0];i&&(this._latestLocationEvent=i,this.emit(tt.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=c0(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&av(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(tt.LivenessChange,this.isLive,this)}}}function _y(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function SM(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?_y(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):_y(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function f0(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new zt({content:{[e.getId()]:{[t]:{[r]:SM({ts:e.getTs()},!n&&{thread_id:Ts(e)})}}},type:j.Receipt,room_id:e.getRoomId()})}var Ta=0,Ra=1;class v0 extends nt{constructor(){super(...arguments),c(this,"receipts",new Nn(()=>new Map)),c(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Xt.Read,[s,o]=(t=(n=this.receipts.get(a))===null||n===void 0?void 0:n.get(e))!==null&&t!==void 0?t:[null,null];return i?s:o??s}compareReceipts(e,t){var n;return(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&n!==void 0?n:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t,n=this.findEventById(e.eventId);if(!n)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===_l){var i=ll(n);if(i)return!0}else if(n.threadRootId===e.data.thread_id)return!0;return T.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(n.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var n,i,a=this.getReadReceiptForUserId(e,t,Xt.Read),s=this.getReadReceiptForUserId(e,t,Xt.ReadPrivate),o;return a!=null&&a.eventId&&s!==null&&s!==void 0&&s.eventId&&(o=this.compareReceipts(a,s)),o?(i=o<0?s:a)!==null&&i!==void 0?i:null:(n=s??a)!==null&&n!==void 0?n:null}addReceiptToStructure(e,t,n,i,a){var s,o,l=this.receipts.getOrCreate(t),u=l.get(n);u||(u=[null,null],l.set(n,u));var d=u[Ta];if(a){var h;d=(h=u[Ra])!==null&&h!==void 0?h:u[Ta]}var f={eventId:e,data:i};if(d){var m=this.compareReceipts(d,f);if(m>=0)return}var v=a?u[Ta]:f,y=a?f:u[Ra],I=null;v&&y&&(I=this.getUnfilteredTimelineSet().compareEventOrdering(v.eventId,y.eventId));var g=I===null||I<0,p=(s=u[Ra])!==null&&s!==void 0?s:u[Ta];a&&g?u[Ra]=f:a||(u[Ta]=f,g||(u[Ra]=null));var b=(o=u[Ra])!==null&&o!==void 0?o:u[Ta];if(p!==b){if(p&&this.receiptCacheByEventId.get(p.eventId)){var R=p.eventId;this.receiptCacheByEventId.set(R,this.receiptCacheByEventId.get(R).filter(P=>P.type!==t||P.userId!==n)),this.receiptCacheByEventId.get(R).length<1&&this.receiptCacheByEventId.delete(R)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&(t==null?void 0:t.eventId)===n.getId()&&e===n.getSender()&&(this.setUnread(We.Total,0),this.setUnread(We.Highlight,0))}addLocalEchoReceipt(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(f0(e,t,n,i),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return Lp(t.type)}).map(function(t){return t.userId})}}var EM=new nr.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),_M=new nr.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),bM=new nr.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),il=new nr.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),Td=new nr.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),ni=function(r){return r.New="Poll.new",r.End="Poll.end",r.Update="Poll.update",r.Responses="Poll.Responses",r.Destroy="Poll.Destroy",r.UndecryptableRelations="Poll.UndecryptableRelations",r}({}),by=(r,e)=>{var t=r.filter(n=>{if(!n.isDecryptionFailure())return il.matches(n.getType())&&n.getTs()<=e});return{responseEvents:t}};class p0 extends nt{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,c(this,"roomId",void 0),c(this,"pollEvent",void 0),c(this,"_isFetchingResponses",!1),c(this,"relationsNextBatch",void 0),c(this,"responses",null),c(this,"endEvent",void 0),c(this,"undecryptableRelationEventIds",new Set),c(this,"countUndecryptableEvents",i=>{var a=i.filter(o=>o.isDecryptionFailure()).map(o=>o.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==s&&this.emit(ni.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return w(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(Td.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(ni.End)),!!this.responses){var n=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=by([e],n);this.countUndecryptableEvents([e]),i.length&&(i.forEach(a=>{this.responses.addEvent(a)}),this.emit(ni.Responses,this.responses))}}fetchResponses(){var e=this;return w(function*(){var t,n;e._isFetchingResponses=!0;var i=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(i.events.map(u=>e.matrixClient.decryptEventIfNeeded(u)));var a=e.responses||new Fp("m.reference",il.name,e.matrixClient,[il.altName]),s=i.events.find(u=>Td.matches(u.getType()));e.validateEndEvent(s)&&(e.endEvent=s,e.refilterResponsesOnEnd(),e.emit(ni.End));var o=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=by(i.events,o);l.forEach(u=>{a.addEvent(u)}),e.relationsNextBatch=(n=i.nextBatch)!==null&&n!==void 0?n:void 0,e.responses=a,e.countUndecryptableEvents(i.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(ni.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{if(n.getTs()>t){var i;(i=this.responses)===null||i===void 0||i.removeEvent(n)}}),this.emit(ni.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}}var m0=r=>{var e=r.getType();return nr.M_POLL_START.matches(e)||il.matches(e)||Td.matches(e)};class wM{constructor(e){c(this,"room",void 0),c(this,"threadedReceipts",void 0),c(this,"unthreadedReceipts",void 0),c(this,"danglingReceipts",void 0),c(this,"onTimelineEvent",t=>{var n=t.getId();if(n){var i=this.danglingReceipts.remove(n);i==null||i.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(n,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new CM(e),this.unthreadedReceipts=new g0(e),this.danglingReceipts=new OM,e.on(le.Timeline,this.onTimelineEvent)}add(e,t){for(var[n,i]of Object.entries(e))for(var[a,s]of Object.entries(i))for(var[o,l]of Object.entries(s)){var u=this.room.findEventById(n);u?l.thread_id?this.threadedReceipts.set(l.thread_id,n,a,o,l.ts,t):this.unthreadedReceipts.set(n,a,o,l.ts,t):this.danglingReceipts.add(new RM(n,a,o,l,t))}}hasUserReadEvent(e,t){var n=this.unthreadedReceipts.get(e);if(n&&sv(n.eventId,t,this.room))return!0;var i=this.room.findEventById(t);if(!i)return T.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=Ts(i),s=this.threadedReceipts.get(a,e);return!!(s&&sv(s.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var n,i=e===_l?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))===null||n===void 0?void 0:n.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}}class TM{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}}class RM{constructor(e,t,n,i,a){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=i,this.synthetic=a}}class IM{constructor(e){c(this,"room",void 0),c(this,"real",void 0),c(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&sv(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class g0{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a){var s=Wp(this.data,n,()=>new IM(this.room)),o=s.getByType(a);o&&kM(o.eventId,e,this.room)||s.set(a,new TM(e,t,i))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class CM{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a,s){var o=Wp(this.data,e,()=>new g0(this.room));o.set(t,n,i,a,s)}get(e,t){var n;return(n=this.data.get(e))===null||n===void 0?void 0:n.get(t)}}class OM{constructor(){c(this,"data",new Map)}add(e){var t=Wp(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function Wp(r,e,t){var n=r.get(e);if(n)return n;var i=t();return r.set(e,i),i}function sv(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>=0}function kM(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>0}function PM(r,e,t){var n=r.findEventById(e),i=r.findEventById(t);if(!n||!i)return null;var a=ll(n),s=ll(i);return a&&s?MM(r,e,t,n,i):AM(e,t,n,i)}function MM(r,e,t,n,i){var a=r.getUnfilteredTimelineSet(),s=a.compareEventOrdering(e,t);if(s!==null)return s;var o=a.getTimelineForEvent(e);if(o===a.getLiveTimeline())return 1;var l=a.getTimelineForEvent(t);return l===a.getLiveTimeline()?-1:y0(n,i)}function AM(r,e,t,n){var i=Ts(t),a=Ts(n),s=t.getThread();return s&&i===a?s.timelineSet.compareEventOrdering(r,e):y0(t,n)}function y0(r,e){var t=r.getTs(),n=e.getTs();return t<n?-1:t>n?1:0}var V=function(r){return r.Get="GET",r.Put="PUT",r.Post="POST",r.Delete="DELETE",r.Options="OPTIONS",r.Head="HEAD",r.Patch="PATCH",r}({});function wy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function DM(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):wy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}class ha extends Error{constructor(e,t,n){super(e),this.httpStatus=t,this.httpHeaders=n}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var n=Number.parseInt(t)*1e3;if(!Number.isFinite(n))throw new Error("Retry-After header integer value is too large");return n}var i=new Date(t);if(i.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return i.getTime()-Date.now()}return null}}class mt extends ha{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),n&&(s="".concat(s," (").concat(n,")")),super("MatrixError: ".concat(s),t,a),this.url=n,this.event=i,c(this,"errcode",void 0),c(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,n,i,a={};if(this.httpHeaders)for(var[s,o]of this.httpHeaders)a[s]=o;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:DM({errcode:(n=this.errcode)!==null&&n!==void 0?n:"M_UNKNOWN",error:(i=this.data.error)!==null&&i!==void 0?i:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new mt(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function Kp(r,e){if(!(r instanceof ha)||!r.isRateLimitError())return e;try{var t;return(t=r.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}class ga extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class S0 extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}}class Vp extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}}var ov=function(r){return r.SessionLoggedOut="Session.logged_out",r.NoConsent="no_consent",r}({});/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var Ty=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,xM=/\\([\u000b\u0020-\u00ff])/g,NM=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,LM=UM;function UM(r){if(!r)throw new TypeError("argument string is required");var e=typeof r=="object"?jM(r):r;if(typeof e!="string")throw new TypeError("argument string is required to be a string");var t=e.indexOf(";"),n=t!==-1?e.slice(0,t).trim():e.trim();if(!NM.test(n))throw new TypeError("invalid media type");var i=new FM(n.toLowerCase());if(t!==-1){var a,s,o;for(Ty.lastIndex=t;s=Ty.exec(e);){if(s.index!==t)throw new TypeError("invalid parameter format");t+=s[0].length,a=s[1].toLowerCase(),o=s[2],o.charCodeAt(0)===34&&(o=o.slice(1,-1),o.indexOf("\\")!==-1&&(o=o.replace(xM,"$1"))),i.parameters[a]=o}if(t!==e.length)throw new TypeError("invalid parameter format")}return i}function jM(r){var e;if(typeof r.getHeader=="function"?e=r.getHeader("content-type"):typeof r.headers=="object"&&(e=r.headers&&r.headers["content-type"]),typeof e!="string")throw new TypeError("content-type header is missing from object");return e}function FM(r){this.parameters=Object.create(null),this.type=r}function lc(r){var e=new AbortController;return setTimeout(()=>{e.abort()},r),e.signal}function E0(r){var e=new AbortController;function t(){for(var a of r)a.removeEventListener("abort",n)}function n(){e.abort(),t()}for(var i of r){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:e.signal,cleanup:t}}function Gp(r,e){var t,n,i=Ry(r)?new Headers(r.getAllResponseHeaders().trim().split(/[\r\n]+/).map(s=>{var o=s.indexOf(":");return[s.substring(0,o),s.substring(o+1)]})):r.headers,a;try{a=BM(i)}catch(s){return s}return((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e?new mt(JSON.parse(e),r.status,Ry(r)?r.responseURL:r.url,void 0,i):((n=a)===null||n===void 0?void 0:n.type)==="text/plain"?new ha("Server returned ".concat(r.status," error: ").concat(e),r.status,i):new ha("Server returned ".concat(r.status," error"),r.status,i)}function Ry(r){return"getResponseHeader"in r}function BM(r){var e=r.get("Content-Type");if(e===null)return null;try{return LM(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function lv(r,e){return uv.apply(this,arguments)}function uv(){return uv=w(function*(r,e){for(var t=0,n=null;t<r;)try{if(t>0){var i=1e3*Math.pow(2,t);T.log("network operation failed ".concat(t," times, retrying in ").concat(i,"ms...")),yield wl(i)}return yield e()}catch(a){if(a instanceof ga)t+=1,n=a;else throw a}throw n}),uv.apply(this,arguments)}function _0(r,e,t){return e>4||r instanceof ga&&!t||r.httpStatus&&Math.floor(r.httpStatus/100)===4&&r.httpStatus!==429||r.name==="AbortError"||r.name==="M_TOO_LARGE"?-1:Kp(r,1e3*Math.pow(2,e))}var ii=function(r){return r.Success="success",r.Failure="failure",r.Logout="logout",r}({}),$M=500,WM=60*1e3;class KM{constructor(e){this.opts=e,c(this,"tokenRefreshPromise",void 0),c(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return w(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return w(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=$M&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var n=this;return w(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return w(function*(){if(e!=null&&e.expiry){var i=e.expiry.getTime()-Date.now();if(i>=WM)return ii.Logout}if(!e||(e==null?void 0:e.accessToken)===n.opts.accessToken){var a;(a=n.tokenRefreshPromise)!==null&&a!==void 0||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return ii.Success})()}doTokenRefresh(e){var t=this;return w(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var n;return(n=t.opts.logger)===null||n===void 0||n.error("Unable to refresh token - no refresh token or refresh function"),ii.Logout}e&&e>1&&(yield wl(1e3*Math.min(32,2**e)));try{var i,a;(i=t.opts.logger)===null||i===void 0||i.debug("Attempting to refresh token");var{accessToken:s,refreshToken:o,expiry:l}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=s,t.opts.refreshToken=o,t.latestTokenRefreshExpiry=l,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",l),ii.Success}catch(h){var u;if(h instanceof Vp||h instanceof mt){var d;return(d=t.opts.logger)===null||d===void 0||d.error("Failed to refresh token",h),ii.Logout}return(u=t.opts.logger)===null||u===void 0||u.warn("Failed to refresh token",h),ii.Failure}})()}}function Iy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Cy(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Iy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Iy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}class VM{constructor(e,t){var n;this.eventEmitter=e,this.opts=t,c(this,"abortController",new AbortController),c(this,"tokenRefresher",void 0),yb(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(n=t.useAuthorizationHeader)!==null&&n!==void 0?n:!0,this.tokenRefresher=new KM(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,i,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var s=void 0,o=void 0;e===V.Get?s=n:o=n;var l=this.getUrl(t,s,i,this.opts.idBaseUrl),u={json:!0,headers:{}};return a&&(u.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,l,o,u)}authedRequest(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,n,i,a)}doAuthedRequest(e,t,n,i,a){var s=arguments,o=this;return w(function*(){var l=s.length>5&&s[5]!==void 0?s[5]:{},u=bl(l);u.abortSignal=l.abortSignal;var d=yield o.tokenRefresher.prepareForRequest();d.accessToken&&(o.opts.useAuthorizationHeader?(u.headers||(u.headers={}),u.headers.Authorization||(u.headers.Authorization="Bearer ".concat(d.accessToken)),i.access_token&&delete i.access_token):i.access_token||(i.access_token=d.accessToken));try{var h=yield o.request(t,n,i,a,u);return h}catch(m){if(!(m instanceof mt))throw m;if(m.errcode==="M_UNKNOWN_TOKEN"){var f=yield o.tokenRefresher.handleUnknownToken(d,e);if(f===ii.Success)return o.doAuthedRequest(e+1,t,n,i,a,l);if(f===ii.Failure)throw new S0(m);u!=null&&u.inhibitLogoutEmit||o.eventEmitter.emit(ov.SessionLoggedOut,m)}else m.errcode=="M_CONSENT_NOT_GIVEN"&&o.eventEmitter.emit(ov.NoConsent,m.message,m.data.consent_uri);throw m}})()}request(e,t,n,i,a){var s=this.getUrl(t,n,a==null?void 0:a.prefix,a==null?void 0:a.baseUrl);return this.requestOtherUrl(e,s,i,a)}requestOtherUrl(e,t,n){var i=arguments,a=this;return w(function*(){var s,o,l,u,d=i.length>3&&i[3]!==void 0?i[3]:{};if(d.json!==void 0&&d.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var h=a.sanitizeUrlForLogs(t);(s=a.opts.logger)===null||s===void 0||s.debug("FetchHttpApi: --> ".concat(e," ").concat(h));var f=Object.assign({},d.headers||{}),m=!d.rawResponseBody&&d.json!==!1;m&&(f.Accept||(f.Accept="application/json"));var v=(o=d.localTimeoutMs)!==null&&o!==void 0?o:a.opts.localTimeoutMs,y=(l=d.keepAlive)!==null&&l!==void 0?l:!1,I=[a.abortController.signal];v!==void 0&&I.push(lc(v)),d.abortSignal&&I.push(d.abortSignal);var g;d.json!==!1&&(n==null||(u=n.constructor)===null||u===void 0?void 0:u.name)===Object.name?(g=JSON.stringify(n),f["Content-Type"]||(f["Content-Type"]="application/json")):g=n;var{signal:p,cleanup:b}=E0(I),R,P=Date.now();try{var E;R=yield a.fetch(t,{signal:p,method:e,body:g,headers:f,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:y,priority:d.priority}),(E=a.opts.logger)===null||E===void 0||E.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-P,"ms ").concat(R.status,"]"))}catch(S){var C;throw(C=a.opts.logger)===null||C===void 0||C.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-P,"ms ").concat(S,"]")),S.name==="AbortError"?S:new ga("fetch failed",S)}finally{b()}if(!R.ok)throw Gp(R,yield R.text());return a.opts.onlyData?d.rawResponseBody?yield R.blob():m?yield R.json():yield R.text():R})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var n=new URLSearchParams;for(var i of t.searchParams.keys())n.append(i,"xxx");var a=n.toString(),s=a?"?".concat(a):"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,n,i){var a=i??this.opts.baseUrl,s=a.endsWith("/")?a.slice(0,-1):a,o=new URL(s+(n??this.opts.prefix)+e);if(this.opts.extraParams||t){var l=Cy(Cy({},this.opts.extraParams),t);If(l,o.searchParams)}return o}}var It=function(r){return r.V1="/_matrix/client/v1",r.V3="/_matrix/client/v3",r.Unstable="/_matrix/client/unstable",r}({}),bn=function(r){return r.V2="/_matrix/identity/v2",r}({}),ts=function(r){return r.V1="/_matrix/media/v1",r.V3="/_matrix/media/v3",r}({}),GM=1e3,qM=0,dh,Mn=[],HM=function(){};function Oy(r,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),i=2;i<t;i++)n[i-2]=arguments[i];e=e||0,e<0&&(e=0);var a=Date.now()+e,s=qM++,o={runAt:a,func:r,params:n,key:s},l=JM(Mn,function(u){return u.runAt-a});return Mn.splice(l,0,o),qp(),s}function ky(r){if(Mn.length!==0){var e;for(e=0;e<Mn.length;e++){var t=Mn[e];if(t.key==r){Mn.splice(e,1);break}}e===0&&qp()}}function qp(){dh&&globalThis.clearTimeout(dh);var r=Mn[0];if(r){var e=Date.now(),t=Math.min(r.runAt-e,GM);dh=globalThis.setTimeout(zM,t)}}function zM(){for(var r=Date.now(),e=[];;){var t=Mn[0];if(!t||t.runAt>r)break;var n=Mn.shift();HM("runCallbacks: popping",n.key),e.push(n)}qp();for(var i of e)try{i.func.apply(globalThis,i.params)}catch(a){T.error("Uncaught exception in callback function",a)}}function JM(r,e){for(var t=0,n=r.length;t<n;){var i=t+n>>1,a=e(r[i]);a>0?n=i:t=i+1}return t}class b0 extends VM{constructor(){super(...arguments),c(this,"uploads",[])}uploadContent(e){var t,n,i,a,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=(t=s.includeFilename)!==null&&t!==void 0?t:!0,l=(n=s.abortController)!==null&&n!==void 0?n:new AbortController,u=((i=s.type)!==null&&i!==void 0?i:e.type)||"application/octet-stream",d=(a=s.name)!==null&&a!==void 0?a:e.name,h={loaded:0,total:0,abortController:l},f=Promise.withResolvers();if(globalThis.XMLHttpRequest){var m=new globalThis.XMLHttpRequest,v=function(){m.abort(),f.reject(new Error("Timeout"))},y=Oy(v,3e4);m.onreadystatechange=function(){switch(m.readyState){case globalThis.XMLHttpRequest.DONE:ky(y);try{if(m.status===0)throw new DOMException(m.statusText,"AbortError");if(!m.responseText)throw new Error("No response body.");m.status>=400?f.reject(Gp(m,m.responseText)):f.resolve(JSON.parse(m.responseText))}catch(b){if(b.name==="AbortError"){f.reject(b);return}f.reject(new ga("request failed",b))}break}},m.upload.onprogress=b=>{var R;ky(y),h.loaded=b.loaded,h.total=b.total,y=Oy(v,3e4),(R=s.progressHandler)===null||R===void 0||R.call(s,{loaded:b.loaded,total:b.total})};var I=this.getUrl("/upload",void 0,ts.V3);o&&d&&I.searchParams.set("filename",encodeURIComponent(d)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&I.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),m.open(V.Post,I.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&m.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),m.setRequestHeader("Content-Type",u),m.send(e),l.signal.addEventListener("abort",()=>{m.abort()})}else{var g={};o&&d&&(g.filename=d);var p={"Content-Type":u};this.authedRequest(V.Post,"/upload",g,e,{prefix:ts.V3,headers:p,abortSignal:l.signal}).then(b=>this.opts.onlyData?b:b.json()).then(f.resolve,f.reject)}return h.promise=f.promise.finally(()=>{hd(this.uploads,b=>b===h)}),l.signal.addEventListener("abort",()=>{hd(this.uploads,b=>b===h),f.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(h),h.promise}cancelUpload(e){var t=this.uploads.find(n=>n.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:ts.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var YM=6*60*60*1e3,QM=30*1e3,w0=function(r){return r.Stable="stable",r.Unstable="unstable",r}({});class T0{constructor(e,t){var n=this;this.logger=e,this.http=t,c(this,"capabilities",void 0),c(this,"retryTimeout",void 0),c(this,"refreshTimeout",void 0),c(this,"fetchCapabilities",w(function*(){var i=yield n.http.authedRequest(V.Get,"/capabilities");return n.capabilities=i.capabilities,n.capabilities})),c(this,"poll",w(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,YM),n.logger.debug("Fetched new server capabilities")}catch(a){n.clearTimeouts();var i=Math.floor(QM+Math.random()*5e3);n.retryTimeout=setTimeout(n.poll,i),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(i,"ms"),a)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}function Py(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Ys(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Py(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Py(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var R0="10",XM=["1","2","3","4","5","6","7","8","9","10"],ZM=30,We=function(r){return r.Highlight="highlight",r.Total="total",r}({}),le=function(r){return r.MyMembership="Room.myMembership",r.Tags="Room.tags",r.AccountData="Room.accountData",r.Receipt="Room.receipt",r.Name="Room.name",r.Redaction="Room.redaction",r.RedactionCancelled="Room.redactionCancelled",r.LocalEchoUpdated="Room.localEchoUpdated",r.Timeline="Room.timeline",r.TimelineReset="Room.timelineReset",r.TimelineRefresh="Room.TimelineRefresh",r.OldStateUpdated="Room.OldStateUpdated",r.CurrentStateUpdated="Room.CurrentStateUpdated",r.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",r.UnreadNotifications="Room.UnreadNotifications",r.Summary="Room.Summary",r}({});class uc extends v0{constructor(e,t,n){var i,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),i=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=a,c(this,"reEmitter",void 0),c(this,"txnToEvent",new Map),c(this,"notificationCounts",{}),c(this,"bumpStamp",void 0),c(this,"threadNotifications",new Map),c(this,"cachedThreadReadReceipts",new Map),c(this,"oldestThreadedReceiptTs",1/0),c(this,"unthreadedReceipts",new Map),c(this,"timelineSets",void 0),c(this,"polls",new Map),c(this,"threadsTimelineSets",[]),c(this,"filteredTimelineSets",{}),c(this,"timelineNeedsRefresh",!1),c(this,"pendingEventList",void 0),c(this,"blacklistUnverifiedDevices",void 0),c(this,"selfMembership",void 0),c(this,"heroes",null),c(this,"getTypeWarning",!1),c(this,"membersPromise",void 0),c(this,"name",void 0),c(this,"normalizedName",void 0),c(this,"tags",{}),c(this,"accountData",new Map),c(this,"summary",null),c(this,"oldState",void 0),c(this,"currentState",void 0),c(this,"relations",void 0),c(this,"threads",new Map),c(this,"visibilityEvents",new Map),c(this,"roomReceipts",new wM(this)),c(this,"threadTimelineSetsPromise",null),c(this,"threadsReady",!1),c(this,"updateThreadRootEvents",(s,o,l)=>{if(s.length){var u;if(this.updateThreadRootEvent((u=this.threadsTimelineSets)===null||u===void 0?void 0:u[0],s,o,l),s.hasCurrentUserParticipated){var d;this.updateThreadRootEvent((d=this.threadsTimelineSets)===null||d===void 0?void 0:d[1],s,o,l)}}}),c(this,"updateThreadRootEvent",(s,o,l,u)=>{s&&o.rootEvent&&(u&&s.removeEvent(o.id),Xe.hasServerSideSupport?s.addLiveEvent(o.rootEvent,{duplicateStrategy:Io.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):s.addEventToTimeline(o.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:l,addToState:!1}))}),c(this,"tryApplyRedaction",s=>{if(s.isRedaction()){var o=s.event.redacts,l=o?this.findEventById(o):void 0;l&&this.applyEventAsRedaction(s,l)}else if(s.getType()===j.RoomMember){var u=s.getContent().membership;if(u!==Ie.Ban&&!(u===Ie.Leave&&s.getStateKey()!==s.getSender()))return;var d=s.getContent()["org.matrix.msc4293.redact_events"];if(d!==!0)return;var h=this.getLiveTimeline().getState(ke.Forward);if(!h.maySendRedactionForEvent(s,s.getSender()))return;var f=this.getTimelineSets().map(v=>v.getTimelines()).reduce((v,y)=>(v.push(...y),v),[]).map(v=>v.getEvents().filter(y=>y.getSender()===s.getStateKey())).reduce((v,y)=>(v.push(...y),y),[]);for(var m of f)this.applyEventAsRedaction(s,m)}}),this.setMaxListeners(100),this.reEmitter=new xs(this),a.pendingEventOrdering=a.pendingEventOrdering||ws.Chronological,this.name=e,this.normalizedName=e,this.relations=new Xb(this.client,this),this.on(le.Receipt,this.onReceipt),this.timelineSets=[new Va(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[le.Timeline,le.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===ws.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{var o=this.client.getEventMapper({toDevice:!1,decrypt:!1});s.forEach(function(){var l=w(function*(u){var d=o(u);yield t.decryptEventIfNeeded(d),d.setStatus(Se.NOT_SENT),i.addPendingEvent(d,d.getTxnId())});return function(u){return l.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return w(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Kr.My)]);var n=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=n[0],e.threadsTimelineSets[1]=n[1],n}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return w(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),n=e.getLiveTimeline().getEvents(),i=n.findIndex(s=>s.event.event_id===t),a=n.slice(i).reverse().map(s=>e.client.decryptEventIfNeeded(s));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return w(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(n=>e.client.decryptEventIfNeeded(n));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(j.RoomCreate,"");return(e=t==null?void 0:t.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return w(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var n=t["m.room_versions"];if(!n){n={default:R0,available:{}};for(var i of XM)n.available[i]=w0.Stable}var a=e.checkVersionAgainstCapability(n);if(a.urgent&&a.needsUpgrade){T.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){T.warn("Failed to refresh room version capabilities",s)}if(n=t["m.room_versions"],n)a=e.checkVersionAgainstCapability(n);else return T.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();T.log("[".concat(this.roomId,"] Current version: ").concat(t)),T.log("[".concat(this.roomId,"] Version capability: "),e);var n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;var i=Object.keys(e.available).filter(a=>e.available[a]==="stable");return i.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?T.warn("URGENT upgrade required on ".concat(this.roomId)):T.warn("Non-urgent upgrade required on ".concat(this.roomId))),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(j.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=hd(this.pendingEventList,function(n){return n.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.some(i=>i.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.find(i=>i.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var n=t[t.length-1];return n.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,n=this.getLiveTimeline().getEvents(),i=n[n.length-1],a=this.getLastThread();if(!a)return i;var s=a.events[a.events.length-1];return((e=i==null?void 0:i.getTs())!==null&&e!==void 0?e:0)>((t=s==null?void 0:s.getTs())!==null&&t!==void 0?t:0)?i:s}getLastThread(){return this.getThreads().reduce((e,t)=>{var n,i;if(!e)return t;var a=t.events[t.events.length-1],s=e.events[e.events.length-1];return((n=a==null?void 0:a.getTs())!==null&&n!==void 0?n:0)>=((i=s==null?void 0:s.getTs())!==null&&i!==void 0?i:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Ie.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Ie.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var n;return(n=this.heroes)===null||n===void 0||(n=n[0])===null||n===void 0?void 0:n.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var n=this.currentState.getMembers(),i=n.find(a=>a.userId!==this.myUserId);return i?i.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(Ub.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),n=0;if(this.getMembers().forEach(y=>{y.membership!=="join"&&y.membership!=="invite"||t.includes(y.userId)||n++}),!(n>2)){var i=(e=this.heroes)===null||e===void 0?void 0:e.filter(y=>!t.includes(y.userId)),a=Array.isArray(i)&&i.length;if(a){for(var s of i)if(s.fromMSC4186){var l=new el(this.roomId,s.userId);return l.setMembershipEvent(new zt({event_id:"$"+this.roomId+s.userId+new Date().getTime(),type:j.RoomMember,state_key:s.userId,content:{displayname:s.displayName,avatar_url:s.avatarUrl}})),l}else{var o=this.getMember(s.userId);if(o)return o}var u=i.map(y=>this.getMember(y.userId)).find(y=>!!y);if(u)return u}var d=this.getMembers(),h=d==null?void 0:d.filter(y=>!t.includes(y.userId));if(h.length<=2){var f=h.find(y=>y.userId!==this.myUserId);if(f)return f}if(a){var m=i.map(y=>this.client.getUser(y.userId)).find(y=>!!y);if(m){var v=new el(this.roomId,m.userId);return v.user=m,v}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Ie.Leave&&this.cleanupAfterLeaving(),this.emit(le.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return w(function*(){var t=e.client.store.getSyncToken(),n=yield e.client.members(e.roomId,void 0,Ie.Leave,t??void 0);return n.chunk})()}loadMembers(){var e=this;return w(function*(){var t=!1,n=yield e.client.store.getOutOfBandMembers(e.roomId);(n===null||e.hasEncryptionStateEvent())&&(t=!0,n=yield e.loadMembersFromServer(),T.log("LL: got ".concat(n.length," ")+"members from server for room ".concat(e.roomId)));var i=n.filter(Hr).map(e.client.getEventMapper());return{memberEvents:i,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var n=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var s;return(s=a.events.member)===null||s===void 0?void 0:s.event});T.log("LL: telling store to write ".concat(n.length)+" members for room ".concat(this.roomId));var i=this.client.store;return i.setOutOfBandMembers(this.roomId,n).catch(a=>{T.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{T.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return w(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{T.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),T.log(e)})}refreshLiveTimeline(){var e=this;return w(function*(){var t=e.getLiveTimeline(),n=t.getPaginationToken(se.FORWARDS),i=t.getPaginationToken(se.BACKWARDS),a=t.getEvents(),s=a[a.length-1];T.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(s&&s.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(n," ")+"backwardPaginationToken=".concat(i));var o=e.getUnfilteredTimelineSet(),l;s?(e.resetLiveTimeline(null,null),e.emit(le.TimelineRefresh,e,o),l=yield e.client.getEventTimeline(o,s.getId())):l=yield e.client.getLatestTimeline(o);var u=o.getLiveTimeline();!u||u.getPaginationToken(ke.Forward)===null&&u.getPaginationToken(ke.Backward)===null&&u.getEvents().length===0?(T.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),l.setPaginationToken(n,se.FORWARDS),o.setLiveTimeline(l),e.fixUpLegacyTimelineFields()):T.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(le.TimelineRefresh,e,o)})()}resetLiveTimeline(e,t){for(var n of this.timelineSets)n.resetLiveTimeline(e??void 0,t??void 0);for(var i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(se.BACKWARDS),this.currentState=this.getLiveTimeline().getState(se.FORWARDS),e!==this.oldState&&this.emit(le.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(le.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,Ae.Marker,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),this.reEmitter.reEmit(this.currentState,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,Ae.Marker,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],n=!1,i=e.getContent();for(var a of Object.values(i))for(var[s,o]of Object.entries(a))if(Lp(s)&&o){for(var[l,u]of Object.entries(o))if(!(!u||typeof u!="object")){var d=u;l===this.client.getUserId()&&(d.thread_id===void 0?n=!0:typeof d.thread_id=="string"&&t.push(d.thread_id))}}n&&(t=this.getThreads().filter(P=>this.getThreadUnreadNotificationCount(P.id,We.Total)>0||this.getThreadUnreadNotificationCount(P.id,We.Highlight)>0).map(P=>P.id),t.push("main"));for(var h of t){var f,m=20,v=h==="main"?this.getLiveTimeline():(f=this.getThread(h))===null||f===void 0?void 0:f.liveTimeline;if(!v){T.warn("Couldn't find timeline for thread ID ".concat(h," in room ").concat(this.roomId));continue}for(var y=v.getEvents(),I=0,g=y.length-1;g>=0;g--){var p;if(g===y.length-m)return;var b=y[g];if(this.hasUserReadEvent(this.client.getUserId(),b.getId()))break;var R=this.client.getPushActionsForEvent(b);I+=R!=null&&(p=R.tweaks)!==null&&p!==void 0&&p.highlight?1:0}h==="main"?this.setUnreadNotificationCount(We.Highlight,I):this.setThreadUnreadNotificationCount(h,We.Highlight,I)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var n=this.getThreads(),i=0;i<n.length;i++){var a=n[i];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:We.Total,t=this.getRoomUnreadNotificationCount(e);for(var n of this.threadNotifications.values()){var i;t+=(i=n[e])!==null&&i!==void 0?i:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:We.Total,n=arguments.length>1?arguments[1]:void 0,i=!!n.threadRootId&&!n.isThreadRoot;return(e=i?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:We.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:We.Total;return(t=(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n[i])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,n;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((n=e.total)!==null&&n!==void 0?n:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var i,a,s=Ys({highlight:(i=this.threadNotifications.get(e))===null||i===void 0?void 0:i.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:n});this.threadNotifications.set(e,s),this.emit(le.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var n,i;if(((n=t.highlight)!==null&&n!==void 0?n:0)>0)return We.Highlight;((i=t.total)!==null&&i!==void 0?i:0)>0&&!e&&(e=We.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[n,i]of this.threadNotifications)e.includes(n)||(i.total=0,t||(i.highlight=0));this.emit(le.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(le.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,n=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(s=>({userId:s,fromMSC4186:!1})),i=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(n)&&(this.heroes=n.filter(s=>s.userId!=this.myUserId)),this.emit(le.Summary,e)}setMSC4186SummaryData(e,t,n){e&&(this.heroes=e.filter(i=>i.user_id!==this.myUserId).map(i=>({userId:i.user_id,displayName:i.displayname,avatarUrl:i.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),n!==void 0&&Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),this.emit(le.Summary,{"m.heroes":this.heroes?this.heroes.map(i=>i.userId):[],"m.joined_member_count":t,"m.invited_member_count":n})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,o=this.currentState.getStateEvents(j.RoomAvatar,"");if(!o&&!a)return null;var l=o?o.getContent().url:null;return l?tc(e,l,t,n,i,void 0,void 0,s):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents(j.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(j.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(j.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,n,i,a){i.getTimelineSet().addEventsToTimeline(e,t,n,i,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Ie.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return w(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Ie.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Ie.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(j.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var n=this.getMember(e);return n?n.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:i},this.opts),s=new Va(this,a);this.reEmitter.reEmit(s,[le.Timeline,le.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s));var o=this.getLiveTimeline();if(t){o.getEvents().forEach(function(d){s.addLiveEvent(d,{addToState:!1})});for(var l=o;l.getNeighbouringTimeline(se.BACKWARDS);)l=l.getNeighbouringTimeline(se.BACKWARDS);s.getLiveTimeline().setPaginationToken(l.getPaginationToken(se.BACKWARDS),se.BACKWARDS)}else if(n){var u=o.getPaginationToken(ke.Forward);s.getLiveTimeline().setPaginationToken(u,ke.Backward)}return s}getThreadListFilter(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:Kr.All,i=t.client.getUserId(),a=new sr(i),s={room:{timeline:{[ss.name]:[ze.name]}}};n===Kr.My&&(s.room.timeline[as.name]=[i]),a.setDefinition(s);var o=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(n),a);return a.filterId=o,a})()}createThreadTimelineSet(e){var t=this;return w(function*(){var n;if(Xe.hasServerSideListSupport)n=new Va(t,Ys(Ys({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Kr.All),t.reEmitter.reEmit(n,[le.Timeline,le.TimelineReset]);else if(Xe.hasServerSideSupport){var i=yield t.getThreadListFilter(e);n=t.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else n=new Va(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,s]=a;if(s.length!==0){var o=s.timeline.some(l=>l.getSender()===t.client.getUserId());(e!==Kr.My||o)&&n.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return n})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var n of e)se.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}fetchRoomThreads(){var e=this;return w(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(Xe.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Kr.All),e.fetchRoomThreadList(Kr.My)]);else{var t=yield e.getThreadListFilter(),{chunk:n}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,ke.Backward,t);if(!n.length)return;var i=n.map(e.client.getEventMapper()).sort((f,m)=>{var v=f.getServerAggregatedRelation(ze.name),y=m.getServerAggregatedRelation(ze.name);return v.latest_event.origin_server_ts-y.latest_event.origin_server_ts}),a,s=e.getLiveTimeline().getState(se.FORWARDS);for(var o of i){var l,u={duplicateStrategy:Io.Ignore,fromCache:!1,addToState:!1,roomState:s};(l=e.threadsTimelineSets[0])===null||l===void 0||l.addLiveEvent(o,u);var d=o.getServerAggregatedRelation(ze.name);if(d!=null&&d.current_user_participated){var h;(h=e.threadsTimelineSets[1])===null||h===void 0||h.addLiveEvent(o,u),a=o}}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(Zt.NewReply,e.onThreadReply),e.on(Zt.Update,e.onThreadUpdate),e.on(Zt.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return w(function*(){for(var n of e)try{if(!n.isEncrypted()&&!m0(n))continue;yield t.client.decryptEventIfNeeded(n),t.processPollEvent(n)}catch(i){T.warn("Error processing poll event",n.getId(),i)}})()}processPollEvent(e){var t=this;return w(function*(){if(e.isDecryptionFailure()){e.once(Ve.Decrypted,s=>{t.processPollEvent(s)});return}if(nr.M_POLL_START.matches(e.getType())){try{var n=new p0(e,t.client,t);t.polls.set(e.getId(),n),t.emit(ni.New,n),e.once(Ve.BeforeRedaction,s=>{t.polls.delete(s.getId())})}catch{}return}var i=e.relationEventId;if(i&&t.polls.has(i)){var a=t.polls.get(i);a==null||a.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return w(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var n=e===Kr.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:i,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,ke.Backward,n.threadListType,n.getFilter());if(n.getLiveTimeline().setPaginationToken(a??null,ke.Backward),!!i.length){var s=i.map(t.client.getEventMapper());t.processThreadRoots(s,!0);var o=t.getLiveTimeline().getState(se.FORWARDS);for(var l of s)n.addLiveEvent(l,{duplicateStrategy:Io.Replace,fromCache:!1,roomState:o,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var n=this.getTimelineForEvent(e.id),i=n==null||(t=n.getEvents())===null||t===void 0?void 0:t.find(s=>s.getId()===e.id);i?e.clearEventMetadata(i):T.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i;if(!((i=this.client)!==null&&i!==void 0&&i.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||n!=null&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(ze.name),s=e.getAssociatedId(),o=e.threadRootId;if(s&&!a&&(o===s||n!=null&&n.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var l;if(s){var u;l=(u=this.findEventById(s))!==null&&u!==void 0?u:t==null?void 0:t.find(d=>d.getId()===s)}return l&&!a?this.eventShouldLiveIn(l,t,n):o!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getThread(e);if(i)i.addEvents(t,n);else{var a,s=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(o=>o.getId()===e);this.createThread(e,s,t,n)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var n={};for(var i of e){var a,{threadId:s,shouldLiveInThread:o}=this.eventShouldLiveIn(i);o&&!n[s]&&(n[s]=[]),(a=n[s])===null||a===void 0||a.push(i)}Object.entries(n).map(l=>{var[u,d]=l;return this.addThreadedEvents(u,d,t)})}createThread(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var s=this.relations.getAllChildEventsForEvent(t.getId());s!=null&&s.length&&(i=i.concat(s.filter(l=>!l.isRelation(it.Replace))))}var o=new Xe(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(n=this.cachedThreadReadReceipts.get(e))!==null&&n!==void 0?n:[]});return this.reEmitter.reEmit(o,[Zt.Delete,Zt.Update,Zt.NewReply,le.Timeline,le.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(o.id,o),o.addEvents(i,!1),this.threadsReady&&o.initialEventsFetched&&this.updateThreadRootEvents(o,a,!1),this.emit(Zt.New,o,a),o}applyEventAsRedaction(e,t){var n=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var i=this.currentState.getStateEvents(t.getType(),t.getStateKey());(i==null?void 0:i.getId())===t.getId()&&this.currentState.setStateEvents([t])}this.emit(le.Redaction,e,this,n),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[n,i]of this.txnToEvent)if(i.getId()===e.getId()){T.debug("processLiveEvent: found sent event without txn ID: ",n,e.getId());var a=e.getUnsigned();a.transaction_id=n,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:n,timelineWasEmpty:i,fromCache:a,addToState:s}=t;for(var o of this.timelineSets)o.addLiveEvent(e,{duplicateStrategy:n,fromCache:a,timelineWasEmpty:i,addToState:s});e.sender&&e.getType()!==j.RoomRedaction&&this.addReceipt(f0(e.sender.userId,e,Xt.Read),!0)}addPendingEvent(e,t){if(e.status!==Se.SENDING&&e.status!==Se.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(se.setEventMetadata(e,this.getLiveTimeline().getState(se.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(s=>s.status===Se.NOT_SENT)&&(T.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(Se.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n=e.event.redacts,i=this.pendingEventList.find(s=>s.getId()===n);!i&&n&&(i=this.findEventById(n)),i&&(i.markLocallyRedacted(e),this.emit(le.Redaction,e,this,i.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(le.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Ys(Ys({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var n=t.type===j.RoomMessageEncrypted,i=this.hasEncryptionStateEvent();return n||!i});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var n=t.getId(),i=e.getId(),a=t.status;T.debug("Got remote echo for event ".concat(n," -> ").concat(i," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:s,threadId:o}=this.eventShouldLiveIn(e),l=o?this.getThread(o):null;if(l==null||l.setEventMetadata(t),l==null||l.timelineSet.handleRemoteEcho(t,n,i),s)for(var u of this.timelineSets)u.handleRemoteEcho(t,n,i);this.emit(le.LocalEchoUpdated,t,this,n,a)}updatePendingEvent(e,t,n){if(T.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(n)),t==Se.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==Se.SENT){var i=this.getTimelineForEvent(n);if(i){var a=this.findEventById(n),s=a==null?void 0:a.getUnsigned().transaction_id;if(!s&&a){var o=a.getUnsigned();o.transaction_id=e.getTxnId(),a.setUnsigned(o),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var l=e.status,u=e.getId();if(!l)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var d=eA[l];if(!(d!=null&&d.includes(t)))throw new Error("Invalid EventStatus transition ".concat(l,"->").concat(t));if(e.setStatus(t),t==Se.SENT){e.replaceLocalEventId(n);var{shouldLiveInRoom:h,threadId:f}=this.eventShouldLiveIn(e),m=f?this.getThread(f):void 0;if(m==null||m.setEventMetadata(e),m==null||m.timelineSet.replaceEventId(u,n),h)for(var v of this.timelineSets)v.replaceEventId(u,n)}else if(t==Se.CANCELLED){if(this.pendingEventList){var y=this.getPendingEvent(u);this.removePendingEvent(u),y!=null&&y.isRedaction()&&this.revertRedactionLocalEcho(y)}this.removeEvent(u)}this.savePendingEvents(),this.emit(le.LocalEchoUpdated,e,this,u,l)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(le.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(se.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(se.FORWARDS)+")");if(t.getNeighbouringTimeline(se.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return w(function*(){var{duplicateStrategy:i,fromCache:a,timelineWasEmpty:s=!1,addToState:o}=t;if(i&&["replace","ignore"].indexOf(i)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var l=n.findThreadRoots(e),u={},d={duplicateStrategy:i,fromCache:a,timelineWasEmpty:s,addToState:o},h=[...e];for(var f of e){var m;if(n.processLiveEvent(f),f.getUnsigned().transaction_id){var v=n.txnToEvent.get(f.getUnsigned().transaction_id);if(v){n.handleRemoteEcho(f,v);continue}}var{shouldLiveInRoom:y,shouldLiveInThread:I,threadId:g=""}=n.eventShouldLiveIn(f,h,l);if(!I&&!y&&f.isRelation())try{var p=new zt(yield n.client.fetchRoomEvent(n.roomId,f.relationEventId));if(h.push(p),p.threadRootId){l.add(p.threadRootId);var b=f.getUnsigned();b[md.name]=p.threadRootId,f.setUnsigned(b)}({shouldLiveInRoom:y,shouldLiveInThread:I,threadId:g=""}=n.eventShouldLiveIn(f,h,l))}catch(R){T.error("Failed to load parent event of unhandled relation",R)}I&&!u[g]&&(u[g]=[]),(m=u[g])===null||m===void 0||m.push(f),y?n.addLiveEvent(f,d):!I&&f.isRelation()&&n.relations.aggregateChildEvent(f)}Object.entries(u).forEach(R=>{var[P,E]=R;n.addThreadedEvents(P,E,!1)})})()}partitionThreadedEvents(e){var t=0,n=1,i=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((s,o)=>{var{shouldLiveInRoom:l,shouldLiveInThread:u,threadId:d}=this.eventShouldLiveIn(o,e,a);return l&&s[t].push(o),u&&(o.setThreadId(d??""),s[n].push(o)),!u&&!l&&s[i].push(o),s},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var n of e){var i=n.threadRootId;i!=null&&t.add(i)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(a=>{Object.keys(n[i][a]).forEach(s=>{var o,l,u,d=n[i][a][s],h=!d.thread_id||d.thread_id===_l,f=h?this:this.threads.get((o=d.thread_id)!==null&&o!==void 0?o:"");if(f){if(f.addReceiptToStructure(i,a,s,d,t),!t&&this.client.isInitialSyncComplete()&&s===this.client.getUserId()){var m=f.timeline[f.timeline.length-1];m&&i===m.getId()&&s===m.getSender()&&(f.setUnread(We.Total,0),f.setUnread(We.Highlight,0))}}else{var v;this.cachedThreadReadReceipts.set(d.thread_id,[...(v=this.cachedThreadReadReceipts.get(d.thread_id))!==null&&v!==void 0?v:[],{eventId:i,receiptType:a,userId:s,receipt:d,synthetic:t}])}var y=this.client.getUserId();s===y&&!h&&d.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=d.ts),!d.thread_id&&d.ts>((l=(u=this.unthreadedReceipts.get(s))===null||u===void 0?void 0:u.ts)!==null&&l!==void 0?l:0)&&this.unthreadedReceipts.set(s,d)})})}),this.emit(le.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===j.Typing?this.currentState.setTypingEvent(t):t.getType()===j.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var n of this.timelineSets){var i=n.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(j.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Ie.Invite){var n=e.getUnsigned().invite_room_state||[];n.forEach(a=>{var s=this.currentState.getStateEvents(a.type,a.state_key);s||this.currentState.setStateEvents([new zt({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var i=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=vO(this.name),this.summary=new Zb(this.roomId,{title:this.name}),i!==this.name&&this.emit(le.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(le.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var n=t.getType(),i=this.accountData.get(n);this.accountData.set(n,t),this.emit(le.AccountData,t,this,i)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===Ie.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(j.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(j.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Ie.Join,n=this.currentState.getStateEvents(j.RoomPowerLevels,""),i=n&&n.getContent(),a=this.getMember(e);return i&&a&&i.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(j.RoomCreate,"");if(!e){this.getTypeWarning||(T.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[pd]}isSpaceRoom(){return this.getType()===Za.Space}isCallRoom(){return this.getType()===Za.UnstableCall}isElementVideoRoom(){return this.getType()===Za.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(se.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case nn.Actual:return e.name;case nn.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(My(e.names,e.count));default:return My(e.names,e.count)}case nn.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var n=this.currentState.getStateEvents(j.RoomName,"");if(n!=null&&n.getContent().name)return this.roomNameGenerator({type:nn.Actual,name:n.getContent().name})}var i=this.getCanonicalAlias();if(i)return this.roomNameGenerator({type:nn.Actual,name:i});var a=this.currentState.getJoinedMemberCount(),s=this.currentState.getInvitedMemberCount(),o=a+s-1,l=this.getFunctionalMembers(),u=[];if(this.heroes)this.heroes.forEach(g=>{if(l.includes(g.userId)){o--;return}if(g.displayName)u.push(g.displayName);else{var p=this.getMember(g.userId);u.push(p?p.name:g.userId)}});else{var d=this.currentState.getMembers().filter(g=>g.userId!==e&&(g.membership===Ie.Invite||g.membership===Ie.Join));d=d.filter(g=>{var{userId:p}=g;return l.includes(p)?(o--,!1):!0});var h=new Intl.Collator;d.sort((g,p)=>h.compare(g.userId,p.userId)),d=d.slice(0,5),u=d.map(g=>g.name)}if(o)return this.roomNameGenerator({type:nn.Generated,names:u,count:o});var f=this.getMyMembership();if(f==Ie.Join){var m=this.currentState.getStateEvents(j.RoomThirdPartyInvite);if(m!=null&&m.length){var v=m.map(g=>g.getContent().display_name);return this.roomNameGenerator({type:nn.Generated,subtype:"Inviting",names:v,count:v.length+1})}}var y=u;y.length||(y=this.currentState.getMembers().filter(g=>g.userId!==e&&g.membership!==Ie.Invite&&g.membership!==Ie.Join).map(g=>g.name));var I;return y.length&&(I=this.roomNameGenerator({type:nn.Generated,names:y,count:y.length+1})),this.roomNameGenerator({type:nn.EmptyRoom,oldName:I})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var n=e.getSender();if(n){var i=Xi.name&&this.currentState.maySendStateEvent(Xi.name,n)||Xi.altName&&this.currentState.maySendStateEvent(Xi.altName,n);if(i){var a=this.visibilityEvents.get(t.eventId);if(a){for(var s=a.length-1,o=Math.max(0,a.length-ZM);s>=o;--s){var l=a[s];if(l.getTs()<e.getTs())break}s===-1?a.unshift(e):a.splice(s+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var u=this.findEventById(t.eventId);u&&u.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),n=t==null?void 0:t.event_id,i=this.visibilityEvents.get(n);if(i){var a=i.findIndex(u=>u.getId()===e.getId());if(a!==-1&&(i.splice(a,1),a===i.length)){var s=this.findEventById(n);if(!s)return;if(a===0)this.visibilityEvents.delete(n),s.applyVisibilityEvent();else{var o=i[i.length-1],l=o.asVisibilityChange();if(!l)throw new Error("at this stage, visibility changes should be well-formed");s.applyVisibilityEvent(l)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(i))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(i=>this.getThreadUnreadNotificationCount(i.id,We.Total)>0);for(var n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return PM(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(se.FORWARDS))===null||e===void 0)&&e.getStateEvents(j.RoomEncryption,""))}}var eA={[Se.ENCRYPTING]:[Se.SENDING,Se.NOT_SENT,Se.CANCELLED],[Se.SENDING]:[Se.ENCRYPTING,Se.QUEUED,Se.NOT_SENT,Se.SENT],[Se.QUEUED]:[Se.SENDING,Se.NOT_SENT,Se.CANCELLED],[Se.SENT]:[],[Se.NOT_SENT]:[Se.SENDING,Se.QUEUED,Se.CANCELLED],[Se.CANCELLED]:[]},nn=function(r){return r[r.EmptyRoom=0]="EmptyRoom",r[r.Generated=1]="Generated",r[r.Actual=2]="Actual",r}({});function My(r,e){var t=e-1;if(r.length){if(r.length===1&&t<=1)return r[0];if(r.length===2&&t<=2)return"".concat(r[0]," and ").concat(r[1]);var n=t>1;return n?"".concat(r[0]," and ").concat(t," others"):"".concat(r[0]," and 1 other")}else return"Empty room"}var Ct=function(r){return r[r.Stable=0]="Stable",r[r.Unstable=1]="Unstable",r[r.Unsupported=2]="Unsupported",r}({}),kt=function(r){return r.Thread="Thread",r.ThreadUnreadNotifications="ThreadUnreadNotifications",r.LoginTokenRequest="LoginTokenRequest",r.RelationBasedRedactions="RelationBasedRedactions",r.AccountDataDeletion="AccountDataDeletion",r.RelationsRecursion="RelationsRecursion",r.IntentionalMentions="IntentionalMentions",r}({}),tA={[kt.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[kt.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[kt.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[kt.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[kt.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[kt.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[kt.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function rA(r){return dv.apply(this,arguments)}function dv(){return dv=w(function*(r){var e=new Map;for(var[t,n]of Object.entries(tA)){var i,a,s,o,l=(i=(a=r.versions)===null||a===void 0?void 0:a.includes(n.matrixVersion||""))!==null&&i!==void 0?i:!1,u=(s=(o=n.unstablePrefixes)===null||o===void 0?void 0:o.every(d=>{var h;return((h=r.unstable_features)===null||h===void 0?void 0:h[d])===!0}))!==null&&s!==void 0?s:!1;l?e.set(t,Ct.Stable):u?e.set(t,Ct.Unstable):e.set(t,Ct.Unsupported)}return e}),dv.apply(this,arguments)}function Ay(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Rd(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ay(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ay(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var Dy=80*1e3,nA=3,qe=function(r){return r.Error="ERROR",r.Prepared="PREPARED",r.Stopped="STOPPED",r.Syncing="SYNCING",r.Catchup="CATCHUP",r.Reconnecting="RECONNECTING",r}({}),iA=["org.matrix.msc2716v3"];function xy(r,e){return"FILTER_SYNC_".concat(r)+(e?"_"+e:"")}var I0=function(r){return r.Offline="offline",r.Online="online",r.Unavailable="unavailable",r}({});function C0(r){return Rd({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:ws.Chronological,threadSupport:!1},r)}function O0(r){return Rd({canResetEntireTimeline:e=>!1},r)}class di{constructor(e,t,n){var i=this;this.client=e,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"_peekRoom",null),c(this,"currentSyncRequest",void 0),c(this,"abortController",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"catchingUp",!1),c(this,"running",!1),c(this,"keepAliveTimer",void 0),c(this,"connectionReturnedResolvers",void 0),c(this,"notifEvents",[]),c(this,"failedSyncCount",0),c(this,"storeIsInvalid",!1),c(this,"presence",void 0),c(this,"getPushRules",w(function*(){try{i.syncOpts.logger.debug("Getting push rules...");var a=yield i.client.getPushRules();i.syncOpts.logger.debug("Got push rules"),i.client.pushRules=a}catch(s){return i.syncOpts.logger.error("Getting push rules failed",s),i.shouldAbortSync(s)?void 0:(i.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,s),i.getPushRules())}})),c(this,"buildDefaultFilter",()=>{var a=new sr(this.client.credentials.userId);return this.client.canSupport.get(kt.ThreadUnreadNotifications)!==Ct.Unsupported&&a.setUnreadThreadNotifications(!0),a}),c(this,"prepareLazyLoadingForSync",w(function*(){i.syncOpts.logger.debug("Prepare lazy loading for sync..."),i.client.isGuest()&&(i.opts.lazyLoadMembers=!1),i.opts.lazyLoadMembers&&(i.syncOpts.logger.debug("Enabling lazy load on sync filter..."),i.opts.filter||(i.opts.filter=i.buildDefaultFilter()),i.opts.filter.setLazyLoadMembers(!0))})),c(this,"storeClientOptions",w(function*(){try{i.syncOpts.logger.debug("Storing client options..."),yield i.client.storeClientOptions(),i.syncOpts.logger.debug("Stored client options")}catch(a){throw i.syncOpts.logger.error("Storing client options failed",a),a}})),c(this,"getFilter",w(function*(){i.syncOpts.logger.debug("Getting filter...");var a;i.opts.filter?a=i.opts.filter:a=i.buildDefaultFilter();var s;try{s=yield i.client.getOrCreateFilter(xy(i.client.credentials.userId),a)}catch(o){return i.syncOpts.logger.error("Getting filter failed",o),i.shouldAbortSync(o)?{}:(i.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,o),i.getFilter())}return{filter:a,filterId:s}})),c(this,"savedSyncPromise",void 0),c(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=C0(t),this.syncOpts=O0(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[le.Timeline,le.TimelineReset])}createRoom(e){var t=k0(this.client,e,this.opts);return t.on(Ae.Marker,(n,i)=>{this.onMarkerStateEvent(t,n,i)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:n}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var i=iA.includes(e.getVersion())||t.getSender()===e.getCreator();i?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(le.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return w(function*(){var t,n=e.client,i=new sr(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+Dy,s=yield n.getOrCreateFilter(xy(n.credentials.userId,"LEFT_ROOMS"),i),o={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},l=yield n.http.authedRequest(V.Get,"/sync",o,void 0,{localTimeoutMs:a}),u=[];(t=l.rooms)!==null&&t!==void 0&&t.leave&&(u=e.mapSyncResponseToRoomArray(l.rooms.leave));var d=yield Promise.all(u.map(function(){var h=w(function*(f){var m=f.room;if(f.isBrandNewRoom){f.timeline=f.timeline||{prev_batch:null,events:[]},m.getLiveTimeline().setPaginationToken(f.timeline.prev_batch,se.BACKWARDS);var{timelineEvents:v}=yield e.mapAndInjectRoomEvents(f);return m.recalculate(),n.store.storeRoom(m),n.emit(ce.Room,m),e.processEventsForNotifs(m,v),m}});return function(f){return h.apply(this,arguments)}}()));return d.filter(Boolean)})()}peek(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,n).then(a=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var o=bl(a.state).map(i.getEventMapper()),l=a.state.map(i.getEventMapper()),u=a.messages.chunk.map(i.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(i.getEventMapper()).forEach(function(d){var h=i.store.getUser(d.getContent().user_id);h?h.setPresenceEvent(d):(h=Ln.createUser(d.getContent().user_id,i),h.setPresenceEvent(d),i.store.storeUser(h)),i.emit(ce.Event,d)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(o),this._peekRoom.currentState.setStateEvents(l),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(u.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),i.store.storeRoom(this._peekRoom),i.emit(ce.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,i=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(V.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal}).then(function(){var a=w(function*(s){if(i._peekRoom!==e){i.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}s.chunk.filter(function(l){return l.type==="m.presence"}).map(i.client.getEventMapper()).forEach(l=>{var u=i.client.store.getUser(l.getContent().user_id);u?u.setPresenceEvent(l):(u=Ln.createUser(l.getContent().user_id,i.client),u.setPresenceEvent(l),i.client.store.storeUser(u)),i.client.emit(ce.Event,l)});var o=s.chunk.filter(function(l){return l.room_id===e.roomId&&l.event_id}).map(i.client.getEventMapper());yield e.addLiveEvents(o,{addToState:!0}),i.peekPoll(e,s.end)});return function(s){return a.apply(this,arguments)}}(),a=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var n=this;return w(function*(){yield e;var i=n.startKeepAlives();n.updateSyncState(qe.Error,{error:t}),yield i})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(qe.Error,{error:e}),!0):!1}sync(){var e=this;return w(function*(){var t,n;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(n=t.addEventListener)===null||n===void 0||n.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var i=e.client.store.getSavedSyncToken().then(d=>(e.syncOpts.logger.debug("Got saved sync token"),d));e.savedSyncPromise=e.client.store.getSavedSync().then(d=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!d)),d)return e.syncFromCache(d)}).catch(d=>{e.syncOpts.logger.error("Getting saved sync failed",d)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:s}=yield e.getFilter();if(s){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var o=a,l=yield i;if(l)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var u=e.buildDefaultFilter();u.setDefinition(s.getDefinition()),u.setTimelineLimit(e.opts.initialSyncLimit),o=JSON.stringify(u.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:o},l)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,n;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(n=this.abortController)===null||n===void 0||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return w(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var n=e.nextBatch;t.client.store.setSyncToken(n);var i={nextSyncToken:n,catchingUp:!1,fromCache:!0},a={next_batch:n,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(i,a)}catch(s){t.syncOpts.logger.error("Error processing cached sync",s)}t.storeIsInvalid||t.updateSyncState(qe.Prepared,i)})()}doSync(e){var t=this;return w(function*(){for(;t.running;){var n=t.client.store.getSyncToken(),i=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,n)),i=yield t.currentSyncRequest}catch(o){var a=yield t.onSyncError(o);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(i.next_batch),t.failedSyncCount=0;var s={oldSyncToken:n??void 0,nextSyncToken:i.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(s,i)}catch(o){t.syncOpts.logger.error("Caught /sync error",o),t.client.emit(ce.SyncUnexpectedError,o)}yield t.client.store.setSyncData(i),s.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(qe.Prepared,s),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(s)),t.updateSyncState(qe.Syncing,s),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(qe.Stopped))})()}doSyncRequest(e,t){var n,i=this.getSyncParams(e,t);return this.client.http.authedRequest(V.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+Dy,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal})}getSyncParams(e,t){var n=this.opts.pollTimeout;(this.getSyncState()!==qe.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);var i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());var a={filter:i,timeout:n,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=I0.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[qe.Reconnecting,qe.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return w(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(qe.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var n=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=nA?qe.Error:qe.Reconnecting,{error:e});var i=yield n;return i&&t.getSyncState()===qe.Error&&t.updateSyncState(qe.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return w(function*(){var i,a,s,o,l=n.client;if(Array.isArray((i=t.presence)===null||i===void 0?void 0:i.events)&&t.presence.events.filter(Hr).map(l.getEventMapper()).forEach(function(g){var p=l.store.getUser(g.getSender());p?p.setPresenceEvent(g):(p=Ln.createUser(g.getSender(),l),p.setPresenceEvent(g),l.store.storeUser(p)),l.emit(ce.Event,g)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var u=t.account_data.events.filter(Hr).map(l.getEventMapper()),d=u.reduce((g,p)=>(g[p.getType()]=l.store.getAccountData(p.getType()),g),{});l.store.storeAccountDataEvents(u),u.forEach(function(g){if(g.getType()===j.PushRules){var p=g.getContent();l.setPushRules(p)}var b=d[g.getType()];return l.emit(ce.AccountData,g,b),g})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var h=t.to_device.events.filter(Hr),f;n.syncOpts.cryptoCallbacks?f=yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h):f=h.map(g=>({message:g,encryptionInfo:null})),P0(f,l)}else n.catchingUp=!1;var m=[],v=[],y=[],I=[];t.rooms&&(t.rooms.invite&&(m=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(v=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(y=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(I=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Ka(m,function(){var g=w(function*(p){var b=p.room,R=n.mapSyncEventsFormat(p.invite_state,b);yield n.injectRoomEvents(b,R,void 0),p.isBrandNewRoom?(b.recalculate(),l.store.storeRoom(b),l.emit(ce.Room,b)):b.recalculate(),R.forEach(function(P){l.emit(ce.Event,P)})});return function(p){return g.apply(this,arguments)}}()),yield Ka(v,function(){var g=w(function*(p){var b,R=p.room,P=n.mapSyncEventsFormat(p.state,R),E=n.mapSyncEventsFormat(p["org.matrix.msc4222.state_after"],R),C=n.mapSyncEventsFormat(p.timeline,R,!1),S=n.mapSyncEventsFormat(p.ephemeral),x=n.mapSyncEventsFormat(p.account_data),K=p["org.matrix.msc4222.state_after"]?E:P.concat(C),z=n.isRoomEncrypted(R,K);if(p.unread_notifications){if(!z||p.unread_notifications.notification_count===0){var oe;R.setUnreadNotificationCount(We.Total,(oe=p.unread_notifications.notification_count)!==null&&oe!==void 0?oe:0)}if(!z||R.getUnreadNotificationCount(We.Highlight)<=0){var ge;R.setUnreadNotificationCount(We.Highlight,(ge=p.unread_notifications.highlight_count)!==null&&ge!==void 0?ge:0)}}var xe=(b=p[nl.name])!==null&&b!==void 0?b:p[nl.altName];if(xe){R.resetThreadUnreadNotificationCountFromSync(Object.keys(xe));for(var[_e,Me]of Object.entries(xe)){if(!z||Me.notification_count===0){var je;R.setThreadUnreadNotificationCount(_e,We.Total,(je=Me.notification_count)!==null&&je!==void 0?je:0)}var re=R.getThreadUnreadNotificationCount(_e,We.Highlight)<=0;if(!z||z&&re){var he;R.setThreadUnreadNotificationCount(_e,We.Highlight,(he=Me.highlight_count)!==null&&he!==void 0?he:0)}}}else R.resetThreadUnreadNotificationCountFromSync();if(p.timeline=p.timeline||{},p.isBrandNewRoom)p.timeline.prev_batch!==null&&R.getLiveTimeline().setPaginationToken(p.timeline.prev_batch,se.BACKWARDS);else if(p.timeline.limited){for(var ye=!0,Ne=C.length-1;Ne>=0;Ne--){var J=C[Ne].getId();if(R.getTimelineForEvent(J)){n.syncOpts.logger.debug("Already have event ".concat(J," in limited sync - not resetting")),ye=!1,C.splice(0,Ne);break}}if(ye){var te;R.resetLiveTimeline(p.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(R.roomId)?null:(te=e.oldSyncToken)!==null&&te!==void 0?te:null),l.resetNotifTimelineSet()}}if(n.syncOpts.cryptoCallbacks)for(var L of K)L.isState()&&L.getType()===j.RoomEncryption&&L.getStateKey()===""&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(R,L));try{"org.matrix.msc4222.state_after"in p?yield n.injectRoomEvents(R,void 0,E,C,e.fromCache):yield n.injectRoomEvents(R,P,void 0,C,e.fromCache)}catch(A){n.syncOpts.logger.error("Failed to process events on room ".concat(R.roomId,":"),A)}p.summary&&R.setSummary(p.summary),R.addEphemeralEvents(S),R.addAccountData(x),R.recalculate(),p.isBrandNewRoom&&(l.store.storeRoom(R),l.emit(ce.Room,R)),n.processEventsForNotifs(R,C);var D=A=>l.emit(ce.Event,A);P.forEach(D),C.forEach(D),S.forEach(D),x.forEach(D),R.decryptCriticalEvents()});return function(p){return g.apply(this,arguments)}}()),yield Ka(y,function(){var g=w(function*(p){var b=p.room,{timelineEvents:R,stateEvents:P,stateAfterEvents:E}=yield n.mapAndInjectRoomEvents(p),C=n.mapSyncEventsFormat(p.account_data);b.addAccountData(C),b.recalculate(),p.isBrandNewRoom&&(l.store.storeRoom(b),l.emit(ce.Room,b)),n.processEventsForNotifs(b,R),P==null||P.forEach(function(S){l.emit(ce.Event,S)}),E==null||E.forEach(function(S){l.emit(ce.Event,S)}),R.forEach(function(S){l.emit(ce.Event,S)}),C.forEach(function(S){l.emit(ce.Event,S)})});return function(p){return g.apply(this,arguments)}}()),yield Ka(I,function(){var g=w(function*(p){var b=p.room,R=n.mapSyncEventsFormat(p.knock_state,b);yield n.injectRoomEvents(b,R,void 0),p.isBrandNewRoom?(b.recalculate(),l.store.storeRoom(b),l.emit(ce.Room,b)):b.recalculate(),R.forEach(function(P){l.emit(ce.Event,P)})});return function(p){return g.apply(this,arguments)}}()),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(g,p){return g.getTs()-p.getTs()}),n.notifEvents.forEach(function(g){var p;(p=l.getNotifTimelineSet())===null||p===void 0||p.addLiveEvent(g,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(s=n.syncOpts.cryptoCallbacks)===null||s===void 0?void 0:s.processKeyCounts(t.device_one_time_keys_count,(o=t.device_unused_fallback_key_types)!==null&&o!==void 0?o:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var n=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(V.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{n()},i=>{i.httpStatus==400||i.httpStatus==404?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(qe.Error,{error:i}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(n=>!wo(n)).map(n=>{var i=t.store.getRoom(n),a=!1;return i||(i=this.createRoom(n),a=!0),Rd(Rd({},e[n]),{},{room:i,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var i=this.client.getEventMapper({decrypt:n});return e.events.filter(Hr).map(function(a){return t&&(a.room_id=t.roomId),i(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ie.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var o=n.events.member;(o==null?void 0:o.getContent().membership)===Ie.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,n.setMembershipEvent(o,e.currentState))},function(s){})}})}}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===j.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return w(function*(){var n=t.mapSyncEventsFormat(e.state,e.room),i=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,i,a):yield t.injectRoomEvents(e.room,n,void 0,a),{timelineEvents:a,stateEvents:n,stateAfterEvents:i}})()}injectRoomEvents(e,t,n,i){var a=arguments,s=this;return w(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:!1,l=n??t,u=e.getLiveTimeline(),d=u.getEvents().length==0;if(d){for(var h of l)s.client.getPushActionsForEvent(h);u.initialiseState(l,{timelineWasEmpty:d})}s.resolveInvites(e),e.recalculate(),d||(e.oldState.setStateEvents(l),e.currentState.setStateEvents(l)),yield e.addLiveEvents(i||[],{fromCache:o,timelineWasEmpty:d,addToState:n===void 0}),s.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var n of t){var i,a=this.client.getPushActionsForEvent(n);a!=null&&a.notify&&(i=a.tweaks)!==null&&i!==void 0&&i.highlight&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ce.Sync,this.syncState,n,t)}}function k0(r,e,t){var{timelineSupport:n}=r,i=new uc(e,r,r.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:n});return r.reEmitter.reEmit(i,[le.Name,le.Redaction,le.RedactionCancelled,le.Receipt,le.Tags,le.LocalEchoUpdated,le.AccountData,le.MyMembership,le.Timeline,le.TimelineReset,Ae.Events,Ae.Members,Ae.NewMember,Ae.Update,tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),i.on(Ae.NewMember,(a,s,o)=>{var l;o.user=(l=r.getUser(o.userId))!==null&&l!==void 0?l:void 0,r.reEmitter.reEmit(o,[ur.Name,ur.Typing,ur.PowerLevel,ur.Membership])}),i}function P0(r,e){var t=[];r.map(n=>{if(n.message.type==="m.key.verification.cancel"){var i=n.message.content.transaction_id;i&&t.push(i)}return n}).forEach(function(n){{var i=n.message,a=i.content,s=new zt(Object.assign({},i));if(i.type==="m.key.verification.start"||i.type==="m.key.verification.request"){var o=a.transaction_id;t.includes(o)&&s.flagCancelled()}n.encryptionInfo&&s.makeEncrypted(j.RoomMessageEncrypted,{ciphertext:""},n.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(ce.ToDeviceEvent,s)}e.emit(ce.ReceivedToDeviceMessage,n)})}class aA{constructor(){c(this,"accountData",new Map),c(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return w(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return w(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return w(function*(){return Promise.resolve()})()}destroy(){return w(function*(){})()}}const Ut=[];for(let r=0;r<256;++r)Ut.push((r+256).toString(16).slice(1));function sA(r,e=0){return(Ut[r[e+0]]+Ut[r[e+1]]+Ut[r[e+2]]+Ut[r[e+3]]+"-"+Ut[r[e+4]]+Ut[r[e+5]]+"-"+Ut[r[e+6]]+Ut[r[e+7]]+"-"+Ut[r[e+8]]+Ut[r[e+9]]+"-"+Ut[r[e+10]]+Ut[r[e+11]]+Ut[r[e+12]]+Ut[r[e+13]]+Ut[r[e+14]]+Ut[r[e+15]]).toLowerCase()}let ch;const oA=new Uint8Array(16);function lA(){if(!ch){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ch=crypto.getRandomValues.bind(crypto)}return ch(oA)}const uA=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ny={randomUUID:uA};function dA(r,e,t){var i;if(Ny.randomUUID&&!r)return Ny.randomUUID();r=r||{};const n=r.random??((i=r.rng)==null?void 0:i.call(r))??lA();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,sA(n)}var M0={},A0={exports:{}},Ly=A0.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Ly).forEach(function(r){var e=Ly[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var D0=A0.exports;(function(r){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,l,u,d){if(d&&!u)l[d]=e(o[1]);else for(var h=0;h<u.length;h+=1)o[h+1]!=null&&(l[u[h]]=e(o[h+1]))},n=function(o,l,u){var d=o.name&&o.names;o.push&&!l[o.push]?l[o.push]=[]:d&&!l[o.name]&&(l[o.name]={});var h=o.push?{}:d?l[o.name]:l;t(u.match(o.reg),h,o.names,o.name),o.push&&l[o.push].push(h)},i=D0,a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(o){var l={},u=[],d=l;return o.split(/(\r\n|\r|\n)/).filter(a).forEach(function(h){var f=h[0],m=h.slice(2);f==="m"&&(u.push({rtp:[],fmtp:[]}),d=u[u.length-1]);for(var v=0;v<(i[f]||[]).length;v+=1){var y=i[f][v];if(y.reg.test(m))return n(y,d,m)}}),l.media=u,l};var s=function(o,l){var u=l.split(/=(.+)/,2);return u.length===2?o[u[0]]=e(u[1]):u.length===1&&l.length>1&&(o[u[0]]=void 0),o};r.parseParams=function(o){return o.split(/;\s?/).reduce(s,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(o){return o.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(o){for(var l=[],u=o.split(" ").map(e),d=0;d<u.length;d+=3)l.push({component:u[d],ip:u[d+1],port:u[d+2]});return l},r.parseImageAttributes=function(o){return o.split(" ").map(function(l){return l.substring(1,l.length-1).split(",").reduce(s,{})})},r.parseSimulcastStreamList=function(o){return o.split(";").map(function(l){return l.split(",").map(function(u){var d,h=!1;return u[0]!=="~"?d=e(u):(d=e(u.substring(1,u.length)),h=!0),{scid:d,paused:h}})})}})(M0);var hh=D0,cA=/%[sdv%]/g,hA=function(r){var e=1,t=arguments,n=t.length;return r.replace(cA,function(i){if(e>=n)return i;var a=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(a);case"%d":return Number(a);case"%v":return""}})},Qs=function(r,e,t){var n=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[r+"="+n];if(e.names)for(var a=0;a<e.names.length;a+=1){var s=e.names[a];e.name?i.push(t[e.name][s]):i.push(t[e.names[a]])}else i.push(t[e.name]);return hA.apply(null,i)},fA=["v","o","s","i","u","e","p","c","b","t","r","z","a"],vA=["i","c","b","a"],pA=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(a){a.payloads==null&&(a.payloads="")});var t=e.outerOrder||fA,n=e.innerOrder||vA,i=[];return t.forEach(function(a){hh[a].forEach(function(s){s.name in r&&r[s.name]!=null?i.push(Qs(a,s,r)):s.push in r&&r[s.push]!=null&&r[s.push].forEach(function(o){i.push(Qs(a,s,o))})})}),r.media.forEach(function(a){i.push(Qs("m",hh.m[0],a)),n.forEach(function(s){hh[s].forEach(function(o){o.name in a&&a[o.name]!=null?i.push(Qs(s,o,a)):o.push in a&&a[o.push]!=null&&a[o.push].forEach(function(l){i.push(Qs(s,o,l))})})})}),i.join(`\r
`)+`\r
`},ya=M0,mA=pA,gA=mA,x0=ya.parse;ya.parseParams;ya.parseFmtpConfig;ya.parsePayloads;ya.parseRemoteCandidates;ya.parseImageAttributes;ya.parseSimulcastStreamList;function Hp(r,e){if(typeof r.toBase64=="function")return r.toBase64(e);var t=btoa(r.reduce((n,i)=>n+String.fromCharCode(i),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}function Co(r){return Hp(r,{alphabet:"base64",omitPadding:!1})}function N0(r){return Hp(r,{alphabet:"base64",omitPadding:!0})}function dc(r){return Hp(r,{alphabet:"base64url",omitPadding:!0})}function yA(r,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(r,e):Uint8Array.from(atob(r),t=>t.charCodeAt(0))}function ra(r){return yA(r.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}var SA="abcdefghijklmnopqrstuvwxyz",EA="ABCDEFGHIJKLMNOPQRSTUVWXYZ",_A="0123456789";function bA(r){var e=new Uint8Array(r);return globalThis.crypto.getRandomValues(e),dc(e)}function bi(r){return wA(r,EA+SA+_A)}function wA(r,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(r<1||r>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,n=new Uint8Array(Math.floor(r*1.3)),i=n.length,a=[];a.length<r;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var s=n[i++];s<t&&a.push(e[s%e.length])}return a.join("")}var Jn="org.matrix.msc3077.sdp_stream_metadata",Qe=function(r){return r.Usermedia="m.usermedia",r.Screenshare="m.screenshare",r}({}),Oo=null,cv=0,TA=()=>(Oo===null&&(Oo=new AudioContext),cv++,Oo),RA=()=>{if(cv--,cv===0){var r;(r=Oo)===null||r===void 0||r.close(),Oo=null}},IA=200,hv=-60,CA=8,an=function(r){return r.NewStream="new_stream",r.MuteStateChanged="mute_state_changed",r.LocalVolumeChanged="local_volume_changed",r.VolumeChanged="volume_changed",r.ConnectedChanged="connected_changed",r.Speaking="speaking",r.Disposed="disposed",r}({});class On extends nt{constructor(e){super(),c(this,"stream",void 0),c(this,"sdpMetadataStreamId",void 0),c(this,"userId",void 0),c(this,"deviceId",void 0),c(this,"purpose",void 0),c(this,"speakingVolumeSamples",void 0),c(this,"client",void 0),c(this,"call",void 0),c(this,"roomId",void 0),c(this,"audioMuted",void 0),c(this,"videoMuted",void 0),c(this,"localVolume",1),c(this,"measuringVolumeActivity",!1),c(this,"audioContext",void 0),c(this,"analyser",void 0),c(this,"frequencyBinCount",void 0),c(this,"speakingThreshold",hv),c(this,"speaking",!1),c(this,"volumeLooperTimeout",void 0),c(this,"_disposed",!1),c(this,"_connected",!1),c(this,"onAddTrack",()=>{this.emit(an.NewStream,this.stream)}),c(this,"onCallState",t=>{t===Te.Connected?this.connected=!0:t===Te.Connecting&&(this.connected=!1)}),c(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(an.VolumeChanged,t);var i=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.emit(an.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,IA)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(CA).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(Pe.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(an.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var n=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),n&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(an.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=TA()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t==null?void 0:t.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(an.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(an.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return T.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Qe.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new On({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(Pe.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,RA()),this._disposed=!0,this.emit(an.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(an.LocalVolumeChanged,e)}}var OA=3e3,fv=function(r){return r.Incoming="Call.incoming",r}({});class kA{constructor(e){c(this,"calls",void 0),c(this,"callEventBuffer",void 0),c(this,"nextSeqByCall",new Map),c(this,"toDeviceEventBuffers",new Map),c(this,"client",void 0),c(this,"candidateEventsByCall",void 0),c(this,"eventBufferPromiseChain",void 0),c(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),c(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),c(this,"onToDeviceEvent",t=>{var n=t.getContent();if(!n.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(n.call_id)||this.nextSeqByCall.set(n.call_id,0),n.seq===void 0){this.callEventBuffer.push(t);return}var i=this.nextSeqByCall.get(n.call_id)||0;if(n.seq!==i){this.toDeviceEventBuffers.has(n.call_id)||this.toDeviceEventBuffers.set(n.call_id,[]);var a=this.toDeviceEventBuffers.get(n.call_id),s=a.findIndex(d=>d.getContent().seq>n.seq);s===-1?a.push(t):a.splice(s,0,t)}else{var o=n.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(o,n.seq+1);for(var l=this.toDeviceEventBuffers.get(o),u=l&&l.shift();u&&u.getContent().seq===this.nextSeqByCall.get(o);)this.callEventBuffer.push(u),this.nextSeqByCall.set(o,u.getContent().seq+1),u=l.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ce.Sync,this.onSync),this.client.on(le.Timeline,this.onRoomTimeline),this.client.on(ce.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ce.Sync,this.onSync),this.client.removeListener(le.Timeline,this.onRoomTimeline),this.client.removeListener(ce.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return w(function*(){yield Promise.all(e.map(d=>t.client.decryptEventIfNeeded(d)));var n=e.filter(d=>{var h=d.getType();return h.startsWith("m.call.")||h.startsWith("org.matrix.call.")}),i=new Set;for(var a of n){var s=a.getType();(s===j.CallAnswer||s===j.CallHangup)&&i.add(a.getContent().call_id)}for(var o of n){var l=o.getType(),u=o.getContent().call_id;if(!(l===j.CallInvite&&i.has(u)))try{yield t.handleCallEvent(o)}catch(d){T.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",d)}}})()}handleCallEvent(e){var t=this;return w(function*(){var n;t.client.emit(ce.ReceivedVoipEvent,e);var i=e.getContent(),a=e.getRoomId()||((n=t.client.groupCallEventHandler.getGroupCallById(i.conf_id))===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.roomId),s=i.conf_id,o=e.getType(),l=e.getSender(),u=i.call_id?t.calls.get(i.call_id):void 0,d,h;if(s){if(h=t.client.groupCallEventHandler.getGroupCallById(s),!h){T.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(s,", type=").concat(o,")"));return}if(d=i.device_id,!d){T.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(l,")")),h.emit(Ye.Error,new j0(l));return}if(i.dest_session_id!==t.client.getSessionId()){T.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var f=l===t.client.credentials.userId&&(d===void 0||d===t.client.getDeviceId());if(a){if(o===j.CallInvite){var m,v,y;if(f||e.getLocalAge()>i.lifetime-OA||u&&u.state===Te.Ended||(u&&T.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(i.call_id,")")),i.invitee&&i.invitee!==t.client.getUserId()))return;var I=((m=t.client.getTurnServersExpiry())!==null&&m!==void 0?m:0)-Date.now();if(T.info("CallEventHandler handleCallEvent() current turn creds expire in "+I+" ms"),u=(v=al(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:d,groupCallId:s,opponentSessionId:i.sender_session_id}))!==null&&v!==void 0?v:void 0,!u){T.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(i.call_id,")"));return}u.callId=i.call_id;var g=(y=h)===null||y===void 0?void 0:y.getGroupCallStats();g&&u.initStats(g);try{yield u.initWithInvite(e)}catch(x){if(x instanceof Rn)if(x.code===Po.UnknownDevice){var p;(p=h)===null||p===void 0||p.emit(Ye.Error,x)}else T.error(x)}if(t.calls.set(u.callId,u),t.candidateEventsByCall.get(u.callId))for(var b of t.candidateEventsByCall.get(u.callId))u.onRemoteIceCandidatesReceived(b);var R;for(var P of t.calls.values()){var E,C=[Te.WaitLocalMedia,Te.CreateOffer,Te.InviteSent].includes(P.state);if(u.roomId===P.roomId&&P.direction===Zn.Outbound&&((E=u.getOpponentMember())===null||E===void 0?void 0:E.userId)===P.invitee&&C){R=P;break}}R?R.callId>u.callId?(T.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(u.callId,", outgoingId=").concat(R.callId,")")),R.replacedBy(u)):(T.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(u.callId,", outgoingId=").concat(R.callId,")")),u.hangup(Oe.Replaced,!0)):t.client.emit(fv.Incoming,u);return}else if(o===j.CallCandidates){if(f)return;u?u.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(i.call_id)||t.candidateEventsByCall.set(i.call_id,[]),t.candidateEventsByCall.get(i.call_id).push(e));return}else if([j.CallHangup,j.CallReject].includes(o)){if(u)u.state!==Te.Ended&&(o===j.CallHangup?u.onHangupReceived(i):u.onRejectReceived(i),u.state===Te.Ended&&t.calls.delete(i.call_id));else{var S;u=(S=al(t.client,a,{opponentDeviceId:d,opponentSessionId:i.sender_session_id}))!==null&&S!==void 0?S:void 0,u&&(u.callId=i.call_id,u.initWithHangup(e),t.calls.set(i.call_id,u))}return}if(!u||!u.hasPeerConnection){T.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(o,")"));return}if(e.getContent().party_id!==u.ourPartyId)switch(o){case j.CallAnswer:f?u.state===Te.Ringing&&u.onAnsweredElsewhere(i):u.onAnswerReceived(e);break;case j.CallSelectAnswer:u.onSelectAnswerReceived(e);break;case j.CallNegotiate:u.onNegotiateReceived(e);break;case j.CallAssertedIdentity:case j.CallAssertedIdentityPrefix:u.onAssertedIdentityReceived(e);break;case j.CallSDPStreamMetadataChanged:case j.CallSDPStreamMetadataChangedPrefix:u.onSDPStreamMetadataChangedReceived(e);break}}})()}}var vv=function(r){return r.Incoming="GroupCall.incoming",r.Outgoing="GroupCall.outgoing",r.Ended="GroupCall.ended",r.Participants="GroupCall.participants",r}({});class PA{constructor(e){this.client=e,c(this,"groupCalls",new Map),c(this,"roomDeferreds",new Map),c(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),c(this,"onRoomStateChanged",(t,n)=>{var i=t.getType();if(i===j.GroupCallPrefix){var a=t.getStateKey(),s=t.getContent(),o=this.groupCalls.get(n.roomId);!o&&!s["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):o&&o.groupCallId===a?s["m.terminated"]||t.isRedacted()?o.terminate(!1):s["m.type"]!==o.type&&T.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(n.roomId,")")):o&&o.groupCallId!==a&&T.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(n.roomId,")"))}})}start(){var e=this;return w(function*(){e.client.getSyncState()!==qe.Syncing&&(T.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(i=>{var a=()=>{if(e.client.getSyncState()===qe.Syncing)return e.client.off(ce.Sync,a),i()};e.client.on(ce.Sync,a)}));var t=e.client.getRooms();for(var n of t)e.createGroupCallForRoom(n);e.client.on(ce.Room,e.onRoomsChanged),e.client.on(Ae.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(ce.Room,this.onRoomsChanged),this.client.removeListener(Ae.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var n;t={prom:new Promise(i=>{n=i})},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(j.GroupCallPrefix),n=t.sort((s,o)=>o.getTs()-s.getTs());for(var i of n){var a=i.getContent();if(!(a["m.terminated"]||i.isRedacted())){T.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(i.getStateKey(),", ts=").concat(i.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(i);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(t);if(!i){T.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),s=n["m.type"];if(!Object.values(cc).includes(s)){T.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(t,")"));return}var o=n["m.intent"];if(!Object.values(U0).includes(o)){T.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(t,")"));return}var l=!!n["io.element.ptt"],u;if(n!=null&&n.dataChannelsEnabled&&n!==null&&n!==void 0&&n.dataChannelOptions){var{ordered:d,maxPacketLifeTime:h,maxRetransmits:f,protocol:m}=n.dataChannelOptions;u={ordered:d,maxPacketLifeTime:h,maxRetransmits:f,protocol:m}}var v=new zp(this.client,i,s,l,o,a,(n==null?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,u,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,v),this.client.emit(vv.Incoming,v),v}}class MA{constructor(){c(this,"bandwidth",{}),c(this,"bitrate",{}),c(this,"packetLoss",{}),c(this,"transport",[])}}class AA{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,n=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:n?Math.round(n/1e3):0}}}class DA{static buildReport(e,t,n,i){var a=e==null?void 0:e.get(t.localCandidateId),s=e==null?void 0:e.get(t.remoteCandidateId);if(s&&a){var o=s.ip!==void 0?s.ip:s.address,l=s.port,u="".concat(o,":").concat(l),d=a.ip!==void 0?a.ip:a.address,h=a.port,f="".concat(d,":").concat(h),m=s.protocol;n.some(v=>v.ip===u&&v.type===m&&v.localIp===f)||n.push({ip:u,type:m,localIp:f,isFocus:i,localCandidateType:a.candidateType,remoteCandidateType:s.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return n}}class xA{constructor(){c(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var n;return this.ssrcToMid[t].forEach((i,a)=>{if(i.find(s=>s==e)){n=a;return}}),n}parse(e,t){var n=x0(e),i=new Map;n.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var s,o=[];(s=a.ssrcs)===null||s===void 0||s.forEach(l=>{l.attribute==="cname"&&o.push("".concat(l.id))}),i.set("".concat(a.mid),o)}}),this.ssrcToMid[t]=i}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class NA{constructor(e){this.pc=e}getLocalTracks(e){var t=n=>n!==null&&n.kind===e;return this.pc.getTransceivers().filter(n=>n.currentDirection==="sendonly"||n.currentDirection==="sendrecv").filter(n=>n.sender!==null).map(n=>n.sender).map(n=>n.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class LA{constructor(e,t,n){this.trackId=e,this.type=t,this.kind=n,c(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),c(this,"bitrate",{download:0,upload:0}),c(this,"resolution",{width:-1,height:-1}),c(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),c(this,"framerate",0),c(this,"jitter",0),c(this,"codec",""),c(this,"isAlive",!0),c(this,"isMuted",!1),c(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class UA{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,c(this,"track2stats",new Map)}findTrack2Stats(e,t){var n;if(e.trackIdentifier)n=e.trackIdentifier;else if(e.mid)n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var i=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!i)return;n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(n){var a=this.track2stats.get(n);if(!a){var s=this.mediaTrackHandler.getTackById(n);if(s!==void 0){var o=s.kind==="audio"?s.kind:"video";a=new LA(n,t,o),this.track2stats.set(n,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class Ki{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class gr{static buildFramerateResolution(e,t){var n={height:t.frameHeight,width:t.frameWidth},i=t.framesPerSecond;n.height&&n.width&&e.setResolution(n),e.setFramerate(Math.round(i||0))}static calculateSimulcastFramerate(e,t,n,i){var a=e.getFramerate();if(!a){if(n){var s=t.timestamp-n.timestamp;if(s>0&&t.framesSent){var o=t.framesSent-n.framesSent;a=o/s*1e3}}if(!a)return}a=i?Math.round(a/i):0,e.setFramerate(a)}static buildCodec(e,t,n){var i=e==null?void 0:e.get(n.codecId);if(i){var a=i.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,n){e.setBitrate({download:gr.calculateBitrate(t.bytesReceived,n.bytesReceived,t.timestamp,n.timestamp),upload:0})}static buildBitrateSend(e,t,n){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,n.bytesSent,t.timestamp,n.timestamp)})}static buildPacketsLost(e,t,n){var i=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[i];(!a||a<0)&&(a=0);var s=Ki.getNonNegativeValue(n[i]),o=Math.max(0,a-s),l=Ki.getNonNegativeValue(t.packetsLost),u=Ki.getNonNegativeValue(n.packetsLost),d=Math.max(0,l-u);e.setLoss({packetsTotal:o+d,packetsLost:d,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,n,i){var a=Ki.getNonNegativeValue(e),s=Ki.getNonNegativeValue(t),o=Math.max(0,a-s),l=n-i,u=0;return l>0&&(u=Math.round(o*8/l)),u}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}var i=e.getType()==="remote"?t.receiver.track:t==null||(n=t.sender)===null||n===void 0?void 0:n.track;if(i==null){e.alive=!1;return}if(i.readyState==="ended"){e.alive=!1;return}e.muted=i.muted,e.enabled=i.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i=e.filter(s=>s.getType()==="remote"),a=i.filter(s=>s.kind==="audio");return i.forEach(s=>{var o=s.kind==="video"?t:n;if(o.count++,s.alive&&s.muted&&o.muted++,o.maxJitter<s.getJitter()&&(o.maxJitter=s.getJitter()),o.maxPacketLoss<s.getLoss().packetsLost&&(o.maxPacketLoss=s.getLoss().packetsLost),a.length>0){var l,u;o.concealedAudio+=(l=s.getAudioConcealment())===null||l===void 0?void 0:l.concealedAudio,o.totalAudio+=(u=s.getAudioConcealment())===null||u===void 0?void 0:u.totalAudioDuration}}),{audioTrackSummary:n,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var n=t==null?void 0:t.jitter;if(n!==void 0){var i=Ki.getNonNegativeValue(n);e.setJitter(Math.round(i*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var n=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived),i=n*(t==null?void 0:t.concealedSamples),a=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(i,a)}}}class ko{static build(e){var t={},n={download:0,upload:0},i={download:0,upload:0},a=0,s=0,o={local:new Map,remote:new Map},l={local:new Map,remote:new Map},u={local:new Map,remote:new Map},d=new Map,h=new Map,f=0,m=0,v=0,y=0,I=0,g=0;for(var[p,b]of e){var R=b.getLoss(),P=R.isDownloadStream?"download":"upload";if(n[P]+=R.packetsTotal,i[P]+=R.packetsLost,a+=b.getBitrate().download,s+=b.getBitrate().upload,b.kind==="audio"){var E=b.getAudioConcealment();I+=E.concealedAudio,g+=E.totalAudioDuration,f+=b.getBitrate().download,m+=b.getBitrate().upload}else v+=b.getBitrate().download,y+=b.getBitrate().upload;o[b.getType()].set(p,b.getResolution()),l[b.getType()].set(p,b.getFramerate()),u[b.getType()].set(p,b.getCodec()),b.getType()==="remote"&&(d.set(p,b.getJitter()),b.kind==="audio"&&h.set(p,b.getAudioConcealment())),b.resetBitrate()}return t.bitrate={upload:s,download:a},t.bitrate.audio={upload:m,download:f},t.bitrate.video={upload:y,download:v},t.packetLoss={total:ko.calculatePacketLoss(i.download+i.upload,n.download+n.upload),download:ko.calculatePacketLoss(i.download,n.download),upload:ko.calculatePacketLoss(i.upload,n.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:I,totalAudioDuration:g},t.framerate=l,t.resolution=o,t.codec=u,t.jitter=d,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class ci{static buildCallFeedReport(e,t,n){var i=n.getTransceivers(),a=[],s=[];return i.forEach(o=>{var l,u=(l=o.sender)!==null&&l!==void 0&&l.track?ci.buildTrackStats(o.sender.track,"sender"):null,d=ci.buildTrackStats(o.receiver.track,"receiver");a.push({mid:o.mid==null?"null":o.mid,direction:o.direction,currentDirection:o.currentDirection==null?"null":o.currentDirection,sender:u,receiver:d})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:s}}static buildTrackStats(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,s=(n=e.getConstraints())===null||n===void 0?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:s??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:i}}static expandCallFeedReport(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(i=>{var a=i.stream.getAudioTracks(),s=i.stream.getVideoTracks(),o=a.length>0?ci.buildTrackStats(i.stream.getAudioTracks()[0],i.purpose):null,l=s.length>0?ci.buildTrackStats(i.stream.getVideoTracks()[0],i.purpose):null,u={stream:i.stream.id,type:i.isLocal()?"local":"remote",audio:o,video:l,purpose:i.purpose,prefix:n,isVideoMuted:i.isVideoMuted(),isAudioMuted:i.isAudioMuted()};e.callFeeds.push(u)}),e}}function Uy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function iu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Uy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Uy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}class jA{constructor(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=n,this.emitter=i,this.isFocus=a,c(this,"isActive",!0),c(this,"previousStatsReport",void 0),c(this,"currentStatsReport",void 0),c(this,"connectionStats",new MA),c(this,"trackStats",void 0),n.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new UA(new xA,new NA(n))}processStats(e,t){var n=this;return w(function*(){var i={isFirstCollection:n.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var a=n.pc.getStats();if(typeof(a==null?void 0:a.then)=="function")return a.then(s=>{var o,l;n.currentStatsReport=typeof(s==null?void 0:s.result)=="function"?s.result():s;try{n.processStatsReport(e,t)}catch(d){return n.handleError(d),i}n.previousStatsReport=n.currentStatsReport,i.receivedMedia=n.connectionStats.bitrate.download,i.receivedAudioMedia=((o=n.connectionStats.bitrate.audio)===null||o===void 0?void 0:o.download)||0,i.receivedVideoMedia=((l=n.connectionStats.bitrate.video)===null||l===void 0?void 0:l.download)||0;var u=gr.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return iu(iu({},i),{},{audioTrackSummary:u.audioTrackSummary,videoTrackSummary:u.videoTrackSummary})}).catch(s=>(n.handleError(s),i));n.isActive=!1}return Promise.resolve(i)})()}processStatsReport(e,t){var n,i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)===null||n===void 0||n.forEach(a=>{var s=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=AA.buildBandwidthReport(a),this.connectionStats.transport=DA.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var o=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!o)return;if(s&&gr.buildPacketsLost(o,a,s),a.type==="inbound-rtp"){gr.buildFramerateResolution(o,a),s&&gr.buildBitrateReceived(o,a,s);var l=this.trackStats.findTransceiverByTrackId(o.trackId);gr.setTrackStatsState(o,l),gr.buildJitter(o,a),gr.buildAudioConcealment(o,a)}else s&&(i.set(o.trackId,Ki.getNonNegativeValue(a.bytesSent)),gr.buildBitrateSend(o,a,s));gr.buildCodec(this.currentStatsReport,o,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var u=this.trackStats.findLocalVideoTrackStats(a);if(!u)return;gr.buildFramerateResolution(u,a),gr.calculateSimulcastFramerate(u,a,s,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(ci.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,T.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=ko.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(iu(iu({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var An=function(r){return r.CONNECTION_STATS="StatsReport.connection_stats",r.CALL_FEED_REPORT="StatsReport.call_feed_report",r.BYTE_SENT_STATS="StatsReport.byte_sent_stats",r.SUMMARY_STATS="StatsReport.summary_stats",r}({});class FA extends nt{emitByteSendReport(e){this.emit(An.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(An.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(An.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(An.SUMMARY_STATS,e)}}class L0{constructor(e){this.emitter=e}build(e){var t=e.filter(d=>!d.isFirstCollection),n=t.length,i=e.length;if(n!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},s=0,o=0;t.forEach(d=>{this.countTrackListReceivedMedia(a,d),this.countConcealedAudio(a,d),s=this.buildMaxJitter(s,d),o=this.buildMaxPacketLoss(o,d)});var l=5,u={percentageReceivedMedia:Number((a.receivedMedia/n).toFixed(l)),percentageReceivedVideoMedia:Number((a.receivedVideo/n).toFixed(l)),percentageReceivedAudioMedia:Number((a.receivedAudio/n).toFixed(l)),maxJitter:s,maxPacketLoss:o,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(l):0),peerConnections:i};this.emitter.emitSummaryStatsReport(u)}}static extendSummaryReport(e,t){var n=[],i=[];for(var a of t){i.push(a);for(var s of a[1])n.push(s)}e.opponentDevicesInCall=Math.max(0,n.length-1),e.opponentUsersInCall=Math.max(0,i.length-1),e.diffDevicesToPeerConnections=Math.max(0,n.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,n.length-1)==0?0:e.peerConnections/(n.length-1)}countTrackListReceivedMedia(e,t){var n=!1,i=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,n=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,i=!0),i&&n&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class BA{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=n,c(this,"timer",void 0),c(this,"gatherers",new Map),c(this,"reports",new FA),c(this,"summaryStatsReportGatherer",new L0(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,n){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new jA(e,t,n,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var n;(n=this.getStatsReportGatherer(e))===null||n===void 0||n.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{T.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function jy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function au(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):jy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var U0=function(r){return r.Ring="m.ring",r.Prompt="m.prompt",r.Room="m.room",r}({}),cc=function(r){return r.Video="m.video",r.Voice="m.voice",r}({}),$A=function(r){return r.CallEnded="call_ended",r}({}),Ye=function(r){return r.GroupCallStateChanged="group_call_state_changed",r.ActiveSpeakerChanged="active_speaker_changed",r.CallsChanged="calls_changed",r.UserMediaFeedsChanged="user_media_feeds_changed",r.ScreenshareFeedsChanged="screenshare_feeds_changed",r.LocalScreenshareStateChanged="local_screenshare_state_changed",r.LocalMuteStateChanged="local_mute_state_changed",r.ParticipantsChanged="participants_changed",r.Error="group_call_error",r}({}),uo=function(r){return r.ConnectionStats="GroupCall.connection_stats",r.ByteSentStats="GroupCall.byte_sent_stats",r.SummaryStats="GroupCall.summary_stats",r.CallFeedStats="GroupCall.call_feed_stats",r}({}),Po=function(r){return r.NoUserMedia="no_user_media",r.UnknownDevice="unknown_device",r.PlaceCallFailed="place_call_failed",r}({});class pv extends Error{constructor(e,t,n){n?(super(t+": "+n),c(this,"code",void 0)):(super(t),c(this,"code",void 0)),this.code=e}}class j0 extends pv{constructor(e){super(Po.UnknownDevice,"No device found for "+e),this.userId=e}}var ut=function(r){return r.LocalCallFeedUninitialized="local_call_feed_uninitialized",r.InitializingLocalCallFeed="initializing_local_call_feed",r.LocalCallFeedInitialized="local_call_feed_initialized",r.Entered="entered",r.Ended="ended",r}({}),Fy=1e3*60*60;function su(r){var e;return((e=r.getOpponentMember())===null||e===void 0?void 0:e.userId)||r.invitee||null}class zp extends nt{constructor(e,t,n,i,a,s,o,l,u){var d,h,f=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,m=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=n,this.isPtt=i,this.intent=a,this.dataChannelsEnabled=o,this.dataChannelOptions=l,this.useLivekit=f,c(this,"activeSpeakerInterval",1e3),c(this,"retryCallInterval",5e3),c(this,"participantTimeout",1e3*15),c(this,"pttMaxTransmitTime",1e3*20),c(this,"activeSpeaker",void 0),c(this,"localCallFeed",void 0),c(this,"localScreenshareFeed",void 0),c(this,"localDesktopCapturerSourceId",void 0),c(this,"userMediaFeeds",[]),c(this,"screenshareFeeds",[]),c(this,"groupCallId",void 0),c(this,"allowCallWithoutVideoAndAudio",void 0),c(this,"calls",new Map),c(this,"callHandlers",new Map),c(this,"activeSpeakerLoopInterval",void 0),c(this,"retryCallLoopInterval",void 0),c(this,"retryCallCounts",new Map),c(this,"reEmitter",void 0),c(this,"transmitTimer",null),c(this,"participantsExpirationTimer",null),c(this,"resendMemberStateTimer",null),c(this,"initWithAudioMuted",!1),c(this,"initWithVideoMuted",!1),c(this,"initCallFeedPromise",void 0),c(this,"_livekitServiceURL",void 0),c(this,"stats",void 0),c(this,"statsCollectIntervalTime",0),c(this,"onConnectionStats",v=>{this.emit(uo.ConnectionStats,{report:v})}),c(this,"onByteSentStats",v=>{this.emit(uo.ByteSentStats,{report:v})}),c(this,"onSummaryStats",v=>{L0.extendSummaryReport(v,this.participants),this.emit(uo.SummaryStats,{report:v})}),c(this,"onCallFeedReport",v=>{this.localCallFeed&&(v=ci.expandCallFeedReport(v,[this.localCallFeed],"from-local-feed"));var y=[];this.forEachCall(I=>{I.callId===v.callId&&I.getFeeds().forEach(g=>y.push(g))}),v=ci.expandCallFeedReport(v,y,"from-call-feed"),this.emit(uo.CallFeedStats,{report:v})}),c(this,"_state",ut.LocalCallFeedUninitialized),c(this,"_participants",new Map),c(this,"_creationTs",null),c(this,"_enteredViaAnotherSession",!1),c(this,"onIncomingCall",v=>{var y,I;if(v.roomId===this.room.roomId){if(v.state!==Te.Ringing){T.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!v.groupCallId||v.groupCallId!==this.groupCallId){T.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),v.reject();return}var g=(y=v.getOpponentMember())===null||y===void 0?void 0:y.userId;if(g===void 0){T.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){T.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var p=(I=this.calls.get(g))!==null&&I!==void 0?I:new Map,b=p.get(v.getOpponentDeviceId());if((b==null?void 0:b.callId)!==v.callId){T.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(g,", callId=").concat(v.callId,")")),b&&b.hangup(Oe.Replaced,!1),p.set(v.getOpponentDeviceId(),v),this.calls.set(g,p),this.initCall(v);var R=this.getLocalFeeds().map(E=>E.clone());if(!this.callExpected(v))for(var P of R)bt(P.stream.getAudioTracks(),!1),bt(P.stream.getVideoTracks(),!1);v.answerWithCallFeeds(R),this.emit(Ye.CallsChanged,this.calls)}}}),c(this,"onRetryCallLoop",()=>{var v=!1;for(var[{userId:y},I]of this.participants){var g=this.calls.get(y),p=this.retryCallCounts.get(y);for(var[b,R]of I){var P,E,C=g==null?void 0:g.get(b),S=(P=(E=p)===null||E===void 0?void 0:E.get(b))!==null&&P!==void 0?P:0;(C==null?void 0:C.getOpponentSessionId())!==R.sessionId&&this.wantsOutgoingCall(y,b)&&S<3&&(p===void 0&&(p=new Map,this.retryCallCounts.set(y,p)),p.set(b,S+1),v=!0)}}v&&this.placeOutgoingCalls()}),c(this,"onCallFeedsChanged",v=>{var y=su(v),I=v.getOpponentDeviceId();if(!y)throw new Error("Cannot change call feeds without user id");var g=this.getUserMediaFeed(y,I),p=v.remoteUsermediaFeed,b=p!==g,R=this.calls.get(y),P=R==null?void 0:R.get(I);if((P==null?void 0:P.callId)===v.callId){b&&(!g&&p?this.addUserMediaFeed(p):g&&p?this.replaceUserMediaFeed(g,p):g&&!p&&this.removeUserMediaFeed(g));var E=this.getScreenshareFeed(y,I),C=v.remoteScreensharingFeed,S=C!==E;S&&(!E&&C?this.addScreenshareFeed(C):E&&C?this.replaceScreenshareFeed(E,C):E&&!C&&this.removeScreenshareFeed(E))}}),c(this,"onCallStateChanged",(v,y,I)=>{var g;if(y!==Te.Ended){var p=this.localCallFeed.isAudioMuted();v.localUsermediaStream&&v.isMicrophoneMuted()!==p&&v.setMicrophoneMuted(p);var b=this.localCallFeed.isVideoMuted();v.localUsermediaStream&&v.isLocalVideoMuted()!==b&&v.setLocalVideoMuted(b);var R=(g=v.getOpponentMember())===null||g===void 0?void 0:g.userId;if(y===Te.Connected&&R){var P=this.retryCallCounts.get(R);P==null||P.delete(v.getOpponentDeviceId()),(P==null?void 0:P.size)===0&&this.retryCallCounts.delete(R)}}}),c(this,"onCallHangup",v=>{var y,I;if(v.hangupReason!==Oe.Replaced){var g=(y=(I=v.getOpponentMember())===null||I===void 0?void 0:I.userId)!==null&&y!==void 0?y:this.room.getMember(v.invitee).userId,p=this.calls.get(g);(p==null?void 0:p.get(v.getOpponentDeviceId()))===v&&(this.disposeCall(v,v.hangupReason),p.delete(v.getOpponentDeviceId()),p.size===0&&this.calls.delete(g),this.emit(Ye.CallsChanged,this.calls))}}),c(this,"onCallReplaced",(v,y)=>{var I=v.getOpponentMember().userId,g=this.calls.get(I);g===void 0&&(g=new Map,this.calls.set(I,g)),v.hangup(Oe.Replaced,!1),this.initCall(y),g.set(v.getOpponentDeviceId(),y),this.emit(Ye.CallsChanged,this.calls)}),c(this,"onActiveSpeakerLoop",()=>{var v=void 0,y=void 0;for(var I of this.userMediaFeeds)if(!(I.isLocal()&&this.userMediaFeeds.length>1)){var g=I.speakingVolumeSamples.reduce((b,R)=>b+Math.max(R,hv)),p=g/I.speakingVolumeSamples.length;(!v||p>v)&&(v=p,y=I)}y&&this.activeSpeaker!==y&&v&&v>hv&&(this.activeSpeaker=y,this.emit(Ye.ActiveSpeakerChanged,this.activeSpeaker))}),c(this,"onRoomState",()=>this.updateParticipants()),c(this,"onParticipantsChanged",()=>{this.forEachCall(v=>{var y=this.callExpected(v);for(var I of v.getLocalFeeds())bt(I.stream.getAudioTracks(),!I.isAudioMuted()&&y),bt(I.stream.getVideoTracks(),!I.isVideoMuted()&&y)}),this.state===ut.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),c(this,"onStateChanged",(v,y)=>{(v===ut.Entered||y===ut.Entered||v===ut.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(I=>T.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),I)))}),c(this,"onLocalFeedsChanged",()=>{this.state===ut.Entered&&this.updateMemberState().catch(v=>T.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),v))}),this.reEmitter=new e0(this),this.groupCallId=s??Vi(),this._livekitServiceURL=m,this.creationTs=(d=(h=t.currentState.getStateEvents(j.GroupCallPrefix,this.groupCallId))===null||h===void 0?void 0:h.getTs())!==null&&d!==void 0?d:null,this.updateParticipants(),t.on(Ae.Update,this.onRoomState),this.on(Ye.ParticipantsChanged,this.onParticipantsChanged),this.on(Ye.GroupCallStateChanged,this.onStateChanged),this.on(Ye.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!u}create(){var e=this;return w(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(vv.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return w(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,j.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Ye.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,n=(a,s)=>a.sessionId===s.sessionId&&a.screensharing===s.screensharing,i=(a,s)=>qg(a,s,n);qg(e,t,i)||(this._participants=e,this.emit(Ye.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var n of t.values())e(n)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,n=su(e),i=n===null?null:this.room.getMember(n),a=e.getOpponentDeviceId();return i!==null&&a!==void 0&&((t=this.participants.get(i))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return w(function*(){if(e.useLivekit){T.info("Livekit group call: not starting local call feed.");return}if(e.state!==ut.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=ut.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return w(function*(){T.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===cc.Video)}catch(i){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=ut.LocalCallFeedUninitialized,i}if(e._state!==ut.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var n=new On({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Qe.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});bt(t.getAudioTracks(),!n.isAudioMuted()),bt(t.getVideoTracks(),!n.isVideoMuted()),e.localCallFeed=n,e.addUserMediaFeed(n),e.state=ut.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return w(function*(){if(t.localCallFeed){var n=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var i=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();T.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(n.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(i,", vidShouldBeMuted=").concat(a,")")),bt(e.getAudioTracks(),!i),bt(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(n)}})()}enter(){var e=this;return w(function*(){if(e.state===ut.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==ut.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));T.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=ut.Entered,e.client.on(fv.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===ut.Entered&&(this.forEachCall(t=>t.hangup(Oe.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(fv.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=ut.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(Ae.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(vv.Ended,t),t.state=ut.Ended,n){var i=t.room.currentState.getStateEvents(j.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,j.GroupCallPrefix,au(au({},i.getContent()),{},{"m.terminated":$A.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return w(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(s=>{var o;return(o=s.localUsermediaFeed)===null||o===void 0?void 0:o.setAudioVideoMuted(e,null)});var i=function(){var s=w(function*(){var o=[];t.forEachCall(l=>o.push(l.sendMetadataUpdate())),yield Promise.all(o).catch(l=>T.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),l))});return function(){return s.apply(this,arguments)}}();if(n&&(yield i()),t.localCallFeed){T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),bt(t.localCallFeed.stream.getAudioTracks(),!e)}else T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(s=>bt(s.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(s))),t.emit(Ye.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield i()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return w(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((n==null?void 0:n.getTracks().length)===0)return T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return T.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return w(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(n),t.localCallFeed.setAudioVideoMuted(null,e),bt(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else T.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var i=[];return t.forEachCall(a=>i.push(a.setLocalVideoMuted(e))),yield Promise.all(i),t.forEachCall(a=>bt(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(Ye.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(e===n.isScreensharing())return e;if(e)try{T.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield n.client.getMediaHandler().getScreensharingStream(i),s=function*(u){var d=()=>{n.setScreensharingEnabled(!1),u.removeEventListener("ended",d)};u.addEventListener("ended",d)};for(var o of a.getTracks())yield*s(o);return T.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=i.desktopCapturerSourceId,n.localScreenshareFeed=new On({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:a,purpose:Qe.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(Ye.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(l=>l.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(l){if(i.throwOnFail)throw l;return T.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),l),n.emit(Ye.Error,new pv(Po.NoUserMedia,"Failed to get screen-sharing stream: ",l)),!1}else return n.forEachCall(l=>{l.localScreensharingFeed&&l.removeLocalFeed(l.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(Ye.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var n=this.client.getUserId(),i=this.client.getDeviceId();return e>=n&&(e!==n||t>i)}placeOutgoingCalls(){var e=this,t=!1,n=function(o){var l,u=(l=e.calls.get(o))!==null&&l!==void 0?l:new Map,d=function(v){var y=u.get(v);if((y==null?void 0:y.getOpponentSessionId())!==f.sessionId&&e.wantsOutgoingCall(o,v)){t=!0,y!==void 0&&(T.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(o,", deviceId=").concat(v,", callId=").concat(y.callId,")")),y.hangup(Oe.NewSession,!1));var I=al(e.client,e.room.roomId,{invitee:o,opponentDeviceId:v,opponentSessionId:f.sessionId,groupCallId:e.groupCallId});I===null?(T.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(o,", device=").concat(v,")")),u.delete(v)):(e.initCall(I),u.set(v,I),T.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(o,", deviceId=").concat(v,", sessionId=").concat(f.sessionId,")")),I.placeCallWithCallFeeds(e.getLocalFeeds().map(g=>g.clone()),f.screensharing).then(()=>{e.dataChannelsEnabled&&I.createDataChannel("datachannel",e.dataChannelOptions)}).catch(g=>{T.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(o,")"),g),g instanceof Rn&&g.code===Po.UnknownDevice?e.emit(Ye.Error,g):e.emit(Ye.Error,new pv(Po.PlaceCallFailed,"Failed to place call to ".concat(o))),I.hangup(Oe.SignallingFailed,!1),u.get(v)===I&&u.delete(v)}))}};for(var[h,f]of a)d(h);u.size>0?e.calls.set(o,u):e.calls.delete(o)};for(var[{userId:i},a]of this.participants)n(i);t&&this.emit(Ye.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(j.GroupCallMemberPrefix):this.room.currentState.getStateEvents(j.GroupCallMemberPrefix,e)}initCall(e){var t=su(e);if(!t)throw new Error("Cannot init call without user id");var n=()=>this.onCallFeedsChanged(e),i=(l,u)=>this.onCallStateChanged(e,l,u),a=this.onCallHangup,s=l=>this.onCallReplaced(e,l),o=this.callHandlers.get(t);o===void 0&&(o=new Map,this.callHandlers.set(t,o)),o.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:i,onCallHangup:a,onCallReplaced:s}),e.on(Pe.FeedsChanged,n),e.on(Pe.State,i),e.on(Pe.Hangup,a),e.on(Pe.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(Pe)),e.initStats(this.getGroupCallStats()),n()}disposeCall(e,t){var n=su(e),i=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(n),{onCallFeedsChanged:s,onCallStateChanged:o,onCallHangup:l,onCallReplaced:u}=a.get(i);if(e.removeListener(Pe.FeedsChanged,s),e.removeListener(Pe.State,o),e.removeListener(Pe.Hangup,l),e.removeListener(Pe.Replaced,u),a.delete(n),a.size===0&&this.callHandlers.delete(n),e.hangupReason!==Oe.Replaced){var d=this.getUserMediaFeed(n,i);d&&this.removeUserMediaFeed(d);var h=this.getScreenshareFeed(n,i);h&&this.removeScreenshareFeed(h)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(n=>n.userId===e&&n.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var n=this.userMediaFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Ye.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Ye.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(n=>n.userId===e&&n.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var n=this.screenshareFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Ye.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){T.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===ut.Ended){this.participants=new Map;return}var t=new Map,n=Date.now(),i=this.state===ut.Entered||this.enteredViaAnotherSession,a=1/0;for(var s of this.getMemberStateEvents()){var o=this.room.getMember(s.getStateKey()),l=s.getContent(),u=Array.isArray(l["m.calls"])?l["m.calls"]:[],d=u.find(I=>I["m.call_id"]===this.groupCallId),h=Array.isArray(d==null?void 0:d["m.devices"])?d["m.devices"]:[],f=h.filter(I=>typeof I.device_id=="string"&&typeof I.session_id=="string"&&typeof I.expires_ts=="number"&&I.expires_ts>n&&Array.isArray(I.feeds));if(!i&&(o==null?void 0:o.userId)===this.client.getUserId()&&(f=f.filter(I=>I.device_id!==this.client.getDeviceId())),f.length>0&&(o==null?void 0:o.membership)===Ie.Join){var m=new Map;t.set(o,m);for(var v of f)m.set(v.device_id,{sessionId:v.session_id,screensharing:v.feeds.some(I=>I.purpose===Qe.Screenshare)}),v.expires_ts<a&&(a=v.expires_ts)}}if(i){var y=t.get(e);y===void 0&&(y=new Map,t.set(e,y)),y.has(this.client.getDeviceId())||y.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(I=>I.purpose===Qe.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-n))}updateDevices(e){var t=arguments,n=this;return w(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1,s=Date.now(),o=n.client.getUserId(),l=n.getMemberStateEvents(o),u=(i=l==null?void 0:l.getContent())!==null&&i!==void 0?i:{},d=Array.isArray(u["m.calls"])?u["m.calls"]:[],h=null,f=[];for(var m of d)m["m.call_id"]===n.groupCallId?h=m:f.push(m);h===null&&(h={});var v=Array.isArray(h["m.devices"])?h["m.devices"]:[],y=v.filter(b=>typeof b.device_id=="string"&&typeof b.session_id=="string"&&typeof b.expires_ts=="number"&&b.expires_ts>s&&Array.isArray(b.feeds)),I=e(y);if(I!==null){var g=[...f];I.length>0&&g.push(au(au({},h),{},{"m.call_id":n.groupCallId,"m.devices":I}));var p={"m.calls":g};yield n.client.sendStateEvent(n.room.roomId,j.GroupCallMemberPrefix,p,o,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return w(function*(){yield e.updateDevices(t=>[...t.filter(n=>n.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+Fy,feeds:e.getLocalFeeds().map(n=>({purpose:n.purpose}))}])})()}updateMemberState(){var e=this;return w(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===ut.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(w(function*(){T.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){T.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),Fy*3/4)):yield e.updateDevices(t=>t.filter(n=>n.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return w(function*(){var{devices:t}=yield e.client.getDevices(),n=new Map(t.map(i=>[i.device_id,i]));yield e.updateDevices(i=>{var a=i.filter(s=>{var o=n.get(s.device_id);return(o==null?void 0:o.last_seen_ts)!==void 0&&!(s.device_id===e.client.getDeviceId()&&e.state!==ut.Entered&&!e.enteredViaAnotherSession)});return a.length===i.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new BA(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(An.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(An.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(An.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(An.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function By(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function ou(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?By(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):By(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var Te=function(r){return r.Fledgling="fledgling",r.InviteSent="invite_sent",r.WaitLocalMedia="wait_local_media",r.CreateOffer="create_offer",r.CreateAnswer="create_answer",r.Connecting="connecting",r.Connected="connected",r.Ringing="ringing",r.Ended="ended",r}({}),$y=function(r){return r.Voice="voice",r.Video="video",r}({}),Zn=function(r){return r.Inbound="inbound",r.Outbound="outbound",r}({}),vt=function(r){return r.Local="local",r.Remote="remote",r}({}),Pe=function(r){return r.Hangup="hangup",r.State="state",r.Error="error",r.Replaced="replaced",r.LocalHoldUnhold="local_hold_unhold",r.RemoteHoldUnhold="remote_hold_unhold",r.HoldUnhold="hold_unhold",r.FeedsChanged="feeds_changed",r.AssertedIdentityChanged="asserted_identity_changed",r.LengthChanged="length_changed",r.DataChannel="datachannel",r.SendVoipEvent="send_voip_event",r.PeerConnectionCreated="peer_connection_created",r}({}),Oe=function(r){return r.UserHangup="user_hangup",r.LocalOfferFailed="local_offer_failed",r.NoUserMedia="no_user_media",r.UnknownDevices="unknown_devices",r.SendInvite="send_invite",r.CreateAnswer="create_answer",r.CreateOffer="create_offer",r.SendAnswer="send_answer",r.SetRemoteDescription="set_remote_description",r.SetLocalDescription="set_local_description",r.AnsweredElsewhere="answered_elsewhere",r.IceFailed="ice_failed",r.InviteTimeout="invite_timeout",r.Replaced="replaced",r.SignallingFailed="signalling_timeout",r.UserBusy="user_busy",r.Transferred="transferred",r.NewSession="new_session",r}({}),WA="1",KA="stun:turn.matrix.org",fh=60*1e3,VA=1e3,GA=30*1e3,qA=2*1e3;class Rn extends Error{constructor(e,t,n){super(t+": "+n),c(this,"code",void 0),this.code=e}}function Vi(){return Date.now().toString()+bi(16)}function Wy(r){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:r?12e3:void 0}];return e}function $r(r,e){return r+":"+e}class HA extends nt{constructor(e){var t,n;if(super(),t=this,c(this,"roomId",void 0),c(this,"callId",void 0),c(this,"invitee",void 0),c(this,"hangupParty",void 0),c(this,"hangupReason",void 0),c(this,"direction",void 0),c(this,"ourPartyId",void 0),c(this,"peerConn",void 0),c(this,"toDeviceSeq",0),c(this,"isPtt",!1),c(this,"_state",Te.Fledgling),c(this,"client",void 0),c(this,"forceTURN",void 0),c(this,"turnServers",void 0),c(this,"candidateSendQueue",[]),c(this,"candidateSendTries",0),c(this,"candidatesEnded",!1),c(this,"feeds",[]),c(this,"transceivers",new Map),c(this,"inviteOrAnswerSent",!1),c(this,"waitForLocalAVStream",!1),c(this,"successor",void 0),c(this,"opponentMember",void 0),c(this,"opponentVersion",void 0),c(this,"opponentPartyId",void 0),c(this,"opponentCaps",void 0),c(this,"iceDisconnectedTimeout",void 0),c(this,"iceReconnectionTimeOut",void 0),c(this,"inviteTimeout",void 0),c(this,"removeTrackListeners",new Map),c(this,"remoteOnHold",!1),c(this,"callStatsAtEnd",void 0),c(this,"makingOffer",!1),c(this,"ignoreOffer",!1),c(this,"isSettingRemoteAnswerPending",!1),c(this,"responsePromiseChain",void 0),c(this,"remoteCandidateBuffer",new Map),c(this,"remoteAssertedIdentity",void 0),c(this,"remoteSDPStreamMetadata",void 0),c(this,"callLengthInterval",void 0),c(this,"callStartTime",void 0),c(this,"opponentDeviceId",void 0),c(this,"hasOpponentDeviceInfo",void 0),c(this,"opponentSessionId",void 0),c(this,"groupCallId",void 0),c(this,"stopVideoTrackTimer",void 0),c(this,"isOnlyDataChannelAllowed",void 0),c(this,"stats",void 0),c(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&T.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),T.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),c(this,"onIceGatheringStateChange",a=>{var s;T.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((s=this.peerConn)===null||s===void 0?void 0:s.iceGatheringState)==="complete"&&(this.queueCandidate(null),T.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),c(this,"getLocalOfferFailed",a=>{T.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(Pe.Error,new Rn(Oe.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate(vt.Local,Oe.LocalOfferFailed,!1)}),c(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}T.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(Pe.Error,new Rn(Oe.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate(vt.Local,Oe.NoUserMedia,!1)}),c(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}T.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(Pe.Error,new Rn(Oe.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate(vt.Local,Oe.IceFailed,!1)}),c(this,"onIceConnectionStateChanged",()=>{var a,s,o,l,u,d;if(!this.callHasEnded()){if(T.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((s=this.peerConn)===null||s===void 0?void 0:s.connectionState,")")),["connected","completed"].includes((o=(l=this.peerConn)===null||l===void 0?void 0:l.iceConnectionState)!==null&&o!==void 0?o:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=Te.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(Pe.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},VA));else if(((u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)=="failed"){var h;if(this.candidatesEnded=!1,(h=this.peerConn)!==null&&h!==void 0&&h.restartIce){var f;this.candidatesEnded=!1,T.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((f=this.peerConn)===null||f===void 0?void 0:f.iceConnectionState,")")),this.peerConn.restartIce()}else T.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Oe.IceFailed,!1)}else((d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var v,y,I;T.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,", conn=").concat((y=this.peerConn)===null||y===void 0?void 0:y.connectionState,")")),(I=this.peerConn)!==null&&I!==void 0&&I.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},qA),this.iceDisconnectedTimeout=setTimeout(()=>{T.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Oe.IceFailed,!1)},GA),this.state=Te.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var m of this.getRemoteFeeds())m.setAudioVideoMuted(!0,!0)}}),c(this,"onSignallingStateChanged",()=>{var a;T.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),c(this,"onTrack",a=>{if(a.streams.length===0){T.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var s=a.streams[0];if(this.pushRemoteFeed(s),!this.removeTrackListeners.has(s)){var o=()=>{s.getTracks().length===0&&(T.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(s.id,")")),this.deleteFeedByStream(s),s.removeEventListener("removetrack",o),this.removeTrackListeners.delete(s))};s.addEventListener("removetrack",o),this.removeTrackListeners.set(s,o)}}),c(this,"onDataChannel",a=>{this.emit(Pe.DataChannel,a.channel,this)}),c(this,"onNegotiationNeeded",w(function*(){if(T.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==Te.CreateOffer&&t.opponentVersion===0){T.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),c(this,"onHangupReceived",a=>{T.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===Te.Ringing?this.terminate(vt.Remote,a.reason||Oe.UserHangup,!0):T.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),c(this,"onRejectReceived",a=>{T.debug("Call ".concat(this.callId," onRejectReceived() running"));var s=[Te.InviteSent,Te.Ringing].includes(this.state)||this.state===Te.Fledgling&&this.direction===Zn.Inbound;s?this.terminate(vt.Remote,a.reason||Oe.UserHangup,!0):T.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),c(this,"onAnsweredElsewhere",a=>{T.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(vt.Remote,Oe.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(n=e.forceTURN)!==null&&n!==void 0?n:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[KA]});for(var i of this.turnServers)yb(i,["urls"]);this.callId=Vi(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return w(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return w(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var n=this.peerConn.createDataChannel(e,t);return this.emit(Pe.DataChannel,n,this),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(Pe.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?$y.Video:$y.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Qe.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Qe.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get($r(Qe.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get($r(Qe.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Qe.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Qe.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Qe.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Qe.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return w(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw n?(e.hasOpponentDeviceInfo=!1,new j0(n)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n){T.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new On({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:i,videoMuted:a})),this.emit(Pe.FeedsChanged,this.feeds,this),T.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(n,")"))}pushRemoteFeedWithoutMetadata(e){var t,n=this.getOpponentMember().userId,i=Qe.Usermedia,a=(t=this.feeds.find(s=>!s.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){T.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new On({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(Pe.FeedsChanged,this.feeds,this),T.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.client.getUserId();if(bt(e.getAudioTracks(),!0),bt(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){T.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new On({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){var t=this,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(s=>e.stream.id===s.stream.id)){T.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),n){var i=function(){T.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var o=$r(e.purpose,a.kind);if(t.transceivers.has(o)){var l=t.transceivers.get(o);l.sender.replaceTrack(a),l.direction=l.direction==="inactive"?"sendonly":"sendrecv"}else{var u=t.peerConn.addTrack(a,e.stream),d=t.peerConn.getTransceivers().find(h=>h.sender===u);d?t.transceivers.set(o,d):T.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var a of e.stream.getTracks())i()}T.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(Pe.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=$r(e.purpose,"audio"),n=$r(e.purpose,"video");for(var i of[t,n])if(this.transceivers.has(i)){var a=this.transceivers.get(i);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===Qe.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(Pe.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){T.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(Pe.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return w(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return w(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),n=[];return t.forEach(i=>{n.push(i)}),n}})()}initWithInvite(e){var t=this;return w(function*(){var n,i=e.getContent();t.direction=Zn.Inbound;var a=yield t.client.checkTurnServers();a||T.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var s=i[Jn];s?t.updateRemoteSDPStreamMetadata(s):T.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(Pe.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(i.offer),T.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(i.offer.type)),yield t.addBufferedIceCandidates()}catch(d){T.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),d),t.terminate(vt.Local,Oe.SetRemoteDescription,!1);return}var o=(n=t.feeds.find(d=>!d.isLocal()))===null||n===void 0?void 0:n.stream;if(!t.isOnlyDataChannelAllowed&&(!o||o.getTracks().length===0)){T.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(vt.Local,Oe.SetRemoteDescription,!1);return}if(t.state=Te.Ringing,e.getLocalAge()){var l=setTimeout(()=>{if(t.state==Te.Ringing){var d;T.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=vt.Remote,t.state=Te.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(d=t.stats)===null||d===void 0||d.removeStatsReportGatherer(t.callId),t.emit(Pe.Hangup,t)}},i.lifetime-e.getLocalAge()),u=d=>{d!==Te.Ringing&&(clearTimeout(l),t.off(Pe.State,u))};t.on(Pe.State,u)}})()}initWithHangup(e){this.state=Te.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(T.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n," because the other side isn't sending it either.")),!1):!_b(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(T.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n,"=").concat(e," because the other side doesn't support it. Answering with ").concat(n,"=").concat(t,".")),t):e??t}answer(e,t){var n=this;return w(function*(){if(!n.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!n.localUsermediaStream&&!n.waitForLocalAVStream){var i=n.state,a=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),s=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=Te.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var o,l=yield n.client.getMediaHandler().getUserMediaStream(a,s);n.waitForLocalAVStream=!1;var u=new On({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(o=n.client.getDeviceId())!==null&&o!==void 0?o:void 0,stream:l,purpose:Qe.Usermedia,audioMuted:!1,videoMuted:!1}),d=[u];n.localScreensharingFeed&&d.push(n.localScreensharingFeed),n.answerWithCallFeeds(d)}catch(h){if(s)T.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=i,n.waitForLocalAVStream=!1,yield n.answer(a,!1);else{n.getUserMediaFailed(h);return}}}else n.waitForLocalAVStream&&(n.state=Te.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){T.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===Te.WaitLocalMedia?(T.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[Te.CreateOffer,Te.InviteSent].includes(this.state)&&(e.direction===Zn.Outbound?e.queueGotCallFeedsForAnswer([]):(T.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(Pe.Replaced,e,this),this.hangup(Oe.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(T.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(vt.Local,e,!t),![Te.Fledgling,Te.WaitLocalMedia].includes(this.state))){var n={};(this.opponentVersion&&this.opponentVersion!==0||e!==Oe.UserHangup)&&(n.reason=e),this.sendVoipEvent(j.CallHangup,n)}}reject(){if(this.state!==Te.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){T.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Oe.UserHangup,!0);return}T.debug("Rejecting call: "+this.callId),this.terminate(vt.Local,Oe.UserHangup,!0),this.sendVoipEvent(j.CallReject,{})}upgradeCall(e,t){var n=this;return w(function*(){if(!(!e&&!t)&&n.opponentSupportsSDPStreamMetadata())try{T.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var i=e||n.hasLocalUserMediaAudioTrack,a=t||n.hasLocalUserMediaVideoTrack,s=yield n.client.getMediaHandler().getUserMediaStream(i,a,!1);yield n.updateLocalUsermediaStream(s,e,t)}catch(o){T.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),o),n.emit(Pe.Error,new Rn(Oe.NoUserMedia,"Failed to get camera access: ",o),n)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var n=this;return w(function*(){if(e&&n.isScreensharing())return T.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return T.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(T.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var i=yield n.client.getMediaHandler().getScreensharingStream(t);return i?(n.pushNewLocalFeed(i,Qe.Screenshare),!0):!1}catch(l){return T.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),l),!1}else{var a=n.transceivers.get($r(Qe.Screenshare,"audio")),s=n.transceivers.get($r(Qe.Screenshare,"video"));for(var o of[a,s])o&&o.sender&&n.peerConn.removeTrack(o.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return w(function*(){if(T.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var i,a=yield n.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var s=a.getTracks().find(f=>f.kind==="video"),o=(i=n.transceivers.get($r(Qe.Usermedia,"video")))===null||i===void 0?void 0:i.sender;return o==null||o.replaceTrack(s??null),n.pushNewLocalFeed(a,Qe.Screenshare,!1),!0}catch(f){return T.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),f),!1}else{var l,u,d=(l=n.localUsermediaStream)===null||l===void 0?void 0:l.getTracks().find(f=>f.kind==="video"),h=(u=n.transceivers.get($r(Qe.Usermedia,"video")))===null||u===void 0?void 0:u.sender;return h==null||h.replaceTrack(d??null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,s=n.localUsermediaFeed,o=i||!s.isAudioMuted()&&!n.remoteOnHold,l=a||!s.isVideoMuted()&&!n.remoteOnHold;T.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(o,", video=").concat(l,")")),bt(e.getAudioTracks(),o),bt(e.getVideoTracks(),l);for(var u of n.localUsermediaStream.getTracks())n.localUsermediaStream.removeTrack(u),u.stop();for(var d of e.getTracks())n.localUsermediaStream.addTrack(d);var h=function*(){var v=$r(Qe.Usermedia,f.kind),y=n.transceivers.get(v),I=y==null?void 0:y.sender,g=!1;if(I)try{T.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(f.id,", kind=").concat(f.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")")),yield I.replaceTrack(f),y.direction=y.direction==="inactive"?"sendonly":"sendrecv",g=!0}catch(R){T.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),R)}if(!g){T.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(f.id,", kind=").concat(f.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")"));var p=n.peerConn.addTrack(f,n.localUsermediaStream),b=n.peerConn.getTransceivers().find(R=>R.sender===p);b?n.transceivers.set(v,b):T.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var f of e.getTracks())yield*h()})()}setLocalVideoMuted(e){var t=this;return w(function*(){var n;if(T.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var i;return(i=t.localUsermediaFeed)===null||i===void 0||i.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var s of t.localUsermediaStream.getVideoTracks())s.stop(),t.localUsermediaStream.removeTrack(s)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return w(function*(){var n;return T.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(Pe.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==Te.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var n;if(((n=t.track)===null||n===void 0?void 0:n.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;T.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),bt(this.localUsermediaStream.getAudioTracks(),!e),bt(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return w(function*(){yield e.sendVoipEvent(j.CallSDPStreamMetadataChangedPrefix,{[Jn]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var n of e)this.pushLocalFeed(n);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=Te.CreateOffer,T.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return w(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Jn]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var n=e.discardDuplicateCandidates();T.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(n," candidates that will be sent in answer"));try{yield e.sendVoipEvent(j.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(s){e.state=Te.Ringing,s instanceof mt&&s.event&&e.client.cancelPendingEvent(s.event);var i=Oe.SendAnswer,a="Failed to send answer";throw s.name=="UnknownDeviceError"&&(i=Oe.UnknownDevices,a="Unknown devices present in the room"),e.emit(Pe.Error,new Rn(i,a,s),e),s}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var n=x0(e.sdp);n.media.forEach(i=>{var a=new Map,s=new Map;for(var o of i.rtp)a.set(o.payload,o.codec),s.set(o.codec,o.payload);for(var l of t)if(l.mediaType===i.type){if(!s.has(l.codec)){T.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(l.codec," as it's not present."));continue}var u=[];l.enableDtx!==void 0&&u.push("usedtx=".concat(l.enableDtx?"1":"0")),l.maxAverageBitrate!==void 0&&u.push("maxaveragebitrate=".concat(l.maxAverageBitrate));var d=!1;for(var h of i.fmtp)a.get(h.payload)===l.codec&&(d=!0,h.config+=";"+u.join(";"));d||i.fmtp.push({payload:s.get(l.codec),config:u.join(";")})}}),e.sdp=gA(n)}createOffer(){var e=this;return w(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,Wy(e.isPtt)),t})()}createAnswer(){var e=this;return w(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,Wy(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return w(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var n of e)t.pushLocalFeed(n);t.state=Te.CreateAnswer;var i;try{t.getRidOfRTXCodecs(),i=yield t.createAnswer()}catch(a){T.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate(vt.Local,Oe.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(i),t.callHasEnded()||(t.state=Te.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){T.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate(vt.Local,Oe.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return w(function*(){if(!t.callHasEnded()){var n=e.getContent(),i=n.candidates;if(!i){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=n.version===0?null:n.party_id||null;if(t.opponentPartyId===void 0){if(a){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(i.length," candidates until we pick an opponent"));var s=t.remoteCandidateBuffer.get(a)||[];s.push(...i),t.remoteCandidateBuffer.set(a,s)}return}if(!t.partyIdMatches(n)){T.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(n.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(i)}})()}onAnswerReceived(e){var t=this;return w(function*(){var n=e.getContent();if(T.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(n.party_id,")")),t.callHasEnded()){T.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){T.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(n.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=Te.Connecting;var i=n[Jn];i?t.updateRemoteSDPStreamMetadata(i):T.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(n.answer),t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(n.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate(vt.Local,Oe.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(j.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){T.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return w(function*(){if(t.direction!==Zn.Inbound){T.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var n=e.getContent().selected_party_id;if(n==null){T.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}n!==t.ourPartyId&&(T.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(n,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(vt.Remote,Oe.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return w(function*(){var n=e.getContent(),i=n.description;if(!i||!i.sdp||!i.type){T.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===Zn.Inbound,s=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),o=i.type==="offer"&&!s;if(t.ignoreOffer=!a&&o,t.ignoreOffer){T.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var l=t.isLocalOnHold(),u=n[Jn];u?t.updateRemoteSDPStreamMetadata(u):T.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=i.type=="answer",yield t.peerConn.setRemoteDescription(i),t.isSettingRemoteAnswerPending=!1,T.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(i.type)),i.type==="offer"){var d,h;try{t.getRidOfRTXCodecs(),h=yield t.createAnswer()}catch(m){T.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),m),t.terminate(vt.Local,Oe.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(h),T.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(j.CallNegotiate,{lifetime:fh,description:(d=t.peerConn.localDescription)===null||d===void 0?void 0:d.toJSON(),[Jn]:t.getLocalSDPStreamMetadata(!0)})}}catch(m){t.isSettingRemoteAnswerPending=!1,T.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),m)}var f=t.isLocalOnHold();l!==f&&(t.emit(Pe.LocalHoldUnhold,f,t),t.emit(Pe.HoldUnhold,f))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=bb(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var n,i=t.stream.id,a=this.remoteSDPStreamMetadata[i];t.setAudioVideoMuted(a==null?void 0:a.audio_muted,a==null?void 0:a.video_muted),t.purpose=(n=this.remoteSDPStreamMetadata[i])===null||n===void 0?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),n=t[Jn];this.updateRemoteSDPStreamMetadata(n)}onAssertedIdentityReceived(e){var t=this;return w(function*(){var n=e.getContent();n.asserted_identity&&(t.remoteAssertedIdentity={id:n.asserted_identity.id,displayName:n.asserted_identity.display_name},t.emit(Pe.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===Te.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return w(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return w(function*(){if(T.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){T.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(d){T.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),d),e.terminate(vt.Local,Oe.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(d){T.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),d),e.terminate(vt.Local,Oe.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(d=>{setTimeout(d,200)})),!e.callHasEnded()){var n=e.state===Te.CreateOffer?j.CallInvite:j.CallNegotiate,i={lifetime:fh};if(n===j.CallInvite&&e.invitee&&(i.invitee=e.invitee),e.state===Te.CreateOffer){var a;i.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var s;i.description=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}i.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},i[Jn]=e.getLocalSDPStreamMetadata(!0);var o=e.discardDuplicateCandidates();T.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(o," candidates that will be sent in offer"));try{yield e.sendVoipEvent(n,i)}catch(d){T.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),d),d instanceof mt&&d.event&&e.client.cancelPendingEvent(d.event);var l=Oe.SignallingFailed,u="Signalling failed";e.state===Te.CreateOffer&&(l=Oe.SendInvite,u="Failed to send invite"),d.name=="UnknownDeviceError"&&(l=Oe.UnknownDevices,u="Unknown devices present in the room"),e.emit(Pe.Error,new Rn(l,u,d),e),e.terminate(vt.Local,l,!1);return}e.sendCandidateQueue(),e.state===Te.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=Te.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===Te.InviteSent&&e.hangup(Oe.InviteTimeout,!1)},fh))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get($r(Qe.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,n=RTCRtpSender.getCapabilities("video").codecs,i=[];for(var a of[...t,...n])if(a.mimeType!=="video/rtx"){i.push(a);try{e.setCodecPreferences(i)}catch(s){T.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,s),i.pop()}}}}}sendVoipEvent(e,t){var n=this;return w(function*(){var i=ou(ou({},t),{},{version:WA,call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var a,s=n.toDeviceSeq++,o=ou(ou({},i),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:s,[ic]:dA()});n.emit(Pe.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||((a=n.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:n.opponentDeviceId,content:o},n);var l=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo){T.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield n.client.sendToDevice(e,new Map([[l,new Map([[n.opponentDeviceId,o]])]]))}else{var u;n.emit(Pe.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:i,userId:n.invitee||((u=n.getOpponentMember())===null||u===void 0?void 0:u.userId)},n),yield n.client.sendEvent(n.roomId,e,i)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===Te.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===Zn.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],n=0;n<this.candidateSendQueue.length;n++){var i=this.candidateSendQueue[n];i.candidate===""?t.push(i):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return w(function*(){var n=yield t.client.getProfileInfo(e),i=Vi(),a={replacement_id:Vi(),target_user:{id:e,display_name:n.displayname,avatar_url:n.avatar_url},create_call:i};yield t.sendVoipEvent(j.CallReplaces,a),yield t.terminate(vt.Local,Oe.Transferred,!0)})()}transferToCall(e){var t=this;return w(function*(){var n,i,a=(n=e.getOpponentMember())===null||n===void 0?void 0:n.userId,s=a?yield t.client.getProfileInfo(a):void 0,o=(i=t.getOpponentMember())===null||i===void 0?void 0:i.userId,l=o?yield t.client.getProfileInfo(o):void 0,u=Vi(),d={replacement_id:Vi(),target_user:{id:o,display_name:l==null?void 0:l.displayname,avatar_url:l==null?void 0:l.avatar_url},await_call:u};yield e.sendVoipEvent(j.CallReplaces,d);var h={replacement_id:Vi(),target_user:{id:a,display_name:s==null?void 0:s.displayname,avatar_url:s==null?void 0:s.avatar_url},create_call:u};yield t.sendVoipEvent(j.CallReplaces,h),yield t.terminate(vt.Local,Oe.Transferred,!0),yield e.terminate(vt.Local,Oe.Transferred,!0)})()}terminate(e,t,n){var i=this;return w(function*(){var a;if(!i.callHasEnded()){i.hangupParty=e,i.hangupReason=t,i.state=Te.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),i.iceDisconnectedTimeout!==void 0&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),i.stopVideoTrackTimer!==void 0&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0);for(var[s,o]of i.removeTrackListeners)s.removeEventListener("removetrack",o);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&i.peerConn.signalingState!=="closed"&&i.peerConn.close(),(a=i.stats)===null||a===void 0||a.removeStatsReportGatherer(i.callId),n&&i.emit(Pe.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}})()}stopAllMedia(){T.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Qe.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Qe.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){T.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(xb.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return w(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var n={candidates:t.map(o=>o.toJSON())};e.candidatesEnded&&n.candidates.push({candidate:""}),T.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(j.CallCandidates,n),e.candidateSendTries=0,e.sendCandidateQueue()}catch(o){if(o instanceof mt&&o.event&&e.client.cancelPendingEvent(o.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){T.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),o);var i=Oe.SignallingFailed,a="Signalling failed";e.emit(Pe.Error,new Rn(i,a,o),e),e.hangup(i,!1);return}var s=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,T.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(s,"ms"),o),setTimeout(()=>{e.sendCandidateQueue()},s)}}})()}placeCall(e,t){var n=this;return w(function*(){if(!e)throw new Error("You CANNOT start a call without audio");n.state=Te.WaitLocalMedia;var i;try{var a,s=yield n.client.getMediaHandler().getUserMediaStream(e,t);bt(s.getAudioTracks(),!0),bt(s.getVideoTracks(),!0),i=new On({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(a=n.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:s,purpose:Qe.Usermedia,audioMuted:!1,videoMuted:!1})}catch(o){n.getUserMediaFailed(o);return}try{yield n.placeCallWithCallFeeds([i])}catch(o){n.placeCallFailed(o);return}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;n.checkForErrorListener(),n.direction=Zn.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n);var a=yield n.client.checkTurnServers();a||T.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(Pe.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,i)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var n=this.getOpponentMember(),i=n?n.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,i,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,n=e.getContent();if(T.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var i;(i=this.stats)===null||i===void 0||i.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return w(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(T.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return w(function*(){for(var n of e){(n.sdpMid===null||n.sdpMid===void 0)&&(n.sdpMLineIndex===null||n.sdpMLineIndex===void 0)?T.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):T.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(n.sdpMid,", candidate=").concat(n.candidate,")"));try{yield t.peerConn.addIceCandidate(n)}catch(i){t.ignoreOffer?T.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),i):T.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),i)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function bt(r,e){for(var t of r)t.enabled=e}function mv(){if(typeof window>"u"||typeof document>"u")return!1;try{var r,e,t,n=!!((r=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&r!==void 0?r:navigator.mediaDevices);if(!n)return T.error("WebRTC is not supported in this browser / environment"),!1}catch(i){return T.error("Exception thrown when trying to access WebRTC",i),!1}return!0}function al(r,e,t){if(!mv())return null;var n=t?t.forceTURN:!1,i={client:r,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:r.getTurnServers(),forceTURN:r.forceTURN||n,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},a=new HA(i);return r.reEmitter.reEmit(a,Object.values(Pe)),a}var wi=function(r){return r.DontNotify="dont_notify",r.Notify="notify",r.Coalesce="coalesce",r}({}),Jp=function(r){return r.Highlight="highlight",r.Sound="sound",r}({}),zA=function(r){return r.ExactEquals="==",r.LessThan="<",r.GreaterThan=">",r.GreaterThanOrEqual=">=",r.LessThanOrEqual="<=",r}({}),JA="2";function YA(r){return r==="==2"||r==="2"}var wt=function(r){return r.EventMatch="event_match",r.EventPropertyIs="event_property_is",r.EventPropertyContains="event_property_contains",r.ContainsDisplayName="contains_display_name",r.RoomMemberCount="room_member_count",r.SenderNotificationPermission="sender_notification_permission",r.CallStarted="call_started",r.CallStartedPrefix="org.matrix.msc3914.call_started",r}({}),xt=function(r){return r.Override="override",r.ContentSpecific="content",r.RoomSpecific="room",r.SenderSpecific="sender",r.Underride="underride",r}({}),At=function(r){return r.Master=".m.rule.master",r.IsUserMention=".m.rule.is_user_mention",r.IsRoomMention=".m.rule.is_room_mention",r.ContainsDisplayName=".m.rule.contains_display_name",r.ContainsUserName=".m.rule.contains_user_name",r.AtRoomNotification=".m.rule.roomnotif",r.DM=".m.rule.room_one_to_one",r.EncryptedDM=".m.rule.encrypted_room_one_to_one",r.Message=".m.rule.message",r.EncryptedMessage=".m.rule.encrypted",r.InviteToSelf=".m.rule.invite_for_me",r.MemberEvent=".m.rule.member_event",r.IncomingCall=".m.rule.call",r.SuppressNotices=".m.rule.suppress_notices",r.Tombstone=".m.rule.tombstone",r.PollStart=".m.rule.poll_start",r.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",r.PollEnd=".m.rule.poll_end",r.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",r.PollStartOneToOne=".m.rule.poll_start_one_to_one",r.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",r.PollEndOneToOne=".m.rule.poll_end_one_to_one",r.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",r}({});function Ky(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Vy(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ky(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ky(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var Gy=[xt.Override,xt.ContentSpecific,xt.RoomSpecific,xt.SenderSpecific,xt.Underride],QA={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:wt.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:wt.SenderNotificationPermission,key:"room"}],actions:[wi.Notify,{set_tweak:Jp.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:wt.EventMatch,key:"type",pattern:"m.reaction"}],actions:[wi.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:wt.EventMatch,key:"type",pattern:j.RoomServerAcl},{kind:wt.EventMatch,key:"state_key",pattern:""}],actions:[]}},Yp=Symbol("UserDefinedRules"),XA=[At.Master,Yp,At.SuppressNotices,At.InviteToSelf,At.MemberEvent,At.IsUserMention,At.ContainsDisplayName,At.IsRoomMention,At.AtRoomNotification,At.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],ZA={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:wt.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:wt.CallStarted}],actions:[wi.Notify,{set_tweak:Jp.Sound,value:"default"}]}},eD=[Yp,At.IncomingCall,".org.matrix.msc3914.rule.room.call",At.EncryptedDM,At.DM,At.Message,At.EncryptedMessage];function qy(r,e,t,n,i){var a=t.filter(v=>v.default),s=t.filter(v=>!v.default);function o(v){v===Yp?u.push(...s):v in n?(r.warn("Adding default global ".concat(e," push rule ").concat(v)),u.push(n[v])):r.warn("Missing default global ".concat(e," push rule ").concat(v))}var l=0,u=[];for(var d of a){var h=i.indexOf(d.rule_id);if(h===-1){u.push(d);continue}for(;h>l;){var f=i[l];o(f),l+=1}u.push(d),l+=1}for(var m of i.slice(l))o(m);return u}class Gr{constructor(e){this.client=e,c(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var n of e)n===wi.Notify?t.notify=!0:typeof n=="object"&&(n.value===void 0&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t){var n=JSON.parse(JSON.stringify(t));return n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]),n.global.override=qy(e,xt.Override,n.global.override,QA,XA),n.global.underride=qy(e,xt.Underride,n.global.underride,ZA,eD),n}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[i,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],s="".concat(t,"-").concat(n,"-").concat(e);return Gr.cachedGlobToRegex[s]||(Gr.cachedGlobToRegex[s]=new RegExp(i+"("+Eb(e)+")"+a,n)),Gr.cachedGlobToRegex[s]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var i of n)if(i.conditions)for(var a of i.conditions)a.kind===wt.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,Gr.partsForDottedKey(a.key)));t.forEach(s=>this.parsedKeys.delete(s))}matchingRuleFromKindSet(e,t){for(var n of Gy){var i=t[n];if(i){for(var a of i)if(a.enabled){var s=this.templateRuleToRaw(n,a);if(s&&this.ruleMatchesEvent(s,e))return Vy(Vy({},a),{},{kind:n})}}}return null}templateRuleToRaw(e,t){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case xt.Underride:case xt.Override:n.conditions=t.conditions;break;case xt.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:wt.EventMatch,key:"room_id",value:t.rule_id});break;case xt.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:wt.EventMatch,key:"user_id",value:t.rule_id});break;case xt.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:wt.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case wt.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case wt.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case wt.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case wt.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case wt.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case wt.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case wt.CallStarted:case wt.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var n=e.key;if(!n)return!1;var i=this.client.getRoom(t.getRoomId());return i!=null&&i.currentState?i.currentState.mayTriggerNotifOfType(n,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var s=a[1],o=parseInt(a[2]);if(isNaN(o))return!1;switch(s){case"":case"==":return i==o;case"<":return i<o;case">":return i>o;case"<=":return i<=o;case">=":return i>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n,i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||typeof i.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),s=a==null||(n=a.currentState)===null||n===void 0?void 0:n.getMember(this.client.credentials.userId);if(!s)return!1;var o=s.name,l=new RegExp("(^|\\W)"+Sb(o)+"(\\W|$)","i");return i.body.search(l)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var n=this.valueForDottedKey(e.key,t);if(typeof n!="string")return!1;if(e.value)return e.value===n;if(typeof e.pattern!="string")return!1;var i=Gr.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!n.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var n=this.valueForDottedKey(e.key,t);return Array.isArray(n)?n.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||gs(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],n="",i=!1;for(var a of e){if(i){a==="\\"||a==="."?n+=a:n+="\\"+a,i=!1;continue}a=="."?(t.push(n),n=""):a=="\\"?i=!0:n+=a}return i&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){var n=this.parsedKeys.get(e);n===void 0&&(n=Gr.partsForDottedKey(e),this.parsedKeys.set(e,n));var i,a=n[0],s=0;for(a==="content"?(i=t.getContent(),++s):a==="type"?(i=t.getType(),++s):i=t.event;s<n.length;++s){if(_b(i))return;var o=n[s];i=i[o]}return i}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};var i=Gr.actionListToActionsObject(n.actions);return i.tweaks.highlight===void 0&&(i.tweaks.highlight=n.kind==xt.ContentSpecific),{actions:i,rule:n}}ruleMatchesEvent(e,t){var n;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===At.ContainsUserName||e.rule_id===At.ContainsDisplayName||e.rule_id===At.AtRoomNotification)?!1:!((n=e.conditions)!==null&&n!==void 0&&n.some(i=>!this.eventFulfillsCondition(i,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,n=this.getPushRuleAndKindById(e);return(t=n==null?void 0:n.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var n;if(((n=this.client.pushRules)===null||n===void 0?void 0:n[t])!==void 0){for(var i of Gy)if(this.client.pushRules[t][i]!==void 0){for(var a of this.client.pushRules[t][i])if(a.rule_id===e)return{rule:a,kind:i}}}}return null}}c(Gr,"cachedGlobToRegex",{});var sl=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],tD=sl[0],rD=sl[sl.length-1],Er=function(r){return r.SUCCESS="SUCCESS",r.IGNORE="IGNORE",r.PROMPT="PROMPT",r.FAIL_PROMPT="FAIL_PROMPT",r.FAIL_ERROR="FAIL_ERROR",r}({}),Fr=function(r){return r.Invalid="Invalid homeserver discovery response",r.GenericFailure="Failed to get autodiscovery configuration from server",r.InvalidHsBaseUrl="Invalid base_url for m.homeserver",r.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",r.InvalidIsBaseUrl="Invalid base_url for m.identity_server",r.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",r.InvalidIs="Invalid identity server discovery response",r.MissingWellknown="No .well-known JSON file found",r.InvalidJson="Invalid JSON",r.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",r}({});class Re{static fromDiscoveryConfig(e){var t=this;return w(function*(){var n,i={"m.homeserver":{state:Re.FAIL_ERROR,error:Re.ERROR_INVALID,base_url:null},"m.identity_server":{state:Re.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return T.error("No m.homeserver key in config"),i["m.homeserver"].state=Re.FAIL_PROMPT,i["m.homeserver"].error=Re.ERROR_INVALID,Promise.resolve(i);if(!e["m.homeserver"].base_url)return T.error("No m.homeserver base_url in config"),i["m.homeserver"].state=Re.FAIL_PROMPT,i["m.homeserver"].error=Re.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return T.error("Invalid base_url for m.homeserver"),i["m.homeserver"].error=Re.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var s=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!s||!Array.isArray((n=s.raw)===null||n===void 0?void 0:n.versions))return T.error("Invalid /versions response"),i["m.homeserver"].error=Re.ERROR_INVALID_HOMESERVER,i["m.homeserver"].base_url=a,Promise.resolve(i);var o=new Set(s.raw.versions),l=!1;for(var u of sl)if(o.has(u)){l=!0;break}if(!l)return T.error("Homeserver does not meet version requirements"),i["m.homeserver"].error=Re.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,i["m.homeserver"].base_url=a,Promise.resolve(i);i["m.homeserver"]={state:Re.SUCCESS,error:null,base_url:a};var d="";if(e["m.identity_server"]){var h={"m.homeserver":i["m.homeserver"],"m.identity_server":{state:Re.FAIL_PROMPT,error:Re.ERROR_INVALID_IS,base_url:null}};if(d=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!d)return T.error("Invalid base_url for m.identity_server"),h["m.identity_server"].error=Re.ERROR_INVALID_IS_BASE_URL,Promise.resolve(h);var f=yield t.fetchWellKnownObject("".concat(d,"/_matrix/identity/v2"));if(!(f!=null&&f.raw)||f.action!==Er.SUCCESS)return T.error("Invalid /v2 response"),h["m.identity_server"].error=Re.ERROR_INVALID_IDENTITY_SERVER,h["m.identity_server"].base_url=d,Promise.resolve(h)}return d&&d.toString().length>0&&(i["m.identity_server"]={state:Re.SUCCESS,error:null,base_url:d}),Object.keys(e).forEach(m=>{if(m==="m.homeserver"||m==="m.identity_server"){var v=["error","state","base_url"];for(var y of Object.keys(e[m]))v.includes(y)||(i[m][y]=e[m][y])}else i[m]=e[m]}),Promise.resolve(i)})()}static findClientConfig(e){var t=this;return w(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n={"m.homeserver":{state:Re.FAIL_ERROR,error:Re.ERROR_INVALID,base_url:null},"m.identity_server":{state:Re.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(i,"/.well-known/matrix/client"));return!a||a.action!==Er.SUCCESS?(T.error("No response or error when parsing .well-known"),a.reason&&T.error(a.reason),a.action===Er.IGNORE?n["m.homeserver"]={state:Re.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=Re.FAIL_PROMPT,n["m.homeserver"].error=Re.ERROR_INVALID),Promise.resolve(n)):Re.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return w(function*(){var n;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var i=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return i?(n=i.raw)!==null&&n!==void 0?n:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,n;try{n=new URL(e)}catch(o){T.error("Could not parse url",o)}if(!((t=n)!==null&&t!==void 0&&t.hostname)||n.protocol!=="http:"&&n.protocol!=="https:")return!1;var i=n.port?":".concat(n.port):"",a=n.pathname?n.pathname:"",s="".concat(n.protocol,"//").concat(n.hostname).concat(i).concat(a);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(o){return T.error(o),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){Re.fetchFn=e}static fetchWellKnownObject(e){return w(function*(){var t;try{if(t=yield Re.fetch(e,{method:V.Get,signal:lc(5e3)}),t.status===404)return{raw:{},action:Er.IGNORE,reason:Re.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:Er.FAIL_PROMPT,reason:"General failure"}}catch(s){var n=s,i="";return typeof n=="object"&&(i=n==null?void 0:n.message),{error:n,raw:{},action:Er.FAIL_PROMPT,reason:i||"General failure"}}try{return{raw:yield t.json(),action:Er.SUCCESS}}catch(s){var a=s;return{error:a,raw:{},action:Er.FAIL_PROMPT,reason:(a==null?void 0:a.name)==="SyntaxError"?Re.ERROR_INVALID_JSON:Re.ERROR_INVALID}}})()}}c(Re,"ERROR_INVALID",Fr.Invalid);c(Re,"ERROR_GENERIC_FAILURE",Fr.GenericFailure);c(Re,"ERROR_INVALID_HS_BASE_URL",Fr.InvalidHsBaseUrl);c(Re,"ERROR_INVALID_HOMESERVER",Fr.InvalidHomeserver);c(Re,"ERROR_INVALID_IS_BASE_URL",Fr.InvalidIsBaseUrl);c(Re,"ERROR_INVALID_IDENTITY_SERVER",Fr.InvalidIdentityServer);c(Re,"ERROR_INVALID_IS",Fr.InvalidIs);c(Re,"ERROR_MISSING_WELLKNOWN",Fr.MissingWellknown);c(Re,"ERROR_INVALID_JSON",Fr.InvalidJson);c(Re,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Fr.UnsupportedHomeserverSpecVersion);c(Re,"ALL_ERRORS",Object.keys(Fr));c(Re,"FAIL_ERROR",Er.FAIL_ERROR);c(Re,"FAIL_PROMPT",Er.FAIL_PROMPT);c(Re,"PROMPT",Er.PROMPT);c(Re,"SUCCESS",Er.SUCCESS);c(Re,"fetchFn",void 0);var gv=function(r){return r.IS="SERVICE_TYPE_IS",r.IM="SERVICE_TYPE_IM",r}({});class nD{constructor(e){this.ourEvent=e,c(this,"timeline",void 0),c(this,"ourEventIndex",0),c(this,"paginateTokens",{[ke.Backward]:null,[ke.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?ke.Backward:ke.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?ke.Backward:ke.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class hc{static fromJson(e,t){var n=e.context||{},i=(n.events_before||[]).map(t),a=(n.events_after||[]).map(t),s=new nD(t(e.result)),o=s.ourEvent.threadRootId;return i=i.filter(l=>l.threadRootId===o),a=a.filter(l=>l.threadRootId===o),s.setPaginateToken(n.start,!0),s.addEvents(i,!0),s.addEvents(a,!1),s.setPaginateToken(n.end,!1),new hc(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}}var iD=function(r){return r.Public="public",r.Private="private",r}({}),Qp=function(r){return r.PrivateChat="private_chat",r.TrustedPrivateChat="trusted_private_chat",r.PublicChat="public_chat",r}({}),F0=function(r){return r.Public="public",r.Invite="invite",r.Private="private",r.Knock="knock",r.Restricted="restricted",r}({}),aD=function(r){return r.RoomMembership="m.room_membership",r}({}),Id=function(r){return r.CanJoin="can_join",r.Forbidden="forbidden",r}({}),Xp=function(r){return r.Invited="invited",r.Joined="joined",r.Shared="shared",r.WorldReadable="world_readable",r}({});function Hy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function zy(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Hy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function sD(r,e){var t=!!e.preventReEmit,n=e.decrypt!==!1;function i(a){var s=r.getRoom(a.room_id),o;s&&a.state_key===void 0&&(o=s.findEventById(a.event_id)),!o||o.status?o=new zt(a):(o.setUnsigned(zy(zy({},o.getUnsigned()),a.unsigned)),t=!0);var l=o.getServerAggregatedRelation(it.Replace);if(l!=null&&l.content){var u=i(l);o.makeReplaced(u)}var d=s==null?void 0:s.findThreadForEvent(o);return d&&o.setThread(d),o.isEncrypted()&&(t||r.reEmitter.reEmit(o,[Ve.Decrypted]),n&&r.decryptEventIfNeeded(o)),t||(r.reEmitter.reEmit(o,[Ve.Replaced,Ve.VisibilityChange]),s==null||s.reEmitter.reEmit(o,[Ve.BeforeRedaction])),o}return i}function Jy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Yn(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Jy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Jy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}class Yy{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return w(function*(){yield e.client.sendStateEvent(e.roomId,Cn.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return w(function*(){yield t.client.sendStateEvent(t.roomId,Cn.name,Yn(Yn({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return w(function*(){yield t.client.sendStateEvent(t.roomId,Cn.name,Yn(Yn({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return w(function*(){var t=yield e.getFileEvent(),n=t.getOriginalContent().file,i=e.client.mxcUrlToHttp(n.url);if(!i)throw new Error("No HTTP URL available for ".concat(n.url));return{info:n,httpUrl:i}})()}getFileEvent(){var e=this;return w(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var n=t.getUnfilteredTimelineSet().findEventById(e.id);!n&&t.getLiveTimeline().getState(se.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),n=t.getUnfilteredTimelineSet().findEventById(e.id);if(!n)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(n),n})()}createNewVersion(e,t,n,i){var a=this;return w(function*(){var s=yield a.directory.createFile(e,t,n,Yn(Yn({},i??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:it.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,Cn.name,{active:!0,name:e,version:a.version+1},s.event_id),yield a.client.sendStateEvent(a.roomId,Cn.name,Yn(Yn({},a.indexEvent.getContent()),{},{active:!1}),a.id),s})()}getVersionHistory(){var e=this;return w(function*(){var t=[];t.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw new Error("Invalid or unknown room");var i=[...n.getLiveTimeline().getEvents()].reverse(),a,s=yield e.getFileEvent();do if(a=i.find(l=>l.replacingEventId()===s.getId()),a){var o=e.directory.getFile(a.getId());if(o)t.push(o),s=a;else break}while(a);return t})()}}function Qy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Ni(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Qy(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Qy(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var oD={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[j.RoomPowerLevels]:100,[j.RoomHistoryVisibility]:100,[j.RoomTombstone]:100,[j.RoomEncryption]:100,[j.RoomName]:50,[j.RoomMessage]:50,[j.RoomMessageEncrypted]:50,[j.Sticker]:50},users:{}},Ia=function(r){return r.Viewer="viewer",r.Editor="editor",r.Owner="owner",r}({});class Xy{constructor(e,t){if(this.client=e,this.roomId=t,c(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(j.SpaceParent);return e!=null&&e.length?e.every(t=>{var n;return!((n=t.getContent())!==null&&n!==void 0&&n.via)}):!0}setName(e){var t=this;return w(function*(){yield t.client.sendStateEvent(t.roomId,j.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=[n.retryInvite(e)];i&&a.push(...n.getDirectories().map(s=>s.invite(e,i))),yield Promise.all(a)})()}retryInvite(e){var t=this;return gO(w(function*(){yield t.client.invite(t.roomId,e).catch(n=>{throw(n==null?void 0:n.errcode)==="M_FORBIDDEN"?new gb.AbortError(n):n})}))}setPermissions(e,t){var n=this;return w(function*(){var i,a=n.room.currentState.getStateEvents(j.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var s=(a==null?void 0:a.getContent())||{},o=s.users_default||0,l=s.events_default||50,u=((i=s.events)===null||i===void 0?void 0:i[j.RoomPowerLevels])||100,d=s.users||{};switch(t){case Ia.Viewer:d[e]=o;break;case Ia.Editor:d[e]=l;break;case Ia.Owner:d[e]=u;break;default:throw new Error("Invalid role: "+t)}s.users=d,yield n.client.sendStateEvent(n.roomId,j.RoomPowerLevels,s,"")})()}getPermissions(e){var t,n,i=this.room.currentState.getStateEvents(j.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var a=(i==null?void 0:i.getContent())||{},s=a.users_default||0,o=a.events_default||50,l=((t=a.events)===null||t===void 0?void 0:t[j.RoomPowerLevels])||100,u=((n=a.users)===null||n===void 0?void 0:n[e])||s;return u>=l?Ia.Owner:u>=o?Ia.Editor:Ia.Viewer}createDirectory(e){var t=this;return w(function*(){var n=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,j.SpaceChild,{via:[t.client.getDomain()]},n.roomId),yield t.client.sendStateEvent(n.roomId,j.SpaceParent,{via:[t.client.getDomain()]},t.roomId),n})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(j.SpaceChild);for(var n of t)try{var i=n.getStateKey();if(i){var a=this.client.unstableGetFileTreeSpace(i);a&&e.push(a)}}catch(s){T.warn("Unable to create tree space instance for listing. Are we joined?",s)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return w(function*(){var t=e.getDirectories();for(var n of t)yield n.delete();var i=[Ie.Invite,Ie.Knock,Ie.Join],a=e.room.currentState.getStateEvents(j.RoomMember);for(var s of a){var o=s.getStateKey()!==e.client.getUserId();if(o&&i.includes(s.getContent().membership)){var l=s.getStateKey();if(!l)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,l,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(n=>({roomId:n.getStateKey(),order:n.getContent().order})).filter(n=>n.roomId);return t.sort((n,i)=>{if(n.order&&!i.order)return-1;if(!n.order&&i.order)return 1;if(!n.order&&!i.order){var a,s,o,l,u=this.client.getRoom(n.roomId),d=this.client.getRoom(i.roomId);if(!u||!d)return Tu(n.roomId,i.roomId);var h=(a=(s=u.currentState.getStateEvents(j.RoomCreate,""))===null||s===void 0?void 0:s.getTs())!==null&&a!==void 0?a:0,f=(o=(l=d.currentState.getStateEvents(j.RoomCreate,""))===null||l===void 0?void 0:l.getTs())!==null&&o!==void 0?o:0;return h===f?Tu(n.roomId,i.roomId):h-f}else return Tu(n.order,i.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(j.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var n=t.getStateKey();if(!n)throw new Error("No state key found for parent");var i=this.client.getRoom(n);if(!i)throw new Error("Unable to locate room for parent");return i}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(j.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex(i=>i.roomId===this.roomId)}setOrder(e){var t=this;return w(function*(){var n;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var i=t.getParentRoom(),a=i.currentState.getStateEvents(j.SpaceChild),s=t.getOrderedChildren(a);e=Math.max(Math.min(e,s.length-1),0);var o=t.getOrder(),l=o<e;l&&e===s.length-1?e--:!l&&e===0&&e++;var u=s[l?e:e-1],d=s[l?e+1:e],h=Ii[0],f=!1;if(!u)d!=null&&d.order&&(h=Vg(d.order));else if(e===s.length-1)d!=null&&d.order&&(h=qs(d.order));else{var m=u==null?void 0:u.order,v=d==null?void 0:d.order;m&&v?m===v?h=qs(m):h=yO(m,v):m?h=qs(m):v?h=Vg(v):f=!0}if(f){for(var y,I=0;I<=e;I++){var g=s[I];if(I===0&&(y=g.order),g.order)y=g.order;else{var p;y=y?qs(y):Ii[0];var b=i.currentState.getStateEvents(j.SpaceChild,g.roomId),R=(p=b==null?void 0:b.getContent())!==null&&p!==void 0?p:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,j.SpaceChild,Ni(Ni({},R),{},{order:y}),g.roomId)}}y&&(h=qs(y))}var P=i.currentState.getStateEvents(j.SpaceChild,t.roomId),E=(n=P==null?void 0:P.getContent())!==null&&n!==void 0?n:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,j.SpaceChild,Ni(Ni({},E),{},{order:h}),t.roomId)})()}createFile(e,t,n,i){var a=this;return w(function*(){var{content_uri:s}=yield a.client.uploadContent(t,{includeFilename:!1});n.url=s;var o={msgtype:Sn.File,body:e,url:s,file:n};i=i??{},i["m.new_content"]&&(i["m.new_content"]=o);var l=yield a.client.sendMessage(a.roomId,Ni(Ni(Ni({},i),o),{},{[Nb.name]:{}}));return yield a.client.sendStateEvent(a.roomId,Cn.name,{active:!0,name:e},l.event_id),l})()}getFile(e){var t=this.room.currentState.getStateEvents(Cn.name,e);return t?new Yy(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(Cn.name))!==null&&e!==void 0?e:[];return t.map(n=>new Yy(this.client,n,this))}}var B0=function(r){return r.Recent="recent",r.Rank="rank",r}({}),Gi=function(r){return r.LocalStreamsChanged="local_streams_changed",r}({});class lD extends nt{constructor(e){super(),this.client=e,c(this,"audioInput",void 0),c(this,"audioSettings",void 0),c(this,"videoInput",void 0),c(this,"localUserMediaStream",void 0),c(this,"userMediaStreams",[]),c(this,"screensharingStreams",[]),c(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return w(function*(){T.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return w(function*(){T.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return w(function*(){T.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return w(function*(){T.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return w(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var n of e.client.callEventHandler.calls.values())t.set(n.callId,{audio:n.hasLocalUserMediaAudioTrack,video:n.hasLocalUserMediaVideoTrack});for(var i of e.userMediaStreams){T.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(i.id,")"));for(var a of i.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var s of e.client.callEventHandler.calls.values())if(!(s.callHasEnded()||!t.has(s.callId))){var{audio:o,video:l}=t.get(s.callId);T.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(s.callId,")"));var u=yield e.getUserMediaStream(o,l);s.callHasEnded()||(yield s.updateLocalUsermediaStream(u))}for(var d of e.client.groupCallEventHandler.groupCalls.values())if(d.localCallFeed){T.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(d.groupCallId,")"));var h=yield e.getUserMediaStream(!0,d.type===cc.Video);d.state!==ut.Ended&&(yield d.updateLocalUsermediaStream(h))}e.emit(Gi.LocalStreamsChanged)}})()}hasAudioDevice(){return w(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return T.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return w(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return T.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var n=arguments,i=this;return w(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0;return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,a)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,a),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var i=this;return w(function*(){var a=e&&(yield i.hasAudioDevice()),s=t&&(yield i.hasVideoDevice()),o,l=!0;if(i.localUserMediaStream){var u,d;a!==i.localUserMediaStream.getAudioTracks().length>0&&(l=!1),s!==i.localUserMediaStream.getVideoTracks().length>0&&(l=!1),a&&((u=i.localUserMediaStream.getAudioTracks()[0])===null||u===void 0||(u=u.getSettings())===null||u===void 0?void 0:u.deviceId)!==i.audioInput&&(l=!1),s&&((d=i.localUserMediaStream.getVideoTracks()[0])===null||d===void 0||(d=d.getSettings())===null||d===void 0?void 0:d.deviceId)!==i.videoInput&&(l=!1)}else l=!1;if(l){var v;if(o=i.localUserMediaStream.clone(),T.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((v=i.localUserMediaStream)===null||v===void 0?void 0:v.id," newStreamId=").concat(o.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(s,")")),!a)for(var y of o.getAudioTracks())o.removeTrack(y);if(!s)for(var I of o.getVideoTracks())o.removeTrack(I)}else{var h=i.getUserMediaContraints(a,s);o=yield navigator.mediaDevices.getUserMedia(h),T.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(o.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(s,", constraints=").concat(JSON.stringify(h),")"));for(var f of o.getTracks()){var m=f.getSettings();f.kind==="audio"?i.audioInput=m.deviceId:f.kind==="video"&&(i.videoInput=m.deviceId)}n&&(i.localUserMediaStream=o)}return n&&i.userMediaStreams.push(o),i.emit(Gi.LocalStreamsChanged),o})()}stopUserMediaStream(e){T.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.userMediaStreams.indexOf(e);if(n!==-1&&(T.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(Gi.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var i of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(i.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{},i=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var s=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(T.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getUserMedia(s)):(T.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getDisplayMedia(s))}else{var o=t.screensharingStreams[t.screensharingStreams.length-1];T.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(o.id,")")),a=o.clone()}return i&&t.screensharingStreams.push(a),t.emit(Gi.LocalStreamsChanged),a})()}stopScreensharingStream(e){T.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.screensharingStreams.indexOf(e);n!==-1&&(T.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(n,1)),this.emit(Gi.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){T.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var n of this.screensharingStreams)for(var i of n.getTracks())i.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(Gi.LocalStreamsChanged)}getUserMediaContraints(e,t){var n=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:n??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:n??!1,video:!0}}}var Zy=function(r){return r.RequestFinished="FINISHED",r.Complete="COMPLETE",r}({}),Pl=function(r){return r.PreProcess="ExtState.PreProcess",r.PostProcess="ExtState.PostProcess",r}({}),yv=function(r){return r.RoomData="SlidingSync.RoomData",r.Lifecycle="SlidingSync.Lifecycle",r}({}),uD=3;class dD{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return Pl.PreProcess}onRequest(e){var t=this;return w(function*(){return e&&(T.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return w(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class cD{constructor(e,t){this.client=e,this.cryptoCallbacks=t,c(this,"nextBatch",null)}name(){return"to_device"}when(){return Pl.PreProcess}onRequest(e){var t=this;return w(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return w(function*(){var n=e.events||[],i;t.cryptoCallbacks?i=yield t.cryptoCallbacks.preprocessToDeviceMessages(n):i=n.map(a=>({message:a,encryptionInfo:null})),P0(i,t.client),t.nextBatch=e.next_batch})()}}class hD{constructor(e){this.client=e}name(){return"account_data"}when(){return Pl.PostProcess}onRequest(e){return w(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return w(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var n in e.rooms){var i=rs(t.client,n,e.rooms[n]),a=t.client.getRoom(n);if(!a){T.warn("got account data for room but room doesn't exist on client:",n);continue}a.addAccountData(i),i.forEach(s=>{t.client.emit(ce.Event,s)})}})()}processGlobalAccountData(e){var t=rs(this.client,void 0,e),n=t.reduce((i,a)=>(i[a.getType()]=this.client.store.getAccountData(a.getType()),i),{});this.client.store.storeAccountDataEvents(t),t.forEach(i=>{if(i.getType()===j.PushRules){var a=i.getContent();this.client.setPushRules(a)}var s=n[i.getType()];return this.client.emit(ce.AccountData,i,s),i})}}class fD{constructor(e){this.client=e}name(){return"typing"}when(){return Pl.PostProcess}onRequest(e){return w(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return w(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)W0(t.client,n,[e.rooms[n]])})()}}class vD{constructor(e){this.client=e}name(){return"receipts"}when(){return Pl.PostProcess}onRequest(e){return w(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return w(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)W0(t.client,n,[e.rooms[n]])})()}}class $0{constructor(e,t,n,i){this.slidingSync=e,this.client=t,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"lastPos",null),c(this,"failCount",0),c(this,"notifEvents",[]),this.opts=C0(n),this.syncOpts=O0(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[le.Timeline,le.TimelineReset]),this.slidingSync.on(yv.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(yv.RoomData,this.onRoomData.bind(this));var a=[new cD(this.client,this.syncOpts.cryptoCallbacks),new hD(this.client),new fD(this.client),new vD(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new dD(this.syncOpts.cryptoCallbacks)),a.forEach(s=>{this.slidingSync.registerExtension(s)})}onRoomData(e,t){var n=this;return w(function*(){var i=n.client.store.getRoom(e);if(!i){if(!t.initial){n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}i=k0(n.client,e,n.opts)}yield n.processRoomData(n.client,i,t)})()}onLifecycle(e,t,n){switch(n&&this.syncOpts.logger.debug("onLifecycle",e,n),e){case Zy.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(qe.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(qe.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case Zy.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>uD?qe.Error:qe.Reconnecting,{error:new mt(n)}),this.shouldAbortSync(new mt(n)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys((t==null?void 0:t.rooms)||[]).length," rooms"));break}}syncLeftRooms(){return w(function*(){return[]})()}peek(e){return w(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,n=new uc(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[le.Name,le.Redaction,le.RedactionCancelled,le.Receipt,le.Tags,le.LocalEchoUpdated,le.AccountData,le.MyMembership,le.Timeline,le.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[Ae.Events,Ae.Members,Ae.NewMember,Ae.Update]),e.currentState.on(Ae.NewMember,(t,n,i)=>{var a;i.user=(a=this.client.getUser(i.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(i,[ur.Name,ur.Typing,ur.PowerLevel,ur.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(qe.Error,{error:e}),!0):!1}processRoomData(e,t,n){var i=this;return w(function*(){n=pD(e,t.roomId,n);var a=rs(i.client,t.roomId,n.required_state),s=rs(i.client,t.roomId,n.timeline,!1),o=[];if(n.limited||n.initial){var l=new Set;t.getLiveTimeline().getEvents().forEach(p=>{l.add(p.getId())});for(var u=[],d=[],h=!1,f=s.length-1;f>=0;f--){var m=s[f];if(l.has(m.getId())){h=!0;continue}h?u.push(m):d.unshift(m)}s=d,u.length>0&&t.addEventsToTimeline(u,!0,!1,t.getLiveTimeline(),n.prev_batch)}var v=t.hasEncryptionStateEvent();if(n.notification_count!=null&&t.setUnreadNotificationCount(We.Total,n.notification_count),n.highlight_count!=null&&(!v||v&&t.getUnreadNotificationCount(We.Highlight)<=0)&&t.setUnreadNotificationCount(We.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var y=rs(i.client,t.roomId,n.invite_state);yield i.injectRoomEvents(t,y),n.initial&&(t.recalculate(),i.client.store.storeRoom(t),i.client.emit(ce.Room,t)),y.forEach(p=>{i.client.emit(ce.Event,p)});return}if(n.limited){var I;t.getLiveTimeline().setPaginationToken((I=n.prev_batch)!==null&&I!==void 0?I:null,se.BACKWARDS)}yield i.injectRoomEvents(t,a,s,n.num_live),t.addEphemeralEvents(o),t.updateMyMembership(Ie.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(ce.Room,t)),i.addNotifications(s);var g=function(){var p=w(function*(b){e.emit(ce.Event,b),b.isState()&&b.getType()==j.RoomEncryption&&i.syncOpts.cryptoCallbacks&&(yield i.syncOpts.cryptoCallbacks.onCryptoEvent(t,b))});return function(R){return p.apply(this,arguments)}}();yield Ka(a,g),yield Ka(s,g),o.forEach(function(p){e.emit(ce.Event,p)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,i=this;return w(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:[],s=n.length>3&&n[3]!==void 0?n[3]:0,o=e.getLiveTimeline(),l=o.getEvents().length==0;if(l){for(var u of t)i.client.getPushActionsForEvent(u);o.initialiseState(t)}l||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var d=[];s>0&&(d=a.slice(-1*s),a=a.slice(0,-1*d.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),d.length>0&&(yield e.addLiveEvents(d,{fromCache:!1,addToState:!1})),e.recalculate(),i.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ie.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var o=n.events.member;o.getContent().membership===Ie.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,n.setMembershipEvent(o,e.currentState))},function(s){})}})}}retryImmediately(){return!0}sync(){var e=this;return w(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(n){if(e.syncOpts.logger.error("Getting push rules failed",n),e.shouldAbortSync(n))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ce.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var n=this.client.getPushActionsForEvent(t);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function pD(r,e,t){if(!t.name)return t;for(var n of t.required_state)if(n.type===j.RoomName&&n.state_key==="")return n.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:j.RoomName,content:{name:t.name},sender:r.getUserId(),origin_server_ts:new Date().getTime()}),t}function rs(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,i=r.getEventMapper({decrypt:n});return t.map(function(a){return a.room_id=e,i(a)})}function W0(r,e,t){var n=rs(r,e,t),i=r.getRoom(e);if(!i){T.warn("got ephemeral events for room but room doesn't exist on client:",e);return}i.addEphemeralEvents(n),n.forEach(a=>{r.emit(ce.Event,a)})}var Zp=new Et("m.beacon_info","org.matrix.msc3672.beacon_info"),Sv=new Et("m.beacon","org.matrix.msc3672.beacon");class Es{static RETRY_BACKOFF_RATELIMIT(e,t,n){return _0(n,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===j.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Es.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Es.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,c(this,"queues",{}),c(this,"activeQueues",[]),c(this,"procFn",null),c(this,"processQueue",n=>{var i=this.peekNextEvent(n);if(!i){this.disableQueue(n);return}this.queues[n].length,Promise.resolve().then(()=>this.procFn(i.event)).then(a=>{this.removeNextEvent(n),i.event.getId(),i.resolvers.resolve(a),this.processQueue(n)},a=>{i.attempts+=1;var s=this.retryAlgorithm(i.event,i.attempts,a);i.attempts,i.event.getId(),s===-1?(T.info("Queue '%s' giving up on event %s",n,i.event.getId()),this.clearQueue(n,a)):setTimeout(this.processQueue,s,n)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(n){return n.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var n=!1;return hd(this.queues[t],i=>i.event.getId()===e.getId()?(n=!0,!0):!1),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var n=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),T.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){T.info("clearing queue '%s'",e);for(var n;n=this.removeNextEvent(e);)n.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var eS=20;class mD{constructor(e,t){var n=this;this.client=e,this.logger=t,c(this,"sending",!1),c(this,"running",!0),c(this,"retryTimeout",null),c(this,"retryAttempts",0),c(this,"sendQueue",w(function*(){if(n.retryTimeout!==null&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!(n.sending||!n.running)){n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;var i;try{for(;n.running&&(i=yield n.client.store.getOldestToDeviceBatch(),i!==null);)yield n.sendBatch(i),yield n.client.store.removeToDeviceBatch(i.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(s){++n.retryAttempts;var a=Es.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,s);if(a===-1){Math.floor(s.httpStatus/100)===4?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield n.client.store.removeToDeviceBatch(i.id)):n.logger.info("Automatic retry limit reached for to-device messages.");return}n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(a,"ms"),s),n.retryTimeout=setTimeout(n.sendQueue,a)}finally{n.sending=!1}}})),c(this,"onResumedSync",(i,a)=>{i===qe.Syncing&&a!==qe.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ce.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ce.Sync,this.onResumedSync)}queueBatch(e){var t=this;return w(function*(){for(var n=[],i=0;i<e.batch.length;i+=eS){var a={eventType:e.eventType,batch:e.batch.slice(i,i+eS),txnId:t.client.makeTxnId()};n.push(a);var s=a.batch.map(o=>"".concat(o.userId,"/").concat(o.deviceId," (msgid ").concat(o.payload[ic],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),s)}yield t.client.store.saveToDeviceBatches(n),t.sendQueue()})()}sendBatch(e){var t=this;return w(function*(){var n=new Nn(()=>new Map);for(var i of e.batch)n.getOrCreate(i.userId).set(i.deviceId,i.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,n,e.txnId)})()}}var vh=new nr.UnstableValue("m.policies","org.matrix.msc3847.policies"),lu=new nr.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),tS=function(r){return r.Ban="m.ban",r}({}),ns=function(r){return r.User="m.policy.user",r.Room="m.policy.room",r.Server="m.policy.server",r}({}),rS={[ns.User]:j.PolicyRuleUser,[ns.Room]:j.PolicyRuleRoom,[ns.Server]:j.PolicyRuleServer};class gD{constructor(e){this.client=e}addRule(e,t,n){var i=this;return w(function*(){var a=yield i.getOrCreateTargetRoom(),s=yield i.client.sendStateEvent(a.roomId,rS[e],{entity:t,reason:n,recommendation:tS.Ban});return s.event_id})()}removeRule(e){var t=this;return w(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return w(function*(){yield t.client.joinRoom(e);var n=(yield t.getOrCreateSourceRooms()).map(i=>i.roomId);return n.includes(e)?!1:(n.push(e),yield t.withIgnoreInvitesPolicies(i=>{i.sources=n}),!0)})()}getRuleForInvite(e){var t=this;return w(function*(){var{sender:n,roomId:i}=e,a=yield t.getOrCreateSourceRooms(),s=n.split(":")[1],o=i.split(":")[1];for(var l of a){var u=l.getUnfilteredTimelineSet().getLiveTimeline().getState(se.FORWARDS);for(var{scope:d,entities:h}of[{scope:ns.Room,entities:[i]},{scope:ns.User,entities:[n]},{scope:ns.Server,entities:[s,o]}]){var f=u.getStateEvents(rS[d]);for(var m of f){var v=m.getContent();if((v==null?void 0:v.recommendation)==tS.Ban){var y=v==null?void 0:v.entity;if(y){var I=void 0;try{I=new RegExp(Eb(y))}catch{continue}for(var g of h)if(g&&I.test(g))return m}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return w(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.target;if(typeof n!="string"&&(n=null),n){var i=e.client.getRoom(n);if(i)return i;n=null}return n=(yield e.client.createRoom({name:"Individual Policy Room",preset:Qp.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=n}),e.client.getRoom(n)})()}getOrCreateSourceRooms(){var e=this;return w(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.sources,i=!1;Array.isArray(n)||(i=!0,n=[]);var a=n.filter(o=>typeof o=="string").map(o=>e.client.getRoom(o)).filter(o=>!!o);if(a.length!=n.length&&(i=!0),a.length==0){var s=yield e.getOrCreateTargetRoom();i=!0,a=[s]}return i&&(yield e.withIgnoreInvitesPolicies(o=>{o.sources=n})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return w(function*(){var{policies:n,ignoreInvitesPolicies:i}=t.getPoliciesAndIgnoreInvitesPolicies();e(i),n[lu.name]=i,yield t.client.setAccountData(vh.name,n)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[vh.name,vh.altName]){var n;if(t){var i=(n=this.client.getAccountData(t))===null||n===void 0?void 0:n.getContent();if(i){e=i;break}}}var a={},s=!1;for(var o of[lu.name,lu.altName])if(o){var l=e[o];if(l&&typeof l=="object"){a=l,s=!0;break}}return s||(e[lu.name]=a),{policies:e,ignoreInvitesPolicies:a}}}var ph="matrix-js-sdk";function yD(r){if(r.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let u=0;u<e.length;u++)e[u]=255;for(let u=0;u<r.length;u++){const d=r.charAt(u),h=d.charCodeAt(0);if(e[h]!==255)throw new TypeError(d+" is ambiguous");e[h]=u}const t=r.length,n=r.charAt(0),i=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function s(u){if(u instanceof Uint8Array||(ArrayBuffer.isView(u)?u=new Uint8Array(u.buffer,u.byteOffset,u.byteLength):Array.isArray(u)&&(u=Uint8Array.from(u))),!(u instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(u.length===0)return"";let d=0,h=0,f=0;const m=u.length;for(;f!==m&&u[f]===0;)f++,d++;const v=(m-f)*a+1>>>0,y=new Uint8Array(v);for(;f!==m;){let p=u[f],b=0;for(let R=v-1;(p!==0||b<h)&&R!==-1;R--,b++)p+=256*y[R]>>>0,y[R]=p%t>>>0,p=p/t>>>0;if(p!==0)throw new Error("Non-zero carry");h=b,f++}let I=v-h;for(;I!==v&&y[I]===0;)I++;let g=n.repeat(d);for(;I<v;++I)g+=r.charAt(y[I]);return g}function o(u){if(typeof u!="string")throw new TypeError("Expected String");if(u.length===0)return new Uint8Array;let d=0,h=0,f=0;for(;u[d]===n;)h++,d++;const m=(u.length-d)*i+1>>>0,v=new Uint8Array(m);for(;d<u.length;){const p=u.charCodeAt(d);if(p>255)return;let b=e[p];if(b===255)return;let R=0;for(let P=m-1;(b!==0||R<f)&&P!==-1;P--,R++)b+=t*v[P]>>>0,v[P]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");f=R,d++}let y=m-f;for(;y!==m&&v[y]===0;)y++;const I=new Uint8Array(h+(m-y));let g=h;for(;y!==m;)I[g++]=v[y++];return I}function l(u){const d=o(u);if(d)return d;throw new Error("Non-base"+t+" character")}return{encode:s,decodeUnsafe:o,decode:l}}var SD="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const QN=yD(SD);var Mt=function(r){return r.UserTrustStatusChanged="userTrustStatusChanged",r.KeyBackupStatus="crypto.keyBackupStatus",r.KeyBackupFailed="crypto.keyBackupFailed",r.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",r.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",r.VerificationRequestReceived="crypto.verificationRequestReceived",r.WillUpdateDevices="crypto.willUpdateDevices",r.DevicesUpdated="crypto.devicesUpdated",r.KeysChanged="crossSigning.keysChanged",r.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",r.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",r.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",r.RehydrationStarted="dehydration.RehydrationStarted",r.RehydrationProgress="dehydration.RehydrationProgress",r.RehydrationCompleted="dehydration.RehydrationCompleted",r.RehydrationError="dehydration.RehydrationError",r.DehydrationKeyCached="dehydration.DehydrationKeyCached",r.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",r}({}),nS=function(r){return r.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",r.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",r.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",r.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",r.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",r.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",r.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",r.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",r.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",r.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",r.UNKNOWN_ERROR="UNKNOWN_ERROR",r.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",r.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",r.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",r.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",r.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",r.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",r.OLM_BAD_ROOM="OLM_BAD_ROOM",r.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",r.OLM_BAD_SENDER="OLM_BAD_SENDER",r.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",r.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",r.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",r.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",r}({}),ED=function(r){return r[r.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",r[r.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",r}({});class XN{constructor(e){this.errorOnVerifiedUserProblems=e,c(this,"kind",ED.AllDevicesIsolationMode)}}class ZN{constructor(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n,c(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class e1{constructor(e){var t,n,i,a,s;c(this,"signedByOwner",void 0),c(this,"crossSigningVerified",void 0),c(this,"tofu",void 0),c(this,"localVerified",void 0),c(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(n=e.crossSigningVerified)!==null&&n!==void 0?n:!1,this.tofu=(i=e.tofu)!==null&&i!==void 0?i:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(s=e.trustCrossSignedDevices)!==null&&s!==void 0?s:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var t1=function(r){return r.Fetch="fetch",r.LoadKeys="load_keys",r}({}),r1=function(r){return r.Master="master",r.SelfSigning="self_signing",r.UserSigning="user_signing",r}({}),n1=function(r){return r[r.NONE=0]="NONE",r[r.GREY=1]="GREY",r[r.RED=2]="RED",r}({}),i1=function(r){return r[r.UNKNOWN=0]="UNKNOWN",r[r.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",r[r.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",r[r.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",r[r.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",r[r.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",r[r.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",r[r.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",r[r.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",r}({}),_D=new Uint8Array(8);function K0(r,e){return Ev.apply(this,arguments)}function Ev(){return Ev=w(function*(r,e){var t=yield globalThis.crypto.subtle.importKey("raw",r,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:_D,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),i=n.slice(0,32),a=n.slice(32),s=globalThis.crypto.subtle.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),o=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,o])}),Ev.apply(this,arguments)}function V0(r,e,t,n){return _v.apply(this,arguments)}function _v(){return _v=w(function*(r,e,t,n){var i;n?i=ra(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var[a,s]=yield K0(e,t),o=new TextEncoder().encode(r),l=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},a,o),u=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,l);return{iv:Co(i),ciphertext:Co(new Uint8Array(l)),mac:Co(new Uint8Array(u))}}),_v.apply(this,arguments)}function bD(r,e,t){return bv.apply(this,arguments)}function bv(){return bv=w(function*(r,e,t){var[n,i]=yield K0(e,t),a=ra(r.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},i,ra(r.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:ra(r.iv),length:64},n,a);return new TextDecoder().decode(new Uint8Array(s))}),bv.apply(this,arguments)}var qi="m.secret_storage.v1.aes-hmac-sha2";class G0{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return w(function*(){var t,n=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return n&&(t=n.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,n)=>{var i=s=>{if(s.getType()==="m.secret_storage.default_key"){var o=s.getContent(),l=e===null?Object.keys(o).length===0:o.key===e;l&&(this.accountDataAdapter.removeListener(ce.AccountData,i),t())}};this.accountDataAdapter.on(ce.AccountData,i);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(s=>{this.accountDataAdapter.removeListener(ce.AccountData,i),n(s)})})}addKey(e,t,n){var i=this;return w(function*(){if(e!==qi)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:s,mac:o}=yield Tv(t.key);if(a.iv=s,a.mac=o,!n)do n=bi(32);while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),a),{keyId:n,keyInfo:a}})()}getKey(e){var t=this;return w(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var n=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return n?[e,n]:null})()}hasKey(e){var t=this;return w(function*(){var n=yield t.getKey(e);return!!n})()}checkKey(e,t){return w(function*(){if(t.algorithm===qi)if(t.mac){var{mac:n}=yield Tv(e,t.iv);return wv(t.mac)===wv(n)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,n){var i=this;return w(function*(){if(t===null){yield i.accountDataAdapter.setAccountData(e,{});return}var a={};if(!n){var s=yield i.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");n=[s]}if(n.length===0)throw new Error("Zero keys given to encrypt with!");for(var o of n){var l=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(o));if(!l)throw new Error("Unknown key: "+o);if(l.algorithm===qi){var u={[o]:l},[,d]=yield i.getSecretStorageKey(u,e);a[o]=yield d.encrypt(t)}else T.warn("unknown algorithm for secret storage key "+o+": "+l.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return w(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(n){if(!n.encrypted)throw new Error("Content is not encrypted!");var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),o=n.encrypted[a];(s==null?void 0:s.algorithm)===qi&&o.iv&&o.ciphertext&&o.mac&&(i[a]=s)}if(Object.keys(i).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[l,u]=yield t.getSecretStorageKey(i,e),d=n.encrypted[l];return u.decrypt(d)}})()}isStored(e){var t=this;return w(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(n!=null&&n.encrypted))return null;var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(s){var o=n.encrypted[a];s.algorithm===qi&&o.iv&&o.ciphertext&&o.mac&&(i[a]=s)}}return Object.keys(i).length?i:null})()}getSecretStorageKey(e,t){var n=this;return w(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var i=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,s]=i;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===qi){var o={encrypt:function(u){return V0(u,s,t)},decrypt:function(u){return bD(u,s,t)}};return[a,o]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}}function wv(r){for(var e=r.length;e>=1&&r.charCodeAt(e-1)==61;)e--;return e<r.length?r.substring(0,e):r}var wD="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function Tv(r,e){return V0(wD,r,"",e)}const TD=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:qi,ServerSideSecretStorageImpl:G0,calculateKeyCheck:Tv,trimTrailingEquals:wv},Symbol.toStringTag,{value:"Module"}));var q0=r=>r.type==="livekit"&&"focus_selection"in r,H0=1e3*60*60*4,RD=(r,e)=>{var t,n="Malformed session membership event: ";return typeof r.device_id!="string"&&e.push(n+"device_id must be string"),typeof r.call_id!="string"&&e.push(n+"call_id must be string"),typeof r.application!="string"&&e.push(n+"application must be a string"),typeof((t=r.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(n+"focus_active.type must be a string"),Array.isArray(r.foci_preferred)||e.push(n+"foci_preferred must be an array"),r.created_ts&&typeof r.created_ts!="number"&&e.push(n+"created_ts must be number"),r.scope&&typeof r.scope!="string"&&e.push(n+"scope must be string"),e.length===0};class iS{static equal(e,t){return gs(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,c(this,"membershipData",void 0);var n=[];if(RD(t,n))this.membershipData=t;else throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(n.join(" & "),") events this could be a legacy membership event: (").concat(t,")"))}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+((e=this.membershipData.expires)!==null&&e!==void 0?e:H0)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(q0(e))return e.focus_selection}}var Mu=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({}),em=function(r){return r.TooNew="TOO_NEW",r}({});class tm extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}c(tm,"TOO_NEW",em.TooNew);class ID extends Error{constructor(e,t){super(e),this.value=t}}class CD extends Error{constructor(){super("MatrixClient has been stopped")}}class hi extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}var Li=function(r){return r.Disconnected="Disconnected",r.Connecting="Connecting",r.ConnectingFailed="ConnectingFailed",r.Connected="Connected",r.Reconnecting="Reconnecting",r.Disconnecting="Disconnecting",r.Stuck="Stuck",r.Unknown="Unknown",r}({}),Au=(r,e,t)=>r.sender===e&&r.deviceId===t;class OD{constructor(e,t){this.membershipLoopHandler=e,c(this,"logger",void 0),c(this,"running",!1),c(this,"wakeup",n=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),c(this,"_actions",[]),this.logger=(t??T).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return w(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:we.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((u,d)=>u.ts-d.ts);var i=e._actions[0],a=void 0,s=new Promise(u=>{e.wakeup=d=>{a=d,u()}});i.ts>Date.now()&&(yield Promise.race([s,wl(i.ts-Date.now())]));var o={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(i.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{o=yield e.membershipLoopHandler(i.type)}catch(u){throw Error("The MembershipManager shut down because of the end condition: ".concat(u))}}e._actions.splice(0,1);var l=a??o;"replace"in l?e._actions=l.replace:"insert"in l&&e._actions.push(...l.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:we.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:we.SendScheduledDelayedLeaveEvent}]})}}var aS=function(r){return r.StatusChanged="StatusChanged",r}({}),we=function(r){return r.SendDelayedEvent="SendDelayedEvent",r.SendJoinEvent="SendJoinEvent",r.RestartDelayedEvent="RestartDelayedEvent",r.UpdateExpiry="UpdateExpiry",r.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",r.SendLeaveEvent="SendLeaveEvent",r}({});class Cd extends nt{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,n){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.focusActive=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=Cd.defaultState,this.scheduler.startWithJoin().catch(i=>{this.logger.error("MembershipManager stopped because: ",i),n==null||n(i)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(aS.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var i;(i=this.leavePromiseResolvers)===null||i===void 0||i.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){var t=this;return w(function*(){var n=t.client.getUserId(),i=t.client.getDeviceId();if(!n||!i)return t.logger.error("MembershipManager.onRTCSessionMemberUpdate called without user or device id"),Promise.resolve();if(t._ownMembership=e.find(s=>Au(s,n,i)),t.isActivated()&&!t._ownMembership){var a=[we.SendDelayedEvent,we.SendJoinEvent];t.logger.warn("Missing own membership: force re-join"),t.state.hasMemberStateEvent=!1,t.scheduler.actions.some(s=>a.includes(s.type))?t.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",t.scheduler.actions):t.scheduler.initiateJoin()}return Promise.resolve()})()}getActiveFocus(){if(this.focusActive)if(q0(this.focusActive)){if(this.focusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e==null?void 0:e.getPreferredFoci()[0]}}else this.logger.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.");else{var t=this.getOldestMembership();return t==null?void 0:t.getPreferredFoci()[0]}}constructor(e,t,n,i,a){super(),this.joinConfig=e,this.room=t,this.client=n,this.getOldestMembership=i,c(this,"activated",!1),c(this,"logger",void 0),c(this,"leavePromiseResolvers",void 0),c(this,"_ownMembership",void 0),c(this,"oldStatus",void 0),c(this,"scheduler",void 0),c(this,"state",void 0),c(this,"deviceId",void 0),c(this,"stateKey",void 0),c(this,"fociPreferred",void 0),c(this,"focusActive",void 0),c(this,"delayedLeaveEventDelayMsOverride",void 0),this.logger=(a??T).getChild("[MembershipManager]");var[s,o]=[this.client.getUserId(),this.client.getDeviceId()];if(s===null)throw Error("Missing userId in client");if(o===null)throw Error("Missing deviceId in client");this.deviceId=o,this.stateKey=this.makeMembershipStateKey(s,o),this.state=Cd.defaultState,this.scheduler=new OD(l=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(aS.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(l)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1}}get networkErrorRetryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.networkErrorRetryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeout)!==null&&e!==void 0?e:H0}get membershipEventExpiryHeadroomMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryHeadroomMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeoutHeadroom)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+this.membershipEventExpiryMs*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,n,i,a;return(e=(t=(n=this.delayedLeaveEventDelayMsOverride)!==null&&n!==void 0?n:(i=this.joinConfig)===null||i===void 0?void 0:i.delayedLeaveEventDelayMs)!==null&&t!==void 0?t:(a=this.joinConfig)===null||a===void 0?void 0:a.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventRestartMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return w(function*(){switch(e){case we.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case we.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):Or(we.SendDelayedEvent);case we.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):Or(we.SendLeaveEvent):{replace:[]};case we.SendJoinEvent:return t.sendJoinEvent();case we.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case we.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return w(function*(){return yield e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},j.GroupCallMemberPrefix,{},e.stateKey).then(t=>(e.resetRateLimitCounter(we.SendDelayedEvent),e.state.delayId=t.delay_id,e.state.hasMemberStateEvent?Or(we.RestartDelayedEvent,e.delayedLeaveEventRestartMs):Or(we.SendJoinEvent))).catch(t=>{var n=we.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return Or(n);var i=e.actionUpdateFromErrors(t,n,"sendDelayedStateEvent");if(i)return i;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),Or(we.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return w(function*(){return yield t.client._unstable_updateDelayedEvent(e,Mu.Cancel).then(()=>(t.state.delayId=void 0,t.resetRateLimitCounter(we.SendDelayedEvent),mh(we.SendDelayedEvent))).catch(n=>{var i=we.SendDelayedEvent,a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");if(a)return a;if(t.isNotFoundError(n))return t.state.delayId=void 0,mh(i);if(t.isUnsupportedDelayedEndpoint(n))return mh(we.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}restartDelayedEvent(e){var t=this;return w(function*(){var n=new Promise((i,a)=>{setTimeout(()=>{a(new hO("Restart delayed event timed out before the HS responded"))},t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_updateDelayedEvent(e,Mu.Restart),n]).then(()=>(t.resetRateLimitCounter(we.RestartDelayedEvent),Or(we.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(i=>{var a=we.RestartDelayedEvent;if(t.isNotFoundError(i))return t.state.delayId=void 0,Or(we.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(i))return{};var s=t.actionUpdateFromErrors(i,a,"updateDelayedEvent");if(s)return s;throw Error("Could not restart delayed event, even though delayed events are supported. "+i)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return w(function*(){return yield t.client._unstable_updateDelayedEvent(e,Mu.Send).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(we.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(n=>{var i=we.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(n))return{};if(t.isNotFoundError(n))return t.state.delayId=void 0,Or(i);var a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",n),Or(i))})})()}sendJoinEvent(){var e=this;return w(function*(){return yield e.client.sendStateEvent(e.room.roomId,j.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs),e.stateKey).then(()=>{e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(we.SendJoinEvent);var t=e.scheduler.actions.filter(n=>n.type!==we.UpdateExpiry&&n.type!==we.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:we.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:we.UpdateExpiry}]}}).catch(t=>{var n=e.actionUpdateFromErrors(t,we.SendJoinEvent,"sendStateEvent");if(n)return n;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return w(function*(){var t=e.state.expireUpdateIterations+1;return yield e.client.sendStateEvent(e.room.roomId,j.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs*t),e.stateKey).then(()=>(e.resetRateLimitCounter(we.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:we.UpdateExpiry}]})).catch(n=>{var i=e.actionUpdateFromErrors(n,we.UpdateExpiry,"sendStateEvent");if(i)return i;throw n})})()}sendFallbackLeaveEvent(){var e=this;return w(function*(){return yield e.client.sendStateEvent(e.room.roomId,j.GroupCallMemberPrefix,{},e.stateKey).then(()=>(e.resetRateLimitCounter(we.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var n=e.actionUpdateFromErrors(t,we.SendLeaveEvent,"sendStateEvent");if(n)return n;throw t})})()}makeMembershipStateKey(e,t){var n="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?n:"_".concat(n)}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:this.deviceId,expires:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}}isNotFoundError(e){return e instanceof mt&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof mt&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,n){var i=this.actionUpdateFromRateLimitError(e,n,t);if(i)return i;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,n){var i;if((e instanceof ha||e instanceof mt)&&e.isRateLimitError()){var a=(i=this.state.rateLimitRetries.get(n))!==null&&i!==void 0?i:0;if(a<this.maximumRateLimitRetryCount){var s,o=5e3;try{var l;s=(l=e.getRetryAfterMs())!==null&&l!==void 0?l:o,this.logger.info("Rate limited by server, retrying in ".concat(s,"ms"))}catch(u){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(o),u),s=o}return this.state.rateLimitRetries.set(n,a+1),Or(n,s)}throw Error("Exceeded maximum retries for "+n+" attempts (client."+t+"): "+e)}}actionUpdateFromNetworkErrorRetry(e,t){var n,i=(n=this.state.networkErrorRetries.get(t))!==null&&n!==void 0?n:0,a=this.networkErrorRetryMs/1e3+"s",s="("+i+"/"+this.maximumNetworkErrorRetryCount+")",o=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")o=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+s+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+s,e);else if(e instanceof ga)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+s,e);else if((e instanceof ha||e instanceof mt)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+s,e);else return;if(i<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,i+1),Or(t,o);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof hi}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case we.SendDelayedEvent:case we.SendJoinEvent:return Li.Connecting;case we.UpdateExpiry:return Li.Connected;case we.SendScheduledDelayedLeaveEvent:case we.SendLeaveEvent:return Li.Disconnecting}}else if(e.length===2){var n=e.map(a=>a.type);if((n.includes(we.RestartDelayedEvent)||n.includes(we.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&n.includes(we.UpdateExpiry))return Li.Connected}else if(e.length===3){var i=e.map(a=>a.type);if(i.filter(a=>a===we.RestartDelayedEvent).length===2&&i.includes(we.UpdateExpiry))return Li.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Li.Unknown):Li.Disconnected}}function Or(r,e){return{insert:[{ts:Date.now()+(e??0),type:r}]}}function mh(r,e){return{replace:[{ts:Date.now()+0,type:r}]}}var fn=function(r){return r.ReceivedKeys="received_keys",r.NotSupportedError="not_supported_error",r}({});class kD{constructor(){c(this,"tsBuffer",new Map)}isOutdated(e,t){var n;this.tsBuffer.has(e)||this.tsBuffer.set(e,new Map);var i=(n=this.tsBuffer.get(e))===null||n===void 0?void 0:n.get(t.keyIndex);return i&&i>t.creationTS?!0:(this.tsBuffer.get(e).set(t.keyIndex,t.creationTS),!1)}}function na(r,e){return"".concat(r,":").concat(e)}class z0 extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class PD extends nt{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,n,i,a,s){super(),this.userId=e,this.deviceId=t,this.roomId=n,this.client=i,this.statistics=a,c(this,"logger",T),c(this,"onToDeviceEvent",o=>{if(o.getType()===j.CallEncryptionKeysPrefix){var l=this.getValidEventContent(o);l&&o.getSender()&&this.receiveCallKeyEvent(o.getSender(),l)}}),this.setParentLogger(s??T)}start(){this.client.on(ce.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(ce.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var i=this;return w(function*(){var a={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.deviceId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},s=n.map(o=>({userId:o.userId,deviceId:o.deviceId})).filter(o=>!(o.userId==i.userId&&o.deviceId==i.deviceId));s.length>0?(yield i.client.encryptAndSendToDevice(j.CallEncryptionKeysPrefix,s,a).catch(o=>{var l=o.message;if(l.includes("unknown variant")&&l.includes("send_to_device")||l.includes("not supported"))throw new z0("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var n=Date.now(),i=n-(typeof t.sent_ts=="number"?t.sent_ts:n);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=i,this.emit(fn.ReceivedKeys,e,t.member.claimed_device_id,t.keys.key,t.keys.index,n)}getValidEventContent(e){var t=e.getContent(),n=t.room_id;if(!n){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(n!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}}var fc=function(r){return r.EnabledTransportsChanged="enabled_transports_changed",r}({});class rm extends nt{constructor(e,t,n){var i;super(),i=this,this.toDeviceTransport=e,this.roomKeyTransport=t,c(this,"logger",void 0),c(this,"_enabled",{toDevice:!0,room:!1}),this.logger=(n??T).getChild("[RoomAndToDeviceTransport]"),this.toDeviceTransport.setParentLogger(this.logger),this.roomKeyTransport.setParentLogger(this.logger),this.roomKeyTransport.on(fn.ReceivedKeys,function(){i._enabled.room||(i.logger.debug("Received room key, enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}));for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];i.emit(fn.ReceivedKeys,...s)}),this.toDeviceTransport.on(fn.ReceivedKeys,function(){if(i._enabled.toDevice){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];i.emit(fn.ReceivedKeys,...s)}else i.logger.debug("To Device transport is disabled, ignoring received keys")})}setEnabled(e){(this.enabled.toDevice!==e.toDevice||this.enabled.room!==e.room)&&(this._enabled=e,this.emit(fc.EnabledTransportsChanged,e))}get enabled(){return this._enabled}start(){this.roomKeyTransport.start(),this.toDeviceTransport.start()}stop(){this.roomKeyTransport.stop(),this.toDeviceTransport.stop()}sendKey(e,t,n){var i=this;return w(function*(){if(i.logger.debug("Sending key with index ".concat(t," to call members (count=").concat(n.length,") via:")+(i._enabled.room?"room transport":"")+(i._enabled.room&&i._enabled.toDevice?"and":"")+(i._enabled.toDevice?"to device transport":"")),i._enabled.room&&(yield i.roomKeyTransport.sendKey(e,t,n)),i._enabled.toDevice)try{yield i.toDeviceTransport.sendKey(e,t,n)}catch(a){a instanceof z0&&!i._enabled.room&&(i.logger.warn("To device is not supported enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}),yield i.sendKey(e,t,n))}})()}}class MD{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,n,i,a,s,o){var l=this;this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,c(this,"manageMediaKeys",!1),c(this,"keysEventUpdateTimeout",void 0),c(this,"makeNewKeyTimeout",void 0),c(this,"setNewKeyTimeouts",new Set),c(this,"encryptionKeys",new Map),c(this,"lastEncryptionKeyUpdateRequest",void 0),c(this,"lastMembershipFingerprints",void 0),c(this,"latestGeneratedKeyIndex",-1),c(this,"joinConfig",void 0),c(this,"logger",void 0),c(this,"joined",!1),c(this,"sendEncryptionKeysEvent",function(){var u=w(function*(d){if(l.keysEventUpdateTimeout!==void 0&&(clearTimeout(l.keysEventUpdateTimeout),l.keysEventUpdateTimeout=void 0),l.lastEncryptionKeyUpdateRequest=Date.now(),!!l.joined){var h=l.getKeysForParticipant(l.userId,l.deviceId);if(!h){l.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof d!="number"&&l.latestGeneratedKeyIndex===-1){l.logger.warn("Tried to send encryption keys event but no current key index found!");return}var f=d??l.latestGeneratedKeyIndex;l.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(f," (method parameter: ").concat(d,")"));var m=h[f];try{l.statistics.counters.roomEventEncryptionKeysSent+=1;var v=l.getMemberships().filter(I=>I.sender!=null).map(I=>({userId:I.sender,deviceId:I.deviceId,membershipTs:I.createdTs()}));yield l.transport.sendKey(N0(m),f,v),l.logger.debug("sendEncryptionKeysEvent participantId=".concat(l.userId,":").concat(l.deviceId," numKeys=").concat(h.length," currentKeyIndex=").concat(l.latestGeneratedKeyIndex," keyIndexToSend=").concat(f))}catch(I){if(l.keysEventUpdateTimeout===void 0){var y=Kp(I,5e3);l.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(y),I),l.keysEventUpdateTimeout=setTimeout(()=>void l.sendEncryptionKeysEvent(),y)}else l.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(d){return u.apply(this,arguments)}}()),c(this,"onTransportChanged",()=>{this.requestSendCurrentKey()}),c(this,"onNewKeyReceived",(u,d,h,f,m)=>{this.logger.debug("Received key over key transport ".concat(u,":").concat(d," at index ").concat(f)),this.setEncryptionKey(u,d,f,h,m)}),c(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var u=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(u)}}),this.logger=(o??T).getChild("[EncryptionManager]")}getEncryptionKeys(){var e=new Map;for(var[t,n]of this.encryptionKeys){var i=n.map((a,s)=>({key:a.key,keyIndex:s}));e.set(t,i)}return e}join(e){var t,n,i;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(fn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof rm&&this.transport.on(fc.EnabledTransportsChanged,this.onTransportChanged),this.transport.start(),(i=this.joinConfig)!==null&&i!==void 0&&i.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(na(this.userId,this.deviceId),[]),this.transport.off(fn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(u=>!Au(u,this.userId,this.deviceId)).map(gh)),n=new Set(this.getMemberships().filter(u=>!Au(u,this.userId,this.deviceId)).map(gh)),i=Array.from(t).some(u=>!n.has(u)),a=Array.from(n).some(u=>!t.has(u)),s=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),i)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(s){var o=this.lastMembershipFingerprints,l=Array.from(s).some(u=>!o.has(u))||Array.from(o).some(u=>!s.has(u));l&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=bA(16),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.userId,this.deviceId,n,t,Date.now(),e),n}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>void this.sendEncryptionKeysEvent(),this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e,t){var n;return(n=this.encryptionKeys.get(na(e,t)))===null||n===void 0?void 0:n.map(i=>i.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!Au(e,this.userId,this.deviceId)).map(e=>"".concat(gh(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,n,i,a){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1;this.logger.debug("Setting encryption key for ".concat(e,":").concat(t," at index ").concat(n));var o=ra(i),l=na(e,t);this.encryptionKeys.has(l)||this.encryptionKeys.set(l,[]);var u=this.encryptionKeys.get(l),d=u[n];if(d){if(d.timestamp>a){this.logger.info("Ignoring new key at index ".concat(n," for ").concat(l," as it is older than existing known key"));return}if(AD(d.key,o)){d.timestamp=a;return}}if(e===this.userId&&t===this.deviceId&&(this.latestGeneratedKeyIndex=n),u[n]={key:o,timestamp:a},s){var h=setTimeout(()=>{this.setNewKeyTimeouts.delete(h),this.logger.info("Delayed-emitting key changed event for ".concat(l," index ").concat(n)),this.onEncryptionKeysChanged(o,n,l)},this.useKeyDelay);this.setNewKeyTimeouts.add(h)}else this.onEncryptionKeysChanged(o,n,l)}}function AD(r,e){return r===e?!0:!!r&&!!e&&r.length===e.length&&r.every((t,n)=>t===e[n])}var gh=r=>na(r.sender,r.deviceId);class sS extends nt{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,n,i){super(),this.room=e,this.client=t,this.statistics=n,c(this,"logger",T),this.setParentLogger(i??T)}start(){this.room.on(le.Timeline,e=>void this.consumeCallEncryptionEvent(e))}stop(){this.room.off(le.Timeline,e=>void this.consumeCallEncryptionEvent(e))}consumeCallEncryptionEvent(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield n.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){i?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>void n.consumeCallEncryptionEvent(e,!0),1e3));return}else i&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==j.CallEncryptionKeysPrefix)return Promise.resolve();if(!n.room)return n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();n.onEncryptionEvent(e)})()}sendKey(e,t,n){var i=this;return w(function*(){var a={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,j.CallEncryptionKeysPrefix,a)}catch(o){i.logger.error("Failed to send call encryption keys",o);var s=o;throw s.event&&i.client.cancelPendingEvent(s.event),o}})()}onEncryptionEvent(e){var t=e.getSender(),n=e.getContent(),i=n.device_id,a=n.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(i,", callId=").concat(a));return}if(!Array.isArray(n.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&i===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var s=Date.now()-(typeof n.sent_ts=="number"?n.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=s;for(var o of n.keys){if(!o){this.logger.info("Ignoring false-y key in keys event");continue}var l=o.key,u=o.index;!l||u===void 0||u===null||a===void 0||a===null||typeof i!="string"||typeof a!="string"||typeof l!="string"||typeof u!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(i,", encryptionKeyIndex=").concat(u," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(i," encryptionKeyIndex=").concat(u," age=").concat(s,"ms")),this.emit(fn.ReceivedKeys,t,i,l,u,e.getTs()))}}}class DD{constructor(e,t,n,i,a,s,o){this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,c(this,"manageMediaKeys",!1),c(this,"participantKeyRings",new Map),c(this,"outboundSession",null),c(this,"currentKeyDistributionPromise",null),c(this,"useKeyDelay",5e3),c(this,"keyRotationGracePeriodMs",1e4),c(this,"needToEnsureKeyAgain",!1),c(this,"keyBuffer",new kD),c(this,"logger",void 0),c(this,"onTransportChanged",()=>{var l;(l=this.logger)===null||l===void 0||l.info("Transport change detected, restarting key distribution"),this.currentKeyDistributionPromise?this.currentKeyDistributionPromise.then(()=>{this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}).catch(u=>{var d;(d=this.logger)===null||d===void 0||d.error("Failed to restart key distribution",u)}):this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}),c(this,"onNewKeyReceived",(l,u,d,h,f)=>{var m;if(!this.manageMediaKeys){var v;(v=this.logger)===null||v===void 0||v.warn("Received key over transport ".concat(l,":").concat(u," at index ").concat(h," but media keys are disabled"));return}(m=this.logger)===null||m===void 0||m.debug("Received key over transport ".concat(l,":").concat(u," at index ").concat(h));var y=na(l,u),I=ra(d),g={key:I,participantId:y,keyIndex:h,creationTS:f},p=this.keyBuffer.isOutdated(y,g);if(!p)this.addKeyToParticipant(g.key,g.keyIndex,g.participantId),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var b;(b=this.logger)===null||b===void 0||b.info("Received an out of order key for ".concat(l,":").concat(u,", dropping it"))}}),this.logger=o==null?void 0:o.getChild("[EncryptionManager]")}getEncryptionKeys(){return new Map(this.participantKeyRings)}addKeyToParticipant(e,t,n){this.participantKeyRings.has(n)||this.participantKeyRings.set(n,[]),this.participantKeyRings.get(n).push({key:e,keyIndex:t}),this.onEncryptionKeysChanged(e,t,n)}join(e){var t,n,i,a;this.manageMediaKeys=(t=e==null?void 0:e.manageMediaKeys)!==null&&t!==void 0?t:!0,(n=this.logger)===null||n===void 0||n.info("Joining room"),this.useKeyDelay=(i=e==null?void 0:e.useKeyDelay)!==null&&i!==void 0?i:1e3,this.keyRotationGracePeriodMs=(a=e==null?void 0:e.keyRotationGracePeriodMs)!==null&&a!==void 0?a:1e4,this.transport.on(fn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof rm&&this.transport.on(fc.EnabledTransportsChanged,this.onTransportChanged),this.transport.start()}leave(){this.transport.off(fn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var n;if((n=this.logger)===null||n===void 0||n.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var i;(i=this.logger)===null||i===void 0||i.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution()}rolloutOutboundKey(){var e=this;return w(function*(){var t,n,i=e.outboundSession==null;i&&(e.outboundSession={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0},e.addKeyToParticipant(e.outboundSession.key,e.outboundSession.keyId,na(e.userId,e.deviceId)));var a=e.getMemberships().filter(C=>C.sender!=null).map(C=>({userId:C.sender,deviceId:C.deviceId,membershipTs:C.createdTs()})),s=(t=(n=e.outboundSession)===null||n===void 0?void 0:n.sharedWith)!==null&&t!==void 0?t:[];s=s.filter(C=>!a.some(S=>C.userId==S.userId&&C.deviceId==S.deviceId&&C.membershipTs!=S.membershipTs));var o=s.filter(C=>!a.some(S=>C.userId==S.userId&&C.deviceId==S.deviceId&&C.membershipTs==S.membershipTs)),l=a.filter(C=>!s.some(S=>C.userId==S.userId&&C.deviceId==S.deviceId&&C.membershipTs==S.membershipTs)),u=[],d,h=!1;if(o.length>0){var f=e.createNewOutboundSession();h=!0,u=a,d=f}else if(l.length>0){var m=Date.now(),v=m-e.outboundSession.creationTS;if(v<e.keyRotationGracePeriodMs){var y;(y=e.logger)===null||y===void 0||y.debug("New joiners detected, but the key is recent enough (age:".concat(v,"), keeping it")),u=l,d=e.outboundSession}else{var I;(I=e.logger)===null||I===void 0||I.debug("New joiners detected, rotating the key");var g=e.createNewOutboundSession();h=!0,u=a,d=g}}else return;try{var p,b;if((p=e.logger)===null||p===void 0||p.trace("Sending key..."),yield e.transport.sendKey(Co(d.key),d.keyId,u),e.statistics.counters.roomEventEncryptionKeysSent+=1,d.sharedWith.push(...u),(b=e.logger)===null||b===void 0||b.trace("key index:".concat(d.keyId," sent to ").concat(d.sharedWith.map(C=>"".concat(C.userId,":").concat(C.deviceId)).join(","))),h){var R,P;(R=e.logger)===null||R===void 0||R.trace("Delay Rollout for key:".concat(d.keyId,"...")),yield wl(e.useKeyDelay),(P=e.logger)===null||P===void 0||P.trace("...Delayed rollout of index:".concat(d.keyId," ")),e.addKeyToParticipant(d.key,d.keyId,na(e.userId,e.deviceId))}}catch(C){var E;(E=e.logger)===null||E===void 0||E.error("Failed to rollout key",C)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}var Qn=function(r){return r.MembershipsChanged="memberships_changed",r.JoinStateChanged="join_state_changed",r.EncryptionKeyChanged="encryption_key_changed",r.MembershipManagerError="membership_manager_error",r}({});class is extends nt{get callId(){return this._callId}static callMembershipsForRoom(e){var t=T.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),n=e.getLiveTimeline().getState(se.FORWARDS);if(!n)throw t.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var i=n.getStateEvents(j.GroupCallMemberPrefix),a=[];for(var s of i){var o=s.getContent(),l=Object.keys(o).length;if(l!==0){var u=[];if(l>1&&"focus_active"in o?u.push(o):l===1&&"memberships"in o&&t.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),u.length!==0)for(var d of u)try{var h,f=new iS(s,d);if(f.callId!==""||f.scope!=="m.room"){t.info("Ignoring user-scoped call");continue}if(f.isExpired()){t.info("Ignoring expired device membership ".concat(f.sender,"/").concat(f.deviceId));continue}if(!e.hasMembershipState((h=f.sender)!==null&&h!==void 0?h:"",Ie.Join)){t.info("Ignoring membership of user ".concat(f.sender," who is not in the room."));continue}a.push(f)}catch(m){t.warn("Couldn't construct call membership: ",m)}}}return a.sort((m,v)=>m.createdTs()-v.createdTs()),a.length>1&&t.debug("Call memberships in room ".concat(e.roomId,", in order: "),a.map(m=>[m.createdTs(),m.sender])),a}static roomSessionForRoom(e,t){var n=is.callMembershipsForRoom(t);return new is(e,t,n)}get room(){return this.roomSubset}constructor(e,t,n){var i;super(),this.client=e,this.roomSubset=t,this.memberships=n,c(this,"membershipManager",void 0),c(this,"encryptionManager",void 0),c(this,"_callId",void 0),c(this,"joinConfig",void 0),c(this,"logger",void 0),c(this,"pendingNotificationToSend",void 0),c(this,"expiryTimeout",void 0),c(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),c(this,"reEmitter",new xs(this)),c(this,"onRoomMemberUpdate",()=>{this.recalculateSessionMembers()}),c(this,"onRTCSessionMemberUpdate",()=>{this.recalculateSessionMembers()}),c(this,"recalculateSessionMembers",()=>{var s,o,l,u=this.memberships;this.memberships=is.callMembershipsForRoom(this.room),this._callId=(s=this._callId)!==null&&s!==void 0?s:(o=this.memberships[0])===null||o===void 0?void 0:o.callId;var d=u.length!=this.memberships.length||u.some((y,I)=>!iS.equal(y,this.memberships[I]));if(d){var h,f;this.logger.info("Memberships for call in room ".concat(this.roomSubset.roomId," have changed: emitting (").concat(this.memberships.length," members)")),mO(this.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{this.emit(Qn.MembershipsChanged,u,this.memberships)}),(h=this.membershipManager)===null||h===void 0||h.onRTCSessionMemberUpdate(this.memberships);var m=(f=this.membershipManager)===null||f===void 0?void 0:f.ownMembership;if(this.pendingNotificationToSend&&m&&u.length===0){var v;m.eventId&&(v=this.joinConfig)!==null&&v!==void 0&&v.notificationType?this.sendCallNotify(m.eventId,this.joinConfig.notificationType):this.logger.warn("Own membership eventId is undefined, cannot send call notification")}this.memberships.length>0&&(this.pendingNotificationToSend=void 0)}(l=this.encryptionManager)===null||l===void 0||l.onMembershipsUpdate(u),this.setExpiryTimer()}),this.logger=T.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this._callId=(i=n[0])===null||i===void 0?void 0:i.callId;var a=this.roomSubset.getLiveTimeline().getState(se.FORWARDS);a==null||a.on(Ae.Members,this.onRoomMemberUpdate),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return w(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var n=e.roomSubset.getLiveTimeline().getState(se.FORWARDS);n==null||n.off(Ae.Members,e.onRoomMemberUpdate)})()}joinRoomSession(e,t,n){var i;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=new Cd(n,this.roomSubset,this.client,()=>this.getOldestMembership(),this.logger);var a;if(n!=null&&n.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[s,o]=[this.client.getUserId(),this.client.getDeviceId()],[l,u,d]=[this.roomSubset,this.client,this.statistics],h=new sS(l,u,d),f=new PD(s,o,l.roomId,u,d);a=new rm(f,h,this.logger),this.reEmitter.reEmit(a,[fc.EnabledTransportsChanged]),this.encryptionManager=new DD(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(m,v,y)=>{this.emit(Qn.EncryptionKeyChanged,m,v,y)},this.logger)}else a=new sS(this.roomSubset,this.client,this.statistics),this.encryptionManager=new MD(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(m,v,y)=>{this.emit(Qn.EncryptionKeyChanged,m,v,y)})}this.joinConfig=n,this.pendingNotificationToSend=(i=this.joinConfig)===null||i===void 0?void 0:i.notificationType,this.membershipManager.join(e,t,m=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",m),this.emit(Qn.MembershipManagerError,m),this.emit(Qn.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(n),this.emit(Qn.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var i=t.membershipManager.leave(n);return t.emit(Qn.JoinStateChanged,!1),yield i})()}getActiveFocus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if((e==null?void 0:e.getFocusSelection())==="oldest_membership")return e.getPreferredFoci()[0]}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,n)=>{t.forEach(i=>{this.emit(Qn.EncryptionKeyChanged,i.key,i.keyIndex,n)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var n=t.getMsUntilExpiry();n!==void 0&&(e===void 0||n<e)&&(e=n)}e!=null&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}sendCallNotify(e,t){this.client.sendEvent(this.roomSubset.roomId,j.CallNotify,{application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:t==="notification"?"notify":t,call_id:this.callId}).catch(n=>this.logger.error("Failed to send call notification",n)),this.client.sendEvent(this.roomSubset.roomId,j.RTCNotification,{"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:it.unstable_RTCNotificationParent},sender_ts:Date.now(),lifetime:3e4}).catch(n=>this.logger.error("Failed to send call notification",n))}}var oS=function(r){return r.SessionStarted="session_started",r.SessionEnded="session_ended",r}({});class xD extends nt{constructor(e,t){super(),this.client=t,c(this,"roomSessions",new Map),c(this,"logger",void 0),c(this,"onRoom",n=>{this.refreshRoom(n)}),c(this,"onRoomState",(n,i)=>{var a=this.client.getRoom(n.getRoomId());if(!a){this.logger.error("Got room state event for unknown room ".concat(n.getRoomId(),"!"));return}n.getType()==j.GroupCallMemberPrefix&&this.refreshRoom(a)}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,n=is.roomSessionForRoom(this.client,e);n.memberships.length>0&&this.roomSessions.set(e.roomId,n)}this.client.on(ce.Room,this.onRoom),this.client.on(Ae.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ce.Room,this.onRoom),this.client.off(Ae.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,is.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),n=this.getRoomSession(e),i=n.memberships.length>0&&!t;n.onRTCSessionMemberUpdate();var a=n.memberships.length>0;i&&!a?(this.logger.trace("Session ended for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(oS.SessionEnded,e.roomId,this.roomSessions.get(e.roomId))):!i&&a&&(this.logger.trace("Session started for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(oS.SessionStarted,e.roomId,this.roomSessions.get(e.roomId)))}}function yh(r){return e=>{var t,n;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==r||((n=e.content)===null||n===void 0||(n=n["m.relates_to"])===null||n===void 0?void 0:n.rel_type)===ze.name}}function J0(r){return Rv.apply(this,arguments)}function Rv(){return Rv=w(function*(r){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(r),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),Rv.apply(this,arguments)}class co extends Error{}co.prototype.name="InvalidTokenError";function ND(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function LD(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return ND(e)}catch{return atob(e)}}function Y0(r,e){if(typeof r!="string")throw new co("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=r.split(".")[t];if(typeof n!="string")throw new co(`Invalid token specified: missing part #${t+1}`);let i;try{i=LD(n)}catch(a){throw new co(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(i)}catch(a){throw new co(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var UD={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},un,dn,ol=(r=>(r[r.NONE=0]="NONE",r[r.ERROR=1]="ERROR",r[r.WARN=2]="WARN",r[r.INFO=3]="INFO",r[r.DEBUG=4]="DEBUG",r))(ol||{});(r=>{function e(){un=3,dn=UD}r.reset=e;function t(i){if(!(0<=i&&i<=4))throw new Error("Invalid log level");un=i}r.setLevel=t;function n(i){dn=i}r.setLogger=n})(ol||(ol={}));var St=class sn{constructor(e){this._name=e}debug(...e){un>=4&&dn.debug(sn._format(this._name,this._method),...e)}info(...e){un>=3&&dn.info(sn._format(this._name,this._method),...e)}warn(...e){un>=2&&dn.warn(sn._format(this._name,this._method),...e)}error(...e){un>=1&&dn.error(sn._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const n=new sn(`${e}.${t}`);return n.debug("begin"),n}static _format(e,t){const n=`[${e}]`;return t?`${n} ${t}:`:n}static debug(e,...t){un>=4&&dn.debug(sn._format(e),...t)}static info(e,...t){un>=3&&dn.info(sn._format(e),...t)}static warn(e,...t){un>=2&&dn.warn(sn._format(e),...t)}static error(e,...t){un>=1&&dn.error(sn._format(e),...t)}};ol.reset();var Od=class{static decode(r){try{return Y0(r)}catch(e){throw St.error("JwtUtils.decode",e),e}}static async generateSignedJwt(r,e,t){const n=Yr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(r))),i=Yr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=`${n}.${i}`,s=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(a)),o=Yr.encodeBase64Url(new Uint8Array(s));return`${a}.${o}`}},jD="10000000-1000-4000-8000-100000000000",Iv=r=>btoa([...new Uint8Array(r)].map(e=>String.fromCharCode(e)).join("")),Q0=class on{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return jD.replace(/[018]/g,t=>(+t^on._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return on.generateUUIDv4()+on.generateUUIDv4()+on.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const n=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",n);return Iv(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw St.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const i=new TextEncoder().encode([e,t].join(":"));return Iv(i)}static async hash(e,t){const n=new TextEncoder().encode(t),i=await crypto.subtle.digest(e,n);return new Uint8Array(i)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const n=await on.hash("SHA-256",JSON.stringify(t));return on.encodeBase64Url(n)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:n,keyPair:i,nonce:a}){let s,o;const l={jti:window.crypto.randomUUID(),htm:n??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(s=await on.hash("SHA-256",t),o=on.encodeBase64Url(s),l.ath=o),a&&(l.nonce=a);try{const u=await crypto.subtle.exportKey("jwk",i.publicKey),d={alg:"ES256",typ:"dpop+jwt",jwk:{crv:u.crv,kty:u.kty,x:u.x,y:u.y}};return await Od.generateSignedJwt(d,l,i.privateKey)}catch(u){throw u instanceof TypeError?new Error(`Error exporting dpop public key: ${u.message}`):u}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await on.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};Q0.encodeBase64Url=r=>Iv(r).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var Yr=Q0,FD=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new St(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},kd=class Du extends FD{constructor(){super(...arguments),this._logger=new St(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Du.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Du.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const n=Du.getEpochTime()+e;if(this.expiration===n&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=n;const i=Math.min(e,5);this._timerHandle=setInterval(this._callback,i*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},lS=class{static readParams(r,e="query"){if(!r)throw new TypeError("Invalid URL");const n=new URL(r,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(n.slice(1))}},_s=";",bs=class extends Error{constructor(r,e){var t,n,i;if(super(r.error_description||r.error||""),this.form=e,this.name="ErrorResponse",!r.error)throw St.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=r.error,this.error_description=(t=r.error_description)!=null?t:null,this.error_uri=(n=r.error_uri)!=null?n:null,this.state=r.userState,this.session_state=(i=r.session_state)!=null?i:null,this.url_state=r.url_state}},BD=class extends Error{constructor(r){super(r),this.name="ErrorTimeout"}},$D=class{constructor(){this._logger=new St("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(r){return this._logger.create(`getItem('${r}')`),this._data[r]}setItem(r,e){this._logger.create(`setItem('${r}')`),this._data[r]=e}removeItem(r){this._logger.create(`removeItem('${r}')`),delete this._data[r]}get length(){return Object.getOwnPropertyNames(this._data).length}key(r){return Object.getOwnPropertyNames(this._data)[r]}},Cv=class extends Error{constructor(r,e){super(e),this.name="ErrorDPoPNonce",this.nonce=r}},nm=class{constructor(r=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new St("JsonService"),this._contentTypes=[],this._contentTypes.push(...r,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(r,e={}){const{timeoutInSeconds:t,...n}=e;if(!t)return await fetch(r,n);const i=new AbortController,a=setTimeout(()=>i.abort(),t*1e3);try{return await fetch(r,{...e,signal:i.signal})}catch(s){throw s instanceof DOMException&&s.name==="AbortError"?new BD("Network timed out"):s}finally{clearTimeout(a)}}async getJson(r,{token:e,credentials:t,timeoutInSeconds:n}={}){const i=this._logger.create("getJson"),a={Accept:this._contentTypes.join(", ")};e&&(i.debug("token passed, setting Authorization header"),a.Authorization="Bearer "+e),this._appendExtraHeaders(a);let s;try{i.debug("url:",r),s=await this.fetchWithTimeout(r,{method:"GET",headers:a,timeoutInSeconds:n,credentials:t})}catch(u){throw i.error("Network Error"),u}i.debug("HTTP response received, status",s.status);const o=s.headers.get("Content-Type");if(o&&!this._contentTypes.find(u=>o.startsWith(u))&&i.throw(new Error(`Invalid response Content-Type: ${o??"undefined"}, from URL: ${r}`)),s.ok&&this._jwtHandler&&(o!=null&&o.startsWith("application/jwt")))return await this._jwtHandler(await s.text());let l;try{l=await s.json()}catch(u){throw i.error("Error parsing JSON response",u),s.ok?u:new Error(`${s.statusText} (${s.status})`)}if(!s.ok)throw i.error("Error from server:",l),l.error?new bs(l):new Error(`${s.statusText} (${s.status}): ${JSON.stringify(l)}`);return l}async postForm(r,{body:e,basicAuth:t,timeoutInSeconds:n,initCredentials:i,extraHeaders:a}){const s=this._logger.create("postForm"),o={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...a};t!==void 0&&(o.Authorization="Basic "+t),this._appendExtraHeaders(o);let l;try{s.debug("url:",r),l=await this.fetchWithTimeout(r,{method:"POST",headers:o,body:e,timeoutInSeconds:n,credentials:i})}catch(f){throw s.error("Network error"),f}s.debug("HTTP response received, status",l.status);const u=l.headers.get("Content-Type");if(u&&!this._contentTypes.find(f=>u.startsWith(f)))throw new Error(`Invalid response Content-Type: ${u??"undefined"}, from URL: ${r}`);const d=await l.text();let h={};if(d)try{h=JSON.parse(d)}catch(f){throw s.error("Error parsing JSON response",f),l.ok?f:new Error(`${l.statusText} (${l.status})`)}if(!l.ok){if(s.error("Error from server:",h),l.headers.has("dpop-nonce")){const f=l.headers.get("dpop-nonce");throw new Cv(f,`${JSON.stringify(h)}`)}throw h.error?new bs(h,e):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(h)}`)}return h}_appendExtraHeaders(r){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),n=["accept","content-type"],i=["authorization"];t.length!==0&&t.forEach(a=>{if(n.includes(a.toLocaleLowerCase())){e.warn("Protected header could not be set",a,n);return}if(i.includes(a.toLocaleLowerCase())&&Object.keys(r).includes(a)){e.warn("Header could not be overridden",a,i);return}const s=typeof this._extraHeaders[a]=="function"?this._extraHeaders[a]():this._extraHeaders[a];s&&s!==""&&(r[a]=s)})}},X0=class{constructor(r){this._settings=r,this._logger=new St("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new nm(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const r=this._logger.create("getMetadata");if(this._metadata)return r.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw r.throw(new Error("No authority or metadataUrl configured on settings")),null;r.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return r.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},e,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(r=!0){return this._getMetadataProperty("token_endpoint",r)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(r=!0){return this._getMetadataProperty("revocation_endpoint",r)}getKeysEndpoint(r=!0){return this._getMetadataProperty("jwks_uri",r)}async _getMetadataProperty(r,e=!1){const t=this._logger.create(`_getMetadataProperty('${r}')`),n=await this.getMetadata();if(t.debug("resolved"),n[r]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+r))}return n[r]}async getSigningKeys(){const r=this._logger.create("getSigningKeys");if(this._signingKeys)return r.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);r.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(r.debug("got key set",t),!Array.isArray(t.keys))throw r.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},vc=class{constructor({prefix:r="oidc.",store:e=localStorage}={}){this._logger=new St("WebStorageStateStore"),this._store=e,this._prefix=r}async set(r,e){this._logger.create(`set('${r}')`),r=this._prefix+r,await this._store.setItem(r,e)}async get(r){return this._logger.create(`get('${r}')`),r=this._prefix+r,await this._store.getItem(r)}async remove(r){this._logger.create(`remove('${r}')`),r=this._prefix+r;const e=await this._store.getItem(r);return await this._store.removeItem(r),e}async getAllKeys(){this._logger.create("getAllKeys");const r=await this._store.length,e=[];for(let t=0;t<r;t++){const n=await this._store.key(t);n&&n.indexOf(this._prefix)===0&&e.push(n.substr(this._prefix.length))}return e}},WD="code",KD="openid",VD="client_secret_post",GD=60*15,Ov=class{constructor({authority:r,metadataUrl:e,metadata:t,signingKeys:n,metadataSeed:i,client_id:a,client_secret:s,response_type:o=WD,scope:l=KD,redirect_uri:u,post_logout_redirect_uri:d,client_authentication:h=VD,prompt:f,display:m,max_age:v,ui_locales:y,acr_values:I,resource:g,response_mode:p,filterProtocolClaims:b=!0,loadUserInfo:R=!1,requestTimeoutInSeconds:P,staleStateAgeInSeconds:E=GD,mergeClaimsStrategy:C={array:"replace"},disablePKCE:S=!1,stateStore:x,revokeTokenAdditionalContentTypes:K,fetchRequestCredentials:z,refreshTokenAllowedScope:oe,extraQueryParams:ge={},extraTokenParams:xe={},extraHeaders:_e={},dpop:Me,omitScopeWhenRequesting:je=!1}){var re;if(this.authority=r,e?this.metadataUrl=e:(this.metadataUrl=r,r&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=i,this.signingKeys=n,this.client_id=a,this.client_secret=s,this.response_type=o,this.scope=l,this.redirect_uri=u,this.post_logout_redirect_uri=d,this.client_authentication=h,this.prompt=f,this.display=m,this.max_age=v,this.ui_locales=y,this.acr_values=I,this.resource=g,this.response_mode=p,this.filterProtocolClaims=b??!0,this.loadUserInfo=!!R,this.staleStateAgeInSeconds=E,this.mergeClaimsStrategy=C,this.omitScopeWhenRequesting=je,this.disablePKCE=!!S,this.revokeTokenAdditionalContentTypes=K,this.fetchRequestCredentials=z||"same-origin",this.requestTimeoutInSeconds=P,x)this.stateStore=x;else{const he=typeof window<"u"?window.localStorage:new $D;this.stateStore=new vc({store:he})}if(this.refreshTokenAllowedScope=oe,this.extraQueryParams=ge,this.extraTokenParams=xe,this.extraHeaders=_e,this.dpop=Me,this.dpop&&!((re=this.dpop)!=null&&re.store))throw new Error("A DPoPStore is required when dpop is enabled")}},qD=class{constructor(r,e){this._settings=r,this._metadataService=e,this._logger=new St("UserInfoService"),this._getClaimsFromJwt=async t=>{const n=this._logger.create("_getClaimsFromJwt");try{const i=Od.decode(t);return n.debug("JWT decoding successful"),i}catch(i){throw n.error("Error parsing JWT response"),i}},this._jsonService=new nm(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(r){const e=this._logger.create("getClaims");r||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const n=await this._jsonService.getJson(t,{token:r,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",n),n}},Z0=class{constructor(r,e){this._settings=r,this._metadataService=e,this._logger=new St("TokenClient"),this._jsonService=new nm(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:r="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:i,...a}){const s=this._logger.create("exchangeCode");t||s.throw(new Error("A client_id is required")),e||s.throw(new Error("A redirect_uri is required")),a.code||s.throw(new Error("A code is required"));const o=new URLSearchParams({grant_type:r,redirect_uri:e});for(const[h,f]of Object.entries(a))f!=null&&o.set(h,f);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(n==null)throw s.throw(new Error("A client_secret is required")),null;l=Yr.generateBasicAuth(t,n);break;case"client_secret_post":o.append("client_id",t),n&&o.append("client_secret",n);break}const u=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(u,{body:o,basicAuth:l,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async exchangeCredentials({grant_type:r="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:n=this._settings.scope,...i}){const a=this._logger.create("exchangeCredentials");e||a.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:r});this._settings.omitScopeWhenRequesting||s.set("scope",n);for(const[d,h]of Object.entries(i))h!=null&&s.set(d,h);let o;switch(this._settings.client_authentication){case"client_secret_basic":if(t==null)throw a.throw(new Error("A client_secret is required")),null;o=Yr.generateBasicAuth(e,t);break;case"client_secret_post":s.append("client_id",e),t&&s.append("client_secret",t);break}const l=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");const u=await this._jsonService.postForm(l,{body:s,basicAuth:o,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),u}async exchangeRefreshToken({grant_type:r="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:i,...a}){const s=this._logger.create("exchangeRefreshToken");e||s.throw(new Error("A client_id is required")),a.refresh_token||s.throw(new Error("A refresh_token is required"));const o=new URLSearchParams({grant_type:r});for(const[h,f]of Object.entries(a))Array.isArray(f)?f.forEach(m=>o.append(h,m)):f!=null&&o.set(h,f);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(t==null)throw s.throw(new Error("A client_secret is required")),null;l=Yr.generateBasicAuth(e,t);break;case"client_secret_post":o.append("client_id",e),t&&o.append("client_secret",t);break}const u=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(u,{body:o,basicAuth:l,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async revoke(r){var e;const t=this._logger.create("revoke");r.token||t.throw(new Error("A token is required"));const n=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=r.token_type_hint)!=null?e:"default token type"}`);const i=new URLSearchParams;for(const[a,s]of Object.entries(r))s!=null&&i.set(a,s);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},HD=class{constructor(r,e,t){this._settings=r,this._metadataService=e,this._claimsService=t,this._logger=new St("ResponseValidator"),this._userInfoService=new qD(this._settings,this._metadataService),this._tokenClient=new Z0(this._settings,this._metadataService)}async validateSigninResponse(r,e,t){const n=this._logger.create("validateSigninResponse");this._processSigninState(r,e),n.debug("state processed"),await this._processCode(r,e,t),n.debug("code processed"),r.isOpenId&&this._validateIdTokenAttributes(r),n.debug("tokens validated"),await this._processClaims(r,e==null?void 0:e.skipUserInfo,r.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(r,e){const t=this._logger.create("validateCredentialsResponse"),n=r.isOpenId&&!!r.id_token;n&&this._validateIdTokenAttributes(r),t.debug("tokens validated"),await this._processClaims(r,e,n),t.debug("claims processed")}async validateRefreshResponse(r,e){var t,n;const i=this._logger.create("validateRefreshResponse");r.userState=e.data,(t=r.session_state)!=null||(r.session_state=e.session_state),(n=r.scope)!=null||(r.scope=e.scope),r.isOpenId&&r.id_token&&(this._validateIdTokenAttributes(r,e.id_token),i.debug("ID Token validated")),r.id_token||(r.id_token=e.id_token,r.profile=e.profile);const a=r.isOpenId&&!!r.id_token;await this._processClaims(r,!1,a),i.debug("claims processed")}validateSignoutResponse(r,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==r.state&&t.throw(new Error("State does not match")),t.debug("state validated"),r.userState=e.data,r.error)throw t.warn("Response was error",r.error),new bs(r)}_processSigninState(r,e){var t;const n=this._logger.create("_processSigninState");if(e.id!==r.state&&n.throw(new Error("State does not match")),e.client_id||n.throw(new Error("No client_id on state")),e.authority||n.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&n.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&n.throw(new Error("client_id mismatch on settings vs. signin state")),n.debug("state validated"),r.userState=e.data,r.url_state=e.url_state,(t=r.scope)!=null||(r.scope=e.scope),r.error)throw n.warn("Response was error",r.error),new bs(r);e.code_verifier&&!r.code&&n.throw(new Error("Expected code in response"))}async _processClaims(r,e=!1,t=!0){const n=this._logger.create("_processClaims");if(r.profile=this._claimsService.filterProtocolClaims(r.profile),e||!this._settings.loadUserInfo||!r.access_token){n.debug("not loading user info");return}n.debug("loading user info");const i=await this._userInfoService.getClaims(r.access_token);n.debug("user info claims received from user info endpoint"),t&&i.sub!==r.profile.sub&&n.throw(new Error("subject from UserInfo response does not match subject in ID Token")),r.profile=this._claimsService.mergeClaims(r.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",r.profile)}async _processCode(r,e,t){const n=this._logger.create("_processCode");if(r.code){n.debug("Validating code");const i=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:r.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(r,i)}else n.debug("No code to process")}_validateIdTokenAttributes(r,e){var t;const n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");const i=Od.decode((t=r.id_token)!=null?t:"");if(i.sub||n.throw(new Error("ID Token is missing a subject claim")),e){const a=Od.decode(e);i.sub!==a.sub&&n.throw(new Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==a.auth_time&&n.throw(new Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==a.azp&&n.throw(new Error("azp in id_token does not match original azp")),!i.azp&&a.azp&&n.throw(new Error("azp not in id_token, but present in original id_token"))}r.profile=i}},Pd=class kv{constructor(e){this.id=e.id||Yr.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=kd.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new St("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return St.createStatic("State","fromStorageString"),Promise.resolve(new kv(JSON.parse(e)))}static async clearStaleState(e,t){const n=St.createStatic("State","clearStaleState"),i=kd.getEpochTime()-t,a=await e.getAllKeys();n.debug("got keys",a);for(let s=0;s<a.length;s++){const o=a[s],l=await e.get(o);let u=!1;if(l)try{const d=await kv.fromStorageString(l);n.debug("got item from key:",o,d.created),d.created<=i&&(u=!0)}catch(d){n.error("Error parsing state for key:",o,d),u=!0}else n.debug("no item in storage for key:",o),u=!0;u&&(n.debug("removed item for key:",o),e.remove(o))}}},im=class Pv extends Pd{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?Yr.generateCodeVerifier():e.code_verifier||void 0,n=t?await Yr.generateCodeChallenge(t):void 0;return new Pv({...e,code_verifier:t,code_challenge:n})}toStorageString(){return new St("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){St.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return Pv.create(t)}},ew=class tw{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:n,redirect_uri:i,response_type:a,scope:s,state_data:o,response_mode:l,request_type:u,client_secret:d,nonce:h,url_state:f,resource:m,skipUserInfo:v,extraQueryParams:y,extraTokenParams:I,disablePKCE:g,dpopJkt:p,omitScopeWhenRequesting:b,...R}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const P=await im.create({data:o,request_type:u,url_state:f,code_verifier:!g,client_id:n,authority:t,redirect_uri:i,response_mode:l,client_secret:d,scope:s,extraTokenParams:I,skipUserInfo:v}),E=new URL(e);E.searchParams.append("client_id",n),E.searchParams.append("redirect_uri",i),E.searchParams.append("response_type",a),b||E.searchParams.append("scope",s),h&&E.searchParams.append("nonce",h),p&&E.searchParams.append("dpop_jkt",p);let C=P.id;f&&(C=`${C}${_s}${f}`),E.searchParams.append("state",C),P.code_challenge&&(E.searchParams.append("code_challenge",P.code_challenge),E.searchParams.append("code_challenge_method","S256")),m&&(Array.isArray(m)?m:[m]).forEach(x=>E.searchParams.append("resource",x));for(const[S,x]of Object.entries({response_mode:l,...R,...y}))x!=null&&E.searchParams.append(S,x.toString());return new tw({url:E.href,state:P})}};ew._logger=new St("SigninRequest");var zD=ew,JD="openid",xu=class{constructor(r){if(this.access_token="",this.token_type="",this.profile={},this.state=r.get("state"),this.session_state=r.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(_s);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(_s))}this.error=r.get("error"),this.error_description=r.get("error_description"),this.error_uri=r.get("error_uri"),this.code=r.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-kd.getEpochTime()}set expires_in(r){typeof r=="string"&&(r=Number(r)),r!==void 0&&r>=0&&(this.expires_at=Math.floor(r)+kd.getEpochTime())}get isOpenId(){var r;return((r=this.scope)==null?void 0:r.split(" ").includes(JD))||!!this.id_token}},YD=class{constructor({url:r,state_data:e,id_token_hint:t,post_logout_redirect_uri:n,extraQueryParams:i,request_type:a,client_id:s,url_state:o}){if(this._logger=new St("SignoutRequest"),!r)throw this._logger.error("ctor: No url passed"),new Error("url");const l=new URL(r);if(t&&l.searchParams.append("id_token_hint",t),s&&l.searchParams.append("client_id",s),n&&(l.searchParams.append("post_logout_redirect_uri",n),e||o)){this.state=new Pd({data:e,request_type:a,url_state:o});let u=this.state.id;o&&(u=`${u}${_s}${o}`),l.searchParams.append("state",u)}for(const[u,d]of Object.entries({...i}))d!=null&&l.searchParams.append(u,d.toString());this.url=l.href}},QD=class{constructor(r){if(this.state=r.get("state"),this.state){const e=decodeURIComponent(this.state).split(_s);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(_s))}this.error=r.get("error"),this.error_description=r.get("error_description"),this.error_uri=r.get("error_uri")}},XD=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],ZD=["sub","iss","aud","exp","iat"],ex=class{constructor(r){this._settings=r,this._logger=new St("ClaimsService")}filterProtocolClaims(r){const e={...r};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=XD;for(const n of t)ZD.includes(n)||delete e[n]}return e}mergeClaims(r,e){const t={...r};for(const[n,i]of Object.entries(e))if(t[n]!==i)if(Array.isArray(t[n])||Array.isArray(i))if(this._settings.mergeClaimsStrategy.array=="replace")t[n]=i;else{const a=Array.isArray(t[n])?t[n]:[t[n]];for(const s of Array.isArray(i)?i:[i])a.includes(s)||a.push(s);t[n]=a}else typeof t[n]=="object"&&typeof i=="object"?t[n]=this.mergeClaims(t[n],i):t[n]=i;return t}},tx=class{constructor(r,e){this.keys=r,this.nonce=e}},am=class{constructor(r,e){this._logger=new St("OidcClient"),this.settings=r instanceof Ov?r:new Ov(r),this.metadataService=e??new X0(this.settings),this._claimsService=new ex(this.settings),this._validator=new HD(this.settings,this.metadataService,this._claimsService),this._tokenClient=new Z0(this.settings,this.metadataService)}async createSigninRequest({state:r,request:e,request_uri:t,request_type:n,id_token_hint:i,login_hint:a,skipUserInfo:s,nonce:o,url_state:l,response_type:u=this.settings.response_type,scope:d=this.settings.scope,redirect_uri:h=this.settings.redirect_uri,prompt:f=this.settings.prompt,display:m=this.settings.display,max_age:v=this.settings.max_age,ui_locales:y=this.settings.ui_locales,acr_values:I=this.settings.acr_values,resource:g=this.settings.resource,response_mode:p=this.settings.response_mode,extraQueryParams:b=this.settings.extraQueryParams,extraTokenParams:R=this.settings.extraTokenParams,dpopJkt:P,omitScopeWhenRequesting:E=this.settings.omitScopeWhenRequesting}){const C=this._logger.create("createSigninRequest");if(u!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const S=await this.metadataService.getAuthorizationEndpoint();C.debug("Received authorization endpoint",S);const x=await zD.create({url:S,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:h,response_type:u,scope:d,state_data:r,url_state:l,prompt:f,display:m,max_age:v,ui_locales:y,id_token_hint:i,login_hint:a,acr_values:I,dpopJkt:P,resource:g,request:e,request_uri:t,extraQueryParams:b,extraTokenParams:R,request_type:n,response_mode:p,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:o,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:E});await this.clearStaleState();const K=x.state;return await this.settings.stateStore.set(K.id,K.toStorageString()),x}async readSigninResponseState(r,e=!1){const t=this._logger.create("readSigninResponseState"),n=new xu(lS.readParams(r,this.settings.response_mode));if(!n.state)throw t.throw(new Error("No state in response")),null;const i=await this.settings.stateStore[e?"remove":"get"](n.state);if(!i)throw t.throw(new Error("No matching state found in storage")),null;return{state:await im.fromStorageString(i),response:n}}async processSigninResponse(r,e,t=!0){const n=this._logger.create("processSigninResponse"),{state:i,response:a}=await this.readSigninResponseState(r,t);if(n.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const s=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:s}}try{await this._validator.validateSigninResponse(a,i,e)}catch(s){if(s instanceof Cv&&this.settings.dpop){const o=await this.getDpopProof(this.settings.dpop.store,s.nonce);e.DPoP=o,await this._validator.validateSigninResponse(a,i,e)}else throw s}return a}async getDpopProof(r,e){let t,n;return(await r.getAllKeys()).includes(this.settings.client_id)?(n=await r.get(this.settings.client_id),n.nonce!==e&&e&&(n.nonce=e,await r.set(this.settings.client_id,n))):(t=await Yr.generateDPoPKeys(),n=new tx(t,e),await r.set(this.settings.client_id,n)),await Yr.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:n.keys,nonce:n.nonce})}async processResourceOwnerPasswordCredentials({username:r,password:e,skipUserInfo:t=!1,extraTokenParams:n={}}){const i=await this._tokenClient.exchangeCredentials({username:r,password:e,...n}),a=new xu(new URLSearchParams);return Object.assign(a,i),await this._validator.validateCredentialsResponse(a,t),a}async useRefreshToken({state:r,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,extraTokenParams:a}){var s;const o=this._logger.create("useRefreshToken");let l;if(this.settings.refreshTokenAllowedScope===void 0)l=r.scope;else{const h=this.settings.refreshTokenAllowedScope.split(" ");l=(((s=r.scope)==null?void 0:s.split(" "))||[]).filter(m=>h.includes(m)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const h=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:h}}let u;try{u=await this._tokenClient.exchangeRefreshToken({refresh_token:r.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,...a})}catch(h){if(h instanceof Cv&&this.settings.dpop)i.DPoP=await this.getDpopProof(this.settings.dpop.store,h.nonce),u=await this._tokenClient.exchangeRefreshToken({refresh_token:r.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:n,extraHeaders:i,...a});else throw h}const d=new xu(new URLSearchParams);return Object.assign(d,u),o.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...r,scope:l}),d}async createSignoutRequest({state:r,id_token_hint:e,client_id:t,request_type:n,url_state:i,post_logout_redirect_uri:a=this.settings.post_logout_redirect_uri,extraQueryParams:s=this.settings.extraQueryParams}={}){const o=this._logger.create("createSignoutRequest"),l=await this.metadataService.getEndSessionEndpoint();if(!l)throw o.throw(new Error("No end session endpoint")),null;o.debug("Received end session endpoint",l),!t&&a&&!e&&(t=this.settings.client_id);const u=new YD({url:l,id_token_hint:e,client_id:t,post_logout_redirect_uri:a,state_data:r,extraQueryParams:s,request_type:n,url_state:i});await this.clearStaleState();const d=u.state;return d&&(o.debug("Signout request has state to persist"),await this.settings.stateStore.set(d.id,d.toStorageString())),u}async readSignoutResponseState(r,e=!1){const t=this._logger.create("readSignoutResponseState"),n=new QD(lS.readParams(r,this.settings.response_mode));if(!n.state){if(t.debug("No state in response"),n.error)throw t.warn("Response was error:",n.error),new bs(n);return{state:void 0,response:n}}const i=await this.settings.stateStore[e?"remove":"get"](n.state);if(!i)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Pd.fromStorageString(i),response:n}}async processSignoutResponse(r){const e=this._logger.create("processSignoutResponse"),{state:t,response:n}=await this.readSignoutResponseState(r,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,t)):e.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),Pd.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(r,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:r,token_type_hint:e})}},Ht=function(r){return r.NotSupported="OIDC authentication not supported",r.Misconfigured="OIDC is misconfigured",r.General="Something went wrong with OIDC discovery",r.OpSupport="Configured OIDC OP does not support required functions",r.DynamicRegistrationNotSupported="Dynamic registration not supported",r.DynamicRegistrationFailed="Dynamic registration failed",r.DynamicRegistrationInvalid="Dynamic registration invalid response",r.CodeExchangeFailed="Failed to exchange code for token",r.InvalidBearerTokenResponse="Invalid bearer token response",r.InvalidIdToken="Invalid ID token",r.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",r}({}),sm=r=>!!r&&typeof r=="object"&&!Array.isArray(r),Dn=(r,e)=>!r[e]||!Mo(r,e)?(T.error("Missing or invalid property: ".concat(e)),!1):!0,Mo=(r,e)=>r[e]&&typeof r[e]!="string"?(T.error("Invalid property: ".concat(e)),!1):!0,uS=(r,e)=>r[e]&&(!Array.isArray(r[e])||!r[e].every(t=>typeof t=="string"))?(T.error("Invalid property: ".concat(e)),!1):!0,Sh=(r,e,t)=>{var n=r[e];return!n||!Array.isArray(n)||!n.includes(t)?(T.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},rw=r=>{if(!sm(r))throw T.error("Issuer configuration not found or malformed"),new Error(Ht.OpSupport);var e=[Dn(r,"issuer"),Dn(r,"authorization_endpoint"),Dn(r,"token_endpoint"),Dn(r,"revocation_endpoint"),Mo(r,"registration_endpoint"),Mo(r,"account_management_uri"),Mo(r,"device_authorization_endpoint"),uS(r,"account_management_actions_supported"),Sh(r,"response_types_supported","code"),Sh(r,"grant_types_supported","authorization_code"),Sh(r,"code_challenge_methods_supported","S256"),uS(r,"prompt_values_supported")].some(t=>!t);if(!e)return r;throw T.error("Issuer configuration not valid"),new Error(Ht.OpSupport)},nw=r=>{try{return Y0(r)}catch(e){throw T.error("Could not decode id_token",e),e}},iw=(r,e,t,n)=>{try{if(!r)throw new Error("No ID token");var i=nw(r);if(i.iss!==e)throw new Error("Invalid issuer");var a=typeof i.aud=="string"?[i.aud]:i.aud;if(!a.includes(t))throw new Error("Invalid audience");if(n!==void 0&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>i.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw T.error("Invalid ID token",s),new Error(Ht.InvalidIdToken)}};function aw(r){if(!sm(r))throw T.error("Stored user state not found"),new Error(Ht.MissingOrInvalidStoredState);var e=[Dn(r,"homeserverUrl"),Dn(r,"nonce"),Mo(r,"identityServerUrl")].some(t=>!t);if(e)throw new Error(Ht.MissingOrInvalidStoredState)}var rx=r=>sm(r)&&Dn(r,"token_type")&&r.token_type.toLowerCase()==="bearer"&&Dn(r,"access_token")&&Dn(r,"refresh_token")&&(!("expires_in"in r)||typeof r.expires_in=="number");function sw(r){if(!rx(r))throw new Error(Ht.InvalidBearerTokenResponse)}function dS(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Md(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?dS(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):dS(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var pc=r=>{var e=r??bi(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},nx=function(){var r=w(function*(e){if(!globalThis.crypto.subtle)return T.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield J0(e);return dc(t)});return function(t){return r.apply(this,arguments)}}(),ix=r=>{var{redirectUri:e}=r;return{scope:pc(),redirectUri:e,state:bi(8),nonce:bi(8),codeVerifier:bi(64)}},ax=function(){var r=w(function*(e,t,n){var{scope:i,redirectUri:a,state:s,nonce:o,codeVerifier:l}=n,u=new URL(e);return u.searchParams.append("response_mode","query"),u.searchParams.append("response_type","code"),u.searchParams.append("redirect_uri",a),u.searchParams.append("client_id",t),u.searchParams.append("state",s),u.searchParams.append("scope",i),u.searchParams.append("nonce",o),u.searchParams.append("code_challenge_method","S256"),u.searchParams.append("code_challenge",yield nx(l)),u.toString()});return function(t,n,i){return r.apply(this,arguments)}}(),sx=function(){var r=w(function*(e){var{metadata:t,redirectUri:n,clientId:i,homeserverUrl:a,identityServerUrl:s,nonce:o,prompt:l,urlState:u}=e,d=pc(),h=new am(Md(Md({},t),{},{client_id:i,redirect_uri:n,authority:t.issuer,response_mode:"query",response_type:"code",scope:d,stateStore:new vc({prefix:"mx_oidc_",store:window.sessionStorage})})),f={homeserverUrl:a,nonce:o,identityServerUrl:s},m=yield h.createSigninRequest({state:f,nonce:o,prompt:l,url_state:u});return m.url});return function(t){return r.apply(this,arguments)}}(),ox=r=>({id_token:r.id_token,scope:r.scope,expires_at:r.expires_at,refresh_token:r.refresh_token,access_token:r.access_token,token_type:"Bearer"}),lx=function(){var r=w(function*(e,t){var n=new URL(window.location.origin);n.searchParams.append("code",e),n.searchParams.append("state",t),ol.setLogger(T);try{var i=new xu(n.searchParams),a=new vc({prefix:"mx_oidc_",store:window.sessionStorage}),s=yield a.get(i.state);if(!s)throw new Error(Ht.MissingOrInvalidStoredState);var o=yield im.fromStorageString(s),l=new am(Md(Md({},o),{},{stateStore:a})),u=yield l.processSigninResponse(n.href),d=u.userState;aw(d),sw(u),iw(u.id_token,l.settings.authority,l.settings.client_id,d.nonce);var h=ox(u);return{oidcClientSettings:{clientId:l.settings.client_id,issuer:l.settings.authority},tokenResponse:h,homeserverUrl:d.homeserverUrl,identityServerUrl:d.identityServerUrl,idTokenClaims:u.profile}}catch(m){T.error("Oidc login failed",m);var f=m.message;throw Object.values(Ht).includes(f)?m:new Error(Ht.CodeExchangeFailed)}});return function(t,n){return r.apply(this,arguments)}}();function cS(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function hS(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?cS(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):cS(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var om=function(){var r=w(function*(e){var t=new URL(".well-known/openid-configuration",e),n=yield fetch(t,{method:V.Get,signal:lc(5e3)}),i=yield n.json();return lm(i)});return function(t){return r.apply(this,arguments)}}(),lm=function(){var r=w(function*(e){var t=rw(e),n=new Ov({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),i=new X0(n);return hS(hS({},t),{},{signingKeys:yield i.getSigningKeys()})});return function(t){return r.apply(this,arguments)}}(),ux="urn:ietf:params:oauth:grant-type:device_code",Eh=(r,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==r.protocol||t.hostname!==r.hostname&&!t.hostname.endsWith(".".concat(r.hostname)))},dx=function(){var r=w(function*(e,t){if(!e.registration_endpoint)throw new Error(Ht.DynamicRegistrationNotSupported);var n=["authorization_code","refresh_token"];if(n.some(d=>!e.grant_types_supported.includes(d)))throw new Error(Ht.DynamicRegistrationNotSupported);var i=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:n,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:Eh(i,t.logoUri)?t.logoUri:void 0,policy_uri:Eh(i,t.policyUri)?t.policyUri:void 0,tos_uri:Eh(i,t.tosUri)?t.tosUri:void 0},s={Accept:"application/json","Content-Type":"application/json"};try{var o=yield fetch(e.registration_endpoint,{method:V.Post,headers:s,body:JSON.stringify(a)});if(o.status>=400)throw new Error(Ht.DynamicRegistrationFailed);var l=yield o.json(),u=l.client_id;if(!u||typeof u!="string")throw new Error(Ht.DynamicRegistrationInvalid);return u}catch(d){throw Object.values(Ht).includes(d.message)?d:(T.error("Dynamic registration request failed",d),new Error(Ht.DynamicRegistrationFailed))}});return function(t,n){return r.apply(this,arguments)}}();class cx{constructor(e,t,n,i,a){this.idTokenClaims=a,c(this,"oidcClientReady",void 0),c(this,"oidcClient",void 0),c(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,i,n)}initialiseOidcClient(e,t,n,i){var a=this;return w(function*(){try{var s,o=yield om(e),l=pc(n);a.oidcClient=new am({metadata:o,signingKeys:(s=o.signingKeys)!==null&&s!==void 0?s:void 0,client_id:t,scope:l,redirect_uri:i,authority:o.issuer,stateStore:new vc({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(u){throw T.error("Failed to initialise OIDC client.",u),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return w(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var n=yield t.inflightRefreshRequest;return n}catch(i){throw i instanceof bs?new Vp(i):i}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return w(function*(){})()}getNewTokens(e){var t=this;return w(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var n={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},i=Date.now(),a=yield t.oidcClient.useRefreshToken({state:n,timeoutInSeconds:300}),s={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(i+a.expires_in*1e3):void 0};return yield t.persistTokens(s),s})()}}var hx=["server","limit","since"];function fS(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function Rt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fS(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):fS(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var fx=3e3,vS=10*60*1e3,vx=new Et("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),ws=function(r){return r.Chronological="chronological",r.Detached="detached",r}({}),px=new yl("m.get_login_token","org.matrix.msc3882.get_login_token"),ow="uk.half-shot.msc2666",lw="uk.half-shot.msc2666.mutual_rooms",uw="uk.half-shot.msc2666.query_mutual_rooms",cn="org.matrix.msc4140",dw="uk.tcpip.msc4133",tn="$",ce=function(r){return r.Sync="sync",r.Event="event",r.ToDeviceEvent="toDeviceEvent",r.ReceivedToDeviceMessage="receivedToDeviceMessage",r.AccountData="accountData",r.Room="Room",r.DeleteRoom="deleteRoom",r.SyncUnexpectedError="sync.unexpectedError",r.ClientWellKnown="WellKnown.client",r.ReceivedVoipEvent="received_voip_event",r.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",r.TurnServers="turnServers",r.TurnServersError="turnServers.error",r}({}),mx=new Et("action","org.matrix.msc3824.action");class mc extends nt{constructor(e){var t,n,i,a;super(),i=this,c(this,"logger",void 0),c(this,"reEmitter",new xs(this)),c(this,"olmVersion",null),c(this,"usingExternalCrypto",!1),c(this,"_store",void 0),c(this,"deviceId",void 0),c(this,"credentials",void 0),c(this,"legacyPickleKey",void 0),c(this,"scheduler",void 0),c(this,"clientRunning",!1),c(this,"timelineSupport",!1),c(this,"urlPreviewCache",{}),c(this,"identityServer",void 0),c(this,"http",void 0),c(this,"cryptoBackend",void 0),c(this,"cryptoCallbacks",void 0),c(this,"callEventHandler",void 0),c(this,"groupCallEventHandler",void 0),c(this,"supportsCallTransfer",!1),c(this,"forceTURN",!1),c(this,"iceCandidatePoolSize",0),c(this,"idBaseUrl",void 0),c(this,"baseUrl",void 0),c(this,"isVoipWithNoMediaAllowed",void 0),c(this,"useLivekitForGroupCalls",void 0),c(this,"canSupportVoip",!1),c(this,"peekSync",null),c(this,"isGuestAccount",!1),c(this,"ongoingScrollbacks",{}),c(this,"notifTimelineSet",null),c(this,"legacyCryptoStore",void 0),c(this,"verificationMethods",void 0),c(this,"fallbackICEServerAllowed",!1),c(this,"syncApi",void 0),c(this,"roomNameGenerator",void 0),c(this,"pushRules",void 0),c(this,"syncLeftRoomsPromise",void 0),c(this,"syncedLeftRooms",!1),c(this,"clientOpts",void 0),c(this,"clientWellKnownIntervalID",void 0),c(this,"canResetTimelineCallback",void 0),c(this,"canSupport",new Map),c(this,"pushProcessor",new Gr(this)),c(this,"serverVersionsPromise",void 0),c(this,"clientWellKnown",void 0),c(this,"clientWellKnownPromise",void 0),c(this,"turnServers",[]),c(this,"turnServersExpiry",0),c(this,"checkTurnServersIntervalID",void 0),c(this,"txnCtr",0),c(this,"mediaHandler",new lD(this)),c(this,"sessionId",void 0),c(this,"eventsBeingEncrypted",new Set),c(this,"useE2eForGroupCall",!0),c(this,"toDeviceMessageQueue",void 0),c(this,"livekitServiceURL",void 0),c(this,"_secretStorage",void 0),c(this,"ignoredInvites",void 0),c(this,"matrixRTC",void 0),c(this,"serverCapabilitiesService",void 0),c(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(mv()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ce.Sync,this.startCallEventHandler))}),c(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ce.Sync,this.startMatrixRTC))}),c(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var o,l=((o=this.getRooms())!==null&&o!==void 0?o:[]).filter(h=>h.getUnreadNotificationCount(We.Total)>0);for(var u of l){var d=this.getSafeUserId();u.fixupNotifications(d)}this.off(ce.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:T,e.baseUrl=eh(e.baseUrl),e.idBaseUrl=eh(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(n=e.usingExternalCrypto)!==null&&n!==void 0?n:!1,this.store=e.store||new aA,this.deviceId=e.deviceId||null,this.sessionId=bi(10);var s=e.userId||null;this.credentials={userId:s},this.http=new b0(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:It.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var o=w(function*(l){var u=i.getRoom(l.getRoomId());l.status!==Se.SENDING&&i.updatePendingEventStatus(u,l,Se.SENDING);var d=yield i.sendEventHttpRequest(l);return u&&u.updatePendingEvent(l,Se.SENT,d.event_id),d});return function(l){return o.apply(this,arguments)}}()),mv()&&(this.callEventHandler=new kA(this),this.groupCallEventHandler=new PA(this),this.canSupportVoip=!0,this.on(ce.Sync,this.startCallEventHandler)),this.matrixRTC=new xD(this.logger,this),this.serverCapabilitiesService=new T0(this.logger,this.http),this.on(ce.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new mD(this,this.logger),this.on(Ve.Decrypted,o=>{cw(this,o)}),this.ignoredInvites=new gD(this),this._secretStorage=new G0(this,(a=e.cryptoCallbacks)!==null&&a!==void 0?a:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Ln.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return w(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ce.Sync,t.startMatrixRTC);var n=t.getUserId();n&&t.store.storeUser(new Ln(n)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},vS),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:i,list:a,fwdPagination:s}=yield t.doesServerSupportThread();Xe.setServerSideSupport(i),Xe.setServerSideListSupport(a),Xe.setServerSideFwdPaginationSupport(s)}catch(o){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",o)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new $0(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new di(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(o=>t.logger.info("Sync startup aborted with an error:",o)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,logger:this.logger.getChild("sync")}}stopClient(){var e,t,n,i,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(ce.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(n=this.peekSync)===null||n===void 0||n.stopPeeking(),(i=this.callEventHandler)===null||i===void 0||i.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var i=function(){var a=w(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var o=function*(f){var m=new Promise((v,y)=>{e.logger.info("Removing IndexedDB instance ".concat(f));var I=s.deleteDatabase(f);I.onsuccess=g=>{e.logger.info("Removed IndexedDB instance ".concat(f)),v(0)},I.onerror=g=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(f,":"),g),v(0)},I.onblocked=g=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(f))}});yield m};for(var l of["".concat((u=t.cryptoDatabasePrefix)!==null&&u!==void 0?u:ph,"::matrix-sdk-crypto"),"".concat((d=t.cryptoDatabasePrefix)!==null&&d!==void 0?d:ph,"::matrix-sdk-crypto-meta")]){var u,d;yield*o(l)}});return function(){return a.apply(this,arguments)}}();return n.push(i()),Promise.all(n).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return al(this,e)}createGroupCall(e,t,n,i,a,s){var o=this;return w(function*(){if(o.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var l=o.getRoom(e);if(!l)throw new Error("Cannot find room ".concat(e));return new zp(o,l,t,n,i,void 0,a||o.isVoipWithNoMediaAllowed,s,o.isVoipWithNoMediaAllowed,o.useLivekitForGroupCalls,o.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===qe.Prepared||e===qe.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return w(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return w(function*(){var n,i,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var o=t.getDeviceId();if(o===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var l=yield aM(()=>import("./index-BSuHAPLu.js"),[]),u=yield l.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:o,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(n=a.cryptoDatabasePrefix)!==null&&n!==void 0?n:ph,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(i=t.legacyPickleKey)!==null&&i!==void 0?i:"DEFAULT_KEY",legacyMigrationProgressListener:(d,h)=>{t.emit(Mt.LegacyCryptoStoreMigrationProgress,d,h)}});u.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=u,t.on(ur.Membership,u.onRoomMembership.bind(u)),t.on(ce.Event,d=>{u.onLiveEventFromSync(d)}),t.reEmitter.reEmit(u,[Mt.VerificationRequestReceived,Mt.UserTrustStatusChanged,Mt.KeyBackupStatus,Mt.KeyBackupSessionsRemaining,Mt.KeyBackupFailed,Mt.KeyBackupDecryptionKeyCached,Mt.KeysChanged,Mt.DevicesUpdated,Mt.WillUpdateDevices,Mt.DehydratedDeviceCreated,Mt.DehydratedDeviceUploaded,Mt.RehydrationStarted,Mt.RehydrationProgress,Mt.RehydrationCompleted,Mt.RehydrationError,Mt.DehydrationKeyCached,Mt.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,n){var i;t!==void 0?i=ie("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?i=ie("/room_keys/keys/$roomId",{$roomId:e}):i="/room_keys/keys";var a=n===void 0?void 0:{version:n};return{path:i,queryData:a}}deleteKeysFromBackup(e,t,n){var i=this;return w(function*(){var a=i.makeKeyBackupPath(e,t,n);yield i.http.authedRequest(V.Delete,a.path,a.queryData,void 0,{prefix:It.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(V.Get,t,void 0,void 0,{prefix:e?It.V1:ts.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),n=new Set;for(var i of t){var a,s=(a=i.findPredecessor(e))===null||a===void 0?void 0:a.roomId;s&&n.add(s)}return t.filter(o=>{var l=o.currentState.getStateEvents(j.RoomTombstone,"");return!(l&&n.has(o.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return w(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield lv(5,()=>n.setAccountDataRaw(e,t));var i=n.store.getAccountData(e);if(i&&gs(i.event.content,t))return{};var a=Promise.withResolvers();function s(l){l.getType()===e&&a.resolve()}n.addListener(ce.AccountData,s);try{var o=yield lv(5,()=>n.setAccountDataRaw(e,t));return yield a.promise,o}finally{n.removeListener(ce.AccountData,s)}})()}setAccountDataRaw(e,t){var n=ie("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(V.Put,n,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return w(function*(){if(t.isInitialSyncComplete()){var n=t.store.getAccountData(e);return n?n.getContent():null}var i=ie("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(V.Get,i)}catch(s){var a;if(((a=s.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw s}})()}deleteAccountData(e){var t=this;return w(function*(){var n=t.canSupport.get(kt.AccountDataDeletion);if(n===Ct.Unsupported){yield t.setAccountData(e,{});return}var i=ie("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=n===Ct.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(V.Delete,i,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(j.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(n=>{t.ignored_users[n]={}}),this.setAccountData(j.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return w(function*(){var i,a,s=t.length>1&&t[1]!==void 0?t[1]:{},o=n.getRoom(e),l=o==null?void 0:o.getMember(n.getSafeUserId()),u=l==null?void 0:l.membership,d=u==Ie.Invite&&(i=l==null||(a=l.events.member)===null||a===void 0?void 0:a.getSender())!==null&&i!==void 0?i:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(u,", inviter=").concat(d,", opts=").concat(JSON.stringify(s))),u==Ie.Join)return o;var h=Promise.resolve();if(s.inviteSignUrl){var f=new URL(s.inviteSignUrl);f.searchParams.set("mxid",n.credentials.userId),h=n.http.requestOtherUrl(V.Post,f)}var m={};s.viaServers&&(m.server_name=s.viaServers,m.via=s.viaServers);var v={},y=yield h;y&&(v.third_party_signed=y);var I=ie("/join/$roomid",{$roomid:e}),g=yield n.http.authedRequest(V.Post,I,m,v),p=g.room_id;s.acceptSharedHistory&&d&&n.cryptoBackend&&(yield n.cryptoBackend.maybeAcceptKeyBundle(p,d));var b=n.getRoom(p);if(b!=null&&b.hasMembershipState(n.credentials.userId,Ie.Join))return b;var R=new di(n,n.clientOpts,n.buildSyncApiOptions());return R.createRoom(p)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=this.getRoom(e);if(n!=null&&n.hasMembershipState(this.credentials.userId,Ie.Knock))return Promise.resolve({room_id:n.roomId});var i=ie("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};t.viaServers&&(a.server_name=t.viaServers,a.via=t.viaServers);var s={};return t.reason&&(s.reason=t.reason),this.http.authedRequest(V.Post,i,a,s)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,Se.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![Se.QUEUED,Se.NOT_SENT,Se.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===Se.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===Se.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,Se.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,j.RoomName,{name:t})}setRoomTopic(e,t,n){var i=d0(t,n);return this.sendStateEvent(e,j.RoomTopic,i)}getRoomTags(e){var t=ie("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(V.Get,t)}setRoomTag(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=ie("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(V.Put,i,void 0,n)}deleteRoomTag(e,t){var n=ie("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(V.Delete,n)}setRoomAccountData(e,t,n){var i=ie("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(V.Put,i,void 0,n)}setPowerLevel(e,t,n){var i=this;return w(function*(){var a,s;if(i.clientRunning&&i.isInitialSyncComplete()){var o;s=(o=i.getRoom(e))===null||o===void 0||(o=o.currentState)===null||o===void 0||(o=o.getStateEvents(j.RoomPowerLevels,""))===null||o===void 0?void 0:o.getContent()}if(!s)try{s=yield i.getStateEvent(e,j.RoomPowerLevels,"")}catch(d){if(d instanceof mt&&d.errcode==="M_NOT_FOUND")s={};else throw d}s=bl(s),(a=s)!==null&&a!==void 0&&a.users||(s.users={});var l=Array.isArray(t)?t:[t];for(var u of l)n==null?delete s.users[u]:s.users[u]=n;return i.sendStateEvent(e,j.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var n=this;return w(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return w(function*(){return n.sendStateEvent(e,Zp.name,t,n.getUserId())})()}sendEvent(e,t,n,i,a){var s,o,l,u;return!(t!=null&&t.startsWith(tn))&&t!==null?(u=i,l=n,o=t,s=null):(u=a,l=i,o=n,s=t),this.addThreadRelationIfNeeded(l,s,e),this.sendCompleteEvent(e,s,{type:o,content:l},u)}addThreadRelationIfNeeded(e,t,n){var i;if(t&&!((i=e["m.relates_to"])!==null&&i!==void 0&&i.rel_type)){var a,s,o=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=Rt(Rt({},e["m.relates_to"]),{},{rel_type:ze.name,event_id:t,is_falling_back:!o});var l=(s=this.getRoom(n))===null||s===void 0?void 0:s.getThread(t);if(l&&!o){var u,d;e["m.relates_to"]["m.in_reply_to"]={event_id:(u=(d=l.lastReply(h=>h.isRelation(ze.name)&&!h.status))===null||d===void 0?void 0:d.getId())!==null&&u!==void 0?u:t}}}}sendCompleteEvent(e,t,n,i,a){var s,o;typeof i=="string"?o=i:(s=i,o=a),o||(o=this.makeTxnId());var l=new zt(Object.assign(n,{event_id:"~"+e+":"+o,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),u=this.getRoom(e),d=t?u==null?void 0:u.getThread(t):void 0;d&&l.setThread(d),s||(this.reEmitter.reEmit(l,[Ve.Replaced,Ve.VisibilityChange]),u==null||u.reEmitter.reEmit(l,[Ve.BeforeRedaction]));var h=l.getAssociatedId();if(h!=null&&h.startsWith("~")){var f=u==null?void 0:u.getPendingEvents().find(v=>v.getId()===h);f==null||f.once(Ve.LocalEventIdReplaced,()=>{l.updateAssociatedId(f.getId())})}var m=l.getType();return this.logger.debug("sendEvent of type ".concat(m," in ").concat(e," with txnId ").concat(o).concat(s?" (delayed event)":"")),l.setTxnId(o),l.setStatus(Se.SENDING),s?this.encryptAndSendEvent(u,l,s):(u==null||u.addPendingEvent(l,o),l.status===Se.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(u,l))}encryptAndSendEvent(e,t,n){var i=this;return w(function*(){if(n)return i.sendEventHttpRequest(t,n);try{var a;i.eventsBeingEncrypted.add(t.getId());try{yield i.encryptEventIfNeeded(t,e??void 0)}finally{a=!i.eventsBeingEncrypted.delete(t.getId())}if(a)return{};t.status===Se.ENCRYPTING&&i.updatePendingEventStatus(e,t,Se.SENDING);var s=null;return i.scheduler&&(s=i.scheduler.queueEvent(t),s&&i.scheduler.getQueueForEvent(t).length>1&&i.updatePendingEventStatus(e,t,Se.QUEUED)),s||(s=i.sendEventHttpRequest(t),e&&(s=s.then(o=>(e.updatePendingEvent(t,Se.SENT,o.event_id),o)))),yield s}catch(o){i.logger.error("Error sending event",o);try{t.error=o,i.updatePendingEventStatus(e,t,Se.NOT_SENT)}catch(l){i.logger.error("Exception in error handler!",l)}throw o instanceof mt&&(o.event=t),o}})()}encryptEventIfNeeded(e,t){var n=this;return w(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,Se.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return w(function*(){var i;return e.isEncrypted()||e.getType()===j.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(i=n.cryptoBackend)===null||i===void 0?void 0:i.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var n;return t===j.Reaction?t:(n=this.getRoom(e))!==null&&n!==void 0&&n.hasEncryptionStateEvent()?j.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e,t){var n=e.getTxnId();n||(n=this.makeTxnId(),e.setTxnId(n));var i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:n},a;if(e.isState()){var s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),a=ie(s,i)}else if(e.isRedaction()&&e.event.redacts){var o="/rooms/$roomId/redact/$redactsEventId/$txnId";a=ie(o,Rt({$redactsEventId:e.event.redacts},i))}else a=ie("/rooms/$roomId/send/$eventType/$txnId",i);var l=e.getWireContent();return t?this.http.authedRequest(V.Put,a,pS(t),l):this.http.authedRequest(V.Put,a,void 0,l).then(u=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(u.event_id)),u))}redactEvent(e,t,n,i,a){var s,o,l;(s=n)!==null&&s!==void 0&&s.startsWith(tn)||(a=i,i=n,n=t,t=null);var u=(o=a)===null||o===void 0?void 0:o.reason,d={reason:u};if(((l=a)===null||l===void 0?void 0:l.with_rel_types)!==void 0){if(this.canSupport.get(kt.RelationBasedRedactions)===Ct.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(n," txnId: ").concat(i," threadId ").concat(t));var h=this.canSupport.get(kt.RelationBasedRedactions)===Ct.Stable?Lf.stable:Lf.unstable;d[h]=a.with_rel_types}return this.sendCompleteEvent(e,t,{type:j.RoomRedaction,content:d,redacts:n},i)}sendMessage(e,t,n,i){typeof t!="string"&&t!==null&&(i=n,n=t,t=null);var a=j.RoomMessage,s=n;return this.sendEvent(e,t,a,s,i)}sendTextMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=a0(n);return this.sendMessage(e,t,s,i)}sendNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=s0(n);return this.sendMessage(e,t,s,i)}sendEmoteMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=o0(n);return this.sendMessage(e,t,s,i)}sendImageMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(s=i||"Image",i=n,n=t,t=null);var o={msgtype:Sn.Image,url:n,info:i,body:s};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(s=i||"Sticker",i=n,n=t,t=null);var o={url:n,info:i,body:s};return this.sendEvent(e,t,j.Sticker,o)}sendHtmlMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=r0(n,i);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=n0(n,i);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=i0(n,i);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,n,i,a,s){var o=this;return w(function*(){if(!(yield o.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","sendDelayedEvent");return o.addThreadRelationIfNeeded(a,n,e),o.sendCompleteEvent(e,n,{type:i,content:a},t,s)})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return w(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"",l=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield s.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","sendDelayedStateEvent");var u={$roomId:e,$eventType:n,$stateKey:o},d=ie("/rooms/$roomId/state/$eventType",u);return o!==void 0&&(d=ie(d+"/$stateKey",u)),s.http.authedRequest(V.Put,d,pS(t),i,l)})()}_unstable_getDelayedEvents(e){var t=this;return w(function*(){if(!(yield t.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","getDelayedEvents");var n=e?{from:e}:void 0;return yield t.http.authedRequest(V.Get,"/delayed_events",n,void 0,{prefix:"".concat(It.Unstable,"/").concat(cn)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,i=this;return w(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","updateDelayedEvent");var s=ie("/delayed_events/$delayId",{$delayId:e}),o={action:t};return yield i.http.authedRequest(V.Post,s,void 0,o,Rt(Rt({},a),{},{prefix:"".concat(It.Unstable,"/").concat(cn)}))})()}sendReceipt(e,t,n){var i=arguments,a=this;return w(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:!1;if(a.isGuest())return Promise.resolve({});var o=ie("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),l=!s&&a.supportsThreads(),u=l?Rt(Rt({},n),{},{thread_id:Ts(e)}):n,d=a.http.authedRequest(V.Post,o,void 0,u||{}),h=a.getRoom(e.getRoomId());return h&&a.credentials.userId&&h.addLocalEchoReceipt(a.credentials.userId,e,t,s),d})()}sendReadReceipt(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:Xt.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var s=e.getId(),o=n.getRoom(e.getRoomId());if(o!=null&&o.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));return n.sendReceipt(e,i,{},a)}})()}setRoomReadMarkers(e,t,n,i){var a=this;return w(function*(){var s=a.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var o;if(n){if(o=n.getId(),s!=null&&s.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,n,Xt.Read)}var l;if(i){if(l=i.getId(),s!=null&&s.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,i,Xt.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,o,l)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var n=new URL(e);n.hash="",e=n.toString();var i=t+"_"+e;if(i in this.urlPreviewCache)return this.urlPreviewCache[i];var a=this.http.authedRequest(V.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:ts.V3,priority:"low"});return this.urlPreviewCache[i]=a,a}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});var i=ie("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=n||2e4),this.http.authedRequest(V.Put,i,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getRoom(e);if(!i)return[];var a=this.findPredecessorRooms(i,t,n),s=this.findSuccessorRooms(i,t,n);return[...a,i,...s]}findPredecessorRooms(e,t,n){for(var i,a=[],s=new Set([e.roomId]),o=(i=e.findPredecessor(n))===null||i===void 0?void 0:i.roomId;o!==null;){var l;if(o){if(s.has(o))break;s.add(o)}var u=this.getRoom(o);if(u===null)break;if(t){var d=u.currentState.getStateEvents(j.RoomTombstone,"");if(!d||d.getContent().replacement_room!==e.roomId)break}a.splice(0,0,u),e=u,o=(l=e.findPredecessor(n))===null||l===void 0?void 0:l.roomId}return a}findSuccessorRooms(e,t,n){for(var i=[],a=e.currentState.getStateEvents(j.RoomTombstone,"");a;){var s=this.getRoom(a.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var o,l=(o=s.findPredecessor(n))===null||o===void 0?void 0:o.roomId;if(!l||l!==e.roomId)break}i.push(s);var u=new Set(i.map(d=>d.roomId));if(u.size<i.length)return i.slice(0,i.length-1);e=s,a=e.currentState.getStateEvents(j.RoomTombstone,"")}return i}invite(e,t){var n=arguments,i=this;return w(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(typeof a!="object"&&(a={reason:a}),a.shareEncryptedHistory){var s;yield(s=i.cryptoBackend)===null||s===void 0?void 0:s.shareRoomHistoryWithUser(e,t)}return yield i.membershipChange(e,t,Ie.Invite,a.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var i=this;return w(function*(){var a,s=ie("/rooms/$roomId/invite",{$roomId:e}),o=i.getIdentityServerUrl(!0);if(!o)return Promise.reject(new mt({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var l={id_server:o,medium:t,address:n};if((a=i.identityServer)!==null&&a!==void 0&&a.getAccessToken){var u=yield i.identityServer.getAccessToken();u&&(l.id_access_token=u)}return i.http.authedRequest(V.Post,s,void 0,l)})()}leave(e){return this.membershipChange(e,void 0,Ie.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=this.getRoomUpgradeHistory(e),i=n;if(!t){i=[];for(var a of n)if(i.push(a),a.roomId===e)break}var s={},o=[],l=d=>this.leave(d).then(()=>{delete s[d]}).catch(h=>{s[d]=h});for(var u of i)o.push(l(u.roomId));return Promise.all(o).then(()=>s)}ban(e,t,n){return this.membershipChange(e,t,Ie.Ban,n)}forget(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=ie("/rooms/$room_id/forget",{$room_id:e}),s=yield n.http.authedRequest(V.Post,a);return i&&(n.store.removeRoom(e),n.emit(ce.DeleteRoom,e)),s})()}unban(e,t){var n=ie("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(V.Post,n,void 0,i)}kick(e,t,n){var i=ie("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:n};return this.http.authedRequest(V.Post,i,void 0,a)}membershipChange(e,t,n,i){var a=ie("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(V.Post,a,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushDetails()}setProfileInfo(e,t){var n=ie("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(V.Put,n,void 0,t)}setDisplayName(e){var t=this;return w(function*(){var n=yield t.setProfileInfo("displayname",{displayname:e}),i=t.getUser(t.getUserId());return i&&(i.displayName=e,i.emit(yr.DisplayName,i.events.presence,i)),n})()}setAvatarUrl(e){var t=this;return w(function*(){var n=yield t.setProfileInfo("avatar_url",{avatar_url:e}),i=t.getUser(t.getUserId());return i&&(i.avatarUrl=e,i.emit(yr.AvatarUrl,i.events.presence,i)),n})()}mxcUrlToHttp(e,t,n,i,a,s,o){return tc(this.baseUrl,e,t,n,i,a,s,o)}setSyncPresence(e){var t=this;return w(function*(){var n;(n=t.syncApi)===null||n===void 0||n.setPresence(e)})()}setPresence(e){var t=this;return w(function*(){var n=ie("/presence/$userId/status",{$userId:t.credentials.userId}),i=["offline","online","unavailable"];if(i.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(V.Put,n,void 0,e)})()}getPresence(e){var t=ie("/presence/$userId/status",{$userId:e});return this.http.authedRequest(V.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var a=Date.now()-i.errorTs;n=Math.max(fx-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;var o=new Promise((l,u)=>{wl(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,ke.Backward)).then(d=>{var h,f,m=d.chunk.map(this.getEventMapper());if(d.state){var v=d.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(v)}var[y,I,g]=e.partitionThreadedEvents(m);this.processAggregatedTimelineEvents(e,y),e.addEventsToTimeline(y,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,I,!0),g.forEach(p=>e.relations.aggregateChildEvent(p)),e.oldState.paginationToken=(h=d.end)!==null&&h!==void 0?h:null,d.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,m,(f=d.end)!==null&&f!==void 0?f:null,!0),delete this.ongoingScrollbacks[e.roomId],l(e)}).catch(d=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},u(d)})});return i={promise:o},this.ongoingScrollbacks[e.roomId]=i,o}getEventMapper(e){return sD(this,e||{})}getEventTimeline(e,t){var n=this;return w(function*(){var i,a,s,o;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads())return n.getThreadTimeline(e,t);var l=ie("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),u=void 0;(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(u={filter:JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER)});var d=yield n.http.authedRequest(V.Get,l,u);if(!d.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var h=n.getEventMapper(),f=h(d.event);if(f.isRelation(ze.name)){n.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var m=[...d.events_after.reverse().map(h),f,...d.events_before.map(h)],v=e.getTimelineForEvent(m[0].getId());v?v.getState(se.BACKWARDS).setUnknownStateEvents(d.state.map(h)):(v=e.addTimeline(),v.initialiseState(d.state.map(h)),v.getState(se.FORWARDS).paginationToken=d.end);var[y,I,g]=e.room.partitionThreadedEvents(m);return e.addEventsToTimeline(y,!0,!1,v,d.start),n.processThreadEvents(e.room,I,!0),n.processAggregatedTimelineEvents(e.room,y),g.forEach(p=>e.relations.aggregateChildEvent(p)),(a=(s=e.getTimelineForEvent(t))!==null&&s!==void 0?s:(o=e.room.findThreadForEvent(f))===null||o===void 0?void 0:o.liveTimeline)!==null&&a!==void 0?a:v})()}getThreadTimeline(e,t){var n=this;return w(function*(){var i;if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var a=ie("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),s={limit:"0"};(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(s.filter=JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER));var o=yield n.http.authedRequest(V.Get,a,s),l=n.getEventMapper(),u=l(o.event);if(e.canContain(u)){var d=n.canSupport.get(kt.RelationsRecursion)!==Ct.Unsupported;if(Xe.hasServerSideSupport)if(Xe.hasServerSideFwdPaginationSupport){var h,f,m;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var v=e.thread,y=yield n.fetchRelations(e.room.roomId,v.id,null,null,{dir:ke.Backward,from:o.start,recurse:d||void 0}),I=yield n.fetchRelations(e.room.roomId,v.id,null,null,{dir:ke.Forward,from:o.end,recurse:d||void 0}),g=[...I.chunk.reverse().filter(yh(v.id)).map(l),u,...y.chunk.filter(yh(v.id)).map(l)];for(var p of g){var b;yield(b=e.thread)===null||b===void 0?void 0:b.processEvent(p)}var R=e.getTimelineForEvent(u.getId());if(R?R.getState(se.BACKWARDS).setUnknownStateEvents(o.state.map(l)):(R=e.addTimeline(),R.initialiseState(o.state.map(l))),e.addEventsToTimeline(g,!0,!1,R,I.next_batch),!y.next_batch){var P=yield n.fetchRoomEvent(e.room.roomId,v.id);e.addEventsToTimeline([l(P)],!0,!1,R,null)}return R.setPaginationToken((h=y.next_batch)!==null&&h!==void 0?h:null,ke.Backward),R.setPaginationToken((f=I.next_batch)!==null&&f!==void 0?f:null,ke.Forward),n.processAggregatedTimelineEvents(e.room,g),(m=e.getTimelineForEvent(t))!==null&&m!==void 0?m:R}else{for(var E,C=e.thread,S=yield n.fetchRelations(e.room.roomId,C.id,ze.name,null,{dir:ke.Backward,from:o.start,recurse:d||void 0}),x=[],K=o.end;K;){var z,oe=yield n.fetchRelations(e.room.roomId,C.id,ze.name,null,{dir:ke.Forward,from:K,recurse:d||void 0});K=(z=oe.next_batch)!==null&&z!==void 0?z:null,x.push(...oe.chunk)}var ge=[...x.reverse().map(l),u,...S.chunk.map(l)];for(var xe of ge){var _e;yield(_e=e.thread)===null||_e===void 0?void 0:_e.processEvent(xe)}var Me=e.getLiveTimeline();if(Me.getState(se.BACKWARDS).setUnknownStateEvents(o.state.map(l)),e.addEventsToTimeline(ge,!0,!1,Me,null),!S.next_batch){var je=yield n.fetchRoomEvent(e.room.roomId,C.id);e.addEventsToTimeline([l(je)],!0,!1,Me,null)}return Me.setPaginationToken((E=S.next_batch)!==null&&E!==void 0?E:null,ke.Backward),Me.setPaginationToken(null,ke.Forward),n.processAggregatedTimelineEvents(e.room,ge),Me}}})()}getLatestTimeline(e){var t=this;return w(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var n;if(e.threadListType!==null){var i,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,ke.Backward,e.threadListType,e.getFilter());n=(i=a.chunk)===null||i===void 0?void 0:i[0]}else if(e.thread&&Xe.hasServerSideSupport){var s,o=t.canSupport.get(kt.RelationsRecursion)!==Ct.Unsupported,l=yield t.fetchRelations(e.room.roomId,e.thread.id,ze.name,null,{dir:ke.Backward,limit:1,recurse:o||void 0});n=(s=l.chunk)===null||s===void 0?void 0:s[0]}else{var u,d,h=ie("/rooms/$roomId/messages",{$roomId:e.room.roomId}),f={dir:"b"};(u=t.clientOpts)!==null&&u!==void 0&&u.lazyLoadMembers&&(f.filter=JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER));var m=yield t.http.authedRequest(V.Get,h,f);n=(d=m.chunk)===null||d===void 0?void 0:d[0]}if(!n)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,n.event_id)})()}createMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,o=ie("/rooms/$roomId/messages",{$roomId:e}),l={limit:i.toString(),dir:a};t&&(l.from=t);var u=null;if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(u=Object.assign({},sr.LAZY_LOADING_MESSAGES_FILTER)),s){var d;u=u||{},Object.assign(u,(d=s.getRoomTimelineFilterComponent())===null||d===void 0?void 0:d.toJSON())}return u&&(l.filter=JSON.stringify(u)),this.http.authedRequest(V.Get,o,l)}createThreadListMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:ke.Backward,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Kr.All,o=arguments.length>5?arguments[5]:void 0,l=ie("/rooms/$roomId/threads",{$roomId:e}),u={limit:i.toString(),dir:a,include:hw(s)};t&&(u.from=t);var d={};if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(d=Rt({},sr.LAZY_LOADING_MESSAGES_FILTER)),o){var h;d=Rt(Rt({},d),(h=o.getRoomTimelineFilterComponent())===null||h===void 0?void 0:h.toJSON())}Object.keys(d).length&&(u.filter=JSON.stringify(d));var f={prefix:Xe.hasServerSideListSupport===Gt.Stable?It.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(V.Get,l,u,void 0,f).then(m=>{var v;return Rt(Rt({},m),{},{chunk:(v=m.chunk)===null||v===void 0?void 0:v.reverse(),start:m.prev_batch,end:m.next_batch})})}paginateEventTimeline(e,t){var n=this,i=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,o=e.getTimelineSet().thread;t=t||{};var l=t.backwards||!1;if(i&&!l)throw new Error("paginateNotifTimeline can only paginate backwards");var u=l?se.BACKWARDS:se.FORWARDS,d=e.getPaginationToken(u),h=e.paginationRequests[u];if(h)return h;var f,m,v;if(i){var y;f="/notifications",m={limit:((y=t.limit)!==null&&y!==void 0?y:30).toString(),only:"highlight"},d&&d!=="end"&&(m.from=d),v=this.http.authedRequest(V.Get,f,m).then(function(){var R=w(function*(P){var E=P.next_token,C=[];P.notifications=P.notifications.filter(Hr);for(var S=0;S<P.notifications.length;S++){var x=P.notifications[S],K=n.getEventMapper()(x.event);n.getPushDetailsForEvent(K,!0),K.event.room_id=x.room_id,C[S]=K}var z=e.getTimelineSet();return z.addEventsToTimeline(C,l,!1,e,E),n.processAggregatedTimelineEvents(z.room,C),l&&!P.next_token&&e.setPaginationToken(null,u),!!P.next_token});return function(P){return R.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else if(s!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!Xe.hasServerSideFwdPaginationSupport&&u===ke.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");v=this.createThreadListMessagesRequest(e.getRoomId(),d,t.limit,u,s,e.getFilter()).then(R=>{if(R.state){var P=e.getState(u),E=R.state.filter(Hr).map(this.getEventMapper());P.setUnknownStateEvents(E)}var C=R.end,S=R.chunk.filter(Hr).map(this.getEventMapper()),x=e.getTimelineSet();return x.addEventsToTimeline(S,l,!1,e,C),this.processAggregatedTimelineEvents(a,S),this.processThreadRoots(a,S,l),l&&R.end==R.start&&e.setPaginationToken(null,u),R.end!==R.start}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else if(o){var I,g,p=this.getRoom((I=e.getRoomId())!==null&&I!==void 0?I:void 0);if(!p)throw new Error("Unknown room "+e.getRoomId());var b=this.canSupport.get(kt.RelationsRecursion)!==Ct.Unsupported;v=this.fetchRelations((g=e.getRoomId())!==null&&g!==void 0?g:"",o.id,null,null,{dir:u,limit:t.limit,from:d??void 0,recurse:b||void 0}).then(function(){var R=w(function*(P){var E=n.getEventMapper(),C=P.chunk.filter(Hr).filter(yh(o.id)).map(E);for(var S of C.slice().reverse()){yield o==null?void 0:o.processEvent(S);var x=S.getSender();(!l||(o==null?void 0:o.getEventReadUpTo(x))===null)&&p.addLocalEchoReceipt(x,S,Xt.Read)}var K=P.next_batch,z=e.getTimelineSet();if(z.addEventsToTimeline(C,l,!1,e,K??null),!K&&l){var oe,ge,xe=(oe=o.rootEvent)!==null&&oe!==void 0?oe:E(yield n.fetchRoomEvent((ge=e.getRoomId())!==null&&ge!==void 0?ge:"",o.id));z.addEventsToTimeline([xe],!0,!1,e,null)}return n.processAggregatedTimelineEvents(z.room,C),l&&!K&&e.setPaginationToken(null,u),!!K});return function(P){return R.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}else{if(!a)throw new Error("Unknown room "+e.getRoomId());v=this.createMessagesRequest(e.getRoomId(),d,t.limit,u,e.getFilter()).then(R=>{if(R.state){var P=e.getState(u),E=R.state.filter(Hr).map(this.getEventMapper());P.setUnknownStateEvents(E)}var C=R.end,S=R.chunk.filter(Hr).map(this.getEventMapper()),x=e.getTimelineSet(),[K,,z]=a.partitionThreadedEvents(S);x.addEventsToTimeline(K,l,!1,e,C),this.processAggregatedTimelineEvents(a,K),this.processThreadRoots(a,K.filter(ge=>ge.getServerAggregatedRelation(ze.name)),!1),z.forEach(ge=>a.relations.aggregateChildEvent(ge));var oe=R.end===void 0||R.end===R.start;return l&&oe&&e.setPaginationToken(null,u),!oe}).finally(()=>{e.paginationRequests[u]=null}),e.paginationRequests[u]=v}return v}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new di(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,n)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var n=this.sendStateEvent(e,j.RoomGuestAccess,{guest_access:t.allowJoin?Id.CanJoin:Id.Forbidden},""),i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,j.RoomHistoryVisibility,{history_visibility:Xp.WorldReadable},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestTokenFromEndpoint(e,t){var n=this;return w(function*(){var i=Object.assign({},t);return n.http.request(V.Post,e,void 0,i)})()}getRoomPushRule(e,t){if(this.pushRules){var n;return(n=this.pushRules[e])===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.find(i=>i.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){var i,a=!1,s=this.getRoomPushRule(e,t);if(s!=null&&s.actions.includes(wi.DontNotify)&&(a=!0),!n)a&&(i=this.deletePushRule(e,xt.RoomSpecific,s.rule_id));else if(!s)i=this.addPushRule(e,xt.RoomSpecific,t,{actions:[wi.DontNotify]});else if(!a){var o=Promise.withResolvers();this.deletePushRule(e,xt.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,xt.RoomSpecific,t,{actions:[wi.DontNotify]}).then(()=>{o.resolve()}).catch(l=>{o.reject(l)})}).catch(l=>{o.reject(l)}),i=o.promise}if(i)return new Promise((l,u)=>{i.then(()=>{this.getPushRules().then(d=>{this.pushRules=d,l()}).catch(d=>{u(d)})}).catch(d=>{this.getPushRules().then(h=>{this.pushRules=h,u(d)}).catch(h=>{u(d)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:B0.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(i=>this.processRoomEventsSearch(n,i))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then(i=>this.processRoomEventsSearch(e,i)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var s=new Set(a.highlights);e.highlights.forEach(m=>{s.add(m)}),e.highlights=Array.from(s);for(var o=this.getEventMapper(),l=(n=(i=a.results)===null||i===void 0?void 0:i.length)!==null&&n!==void 0?n:0,u=0;u<l;u++){var d=hc.fromJson(a.results[u],o),h=this.getRoom(d.context.getEvent().getRoomId());if(h)for(var f of d.context.getTimeline())f.setMetadata(h.currentState,!1);e.results.push(d)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new di(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=ie("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(V.Post,t,void 0,e).then(n=>{var i=sr.fromJson(this.credentials.userId,n.filter_id,e);return this.store.storeFilter(i),i})}getFilter(e,t,n){if(n){var i=this.store.getFilter(e,t);if(i)return Promise.resolve(i)}var a=ie("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(V.Get,a).then(s=>{var o=sr.fromJson(e,t,s);return this.store.storeFilter(o),o})}getOrCreateFilter(e,t){var n=this;return w(function*(){var i=n.store.getFilterIdByName(e),a;if(i){try{var s=yield n.getFilter(n.credentials.userId,i,!0);if(s){var o=s.getDefinition(),l=t.getDefinition();gs(o,l)&&(a=i)}}catch(d){if(d.errcode!=="M_UNKNOWN"&&d.errcode!=="M_NOT_FOUND")throw d}a||n.store.setFilterIdByName(e,void 0)}if(a)return a;var u=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,u.filterId),u.filterId})()}getOpenIdToken(){var e=ie("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(V.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(V.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return w(function*(){if(e.canSupportVoip){var t=!1,n=e.turnServersExpiry-Date.now();if(n>vS)e.logger.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var i=yield e.turnServer();if(i.uris){e.logger.debug("Got TURN URIs: "+i.uris+" refresh in "+i.ttl+" secs");var a={urls:i.uris,username:i.username,credential:i.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+i.ttl*1e3,t=!0,e.emit(ce.TurnServers,e.turnServers)}}catch(s){e.logger.error("Failed to get TURN URIs",s),s.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ce.TurnServersError,s,!0)):e.emit(ce.TurnServersError,s,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=ie("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(V.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=ie("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(V.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=ie("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(V.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return w(function*(){var t;e.clientWellKnownPromise=Re.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ce.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(n=>{var[i,a]=n;return e.includes(typeof a)}).reduce((n,i)=>{var[a,s]=i;return n[a]=s,n},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return w(function*(){var n=yield t.doesServerSupportUnstableFeature(ow),i=yield t.doesServerSupportUnstableFeature(lw),a=yield t.doesServerSupportUnstableFeature(uw);if(!n&&!i&&!a)throw Error("Server does not support the Mutual Rooms API");var s,o;a?(s="/uk.half-shot.msc2666/user/mutual_rooms",o={user_id:e}):(s=ie("/uk.half-shot.msc2666/user/".concat(i?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),o={});var l=[],u=null;do{var d={};u!=null&&a&&(d.batch_token=u);var h=yield t.http.authedRequest(V.Get,s,Rt(Rt({},o),d),void 0,{prefix:It.Unstable});l.push(...h.joined),h.next_batch_token!==void 0?u=h.next_batch_token:u=null}while(u!=null);return l})()}getVersions(){var e=this;return w(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(V.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(n=>{throw e.serverVersionsPromise=void 0,n});var t=yield e.serverVersionsPromise;return e.canSupport=yield rA(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return w(function*(){var{versions:n}=yield t.getVersions();return n&&n.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return w(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features;return i&&!!i[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return w(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return w(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Gt.Stable,list:Gt.Stable,fwdPagination:Gt.Stable};try{var[t,n,i,a,s,o]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Nu(n,t),list:Nu(a,i),fwdPagination:Nu(o,s)}}catch{return{threads:Gt.None,list:Gt.None,fwdPagination:Gt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,i){var a=arguments,s=this;return w(function*(){var o,l,u=a.length>4&&a[4]!==void 0?a[4]:{dir:ke.Backward},d=i?s.getEncryptedIfNeededEventType(e,i):null,[h,f]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,n,d,u)]),m=s.getEventMapper(),v=h?m(h):void 0,y=f.chunk.map(m);if(d===j.RoomMessageEncrypted){var I=v?y.concat(v):y;yield Promise.all(I.map(g=>s.decryptEventIfNeeded(g))),i!==null&&(y=y.filter(g=>g.getType()===i))}return v&&n===it.Replace&&(y=y.filter(g=>g.getSender()===v.getSender())),{originalEvent:v??null,events:y,nextBatch:(o=f.next_batch)!==null&&o!==void 0?o:null,prevBatch:(l=f.prev_batch)!==null&&l!==void 0?l:null}})()}generateClientSecret(){return bi(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case gv.IS:return this.http.getUrl("/terms",void 0,bn.V2,t);case gv.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return n&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=eh(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(V.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,n,i,a,s,o){n&&(i.session=n);var l={auth:i,refresh_token:!0};return e!=null&&(l.username=e),t!=null&&(l.password=t),s!=null&&(l.guest_access_token=s),o!=null&&(l.inhibit_login=o),this.registerRequest(l)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var n={};return t&&(n.kind=t),this.http.request(V.Post,"/register",n,e)}refreshToken(e){var t=n=>this.http.authedRequest(V.Post,"/refresh",void 0,{refresh_token:e},{prefix:n,inhibitLogoutEmit:!0});return t(It.V3).catch(n=>{if(n.errcode==="M_UNRECOGNIZED")return t(It.V1);throw n})}loginFlows(){return this.http.request(V.Get,"/login")}login(e,t){return this.loginRequest(Rt(Rt({},t),{},{type:e})).then(n=>(n.access_token&&n.user_id&&(this.http.opts.accessToken=n.access_token,this.credentials={userId:n.user_id}),n))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";n&&(a+="/"+n);var s={redirectUrl:e,[mx.unstable]:i};return this.http.getUrl(a,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return w(function*(){return yield t.http.authedRequest(V.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!1;return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(V.Post,"/logout")})()}deactivateAccount(e,t){var n={};return e&&(n.auth=e),t!==void 0&&(n.erase=t),this.http.authedRequest(V.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){var t=this;return w(function*(){var n={auth:e};return t.http.authedRequest(V.Post,"/login/get_token",void 0,n,{prefix:It.V1})})()}getFallbackAuthUrl(e,t){var n=ie("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t}).href}createRoom(e){var t=this;return w(function*(){var n,i=(e.invite_3pid||[]).filter(o=>!o.id_access_token);if(i.length>0&&(n=t.identityServer)!==null&&n!==void 0&&n.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var s of i)s.id_access_token=a}return t.http.authedRequest(V.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:ke.Backward},s=a;Xe.hasServerSideFwdPaginationSupport===Gt.Experimental&&(s=$g("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(kt.RelationsRecursion)===Ct.Unstable&&(s=$g("recurse","org.matrix.msc3981.recurse",s));var o=If(s),l="/rooms/$roomId/relations/$eventId";n!==null?(l+="/$relationType",i!==null&&(l+="/$eventType")):i!==null&&(this.logger.warn("eventType: ".concat(i,` ignored when fetching
            relations as relationType is null`)),i=null);var u=ie(l+"?"+o,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(V.Get,u,void 0,void 0,{prefix:It.V1})}roomState(e){var t=ie("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(V.Get,t)}fetchRoomEvent(e,t){var n=ie("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(V.Get,n)}members(e,t,n,i){var a={};t&&(a.membership=t),n&&(a.not_membership=n),i&&(a.at=i);var s=If(a),o=ie("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(V.Get,o)}upgradeRoom(e,t){var n=ie("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(V.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n){var i={$roomId:e,$eventType:t,$stateKey:n},a=ie("/rooms/$roomId/state/$eventType",i);return n!==void 0&&(a=ie(a+"/$stateKey",i)),this.http.authedRequest(V.Get,a)}sendStateEvent(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},s={$roomId:e,$eventType:t,$stateKey:i},o=ie("/rooms/$roomId/state/$eventType",s);return i!==void 0&&(o=ie(o+"/$stateKey",s)),this.http.authedRequest(V.Put,o,void 0,n,a)}roomInitialSync(e,t){var n,i=ie("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(V.Get,i,{limit:(n=t==null?void 0:t.toString())!==null&&n!==void 0?n:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){var a=this;return w(function*(){var s=ie("/rooms/$roomId/read_markers",{$roomId:e}),o={[Xt.FullyRead]:t,[Xt.Read]:n};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(o[Xt.ReadPrivate]=i),a.http.authedRequest(V.Post,s,void 0,o)})()}getJoinedRooms(){var e=ie("/joined_rooms",{});return this.http.authedRequest(V.Get,e)}getJoinedRoomMembers(e){var t=ie("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(V.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:n,since:i}=e,a=oM(e,hx);if(Object.keys(a).length===0){var s={server:t,limit:n,since:i};return this.http.authedRequest(V.Get,"/publicRooms",s)}else{var o={server:t},l=Rt({limit:n,since:i},a);return this.http.authedRequest(V.Post,"/publicRooms",o,l)}}createAlias(e,t){var n=ie("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(V.Put,n,void 0,i)}deleteAlias(e){var t=ie("/directory/room/$alias",{$alias:e});return this.http.authedRequest(V.Delete,t)}getLocalAliases(e){var t=ie("/rooms/$roomId/aliases",{$roomId:e}),n=It.V3;return this.http.authedRequest(V.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){var t=ie("/directory/room/$alias",{$alias:e});return this.http.authedRequest(V.Get,t)}getRoomDirectoryVisibility(e){var t=ie("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(V.Get,t)}setRoomDirectoryVisibility(e,t){var n=ie("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(V.Put,n,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:n}=e,i={search_term:t};return n!==void 0&&(i.limit=n),this.http.authedRequest(V.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var n=t?ie("/profile/$userId/$info",{$userId:e,$info:t}):ie("/profile/$userId",{$userId:e});return this.http.authedRequest(V.Get,n)}doesServerSupportExtendedProfiles(){var e=this;return w(function*(){return e.doesServerSupportUnstableFeature(dw)})()}getExtendedProfileRequestPrefix(){var e=this;return w(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?It.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return w(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(V.Get,ie("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return w(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=yield n.http.authedRequest(V.Get,ie("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()});return i[t]})()}setExtendedProfileProperty(e,t){var n=this;return w(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=n.getUserId();yield n.http.authedRequest(V.Put,ie("/profile/$userId/$key",{$userId:i,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return w(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(V.Delete,ie("/profile/$userId/$key",{$userId:n,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return w(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();return t.http.authedRequest(V.Patch,ie("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return w(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(V.Put,ie("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(V.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return w(function*(){var n="/account/3pid/add";return t.http.authedRequest(V.Post,n,void 0,e)})()}bindThreePid(e){var t=this;return w(function*(){var n="/account/3pid/bind";return t.http.authedRequest(V.Post,n,void 0,e)})()}unbindThreePid(e,t){var n=this;return w(function*(){var i="/account/3pid/unbind",a={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest(V.Post,i,void 0,a)})()}deleteThreePid(e,t){var n="/account/3pid/delete";return this.http.authedRequest(V.Post,n,void 0,{medium:e,address:t})}setPassword(e,t,n){var i="/account/password",a={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(V.Post,i,void 0,a)}getDevices(){return this.http.authedRequest(V.Get,"/devices")}getDevice(e){var t=ie("/devices/$device_id",{$device_id:e});return this.http.authedRequest(V.Get,t)}setDeviceDetails(e,t){var n=ie("/devices/$device_id",{$device_id:e});return this.http.authedRequest(V.Put,n,void 0,t)}deleteDevice(e,t){var n=ie("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(V.Delete,n,void 0,i)}deleteMultipleDevices(e,t){var n={devices:e};t&&(n.auth=t);var i="/delete_devices";return this.http.authedRequest(V.Post,i,void 0,n)}getPushers(){var e=this;return w(function*(){var t=yield e.http.authedRequest(V.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(n=>(n.hasOwnProperty(Uf.name)||(n[Uf.name]=!0),n))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(V.Post,t,void 0,e)}removePusher(e,t){var n="/pushers/set",i={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(V.Post,n,void 0,i)}setLocalNotificationSettings(e,t){var n="".concat(jb.name,".").concat(e);return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest(V.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Gr.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,i){var a=ie("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(V.Put,a,void 0,i)}deletePushRule(e,t,n){var i=ie("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(V.Delete,i)}setPushRuleEnabled(e,t,n,i){var a=ie("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(V.Put,a,void 0,{enabled:i})}setPushRuleActions(e,t,n,i){var a=ie("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(V.Put,a,void 0,{actions:i})}search(e,t){var{body:n,next_batch:i}=e,a={};return i&&(a.next_batch=i),this.http.authedRequest(V.Post,"/search",a,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(V.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(V.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={device_keys:{}};return t!==void 0&&(n.token=t),e.forEach(i=>{n.device_keys[i]=[]}),this.http.authedRequest(V.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0,i={};t===void 0&&(t="signed_curve25519");for(var[a,s]of e){var o=i[a]||{};vd(i,a,o),vd(o,s,t)}var l={one_time_keys:i};n&&(l.timeout=n);var u="/keys/claim";return this.http.authedRequest(V.Post,u,void 0,l)}getKeyChanges(e,t){var n={from:e,to:t};return this.http.authedRequest(V.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){var n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(V.Post,"/keys/device_signing/upload",void 0,n,{prefix:It.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,bn.V2,this.idBaseUrl);return this.http.requestOtherUrl(V.Post,t,e)}requestEmailToken(e,t,n,i,a){var s={client_secret:t,email:e,send_attempt:n==null?void 0:n.toString()};return i&&(s.next_link=i),this.http.idServerRequest(V.Post,"/validate/email/requestToken",s,bn.V2,a)}requestMsisdnToken(e,t,n,i,a,s){var o={client_secret:n,country:e,phone_number:t,send_attempt:i==null?void 0:i.toString()};return a&&(o.next_link=a),this.http.idServerRequest(V.Post,"/validate/msisdn/requestToken",o,bn.V2,s)}submitMsisdnToken(e,t,n,i){var a={sid:e,client_secret:t,token:n};return this.http.idServerRequest(V.Post,"/validate/msisdn/submitToken",a,bn.V2,i??void 0)}submitMsisdnTokenOtherUrl(e,t,n,i){var a={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(V.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest(V.Get,"/hash_details",void 0,bn.V2,e)}identityHashedLookup(e,t){var n=this;return w(function*(){var i={},a=yield n.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=a.lookup_pepper;var s={};if(a.algorithms.includes("sha256"))i.addresses=yield Promise.all(e.map(function(){var f=w(function*(m){var v=m[0].toLowerCase(),y=m[1].toLowerCase(),I=yield J0("".concat(v," ").concat(y," ").concat(i.pepper)),g=dc(I);return s[g]=m[0],g});return function(m){return f.apply(this,arguments)}}())),i.algorithm="sha256";else if(a.algorithms.includes("none"))i.addresses=e.map(f=>{var m=f[0].toLowerCase(),v=f[1].toLowerCase(),y="".concat(m," ").concat(v);return s[y]=f[0],y}),i.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var o=yield n.http.idServerRequest(V.Post,"/lookup",i,bn.V2,t);if(!(o!=null&&o.mappings))return[];var l=[];for(var u of Object.keys(o.mappings)){var d=o.mappings[u],h=s[u];if(!h)throw new Error("Identity server returned more results than expected");l.push({address:h,mxid:d})}return l})()}lookupThreePid(e,t,n){var i=this;return w(function*(){var a=yield i.identityHashedLookup([[t,e]],n),s=a.find(l=>l.address===t);if(!s)return{};var o={address:t,medium:e,mxid:s.mxid};return o})()}bulkLookupThreePids(e,t){var n=this;return w(function*(){var i=yield n.identityHashedLookup(e.map(l=>[l[1],l[0]]),t),a=[],s=function*(u){var d=e.find(h=>h[1]===u.address);if(!d)throw new Error("Identity sever returned unexpected results");a.push([d[0],u.address,u.mxid])};for(var o of i)yield*s(o);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest(V.Get,"/account",void 0,bn.V2,e)}sendToDevice(e,t,n){var i=ie("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),a={messages:Qi(t)},s=new Map;for(var[o,l]of t)s.set(o,Array.from(l.keys()));return this.logger.debug("PUT ".concat(i),s),this.http.authedRequest(V.Put,i,void 0,a)}encryptAndSendToDevice(e,t,n){var i=this;return w(function*(){if(!i.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield i.cryptoBackend.encryptToDeviceMessages(e,t,n);yield i.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(V.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var n=ie("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(V.Get,n,t)}getThirdpartyUser(e,t){var n=ie("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(V.Get,n,t)}getTerms(e,t){var n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(V.Get,n)}agreeToTerms(e,t,n,i){var a=this.termsUrlForService(e,t),s={Authorization:"Bearer "+n};return this.http.requestOtherUrl(V.Post,a,{user_accepts:i},{headers:s})}reportEvent(e,t,n,i){var a=ie("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(V.Post,a,void 0,{score:n,reason:i})}reportRoom(e,t){var n=ie("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(V.Post,n,void 0,{reason:t})}getRoomHierarchy(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,s=ie("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(i),max_depth:n==null?void 0:n.toString(),from:a,limit:t==null?void 0:t.toString()};return this.http.authedRequest(V.Get,s,o,void 0,{prefix:It.V1}).catch(l=>{if(l.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(V.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw l})}unstableCreateFileTree(e){var t=this;return w(function*(){var{room_id:n}=yield t.createRoom({name:e,preset:Qp.PrivateChat,power_level_content_override:Rt(Rt({},oD),{},{users:{[t.getUserId()]:100}}),creation_content:{[pd]:Za.Space},initial_state:[{type:Df.name,state_key:Nf.name,content:{[xf.name]:!0}},{type:j.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new Xy(t,n)})()}unstableGetFileTreeSpace(e){var t,n,i=this.getRoom(e);if((i==null?void 0:i.getMyMembership())!==Ie.Join)return null;var a=i.currentState.getStateEvents(j.RoomCreate,""),s=i.currentState.getStateEvents(Df.name,Nf.name);if(!a)throw new Error("Expected single room create event");return!(s!=null&&(t=s.getContent())!==null&&t!==void 0&&t[xf.name])||((n=a.getContent())===null||n===void 0?void 0:n[pd])!==Za.Space?null:new Xy(this,e)}slidingSync(e,t,n){var i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(V.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:n})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(kt.IntentionalMentions)!==Ct.Unsupported}getRoomSummary(e,t){var n=this;return w(function*(){var i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=ie("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest(V.Get,a,{via:t},void 0,i)}catch(o){if(o instanceof mt&&o.errcode==="M_UNRECOGNIZED"){var s=ie("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest(V.Get,s,{via:t},void 0,i)}else throw o}})()}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){this.supportsThreads()&&e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return w(function*(){return e.http.authedRequest(V.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var i=this;return w(function*(){var a=ie("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:n};try{return yield i.http.authedRequest(V.Get,a,s,void 0,{prefix:It.V1})}catch(o){if(o.errcode==="M_UNRECOGNIZED"&&(o.httpStatus===400||o.httpStatus===404||o.httpStatus===405))return yield i.http.authedRequest(V.Get,a,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw o}})()}getAuthIssuer(){var e=this;return w(function*(){return e.http.request(V.Get,"/auth_issuer",void 0,void 0,{prefix:It.Unstable+"/org.matrix.msc2965"})})()}getAuthMetadata(){var e=this;return w(function*(){var t;try{t=yield e.http.request(V.Get,"/auth_metadata",void 0,void 0,{prefix:It.Unstable+"/org.matrix.msc2965"})}catch(i){if(i instanceof mt&&i.errcode==="M_UNRECOGNIZED"){var{issuer:n}=yield e.getAuthIssuer();return om(n)}throw i}return lm(t)})()}}c(mc,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function pS(r){return Object.fromEntries(Object.entries(r).map(e=>{var[t,n]=e;return["".concat(cn,".").concat(t),n]}))}function cw(r,e){var t,n=r.getUserId(),i=e.getId(),a=r.getRoom(e.getRoomId());if(!(!a||!n||!i)){if(!a.findEventById(i)){T.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var s=!!e.threadRootId&&!e.isThreadRoot,o;if(s){var l=a.getThread(e.threadRootId);o=l?l.hasUserReadEvent(n,i):!0}else o=a.hasUserReadEvent(n,i);if(!o){var u=r.getPushActionsForEvent(e,!0),d=!!(u!=null&&(t=u.tweaks)!==null&&t!==void 0&&t.highlight);if(d){var h=a.getUnreadCountForEventContext(We.Highlight,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,We.Highlight,h):a.setUnreadNotificationCount(We.Highlight,h)}var f=!!(u!=null&&u.notify);if(f){var m=a.getUnreadCountForEventContext(We.Total,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,We.Total,m):a.setUnreadNotificationCount(We.Total,m)}}}}function Ts(r){return ll(r)?_l:r.threadRootId}function ll(r){if(!r.threadRootId||r.isThreadRoot)return!0;if(!r.isRelation())return T.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(r.getId())),!0;if(r.isRelation(ze.name))return!1;var e=r.relationEventId===r.threadRootId;return e}function mS(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function gS(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?mS(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):mS(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}var Zt=function(r){return r.New="Thread.new",r.Update="Thread.update",r.NewReply="Thread.newReply",r.ViewThread="Thread.viewThread",r.Delete="Thread.delete",r}({}),Gt=function(r){return r[r.None=0]="None",r[r.Experimental=1]="Experimental",r[r.Stable=2]="Stable",r}({});function Nu(r,e){return r?Gt.Stable:e?Gt.Experimental:Gt.None}class Xe extends v0{constructor(e,t,n){var i,a;if(super(),i=this,this.id=e,this.rootEvent=t,c(this,"timelineSet",void 0),c(this,"_currentUserParticipated",!1),c(this,"reEmitter",void 0),c(this,"lastEvent",void 0),c(this,"replyCount",0),c(this,"lastPendingEvent",void 0),c(this,"pendingReplyCount",0),c(this,"room",void 0),c(this,"client",void 0),c(this,"pendingEventOrdering",void 0),c(this,"processRootEventPromise",void 0),c(this,"initialEventsFetched",!Xe.hasServerSideSupport),c(this,"initalEventFetchProm",void 0),c(this,"replayEvents",[]),c(this,"onTimelineReset",w(function*(){yield i.processRootEventPromise,i.processRootEventPromise=void 0})),c(this,"onBeforeRedaction",(s,o)=>{s!=null&&s.isRelation(ze.name)&&this.room.eventShouldLiveIn(s).threadId===this.id&&s.getId()!==this.id&&!o.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Zt.Update,this))}),c(this,"onRedaction",function(){var s=w(function*(o,l,u){if(u===i.id)if(i.replyCount<=0){for(var d of i.timeline)i.clearEventMetadata(d);i.lastEvent=i.rootEvent,i._currentUserParticipated=!1,i.emit(Zt.Delete,i)}else{var h;((h=i.lastEvent)===null||h===void 0?void 0:h.getId())===o.getAssociatedId()&&(yield i.processRootEventPromise,i.processRootEventPromise=void 0),yield i.updateThreadMetadata()}});return function(o,l,u){return s.apply(this,arguments)}}()),c(this,"onTimelineEvent",(s,o,l)=>{if(!l){var u=s.getSender();u&&o&&this.shouldSendLocalEchoReceipt(u,s)&&o.addLocalEchoReceipt(u,s,Xt.Read),s.getId()!==this.id&&s.isRelation(ze.name)&&this.replyCount++}this.onEcho(s,l??!1)}),c(this,"onLocalEcho",s=>{this.onEcho(s,!1)}),c(this,"onEcho",function(){var s=w(function*(o,l){o.threadRootId===i.id&&i.lastEvent!==o&&(yield i.updateThreadMetadata(),o.isRelation(ze.name)&&(l||(i.lastEvent=void 0,i.emit(Zt.NewReply,i,o))))});return function(o,l){return s.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(n!=null&&n.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=(a=n.pendingEventOrdering)!==null&&a!==void 0?a:ws.Chronological,this.timelineSet=new Va(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new xs(this),this.reEmitter.reEmit(this.timelineSet,[le.Timeline,le.TimelineReset]),this.room.on(Ve.BeforeRedaction,this.onBeforeRedaction),this.room.on(le.Redaction,this.onRedaction),this.room.on(le.LocalEchoUpdated,this.onLocalEcho),this.room.on(le.TimelineReset,this.onTimelineReset),this.timelineSet.on(le.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return w(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),n=e.client.getEventMapper();e.rootEvent=n(t)}catch(i){T.error("Failed to fetch thread root to construct thread with",i)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){Xe.hasServerSideSupport=e,e!==Gt.Stable&&(as.setPreferUnstable(!0),ss.setPreferUnstable(!0),ze.setPreferUnstable(!0))}static setServerSideListSupport(e){Xe.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){Xe.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n,i=(n=this.client.canSupport.get(kt.RelationsRecursion))!==null&&n!==void 0?n:Ct.Unsupported;if(i===Ct.Unsupported){var a,s=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(s){var o=this.findEventById(s);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(se.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(n=>this.addEvent(n,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var i=this.lastReply(),a=!i||e.localTimestamp>=i.localTimestamp;if(!Xe.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(it.Annotation)||e.isRelation(it.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(ze.name)&&!t&&a&&(this.lastEvent=void 0),n&&(this.emit(Zt.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var n,i;if(this.initialEventsFetched){var s,o=(s=this.client.canSupport.get(kt.RelationsRecursion))!==null&&s!==void 0?s:Ct.Unsupported;o===Ct.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var a;(a=this.replayEvents)===null||a===void 0||a.push(e)}(n=this.timelineSet.relations)===null||n===void 0||n.aggregateParentEvent(e),(i=this.timelineSet.relations)===null||i===void 0||i.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return w(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:n,userId:i,receipt:a,synthetic:s}of e)this.addReceiptToStructure(t,n,i,a,s)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e==null?void 0:e.getServerAggregatedRelation(ze.name)}processRootEvent(){var e=this;return w(function*(){var t=e.getRootEventBundledRelationship();if(Xe.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var n=e.client.getEventMapper();e.lastEvent=n(gS(gS({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===ws.Detached?this.room.getPendingEvents():this.events,t=e.filter(n=>{var i;return n.threadRootId===this.id&&n.isRelation(ze.name)&&n.status!==null&&n.getId()!==((i=this.lastEvent)===null||i===void 0?void 0:i.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var n=this;return w(function*(){var i=n.liveTimeline;n.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=n.liveTimeline,s,o;if(e){var l=yield n.client.createMessagesRequest(n.roomId,e,1,ke.Forward);s=l.end}if(t){var u=yield n.client.createMessagesRequest(n.roomId,t,1,ke.Backward);o=u.start}t&&i.getPaginationToken(ke.Forward)===t&&i.setPaginationToken(o??null,ke.Forward),e&&a.getPaginationToken(ke.Backward)===e&&a.setPaginationToken(s??null,ke.Backward)})()}updateThreadFromRootEvent(){var e=this;return w(function*(){Xe.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return w(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,ke.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(le.TimelineReset,e.room,e.timelineSet,!0)}catch(n){T.error("Failed to load start of newly created thread: ",n),e.initialEventsFetched=!1}e.emit(Zt.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return w(function*(){var n,i=(n=t.client.canSupport.get(kt.RelationsRecursion))!==null&&n!==void 0?n:Ct.Unsupported;if(i===Ct.Unsupported){for(var a=e.length,s=new Array(a),o=0;o<a;o++)s[o]=e[o];return Promise.all(s.filter(gx).map(function(){var l=w(function*(u){try{var d=yield t.client.relations(t.roomId,u.getId(),it.Replace,u.getType(),{limit:1});if(d.events.length){var h=d.events[0];u.makeReplaced(h),t.insertEventIntoTimeline(h)}}catch(f){T.error("Failed to load edits for encrypted thread event",f)}});return function(u){return l.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(se.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[ze.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:i=>i.isRelation(ze.name),t=this.timeline.length-1;t>=0;t--){var n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof zt}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(n&&i){var a=i.getTs()<this.room.getOldestThreadedReceiptTs(),s=i.getId();if(a&&s)return s}var o=super.getEventReadUpTo(e,t);if(i){var l=this.room.getLastUnthreadedReceiptFor(e);if(!l)return o;for(var u=((d=this.timeline)===null||d===void 0?void 0:d.length)-1;u>=0;--u){var d,h,f=this.timeline[u];if(f.getId()===o)return o;if(f.getTs()<l.ts)return(h=f.getId())!==null&&h!==void 0?h:o}}return o}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,i,a,s,o,l,u=((n=(i=this.lastReply())===null||i===void 0?void 0:i.getTs())!==null&&n!==void 0?n:0)<this.room.getOldestThreadedReceiptTs(),d=(a=(s=this.room.getLastUnthreadedReceiptFor(e))===null||s===void 0?void 0:s.ts)!==null&&a!==void 0?a:0,h=((o=this===null||this===void 0||(l=this.lastReply())===null||l===void 0?void 0:l.getTs())!==null&&o!==void 0?o:0)<d;if(u||h)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}c(Xe,"hasServerSideSupport",Gt.None);c(Xe,"hasServerSideListSupport",Gt.None);c(Xe,"hasServerSideFwdPaginationSupport",Gt.None);function gx(r){return r.isEncrypted()&&(r.isRelation(ze.name)||r.isThreadRoot)}var as=new Zd("related_by_senders","io.element.relation_senders"),ss=new Zd("related_by_rel_types","io.element.relation_types"),ze=new Zd("m.thread","io.element.thread"),Kr=function(r){return r[r.My=0]="My",r[r.All=1]="All",r}({});function hw(r){switch(r){case Kr.My:return"participated";default:return"all"}}class yS extends Error{constructor(e,t,n){super(t),this.code=e,c(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=yx(this,n)}}function yx(r,e){var t=r.name+"[msg: "+r.message;return e&&(t+=", "+Object.keys(e).map(n=>n+": "+e[n]).join(", ")),t+="]",t}var SS=Object.freeze({visible:!0}),Ve=function(r){return r.Decrypted="Event.decrypted",r.BeforeRedaction="Event.beforeRedaction",r.VisibilityChange="Event.visibilityChange",r.LocalEventIdReplaced="Event.localEventIdReplaced",r.Status="Event.status",r.Replaced="Event.replaced",r.RelationsCreated="Event.relationsCreated",r.SentinelUpdated="Event.sentinelUpdated",r}({});class zt extends nt{setMetadata(e,t){var n,i,a=this.isState()&&this.getType()===j.RoomMember&&this.getSender()===this.getStateKey(),s=!1;if(a||!((n=this.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)){var o=e.getSentinelMember(this.getSender());o!==this.sender&&(s=!0),this.sender=o}if(a||!((i=this.target)!==null&&i!==void 0&&(i=i.events)!==null&&i!==void 0&&i.member)&&this.getType()===j.RoomMember){var l=e.getSentinelMember(this.getStateKey());l!==this.target&&(s=!0),this.target=l}this.isState()&&t&&(this.forwardLooking=!1),s&&this.emit(Ve.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,c(this,"pushDetails",{}),c(this,"_replacingEvent",null),c(this,"_localRedactionEvent",null),c(this,"_isCancelled",!1),c(this,"clearEvent",void 0),c(this,"visibility",SS),c(this,"_hasCachedExtEv",!1),c(this,"_cachedExtEv",void 0),c(this,"_decryptionFailureReason",null),c(this,"senderCurve25519Key",null),c(this,"claimedEd25519Key",null),c(this,"forwardingCurve25519KeyChain",[]),c(this,"untrusted",null),c(this,"decryptionPromise",null),c(this,"retryDecryption",!1),c(this,"txnId",void 0),c(this,"thread",void 0),c(this,"threadId",void 0),c(this,"localTimestamp",void 0),c(this,"sender",null),c(this,"target",null),c(this,"status",null),c(this,"error",null),c(this,"forwardLooking",!0),c(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(i=>{typeof t[i]=="string"&&(t[i]=Zc(t[i]))}),["membership","avatar_url","displayname"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0?void 0:a[i])=="string"&&(t.content[i]=Zc(t.content[i]))}),["rel_type"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0||(a=a["m.relates_to"])===null||a===void 0?void 0:a[i])=="string"&&(t.content["m.relates_to"][i]=Zc(t.content["m.relates_to"][i]))}),this.txnId=t.txn_id;var n=this.getAge();this.localTimestamp=n!==void 0?Date.now()-n:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new xs(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=nr.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===j.RoomMessageEncrypted)for(var[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var n=this.getContent()[ic];return"msgid=".concat(n," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if((t==null?void 0:t.rel_type)===ze.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var n=this.getUnsigned();if(typeof n[md.name]=="string")return n[md.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(ze.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return Fb.findIn(e)}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===nS.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=n.clearEvent&&!n.isDecryptionFailure(),s=i.forceRedecryptIfUntrusted&&n.isKeySourceUntrusted();if(a&&!s)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(T.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,i),n.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var a=void 0;try{var s=yield e.decryptEvent(n);i.isRetry===!0&&T.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(s),n._decryptionFailureReason=null}catch(l){var o=l instanceof yS?l.detailedString:String(l);if(a=l,n.retryDecryption){T.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(o));continue}T.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(o)),n.setClearDataForDecryptionFailure(String(l)),n._decryptionFailureReason=l instanceof yS?l.code:nS.UNKNOWN_ERROR}n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),i.emit!==!1&&n.emit(Ve.Decrypted,n,a);return}})()}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(n=e.claimedEd25519Key)!==null&&n!==void 0?n:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:j.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===j.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(Ve.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n,i=(t=e==null?void 0:e.visible)!==null&&t!==void 0?t:!0,a=(n=e==null?void 0:e.reason)!==null&&n!==void 0?n:null,s=!1;(this.visibility.visible!==i||!this.visibility.visible&&this.visibility.reason!==a)&&(s=!0),s&&(i?this.visibility=SS:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(Ve.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(Ve.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var n in this.event)this.event.hasOwnProperty(n)&&!Sx.has(n)&&delete this.event[n];this.isEncrypted()&&(this.clearEvent=void 0);var i=this.getType()in ES?ES[this.getType()]:{},a=this.getContent();for(var s in a)a.hasOwnProperty(s)&&!i[s]&&delete a[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var n of t.events){var i;((i=n.getRelation())===null||i===void 0?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var n=e.getLiveTimeline();n.getTimelineSet().insertEventIntoTimeline(this,n,n.getState(se.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===j.RoomRedaction}asVisibilityChange(){if(!Xi.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var n=this.getWireContent(),i=!!n.visible,a=n.reason;return a&&typeof a!="string"?null:{visible:i,reason:a,eventId:t}}isVisibilityEvent(){return Xi.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var n,i;return(n=(i=this.clearEvent)===null||i===void 0?void 0:i.unsigned.redacted_because)!==null&&n!==void 0?n:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,n=this.getUnsigned(),i=this.getId();this.event=e,n.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=n.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit(Ve.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(Ve.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(Ve.LocalEventIdReplaced,this)}isRelation(e){var t,n=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(n!=null&&n.rel_type)&&[it.Replace,it.Thread].includes(n.rel_type)?!1:!!(n!=null&&n.rel_type&&n.event_id&&(!e||n.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(Ve.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(it.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(it.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var n;return(n=this._replacingEvent.getDate())!==null&&n!==void 0?n:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new zt(JSON.parse(JSON.stringify(this.event)));for(var[t,n]of Object.entries(this))t!=="event"&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=Cf(this.event),n=Cf(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Zt.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[Zt.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var Sx=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),ES={[j.RoomMember]:{membership:1},[j.RoomJoinRules]:{join_rule:1},[j.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},Ex=["org.matrix.hydra.11","12"];function _x(r){return Ex.includes(r)}var vr=function(r){return r[r.NotStarted=0]="NotStarted",r[r.InProgress=1]="InProgress",r[r.Finished=2]="Finished",r}(vr||{}),Ae=function(r){return r.Events="RoomState.events",r.Members="RoomState.members",r.NewMember="RoomState.newMember",r.Update="RoomState.update",r.BeaconLiveness="RoomState.BeaconLiveness",r.Marker="RoomState.Marker",r}({});class ul extends nt{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:vr.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,c(this,"reEmitter",new xs(this)),c(this,"sentinels",{}),c(this,"displayNameToUserIds",new Map),c(this,"userIdsToDisplayNames",{}),c(this,"tokenToInvite",{}),c(this,"joinedMemberCount",null),c(this,"summaryJoinedMemberCount",null),c(this,"invitedMemberCount",null),c(this,"summaryInvitedMemberCount",null),c(this,"modified",-1),c(this,"members",{}),c(this,"events",new Map),c(this,"paginationToken",null),c(this,"beacons",new Map),c(this,"_liveBeaconIds",[]),c(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(j.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(T.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ie.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ie.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new el(this.roomId,e);var n=this.members[e];n!=null&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new ul(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=vr.NotStarted,Array.from(this.events.values()).forEach(n=>{e.setStateEvents(Array.from(n.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==vr.Finished&&this.getMembers().forEach(n=>{if(n.isOutOfBand()){var i;(i=e.getMember(n.userId))===null||i===void 0||i.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(n=>!this.events.has(n.getType())||!this.events.get(n.getType()).has(n.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState())){Zp.matches(n.getType())&&this.setBeacon(n);var i=this.getStateEventMatching(n);if(this.setStateEvent(n),n.getType()===j.RoomMember){var a;this.updateDisplayNameCache(n.getStateKey(),(a=n.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(n)}this.emit(Ae.Events,n,this,i)}}),this.onBeaconLivenessChange(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState()))if(n.getType()===j.RoomMember){var i=n.getStateKey();(n.getContent().membership===Ie.Leave||n.getContent().membership===Ie.Ban)&&(n.getContent().avatar_url=n.getContent().avatar_url||n.getPrevContent().avatar_url,n.getContent().displayname=n.getContent().displayname||n.getPrevContent().displayname);var a=this.getOrCreateMember(i,n);a.setMembershipEvent(n,this),this.updateMember(a),this.emit(Ae.Members,n,this,a)}else if(n.getType()===j.RoomPowerLevels){if(n.getStateKey()!=="")return;var s=Object.values(this.members),o=this.getStateEvents(j.RoomCreate,""),l=_S(this.getRoomVersion(),o);s.forEach(u=>{var d=u.getLastModifiedTime();if(o){var h=bS(u.userId,n,l);u.setPowerLevel(h,n)}d!==u.getLastModifiedTime()&&this.emit(Ae.Members,n,this,u)}),this.sentinels={}}else Lb.matches(n.getType())&&this.emit(Ae.Marker,n,t)}),this.emit(Ae.Update,this)}processBeaconEvents(e,t){var n=this;return w(function*(){if(!(!e.length||!n.beacons.size)){var i=[...n.beacons.values()].reduce((u,d)=>(u[d.beaconInfoId]=d,u),{}),a=(u,d)=>{if(Sv.matches(d.getType())){var h=i[u];h&&h.addLocations([d])}},s=function*(d){var h,f=(h=d.getRelation())===null||h===void 0?void 0:h.event_id;if(!f||!i[f])return{v:void 0};if(!Sv.matches(d.getType())&&!d.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(d),a(f,d)}catch{d.isDecryptionFailure()&&d.once(Ve.Decrypted,w(function*(){a(f,d)}))}},o;for(var l of e)if(o=yield*s(l),o)return o.v}})()}getOrCreateMember(e,t){var n=this.members[e];return n||(n=new el(this.roomId,e),this.members[e]=n,this.emit(Ae.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=wd(e);if(this.beacons.has(t)){var n=this.beacons.get(t);if(e.isRedacted()){var i;n.beaconInfoId===((i=e.getRedactionEvent())===null||i===void 0?void 0:i.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var a=new h0(e);this.reEmitter.reEmit(a,[tt.New,tt.Update,tt.Destroy,tt.LivenessChange]),this.emit(tt.New,e,a),a.on(tt.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(tt.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(Ae.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return(t=(n=this.events.get(e.getType()))===null||n===void 0?void 0:n.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(j.RoomCreate,""),n=this.getStateEvents(j.RoomPowerLevels,"");if(n&&t){var i=bS(e.userId,n,_S(this.getRoomVersion(),t));e.setPowerLevel(i,n)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===vr.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===vr.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===vr.NotStarted&&(this.oobMemberFlags.status=vr.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===vr.InProgress&&(this.oobMemberFlags.status=vr.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])}),T.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=vr.NotStarted}setOutOfBandMembers(e){T.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===vr.InProgress&&(T.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=vr.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(Ae.Update,this))}setOutOfBandMember(e){if(e.getType()===j.RoomMember){var t=e.getStateKey(),n=this.getMember(t);if(!(n&&!n.isOutOfBand())){var i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(Ae.Members,e,this,i)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(ta(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var n=this.getMember(t);if(!n||n.membership===Ie.Leave||e.status||e.isRedacted())return!1;var i=this.maySendEvent(j.RoomRedaction,t);return i?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",n.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var n=this.getStateEvents(j.RoomPowerLevels,""),i={};n&&(i=n.getContent());var a=50;return Wg(i[e])&&(a=i[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(j.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){var i,a=this.getStateEvents(j.RoomPowerLevels,""),s,o={},l=0,u=0;a&&(s=a.getContent(),o=s.events||{},Number.isSafeInteger(s.state_default)?l=s.state_default:l=50,Number.isSafeInteger(s.events_default)&&(u=s.events_default));var d=n?l:u;Number.isSafeInteger(o[e])&&(d=o[e]);var h=this.getMember(t),f=(i=h==null?void 0:h.powerLevel)!==null&&i!==void 0?i:0;return f>=d}mayTriggerNotifOfType(e,t){var n=this.getMember(t);if(!n)return!1;var i=this.getStateEvents(j.RoomPowerLevels,""),a=50;return i&&i.getContent()&&i.getContent().notifications&&Wg(i.getContent().notifications[e])&&(a=i.getContent().notifications[e]),n.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(j.RoomJoinRules,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.join_rule||F0.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(j.RoomHistoryVisibility,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.history_visibility||Xp.Shared}getGuestAccess(){var e,t=this.getStateEvents(j.RoomGuestAccess,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.guest_access||Id.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(j.RoomPredecessor,"");if(t){var n=t.getContent(),i=n.predecessor_room_id,a=n.last_known_event_id;typeof a!="string"&&(a=void 0);var s=n.via_servers;if(Array.isArray(s)||(s=void 0),typeof i=="string")return{roomId:i,eventId:a,viaServers:s}}}var o=this.getStateEvents(j.RoomCreate,"");if(o){var l=o.getContent().predecessor;if(l){var u=l.room_id;if(typeof u=="string"){var d=l.event_id;return(typeof d!="string"||d==="")&&(d=void 0),{roomId:u,eventId:d}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var n=this.getStateEvents(j.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){var i=ta(n),a=this.displayNameToUserIds.get(i);if(a){var s=a.filter(d=>d!==e);this.displayNameToUserIds.set(i,s)}}this.userIdsToDisplayNames[e]=t;var o=t&&ta(t);if(o){var l,u=(l=this.displayNameToUserIds.get(o))!==null&&l!==void 0?l:[];u.push(e),this.displayNameToUserIds.set(o,u)}}}function _S(r,e){var t=new Set;if(_x(r)&&e){var n=e.getSender();n&&t.add(n);var i=e.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(a=>t.add(a))}return t}function bS(r,e,t){if(t.has(r))return 1/0;var n=e.getDirectionalContent(),i=n.users||{};return i[r]!==void 0&&Number.isInteger(i[r])?i[r]:n.users_default!==void 0?n.users_default:0}function wS(r){var e=typeof r=="string"&&!!r&&r!=="undefined"&&r!=="null";return e||typeof r=="number"}class um{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};c(this,"rooms",{}),c(this,"users",{}),c(this,"syncToken",null),c(this,"filters",new Nn(()=>new Map)),c(this,"accountData",new Map),c(this,"localStorage",void 0),c(this,"oobMembers",new Map),c(this,"pendingEvents",{}),c(this,"clientOptions",void 0),c(this,"pendingToDeviceBatches",[]),c(this,"nextToDeviceBatchId",0),c(this,"createUser",void 0),c(this,"onRoomMember",(t,n,i)=>{var a;if(i.membership!==Ie.Invite){var s=this.users[i.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,i.userId));i.name&&(s.setDisplayName(i.name),i.events.member&&s.setRawDisplayName(i.events.member.getDirectionalContent().displayname)),i.events.member&&i.events.member.getContent().avatar_url&&s.setAvatarUrl(i.events.member.getContent().avatar_url),this.users[s.userId]=s}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(Ae.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(Ae.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return((n=this.filters.get(e))===null||n===void 0?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var n=this.localStorage.getItem(t);if(wS(n))return n}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var n="mxjssdk_memory_filter_"+e;try{wS(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var n=!Object.keys(t.getContent()).length;n?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new Nn(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return w(function*(){var n;return(n=t.pendingEvents[e])!==null&&n!==void 0?n:[]})()}setPendingEvents(e,t){var n=this;return w(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return w(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return w(function*(){})()}}var _h={},Ui={},Sa={};Object.defineProperty(Sa,"__esModule",{value:!0});Sa.WidgetApiDirection=void 0;Sa.invertedDirection=bx;var ho=function(r){return r.ToWidget="toWidget",r.FromWidget="fromWidget",r}({});Sa.WidgetApiDirection=ho;function bx(r){if(r===ho.ToWidget)return ho.FromWidget;if(r===ho.FromWidget)return ho.ToWidget;throw new Error("Invalid direction")}var mn={};Object.defineProperty(mn,"__esModule",{value:!0});mn.UnstableApiVersion=mn.MatrixApiVersion=mn.CurrentApiVersions=void 0;var Mv=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});mn.MatrixApiVersion=Mv;var pr=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});mn.UnstableApiVersion=pr;var wx=[Mv.Prerelease1,Mv.Prerelease2,pr.MSC2762,pr.MSC2762_UPDATE_STATE,pr.MSC2871,pr.MSC2873,pr.MSC2931,pr.MSC2974,pr.MSC2876,pr.MSC3819,pr.MSC3846,pr.MSC3869,pr.MSC3973,pr.MSC4039];mn.CurrentApiVersions=wx;var Xs={},TS;function dm(){if(TS)return Xs;TS=1,Object.defineProperty(Xs,"__esModule",{value:!0}),Xs.PostmessageTransport=void 0;var r=nc,e=bc(),t=["message"];function n(E){"@babel/helpers - typeof";return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},n(E)}function i(E,C){if(E==null)return{};var S=a(E,C),x,K;if(Object.getOwnPropertySymbols){var z=Object.getOwnPropertySymbols(E);for(K=0;K<z.length;K++)x=z[K],!(C.indexOf(x)>=0)&&Object.prototype.propertyIsEnumerable.call(E,x)&&(S[x]=E[x])}return S}function a(E,C){if(E==null)return{};var S={},x=Object.keys(E),K,z;for(z=0;z<x.length;z++)K=x[z],!(C.indexOf(K)>=0)&&(S[K]=E[K]);return S}function s(E,C){var S=Object.keys(E);if(Object.getOwnPropertySymbols){var x=Object.getOwnPropertySymbols(E);C&&(x=x.filter(function(K){return Object.getOwnPropertyDescriptor(E,K).enumerable})),S.push.apply(S,x)}return S}function o(E){for(var C=1;C<arguments.length;C++){var S=arguments[C]!=null?arguments[C]:{};C%2?s(Object(S),!0).forEach(function(x){p(E,x,S[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(E,Object.getOwnPropertyDescriptors(S)):s(Object(S)).forEach(function(x){Object.defineProperty(E,x,Object.getOwnPropertyDescriptor(S,x))})}return E}function l(E,C){if(!(E instanceof C))throw new TypeError("Cannot call a class as a function")}function u(E,C){for(var S=0;S<C.length;S++){var x=C[S];x.enumerable=x.enumerable||!1,x.configurable=!0,"value"in x&&(x.writable=!0),Object.defineProperty(E,b(x.key),x)}}function d(E,C,S){return C&&u(E.prototype,C),Object.defineProperty(E,"prototype",{writable:!1}),E}function h(E,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");E.prototype=Object.create(C&&C.prototype,{constructor:{value:E,writable:!0,configurable:!0}}),Object.defineProperty(E,"prototype",{writable:!1}),C&&f(E,C)}function f(E,C){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(x,K){return x.__proto__=K,x},f(E,C)}function m(E){var C=I();return function(){var x=g(E),K;if(C){var z=g(this).constructor;K=Reflect.construct(x,arguments,z)}else K=x.apply(this,arguments);return v(this,K)}}function v(E,C){if(C&&(n(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return y(E)}function y(E){if(E===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return E}function I(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function g(E){return g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(S){return S.__proto__||Object.getPrototypeOf(S)},g(E)}function p(E,C,S){return C=b(C),C in E?Object.defineProperty(E,C,{value:S,enumerable:!0,configurable:!0,writable:!0}):E[C]=S,E}function b(E){var C=R(E,"string");return n(C)==="symbol"?C:String(C)}function R(E,C){if(n(E)!=="object"||E===null)return E;var S=E[Symbol.toPrimitive];if(S!==void 0){var x=S.call(E,C);if(n(x)!=="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(C==="string"?String:Number)(E)}var P=function(E){h(S,E);var C=m(S);function S(x,K,z,oe){var ge;return l(this,S),ge=C.call(this),ge.sendDirection=x,ge.initialWidgetId=K,ge.transportWindow=z,ge.inboundWindow=oe,p(y(ge),"strictOriginCheck",!1),p(y(ge),"targetOrigin","*"),p(y(ge),"timeoutSeconds",10),p(y(ge),"_ready",!1),p(y(ge),"_widgetId",null),p(y(ge),"outboundRequests",new Map),p(y(ge),"stopController",new AbortController),ge._widgetId=K,ge}return d(S,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var K="widgetapi-".concat(Date.now()),z=0,oe=K;this.outboundRequests.has(oe);)oe="".concat(K,"-").concat(z++);return this.outboundRequests.set(oe,null),oe}},{key:"sendInternal",value:function(K){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),K),this.transportWindow.postMessage(K,this.targetOrigin)}},{key:"reply",value:function(K,z){return this.sendInternal(o(o({},K),{},{response:z}))}},{key:"send",value:function(K,z){return this.sendComplete(K,z).then(function(oe){return oe.response})}},{key:"sendComplete",value:function(K,z){var oe=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var ge={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:K,data:z};return K===e.WidgetApiToWidgetAction.UpdateVisibility&&(ge.visible=z.visible),new Promise(function(xe,_e){var Me=function(J){ye(),xe(J)},je=function(J){ye(),_e(J)},re=setTimeout(function(){return je(new Error("Request timed out"))},(oe.timeoutSeconds||1)*1e3),he=function(){return je(new Error("Transport stopped"))};oe.stopController.signal.addEventListener("abort",he);var ye=function(){oe.outboundRequests.delete(ge.requestId),clearTimeout(re),oe.stopController.signal.removeEventListener("abort",he)};oe.outboundRequests.set(ge.requestId,{request:ge,resolve:Me,reject:je}),oe.sendInternal(ge)})}},{key:"start",value:function(){var K=this;this.inboundWindow.addEventListener("message",function(z){K.handleMessage(z)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(K){if(!this.stopController.signal.aborted&&K.data&&!(this.strictOriginCheck&&K.origin!==window.origin)){var z=K.data;if(!(!z.action||!z.requestId||!z.widgetId))if(z.response){if(z.api!==this.sendDirection)return;this.handleResponse(z)}else{var oe=z;if(oe.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(oe)}}}},{key:"handleRequest",value:function(K){if(this.widgetId){if(this.widgetId!==K.widgetId)return}else this._widgetId=K.widgetId;this.emit("message",new CustomEvent("message",{detail:K}))}},{key:"handleResponse",value:function(K){if(K.widgetId===this.widgetId){var z=this.outboundRequests.get(K.requestId);if(z)if((0,e.isErrorResponse)(K.response)){var oe=K.response.error,ge=oe.message,xe=i(oe,t);z.reject(new e.WidgetApiResponseError(ge,xe))}else z.resolve(K)}}}]),S}(r.EventEmitter);return Xs.PostmessageTransport=P,Xs}var Ci={};Object.defineProperty(Ci,"__esModule",{value:!0});Ci.WidgetApiToWidgetAction=Ci.WidgetApiFromWidgetAction=void 0;var Tx=function(r){return r.SupportedApiVersions="supported_api_versions",r.Capabilities="capabilities",r.NotifyCapabilities="notify_capabilities",r.ThemeChange="theme_change",r.LanguageChange="language_change",r.TakeScreenshot="screenshot",r.UpdateVisibility="visibility",r.OpenIDCredentials="openid_credentials",r.WidgetConfig="widget_config",r.CloseModalWidget="close_modal",r.ButtonClicked="button_clicked",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.UpdateState="update_state",r.UpdateTurnServers="update_turn_servers",r}({});Ci.WidgetApiToWidgetAction=Tx;var Rx=function(r){return r.SupportedApiVersions="supported_api_versions",r.ContentLoaded="content_loaded",r.SendSticker="m.sticker",r.UpdateAlwaysOnScreen="set_always_on_screen",r.GetOpenIDCredentials="get_openid",r.CloseModalWidget="close_modal",r.OpenModalWidget="open_modal",r.SetModalButtonEnabled="set_button_enabled",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.WatchTurnServers="watch_turn_servers",r.UnwatchTurnServers="unwatch_turn_servers",r.BeeperReadRoomAccountData="com.beeper.read_room_account_data",r.MSC2876ReadEvents="org.matrix.msc2876.read_events",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",r.MSC3869ReadRelations="org.matrix.msc3869.read_relations",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",r.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",r.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});Ci.WidgetApiFromWidgetAction=Rx;var Ns={};Object.defineProperty(Ns,"__esModule",{value:!0});Ns.OpenIDRequestState=void 0;var Ix=function(r){return r.Allowed="allowed",r.Blocked="blocked",r.PendingUserConfirmation="request",r}({});Ns.OpenIDRequestState=Ix;var Ml={};Object.defineProperty(Ml,"__esModule",{value:!0});Ml.MatrixWidgetType=void 0;var Cx=function(r){return r.Custom="m.custom",r.JitsiMeet="m.jitsi",r.Stickerpicker="m.stickerpicker",r}({});Ml.MatrixWidgetType=Cx;var Al={};Object.defineProperty(Al,"__esModule",{value:!0});Al.BuiltInModalButtonID=void 0;var Ox=function(r){return r.Close="m.close",r}({});Al.BuiltInModalButtonID=Ox;var gn={};Object.defineProperty(gn,"__esModule",{value:!0});gn.WidgetEventCapability=gn.EventKind=gn.EventDirection=void 0;function dl(r){"@babel/helpers - typeof";return dl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},dl(r)}function kx(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=Px(r))||e){t&&(r=t);var n=0,i=function(){};return{s:i,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(u){throw u},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,o;return{s:function(){t=t.call(r)},n:function(){var u=t.next();return a=u.done,u},e:function(u){s=!0,o=u},f:function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw o}}}}function Px(r,e){if(r){if(typeof r=="string")return RS(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return RS(r,e)}}function RS(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function Mx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function IS(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,Dx(n.key),n)}}function Ax(r,e,t){return e&&IS(r.prototype,e),t&&IS(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function Dx(r){var e=xx(r,"string");return dl(e)==="symbol"?e:String(e)}function xx(r,e){if(dl(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(dl(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}var mr=function(r){return r.Event="event",r.State="state_event",r.ToDevice="to_device",r.RoomAccount="room_account",r}({});gn.EventKind=mr;var ei=function(r){return r.Send="send",r.Receive="receive",r}({});gn.EventDirection=ei;var Nx=function(){function r(e,t,n,i,a){Mx(this,r),this.direction=e,this.eventType=t,this.kind=n,this.keyStr=i,this.raw=a}return Ax(r,[{key:"matchesAsStateEvent",value:function(t,n,i){return this.kind!==mr.State||this.direction!==t||this.eventType!==n?!1:this.keyStr===null||this.keyStr===i}},{key:"matchesAsToDeviceEvent",value:function(t,n){return!(this.kind!==mr.ToDevice||this.direction!==t||this.eventType!==n)}},{key:"matchesAsRoomEvent",value:function(t,n){var i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==mr.Event||this.direction!==t||this.eventType!==n)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===i)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(t,n){return!(this.kind!==mr.RoomAccount||this.direction!==t||this.eventType!==n)}}],[{key:"forStateEvent",value:function(t,n,i){n=n.replace(/#/g,"\\#"),i=i!=null?"#".concat(i):"";var a="org.matrix.msc2762.".concat(t,".state_event:").concat(n).concat(i);return r.findEventCapabilities([a])[0]}},{key:"forToDeviceEvent",value:function(t,n){var i="org.matrix.msc3819.".concat(t,".to_device:").concat(n);return r.findEventCapabilities([i])[0]}},{key:"forRoomEvent",value:function(t,n){var i="org.matrix.msc2762.".concat(t,".event:").concat(n);return r.findEventCapabilities([i])[0]}},{key:"forRoomMessageEvent",value:function(t,n){n=n??"";var i="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(n);return r.findEventCapabilities([i])[0]}},{key:"forRoomAccountData",value:function(t,n){var i="com.beeper.capabilities.".concat(t,".room_account_data:").concat(n);return r.findEventCapabilities([i])[0]}},{key:"findEventCapabilities",value:function(t){var n=[],i=kx(t),a;try{for(i.s();!(a=i.n()).done;){var s=a.value,o=null,l=void 0,u=null;if(s.startsWith("org.matrix.msc2762.send.event:")?(o=ei.Send,u=mr.Event,l=s.substring(30)):s.startsWith("org.matrix.msc2762.send.state_event:")?(o=ei.Send,u=mr.State,l=s.substring(36)):s.startsWith("org.matrix.msc3819.send.to_device:")?(o=ei.Send,u=mr.ToDevice,l=s.substring(34)):s.startsWith("org.matrix.msc2762.receive.event:")?(o=ei.Receive,u=mr.Event,l=s.substring(33)):s.startsWith("org.matrix.msc2762.receive.state_event:")?(o=ei.Receive,u=mr.State,l=s.substring(39)):s.startsWith("org.matrix.msc3819.receive.to_device:")?(o=ei.Receive,u=mr.ToDevice,l=s.substring(37)):s.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(o=ei.Receive,u=mr.RoomAccount,l=s.substring(50)),!(o===null||u===null||l===void 0)){var d=l.startsWith("m.room.message#")||u===mr.State,h=null;if(l.includes("#")&&d){var f=l.split("#"),m=f.findIndex(function(v){return!v.endsWith("\\")});l=f.slice(0,m+1).map(function(v){return v.endsWith("\\")?v.substring(0,v.length-1):v}).join("#"),h=f.slice(m+1).join("#")}n.push(new r(o,l,u,h,s))}}}catch(v){i.e(v)}finally{i.f()}return n}}]),r}();gn.WidgetEventCapability=Nx;var Ls={};Object.defineProperty(Ls,"__esModule",{value:!0});Ls.Symbols=void 0;var Lx=function(r){return r.AnyRoom="*",r}({});Ls.Symbols=Lx;var CS;function Ux(){if(CS)return Ui;CS=1;function r(J){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(te){return typeof te}:function(te){return te&&typeof Symbol=="function"&&te.constructor===Symbol&&te!==Symbol.prototype?"symbol":typeof te},r(J)}Object.defineProperty(Ui,"__esModule",{value:!0}),Ui.WidgetApiResponseError=Ui.WidgetApi=void 0;var e=nc,t=Sa,n=mn,i=dm(),a=Ci,s=Ns,o=Ml,l=Al,u=gn,d=Ls;function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=function(){return J};var J={},te=Object.prototype,L=te.hasOwnProperty,D=Object.defineProperty||function(q,Y,B){q[Y]=B.value},A=typeof Symbol=="function"?Symbol:{},M=A.iterator||"@@iterator",k=A.asyncIterator||"@@asyncIterator",U=A.toStringTag||"@@toStringTag";function O(q,Y,B){return Object.defineProperty(q,Y,{value:B,enumerable:!0,configurable:!0,writable:!0}),q[Y]}try{O({},"")}catch{O=function(B,W,H){return B[W]=H}}function F(q,Y,B,W){var H=Y&&Y.prototype instanceof Z?Y:Z,ee=Object.create(H.prototype),ve=new _t(W||[]);return D(ee,"_invoke",{value:X(q,B,ve)}),ee}function N(q,Y,B){try{return{type:"normal",arg:q.call(Y,B)}}catch(W){return{type:"throw",arg:W}}}J.wrap=F;var $={};function Z(){}function fe(){}function ae(){}var Ke={};O(Ke,M,function(){return this});var Ee=Object.getPrototypeOf,ue=Ee&&Ee(Ee(Ue([])));ue&&ue!==te&&L.call(ue,M)&&(Ke=ue);var Fe=ae.prototype=Z.prototype=Object.create(Ke);function Q(q){["next","throw","return"].forEach(function(Y){O(q,Y,function(B){return this._invoke(Y,B)})})}function de(q,Y){function B(H,ee,ve,me){var De=N(q[H],q,ee);if(De.type!=="throw"){var ot=De.arg,lt=ot.value;return lt&&r(lt)=="object"&&L.call(lt,"__await")?Y.resolve(lt.__await).then(function(Yt){B("next",Yt,ve,me)},function(Yt){B("throw",Yt,ve,me)}):Y.resolve(lt).then(function(Yt){ot.value=Yt,ve(ot)},function(Yt){return B("throw",Yt,ve,me)})}me(De.arg)}var W;D(this,"_invoke",{value:function(ee,ve){function me(){return new Y(function(De,ot){B(ee,ve,De,ot)})}return W=W?W.then(me,me):me()}})}function X(q,Y,B){var W="suspendedStart";return function(H,ee){if(W==="executing")throw new Error("Generator is already running");if(W==="completed"){if(H==="throw")throw ee;return Lt()}for(B.method=H,B.arg=ee;;){var ve=B.delegate;if(ve){var me=Ce(ve,B);if(me){if(me===$)continue;return me}}if(B.method==="next")B.sent=B._sent=B.arg;else if(B.method==="throw"){if(W==="suspendedStart")throw W="completed",B.arg;B.dispatchException(B.arg)}else B.method==="return"&&B.abrupt("return",B.arg);W="executing";var De=N(q,Y,B);if(De.type==="normal"){if(W=B.done?"completed":"suspendedYield",De.arg===$)continue;return{value:De.arg,done:B.done}}De.type==="throw"&&(W="completed",B.method="throw",B.arg=De.arg)}}}function Ce(q,Y){var B=Y.method,W=q.iterator[B];if(W===void 0)return Y.delegate=null,B==="throw"&&q.iterator.return&&(Y.method="return",Y.arg=void 0,Ce(q,Y),Y.method==="throw")||B!=="return"&&(Y.method="throw",Y.arg=new TypeError("The iterator does not provide a '"+B+"' method")),$;var H=N(W,q.iterator,Y.arg);if(H.type==="throw")return Y.method="throw",Y.arg=H.arg,Y.delegate=null,$;var ee=H.arg;return ee?ee.done?(Y[q.resultName]=ee.value,Y.next=q.nextLoc,Y.method!=="return"&&(Y.method="next",Y.arg=void 0),Y.delegate=null,$):ee:(Y.method="throw",Y.arg=new TypeError("iterator result is not an object"),Y.delegate=null,$)}function be(q){var Y={tryLoc:q[0]};1 in q&&(Y.catchLoc=q[1]),2 in q&&(Y.finallyLoc=q[2],Y.afterLoc=q[3]),this.tryEntries.push(Y)}function Ge(q){var Y=q.completion||{};Y.type="normal",delete Y.arg,q.completion=Y}function _t(q){this.tryEntries=[{tryLoc:"root"}],q.forEach(be,this),this.reset(!0)}function Ue(q){if(q){var Y=q[M];if(Y)return Y.call(q);if(typeof q.next=="function")return q;if(!isNaN(q.length)){var B=-1,W=function H(){for(;++B<q.length;)if(L.call(q,B))return H.value=q[B],H.done=!1,H;return H.value=void 0,H.done=!0,H};return W.next=W}}return{next:Lt}}function Lt(){return{value:void 0,done:!0}}return fe.prototype=ae,D(Fe,"constructor",{value:ae,configurable:!0}),D(ae,"constructor",{value:fe,configurable:!0}),fe.displayName=O(ae,U,"GeneratorFunction"),J.isGeneratorFunction=function(q){var Y=typeof q=="function"&&q.constructor;return!!Y&&(Y===fe||(Y.displayName||Y.name)==="GeneratorFunction")},J.mark=function(q){return Object.setPrototypeOf?Object.setPrototypeOf(q,ae):(q.__proto__=ae,O(q,U,"GeneratorFunction")),q.prototype=Object.create(Fe),q},J.awrap=function(q){return{__await:q}},Q(de.prototype),O(de.prototype,k,function(){return this}),J.AsyncIterator=de,J.async=function(q,Y,B,W,H){H===void 0&&(H=Promise);var ee=new de(F(q,Y,B,W),H);return J.isGeneratorFunction(Y)?ee:ee.next().then(function(ve){return ve.done?ve.value:ee.next()})},Q(Fe),O(Fe,U,"Generator"),O(Fe,M,function(){return this}),O(Fe,"toString",function(){return"[object Generator]"}),J.keys=function(q){var Y=Object(q),B=[];for(var W in Y)B.push(W);return B.reverse(),function H(){for(;B.length;){var ee=B.pop();if(ee in Y)return H.value=ee,H.done=!1,H}return H.done=!0,H}},J.values=Ue,_t.prototype={constructor:_t,reset:function(Y){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Ge),!Y)for(var B in this)B.charAt(0)==="t"&&L.call(this,B)&&!isNaN(+B.slice(1))&&(this[B]=void 0)},stop:function(){this.done=!0;var Y=this.tryEntries[0].completion;if(Y.type==="throw")throw Y.arg;return this.rval},dispatchException:function(Y){if(this.done)throw Y;var B=this;function W(ot,lt){return ve.type="throw",ve.arg=Y,B.next=ot,lt&&(B.method="next",B.arg=void 0),!!lt}for(var H=this.tryEntries.length-1;H>=0;--H){var ee=this.tryEntries[H],ve=ee.completion;if(ee.tryLoc==="root")return W("end");if(ee.tryLoc<=this.prev){var me=L.call(ee,"catchLoc"),De=L.call(ee,"finallyLoc");if(me&&De){if(this.prev<ee.catchLoc)return W(ee.catchLoc,!0);if(this.prev<ee.finallyLoc)return W(ee.finallyLoc)}else if(me){if(this.prev<ee.catchLoc)return W(ee.catchLoc,!0)}else{if(!De)throw new Error("try statement without catch or finally");if(this.prev<ee.finallyLoc)return W(ee.finallyLoc)}}}},abrupt:function(Y,B){for(var W=this.tryEntries.length-1;W>=0;--W){var H=this.tryEntries[W];if(H.tryLoc<=this.prev&&L.call(H,"finallyLoc")&&this.prev<H.finallyLoc){var ee=H;break}}ee&&(Y==="break"||Y==="continue")&&ee.tryLoc<=B&&B<=ee.finallyLoc&&(ee=null);var ve=ee?ee.completion:{};return ve.type=Y,ve.arg=B,ee?(this.method="next",this.next=ee.finallyLoc,$):this.complete(ve)},complete:function(Y,B){if(Y.type==="throw")throw Y.arg;return Y.type==="break"||Y.type==="continue"?this.next=Y.arg:Y.type==="return"?(this.rval=this.arg=Y.arg,this.method="return",this.next="end"):Y.type==="normal"&&B&&(this.next=B),$},finish:function(Y){for(var B=this.tryEntries.length-1;B>=0;--B){var W=this.tryEntries[B];if(W.finallyLoc===Y)return this.complete(W.completion,W.afterLoc),Ge(W),$}},catch:function(Y){for(var B=this.tryEntries.length-1;B>=0;--B){var W=this.tryEntries[B];if(W.tryLoc===Y){var H=W.completion;if(H.type==="throw"){var ee=H.arg;Ge(W)}return ee}}throw new Error("illegal catch attempt")},delegateYield:function(Y,B,W){return this.delegate={iterator:Ue(Y),resultName:B,nextLoc:W},this.method==="next"&&(this.arg=void 0),$}},J}function f(J,te,L,D,A,M,k){try{var U=J[M](k),O=U.value}catch(F){L(F);return}U.done?te(O):Promise.resolve(O).then(D,A)}function m(J){return function(){var te=this,L=arguments;return new Promise(function(D,A){var M=J.apply(te,L);function k(O){f(M,D,A,k,U,"next",O)}function U(O){f(M,D,A,k,U,"throw",O)}k(void 0)})}}function v(J,te){var L=Object.keys(J);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(J);te&&(D=D.filter(function(A){return Object.getOwnPropertyDescriptor(J,A).enumerable})),L.push.apply(L,D)}return L}function y(J){for(var te=1;te<arguments.length;te++){var L=arguments[te]!=null?arguments[te]:{};te%2?v(Object(L),!0).forEach(function(D){I(J,D,L[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(J,Object.getOwnPropertyDescriptors(L)):v(Object(L)).forEach(function(D){Object.defineProperty(J,D,Object.getOwnPropertyDescriptor(L,D))})}return J}function I(J,te,L){return te=b(te),te in J?Object.defineProperty(J,te,{value:L,enumerable:!0,configurable:!0,writable:!0}):J[te]=L,J}function g(J,te){for(var L=0;L<te.length;L++){var D=te[L];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(J,b(D.key),D)}}function p(J,te,L){return te&&g(J.prototype,te),Object.defineProperty(J,"prototype",{writable:!1}),J}function b(J){var te=R(J,"string");return r(te)==="symbol"?te:String(te)}function R(J,te){if(r(J)!=="object"||J===null)return J;var L=J[Symbol.toPrimitive];if(L!==void 0){var D=L.call(J,te);if(r(D)!=="object")return D;throw new TypeError("@@toPrimitive must return a primitive value.")}return(te==="string"?String:Number)(J)}function P(J,te){if(!(J instanceof te))throw new TypeError("Cannot call a class as a function")}function E(J,te){if(typeof te!="function"&&te!==null)throw new TypeError("Super expression must either be null or a function");J.prototype=Object.create(te&&te.prototype,{constructor:{value:J,writable:!0,configurable:!0}}),Object.defineProperty(J,"prototype",{writable:!1}),te&&xe(J,te)}function C(J){var te=oe();return function(){var D=_e(J),A;if(te){var M=_e(this).constructor;A=Reflect.construct(D,arguments,M)}else A=D.apply(this,arguments);return S(this,A)}}function S(J,te){if(te&&(r(te)==="object"||typeof te=="function"))return te;if(te!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return x(J)}function x(J){if(J===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return J}function K(J){var te=typeof Map=="function"?new Map:void 0;return K=function(D){if(D===null||!ge(D))return D;if(typeof D!="function")throw new TypeError("Super expression must either be null or a function");if(typeof te<"u"){if(te.has(D))return te.get(D);te.set(D,A)}function A(){return z(D,arguments,_e(this).constructor)}return A.prototype=Object.create(D.prototype,{constructor:{value:A,enumerable:!1,writable:!0,configurable:!0}}),xe(A,D)},K(J)}function z(J,te,L){return oe()?z=Reflect.construct.bind():z=function(A,M,k){var U=[null];U.push.apply(U,M);var O=Function.bind.apply(A,U),F=new O;return k&&xe(F,k.prototype),F},z.apply(null,arguments)}function oe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ge(J){return Function.toString.call(J).indexOf("[native code]")!==-1}function xe(J,te){return xe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(D,A){return D.__proto__=A,D},xe(J,te)}function _e(J){return _e=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(L){return L.__proto__||Object.getPrototypeOf(L)},_e(J)}function Me(J){return new he(J,0)}function je(J){return function(){return new re(J.apply(this,arguments))}}function re(J){var te,L;function D(M,k){try{var U=J[M](k),O=U.value,F=O instanceof he;Promise.resolve(F?O.v:O).then(function(N){if(F){var $=M==="return"?"return":"next";if(!O.k||N.done)return D($,N);N=J[$](N).value}A(U.done?"return":"normal",N)},function(N){D("throw",N)})}catch(N){A("throw",N)}}function A(M,k){switch(M){case"return":te.resolve({value:k,done:!0});break;case"throw":te.reject(k);break;default:te.resolve({value:k,done:!1})}(te=te.next)?D(te.key,te.arg):L=null}this._invoke=function(M,k){return new Promise(function(U,O){var F={key:M,arg:k,resolve:U,reject:O,next:null};L?L=L.next=F:(te=L=F,D(M,k))})},typeof J.return!="function"&&(this.return=void 0)}re.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},re.prototype.next=function(J){return this._invoke("next",J)},re.prototype.throw=function(J){return this._invoke("throw",J)},re.prototype.return=function(J){return this._invoke("return",J)};function he(J,te){this.v=J,this.k=te}var ye=function(J){E(L,J);var te=C(L);function L(D,A){var M;return P(this,L),M=te.call(this,D),M.data=A,M}return p(L)}(K(Error));Ui.WidgetApiResponseError=ye,ye.prototype.name=ye.name;var Ne=function(J){E(L,J);var te=C(L);function L(){var D,A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,M=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(P(this,L),D=te.call(this),D.clientOrigin=M,I(x(D),"transport",void 0),I(x(D),"capabilitiesFinished",!1),I(x(D),"supportsMSC2974Renegotiate",!1),I(x(D),"requestedCapabilities",[]),I(x(D),"approvedCapabilities",void 0),I(x(D),"cachedClientVersions",void 0),I(x(D),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return D.transport=new i.PostmessageTransport(t.WidgetApiDirection.FromWidget,A,window.parent,window),D.transport.targetOrigin=M,D.transport.on("message",D.handleMessage.bind(x(D))),D}return p(L,[{key:"hasCapability",value:function(A){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(A):this.requestedCapabilities.includes(A)}},{key:"requestCapability",value:function(A){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(A)}},{key:"requestCapabilities",value:function(A){var M=this;A.forEach(function(k){return M.requestCapability(k)})}},{key:"requestCapabilityForRoomTimeline",value:function(A){this.requestCapability("org.matrix.msc2762.timeline:".concat(A))}},{key:"requestCapabilityToSendState",value:function(A,M){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Send,A,M).raw)}},{key:"requestCapabilityToReceiveState",value:function(A,M){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Receive,A,M).raw)}},{key:"requestCapabilityToSendToDevice",value:function(A){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(A){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToSendEvent",value:function(A){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(A){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToSendMessage",value:function(A){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(A){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(A){this.requestCapability(u.WidgetEventCapability.forRoomAccountData(u.EventDirection.Receive,A).raw)}},{key:"requestOpenIDConnectToken",value:function(){var A=this;return new Promise(function(M,k){A.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(U){var O=U.response;if(O.state===s.OpenIDRequestState.Allowed)M(O);else if(O.state===s.OpenIDRequestState.Blocked)k(new Error("User declined to verify their identity"));else if(O.state===s.OpenIDRequestState.PendingUserConfirmation){var F=function N($){$.preventDefault();var Z=$.detail;Z.data.original_request_id===U.requestId&&(Z.data.state===s.OpenIDRequestState.Allowed?(M(Z.data),A.transport.reply(Z,{})):Z.data.state===s.OpenIDRequestState.Blocked?(k(new Error("User declined to verify their identity")),A.transport.reply(Z,{})):(k(new Error("Invalid state on reply: "+O.state)),A.transport.reply(Z,{error:{message:"Invalid state"}})),A.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),N))};A.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),F)}else k(new Error("Invalid state: "+O.state))}).catch(k)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(A){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,A).then()}},{key:"setAlwaysOnScreen",value:function(A){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:A}).then(function(M){return M.success})}},{key:"openModalWidget",value:function(A,M){var k=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],U=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},O=arguments.length>4&&arguments[4]!==void 0?arguments[4]:o.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:O,url:A,name:M,buttons:k,data:U}).then()}},{key:"closeModalWidget",value:function(){var A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,A).then()}},{key:"sendRoomEvent",value:function(A,M,k,U,O){return this.sendEvent(A,void 0,M,k,U,O)}},{key:"sendStateEvent",value:function(A,M,k,U,O,F){return this.sendEvent(A,M,k,U,O,F)}},{key:"sendEvent",value:function(A,M,k,U,O,F){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,y(y(y(y({type:A,content:k},M!==void 0&&{state_key:M}),U!==void 0&&{room_id:U}),O!==void 0&&{delay:O}),F!==void 0&&{parent_delay_id:F}))}},{key:"updateDelayedEvent",value:function(A,M){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:A,action:M})}},{key:"sendToDevice",value:function(A,M,k){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:A,encrypted:M,messages:k})}},{key:"readRoomAccountData",value:function(A,M){var k={type:A};return M&&(M.includes(d.Symbols.AnyRoom)?k.room_ids=d.Symbols.AnyRoom:k.room_ids=M),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,k).then(function(U){return U.events})}},{key:"readRoomEvents",value:function(A,M,k,U,O){var F={type:A,msgtype:k};return M!==void 0&&(F.limit=M),U&&(U.includes(d.Symbols.AnyRoom)?F.room_ids=d.Symbols.AnyRoom:F.room_ids=U),O&&(F.since=O),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,F).then(function(N){return N.events})}},{key:"readEventRelations",value:function(){var D=m(h().mark(function M(k,U,O,F,N,$,Z,fe){var ae,Ke;return h().wrap(function(ue){for(;;)switch(ue.prev=ue.next){case 0:return ue.next=2,this.getClientVersions();case 2:if(ae=ue.sent,ae.includes(n.UnstableApiVersion.MSC3869)){ue.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return Ke={event_id:k,rel_type:O,event_type:F,room_id:U,to:Z,from:$,limit:N,direction:fe},ue.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,Ke));case 7:case"end":return ue.stop()}},M,this)}));function A(M,k,U,O,F,N,$,Z){return D.apply(this,arguments)}return A}()},{key:"readStateEvents",value:function(A,M,k,U){var O={type:A,state_key:k===void 0?!0:k};return M!==void 0&&(O.limit=M),U&&(U.includes(d.Symbols.AnyRoom)?O.room_ids=d.Symbols.AnyRoom:O.room_ids=U),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,O).then(function(F){return F.events})}},{key:"setModalButtonEnabled",value:function(A,M){if(A===l.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:A,enabled:M}).then()}},{key:"navigateTo",value:function(A){if(!A||!A.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:A}).then()}},{key:"getTurnServers",value:function(){var A=this;return je(h().mark(function M(){var k,U;return h().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:if(U=function(){var N=m(h().mark(function $(Z){return h().wrap(function(ae){for(;;)switch(ae.prev=ae.next){case 0:return Z.preventDefault(),k(Z.detail.data),ae.next=4,A.transport.reply(Z.detail,{});case 4:case"end":return ae.stop()}},$)}));return function(Z){return N.apply(this,arguments)}}(),A.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),A.turnServerWatchers!==0){F.next=12;break}return F.prev=3,F.next=6,Me(A.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:F.next=12;break;case 8:throw F.prev=8,F.t0=F.catch(3),A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),F.t0;case 12:A.turnServerWatchers++,F.prev=13;case 14:return F.next=17,Me(new Promise(function(N){return k=N}));case 17:return F.next=19,F.sent;case 19:F.next=14;break;case 21:if(F.prev=21,A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),A.turnServerWatchers--,A.turnServerWatchers!==0){F.next=27;break}return F.next=27,Me(A.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return F.finish(21);case 28:case"end":return F.stop()}},M,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var D=m(h().mark(function M(k,U){var O,F;return h().wrap(function($){for(;;)switch($.prev=$.next){case 0:return $.next=2,this.getClientVersions();case 2:if(O=$.sent,O.includes(n.UnstableApiVersion.MSC3973)){$.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return F={search_term:k,limit:U},$.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,F));case 7:case"end":return $.stop()}},M,this)}));function A(M,k){return D.apply(this,arguments)}return A}()},{key:"getMediaConfig",value:function(){var D=m(h().mark(function M(){var k,U;return h().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:return F.next=2,this.getClientVersions();case 2:if(k=F.sent,k.includes(n.UnstableApiVersion.MSC4039)){F.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return U={},F.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,U));case 7:case"end":return F.stop()}},M,this)}));function A(){return D.apply(this,arguments)}return A}()},{key:"uploadFile",value:function(){var D=m(h().mark(function M(k){var U,O;return h().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:return N.next=2,this.getClientVersions();case 2:if(U=N.sent,U.includes(n.UnstableApiVersion.MSC4039)){N.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return O={file:k},N.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,O));case 7:case"end":return N.stop()}},M,this)}));function A(M){return D.apply(this,arguments)}return A}()},{key:"downloadFile",value:function(){var D=m(h().mark(function M(k){var U,O;return h().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:return N.next=2,this.getClientVersions();case 2:if(U=N.sent,U.includes(n.UnstableApiVersion.MSC4039)){N.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return O={content_uri:k},N.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,O));case 7:case"end":return N.stop()}},M,this)}));function A(M){return D.apply(this,arguments)}return A}()},{key:"start",value:function(){var A=this;this.transport.start(),this.getClientVersions().then(function(M){M.includes(n.UnstableApiVersion.MSC2974)&&(A.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(A){var M=new CustomEvent("action:".concat(A.detail.action),{detail:A.detail,cancelable:!0});if(this.emit("action:".concat(A.detail.action),M),!M.defaultPrevented)switch(A.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(A.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(A.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(A.detail,{});case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(A.detail,{});default:return this.transport.reply(A.detail,{error:{message:"Unknown or unsupported action: "+A.detail.action}})}}},{key:"replyVersions",value:function(A){this.transport.reply(A,{supported_versions:n.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var A=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(M){return A.cachedClientVersions=M.supported_versions,M.supported_versions}).catch(function(M){return console.warn("non-fatal error getting supported client versions: ",M),[]})}},{key:"handleCapabilities",value:function(A){var M=this;return this.capabilitiesFinished?this.transport.reply(A,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(k){return k.includes(n.UnstableApiVersion.MSC2871)?M.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(U){M.approvedCapabilities=U.detail.data.approved,M.emit("ready")}):M.emit("ready"),M.capabilitiesFinished=!0,M.transport.reply(A,{capabilities:M.requestedCapabilities})})}}]),L}(e.EventEmitter);return Ui.WidgetApi=Ne,Ui}var Zs={},Nr={};Object.defineProperty(Nr,"__esModule",{value:!0});Nr.VideoConferenceCapabilities=Nr.StickerpickerCapabilities=Nr.MatrixCapabilities=void 0;Nr.getTimelineRoomIDFromCapability=Wx;Nr.isTimelineCapability=Bx;Nr.isTimelineCapabilityFor=$x;var cm=function(r){return r.Screenshots="m.capability.screenshot",r.StickerSending="m.sticker",r.AlwaysOnScreen="m.always_on_screen",r.RequiresClient="io.element.requires_client",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC3846TurnServers="town.robin.msc3846.turn_servers",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039UploadFile="org.matrix.msc4039.upload_file",r.MSC4039DownloadFile="org.matrix.msc4039.download_file",r.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});Nr.MatrixCapabilities=cm;var jx=[cm.StickerSending];Nr.StickerpickerCapabilities=jx;var Fx=[cm.AlwaysOnScreen];Nr.VideoConferenceCapabilities=Fx;function Bx(r){return r==null?void 0:r.startsWith("org.matrix.msc2762.timeline:")}function $x(r,e){return r==="org.matrix.msc2762.timeline:".concat(e)}function Wx(r){return r.substring(r.indexOf(":")+1)}var Dl={};Object.defineProperty(Dl,"__esModule",{value:!0});Dl.SimpleObservable=void 0;function cl(r){"@babel/helpers - typeof";return cl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},cl(r)}function Kx(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=Vx(r))||e){t&&(r=t);var n=0,i=function(){};return{s:i,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(u){throw u},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,o;return{s:function(){t=t.call(r)},n:function(){var u=t.next();return a=u.done,u},e:function(u){s=!0,o=u},f:function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw o}}}}function Vx(r,e){if(r){if(typeof r=="string")return OS(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return OS(r,e)}}function OS(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function Gx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function qx(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,fw(n.key),n)}}function Hx(r,e,t){return e&&qx(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function zx(r,e,t){return e=fw(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function fw(r){var e=Jx(r,"string");return cl(e)==="symbol"?e:String(e)}function Jx(r,e){if(cl(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(cl(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}var Yx=function(){function r(e){Gx(this,r),zx(this,"listeners",[]),e&&this.listeners.push(e)}return Hx(r,[{key:"onUpdate",value:function(t){this.listeners.push(t)}},{key:"update",value:function(t){var n=Kx(this.listeners),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;a(t)}}catch(s){n.e(s)}finally{n.f()}}},{key:"close",value:function(){this.listeners=[]}}]),r}();Dl.SimpleObservable=Yx;var xl={};Object.defineProperty(xl,"__esModule",{value:!0});xl.UpdateDelayedEventAction=void 0;var Qx=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({});xl.UpdateDelayedEventAction=Qx;var kS;function Xx(){if(kS)return Zs;kS=1,Object.defineProperty(Zs,"__esModule",{value:!0}),Zs.ClientWidgetApi=void 0;var r=nc,e=dm(),t=Sa,n=Ci,i=Nr,a=mn,s=gn,o=Ns,l=Dl,u=Ls,d=xl;function h(L){"@babel/helpers - typeof";return h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},h(L)}function f(L,D){var A=Object.keys(L);if(Object.getOwnPropertySymbols){var M=Object.getOwnPropertySymbols(L);D&&(M=M.filter(function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable})),A.push.apply(A,M)}return A}function m(L){for(var D=1;D<arguments.length;D++){var A=arguments[D]!=null?arguments[D]:{};D%2?f(Object(A),!0).forEach(function(M){re(L,M,A[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(A)):f(Object(A)).forEach(function(M){Object.defineProperty(L,M,Object.getOwnPropertyDescriptor(A,M))})}return L}function v(L,D){var A=typeof Symbol<"u"&&L[Symbol.iterator]||L["@@iterator"];if(!A){if(Array.isArray(L)||(A=g(L))||D){A&&(L=A);var M=0,k=function(){};return{s:k,n:function(){return M>=L.length?{done:!0}:{done:!1,value:L[M++]}},e:function($){throw $},f:k}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var U=!0,O=!1,F;return{s:function(){A=A.call(L)},n:function(){var $=A.next();return U=$.done,$},e:function($){O=!0,F=$},f:function(){try{!U&&A.return!=null&&A.return()}finally{if(O)throw F}}}}function y(L){return b(L)||p(L)||g(L)||I()}function I(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function g(L,D){if(L){if(typeof L=="string")return R(L,D);var A=Object.prototype.toString.call(L).slice(8,-1);if(A==="Object"&&L.constructor&&(A=L.constructor.name),A==="Map"||A==="Set")return Array.from(L);if(A==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(A))return R(L,D)}}function p(L){if(typeof Symbol<"u"&&L[Symbol.iterator]!=null||L["@@iterator"]!=null)return Array.from(L)}function b(L){if(Array.isArray(L))return R(L)}function R(L,D){(D==null||D>L.length)&&(D=L.length);for(var A=0,M=new Array(D);A<D;A++)M[A]=L[A];return M}function P(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */P=function(){return L};var L={},D=Object.prototype,A=D.hasOwnProperty,M=Object.defineProperty||function(B,W,H){B[W]=H.value},k=typeof Symbol=="function"?Symbol:{},U=k.iterator||"@@iterator",O=k.asyncIterator||"@@asyncIterator",F=k.toStringTag||"@@toStringTag";function N(B,W,H){return Object.defineProperty(B,W,{value:H,enumerable:!0,configurable:!0,writable:!0}),B[W]}try{N({},"")}catch{N=function(H,ee,ve){return H[ee]=ve}}function $(B,W,H,ee){var ve=W&&W.prototype instanceof ae?W:ae,me=Object.create(ve.prototype),De=new Lt(ee||[]);return M(me,"_invoke",{value:be(B,H,De)}),me}function Z(B,W,H){try{return{type:"normal",arg:B.call(W,H)}}catch(ee){return{type:"throw",arg:ee}}}L.wrap=$;var fe={};function ae(){}function Ke(){}function Ee(){}var ue={};N(ue,U,function(){return this});var Fe=Object.getPrototypeOf,Q=Fe&&Fe(Fe(q([])));Q&&Q!==D&&A.call(Q,U)&&(ue=Q);var de=Ee.prototype=ae.prototype=Object.create(ue);function X(B){["next","throw","return"].forEach(function(W){N(B,W,function(H){return this._invoke(W,H)})})}function Ce(B,W){function H(ve,me,De,ot){var lt=Z(B[ve],B,me);if(lt.type!=="throw"){var Yt=lt.arg,Gn=Yt.value;return Gn&&h(Gn)=="object"&&A.call(Gn,"__await")?W.resolve(Gn.__await).then(function(Di){H("next",Di,De,ot)},function(Di){H("throw",Di,De,ot)}):W.resolve(Gn).then(function(Di){Yt.value=Di,De(Yt)},function(Di){return H("throw",Di,De,ot)})}ot(lt.arg)}var ee;M(this,"_invoke",{value:function(me,De){function ot(){return new W(function(lt,Yt){H(me,De,lt,Yt)})}return ee=ee?ee.then(ot,ot):ot()}})}function be(B,W,H){var ee="suspendedStart";return function(ve,me){if(ee==="executing")throw new Error("Generator is already running");if(ee==="completed"){if(ve==="throw")throw me;return Y()}for(H.method=ve,H.arg=me;;){var De=H.delegate;if(De){var ot=Ge(De,H);if(ot){if(ot===fe)continue;return ot}}if(H.method==="next")H.sent=H._sent=H.arg;else if(H.method==="throw"){if(ee==="suspendedStart")throw ee="completed",H.arg;H.dispatchException(H.arg)}else H.method==="return"&&H.abrupt("return",H.arg);ee="executing";var lt=Z(B,W,H);if(lt.type==="normal"){if(ee=H.done?"completed":"suspendedYield",lt.arg===fe)continue;return{value:lt.arg,done:H.done}}lt.type==="throw"&&(ee="completed",H.method="throw",H.arg=lt.arg)}}}function Ge(B,W){var H=W.method,ee=B.iterator[H];if(ee===void 0)return W.delegate=null,H==="throw"&&B.iterator.return&&(W.method="return",W.arg=void 0,Ge(B,W),W.method==="throw")||H!=="return"&&(W.method="throw",W.arg=new TypeError("The iterator does not provide a '"+H+"' method")),fe;var ve=Z(ee,B.iterator,W.arg);if(ve.type==="throw")return W.method="throw",W.arg=ve.arg,W.delegate=null,fe;var me=ve.arg;return me?me.done?(W[B.resultName]=me.value,W.next=B.nextLoc,W.method!=="return"&&(W.method="next",W.arg=void 0),W.delegate=null,fe):me:(W.method="throw",W.arg=new TypeError("iterator result is not an object"),W.delegate=null,fe)}function _t(B){var W={tryLoc:B[0]};1 in B&&(W.catchLoc=B[1]),2 in B&&(W.finallyLoc=B[2],W.afterLoc=B[3]),this.tryEntries.push(W)}function Ue(B){var W=B.completion||{};W.type="normal",delete W.arg,B.completion=W}function Lt(B){this.tryEntries=[{tryLoc:"root"}],B.forEach(_t,this),this.reset(!0)}function q(B){if(B){var W=B[U];if(W)return W.call(B);if(typeof B.next=="function")return B;if(!isNaN(B.length)){var H=-1,ee=function ve(){for(;++H<B.length;)if(A.call(B,H))return ve.value=B[H],ve.done=!1,ve;return ve.value=void 0,ve.done=!0,ve};return ee.next=ee}}return{next:Y}}function Y(){return{value:void 0,done:!0}}return Ke.prototype=Ee,M(de,"constructor",{value:Ee,configurable:!0}),M(Ee,"constructor",{value:Ke,configurable:!0}),Ke.displayName=N(Ee,F,"GeneratorFunction"),L.isGeneratorFunction=function(B){var W=typeof B=="function"&&B.constructor;return!!W&&(W===Ke||(W.displayName||W.name)==="GeneratorFunction")},L.mark=function(B){return Object.setPrototypeOf?Object.setPrototypeOf(B,Ee):(B.__proto__=Ee,N(B,F,"GeneratorFunction")),B.prototype=Object.create(de),B},L.awrap=function(B){return{__await:B}},X(Ce.prototype),N(Ce.prototype,O,function(){return this}),L.AsyncIterator=Ce,L.async=function(B,W,H,ee,ve){ve===void 0&&(ve=Promise);var me=new Ce($(B,W,H,ee),ve);return L.isGeneratorFunction(W)?me:me.next().then(function(De){return De.done?De.value:me.next()})},X(de),N(de,F,"Generator"),N(de,U,function(){return this}),N(de,"toString",function(){return"[object Generator]"}),L.keys=function(B){var W=Object(B),H=[];for(var ee in W)H.push(ee);return H.reverse(),function ve(){for(;H.length;){var me=H.pop();if(me in W)return ve.value=me,ve.done=!1,ve}return ve.done=!0,ve}},L.values=q,Lt.prototype={constructor:Lt,reset:function(W){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Ue),!W)for(var H in this)H.charAt(0)==="t"&&A.call(this,H)&&!isNaN(+H.slice(1))&&(this[H]=void 0)},stop:function(){this.done=!0;var W=this.tryEntries[0].completion;if(W.type==="throw")throw W.arg;return this.rval},dispatchException:function(W){if(this.done)throw W;var H=this;function ee(Yt,Gn){return De.type="throw",De.arg=W,H.next=Yt,Gn&&(H.method="next",H.arg=void 0),!!Gn}for(var ve=this.tryEntries.length-1;ve>=0;--ve){var me=this.tryEntries[ve],De=me.completion;if(me.tryLoc==="root")return ee("end");if(me.tryLoc<=this.prev){var ot=A.call(me,"catchLoc"),lt=A.call(me,"finallyLoc");if(ot&&lt){if(this.prev<me.catchLoc)return ee(me.catchLoc,!0);if(this.prev<me.finallyLoc)return ee(me.finallyLoc)}else if(ot){if(this.prev<me.catchLoc)return ee(me.catchLoc,!0)}else{if(!lt)throw new Error("try statement without catch or finally");if(this.prev<me.finallyLoc)return ee(me.finallyLoc)}}}},abrupt:function(W,H){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var ve=this.tryEntries[ee];if(ve.tryLoc<=this.prev&&A.call(ve,"finallyLoc")&&this.prev<ve.finallyLoc){var me=ve;break}}me&&(W==="break"||W==="continue")&&me.tryLoc<=H&&H<=me.finallyLoc&&(me=null);var De=me?me.completion:{};return De.type=W,De.arg=H,me?(this.method="next",this.next=me.finallyLoc,fe):this.complete(De)},complete:function(W,H){if(W.type==="throw")throw W.arg;return W.type==="break"||W.type==="continue"?this.next=W.arg:W.type==="return"?(this.rval=this.arg=W.arg,this.method="return",this.next="end"):W.type==="normal"&&H&&(this.next=H),fe},finish:function(W){for(var H=this.tryEntries.length-1;H>=0;--H){var ee=this.tryEntries[H];if(ee.finallyLoc===W)return this.complete(ee.completion,ee.afterLoc),Ue(ee),fe}},catch:function(W){for(var H=this.tryEntries.length-1;H>=0;--H){var ee=this.tryEntries[H];if(ee.tryLoc===W){var ve=ee.completion;if(ve.type==="throw"){var me=ve.arg;Ue(ee)}return me}}throw new Error("illegal catch attempt")},delegateYield:function(W,H,ee){return this.delegate={iterator:q(W),resultName:H,nextLoc:ee},this.method==="next"&&(this.arg=void 0),fe}},L}function E(L,D,A,M,k,U,O){try{var F=L[U](O),N=F.value}catch($){A($);return}F.done?D(N):Promise.resolve(N).then(M,k)}function C(L){return function(){var D=this,A=arguments;return new Promise(function(M,k){var U=L.apply(D,A);function O(N){E(U,M,k,O,F,"next",N)}function F(N){E(U,M,k,O,F,"throw",N)}O(void 0)})}}function S(L,D){if(!(L instanceof D))throw new TypeError("Cannot call a class as a function")}function x(L,D){for(var A=0;A<D.length;A++){var M=D[A];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(L,he(M.key),M)}}function K(L,D,A){return D&&x(L.prototype,D),Object.defineProperty(L,"prototype",{writable:!1}),L}function z(L,D){if(typeof D!="function"&&D!==null)throw new TypeError("Super expression must either be null or a function");L.prototype=Object.create(D&&D.prototype,{constructor:{value:L,writable:!0,configurable:!0}}),Object.defineProperty(L,"prototype",{writable:!1}),D&&oe(L,D)}function oe(L,D){return oe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(M,k){return M.__proto__=k,M},oe(L,D)}function ge(L){var D=Me();return function(){var M=je(L),k;if(D){var U=je(this).constructor;k=Reflect.construct(M,arguments,U)}else k=M.apply(this,arguments);return xe(this,k)}}function xe(L,D){if(D&&(h(D)==="object"||typeof D=="function"))return D;if(D!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _e(L)}function _e(L){if(L===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return L}function Me(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function je(L){return je=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(A){return A.__proto__||Object.getPrototypeOf(A)},je(L)}function re(L,D,A){return D=he(D),D in L?Object.defineProperty(L,D,{value:A,enumerable:!0,configurable:!0,writable:!0}):L[D]=A,L}function he(L){var D=ye(L,"string");return h(D)==="symbol"?D:String(D)}function ye(L,D){if(h(L)!=="object"||L===null)return L;var A=L[Symbol.toPrimitive];if(A!==void 0){var M=A.call(L,D);if(h(M)!=="object")return M;throw new TypeError("@@toPrimitive must return a primitive value.")}return(D==="string"?String:Number)(L)}function Ne(L){var D,A,M,k=2;for(typeof Symbol<"u"&&(A=Symbol.asyncIterator,M=Symbol.iterator);k--;){if(A&&(D=L[A])!=null)return D.call(L);if(M&&(D=L[M])!=null)return new J(D.call(L));A="@@asyncIterator",M="@@iterator"}throw new TypeError("Object is not async iterable")}function J(L){function D(A){if(Object(A)!==A)return Promise.reject(new TypeError(A+" is not an object."));var M=A.done;return Promise.resolve(A.value).then(function(k){return{value:k,done:M}})}return J=function(M){this.s=M,this.n=M.next},J.prototype={s:null,n:null,next:function(){return D(this.n.apply(this.s,arguments))},return:function(M){var k=this.s.return;return k===void 0?Promise.resolve({value:M,done:!0}):D(k.apply(this.s,arguments))},throw:function(M){var k=this.s.return;return k===void 0?Promise.reject(M):D(k.apply(this.s,arguments))}},new J(L)}var te=function(L){z(A,L);var D=ge(A);function A(M,k,U){var O;if(S(this,A),O=D.call(this),O.widget=M,O.iframe=k,O.driver=U,re(_e(O),"transport",void 0),re(_e(O),"cachedWidgetVersions",null),re(_e(O),"contentLoadedActionSent",!1),re(_e(O),"allowedCapabilities",new Set),re(_e(O),"allowedEvents",[]),re(_e(O),"isStopped",!1),re(_e(O),"turnServers",null),re(_e(O),"contentLoadedWaitTimer",void 0),re(_e(O),"pushRoomStateTasks",new Set),re(_e(O),"pushRoomStateResult",new Map),re(_e(O),"flushRoomStateTask",null),re(_e(O),"viewedRoomId",null),!(k!=null&&k.contentWindow))throw new Error("No iframe supplied");if(!M)throw new Error("Invalid widget");if(!U)throw new Error("Invalid driver");return O.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,M.id,k.contentWindow,window),O.transport.targetOrigin=M.origin,O.transport.on("message",O.handleMessage.bind(_e(O))),k.addEventListener("load",O.onIframeLoad.bind(_e(O))),O.transport.start(),O}return K(A,[{key:"hasCapability",value:function(k){return this.allowedCapabilities.has(k)}},{key:"canUseRoomTimeline",value:function(k){return this.hasCapability("org.matrix.msc2762.timeline:".concat(u.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(k))}},{key:"canSendRoomEvent",value:function(k){var U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(O){return O.matchesAsRoomEvent(s.EventDirection.Send,k,U)})}},{key:"canSendStateEvent",value:function(k,U){return this.allowedEvents.some(function(O){return O.matchesAsStateEvent(s.EventDirection.Send,k,U)})}},{key:"canSendToDeviceEvent",value:function(k){return this.allowedEvents.some(function(U){return U.matchesAsToDeviceEvent(s.EventDirection.Send,k)})}},{key:"canReceiveRoomEvent",value:function(k){var U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(O){return O.matchesAsRoomEvent(s.EventDirection.Receive,k,U)})}},{key:"canReceiveStateEvent",value:function(k,U){return this.allowedEvents.some(function(O){return O.matchesAsStateEvent(s.EventDirection.Receive,k,U)})}},{key:"canReceiveToDeviceEvent",value:function(k){return this.allowedEvents.some(function(U){return U.matchesAsToDeviceEvent(s.EventDirection.Receive,k)})}},{key:"canReceiveRoomAccountData",value:function(k){return this.allowedEvents.some(function(U){return U.matchesAsRoomAccountData(s.EventDirection.Receive,k)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:function(){var M=C(P().mark(function U(){var O;return P().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){N.next=2;break}return N.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return N.prev=2,N.next=5,this.transport.send(n.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return O=N.sent,this.cachedWidgetVersions=O.supported_versions,N.abrupt("return",O.supported_versions);case 10:return N.prev=10,N.t0=N.catch(2),console.warn("non-fatal error getting supported widget versions: ",N.t0),N.abrupt("return",[]);case 14:case"end":return N.stop()}},U,this,[[2,10]])}));function k(){return M.apply(this,arguments)}return k}()},{key:"beginCapabilities",value:function(){var k=this;this.emit("preparing");var U;this.transport.send(n.WidgetApiToWidgetAction.Capabilities,{}).then(function(O){return U=O.capabilities,k.driver.validateCapabilities(new Set(O.capabilities))}).then(function(O){k.allowCapabilities(y(O),U),k.emit("ready")}).catch(function(O){k.emit("error:preparing",O)})}},{key:"allowCapabilities",value:function(k,U){var O,F=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),k);var N=v(k),$;try{for(N.s();!($=N.n()).done;){var Z=$.value;this.allowedCapabilities.add(Z)}}catch(X){N.e(X)}finally{N.f()}var fe=s.WidgetEventCapability.findEventCapabilities(k);(O=this.allowedEvents).push.apply(O,y(fe)),this.transport.send(n.WidgetApiToWidgetAction.NotifyCapabilities,{requested:U,approved:Array.from(this.allowedCapabilities)}).catch(function(X){console.warn("non-fatal error notifying widget of approved capabilities:",X)}).then(function(){F.emit("capabilitiesNotified")});var ae=v(k),Ke;try{for(ae.s();!(Ke=ae.n()).done;){var Ee=Ke.value;if((0,i.isTimelineCapability)(Ee)){var ue=(0,i.getTimelineRoomIDFromCapability)(Ee);if(ue===u.Symbols.AnyRoom){var Fe=v(this.driver.getKnownRooms()),Q;try{for(Fe.s();!(Q=Fe.n()).done;){var de=Q.value;this.pushRoomState(de)}}catch(X){Fe.e(X)}finally{Fe.f()}}else this.pushRoomState(ue)}}}catch(X){ae.e(X)}finally{ae.f()}fe.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(k){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(k){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(k,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(k,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(k){this.transport.reply(k,{supported_versions:a.CurrentApiVersions})}},{key:"supportsUpdateState",value:function(){var M=C(P().mark(function U(){return P().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:return F.next=2,this.getWidgetVersions();case 2:return F.abrupt("return",F.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return F.stop()}},U,this)}));function k(){return M.apply(this,arguments)}return k}()},{key:"handleCapabilitiesRenegotiate",value:function(k){var U,O=this;this.transport.reply(k,{});var F=((U=k.data)===null||U===void 0?void 0:U.capabilities)||[],N=new Set(F.filter(function($){return!O.hasCapability($)}));N.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(N).then(function($){return O.allowCapabilities(y($),y(N))})}},{key:"handleNavigate",value:function(k){var U,O,F=this;if(!this.hasCapability(i.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(k,{error:{message:"Missing capability"}});if(!((U=k.data)!==null&&U!==void 0&&U.uri)||!((O=k.data)!==null&&O!==void 0&&O.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(k,{error:{message:"Invalid matrix.to URI"}});var N=function(Z){console.error("[ClientWidgetApi] Failed to handle navigation: ",Z),F.handleDriverError(Z,k,"Error handling navigation")};try{this.driver.navigate(k.data.uri.toString()).catch(function($){return N($)}).then(function(){return F.transport.reply(k,{})})}catch($){return N($)}}},{key:"handleOIDC",value:function(k){var U=this,O=1,F=function(fe,ae){return ae=ae||{},O>1?U.transport.send(n.WidgetApiToWidgetAction.OpenIDCredentials,m({state:fe,original_request_id:k.requestId},ae)):U.transport.reply(k,m({state:fe},ae))},N=function(fe){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",fe),O>1?F(o.OpenIDRequestState.Blocked):U.transport.reply(k,{error:{message:fe}})},$=new l.SimpleObservable(function(Z){if(Z.state===o.OpenIDRequestState.PendingUserConfirmation&&O>1)return $.close(),N("client provided out-of-phase response to OIDC flow");if(Z.state===o.OpenIDRequestState.PendingUserConfirmation){F(Z.state),O++;return}return Z.state===o.OpenIDRequestState.Allowed&&!Z.token?N("client provided invalid OIDC token for an allowed request"):(Z.state===o.OpenIDRequestState.Blocked&&(Z.token=void 0),$.close(),F(Z.state,Z.token))});this.driver.askOpenID($)}},{key:"handleReadRoomAccountData",value:function(k){var U=this,O=Promise.resolve([]);return O=this.driver.readRoomAccountData(k.data.type),this.canReceiveRoomAccountData(k.data.type)?O.then(function(F){U.transport.reply(k,{events:F})}):this.transport.reply(k,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(){var M=C(P().mark(function U(O){var F=this,N,$,Z,fe,ae,Ke,Ee,ue,Fe,Q;return P().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:if(O.data.type){X.next=2;break}return X.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(O.data.limit!==void 0&&(!O.data.limit||O.data.limit<0))){X.next=4;break}return X.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 4:if(O.data.room_ids!==void 0){X.next=8;break}N=this.viewedRoomId===null?[]:[this.viewedRoomId],X.next=30;break;case 8:if(O.data.room_ids!==u.Symbols.AnyRoom){X.next=12;break}N=this.driver.getKnownRooms().filter(function(Ce){return F.canUseRoomTimeline(Ce)}),X.next=30;break;case 12:N=O.data.room_ids,$=v(N),X.prev=14,$.s();case 16:if((Z=$.n()).done){X.next=22;break}if(fe=Z.value,this.canUseRoomTimeline(fe)){X.next=20;break}return X.abrupt("return",this.transport.reply(O,{error:{message:"Unable to access room timeline: ".concat(fe)}}));case 20:X.next=16;break;case 22:X.next=27;break;case 24:X.prev=24,X.t0=X.catch(14),$.e(X.t0);case 27:return X.prev=27,$.f(),X.finish(27);case 30:if(ae=O.data.limit||0,Ke=O.data.since,Ee=void 0,ue=void 0,O.data.state_key===void 0){X.next=40;break}if(Ee=O.data.state_key===!0?void 0:O.data.state_key.toString(),this.canReceiveStateEvent(O.data.type,(Fe=Ee)!==null&&Fe!==void 0?Fe:null)){X.next=38;break}return X.abrupt("return",this.transport.reply(O,{error:{message:"Cannot read state events of this type"}}));case 38:X.next=43;break;case 40:if(ue=O.data.msgtype,this.canReceiveRoomEvent(O.data.type,ue)){X.next=43;break}return X.abrupt("return",this.transport.reply(O,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(O.data.room_ids===void 0&&N.length===0)){X.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),X.next=47,O.data.state_key===void 0?this.driver.readRoomEvents(O.data.type,ue,ae,null,Ke):this.driver.readStateEvents(O.data.type,Ee,ae,null);case 47:Q=X.sent,X.next=68;break;case 50:return X.next=52,this.supportsUpdateState();case 52:if(!X.sent){X.next=58;break}return X.next=55,Promise.all(N.map(function(Ce){return F.driver.readRoomTimeline(Ce,O.data.type,ue,Ee,ae,Ke)}));case 55:Q=X.sent.flat(1),X.next=68;break;case 58:if(O.data.state_key!==void 0){X.next=64;break}return X.next=61,Promise.all(N.map(function(Ce){return F.driver.readRoomTimeline(Ce,O.data.type,ue,Ee,ae,Ke)}));case 61:X.t1=X.sent,X.next=67;break;case 64:return X.next=66,Promise.all(N.map(function(Ce){return F.driver.readRoomState(Ce,O.data.type,Ee)}));case 66:X.t1=X.sent;case 67:Q=X.t1.flat(1);case 68:this.transport.reply(O,{events:Q});case 69:case"end":return X.stop()}},U,this,[[14,24,27,30]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleSendEvent",value:function(k){var U=this;if(!k.data.type)return this.transport.reply(k,{error:{message:"Invalid request - missing event type"}});if(k.data.room_id&&!this.canUseRoomTimeline(k.data.room_id))return this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(k.data.room_id)}});var O=k.data.delay!==void 0||k.data.parent_delay_id!==void 0;if(O&&!this.hasCapability(i.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(k,{error:{message:"Missing capability"}});var F;if(k.data.state_key!==void 0){if(!this.canSendStateEvent(k.data.type,k.data.state_key))return this.transport.reply(k,{error:{message:"Cannot send state events of this type"}});if(!O)F=this.driver.sendEvent(k.data.type,k.data.content||{},k.data.state_key,k.data.room_id);else{var N,$;F=this.driver.sendDelayedEvent((N=k.data.delay)!==null&&N!==void 0?N:null,($=k.data.parent_delay_id)!==null&&$!==void 0?$:null,k.data.type,k.data.content||{},k.data.state_key,k.data.room_id)}}else{var Z=k.data.content||{},fe=Z.msgtype;if(!this.canSendRoomEvent(k.data.type,fe))return this.transport.reply(k,{error:{message:"Cannot send room events of this type"}});if(!O)F=this.driver.sendEvent(k.data.type,Z,null,k.data.room_id);else{var ae,Ke;F=this.driver.sendDelayedEvent((ae=k.data.delay)!==null&&ae!==void 0?ae:null,(Ke=k.data.parent_delay_id)!==null&&Ke!==void 0?Ke:null,k.data.type,Z,null,k.data.room_id)}}F.then(function(Ee){return U.transport.reply(k,m({room_id:Ee.roomId},"eventId"in Ee?{event_id:Ee.eventId}:{delay_id:Ee.delayId}))}).catch(function(Ee){console.error("error sending event: ",Ee),U.handleDriverError(Ee,k,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(k){var U=this;if(!k.data.delay_id)return this.transport.reply(k,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(i.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(k,{error:{message:"Missing capability"}});switch(k.data.action){case d.UpdateDelayedEventAction.Cancel:case d.UpdateDelayedEventAction.Restart:case d.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(k.data.delay_id,k.data.action).then(function(){return U.transport.reply(k,{})}).catch(function(O){console.error("error updating delayed event: ",O),U.handleDriverError(O,k,"Error updating delayed event")});break;default:return this.transport.reply(k,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:function(){var M=C(P().mark(function U(O){return P().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:if(O.data.type){N.next=5;break}return N.next=3,this.transport.reply(O,{error:{message:"Invalid request - missing event type"}});case 3:N.next=31;break;case 5:if(O.data.messages){N.next=10;break}return N.next=8,this.transport.reply(O,{error:{message:"Invalid request - missing event contents"}});case 8:N.next=31;break;case 10:if(typeof O.data.encrypted=="boolean"){N.next=15;break}return N.next=13,this.transport.reply(O,{error:{message:"Invalid request - missing encryption flag"}});case 13:N.next=31;break;case 15:if(this.canSendToDeviceEvent(O.data.type)){N.next=20;break}return N.next=18,this.transport.reply(O,{error:{message:"Cannot send to-device events of this type"}});case 18:N.next=31;break;case 20:return N.prev=20,N.next=23,this.driver.sendToDevice(O.data.type,O.data.encrypted,O.data.messages);case 23:return N.next=25,this.transport.reply(O,{});case 25:N.next=31;break;case 27:N.prev=27,N.t0=N.catch(20),console.error("error sending to-device event",N.t0),this.handleDriverError(N.t0,O,"Error sending event");case 31:case"end":return N.stop()}},U,this,[[20,27]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"pollTurnServers",value:function(){var M=C(P().mark(function U(O,F){var N,$,Z,fe,ae,Ke;return P().wrap(function(ue){for(;;)switch(ue.prev=ue.next){case 0:return ue.prev=0,ue.next=3,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,F);case 3:N=!1,$=!1,ue.prev=5,fe=Ne(O);case 7:return ue.next=9,fe.next();case 9:if(!(N=!(ae=ue.sent).done)){ue.next=16;break}return Ke=ae.value,ue.next=13,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,Ke);case 13:N=!1,ue.next=7;break;case 16:ue.next=22;break;case 18:ue.prev=18,ue.t0=ue.catch(5),$=!0,Z=ue.t0;case 22:if(ue.prev=22,ue.prev=23,!(N&&fe.return!=null)){ue.next=27;break}return ue.next=27,fe.return();case 27:if(ue.prev=27,!$){ue.next=30;break}throw Z;case 30:return ue.finish(27);case 31:return ue.finish(22);case 32:ue.next=37;break;case 34:ue.prev=34,ue.t1=ue.catch(0),console.error("error polling for TURN servers",ue.t1);case 37:case"end":return ue.stop()}},U,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function k(U,O){return M.apply(this,arguments)}return k}()},{key:"handleWatchTurnServers",value:function(){var M=C(P().mark(function U(O){var F,N,$,Z;return P().wrap(function(ae){for(;;)switch(ae.prev=ae.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){ae.next=5;break}return ae.next=3,this.transport.reply(O,{error:{message:"Missing capability"}});case 3:ae.next=30;break;case 5:if(!this.turnServers){ae.next=10;break}return ae.next=8,this.transport.reply(O,{});case 8:ae.next=30;break;case 10:return ae.prev=10,F=this.driver.getTurnServers(),ae.next=14,F.next();case 14:if(N=ae.sent,$=N.done,Z=N.value,!$){ae.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return ae.next=21,this.transport.reply(O,{});case 21:this.pollTurnServers(F,Z),this.turnServers=F,ae.next=30;break;case 25:return ae.prev=25,ae.t0=ae.catch(10),console.error("error getting first TURN server results",ae.t0),ae.next=30,this.transport.reply(O,{error:{message:"TURN servers not available"}});case 30:case"end":return ae.stop()}},U,this,[[10,25]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleUnwatchTurnServers",value:function(){var M=C(P().mark(function U(O){return P().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){N.next=5;break}return N.next=3,this.transport.reply(O,{error:{message:"Missing capability"}});case 3:N.next=15;break;case 5:if(this.turnServers){N.next=10;break}return N.next=8,this.transport.reply(O,{});case 8:N.next=15;break;case 10:return N.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,N.next=15,this.transport.reply(O,{});case 15:case"end":return N.stop()}},U,this)}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleReadRelations",value:function(){var M=C(P().mark(function U(O){var F=this,N,$;return P().wrap(function(fe){for(;;)switch(fe.prev=fe.next){case 0:if(O.data.event_id){fe.next=2;break}return fe.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(O.data.limit!==void 0&&O.data.limit<0)){fe.next=4;break}return fe.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(O.data.room_id!==void 0&&!this.canUseRoomTimeline(O.data.room_id))){fe.next=6;break}return fe.abrupt("return",this.transport.reply(O,{error:{message:"Unable to access room timeline: ".concat(O.data.room_id)}}));case 6:return fe.prev=6,fe.next=9,this.driver.readEventRelations(O.data.event_id,O.data.room_id,O.data.rel_type,O.data.event_type,O.data.from,O.data.to,O.data.limit,O.data.direction);case 9:return N=fe.sent,$=N.chunk.filter(function(ae){return ae.state_key!==void 0?F.canReceiveStateEvent(ae.type,ae.state_key):F.canReceiveRoomEvent(ae.type,ae.content.msgtype)}),fe.abrupt("return",this.transport.reply(O,{chunk:$,prev_batch:N.prevBatch,next_batch:N.nextBatch}));case 14:fe.prev=14,fe.t0=fe.catch(6),console.error("error getting the relations",fe.t0),this.handleDriverError(fe.t0,O,"Unexpected error while reading relations");case 18:case"end":return fe.stop()}},U,this,[[6,14]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleUserDirectorySearch",value:function(){var M=C(P().mark(function U(O){var F;return P().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3973UserDirectorySearch)){$.next=2;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:if(typeof O.data.search_term=="string"){$.next=4;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(O.data.limit!==void 0&&O.data.limit<0)){$.next=6;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 6:return $.prev=6,$.next=9,this.driver.searchUserDirectory(O.data.search_term,O.data.limit);case 9:return F=$.sent,$.abrupt("return",this.transport.reply(O,{limited:F.limited,results:F.results.map(function(Z){return{user_id:Z.userId,display_name:Z.displayName,avatar_url:Z.avatarUrl}})}));case 13:$.prev=13,$.t0=$.catch(6),console.error("error searching in the user directory",$.t0),this.handleDriverError($.t0,O,"Unexpected error while searching in the user directory");case 17:case"end":return $.stop()}},U,this,[[6,13]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleGetMediaConfig",value:function(){var M=C(P().mark(function U(O){var F;return P().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){$.next=2;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return $.prev=2,$.next=5,this.driver.getMediaConfig();case 5:return F=$.sent,$.abrupt("return",this.transport.reply(O,F));case 9:$.prev=9,$.t0=$.catch(2),console.error("error while getting the media configuration",$.t0),this.handleDriverError($.t0,O,"Unexpected error while getting the media configuration");case 13:case"end":return $.stop()}},U,this,[[2,9]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleUploadFile",value:function(){var M=C(P().mark(function U(O){var F;return P().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){$.next=2;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return $.prev=2,$.next=5,this.driver.uploadFile(O.data.file);case 5:return F=$.sent,$.abrupt("return",this.transport.reply(O,{content_uri:F.contentUri}));case 9:$.prev=9,$.t0=$.catch(2),console.error("error while uploading a file",$.t0),this.handleDriverError($.t0,O,"Unexpected error while uploading a file");case 13:case"end":return $.stop()}},U,this,[[2,9]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleDownloadFile",value:function(){var M=C(P().mark(function U(O){var F;return P().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039DownloadFile)){$.next=2;break}return $.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return $.prev=2,$.next=5,this.driver.downloadFile(O.data.content_uri);case 5:return F=$.sent,$.abrupt("return",this.transport.reply(O,{file:F.file}));case 9:$.prev=9,$.t0=$.catch(2),console.error("error while downloading a file",$.t0),this.handleDriverError($.t0,O,"Unexpected error while downloading a file");case 13:case"end":return $.stop()}},U,this,[[2,9]])}));function k(U){return M.apply(this,arguments)}return k}()},{key:"handleDriverError",value:function(k,U,O){var F=this.driver.processError(k);this.transport.reply(U,{error:m({message:O},F)})}},{key:"handleMessage",value:function(k){if(!this.isStopped){var U=new CustomEvent("action:".concat(k.detail.action),{detail:k.detail,cancelable:!0});if(this.emit("action:".concat(k.detail.action),U),!U.defaultPrevented)switch(k.detail.action){case n.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(k.detail);case n.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(k.detail);case n.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(k.detail);case n.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(k.detail);case n.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(k.detail);case n.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(k.detail);case n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(k.detail);case n.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(k.detail);case n.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(k.detail);case n.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(k.detail);case n.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(k.detail);case n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(k.detail);case n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(k.detail);case n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(k.detail);case n.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(k.detail);case n.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(k.detail);case n.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(k.detail);default:return this.transport.reply(k.detail,{error:{message:"Unknown or unsupported action: "+k.detail.action}})}}}},{key:"updateTheme",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.ThemeChange,k)}},{key:"updateLanguage",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.LanguageChange,{lang:k})}},{key:"takeScreenshot",value:function(){return this.transport.send(n.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.UpdateVisibility,{visible:k})}},{key:"sendWidgetConfig",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.WidgetConfig,k).then()}},{key:"notifyModalWidgetButtonClicked",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.ButtonClicked,{id:k}).then()}},{key:"notifyModalWidgetClose",value:function(k){return this.transport.send(n.WidgetApiToWidgetAction.CloseModalWidget,k).then()}},{key:"feedEvent",value:function(){var M=C(P().mark(function U(O,F){var N;return P().wrap(function(Z){for(;;)switch(Z.prev=Z.next){case 0:if(F!==void 0&&this.setViewedRoomId(F),!(O.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(O.room_id))){Z.next=3;break}return Z.abrupt("return");case 3:if(!(O.state_key!==void 0&&O.state_key!==null)){Z.next=8;break}if(this.canReceiveStateEvent(O.type,O.state_key)){Z.next=6;break}return Z.abrupt("return");case 6:Z.next=10;break;case 8:if(this.canReceiveRoomEvent(O.type,(N=O.content)===null||N===void 0?void 0:N.msgtype)){Z.next=10;break}return Z.abrupt("return");case 10:return Z.next=12,this.transport.send(n.WidgetApiToWidgetAction.SendEvent,O);case 12:case"end":return Z.stop()}},U,this)}));function k(U,O){return M.apply(this,arguments)}return k}()},{key:"feedToDevice",value:function(){var M=C(P().mark(function U(O,F){return P().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(!this.canReceiveToDeviceEvent(O.type)){$.next=3;break}return $.next=3,this.transport.send(n.WidgetApiToWidgetAction.SendToDevice,m(m({},O),{},{encrypted:F}));case 3:case"end":return $.stop()}},U,this)}));function k(U,O){return M.apply(this,arguments)}return k}()},{key:"setViewedRoomId",value:function(k){this.viewedRoomId=k,k!==null&&!this.canUseRoomTimeline(k)&&this.pushRoomState(k)}},{key:"flushRoomState",value:function(){var M=C(P().mark(function U(){var O,F,N,$,Z,fe,ae;return P().wrap(function(Ee){for(;;)switch(Ee.prev=Ee.next){case 0:Ee.prev=0;case 1:return Ee.next=3,Promise.all(y(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){Ee.next=1;break}case 4:O=[],F=v(this.pushRoomStateResult.values());try{for(F.s();!(N=F.n()).done;){$=N.value,Z=v($.values());try{for(Z.s();!(fe=Z.n()).done;)ae=fe.value,O.push.apply(O,y(ae.values()))}catch(ue){Z.e(ue)}finally{Z.f()}}}catch(ue){F.e(ue)}finally{F.f()}return Ee.next=9,this.getWidgetVersions();case 9:if(!Ee.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){Ee.next=12;break}return Ee.next=12,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:O});case 12:return Ee.prev=12,this.flushRoomStateTask=null,Ee.finish(12);case 15:case"end":return Ee.stop()}},U,this,[[0,,12,15]])}));function k(){return M.apply(this,arguments)}return k}()},{key:"pushRoomState",value:function(k){var U=this,O=v(this.allowedEvents),F;try{var N=function(){var Z=F.value;if(Z.kind===s.EventKind.State&&Z.direction===s.EventDirection.Receive){var fe,ae,Ke=U.driver.readRoomState(k,Z.eventType,(fe=Z.keyStr)!==null&&fe!==void 0?fe:void 0),Ee=Ke.then(function(ue){var Fe=v(ue),Q;try{for(Fe.s();!(Q=Fe.n()).done;){var de=Q.value,X=U.pushRoomStateResult.get(k);X===void 0&&(X=new Map,U.pushRoomStateResult.set(k,X));var Ce=X.get(Z.eventType);Ce===void 0&&(Ce=new Map,X.set(Z.eventType,Ce)),Ce.has(de.state_key)||Ce.set(de.state_key,de)}}catch(be){Fe.e(be)}finally{Fe.f()}},function(ue){return console.error("Failed to read room state for ".concat(k," (").concat(Z.eventType,", ").concat(Z.keyStr,")"),ue)}).then(function(){U.pushRoomStateTasks.delete(Ee)});U.pushRoomStateTasks.add(Ee),(ae=U.flushRoomStateTask)!==null&&ae!==void 0||(U.flushRoomStateTask=U.flushRoomState()),U.flushRoomStateTask.catch(function(ue){return console.error("Failed to push room state",ue)})}};for(O.s();!(F=O.n()).done;)N()}catch($){O.e($)}finally{O.f()}}},{key:"feedStateUpdate",value:function(){var M=C(P().mark(function U(O){var F,N;return P().wrap(function(Z){for(;;)switch(Z.prev=Z.next){case 0:if(O.state_key!==void 0){Z.next=2;break}throw new Error("Not a state event");case 2:if(!((O.room_id===this.viewedRoomId||this.canUseRoomTimeline(O.room_id))&&this.canReceiveStateEvent(O.type,O.state_key))){Z.next=21;break}if(this.pushRoomStateTasks.size!==0){Z.next=11;break}return Z.next=6,this.getWidgetVersions();case 6:if(!Z.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){Z.next=9;break}return Z.next=9,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:[O]});case 9:Z.next=21;break;case 11:F=this.pushRoomStateResult.get(O.room_id),F===void 0&&(F=new Map,this.pushRoomStateResult.set(O.room_id,F)),N=F.get(O.type),N===void 0&&(N=new Map,F.set(O.type,N)),N.has(O.type)||N.set(O.state_key,O);case 16:return Z.next=18,Promise.all(y(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){Z.next=16;break}case 19:return Z.next=21,this.flushRoomStateTask;case 21:case"end":return Z.stop()}},U,this)}));function k(U){return M.apply(this,arguments)}return k}()}]),A}(r.EventEmitter);return Zs.ClientWidgetApi=te,Zs}var hm={};Object.defineProperty(hm,"__esModule",{value:!0});hm.isErrorResponse=Zx;function Av(r){"@babel/helpers - typeof";return Av=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Av(r)}function Zx(r){var e=r.error;return Av(e)==="object"&&e!==null&&"message"in e&&typeof e.message=="string"}var gc={};Object.defineProperty(gc,"__esModule",{value:!0});gc.WidgetKind=void 0;var eN=function(r){return r.Room="room",r.Account="account",r.Modal="modal",r}({});gc.WidgetKind=eN;var yc={};Object.defineProperty(yc,"__esModule",{value:!0});yc.ModalButtonKind=void 0;var tN=function(r){return r.Primary="m.primary",r.Secondary="m.secondary",r.Warning="m.warning",r.Danger="m.danger",r.Link="m.link",r}({});yc.ModalButtonKind=tN;var Sc={};Object.defineProperty(Sc,"__esModule",{value:!0});Sc.isValidUrl=rN;function rN(r){if(!r)return!1;try{var e=new URL(r);return!(e.protocol!=="http"&&e.protocol!=="https")}catch(t){if(t instanceof TypeError)return!1;throw t}}var Ec={};Object.defineProperty(Ec,"__esModule",{value:!0});Ec.assertPresent=nN;function nN(r,e){if(!r[e])throw new Error("".concat(String(e)," is required"))}var eo={},PS;function vw(){if(PS)return eo;PS=1,Object.defineProperty(eo,"__esModule",{value:!0}),eo.Widget=void 0;var r=Ec,e=bc();function t(u){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(d){return typeof d}:function(d){return d&&typeof Symbol=="function"&&d.constructor===Symbol&&d!==Symbol.prototype?"symbol":typeof d},t(u)}function n(u,d){if(!(u instanceof d))throw new TypeError("Cannot call a class as a function")}function i(u,d){for(var h=0;h<d.length;h++){var f=d[h];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(u,s(f.key),f)}}function a(u,d,h){return d&&i(u.prototype,d),Object.defineProperty(u,"prototype",{writable:!1}),u}function s(u){var d=o(u,"string");return t(d)==="symbol"?d:String(d)}function o(u,d){if(t(u)!=="object"||u===null)return u;var h=u[Symbol.toPrimitive];if(h!==void 0){var f=h.call(u,d);if(t(f)!=="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(u)}var l=function(){function u(d){if(n(this,u),this.definition=d,!this.definition)throw new Error("Definition is required");(0,r.assertPresent)(d,"id"),(0,r.assertPresent)(d,"creatorUserId"),(0,r.assertPresent)(d,"type"),(0,r.assertPresent)(d,"url")}return a(u,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(h){return(0,e.runTemplate)(this.templateUrl,this.definition,h)}}]),u}();return eo.Widget=l,eo}var to={},MS;function iN(){if(MS)return to;MS=1,Object.defineProperty(to,"__esModule",{value:!0}),to.WidgetParser=void 0;var r=vw(),e=Sc;function t(f){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},t(f)}function n(f,m){var v=typeof Symbol<"u"&&f[Symbol.iterator]||f["@@iterator"];if(!v){if(Array.isArray(f)||(v=i(f))||m){v&&(f=v);var y=0,I=function(){};return{s:I,n:function(){return y>=f.length?{done:!0}:{done:!1,value:f[y++]}},e:function(P){throw P},f:I}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var g=!0,p=!1,b;return{s:function(){v=v.call(f)},n:function(){var P=v.next();return g=P.done,P},e:function(P){p=!0,b=P},f:function(){try{!g&&v.return!=null&&v.return()}finally{if(p)throw b}}}}function i(f,m){if(f){if(typeof f=="string")return a(f,m);var v=Object.prototype.toString.call(f).slice(8,-1);if(v==="Object"&&f.constructor&&(v=f.constructor.name),v==="Map"||v==="Set")return Array.from(f);if(v==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(v))return a(f,m)}}function a(f,m){(m==null||m>f.length)&&(m=f.length);for(var v=0,y=new Array(m);v<m;v++)y[v]=f[v];return y}function s(f,m){if(!(f instanceof m))throw new TypeError("Cannot call a class as a function")}function o(f,m){for(var v=0;v<m.length;v++){var y=m[v];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(f,u(y.key),y)}}function l(f,m,v){return v&&o(f,v),Object.defineProperty(f,"prototype",{writable:!1}),f}function u(f){var m=d(f,"string");return t(m)==="symbol"?m:String(m)}function d(f,m){if(t(f)!=="object"||f===null)return f;var v=f[Symbol.toPrimitive];if(v!==void 0){var y=v.call(f,m);if(t(y)!=="object")return y;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(f)}var h=function(){function f(){s(this,f)}return l(f,null,[{key:"parseAccountData",value:function(v){if(!v)return[];for(var y=[],I=0,g=Object.keys(v);I<g.length;I++){var p=g[I],b=v[p];if(b&&!(b.type!=="m.widget"&&b.type!=="im.vector.modular.widgets")&&b.sender){var R=b.state_key||b.id;if(R===p){var P={content:b.content,sender:b.sender,type:"m.widget",state_key:p,event_id:"$example",room_id:"!example",origin_server_ts:1},E=f.parseRoomWidget(P);E&&y.push(E)}}}return y}},{key:"parseWidgetsFromRoomState",value:function(v){if(!v)return[];var y=[],I=n(v),g;try{for(I.s();!(g=I.n()).done;){var p=g.value,b=f.parseRoomWidget(p);b&&y.push(b)}}catch(R){I.e(R)}finally{I.f()}return y}},{key:"parseRoomWidget",value:function(v){if(!v||v.type!=="m.widget"&&v.type!=="im.vector.modular.widgets")return null;var y=v.content||{},I={id:v.state_key,creatorUserId:y.creatorUserId||v.sender,name:y.name,type:y.type,url:y.url,waitForIframeLoad:y.waitForIframeLoad,data:y.data};return f.processEstimatedWidget(I)}},{key:"processEstimatedWidget",value:function(v){return!v.id||!v.creatorUserId||!v.type||!(0,e.isValidUrl)(v.url)?null:new r.Widget(v)}}]),f}();return to.WidgetParser=h,to}var _c={};Object.defineProperty(_c,"__esModule",{value:!0});_c.runTemplate=aN;_c.toString=pw;function aN(r,e,t){for(var n=Object.assign({},e.data,{matrix_room_id:t.widgetRoomId||"",matrix_user_id:t.currentUserId,matrix_display_name:t.userDisplayName||t.currentUserId,matrix_avatar_url:t.userHttpAvatarUrl||"",matrix_widget_id:e.id,"org.matrix.msc2873.client_id":t.clientId||"","org.matrix.msc2873.client_theme":t.clientTheme||"","org.matrix.msc2873.client_language":t.clientLanguage||"","org.matrix.msc3819.matrix_device_id":t.deviceId||"","org.matrix.msc4039.matrix_base_url":t.baseUrl||""}),i=r,a=0,s=Object.keys(n);a<s.length;a++){var o=s[a],l="$".concat(o).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=new RegExp(l,"g");i=i.replace(u,encodeURIComponent(pw(n[o])))}return i}function pw(r){return r==null?"".concat(r):String(r)}var ro={},AS;function sN(){if(AS)return ro;AS=1,Object.defineProperty(ro,"__esModule",{value:!0}),ro.WidgetDriver=void 0;var r=bc();function e(l){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u},e(l)}function t(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")}function n(l,u){for(var d=0;d<u.length;d++){var h=u[d];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(l,a(h.key),h)}}function i(l,u,d){return u&&n(l.prototype,u),Object.defineProperty(l,"prototype",{writable:!1}),l}function a(l){var u=s(l,"string");return e(u)==="symbol"?u:String(u)}function s(l,u){if(e(l)!=="object"||l===null)return l;var d=l[Symbol.toPrimitive];if(d!==void 0){var h=d.call(l,u);if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}var o=function(){function l(){t(this,l)}return i(l,[{key:"validateCapabilities",value:function(d){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(d,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(d,h,f,m){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(d,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(d,h,f){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(d){return Promise.resolve([])}},{key:"readRoomEvents",value:function(d,h,f){return Promise.resolve([])}},{key:"readStateEvents",value:function(d,h,f){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(d,h,f,m,v,y){return m===void 0?this.readRoomEvents(h,f,v,[d],y):this.readStateEvents(h,m,v,[d])}},{key:"readRoomState",value:function(d,h,f){return this.readStateEvents(h,f,Number.MAX_SAFE_INTEGER,[d])}},{key:"readEventRelations",value:function(d,h,f,m,v,y,I,g){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(d){d.update({state:r.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(d){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(d,h){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(d){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(d){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(d){}}]),l}();return ro.WidgetDriver=o,ro}var DS;function bc(){return DS||(DS=1,function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=Ux();Object.keys(e).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===e[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return e[S]}})});var t=Xx();Object.keys(t).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===t[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return t[S]}})});var n=Ls;Object.keys(n).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===n[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return n[S]}})});var i=dm();Object.keys(i).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===i[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return i[S]}})});var a=Ml;Object.keys(a).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===a[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return a[S]}})});var s=hm;Object.keys(s).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===s[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return s[S]}})});var o=Ci;Object.keys(o).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===o[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return o[S]}})});var l=Sa;Object.keys(l).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===l[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return l[S]}})});var u=mn;Object.keys(u).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===u[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return u[S]}})});var d=Nr;Object.keys(d).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===d[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return d[S]}})});var h=Ns;Object.keys(h).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===h[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return h[S]}})});var f=gc;Object.keys(f).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===f[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return f[S]}})});var m=yc;Object.keys(m).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===m[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return m[S]}})});var v=Al;Object.keys(v).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===v[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return v[S]}})});var y=xl;Object.keys(y).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===y[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return y[S]}})});var I=gn;Object.keys(I).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===I[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return I[S]}})});var g=Sc;Object.keys(g).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===g[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return g[S]}})});var p=Ec;Object.keys(p).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===p[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return p[S]}})});var b=vw();Object.keys(b).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===b[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return b[S]}})});var R=iN();Object.keys(R).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===R[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return R[S]}})});var P=_c;Object.keys(P).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===P[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return P[S]}})});var E=Dl;Object.keys(E).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===E[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return E[S]}})});var C=sN();Object.keys(C).forEach(function(S){S==="default"||S==="__esModule"||S in r&&r[S]===C[S]||Object.defineProperty(r,S,{enumerable:!0,get:function(){return C[S]}})})}(_h)),_h}var Pr=bc();function xS(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}function uu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?xS(Object(t),!0).forEach(function(n){c(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):xS(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function oN(r){var e,t,n,i=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(t&&(e=r[t])!=null)return e.call(r);if(n&&(e=r[n])!=null)return new Lu(e.call(r));t="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Lu(r){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(i){return{value:i,done:n}})}return Lu=function(n){this.s=n,this.n=n.next},Lu.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Promise.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Promise.reject(n):e(i.apply(this.s,arguments))}},new Lu(r)}var Uu=function(r){return r.PendingEventsChanged="PendingEvent.pendingEventsChanged",r}({});class mw extends mc{constructor(e,t,n,i,a){var s,o,l,u,d,h,f,m,v,y,I,g,p,b;super(i),s=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,c(this,"room",void 0),c(this,"widgetApiReady",void 0),c(this,"roomStateSynced",void 0),c(this,"lifecycle",void 0),c(this,"syncState",null),c(this,"pendingSendingEventsTxId",[]),c(this,"eventEmitter",new nt),c(this,"updateTxId",function(){var E=w(function*(C){if(C.getSender()===s.getUserId()&&s.pendingSendingEventsTxId.some(z=>C.getType()===z.type)){for(var S,x=(S=s.pendingSendingEventsTxId.find(z=>z.id===C.getId()))===null||S===void 0?void 0:S.txId;!x&&s.pendingSendingEventsTxId.length>0;){var K;yield new Promise(z=>s.eventEmitter.once(Uu.PendingEventsChanged,()=>z())),x=(K=s.pendingSendingEventsTxId.find(z=>z.id===C.getId()))===null||K===void 0?void 0:K.txId}x&&(C.setTxnId(x),C.setUnsigned(uu(uu({},C.getUnsigned()),{},{transaction_id:x}))),s.pendingSendingEventsTxId=s.pendingSendingEventsTxId.filter(z=>z.id!==C.getId()),s.pendingSendingEventsTxId.length===0&&s.eventEmitter.emit(Uu.PendingEventsChanged)}});return function(C){return E.apply(this,arguments)}}()),c(this,"onEvent",function(){var E=w(function*(C){if(C.preventDefault(),C.detail.data.room_id===s.roomId){var S=new zt(C.detail.data);yield s.updateTxId(S),s.syncApi instanceof di?(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,void 0,[],[S]):yield s.syncApi.injectRoomEvents(s.room,[],void 0,[S]):(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,[],[S]):T.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),s.emit(ce.Event,S),s.setSyncState(qe.Syncing),T.info("Received event ".concat(S.getId()," ").concat(S.getType()))}else{var{event_id:x,room_id:K}=C.detail.data;T.info("Received event ".concat(x," for a different room ").concat(K,"; discarding"))}yield s.ack(C)});return function(C){return E.apply(this,arguments)}}()),c(this,"onToDevice",function(){var E=w(function*(C){C.preventDefault();var S=new zt({type:C.detail.data.type,sender:C.detail.data.sender,content:C.detail.data.content});C.detail.data.encrypted&&S.makeEncrypted(j.RoomMessageEncrypted,{},"",""),s.emit(ce.ToDeviceEvent,S),s.setSyncState(qe.Syncing),yield s.ack(C)});return function(C){return E.apply(this,arguments)}}()),c(this,"onStateUpdate",function(){var E=w(function*(C){C.preventDefault(),(yield s.supportUpdateState())||T.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var S of C.detail.data.state)if(S.room_id===s.roomId){var x=new zt(S);s.syncApi instanceof di?yield s.syncApi.injectRoomEvents(s.room,void 0,[x]):yield s.syncApi.injectRoomEvents(s.room,[x]),T.info("Updated state entry ".concat(x.getType()," ").concat(x.getStateKey()," to ").concat(x.getId()))}else{var{event_id:K,room_id:z}=C.detail.data;T.info("Received state entry ".concat(K," for a different room ").concat(z,"; discarding"))}yield s.ack(C)});return function(C){return E.apply(this,arguments)}}());var R=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var E=w(function*(C,S){try{return yield R(C,S)}catch(x){NS(x)}});return function(C,S){return E.apply(this,arguments)}}();var P=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var E=w(function*(C,S){try{return yield P(C,S)}catch(x){NS(x)}});return function(C,S){return E.apply(this,arguments)}}(),this.widgetApiReady=new Promise(E=>this.widgetApi.once("ready",E)),this.roomStateSynced=(o=t.receiveState)!==null&&o!==void 0&&o.length?new Promise(E=>this.widgetApi.once("action:".concat(Pr.WidgetApiToWidgetAction.UpdateState),E)):Promise.resolve(),((l=t.sendEvent)!==null&&l!==void 0&&l.length||(u=t.receiveEvent)!==null&&u!==void 0&&u.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(d=t.sendState)!==null&&d!==void 0&&d.length||(h=t.receiveState)!==null&&h!==void 0&&h.length)&&e.requestCapabilityForRoomTimeline(n),(f=t.sendEvent)===null||f===void 0||f.forEach(E=>e.requestCapabilityToSendEvent(E)),(m=t.receiveEvent)===null||m===void 0||m.forEach(E=>e.requestCapabilityToReceiveEvent(E)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(E=>e.requestCapabilityToSendMessage(E)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(E=>e.requestCapabilityToReceiveMessage(E)),(v=t.sendState)===null||v===void 0||v.forEach(E=>{var{eventType:C,stateKey:S}=E;return e.requestCapabilityToSendState(C,S)}),(y=t.receiveState)===null||y===void 0||y.forEach(E=>{var{eventType:C,stateKey:S}=E;return e.requestCapabilityToReceiveState(C,S)}),(I=t.sendToDevice)===null||I===void 0||I.forEach(E=>e.requestCapabilityToSendToDevice(E)),(g=t.receiveToDevice)===null||g===void 0||g.forEach(E=>e.requestCapabilityToReceiveToDevice(E)),t.sendDelayedEvents&&((p=t.sendEvent)!==null&&p!==void 0&&p.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(b=t.sendState)!==null&&b!==void 0&&b.length)&&e.requestCapability(Pr.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(Pr.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(Pr.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(Pr.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(Pr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(Pr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}supportUpdateState(){var e=this;return w(function*(){return(yield e.widgetApi.getClientVersions()).includes(Pr.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return w(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var i=t.getUserId();if(i&&t.store.storeUser(new Ln(i)),n.slidingSync?t.syncApi=new $0(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new di(t,n,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,s;yield Promise.all((a=(s=t.capabilities.receiveState)===null||s===void 0?void 0:s.map(function(){var o=w(function*(l){var{eventType:u,stateKey:d}=l,h=yield t.widgetApi.readStateEvents(u,void 0,d,[t.roomId]),f=h.map(m=>new zt(m));t.syncApi instanceof di?yield t.syncApi.injectRoomEvents(t.room,void 0,f):yield t.syncApi.injectRoomEvents(t.room,f),f.forEach(m=>{t.emit(ce.Event,m),T.info("Backfilled event ".concat(m.getId()," ").concat(m.getType()," ").concat(m.getStateKey()))})});return function(l){return o.apply(this,arguments)}}()))!==null&&a!==void 0?a:[])}n.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(qe.Syncing),T.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(Pr.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(Pr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(Pr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return w(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n){var i=this;return w(function*(){var a=t.event.redacts?uu(uu({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(n){var s=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId,"delay"in n?n.delay:void 0,"parent_delay_id"in n?n.parent_delay_id:void 0).catch(rn);return i.validateSendDelayedEventResponse(s)}var o=t.getTxnId();o&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:o});var l;try{l=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId).catch(rn)}catch(u){throw i.updatePendingEventStatus(e,t,Se.NOT_SENT),u}return e.updatePendingEvent(t,Se.SENT,l.event_id),i.pendingSendingEventsTxId.forEach(u=>{u.txId===o&&(u.id=l.event_id)}),i.eventEmitter.emit(Uu.PendingEventsChanged),{event_id:l.event_id}})()}sendStateEvent(e,t,n){var i=arguments,a=this;return w(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:"",o=yield a.widgetApi.sendStateEvent(t,s,n,e).catch(rn);if(o.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:o.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return w(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield s.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","sendDelayedStateEvent");var l=yield s.widgetApi.sendStateEvent(n,o,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(rn);return s.validateSendDelayedEventResponse(l)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return w(function*(){if(!(yield n.doesServerSupportUnstableFeature(cn)))throw new hi("Server does not support the delayed events API","updateDelayedEvent");return yield n.widgetApi.updateDelayedEvent(e,t).catch(rn),{}})()}encryptAndSendToDevice(e,t,n){var i=this;return w(function*(){var a=new Nn(()=>new Map);for(var{userId:s,deviceId:o}of t)a.getOrCreate(s).set(o,n);yield i.widgetApi.sendToDevice(e,!0,Qi(a)).catch(rn)})()}sendToDevice(e,t){var n=this;return w(function*(){return yield n.widgetApi.sendToDevice(e,!1,Qi(t)).catch(rn),{}})()}getOpenIdToken(){var e=this;return w(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(rn);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return w(function*(){var{eventType:n,batch:i}=e,a=new Nn(()=>new Map);for(var{userId:s,deviceId:o,payload:l}of i)a.getOrCreate(s).set(o,l);yield t.widgetApi.sendToDevice(n,!1,Qi(a)).catch(rn)})()}sendToDeviceViaWidgetApi(e,t,n){var i=this;return w(function*(){yield i.widgetApi.sendToDevice(e,t,Qi(n)).catch(rn)})()}checkTurnServers(){var e=this;return w(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(ce.Sync,e,t)}ack(e){var t=this;return w(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return w(function*(){var t=e.widgetApi.getTurnServers(),n=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",n);try{var i=!1,a=!1,s;try{for(var o=oN(t),l;i=!(l=yield o.next()).done;i=!1){var u=l.value;e.turnServers=[{urls:u.uris,username:u.username,credential:u.password}],e.emit(ce.TurnServers,e.turnServers),T.log("Received TURN server: ".concat(u.uris))}}catch(d){a=!0,s=d}finally{try{i&&o.return!=null&&(yield o.return())}finally{if(a)throw s}}}catch(d){T.warn("Error watching TURN servers",d)}finally{e.lifecycle.signal.removeEventListener("abort",n)}})()}}function NS(r){throw r instanceof Pr.WidgetApiResponseError&&r.data.matrix_api_error?mt.fromWidgetApiErrorData(r.data.matrix_api_error):r}function rn(r){throw r instanceof Error&&r.message==="Request timed out"?new ga("widget api timeout"):r}class lN{constructor(){c(this,"unthreadedReadReceipts",new Map),c(this,"threadedReadReceipts",new Nn(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e==null||e.forEach(t=>{t.type!==j.Receipt||!t.content||Object.keys(t.content).forEach(n=>{Object.entries(t.content[n]).forEach(i=>{var[a,s]=i;if(Lp(a))for(var o of Object.keys(s)){var l=t.content[n][a][o],u={data:t.content[n][a][o],type:a,eventId:n};l.thread_id?this.setThreaded(l.thread_id,o,u):this.setUnthreaded(o,u)}})})})}buildAccumulatedReceiptEvent(e){var t={type:j.Receipt,room_id:e,content:{}},n=new Nn(()=>new Nn(()=>new Map));for(var[i,a]of this.allUnthreaded())n.getOrCreate(a.eventId).getOrCreate(a.type).set(i,a.data);for(var[s,o]of this.allThreaded())n.getOrCreate(o.eventId).getOrCreate(o.type).set(s,o.data);return t.content=Qi(n),n.size>0?t:null}}var wn=function(r){return r.Invite="invite",r.Leave="leave",r.Join="join",r.Knock="knock",r}({});function uN(r){return"_localTs"in r&&r._localTs!==void 0}class gw{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,c(this,"accountData",{}),c(this,"inviteRooms",{}),c(this,"knockRooms",{}),c(this,"joinRooms",{}),c(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,wn.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,wn.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,wn.Leave,e.rooms.leave[n],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(n=>{this.accumulateRoom(n,wn.Knock,e.rooms.knock[n],t)}))}accumulateRoom(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case wn.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case wn.Knock:this.accumulateKnockState(e,n);break;case wn.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case wn.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:T.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var n=this.inviteRooms[e];t.invite_state.events.forEach(i=>{for(var a=!1,s=0;s<n.invite_state.events.length;s++){var o=n.invite_state.events[s];o.type===i.type&&o.state_key==i.state_key&&(n.invite_state.events[s]=i,a=!0)}a||n.invite_state.events.push(i)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var n=this.knockRooms[e];t.knock_state.events.forEach(i=>{for(var a=!1,s=0;s<n.knock_state.events.length;s++){var o=n.knock_state.events[s];o.type===i.type&&o.state_key==i.state_key&&(n.knock_state.events[s]=i,a=!0)}a||n.knock_state.events.push(i)})}}accumulateJoinState(e,t){var n,i,a,s,o,l,u=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new lN});var d=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(P=>{d._accountData[P.type]=P}),t.unread_notifications&&(d._unreadNotifications=t.unread_notifications),d._unreadThreadNotifications=(n=(i=t[nl.stable])!==null&&i!==void 0?i:t[nl.unstable])!==null&&n!==void 0?n:void 0,t.summary){var h,f,m,v="m.heroes",y="m.invited_member_count",I="m.joined_member_count",g=d._summary,p=t.summary;g[v]=(h=p[v])!==null&&h!==void 0?h:g[v],g[I]=(f=p[I])!==null&&f!==void 0?f:g[I],g[y]=(m=p[y])!==null&&m!==void 0?m:g[y]}if(d._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(d._timeline=[]),(s=t.state)===null||s===void 0||(s=s.events)===null||s===void 0||s.forEach(P=>{du(d._currentState,P)}),(o=t["org.matrix.msc4222.state_after"])===null||o===void 0||(o=o.events)===null||o===void 0||o.forEach(P=>{du(d._currentState,P)}),(l=t.timeline)===null||l===void 0||(l=l.events)===null||l===void 0||l.forEach((P,E)=>{var C;t["org.matrix.msc4222.state_after"]||du(d._currentState,P);var S;if(u)S=P;else{var x;S=Object.assign({},P),S.unsigned!==void 0&&(S.unsigned=Object.assign({},S.unsigned));var K=(x=P.unsigned)===null||x===void 0?void 0:x.age;K!==void 0&&(S._localTs=Date.now()-K)}d._timeline.push({event:S,token:E===0&&(C=t.timeline.prev_batch)!==null&&C!==void 0?C:null})}),d._timeline.length>this.opts.maxTimelineEntries){for(var b=d._timeline.length-this.opts.maxTimelineEntries,R=b;R<d._timeline.length;R++)if(d._timeline[R].token){d._timeline=d._timeline.slice(R,d._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(i=>{t.invite[i]=this.inviteRooms[i]}),Object.keys(this.knockRooms).forEach(i=>{t.knock[i]=this.knockRooms[i]}),Object.keys(this.joinRooms).forEach(i=>{var a=this.joinRooms[i],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:a._unreadNotifications,unread_thread_notifications:a._unreadThreadNotifications,summary:a._summary};Object.keys(a._accountData).forEach(f=>{s.account_data.events.push(a._accountData[f])});var o=a._receipts.buildAccumulatedReceiptEvent(i);o&&s.ephemeral.events.push(o),a._timeline.forEach(f=>{if(!s.timeline.prev_batch){if(!f.token)return;s.timeline.prev_batch=f.token}var m;!e&&uN(f.event)?(m=Object.assign({},f.event),m.unsigned!==void 0&&(m.unsigned=Object.assign({},m.unsigned)),delete m._localTs,m.unsigned=m.unsigned||{},m.unsigned.age=Date.now()-f.event._localTs):m=f.event,s.timeline.events.push(m)});for(var l=Object.create(null),u=s.timeline.events.length-1;u>=0;u--){var d=s.timeline.events[u];if(!(d.state_key===null||d.state_key===void 0)){var h=bl(d);h.unsigned&&(h.unsigned.prev_content&&(h.content=h.unsigned.prev_content),h.unsigned.prev_sender&&(h.sender=h.unsigned.prev_sender)),du(l,h)}}Object.keys(a._currentState).forEach(f=>{Object.keys(a._currentState[f]).forEach(m=>{var v=a._currentState[f][m];s["org.matrix.msc4222.state_after"].events.push(v),l[f]&&l[f][m]&&(v=l[f][m]),s.state.events.push(v)})}),t.join[i]=s});var n=[];return Object.keys(this.accountData).forEach(i=>{n.push(this.accountData[i])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}}function du(r,e){e.state_key===null||e.state_key===void 0||!e.type||(r[e.type]||(r[e.type]=Object.create(null)),r[e.type][e.state_key]=e)}var yw=function(r){return r[r.Blocked=-1]="Blocked",r[r.Unverified=0]="Unverified",r[r.Verified=1]="Verified",r}({});class dN{constructor(e){c(this,"deviceId",void 0),c(this,"userId",void 0),c(this,"algorithms",void 0),c(this,"keys",void 0),c(this,"verified",void 0),c(this,"signatures",void 0),c(this,"displayName",void 0),c(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||yw.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}var LS=function(){},cN=10;class hN{constructor(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,c(this,"windowLimit",void 0),c(this,"start",void 0),c(this,"end",void 0),c(this,"eventCount",0),this.windowLimit=i.windowLimit||1e3,(n=t.room)===null||n===void 0||n.on(le.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,n=i=>{if(!i)throw new Error("No timeline given to initFields");var a,s=i.getEvents();if(!e)a=s.length;else if(a=s.findIndex(u=>u.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var o=Math.min(s.length,a+Math.ceil(t/2)),l=Math.max(0,o-t);this.start=new Dv(i,l-i.getBaseIndex()),this.end=new Dv(i,o-i.getBaseIndex()),this.eventCount=o-l};return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==se.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==se.FORWARDS){var n;return(n=this.end)!==null&&n!==void 0?n:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var n=this.getTimelineIndex(e);if(!n)return!1;var i=e==se.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,LS("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=se.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,i){i&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==se.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var n=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return!!n||!!i}paginate(e,t){var n=arguments,i=this;return w(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0,s=n.length>3&&n[3]!==void 0?n[3]:cN,o=i.getTimelineIndex(e);if(!o)return!1;if(o.pendingPaginate)return o.pendingPaginate;if(i.extend(e,t))return!0;if(!a||s===0)return!1;var l=o.timeline.getPaginationToken(e);if(!l)return!1;var u=i.client.paginateEventTimeline(o.timeline,{backwards:e==se.BACKWARDS,limit:t}).finally(function(){o.pendingPaginate=void 0}).then(d=>d?i.paginate(e,t,!0,s-1):i.paginate(e,t,!1,0));return o.pendingPaginate=u,u})()}unpaginate(e,t){var n=t?this.start:this.end;if(!n)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,LS("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var n,i,a=t.getEvents(),s=0,o=a.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===((n=this.end)===null||n===void 0?void 0:n.timeline)&&(o=this.end.index+t.getBaseIndex());for(var l=s;l<o;l++)e.push(a[l]);if(t===((i=this.end)===null||i===void 0?void 0:i.timeline))break;t=t.getNeighbouringTimeline(se.FORWARDS)}return e}}class Dv{constructor(e,t){this.timeline=e,this.index=t,c(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?se.BACKWARDS:se.FORWARDS);return n?(this.timeline=n,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var no="m.login.email.identity",US="m.login.msisdn",xv=function(r){return r.Password="m.login.password",r.Recaptcha="m.login.recaptcha",r.Terms="m.login.terms",r.Email="m.login.email.identity",r.Msisdn="m.login.msisdn",r.Sso="m.login.sso",r.SsoUnstable="org.matrix.login.sso",r.Dummy="m.login.dummy",r.RegistrationToken="m.login.registration_token",r.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",r}({});class Sw extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,c(this,"name","NoAuthFlowFoundError")}}class fN{constructor(e){var t=this;c(this,"matrixClient",void 0),c(this,"inputs",void 0),c(this,"clientSecret",void 0),c(this,"requestCallback",void 0),c(this,"busyChangedCallback",void 0),c(this,"stateUpdatedCallback",void 0),c(this,"requestEmailTokenCallback",void 0),c(this,"supportedStages",void 0),c(this,"data",void 0),c(this,"emailSid",void 0),c(this,"requestingEmailToken",!1),c(this,"attemptAuthDeferred",null),c(this,"chosenFlow",null),c(this,"currentStage",null),c(this,"emailAttempt",1),c(this,"submitPromise",null),c(this,"requestEmailToken",w(function*(){if(t.requestingEmailToken)T.warn("Could not request email token: Already requesting");else{T.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var n=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=n.sid,T.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return w(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var n=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var i;(i=e.busyChangedCallback)===null||i===void 0||i.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var s;(s=e.busyChangedCallback)===null||s===void 0||s.call(e,!1)})}return n})()}poll(){var e=this;return w(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==no&&e.emailSid){var n={sid:e.emailSid,client_secret:e.clientSecret},i=e.matrixClient.getIdentityServerUrl();i&&(n.id_server=new URL(i).host),t={type:no,threepid_creds:n}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return w(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var s;(s=n.busyChangedCallback)===null||s===void 0||s.call(n,!0)}for(;n.submitPromise;)try{yield n.submitPromise}catch{}var o;(i=n.data)!==null&&i!==void 0&&i.session?o=Object.assign({session:n.data.session},e):o=e;try{n.submitPromise=n.doRequest(o,a),yield n.submitPromise}finally{if(n.submitPromise=null,!a){var l;(l=n.busyChangedCallback)===null||l===void 0||l.call(n,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return w(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield n.requestCallback(e,i);n.attemptAuthDeferred.resolve(a),n.attemptAuthDeferred=null}catch(v){var s,o,l,u,d=v instanceof mt?v:null,h=(s=d==null||(o=d.data)===null||o===void 0?void 0:o.flows)!==null&&s!==void 0?s:null,f=((l=n.data)===null||l===void 0?void 0:l.flows)||!!h;if(!d||d.httpStatus!==401||!d.data||!f)if(i)T.log("Background poll request failed doing UI auth: ignoring",v);else{var m;(m=n.attemptAuthDeferred)===null||m===void 0||m.reject(v)}d&&!d.data&&(d.data={}),d&&!d.data.flows&&!d.data.completed&&!d.data.session&&(d.data.flows=n.data.flows,d.data.completed=n.data.completed,d.data.session=n.data.session),d&&(n.data=d.data);try{n.startNextAuthStage()}catch(y){n.attemptAuthDeferred.reject(y),n.attemptAuthDeferred=null;return}if(!n.emailSid&&(u=n.chosenFlow)!==null&&u!==void 0&&u.stages.includes(xv.Email))try{yield n.requestEmailToken()}catch(y){n.attemptAuthDeferred.reject(y),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");if(this.currentStage=n,n===xv.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var i,a;this.stateUpdatedCallback(n,{errcode:((i=this.data)===null||i===void 0?void 0:i.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(n,n===no?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),T.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return T.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(n=>!this.supportedStages.has(n)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],n=!!this.inputs.emailAddress||!!this.emailSid,i=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((d,h)=>this.scoreFlow(d)-this.scoreFlow(h));for(var a of t){var s=!1,o=!1;for(var l of a.stages)l===no?s=!0:l==US&&(o=!0);if(s==n&&o==i)return a}var u=[];throw n&&u.push(no),i&&u.push(US),new Sw("No appropriate authentication flow found",u,t)}firstUncompletedStage(e){var t,n=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(i=>!n.includes(i))}}function Ew(r,e){return new Promise((t,n)=>{var i=!0,a=r.open(e);a.onupgradeneeded=()=>{i=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{var s=a.result;s.close(),i||r.deleteDatabase(e),t(i)},a.onerror=()=>n(a.error)})}var _w=[r=>{r.createObjectStore("users",{keyPath:["userId"]}),r.createObjectStore("accountData",{keyPath:["type"]}),r.createObjectStore("sync",{keyPath:["clobber"]})},r=>{var e=r.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},r=>{r.createObjectStore("client_options",{keyPath:["clobber"]})},r=>{r.createObjectStore("to_device_queue",{autoIncrement:!0})}],vN=_w.length;function cu(r,e,t){var n=r.openCursor(e);return new Promise((i,a)=>{var s=[];n.onerror=()=>{var o;a(new Error("Query failed: "+((o=n.error)===null||o===void 0?void 0:o.name)))},n.onsuccess=()=>{var o=n.result;if(!o){i(s);return}s.push(t(o)),o.continue()}})}function ji(r){return new Promise((e,t)=>{r.oncomplete=function(n){e(n)},r.onerror=function(){t(r.error)}})}function bw(r){return new Promise((e,t)=>{r.onsuccess=function(n){e(n)},r.onerror=function(){t(r.error)}})}function pN(r){return new Promise((e,t)=>{r.onsuccess=()=>e(r),r.onerror=n=>t(n)})}function bh(r){return bw(r).then(e=>r.result)}class jS{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),Ew(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,c(this,"dbName",void 0),c(this,"syncAccumulator",void 0),c(this,"db",void 0),c(this,"disconnected",!0),c(this,"_isNewlyCreated",!1),c(this,"syncToDatabasePromise",void 0),c(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new gw}connect(e){var t=this;if(!this.disconnected)return T.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,T.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,vN);return n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;T.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(s)),s<1&&(this._isNewlyCreated=!0),_w.forEach((o,l)=>{s<=l&&o(a)})},n.onblocked=()=>{T.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},T.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),bw(n).then(w(function*(){T.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var i;(i=t.db)===null||i===void 0||i.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e==null||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,n]=e;T.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{var i=this.db.transaction(["oob_membership_events"],"readonly"),a=i.objectStore("oob_membership_events"),s=a.index("room"),o=IDBKeyRange.only(e),l=s.openCursor(o),u=[],d=!1;l.onsuccess=()=>{var h=l.result;if(!h)return!u.length&&!d?t(null):t(u);var f=h.value;f.oob_written?d=!0:u.push(f),h.continue()},l.onerror=h=>{n(h)}}).then(t=>(T.log("LL: got ".concat(t==null?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return w(function*(){T.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var i=n.db.transaction(["oob_membership_events"],"readwrite"),a=i.objectStore("oob_membership_events");t.forEach(o=>{a.put(o)});var s={room_id:e,oob_written:!0,state_key:0};a.put(s),yield ji(i),T.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return w(function*(){var n=t.db.transaction(["oob_membership_events"],"readonly"),i=n.objectStore("oob_membership_events"),a=i.index("room"),s=IDBKeyRange.only(e),o=bh(a.openKeyCursor(s,"next")).then(v=>(v==null?void 0:v.primaryKey)[1]),l=bh(a.openKeyCursor(s,"prev")).then(v=>(v==null?void 0:v.primaryKey)[1]),[u,d]=yield Promise.all([o,l]),h=t.db.transaction(["oob_membership_events"],"readwrite"),f=h.objectStore("oob_membership_events"),m=IDBKeyRange.bound([e,u],[e,d]);T.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,u],[e,d]),yield pN(f.delete(m))})()}clearDatabase(){return new Promise(e=>{var t;T.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{T.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},n.onerror=()=>{var i;T.warn("unable to delete js-sdk store indexeddb: ".concat((i=n.error)===null||i===void 0?void 0:i.name)),e()},n.onsuccess=()=>{T.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(bl(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return w(function*(){return t.syncToDatabasePromise?(T.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return w(function*(){try{var n=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(n.accountData),t.persistSyncData(n.nextBatch,n.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return T.log("Persisting sync data up to",e),_a(()=>{var n=this.db.transaction(["sync"],"readwrite"),i=n.objectStore("sync");return i.put({clobber:"-",nextBatch:e,roomsData:t}),ji(n).then(()=>{T.log("Persisted sync data up to",e)})})}persistAccountData(e){return _a(()=>{var t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(var i of e)n.put(i);return ji(t).then()})}persistUserPresenceEvents(e){return _a(()=>{var t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(var i of e)n.put({userId:i[0],event:i[1]});return ji(t).then()})}getUserPresenceEvents(){return _a(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return cu(t,void 0,n=>[n.value.userId,n.value.event])})}loadAccountData(){return T.log("LocalIndexedDBStoreBackend: loading account data..."),_a(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return cu(t,void 0,n=>n.value).then(n=>(T.log("LocalIndexedDBStoreBackend: loaded account data"),n))})}loadSyncData(){return T.log("LocalIndexedDBStoreBackend: loading sync data..."),_a(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return cu(t,void 0,n=>n.value).then(n=>(T.log("LocalIndexedDBStoreBackend: loaded sync data"),n.length>1&&T.warn("loadSyncData: More than 1 sync row found."),n.length>0?n[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return cu(t,void 0,n=>{var i;return(i=n.value)===null||i===void 0?void 0:i.options}).then(n=>n[0])})}storeClientOptions(e){var t=this;return w(function*(){var n=t.db.transaction(["client_options"],"readwrite"),i=n.objectStore("client_options");i.put({clobber:"-",options:e}),yield ji(n)})()}saveToDeviceBatches(e){var t=this;return w(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");for(var a of e)i.add(a);yield ji(n)})()}getOldestToDeviceBatch(){var e=this;return w(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),n=t.objectStore("to_device_queue"),i=yield bh(n.openCursor());if(!i)return null;var a=i.value;return{id:i.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return w(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");i.delete(e),yield ji(n)})()}destroy(){var e=this;return w(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class mN{constructor(e,t){this.workerFactory=e,this.dbName=t,c(this,"worker",void 0),c(this,"nextSeq",0),c(this,"inFlight",{}),c(this,"startPromise",void 0),c(this,"onWorkerMessage",n=>{var i=n.data;if(i.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(i.command=="cmd_success"||i.command=="cmd_fail"){if(i.seq===void 0){T.error("Got reply from worker with no seq");return}var s=this.inFlight[i.seq];if(s===void 0){T.error("Got reply for unknown seq "+i.seq);return}if(delete this.inFlight[i.seq],i.command=="cmd_success")s.resolve(i.result);else{var o=new Error(i.error.message);o.name=i.error.name,s.reject(o)}}else T.warn("Unrecognised message from worker: ",i)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return w(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return w(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return w(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{T.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var n,i=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[i]=a,(n=this.worker)===null||n===void 0||n.postMessage({command:e,seq:i,args:t}),a.promise})}destroy(){var e=this;return w(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var gN=1e3*60*5;class yN extends um{static exists(e,t){return jS.exists(e,t)}constructor(e){if(super(e),c(this,"backend",void 0),c(this,"startedUp",!1),c(this,"syncTs",0),c(this,"userModifiedMap",{}),c(this,"emitter",new nt),c(this,"onClose",()=>{this.emitter.emit("closed")}),c(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),c(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),c(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),c(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{T.log("Deleted indexeddb data.")},t=>{throw T.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),c(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var n of this.getUsers())this.userModifiedMap[n.userId]!==n.getLastModifiedTime()&&n.events.presence&&(t.push([n.userId,n.events.presence.event]),this.userModifiedMap[n.userId]=n.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),c(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),c(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),c(this,"setOutOfBandMembers",this.degradable((t,n)=>(super.setOutOfBandMembers(t,n),this.backend.setOutOfBandMembers(t,n)),"setOutOfBandMembers")),c(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),c(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),c(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new mN(e.workerFactory,e.dbName):this.backend=new jS(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(T.log("IndexedDBStore.startup: already started"),Promise.resolve()):(T.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(T.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{T.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[n,i]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(n);i&&a.setPresenceEvent(new zt(i)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>gN}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,i=t?super[t]:null;return w(function*(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];try{return yield e.call(n,...s)}catch(l){T.error("IndexedDBStore failure, degrading to MemoryStore",l),n.emitter.emit("degraded",l);try{T.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),T.log("IndexedDBStore delete after degrading succeeded")}catch(u){T.warn("IndexedDBStore delete after degrading failed",u)}if(i)return i.call(n,...s)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,n=this;return w(function*(){if(!n.localStorage)return t().call(n,e);var i=n.localStorage.getItem(wh(e));if(i)try{return JSON.parse(i)}catch(a){T.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var n=()=>super.setPendingEvents,i=this;return w(function*(){if(!i.localStorage)return n().call(i,e,t);t.length>0?i.localStorage.setItem(wh(e),JSON.stringify(t)):i.localStorage.removeItem(wh(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function wh(r){return"mx_pending_events_".concat(r)}var Qr="crypto.",FS=Qr+"migration",Th=Qr+"account",SN=Qr+"cross_signing_keys",ju=Qr+"inboundgroupsessions/",EN=Qr+"inboundgroupsessions.withheld/",_N=Qr+"rooms/",Rh=Qr+"sessionsneedingbackup";function Ca(r){return Qr+"sessions/"+r}function Ih(r,e){return ju+r+"/"+e}function bN(r,e){return EN+r+"/"+e}function wN(r){return _N+r}class wc extends ec{static exists(e){for(var t=e.length,n=0;n<t;n++){var i;if((i=e.key(n))!==null&&i!==void 0&&i.startsWith(Qr))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return w(function*(){return wc.exists(e.store)})()}getMigrationState(){var e=this;return w(function*(){var t;return(t=kr(e.store,FS))!==null&&t!==void 0?t:ys.NOT_STARTED})()}setMigrationState(e){var t=this;return w(function*(){Fi(t.store,FS,e)})()}countEndToEndSessions(e,t){for(var n=0,i=0;i<this.store.length;++i){var a=this.store.key(i);if(a!=null&&a.startsWith(Ca(""))){var s=kr(this.store,a);n+=Object.keys(s??{}).length}}t(n)}_getEndToEndSessions(e){var t=kr(this.store,Ca(e)),n={};for(var[i,a]of Object.entries(t||{}))typeof a=="string"?n[i]={session:a}:n[i]=a;return n}getEndToEndSession(e,t,n,i){var a,s=this._getEndToEndSessions(e);i((a=s[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,n){var i;n((i=this._getEndToEndSessions(e))!==null&&i!==void 0?i:{})}storeEndToEndSession(e,t,n,i){var a=this._getEndToEndSessions(e)||{};a[t]=n,Fi(this.store,Ca(e),a)}getEndToEndSessionsBatch(){var e=this;return w(function*(){for(var t=[],n=0;n<e.store.length;++n){var i;if((i=e.store.key(n))!==null&&i!==void 0&&i.startsWith(Ca(""))){var a=e.store.key(n).split("/")[1];for(var s of Object.values(e._getEndToEndSessions(a)))if(t.push(s),t.length>=Ss)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return w(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t._getEndToEndSessions(n)||{};delete a[i],Object.keys(a).length===0?t.store.removeItem(Ca(n)):Fi(t.store,Ca(n),a)}})()}getEndToEndInboundGroupSession(e,t,n,i){i(kr(this.store,Ih(e,t)),kr(this.store,bN(e,t)))}storeEndToEndInboundGroupSession(e,t,n,i){Fi(this.store,Ih(e,t),n)}countEndToEndInboundGroupSessions(){var e=this;return w(function*(){for(var t=0,n=0;n<e.store.length;++n){var i=e.store.key(n);i!=null&&i.startsWith(ju)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return w(function*(){for(var t=kr(e.store,Rh)||{},n=[],i=0;i<e.store.length;++i){var a=e.store.key(i);if(a!=null&&a.startsWith(ju)){var s=a.slice(ju.length);if(n.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:kr(e.store,a),needsBackup:s in t}),n.length>=Ss)return n}}return n.length===0?null:n})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return w(function*(){for(var{senderKey:n,sessionId:i}of e){var a=Ih(n,i);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var n={},i=wN(""),a=0;a<this.store.length;++a){var s=this.store.key(a);if(s!=null&&s.startsWith(i)){var o=s.slice(i.length);n[o]=kr(this.store,s)}}t(n)}markSessionsNeedingBackup(e){var t=kr(this.store,Rh)||{};for(var n of e)t[n.senderKey+"/"+n.sessionId]=!0;return Fi(this.store,Rh,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Th),Promise.resolve()}getAccount(e,t){var n=kr(this.store,Th);t(n)}storeAccount(e,t){Fi(this.store,Th,t)}getCrossSigningKeys(e,t){var n=kr(this.store,SN);t(n)}getSecretStorePrivateKey(e,t,n){var i=kr(this.store,Qr+"ssss_cache.".concat(n));t(i)}storeSecretStorePrivateKey(e,t,n){Fi(this.store,Qr+"ssss_cache.".concat(t),n)}doTxn(e,t,n){return Promise.resolve(n(null))}}function kr(r,e){try{return JSON.parse(r.getItem(e))}catch(t){T.log("Error: Failed to get key %s: %s",e,t.message),T.log(t.stack)}return null}function Fi(r,e,t){r.setItem(e,JSON.stringify(t))}class TN{constructor(e){this.db=e,c(this,"nextTxnId",0),e.onversionchange=()=>{T.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return w(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return w(function*(){return e})()}deleteAllData(){return w(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return w(function*(){var t=ys.NOT_STARTED;return yield e.doTxn("readonly",[Be.STORE_ACCOUNT],n=>{var i=n.objectStore(Be.STORE_ACCOUNT),a=i.get(Mf);a.onsuccess=()=>{var s;t=(s=a.result)!==null&&s!==void 0?s:ys.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return w(function*(){yield t.doTxn("readwrite",[Be.STORE_ACCOUNT],n=>{var i=n.objectStore(Be.STORE_ACCOUNT);i.put(e,Mf)})})()}getAccount(e,t){var n=e.objectStore("account"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}storeAccount(e,t){var n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){var n=e.objectStore("account"),i=n.get("crossSigningKeys");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}getSecretStorePrivateKey(e,t,n){var i=e.objectStore("account"),a=i.get("ssss_cache:".concat(n));a.onsuccess=function(){try{t(a.result||null)}catch(s){ir(e,s)}}}storeSecretStorePrivateKey(e,t,n){var i=e.objectStore("account");i.put(n,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var n=e.objectStore("sessions"),i=n.count();i.onsuccess=function(){try{t(i.result)}catch(a){ir(e,a)}}}getEndToEndSessions(e,t,n){var i=t.objectStore("sessions"),a=i.index("deviceKey"),s=a.openCursor(e),o={};s.onsuccess=function(){var l=s.result;if(l)o[l.value.sessionId]={session:l.value.session,lastReceivedMessageTs:l.value.lastReceivedMessageTs},l.continue();else try{n(o)}catch(u){ir(t,u)}}}getEndToEndSession(e,t,n,i){var a=n.objectStore("sessions"),s=a.get([e,t]);s.onsuccess=function(){try{s.result?i({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):i(null)}catch(o){ir(n,o)}}}storeEndToEndSession(e,t,n,i){var a=i.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return w(function*(){var t=[];return yield e.doTxn("readonly",[Be.STORE_SESSIONS],n=>{var i=n.objectStore(Be.STORE_SESSIONS),a=i.openCursor();a.onsuccess=function(){try{var s=a.result;s&&(t.push(s.value),t.length<Ss&&s.continue())}catch(o){ir(n,o)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return w(function*(){yield t.doTxn("readwrite",[Be.STORE_SESSIONS],function(){var n=w(function*(i){try{var a=i.objectStore(Be.STORE_SESSIONS),s=function*(){var d=a.delete([o,l]);yield new Promise(h=>{d.onsuccess=h})};for(var{deviceKey:o,sessionId:l}of e)yield*s()}catch(u){ir(i,u)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,n,i){var a=!1,s=!1,o=n.objectStore("inbound_group_sessions"),l=o.get([e,t]);l.onsuccess=function(){try{l.result?a=l.result.session:a=null,s!==!1&&i(a,s)}catch(h){ir(n,h)}};var u=n.objectStore("inbound_group_sessions_withheld"),d=u.get([e,t]);d.onsuccess=function(){try{d.result?s=d.result.session:s=null,a!==!1&&i(a,s)}catch(h){ir(n,h)}}}storeEndToEndInboundGroupSession(e,t,n,i){var a=i.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:n})}countEndToEndInboundGroupSessions(){var e=this;return w(function*(){var t=0;return yield e.doTxn("readonly",[Be.STORE_INBOUND_GROUP_SESSIONS],n=>{var i=n.objectStore(Be.STORE_INBOUND_GROUP_SESSIONS),a=i.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return w(function*(){var t=[];return yield e.doTxn("readonly",[Be.STORE_INBOUND_GROUP_SESSIONS,Be.STORE_BACKUP],n=>{var i=n.objectStore(Be.STORE_INBOUND_GROUP_SESSIONS),a=n.objectStore(Be.STORE_BACKUP),s=i.openCursor();s.onsuccess=function(){try{var o=s.result;if(o){var l=a.get(o.key);l.onsuccess=()=>{t.push({senderKey:o.value.senderCurve25519Key,sessionId:o.value.sessionId,sessionData:o.value.session,needsBackup:l.result!==void 0}),t.length<Ss&&o.continue()}}}catch(u){ir(n,u)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return w(function*(){yield t.doTxn("readwrite",[Be.STORE_INBOUND_GROUP_SESSIONS],function(){var n=w(function*(i){try{var a=i.objectStore(Be.STORE_INBOUND_GROUP_SESSIONS),s=function*(){var d=a.delete([o,l]);yield new Promise(h=>{d.onsuccess=h})};for(var{senderKey:o,sessionId:l}of e)yield*s()}catch(u){ir(i,u)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var n=e.objectStore("device_data"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}getEndToEndRooms(e,t){var n={},i=e.objectStore("rooms"),a=i.openCursor();a.onsuccess=function(){var s=a.result;if(s)n[s.key]=s.value,s.continue();else try{t(n)}catch(o){ir(e,o)}}}markSessionsNeedingBackup(e,t){var n=this;return w(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var i=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((s,o)=>{var l=i.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});l.onsuccess=s,l.onerror=o})))})()}doTxn(e,t,n){var i=this.db.transaction(t,e),a=CN(i),s=n(i);return a.then(()=>s)}}var ww=[r=>{IN(r)},r=>{r.createObjectStore("account")},r=>{var e=r.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},r=>{r.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("device_data")},r=>{r.createObjectStore("rooms")},r=>{r.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{var e=r.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),r.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},r=>{r.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r=>{r.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],Tw=ww.length;function RN(r,e){T.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(Tw)),ww.forEach((t,n)=>{e<=n&&t(r)})}function IN(r){var e=r.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function ir(r,e){r._mx_abortexception=e;try{r.abort()}catch{}}function CN(r){return new Promise((e,t)=>{r.oncomplete=()=>{r._mx_abortexception!==void 0&&t(r._mx_abortexception),e(null)},r.onerror=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(T.log("Error performing indexeddb txn",n),t(r.error))},r.onabort=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(T.log("Error performing indexeddb txn",n),t(r.error))}})}class Be{static exists(e,t){return Ew(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((n,i)=>{var a=!0,s=e.open(t);s.onupgradeneeded=()=>{a=!1},s.onblocked=()=>i(s.error),s.onsuccess=()=>{var o=s.result;if(!a)o.close(),e.deleteDatabase(t),n(!1);else{var l=o.transaction([Be.STORE_ACCOUNT],"readonly"),u=l.objectStore(Be.STORE_ACCOUNT),d=u.get(Mf);d.onsuccess=()=>{var h,f=(h=d.result)!==null&&h!==void 0?h:ys.NOT_STARTED;n(f===ys.NOT_STARTED)},d.onerror=()=>{i(d.error)},o.close()}},s.onerror=()=>i(s.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,c(this,"backendPromise",void 0),c(this,"backend",void 0)}containsData(){var e=this;return w(function*(){return Be.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}T.log("connecting to indexeddb ".concat(this.dbName));var n=this.indexedDB.open(this.dbName,Tw);n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;RN(a,s)},n.onblocked=()=>{T.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{T.log("Error connecting to indexeddb",i),t(n.error)},n.onsuccess=()=>{var i=n.result;T.log("connected to indexeddb ".concat(this.dbName)),e(new TN(i))}}).then(e=>e.doTxn("readonly",[Be.STORE_INBOUND_GROUP_SESSIONS,Be.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw T.warn("Crypto DB is too new for us to use!",e),new tm(em.TooNew);T.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new wc(globalThis.localStorage)}catch(t){return T.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new ec}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}T.log("Removing indexeddb instance: ".concat(this.dbName));var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{T.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{T.log("Error deleting data from indexeddb",i),t(n.error)},n.onsuccess=()=>{T.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{T.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}}c(Be,"STORE_ACCOUNT","account");c(Be,"STORE_SESSIONS","sessions");c(Be,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");c(Be,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");c(Be,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");c(Be,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");c(Be,"STORE_DEVICE_DATA","device_data");c(Be,"STORE_ROOMS","rooms");c(Be,"STORE_BACKUP","sessions_needing_backup");var ON=function(r){return r.Email="email",r.Phone="msisdn",r}({}),kN=new Et("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),PN=function(r){return r.Gitlab="gitlab",r.Github="github",r.Apple="apple",r.Google="google",r.Facebook="facebook",r.Twitter="twitter",r}({}),MN=function(r){return r.LOGIN="login",r.REGISTER="register",r}({}),AN="us.cloke.msc4175.tz";class DN{constructor(e){c(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}}var xN=function(r){return r.Global="Global",r.SetItemError="setItem",r.GetItemError="getItem",r.RemoveItemError="removeItem",r.ClearError="clear",r.QuotaExceededError="QuotaExceededError",r}({});class NN extends nt{}var LN=new NN,Rw=()=>new ec;function Iw(r){Rw=r}function Cw(r){var e,t,n;return r.store=(e=r.store)!==null&&e!==void 0?e:new um({localStorage:globalThis.localStorage}),r.scheduler=(t=r.scheduler)!==null&&t!==void 0?t:new Es,r.cryptoStore=(n=r.cryptoStore)!==null&&n!==void 0?n:Rw(),r}function Nv(r){return new mc(Cw(r))}function UN(r,e,t,n){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new mw(r,e,t,Cw(n),i)}const jN=Object.freeze(Object.defineProperty({__proto__:null,AuthType:xv,AutoDiscovery:Re,AutoDiscoveryAction:Er,AutoDiscoveryError:Fr,Beacon:h0,BeaconEvent:tt,CallEvent:Pe,CallFeedEvent:an,Category:wn,ClientEvent:ce,ClientPrefix:It,ClientStoppedError:CD,ConditionKind:wt,ConditionOperator:zA,ConnectionError:ga,ContentHelpers:yM,DELEGATED_OIDC_COMPATIBILITY:kN,DEVICE_CODE_SCOPE:ux,DMMemberCountCondition:JA,DebugLogger:Up,Device:dN,DeviceVerification:yw,Direction:ke,DuplicateStrategy:Io,EVENT_VISIBILITY_CHANGE_TYPE:Xi,EventEmitterEvents:xb,EventStatus:Se,EventTimeline:se,EventTimelineSet:Va,EventType:j,FILTER_RELATED_BY_REL_TYPES:ss,FILTER_RELATED_BY_SENDERS:as,FeatureSupport:Gt,Filter:sr,GET_LOGIN_TOKEN_CAPABILITY:px,GroupCall:zp,GroupCallEvent:Ye,GroupCallIntent:U0,GroupCallState:ut,GroupCallStatsReportEvent:uo,GroupCallType:cc,GuestAccess:Id,HTTPError:ha,HistoryVisibility:Xp,HttpApiEvent:ov,IdentityPrefix:bn,IdentityProviderBrand:PN,IndexedDBCryptoStore:Be,IndexedDBStore:yN,InteractiveAuth:fN,InvalidCryptoStoreError:tm,InvalidCryptoStoreState:em,JoinRule:F0,KNOWN_SAFE_ROOM_VERSION:R0,KeySignatureUploadError:ID,KnownMembership:Ie,LOCAL_NOTIFICATION_SETTINGS_PREFIX:jb,LocalStorageCryptoStore:wc,LocalStorageErrors:xN,LocationAssetType:ms,MAIN_ROOM_TIMELINE:_l,MAXIMUM_MATRIX_VERSION:rD,MINIMUM_MATRIX_VERSION:tD,MSC3912_RELATION_BASED_REDACTIONS_PROP:Lf,M_ASSET:Sl,M_BEACON:Sv,M_BEACON_INFO:Zp,M_HTML:cM,M_LOCATION:El,M_MESSAGE:dM,M_POLL_END:Td,M_POLL_KIND_DISCLOSED:EM,M_POLL_KIND_UNDISCLOSED:_M,M_POLL_RESPONSE:il,M_POLL_START:bM,M_TEXT:Bp,M_TIMESTAMP:Mi,M_TOPIC:$p,MatrixClient:mc,MatrixError:mt,MatrixEvent:zt,MatrixEventEvent:Ve,MatrixHttpApi:b0,MatrixScheduler:Es,MediaHandlerEvent:Gi,MediaPrefix:ts,MemoryCryptoStore:ec,MemoryStore:um,Method:V,MsgType:Sn,NoAuthFlowFoundError:Sw,NotificationCountType:We,OidcError:Ht,OidcTokenRefresher:cx,PUSHER_DEVICE_ID:DO,PUSHER_ENABLED:Uf,PendingEventOrdering:ws,Poll:p0,PollEvent:ni,Preset:Qp,ProfileKeyMSC4175Timezone:AN,PushRuleActionName:wi,PushRuleKind:xt,REFERENCE_RELATION:t0,ReceiptType:Xt,RelatedRelations:DN,RelationType:it,Relations:Fp,RelationsEvent:Pu,RestrictedAllowType:aD,Room:uc,RoomCreateTypeField:pd,RoomEvent:le,RoomMember:el,RoomMemberEvent:ur,RoomNameType:nn,RoomState:ul,RoomStateEvent:Ae,RoomSummary:Zb,RoomType:Za,RoomVersionStability:w0,RoomWidgetClient:mw,RoomWidgetClientEvent:Uu,RuleId:At,SERVICE_TYPES:gv,SSOAction:MN,SUPPORTED_MATRIX_VERSIONS:sl,SearchOrderBy:B0,SearchResult:hc,SecretStorage:TD,ServerCapabilities:T0,SetPresence:I0,SlidingSyncEvent:yv,StatsReport:An,SyncAccumulator:gw,SyncState:qe,THREAD_RELATION_TYPE:ze,Thread:Xe,ThreadEvent:Zt,ThreadFilterType:Kr,ThreepidMedium:ON,TimelineIndex:Dv,TimelineWindow:hN,ToDeviceMessageId:ic,TokenRefreshError:S0,TokenRefreshLogoutError:Vp,TweakName:Jp,TypedEventEmitter:nt,UNSIGNED_MEMBERSHIP_FIELD:Fb,UNSIGNED_THREAD_ID_FIELD:md,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Ub,UNSTABLE_MSC2666_MUTUAL_ROOMS:lw,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:uw,UNSTABLE_MSC2666_SHARED_ROOMS:ow,UNSTABLE_MSC2716_MARKER:Lb,UNSTABLE_MSC3088_ENABLED:xf,UNSTABLE_MSC3088_PURPOSE:Df,UNSTABLE_MSC3089_BRANCH:Cn,UNSTABLE_MSC3089_LEAF:Nb,UNSTABLE_MSC3089_TREE_SUBTYPE:Nf,UNSTABLE_MSC3852_LAST_SEEN_UA:vx,UNSTABLE_MSC4133_EXTENDED_PROFILES:dw,UNSTABLE_MSC4140_DELAYED_EVENTS:cn,UnsupportedDelayedEventsEndpointError:hi,UpdateDelayedEventAction:Mu,User:Ln,UserEvent:yr,Visibility:iD,anySignal:E0,calculateRetryBackoff:_0,completeAuthorizationCodeGrant:lx,createClient:Nv,createNewMatrixCall:al,createRoomWidgetClient:UN,decodeBase64:ra,decodeIdToken:nw,determineFeatureSupport:Nu,discoverAndValidateOIDCIssuerWellKnown:om,encodeBase64:Co,encodeUnpaddedBase64:N0,encodeUnpaddedBase64Url:dc,fixNotificationCountOnDecryption:cw,generateAuthorizationParams:ix,generateAuthorizationUrl:ax,generateOidcAuthorizationUrl:sx,generateScope:pc,getBeaconInfoIdentifier:wd,getHttpUriForMxc:tc,inMainTimelineForReceipt:ll,isDmMemberCountCondition:YA,isEventTypeSame:hM,isPollEvent:m0,isTimestampInDuration:av,localStorageErrorsEventsEmitter:LN,parseErrorResponse:Gp,registerOidcClient:dx,retryNetworkOperation:lv,safeGetRetryAfterMs:Kp,setCryptoStoreFactory:Iw,threadFilterTypeToFilter:hw,threadIdForReceipt:Ts,timeoutSignal:lc,validateAuthMetadata:rw,validateAuthMetadataAndKeys:lm,validateBearerTokenResponse:sw,validateIdToken:iw,validateStoredUserState:aw},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var Lv;try{Lv=globalThis.indexedDB}catch{}Lv&&Iw(()=>new Be(Lv,"matrix-js-sdk:crypto"));globalThis.matrixcs=jN;function FN(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}function BN(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)/i);return r?decodeURIComponent(r[1]):null}const BS=()=>new Date().toLocaleTimeString(),Ch=r=>({0:"Unsent",1:"Requested",2:"Ready",3:"Started",4:"WaitingForDone",5:"Done",6:"Cancelled"})[r]??String(r),$N=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);function WN(){const e=gl().orgId||BN(),t=FN(`bf_matrix_${e}`,null),[n,i]=G.useState(""),[a,s]=G.useState(""),[o,l]=G.useState(""),[u,d]=G.useState((t==null?void 0:t.userId)||""),[h,f]=G.useState((t==null?void 0:t.accessToken)||""),[m,v]=G.useState((t==null?void 0:t.deviceId)||""),[y,I]=G.useState(""),[g,p]=G.useState(!1),[b,R]=G.useState(!1),[P,E]=G.useState(null),[C,S]=G.useState(""),[x,K]=G.useState([]),[z,oe]=G.useState(""),[ge,xe]=G.useState(null),[_e,Me]=G.useState(null),[je,re]=G.useState([]),[he,ye]=G.useState(null),[Ne,J]=G.useState([]),[te,L]=G.useState(""),D=G.useRef(null),A=G.useRef(null),M=(...Q)=>I(`[${BS()}] ${Q.join(" ")}`);G.useEffect(()=>{if(!(t!=null&&t.hsUrl)||!u||!h)return;const Q=Nv({baseUrl:t.hsUrl,accessToken:h,userId:u,deviceId:m||void 0});D.current=Q,M("Connecting"),(async()=>{var Ge,_t,Ue,Lt;try{typeof Q.initRustCrypto=="function"?await Q.initRustCrypto():typeof Q.initCrypto=="function"&&await Q.initCrypto(),R(!0)}catch(q){R(!1),M("Crypto init failed:",(q==null?void 0:q.message)||q)}Q.on("sync",q=>{q==="PREPARED"&&(p(!0),Ce(),be(),N())});const de=(Ge=Q.getCrypto)==null?void 0:Ge.call(Q),X=q=>{E(q),S(`${(q==null?void 0:q.otherUserId)||""}  ${(q==null?void 0:q.otherDeviceId)||""}`),M("Verification request:",q==null?void 0:q.otherUserId,q==null?void 0:q.otherDeviceId,`(phase ${Ch(q==null?void 0:q.phase)})`),k(q)};(_t=Q.on)==null||_t.call(Q,"crypto.verification.request",X),(Ue=de==null?void 0:de.on)==null||Ue.call(de,"verification.request",X),(Lt=Q.on)==null||Lt.call(Q,"toDeviceEvent",q=>{var W,H,ee,ve,me;if(((W=q.getType)==null?void 0:W.call(q))!=="m.key.verification.request")return;const Y=(H=q.getSender)==null?void 0:H.call(q),B=(ve=(ee=q.getContent)==null?void 0:ee.call(q))==null?void 0:ve.transaction_id;try{const De=(me=Q.getVerificationRequest)==null?void 0:me.call(Q,Y,B);De&&X(De)}catch{}}),Q.on("Room.timeline",(q,Y,B)=>{B||!he||Y.roomId!==he||q.getType()==="m.room.message"&&J(W=>{var H,ee;return[...W,{id:q.getId(),body:((H=q.getContent())==null?void 0:H.body)||"",sender:q.getSender(),ts:q.getTs(),encrypted:!!((ee=q.isEncrypted)!=null&&ee.call(q))}]})}),Q.startClient({initialSyncLimit:30});async function Ce(){const q=Q.getVisibleRooms().filter(Y=>["join","invite"].includes(Y.getMyMembership())).sort((Y,B)=>(B.getLastActiveTimestamp()||0)-(Y.getLastActiveTimestamp()||0));re(q.map(Y=>{var B;return{id:Y.roomId,name:Y.name||Y.getCanonicalAlias()||Y.roomId,encrypted:(B=Y.isEncrypted)==null?void 0:B.call(Y)}}))}async function be(){var q;try{const Y=await((q=Q.getDevices)==null?void 0:q.call(Q)),B=((Y==null?void 0:Y.devices)||[]).filter(W=>W.device_id!==Q.getDeviceId());K(B.map(W=>({device_id:W.device_id,display_name:W.display_name||""})))}catch{}}})()},[t==null?void 0:t.hsUrl,u,h,m]);function k(Q){var de;Q&&((de=Q.on)==null||de.call(Q,"change",()=>{I(`[${BS()}] Verification phase: ${Ch(Q.phase)}`),(Q.phase>=5||Q.phase===6)&&(xe(null),Me(null),A.current=null,E(null),S(""))}))}async function U(){var de,X,Ce;const Q=P;if(Q)try{await Q.accept();const be=Q.beginKeyVerification("sas");A.current=be,(de=be.on)==null||de.call(be,"show_sas",Ge=>{var _t,Ue;try{const Lt=((_t=be.getEmoji)==null?void 0:_t.call(be))||(Ge==null?void 0:Ge.emoji);if(Lt&&Array.isArray(Lt)&&Lt.length){const q=Lt.map(Y=>Array.isArray(Y)?Y:[(Y==null?void 0:Y.emoji)||"",(Y==null?void 0:Y.description)||""]);xe(q),Me(null)}else{const q=((Ue=be.getDecimals)==null?void 0:Ue.call(be))||(Ge==null?void 0:Ge.decimal)||(Ge==null?void 0:Ge.sas);q&&Array.isArray(q)&&Me(q)}}catch{}}),(X=be.on)==null||X.call(be,"cancel",()=>{xe(null),Me(null),A.current=null,E(null),S(""),M("Verification cancelled")}),(Ce=be.on)==null||Ce.call(be,"verified",()=>{xe(null),Me(null),A.current=null,E(null),S(""),M("Device verified ")}),await be.verify()}catch(be){M("Could not begin SAS:",(be==null?void 0:be.message)||be)}}async function O(){var de;const Q=A.current;if(Q)try{(de=Q.confirm)==null||de.call(Q),M("Confirmed SAS match; waiting for other device")}catch(X){M("Confirm failed:",(X==null?void 0:X.message)||X)}}async function F(){var de;const Q=A.current;if(Q)try{await((de=Q.cancel)==null?void 0:de.call(Q)),xe(null),Me(null),A.current=null,E(null),S(""),M("Verification cancelled")}catch(X){M("Cancel failed:",(X==null?void 0:X.message)||X)}}async function N(){var de,X,Ce;const Q=D.current;if(Q)try{const be=((Ce=(X=(de=Q.getCrypto)==null?void 0:de.call(Q))==null?void 0:X.getRequests)==null?void 0:Ce.call(X))||[],Ge=Array.isArray(be)?be:[];if(Ge.length){const _t=Ge.filter(Ue=>(Ue==null?void 0:Ue.otherUserId)===Q.getUserId());if(_t.length){const Ue=_t[_t.length-1];E(Ue),S(`${(Ue==null?void 0:Ue.otherUserId)||""}  ${(Ue==null?void 0:Ue.otherDeviceId)||""}`),k(Ue);return}}M("No pending verification requests")}catch(be){M("Scan failed:",(be==null?void 0:be.message)||be)}}async function $(Q){const de=D.current;if(!(!de||!Q))try{const X=$N(),Ce=new URL("/_matrix/client/v3/sendToDevice/m.key.verification.request/"+encodeURIComponent(X),de.baseUrl).toString(),be={messages:{[de.getUserId()]:{[Q]:{from_device:de.getDeviceId(),transaction_id:X,methods:["m.sas.v1"],timestamp:Date.now()}}}},Ge=await fetch(Ce,{method:"PUT",headers:{Authorization:`Bearer ${de.getAccessToken()}`,"Content-Type":"application/json"},body:JSON.stringify(be)});if(!Ge.ok){const _t=await Ge.text().catch(()=>"");throw new Error(`HTTP ${Ge.status} ${Ge.statusText}  ${_t.slice(0,200)}`)}M("Sent manual verification request to",Q)}catch(X){M("Manual request failed:",(X==null?void 0:X.message)||X)}}const Z=async Q=>{Q.preventDefault();try{const de=n.trim(),X=a.trim(),be=await Nv({baseUrl:de}).login("m.login.password",{identifier:{type:"m.id.user",user:X},password:o});d(be.user_id),f(be.access_token),v(be.device_id||""),localStorage.setItem(`bf_matrix_${e}`,JSON.stringify({hsUrl:de,userId:be.user_id,accessToken:be.access_token,deviceId:be.device_id||""})),l(""),window.location.hash=window.location.hash}catch(de){M("Login failed:",(de==null?void 0:de.message)||"Unknown error")}},fe=()=>{try{localStorage.removeItem(`bf_matrix_${e}`)}catch{}d(""),f(""),v(""),p(!1),R(!1),E(null),S(""),xe(null),Me(null),K([]),re([]),J([]),L(""),D.current&&(D.current.stopClient(),D.current.removeAllListeners(),D.current=null),M("Logged out")},ae=async Q=>{var Ge,_t;ye(Q),J([]);const de=D.current;if(!de)return;const X=de.getRoom(Q);if(!X)return;const Ce=(Ge=X.getLiveTimeline)==null?void 0:Ge.call(X),be=(((_t=Ce==null?void 0:Ce.getEvents)==null?void 0:_t.call(Ce))||[]).filter(Ue=>Ue.getType()==="m.room.message");J(be.map(Ue=>{var Lt,q;return{id:Ue.getId(),body:((Lt=Ue.getContent())==null?void 0:Lt.body)||"",sender:Ue.getSender(),ts:Ue.getTs(),encrypted:!!((q=Ue.isEncrypted)!=null&&q.call(Ue))}}))},Ke=async Q=>{Q.preventDefault();const de=D.current;if(!(!de||!he||!te.trim()))try{await de.sendEvent(he,"m.room.message",{msgtype:"m.text",body:te.trim()},""),L("")}catch(X){M("Send failed:",(X==null?void 0:X.message)||"Unknown error")}},Ee=async()=>{var de,X;const Q=D.current;if(Q)try{await((X=(de=Q.crypto)==null?void 0:de.requestRoomKey)==null?void 0:X.call(de)),M("Key re-request sent")}catch(Ce){M("Failed to re-request keys:",(Ce==null?void 0:Ce.message)||Ce)}},ue=!!(t!=null&&t.hsUrl&&u&&h),Fe=G.useMemo(()=>je.find(Q=>Q.id===he)||null,[je,he]);return _.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[_.jsxs("header",{style:{display:"flex",alignItems:"center",gap:8,marginTop:0,borderBottom:"1px solid #222",paddingBottom:12},children:[_.jsx("button",{className:"btn",onClick:fe,children:"Logout"}),_.jsx("button",{className:"btn",onClick:Ee,children:"Re-request keys"}),_.jsx("button",{className:"btn",onClick:N,children:"Scan for requests"}),_.jsx("div",{className:"helper",style:{marginLeft:"auto"},children:y})]}),ue&&_.jsxs("div",{className:"helper",style:{marginTop:8},children:[_.jsx("strong",{children:"Signed in as:"})," ",u,"  ",_.jsx("strong",{children:"Device:"})," ",m||"(loading)"," ",b?"":""]}),P&&(ge||_e)&&_.jsxs("div",{className:"card",style:{padding:12,marginTop:12,border:"2px solid #10b981"},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Compare the emojis on both devices, then confirm"}),ge?_.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"},children:ge.map(([Q,de],X)=>_.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:56},children:[_.jsx("div",{style:{fontSize:28,lineHeight:1},children:Q}),_.jsx("div",{style:{fontSize:11,opacity:.8},children:de})]},X))}):_.jsxs("div",{className:"helper",children:["Code: ",Array.isArray(_e)?_e.join(" "):String(_e)]}),_.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[_.jsx("button",{className:"btn",onClick:O,children:"Confirm match"}),_.jsx("button",{className:"btn",onClick:F,children:"Cancel"})]}),_.jsxs("div",{className:"helper",style:{marginTop:8},children:["Pending from: ",C]})]}),ue?_.jsxs(_.Fragment,{children:[_.jsxs("div",{className:"card",style:{padding:12,marginTop:12},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Your other devices"}),x.length===0?_.jsx("div",{className:"helper",children:"Open Element with the same account, accept the request there or click Scan for requests here. If nothing arrives, type the Element device ID below and click Manual request."}):_.jsx("ul",{style:{paddingLeft:18},children:x.map(Q=>_.jsxs("li",{style:{marginBottom:6},children:[_.jsx("strong",{children:Q.device_id}),Q.display_name?`  ${Q.display_name}`:"",_.jsx("button",{className:"btn",style:{marginLeft:8},onClick:()=>$(Q.device_id),children:"Manual request (to device)"})]},Q.device_id))}),_.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[_.jsx("input",{className:"input",placeholder:"Or type Element device ID",value:z,onChange:Q=>oe(Q.target.value)}),_.jsx("button",{className:"btn",onClick:()=>z&&$(z),children:"Manual request"}),P&&_.jsx("button",{className:"btn",onClick:U,children:"Accept & Start SAS"})]}),C&&_.jsxs("div",{className:"helper",style:{marginTop:8},children:["Pending from: ",C," ",P?`(phase: ${Ch(P.phase)})`:""]})]}),_.jsxs("div",{style:{display:"grid",gridTemplateColumns:"280px 1fr",gap:12,marginTop:12},children:[_.jsxs("aside",{className:"card",style:{padding:12,minHeight:420},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Rooms"}),_.jsxs("ul",{style:{paddingLeft:18},children:[je.map(Q=>_.jsx("li",{children:_.jsxs("a",{href:"#",onClick:de=>{de.preventDefault(),ae(Q.id)},children:[Q.name,Q.encrypted?" ":""]})},Q.id)),je.length===0&&_.jsx("li",{className:"helper",children:"No rooms yet."})]})]}),_.jsxs("main",{className:"card",style:{padding:12,minHeight:420,display:"flex",flexDirection:"column"},children:[_.jsx("div",{style:{display:"flex",alignItems:"center",gap:8},children:_.jsxs("h3",{className:"section-title",style:{marginTop:0,marginBottom:8,flex:1},children:[Fe?Fe.name:"Select a room",Fe!=null&&Fe.encrypted?" ":""]})}),_.jsx("div",{style:{flex:1,overflow:"auto",border:"1px solid #222",borderRadius:8,padding:8},children:Ne.length===0?_.jsx("div",{className:"helper",children:"No messages yet."}):Ne.sort((Q,de)=>Q.ts-de.ts).map(Q=>_.jsxs("div",{style:{marginBottom:8},children:[_.jsxs("div",{style:{fontSize:12,color:"#6b7280"},children:[Q.sender,"  ",new Date(Q.ts).toLocaleString()," ",Q.encrypted?"":""]}),_.jsx("div",{children:Q.body})]},Q.id))}),_.jsxs("form",{onSubmit:Ke,className:"row",style:{gap:8,marginTop:8},children:[_.jsx("input",{className:"input",placeholder:Fe?"Type a message":"Pick or create a room first",value:te,onChange:Q=>L(Q.target.value),disabled:!Fe}),_.jsx("button",{className:"btn",disabled:!Fe||!te.trim(),children:"Send"})]})]})]})]}):_.jsxs("section",{className:"card",style:{marginTop:12,padding:12},children:[_.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Sign in to your Matrix homeserver"}),_.jsxs("form",{onSubmit:Z,className:"grid",style:{gap:8,maxWidth:520},children:[_.jsx("input",{className:"input",placeholder:"Homeserver base URL (e.g. https://matrix.org)",value:n,onChange:Q=>i(Q.target.value),required:!0}),_.jsx("input",{className:"input",placeholder:"Username (localpart, without @ and domain)",value:a,onChange:Q=>s(Q.target.value),required:!0}),_.jsx("input",{className:"input",type:"password",placeholder:"Password",value:o,onChange:Q=>l(Q.target.value),required:!0}),_.jsx("button",{className:"btn",children:"Login"})]})]})]})}class KN extends $v.Component{constructor(e){super(e),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,t){console.error("App error boundary:",e,t)}render(){return this.state.error?_.jsxs("div",{style:{padding:16},children:[_.jsx("h2",{style:{color:"crimson"},children:"Something broke."}),_.jsx("pre",{style:{whiteSpace:"pre-wrap"},children:String(this.state.error)})]}):this.props.children}}function VN({children:r}){const e=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),t=localStorage.getItem("demo_user");return!e&&!t?_.jsx(ub,{to:"/orgs",replace:!0}):r}function GN(){const e=ma().pathname||"/",t=e==="/"||e==="/orgs"||e.startsWith("/p/");return _.jsxs(_.Fragment,{children:[!t&&_.jsx(bC,{}),_.jsxs(JI,{children:[_.jsx(Vt,{path:"/p/:slug",element:_.jsx(cd,{})}),_.jsx(Vt,{path:"/p/*",element:_.jsx(cd,{})}),_.jsx(Vt,{path:"/",element:_.jsx(xg,{})}),_.jsx(Vt,{path:"/orgs",element:_.jsx(xg,{})}),_.jsxs(Vt,{path:"/org/:orgId/*",element:_.jsx(VN,{children:_.jsx(RC,{})}),children:[_.jsx(Vt,{index:!0,element:_.jsx(Ag,{})}),_.jsx(Vt,{path:"overview",element:_.jsx(Ag,{})}),_.jsx(Vt,{path:"people",element:_.jsx(FC,{})}),_.jsx(Vt,{path:"inventory",element:_.jsx($C,{})}),_.jsx(Vt,{path:"needs",element:_.jsx(GC,{})}),_.jsx(Vt,{path:"meetings",element:_.jsx(KC,{})}),_.jsx(Vt,{path:"settings",element:_.jsx(zC,{})}),_.jsx(Vt,{path:"public",element:_.jsx(yC,{})}),"   ",_.jsx(Vt,{path:"chat",element:_.jsx(WN,{})})]}),_.jsx(Vt,{path:"*",element:_.jsx(ub,{to:"/orgs",replace:!0})})]})]})}function qN(){return _.jsx(nC,{children:_.jsx(KN,{children:_.jsx(GN,{})})})}const Ow=new Date().toISOString()+" #"+Math.floor(Math.random()*1e6);console.log("BOND build:",Ow);window.__BF_BUILD=Ow;Z_(document.getElementById("root")).render(_.jsx($v.StrictMode,{children:_.jsx(qN,{})}));export{XN as A,i1 as B,Mt as C,ED as D,j as E,Be as F,ys as G,Xp as H,t1 as I,bD as J,Ie as K,YN as L,V as M,qi as S,nt as T,ZN as U,w as _,c as a,QN as b,ic as c,ra as d,ie as e,_0 as f,Ad as g,yw as h,dN as i,xs as j,Sn as k,JN as l,mt as m,It as n,CD as o,Co as p,tc as q,e1 as r,wl as s,r1 as t,bi as u,Ve as v,Nn as w,yS as x,nS as y,n1 as z};
