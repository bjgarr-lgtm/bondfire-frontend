var cC=Object.defineProperty;var o=(r,e)=>cC(r,"name",{value:e,configurable:!0});function hC(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const i in n)if(i!=="default"&&!(i in r)){const a=Object.getOwnPropertyDescriptor(n,i);a&&Object.defineProperty(r,i,a.get?a:{enumerable:!0,get:o(()=>n[i],"get")})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}o(hC,"_mergeNamespaces");o(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}o(t,"getFetchOpts");function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}o(n,"processPreload")},"polyfill")();var fC=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function th(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}o(th,"getDefaultExportFromCjs");var K0={exports:{}},rh={},V0={exports:{}},Me={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Zl=Symbol.for("react.element"),vC=Symbol.for("react.portal"),pC=Symbol.for("react.fragment"),mC=Symbol.for("react.strict_mode"),gC=Symbol.for("react.profiler"),yC=Symbol.for("react.provider"),SC=Symbol.for("react.context"),EC=Symbol.for("react.forward_ref"),_C=Symbol.for("react.suspense"),bC=Symbol.for("react.memo"),wC=Symbol.for("react.lazy"),pE=Symbol.iterator;function TC(r){return r===null||typeof r!="object"?null:(r=pE&&r[pE]||r["@@iterator"],typeof r=="function"?r:null)}o(TC,"A$1");var q0={isMounted:o(function(){return!1},"isMounted"),enqueueForceUpdate:o(function(){},"enqueueForceUpdate"),enqueueReplaceState:o(function(){},"enqueueReplaceState"),enqueueSetState:o(function(){},"enqueueSetState")},G0=Object.assign,H0={};function to(r,e,t){this.props=r,this.context=e,this.refs=H0,this.updater=t||q0}o(to,"E$1");to.prototype.isReactComponent={};to.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")};to.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function z0(){}o(z0,"F");z0.prototype=to.prototype;function zm(r,e,t){this.props=r,this.context=e,this.refs=H0,this.updater=t||q0}o(zm,"G$1");var Jm=zm.prototype=new z0;Jm.constructor=zm;G0(Jm,to.prototype);Jm.isPureReactComponent=!0;var mE=Array.isArray,J0=Object.prototype.hasOwnProperty,Qm={current:null},Q0={key:!0,ref:!0,__self:!0,__source:!0};function Y0(r,e,t){var n,i={},a=null,s=null;if(e!=null)for(n in e.ref!==void 0&&(s=e.ref),e.key!==void 0&&(a=""+e.key),e)J0.call(e,n)&&!Q0.hasOwnProperty(n)&&(i[n]=e[n]);var l=arguments.length-2;if(l===1)i.children=t;else if(1<l){for(var u=Array(l),d=0;d<l;d++)u[d]=arguments[d+2];i.children=u}if(r&&r.defaultProps)for(n in l=r.defaultProps,l)i[n]===void 0&&(i[n]=l[n]);return{$$typeof:Zl,type:r,key:a,ref:s,props:i,_owner:Qm.current}}o(Y0,"M$1");function RC(r,e){return{$$typeof:Zl,type:r.type,key:e,ref:r.ref,props:r.props,_owner:r._owner}}o(RC,"N$1");function Ym(r){return typeof r=="object"&&r!==null&&r.$$typeof===Zl}o(Ym,"O$1");function IC(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}o(IC,"escape");var gE=/\/+/g;function $h(r,e){return typeof r=="object"&&r!==null&&r.key!=null?IC(""+r.key):e.toString(36)}o($h,"Q$1");function Xu(r,e,t,n,i){var a=typeof r;(a==="undefined"||a==="boolean")&&(r=null);var s=!1;if(r===null)s=!0;else switch(a){case"string":case"number":s=!0;break;case"object":switch(r.$$typeof){case Zl:case vC:s=!0}}if(s)return s=r,i=i(s),r=n===""?"."+$h(s,0):n,mE(i)?(t="",r!=null&&(t=r.replace(gE,"$&/")+"/"),Xu(i,e,t,"",function(d){return d})):i!=null&&(Ym(i)&&(i=RC(i,t+(!i.key||s&&s.key===i.key?"":(""+i.key).replace(gE,"$&/")+"/")+r)),e.push(i)),1;if(s=0,n=n===""?".":n+":",mE(r))for(var l=0;l<r.length;l++){a=r[l];var u=n+$h(a,l);s+=Xu(a,e,t,u,i)}else if(u=TC(r),typeof u=="function")for(r=u.call(r),l=0;!(a=r.next()).done;)a=a.value,u=n+$h(a,l++),s+=Xu(a,e,t,u,i);else if(a==="object")throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return s}o(Xu,"R$2");function _u(r,e,t){if(r==null)return r;var n=[],i=0;return Xu(r,n,"","",function(a){return e.call(t,a,i++)}),n}o(_u,"S$1");function CC(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}o(CC,"T$1");var tr={current:null},Zu={transition:null},OC={ReactCurrentDispatcher:tr,ReactCurrentBatchConfig:Zu,ReactCurrentOwner:Qm};function X0(){throw Error("act(...) is not supported in production builds of React.")}o(X0,"X$1");Me.Children={map:_u,forEach:o(function(r,e,t){_u(r,function(){e.apply(this,arguments)},t)},"forEach"),count:o(function(r){var e=0;return _u(r,function(){e++}),e},"count"),toArray:o(function(r){return _u(r,function(e){return e})||[]},"toArray"),only:o(function(r){if(!Ym(r))throw Error("React.Children.only expected to receive a single React element child.");return r},"only")};Me.Component=to;Me.Fragment=pC;Me.Profiler=gC;Me.PureComponent=zm;Me.StrictMode=mC;Me.Suspense=_C;Me.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=OC;Me.act=X0;Me.cloneElement=function(r,e,t){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var n=G0({},r.props),i=r.key,a=r.ref,s=r._owner;if(e!=null){if(e.ref!==void 0&&(a=e.ref,s=Qm.current),e.key!==void 0&&(i=""+e.key),r.type&&r.type.defaultProps)var l=r.type.defaultProps;for(u in e)J0.call(e,u)&&!Q0.hasOwnProperty(u)&&(n[u]=e[u]===void 0&&l!==void 0?l[u]:e[u])}var u=arguments.length-2;if(u===1)n.children=t;else if(1<u){l=Array(u);for(var d=0;d<u;d++)l[d]=arguments[d+2];n.children=l}return{$$typeof:Zl,type:r.type,key:i,ref:a,props:n,_owner:s}};Me.createContext=function(r){return r={$$typeof:SC,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:yC,_context:r},r.Consumer=r};Me.createElement=Y0;Me.createFactory=function(r){var e=Y0.bind(null,r);return e.type=r,e};Me.createRef=function(){return{current:null}};Me.forwardRef=function(r){return{$$typeof:EC,render:r}};Me.isValidElement=Ym;Me.lazy=function(r){return{$$typeof:wC,_payload:{_status:-1,_result:r},_init:CC}};Me.memo=function(r,e){return{$$typeof:bC,type:r,compare:e===void 0?null:e}};Me.startTransition=function(r){var e=Zu.transition;Zu.transition={};try{r()}finally{Zu.transition=e}};Me.unstable_act=X0;Me.useCallback=function(r,e){return tr.current.useCallback(r,e)};Me.useContext=function(r){return tr.current.useContext(r)};Me.useDebugValue=function(){};Me.useDeferredValue=function(r){return tr.current.useDeferredValue(r)};Me.useEffect=function(r,e){return tr.current.useEffect(r,e)};Me.useId=function(){return tr.current.useId()};Me.useImperativeHandle=function(r,e,t){return tr.current.useImperativeHandle(r,e,t)};Me.useInsertionEffect=function(r,e){return tr.current.useInsertionEffect(r,e)};Me.useLayoutEffect=function(r,e){return tr.current.useLayoutEffect(r,e)};Me.useMemo=function(r,e){return tr.current.useMemo(r,e)};Me.useReducer=function(r,e,t){return tr.current.useReducer(r,e,t)};Me.useRef=function(r){return tr.current.useRef(r)};Me.useState=function(r){return tr.current.useState(r)};Me.useSyncExternalStore=function(r,e,t){return tr.current.useSyncExternalStore(r,e,t)};Me.useTransition=function(){return tr.current.useTransition()};Me.version="18.3.1";V0.exports=Me;var W=V0.exports;const Xm=th(W),kC=hC({__proto__:null,default:Xm},[W]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var PC=W,MC=Symbol.for("react.element"),AC=Symbol.for("react.fragment"),xC=Object.prototype.hasOwnProperty,DC=PC.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,NC={key:!0,ref:!0,__self:!0,__source:!0};function Z0(r,e,t){var n,i={},a=null,s=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(s=e.ref);for(n in e)xC.call(e,n)&&!NC.hasOwnProperty(n)&&(i[n]=e[n]);if(r&&r.defaultProps)for(n in e=r.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:MC,type:r,key:a,ref:s,props:i,_owner:DC.current}}o(Z0,"q");rh.Fragment=AC;rh.jsx=Z0;rh.jsxs=Z0;K0.exports=rh;var E=K0.exports,ew={exports:{}},Tr={},tw={exports:{}},rw={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(r){function e(Y,le){var me=Y.length;Y.push(le);e:for(;0<me;){var we=me-1>>>1,j=Y[we];if(0<i(j,le))Y[we]=le,Y[me]=j,me=we;else break e}}o(e,"f");function t(Y){return Y.length===0?null:Y[0]}o(t,"h");function n(Y){if(Y.length===0)return null;var le=Y[0],me=Y.pop();if(me!==le){Y[0]=me;e:for(var we=0,j=Y.length,Q=j>>>1;we<Q;){var N=2*(we+1)-1,D=Y[N],x=N+1,A=Y[x];if(0>i(D,me))x<j&&0>i(A,D)?(Y[we]=A,Y[x]=me,we=x):(Y[we]=D,Y[N]=me,we=N);else if(x<j&&0>i(A,me))Y[we]=A,Y[x]=me,we=x;else break e}}return le}o(n,"k");function i(Y,le){var me=Y.sortIndex-le.sortIndex;return me!==0?me:Y.id-le.id}if(o(i,"g"),typeof performance=="object"&&typeof performance.now=="function"){var a=performance;r.unstable_now=function(){return a.now()}}else{var s=Date,l=s.now();r.unstable_now=function(){return s.now()-l}}var u=[],d=[],c=1,h=null,v=3,g=!1,p=!1,m=!1,T=typeof setTimeout=="function"?setTimeout:null,y=typeof clearTimeout=="function"?clearTimeout:null,S=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function w(Y){for(var le=t(d);le!==null;){if(le.callback===null)n(d);else if(le.startTime<=Y)n(d),le.sortIndex=le.expirationTime,e(u,le);else break;le=t(d)}}o(w,"G");function C(Y){if(m=!1,w(Y),!p)if(t(u)!==null)p=!0,$e(M);else{var le=t(d);le!==null&&re(C,le.startTime-Y)}}o(C,"H");function M(Y,le){p=!1,m&&(m=!1,y(b),b=-1),g=!0;var me=v;try{for(w(le),h=t(u);h!==null&&(!(h.expirationTime>le)||Y&&!z());){var we=h.callback;if(typeof we=="function"){h.callback=null,v=h.priorityLevel;var j=we(h.expirationTime<=le);le=r.unstable_now(),typeof j=="function"?h.callback=j:h===t(u)&&n(u),w(le)}else n(u);h=t(u)}if(h!==null)var Q=!0;else{var N=t(d);N!==null&&re(C,N.startTime-le),Q=!1}return Q}finally{h=null,v=me,g=!1}}o(M,"J");var _=!1,O=null,b=-1,F=5,V=-1;function z(){return!(r.unstable_now()-V<F)}o(z,"M");function ie(){if(O!==null){var Y=r.unstable_now();V=Y;var le=!0;try{le=O(!0,Y)}finally{le?se():(_=!1,O=null)}}else _=!1}o(ie,"R");var se;if(typeof S=="function")se=o(function(){S(ie)},"S");else if(typeof MessageChannel<"u"){var Pe=new MessageChannel,Ce=Pe.port2;Pe.port1.onmessage=ie,se=o(function(){Ce.postMessage(null)},"S")}else se=o(function(){T(ie,0)},"S");function $e(Y){O=Y,_||(_=!0,se())}o($e,"I");function re(Y,le){b=T(function(){Y(r.unstable_now())},le)}o(re,"K"),r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(Y){Y.callback=null},r.unstable_continueExecution=function(){p||g||(p=!0,$e(M))},r.unstable_forceFrameRate=function(Y){0>Y||125<Y?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):F=0<Y?Math.floor(1e3/Y):5},r.unstable_getCurrentPriorityLevel=function(){return v},r.unstable_getFirstCallbackNode=function(){return t(u)},r.unstable_next=function(Y){switch(v){case 1:case 2:case 3:var le=3;break;default:le=v}var me=v;v=le;try{return Y()}finally{v=me}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(Y,le){switch(Y){case 1:case 2:case 3:case 4:case 5:break;default:Y=3}var me=v;v=Y;try{return le()}finally{v=me}},r.unstable_scheduleCallback=function(Y,le,me){var we=r.unstable_now();switch(typeof me=="object"&&me!==null?(me=me.delay,me=typeof me=="number"&&0<me?we+me:we):me=we,Y){case 1:var j=-1;break;case 2:j=250;break;case 5:j=1073741823;break;case 4:j=1e4;break;default:j=5e3}return j=me+j,Y={id:c++,callback:le,priorityLevel:Y,startTime:me,expirationTime:j,sortIndex:-1},me>we?(Y.sortIndex=me,e(d,Y),t(u)===null&&Y===t(d)&&(m?(y(b),b=-1):m=!0,re(C,me-we))):(Y.sortIndex=j,e(u,Y),p||g||(p=!0,$e(M))),Y},r.unstable_shouldYield=z,r.unstable_wrapCallback=function(Y){var le=v;return function(){var me=v;v=le;try{return Y.apply(this,arguments)}finally{v=me}}}})(rw);tw.exports=rw;var LC=tw.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var UC=W,wr=LC;function te(r){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+r,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+r+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}o(te,"p");var nw=new Set,dl={};function _a(r,e){Ns(r,e),Ns(r+"Capture",e)}o(_a,"fa");function Ns(r,e){for(dl[r]=e,r=0;r<e.length;r++)nw.add(e[r])}o(Ns,"ha");var Bn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),qf=Object.prototype.hasOwnProperty,jC=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,yE={},SE={};function FC(r){return qf.call(SE,r)?!0:qf.call(yE,r)?!1:jC.test(r)?SE[r]=!0:(yE[r]=!0,!1)}o(FC,"oa");function BC(r,e,t,n){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:t!==null?!t.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}o(BC,"pa");function $C(r,e,t,n){if(e===null||typeof e>"u"||BC(r,e,t,n))return!0;if(n)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}o($C,"qa");function rr(r,e,t,n,i,a,s){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=r,this.type=e,this.sanitizeURL=a,this.removeEmptyString=s}o(rr,"v");var Ft={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){Ft[r]=new rr(r,0,!1,r,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var e=r[0];Ft[e]=new rr(e,1,!1,r[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(r){Ft[r]=new rr(r,2,!1,r.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){Ft[r]=new rr(r,2,!1,r,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){Ft[r]=new rr(r,3,!1,r.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(r){Ft[r]=new rr(r,3,!0,r,null,!1,!1)});["capture","download"].forEach(function(r){Ft[r]=new rr(r,4,!1,r,null,!1,!1)});["cols","rows","size","span"].forEach(function(r){Ft[r]=new rr(r,6,!1,r,null,!1,!1)});["rowSpan","start"].forEach(function(r){Ft[r]=new rr(r,5,!1,r.toLowerCase(),null,!1,!1)});var Zm=/[\-:]([a-z])/g;function eg(r){return r[1].toUpperCase()}o(eg,"sa");"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var e=r.replace(Zm,eg);Ft[e]=new rr(e,1,!1,r,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var e=r.replace(Zm,eg);Ft[e]=new rr(e,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(r){var e=r.replace(Zm,eg);Ft[e]=new rr(e,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(r){Ft[r]=new rr(r,1,!1,r.toLowerCase(),null,!1,!1)});Ft.xlinkHref=new rr("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(r){Ft[r]=new rr(r,1,!1,r.toLowerCase(),null,!0,!0)});function tg(r,e,t,n){var i=Ft.hasOwnProperty(e)?Ft[e]:null;(i!==null?i.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&($C(e,t,i,n)&&(t=null),n||i===null?FC(e)&&(t===null?r.removeAttribute(e):r.setAttribute(e,""+t)):i.mustUseProperty?r[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,n=i.attributeNamespace,t===null?r.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,n?r.setAttributeNS(n,e,t):r.setAttribute(e,t))))}o(tg,"ta");var Gn=UC.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,bu=Symbol.for("react.element"),ja=Symbol.for("react.portal"),Fa=Symbol.for("react.fragment"),rg=Symbol.for("react.strict_mode"),Gf=Symbol.for("react.profiler"),iw=Symbol.for("react.provider"),aw=Symbol.for("react.context"),ng=Symbol.for("react.forward_ref"),Hf=Symbol.for("react.suspense"),zf=Symbol.for("react.suspense_list"),ig=Symbol.for("react.memo"),ai=Symbol.for("react.lazy"),sw=Symbol.for("react.offscreen"),EE=Symbol.iterator;function yo(r){return r===null||typeof r!="object"?null:(r=EE&&r[EE]||r["@@iterator"],typeof r=="function"?r:null)}o(yo,"Ka");var ot=Object.assign,Wh;function jo(r){if(Wh===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);Wh=e&&e[1]||""}return`
`+Wh+r}o(jo,"Ma");var Kh=!1;function Vh(r,e){if(!r||Kh)return"";Kh=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=o(function(){throw Error()},"b"),Object.defineProperty(e.prototype,"props",{set:o(function(){throw Error()},"set")}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(d){var n=d}Reflect.construct(r,[],e)}else{try{e.call()}catch(d){n=d}r.call(e.prototype)}else{try{throw Error()}catch(d){n=d}r()}}catch(d){if(d&&n&&typeof d.stack=="string"){for(var i=d.stack.split(`
`),a=n.stack.split(`
`),s=i.length-1,l=a.length-1;1<=s&&0<=l&&i[s]!==a[l];)l--;for(;1<=s&&0<=l;s--,l--)if(i[s]!==a[l]){if(s!==1||l!==1)do if(s--,l--,0>l||i[s]!==a[l]){var u=`
`+i[s].replace(" at new "," at ");return r.displayName&&u.includes("<anonymous>")&&(u=u.replace("<anonymous>",r.displayName)),u}while(1<=s&&0<=l);break}}}finally{Kh=!1,Error.prepareStackTrace=t}return(r=r?r.displayName||r.name:"")?jo(r):""}o(Vh,"Oa");function WC(r){switch(r.tag){case 5:return jo(r.type);case 16:return jo("Lazy");case 13:return jo("Suspense");case 19:return jo("SuspenseList");case 0:case 2:case 15:return r=Vh(r.type,!1),r;case 11:return r=Vh(r.type.render,!1),r;case 1:return r=Vh(r.type,!0),r;default:return""}}o(WC,"Pa");function Jf(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case Fa:return"Fragment";case ja:return"Portal";case Gf:return"Profiler";case rg:return"StrictMode";case Hf:return"Suspense";case zf:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case aw:return(r.displayName||"Context")+".Consumer";case iw:return(r._context.displayName||"Context")+".Provider";case ng:var e=r.render;return r=r.displayName,r||(r=e.displayName||e.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case ig:return e=r.displayName||null,e!==null?e:Jf(r.type)||"Memo";case ai:e=r._payload,r=r._init;try{return Jf(r(e))}catch{}}return null}o(Jf,"Qa");function KC(r){var e=r.type;switch(r.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=e.render,r=r.displayName||r.name||"",e.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return Jf(e);case 8:return e===rg?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}o(KC,"Ra");function ki(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}o(ki,"Sa");function ow(r){var e=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}o(ow,"Ta");function VC(r){var e=ow(r)?"checked":"value",t=Object.getOwnPropertyDescriptor(r.constructor.prototype,e),n=""+r[e];if(!r.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,a=t.set;return Object.defineProperty(r,e,{configurable:!0,get:o(function(){return i.call(this)},"get"),set:o(function(s){n=""+s,a.call(this,s)},"set")}),Object.defineProperty(r,e,{enumerable:t.enumerable}),{getValue:o(function(){return n},"getValue"),setValue:o(function(s){n=""+s},"setValue"),stopTracking:o(function(){r._valueTracker=null,delete r[e]},"stopTracking")}}}o(VC,"Ua");function wu(r){r._valueTracker||(r._valueTracker=VC(r))}o(wu,"Va");function lw(r){if(!r)return!1;var e=r._valueTracker;if(!e)return!0;var t=e.getValue(),n="";return r&&(n=ow(r)?r.checked?"true":"false":r.value),r=n,r!==t?(e.setValue(r),!0):!1}o(lw,"Wa");function Td(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}o(Td,"Xa");function Qf(r,e){var t=e.checked;return ot({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??r._wrapperState.initialChecked})}o(Qf,"Ya");function _E(r,e){var t=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;t=ki(e.value!=null?e.value:t),r._wrapperState={initialChecked:n,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}o(_E,"Za");function uw(r,e){e=e.checked,e!=null&&tg(r,"checked",e,!1)}o(uw,"ab");function Yf(r,e){uw(r,e);var t=ki(e.value),n=e.type;if(t!=null)n==="number"?(t===0&&r.value===""||r.value!=t)&&(r.value=""+t):r.value!==""+t&&(r.value=""+t);else if(n==="submit"||n==="reset"){r.removeAttribute("value");return}e.hasOwnProperty("value")?Xf(r,e.type,t):e.hasOwnProperty("defaultValue")&&Xf(r,e.type,ki(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(r.defaultChecked=!!e.defaultChecked)}o(Yf,"bb");function bE(r,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+r._wrapperState.initialValue,t||e===r.value||(r.value=e),r.defaultValue=e}t=r.name,t!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,t!==""&&(r.name=t)}o(bE,"db");function Xf(r,e,t){(e!=="number"||Td(r.ownerDocument)!==r)&&(t==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+t&&(r.defaultValue=""+t))}o(Xf,"cb");var Fo=Array.isArray;function Za(r,e,t,n){if(r=r.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<r.length;t++)i=e.hasOwnProperty("$"+r[t].value),r[t].selected!==i&&(r[t].selected=i),i&&n&&(r[t].defaultSelected=!0)}else{for(t=""+ki(t),e=null,i=0;i<r.length;i++){if(r[i].value===t){r[i].selected=!0,n&&(r[i].defaultSelected=!0);return}e!==null||r[i].disabled||(e=r[i])}e!==null&&(e.selected=!0)}}o(Za,"fb");function Zf(r,e){if(e.dangerouslySetInnerHTML!=null)throw Error(te(91));return ot({},e,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}o(Zf,"gb");function wE(r,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(te(92));if(Fo(t)){if(1<t.length)throw Error(te(93));t=t[0]}e=t}e==null&&(e=""),t=e}r._wrapperState={initialValue:ki(t)}}o(wE,"hb");function dw(r,e){var t=ki(e.value),n=ki(e.defaultValue);t!=null&&(t=""+t,t!==r.value&&(r.value=t),e.defaultValue==null&&r.defaultValue!==t&&(r.defaultValue=t)),n!=null&&(r.defaultValue=""+n)}o(dw,"ib");function TE(r){var e=r.textContent;e===r._wrapperState.initialValue&&e!==""&&e!==null&&(r.value=e)}o(TE,"jb");function cw(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}o(cw,"kb");function ev(r,e){return r==null||r==="http://www.w3.org/1999/xhtml"?cw(e):r==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":r}o(ev,"lb");var Tu,hw=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction(function(){return r(e,t,n,i)})}:r}(function(r,e){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=e;else{for(Tu=Tu||document.createElement("div"),Tu.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=Tu.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;e.firstChild;)r.appendChild(e.firstChild)}});function cl(r,e){if(e){var t=r.firstChild;if(t&&t===r.lastChild&&t.nodeType===3){t.nodeValue=e;return}}r.textContent=e}o(cl,"ob");var qo={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},qC=["Webkit","ms","Moz","O"];Object.keys(qo).forEach(function(r){qC.forEach(function(e){e=e+r.charAt(0).toUpperCase()+r.substring(1),qo[e]=qo[r]})});function fw(r,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||qo.hasOwnProperty(r)&&qo[r]?(""+e).trim():e+"px"}o(fw,"rb");function vw(r,e){r=r.style;for(var t in e)if(e.hasOwnProperty(t)){var n=t.indexOf("--")===0,i=fw(t,e[t],n);t==="float"&&(t="cssFloat"),n?r.setProperty(t,i):r[t]=i}}o(vw,"sb");var GC=ot({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function tv(r,e){if(e){if(GC[r]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(te(137,r));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(te(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(te(61))}if(e.style!=null&&typeof e.style!="object")throw Error(te(62))}}o(tv,"ub");function rv(r,e){if(r.indexOf("-")===-1)return typeof e.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}o(rv,"vb");var nv=null;function ag(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}o(ag,"xb");var iv=null,es=null,ts=null;function RE(r){if(r=ru(r)){if(typeof iv!="function")throw Error(te(280));var e=r.stateNode;e&&(e=oh(e),iv(r.stateNode,r.type,e))}}o(RE,"Bb");function pw(r){es?ts?ts.push(r):ts=[r]:es=r}o(pw,"Eb");function mw(){if(es){var r=es,e=ts;if(ts=es=null,RE(r),e)for(r=0;r<e.length;r++)RE(e[r])}}o(mw,"Fb");function gw(r,e){return r(e)}o(gw,"Gb");function yw(){}o(yw,"Hb");var qh=!1;function Sw(r,e,t){if(qh)return r(e,t);qh=!0;try{return gw(r,e,t)}finally{qh=!1,(es!==null||ts!==null)&&(yw(),mw())}}o(Sw,"Jb");function hl(r,e){var t=r.stateNode;if(t===null)return null;var n=oh(t);if(n===null)return null;t=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(r=r.type,n=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!n;break e;default:r=!1}if(r)return null;if(t&&typeof t!="function")throw Error(te(231,e,typeof t));return t}o(hl,"Kb");var av=!1;if(Bn)try{var So={};Object.defineProperty(So,"passive",{get:o(function(){av=!0},"get")}),window.addEventListener("test",So,So),window.removeEventListener("test",So,So)}catch{av=!1}function HC(r,e,t,n,i,a,s,l,u){var d=Array.prototype.slice.call(arguments,3);try{e.apply(t,d)}catch(c){this.onError(c)}}o(HC,"Nb");var Go=!1,Rd=null,Id=!1,sv=null,zC={onError:o(function(r){Go=!0,Rd=r},"onError")};function JC(r,e,t,n,i,a,s,l,u){Go=!1,Rd=null,HC.apply(zC,arguments)}o(JC,"Tb");function QC(r,e,t,n,i,a,s,l,u){if(JC.apply(this,arguments),Go){if(Go){var d=Rd;Go=!1,Rd=null}else throw Error(te(198));Id||(Id=!0,sv=d)}}o(QC,"Ub");function ba(r){var e=r,t=r;if(r.alternate)for(;e.return;)e=e.return;else{r=e;do e=r,e.flags&4098&&(t=e.return),r=e.return;while(r)}return e.tag===3?t:null}o(ba,"Vb");function Ew(r){if(r.tag===13){var e=r.memoizedState;if(e===null&&(r=r.alternate,r!==null&&(e=r.memoizedState)),e!==null)return e.dehydrated}return null}o(Ew,"Wb");function IE(r){if(ba(r)!==r)throw Error(te(188))}o(IE,"Xb");function YC(r){var e=r.alternate;if(!e){if(e=ba(r),e===null)throw Error(te(188));return e!==r?null:r}for(var t=r,n=e;;){var i=t.return;if(i===null)break;var a=i.alternate;if(a===null){if(n=i.return,n!==null){t=n;continue}break}if(i.child===a.child){for(a=i.child;a;){if(a===t)return IE(i),r;if(a===n)return IE(i),e;a=a.sibling}throw Error(te(188))}if(t.return!==n.return)t=i,n=a;else{for(var s=!1,l=i.child;l;){if(l===t){s=!0,t=i,n=a;break}if(l===n){s=!0,n=i,t=a;break}l=l.sibling}if(!s){for(l=a.child;l;){if(l===t){s=!0,t=a,n=i;break}if(l===n){s=!0,n=a,t=i;break}l=l.sibling}if(!s)throw Error(te(189))}}if(t.alternate!==n)throw Error(te(190))}if(t.tag!==3)throw Error(te(188));return t.stateNode.current===t?r:e}o(YC,"Yb");function _w(r){return r=YC(r),r!==null?bw(r):null}o(_w,"Zb");function bw(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var e=bw(r);if(e!==null)return e;r=r.sibling}return null}o(bw,"$b");var ww=wr.unstable_scheduleCallback,CE=wr.unstable_cancelCallback,XC=wr.unstable_shouldYield,ZC=wr.unstable_requestPaint,ht=wr.unstable_now,eO=wr.unstable_getCurrentPriorityLevel,sg=wr.unstable_ImmediatePriority,Tw=wr.unstable_UserBlockingPriority,Cd=wr.unstable_NormalPriority,tO=wr.unstable_LowPriority,Rw=wr.unstable_IdlePriority,nh=null,mn=null;function rO(r){if(mn&&typeof mn.onCommitFiberRoot=="function")try{mn.onCommitFiberRoot(nh,r,void 0,(r.current.flags&128)===128)}catch{}}o(rO,"mc");var Hr=Math.clz32?Math.clz32:aO,nO=Math.log,iO=Math.LN2;function aO(r){return r>>>=0,r===0?32:31-(nO(r)/iO|0)|0}o(aO,"nc");var Ru=64,Iu=4194304;function Bo(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}o(Bo,"tc");function Od(r,e){var t=r.pendingLanes;if(t===0)return 0;var n=0,i=r.suspendedLanes,a=r.pingedLanes,s=t&268435455;if(s!==0){var l=s&~i;l!==0?n=Bo(l):(a&=s,a!==0&&(n=Bo(a)))}else s=t&~i,s!==0?n=Bo(s):a!==0&&(n=Bo(a));if(n===0)return 0;if(e!==0&&e!==n&&!(e&i)&&(i=n&-n,a=e&-e,i>=a||i===16&&(a&4194240)!==0))return e;if(n&4&&(n|=t&16),e=r.entangledLanes,e!==0)for(r=r.entanglements,e&=n;0<e;)t=31-Hr(e),i=1<<t,n|=r[t],e&=~i;return n}o(Od,"uc");function sO(r,e){switch(r){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}o(sO,"vc");function oO(r,e){for(var t=r.suspendedLanes,n=r.pingedLanes,i=r.expirationTimes,a=r.pendingLanes;0<a;){var s=31-Hr(a),l=1<<s,u=i[s];u===-1?(!(l&t)||l&n)&&(i[s]=sO(l,e)):u<=e&&(r.expiredLanes|=l),a&=~l}}o(oO,"wc");function ov(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}o(ov,"xc");function Iw(){var r=Ru;return Ru<<=1,!(Ru&4194240)&&(Ru=64),r}o(Iw,"yc");function Gh(r){for(var e=[],t=0;31>t;t++)e.push(r);return e}o(Gh,"zc");function eu(r,e,t){r.pendingLanes|=e,e!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,e=31-Hr(e),r[e]=t}o(eu,"Ac");function lO(r,e){var t=r.pendingLanes&~e;r.pendingLanes=e,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=e,r.mutableReadLanes&=e,r.entangledLanes&=e,e=r.entanglements;var n=r.eventTimes;for(r=r.expirationTimes;0<t;){var i=31-Hr(t),a=1<<i;e[i]=0,n[i]=-1,r[i]=-1,t&=~a}}o(lO,"Bc");function og(r,e){var t=r.entangledLanes|=e;for(r=r.entanglements;t;){var n=31-Hr(t),i=1<<n;i&e|r[n]&e&&(r[n]|=e),t&=~i}}o(og,"Cc");var Be=0;function Cw(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}o(Cw,"Dc");var Ow,lg,kw,Pw,Mw,lv=!1,Cu=[],mi=null,gi=null,yi=null,fl=new Map,vl=new Map,di=[],uO="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function OE(r,e){switch(r){case"focusin":case"focusout":mi=null;break;case"dragenter":case"dragleave":gi=null;break;case"mouseover":case"mouseout":yi=null;break;case"pointerover":case"pointerout":fl.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":vl.delete(e.pointerId)}}o(OE,"Sc");function Eo(r,e,t,n,i,a){return r===null||r.nativeEvent!==a?(r={blockedOn:e,domEventName:t,eventSystemFlags:n,nativeEvent:a,targetContainers:[i]},e!==null&&(e=ru(e),e!==null&&lg(e)),r):(r.eventSystemFlags|=n,e=r.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),r)}o(Eo,"Tc");function dO(r,e,t,n,i){switch(e){case"focusin":return mi=Eo(mi,r,e,t,n,i),!0;case"dragenter":return gi=Eo(gi,r,e,t,n,i),!0;case"mouseover":return yi=Eo(yi,r,e,t,n,i),!0;case"pointerover":var a=i.pointerId;return fl.set(a,Eo(fl.get(a)||null,r,e,t,n,i)),!0;case"gotpointercapture":return a=i.pointerId,vl.set(a,Eo(vl.get(a)||null,r,e,t,n,i)),!0}return!1}o(dO,"Uc");function Aw(r){var e=ea(r.target);if(e!==null){var t=ba(e);if(t!==null){if(e=t.tag,e===13){if(e=Ew(t),e!==null){r.blockedOn=e,Mw(r.priority,function(){kw(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){r.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}r.blockedOn=null}o(Aw,"Vc");function ed(r){if(r.blockedOn!==null)return!1;for(var e=r.targetContainers;0<e.length;){var t=uv(r.domEventName,r.eventSystemFlags,e[0],r.nativeEvent);if(t===null){t=r.nativeEvent;var n=new t.constructor(t.type,t);nv=n,t.target.dispatchEvent(n),nv=null}else return e=ru(t),e!==null&&lg(e),r.blockedOn=t,!1;e.shift()}return!0}o(ed,"Xc");function kE(r,e,t){ed(r)&&t.delete(e)}o(kE,"Zc");function cO(){lv=!1,mi!==null&&ed(mi)&&(mi=null),gi!==null&&ed(gi)&&(gi=null),yi!==null&&ed(yi)&&(yi=null),fl.forEach(kE),vl.forEach(kE)}o(cO,"$c");function _o(r,e){r.blockedOn===e&&(r.blockedOn=null,lv||(lv=!0,wr.unstable_scheduleCallback(wr.unstable_NormalPriority,cO)))}o(_o,"ad");function pl(r){function e(i){return _o(i,r)}if(o(e,"b"),0<Cu.length){_o(Cu[0],r);for(var t=1;t<Cu.length;t++){var n=Cu[t];n.blockedOn===r&&(n.blockedOn=null)}}for(mi!==null&&_o(mi,r),gi!==null&&_o(gi,r),yi!==null&&_o(yi,r),fl.forEach(e),vl.forEach(e),t=0;t<di.length;t++)n=di[t],n.blockedOn===r&&(n.blockedOn=null);for(;0<di.length&&(t=di[0],t.blockedOn===null);)Aw(t),t.blockedOn===null&&di.shift()}o(pl,"bd");var rs=Gn.ReactCurrentBatchConfig,kd=!0;function hO(r,e,t,n){var i=Be,a=rs.transition;rs.transition=null;try{Be=1,ug(r,e,t,n)}finally{Be=i,rs.transition=a}}o(hO,"ed");function fO(r,e,t,n){var i=Be,a=rs.transition;rs.transition=null;try{Be=4,ug(r,e,t,n)}finally{Be=i,rs.transition=a}}o(fO,"gd");function ug(r,e,t,n){if(kd){var i=uv(r,e,t,n);if(i===null)rf(r,e,n,Pd,t),OE(r,n);else if(dO(i,r,e,t,n))n.stopPropagation();else if(OE(r,n),e&4&&-1<uO.indexOf(r)){for(;i!==null;){var a=ru(i);if(a!==null&&Ow(a),a=uv(r,e,t,n),a===null&&rf(r,e,n,Pd,t),a===i)break;i=a}i!==null&&n.stopPropagation()}else rf(r,e,n,null,t)}}o(ug,"fd");var Pd=null;function uv(r,e,t,n){if(Pd=null,r=ag(n),r=ea(r),r!==null)if(e=ba(r),e===null)r=null;else if(t=e.tag,t===13){if(r=Ew(e),r!==null)return r;r=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;r=null}else e!==r&&(r=null);return Pd=r,null}o(uv,"Yc");function xw(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(eO()){case sg:return 1;case Tw:return 4;case Cd:case tO:return 16;case Rw:return 536870912;default:return 16}default:return 16}}o(xw,"jd");var hi=null,dg=null,td=null;function Dw(){if(td)return td;var r,e=dg,t=e.length,n,i="value"in hi?hi.value:hi.textContent,a=i.length;for(r=0;r<t&&e[r]===i[r];r++);var s=t-r;for(n=1;n<=s&&e[t-n]===i[a-n];n++);return td=i.slice(r,1<n?1-n:void 0)}o(Dw,"nd");function rd(r){var e=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&e===13&&(r=13)):r=e,r===10&&(r=13),32<=r||r===13?r:0}o(rd,"od");function Ou(){return!0}o(Ou,"pd");function PE(){return!1}o(PE,"qd");function Rr(r){function e(t,n,i,a,s){this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=a,this.target=s,this.currentTarget=null;for(var l in r)r.hasOwnProperty(l)&&(t=r[l],this[l]=t?t(a):a[l]);return this.isDefaultPrevented=(a.defaultPrevented!=null?a.defaultPrevented:a.returnValue===!1)?Ou:PE,this.isPropagationStopped=PE,this}return o(e,"b"),ot(e.prototype,{preventDefault:o(function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=Ou)},"preventDefault"),stopPropagation:o(function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=Ou)},"stopPropagation"),persist:o(function(){},"persist"),isPersistent:Ou}),e}o(Rr,"rd");var ro={eventPhase:0,bubbles:0,cancelable:0,timeStamp:o(function(r){return r.timeStamp||Date.now()},"timeStamp"),defaultPrevented:0,isTrusted:0},cg=Rr(ro),tu=ot({},ro,{view:0,detail:0}),vO=Rr(tu),Hh,zh,bo,ih=ot({},tu,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:hg,button:0,buttons:0,relatedTarget:o(function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},"relatedTarget"),movementX:o(function(r){return"movementX"in r?r.movementX:(r!==bo&&(bo&&r.type==="mousemove"?(Hh=r.screenX-bo.screenX,zh=r.screenY-bo.screenY):zh=Hh=0,bo=r),Hh)},"movementX"),movementY:o(function(r){return"movementY"in r?r.movementY:zh},"movementY")}),ME=Rr(ih),pO=ot({},ih,{dataTransfer:0}),mO=Rr(pO),gO=ot({},tu,{relatedTarget:0}),Jh=Rr(gO),yO=ot({},ro,{animationName:0,elapsedTime:0,pseudoElement:0}),SO=Rr(yO),EO=ot({},ro,{clipboardData:o(function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData},"clipboardData")}),_O=Rr(EO),bO=ot({},ro,{data:0}),AE=Rr(bO),wO={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},TO={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},RO={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function IO(r){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(r):(r=RO[r])?!!e[r]:!1}o(IO,"Pd");function hg(){return IO}o(hg,"zd");var CO=ot({},tu,{key:o(function(r){if(r.key){var e=wO[r.key]||r.key;if(e!=="Unidentified")return e}return r.type==="keypress"?(r=rd(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?TO[r.keyCode]||"Unidentified":""},"key"),code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:hg,charCode:o(function(r){return r.type==="keypress"?rd(r):0},"charCode"),keyCode:o(function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},"keyCode"),which:o(function(r){return r.type==="keypress"?rd(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0},"which")}),OO=Rr(CO),kO=ot({},ih,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),xE=Rr(kO),PO=ot({},tu,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:hg}),MO=Rr(PO),AO=ot({},ro,{propertyName:0,elapsedTime:0,pseudoElement:0}),xO=Rr(AO),DO=ot({},ih,{deltaX:o(function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},"deltaX"),deltaY:o(function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},"deltaY"),deltaZ:0,deltaMode:0}),NO=Rr(DO),LO=[9,13,27,32],fg=Bn&&"CompositionEvent"in window,Ho=null;Bn&&"documentMode"in document&&(Ho=document.documentMode);var UO=Bn&&"TextEvent"in window&&!Ho,Nw=Bn&&(!fg||Ho&&8<Ho&&11>=Ho),DE=" ",NE=!1;function Lw(r,e){switch(r){case"keyup":return LO.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}o(Lw,"ge");function Uw(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}o(Uw,"he");var Ba=!1;function jO(r,e){switch(r){case"compositionend":return Uw(e);case"keypress":return e.which!==32?null:(NE=!0,DE);case"textInput":return r=e.data,r===DE&&NE?null:r;default:return null}}o(jO,"je");function FO(r,e){if(Ba)return r==="compositionend"||!fg&&Lw(r,e)?(r=Dw(),td=dg=hi=null,Ba=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return Nw&&e.locale!=="ko"?null:e.data;default:return null}}o(FO,"ke");var BO={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function LE(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e==="input"?!!BO[r.type]:e==="textarea"}o(LE,"me");function jw(r,e,t,n){pw(n),e=Md(e,"onChange"),0<e.length&&(t=new cg("onChange","change",null,t,n),r.push({event:t,listeners:e}))}o(jw,"ne");var zo=null,ml=null;function $O(r){Jw(r,0)}o($O,"re");function ah(r){var e=Ka(r);if(lw(e))return r}o(ah,"te");function WO(r,e){if(r==="change")return e}o(WO,"ve");var Fw=!1;if(Bn){var Qh;if(Bn){var Yh="oninput"in document;if(!Yh){var UE=document.createElement("div");UE.setAttribute("oninput","return;"),Yh=typeof UE.oninput=="function"}Qh=Yh}else Qh=!1;Fw=Qh&&(!document.documentMode||9<document.documentMode)}function jE(){zo&&(zo.detachEvent("onpropertychange",Bw),ml=zo=null)}o(jE,"Ae");function Bw(r){if(r.propertyName==="value"&&ah(ml)){var e=[];jw(e,ml,r,ag(r)),Sw($O,e)}}o(Bw,"Be");function KO(r,e,t){r==="focusin"?(jE(),zo=e,ml=t,zo.attachEvent("onpropertychange",Bw)):r==="focusout"&&jE()}o(KO,"Ce");function VO(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return ah(ml)}o(VO,"De");function qO(r,e){if(r==="click")return ah(e)}o(qO,"Ee");function GO(r,e){if(r==="input"||r==="change")return ah(e)}o(GO,"Fe");function HO(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}o(HO,"Ge");var Xr=typeof Object.is=="function"?Object.is:HO;function gl(r,e){if(Xr(r,e))return!0;if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;var t=Object.keys(r),n=Object.keys(e);if(t.length!==n.length)return!1;for(n=0;n<t.length;n++){var i=t[n];if(!qf.call(e,i)||!Xr(r[i],e[i]))return!1}return!0}o(gl,"Ie");function FE(r){for(;r&&r.firstChild;)r=r.firstChild;return r}o(FE,"Je");function BE(r,e){var t=FE(r);r=0;for(var n;t;){if(t.nodeType===3){if(n=r+t.textContent.length,r<=e&&n>=e)return{node:t,offset:e-r};r=n}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=FE(t)}}o(BE,"Ke");function $w(r,e){return r&&e?r===e?!0:r&&r.nodeType===3?!1:e&&e.nodeType===3?$w(r,e.parentNode):"contains"in r?r.contains(e):r.compareDocumentPosition?!!(r.compareDocumentPosition(e)&16):!1:!1}o($w,"Le");function Ww(){for(var r=window,e=Td();e instanceof r.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)r=e.contentWindow;else break;e=Td(r.document)}return e}o(Ww,"Me");function vg(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e&&(e==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||e==="textarea"||r.contentEditable==="true")}o(vg,"Ne");function zO(r){var e=Ww(),t=r.focusedElem,n=r.selectionRange;if(e!==t&&t&&t.ownerDocument&&$w(t.ownerDocument.documentElement,t)){if(n!==null&&vg(t)){if(e=n.start,r=n.end,r===void 0&&(r=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(r,t.value.length);else if(r=(e=t.ownerDocument||document)&&e.defaultView||window,r.getSelection){r=r.getSelection();var i=t.textContent.length,a=Math.min(n.start,i);n=n.end===void 0?a:Math.min(n.end,i),!r.extend&&a>n&&(i=n,n=a,a=i),i=BE(t,a);var s=BE(t,n);i&&s&&(r.rangeCount!==1||r.anchorNode!==i.node||r.anchorOffset!==i.offset||r.focusNode!==s.node||r.focusOffset!==s.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),r.removeAllRanges(),a>n?(r.addRange(e),r.extend(s.node,s.offset)):(e.setEnd(s.node,s.offset),r.addRange(e)))}}for(e=[],r=t;r=r.parentNode;)r.nodeType===1&&e.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)r=e[t],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}o(zO,"Oe");var JO=Bn&&"documentMode"in document&&11>=document.documentMode,$a=null,dv=null,Jo=null,cv=!1;function $E(r,e,t){var n=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;cv||$a==null||$a!==Td(n)||(n=$a,"selectionStart"in n&&vg(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),Jo&&gl(Jo,n)||(Jo=n,n=Md(dv,"onSelect"),0<n.length&&(e=new cg("onSelect","select",null,e,t),r.push({event:e,listeners:n}),e.target=$a)))}o($E,"Ue");function ku(r,e){var t={};return t[r.toLowerCase()]=e.toLowerCase(),t["Webkit"+r]="webkit"+e,t["Moz"+r]="moz"+e,t}o(ku,"Ve");var Wa={animationend:ku("Animation","AnimationEnd"),animationiteration:ku("Animation","AnimationIteration"),animationstart:ku("Animation","AnimationStart"),transitionend:ku("Transition","TransitionEnd")},Xh={},Kw={};Bn&&(Kw=document.createElement("div").style,"AnimationEvent"in window||(delete Wa.animationend.animation,delete Wa.animationiteration.animation,delete Wa.animationstart.animation),"TransitionEvent"in window||delete Wa.transitionend.transition);function sh(r){if(Xh[r])return Xh[r];if(!Wa[r])return r;var e=Wa[r],t;for(t in e)if(e.hasOwnProperty(t)&&t in Kw)return Xh[r]=e[t];return r}o(sh,"Ze");var Vw=sh("animationend"),qw=sh("animationiteration"),Gw=sh("animationstart"),Hw=sh("transitionend"),zw=new Map,WE="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Di(r,e){zw.set(r,e),_a(e,[r])}o(Di,"ff");for(var Zh=0;Zh<WE.length;Zh++){var ef=WE[Zh],QO=ef.toLowerCase(),YO=ef[0].toUpperCase()+ef.slice(1);Di(QO,"on"+YO)}Di(Vw,"onAnimationEnd");Di(qw,"onAnimationIteration");Di(Gw,"onAnimationStart");Di("dblclick","onDoubleClick");Di("focusin","onFocus");Di("focusout","onBlur");Di(Hw,"onTransitionEnd");Ns("onMouseEnter",["mouseout","mouseover"]);Ns("onMouseLeave",["mouseout","mouseover"]);Ns("onPointerEnter",["pointerout","pointerover"]);Ns("onPointerLeave",["pointerout","pointerover"]);_a("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));_a("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));_a("onBeforeInput",["compositionend","keypress","textInput","paste"]);_a("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));_a("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));_a("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var $o="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),XO=new Set("cancel close invalid load scroll toggle".split(" ").concat($o));function KE(r,e,t){var n=r.type||"unknown-event";r.currentTarget=t,QC(n,e,void 0,r),r.currentTarget=null}o(KE,"nf");function Jw(r,e){e=(e&4)!==0;for(var t=0;t<r.length;t++){var n=r[t],i=n.event;n=n.listeners;e:{var a=void 0;if(e)for(var s=n.length-1;0<=s;s--){var l=n[s],u=l.instance,d=l.currentTarget;if(l=l.listener,u!==a&&i.isPropagationStopped())break e;KE(i,l,d),a=u}else for(s=0;s<n.length;s++){if(l=n[s],u=l.instance,d=l.currentTarget,l=l.listener,u!==a&&i.isPropagationStopped())break e;KE(i,l,d),a=u}}}if(Id)throw r=sv,Id=!1,sv=null,r}o(Jw,"se");function ze(r,e){var t=e[mv];t===void 0&&(t=e[mv]=new Set);var n=r+"__bubble";t.has(n)||(Qw(e,r,2,!1),t.add(n))}o(ze,"D");function tf(r,e,t){var n=0;e&&(n|=4),Qw(t,r,n,e)}o(tf,"qf");var Pu="_reactListening"+Math.random().toString(36).slice(2);function yl(r){if(!r[Pu]){r[Pu]=!0,nw.forEach(function(t){t!=="selectionchange"&&(XO.has(t)||tf(t,!1,r),tf(t,!0,r))});var e=r.nodeType===9?r:r.ownerDocument;e===null||e[Pu]||(e[Pu]=!0,tf("selectionchange",!1,e))}}o(yl,"sf");function Qw(r,e,t,n){switch(xw(e)){case 1:var i=hO;break;case 4:i=fO;break;default:i=ug}t=i.bind(null,e,t,r),i=void 0,!av||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),n?i!==void 0?r.addEventListener(e,t,{capture:!0,passive:i}):r.addEventListener(e,t,!0):i!==void 0?r.addEventListener(e,t,{passive:i}):r.addEventListener(e,t,!1)}o(Qw,"pf");function rf(r,e,t,n,i){var a=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var s=n.tag;if(s===3||s===4){var l=n.stateNode.containerInfo;if(l===i||l.nodeType===8&&l.parentNode===i)break;if(s===4)for(s=n.return;s!==null;){var u=s.tag;if((u===3||u===4)&&(u=s.stateNode.containerInfo,u===i||u.nodeType===8&&u.parentNode===i))return;s=s.return}for(;l!==null;){if(s=ea(l),s===null)return;if(u=s.tag,u===5||u===6){n=a=s;continue e}l=l.parentNode}}n=n.return}Sw(function(){var d=a,c=ag(t),h=[];e:{var v=zw.get(r);if(v!==void 0){var g=cg,p=r;switch(r){case"keypress":if(rd(t)===0)break e;case"keydown":case"keyup":g=OO;break;case"focusin":p="focus",g=Jh;break;case"focusout":p="blur",g=Jh;break;case"beforeblur":case"afterblur":g=Jh;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":g=ME;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":g=mO;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":g=MO;break;case Vw:case qw:case Gw:g=SO;break;case Hw:g=xO;break;case"scroll":g=vO;break;case"wheel":g=NO;break;case"copy":case"cut":case"paste":g=_O;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":g=xE}var m=(e&4)!==0,T=!m&&r==="scroll",y=m?v!==null?v+"Capture":null:v;m=[];for(var S=d,w;S!==null;){w=S;var C=w.stateNode;if(w.tag===5&&C!==null&&(w=C,y!==null&&(C=hl(S,y),C!=null&&m.push(Sl(S,C,w)))),T)break;S=S.return}0<m.length&&(v=new g(v,p,null,t,c),h.push({event:v,listeners:m}))}}if(!(e&7)){e:{if(v=r==="mouseover"||r==="pointerover",g=r==="mouseout"||r==="pointerout",v&&t!==nv&&(p=t.relatedTarget||t.fromElement)&&(ea(p)||p[$n]))break e;if((g||v)&&(v=c.window===c?c:(v=c.ownerDocument)?v.defaultView||v.parentWindow:window,g?(p=t.relatedTarget||t.toElement,g=d,p=p?ea(p):null,p!==null&&(T=ba(p),p!==T||p.tag!==5&&p.tag!==6)&&(p=null)):(g=null,p=d),g!==p)){if(m=ME,C="onMouseLeave",y="onMouseEnter",S="mouse",(r==="pointerout"||r==="pointerover")&&(m=xE,C="onPointerLeave",y="onPointerEnter",S="pointer"),T=g==null?v:Ka(g),w=p==null?v:Ka(p),v=new m(C,S+"leave",g,t,c),v.target=T,v.relatedTarget=w,C=null,ea(c)===d&&(m=new m(y,S+"enter",p,t,c),m.target=w,m.relatedTarget=T,C=m),T=C,g&&p)t:{for(m=g,y=p,S=0,w=m;w;w=Oa(w))S++;for(w=0,C=y;C;C=Oa(C))w++;for(;0<S-w;)m=Oa(m),S--;for(;0<w-S;)y=Oa(y),w--;for(;S--;){if(m===y||y!==null&&m===y.alternate)break t;m=Oa(m),y=Oa(y)}m=null}else m=null;g!==null&&VE(h,v,g,m,!1),p!==null&&T!==null&&VE(h,T,p,m,!0)}}e:{if(v=d?Ka(d):window,g=v.nodeName&&v.nodeName.toLowerCase(),g==="select"||g==="input"&&v.type==="file")var M=WO;else if(LE(v))if(Fw)M=GO;else{M=VO;var _=KO}else(g=v.nodeName)&&g.toLowerCase()==="input"&&(v.type==="checkbox"||v.type==="radio")&&(M=qO);if(M&&(M=M(r,d))){jw(h,M,t,c);break e}_&&_(r,v,d),r==="focusout"&&(_=v._wrapperState)&&_.controlled&&v.type==="number"&&Xf(v,"number",v.value)}switch(_=d?Ka(d):window,r){case"focusin":(LE(_)||_.contentEditable==="true")&&($a=_,dv=d,Jo=null);break;case"focusout":Jo=dv=$a=null;break;case"mousedown":cv=!0;break;case"contextmenu":case"mouseup":case"dragend":cv=!1,$E(h,t,c);break;case"selectionchange":if(JO)break;case"keydown":case"keyup":$E(h,t,c)}var O;if(fg)e:{switch(r){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else Ba?Lw(r,t)&&(b="onCompositionEnd"):r==="keydown"&&t.keyCode===229&&(b="onCompositionStart");b&&(Nw&&t.locale!=="ko"&&(Ba||b!=="onCompositionStart"?b==="onCompositionEnd"&&Ba&&(O=Dw()):(hi=c,dg="value"in hi?hi.value:hi.textContent,Ba=!0)),_=Md(d,b),0<_.length&&(b=new AE(b,r,null,t,c),h.push({event:b,listeners:_}),O?b.data=O:(O=Uw(t),O!==null&&(b.data=O)))),(O=UO?jO(r,t):FO(r,t))&&(d=Md(d,"onBeforeInput"),0<d.length&&(c=new AE("onBeforeInput","beforeinput",null,t,c),h.push({event:c,listeners:d}),c.data=O))}Jw(h,e)})}o(rf,"hd");function Sl(r,e,t){return{instance:r,listener:e,currentTarget:t}}o(Sl,"tf");function Md(r,e){for(var t=e+"Capture",n=[];r!==null;){var i=r,a=i.stateNode;i.tag===5&&a!==null&&(i=a,a=hl(r,t),a!=null&&n.unshift(Sl(r,a,i)),a=hl(r,e),a!=null&&n.push(Sl(r,a,i))),r=r.return}return n}o(Md,"oe");function Oa(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}o(Oa,"vf");function VE(r,e,t,n,i){for(var a=e._reactName,s=[];t!==null&&t!==n;){var l=t,u=l.alternate,d=l.stateNode;if(u!==null&&u===n)break;l.tag===5&&d!==null&&(l=d,i?(u=hl(t,a),u!=null&&s.unshift(Sl(t,u,l))):i||(u=hl(t,a),u!=null&&s.push(Sl(t,u,l)))),t=t.return}s.length!==0&&r.push({event:e,listeners:s})}o(VE,"wf");var ZO=/\r\n?/g,ek=/\u0000|\uFFFD/g;function qE(r){return(typeof r=="string"?r:""+r).replace(ZO,`
`).replace(ek,"")}o(qE,"zf");function Mu(r,e,t){if(e=qE(e),qE(r)!==e&&t)throw Error(te(425))}o(Mu,"Af");function Ad(){}o(Ad,"Bf");var hv=null,fv=null;function vv(r,e){return r==="textarea"||r==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}o(vv,"Ef");var pv=typeof setTimeout=="function"?setTimeout:void 0,tk=typeof clearTimeout=="function"?clearTimeout:void 0,GE=typeof Promise=="function"?Promise:void 0,rk=typeof queueMicrotask=="function"?queueMicrotask:typeof GE<"u"?function(r){return GE.resolve(null).then(r).catch(nk)}:pv;function nk(r){setTimeout(function(){throw r})}o(nk,"If");function nf(r,e){var t=e,n=0;do{var i=t.nextSibling;if(r.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(n===0){r.removeChild(i),pl(e);return}n--}else t!=="$"&&t!=="$?"&&t!=="$!"||n++;t=i}while(t);pl(e)}o(nf,"Kf");function Si(r){for(;r!=null;r=r.nextSibling){var e=r.nodeType;if(e===1||e===3)break;if(e===8){if(e=r.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return r}o(Si,"Lf");function HE(r){r=r.previousSibling;for(var e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return r;e--}else t==="/$"&&e++}r=r.previousSibling}return null}o(HE,"Mf");var no=Math.random().toString(36).slice(2),hn="__reactFiber$"+no,El="__reactProps$"+no,$n="__reactContainer$"+no,mv="__reactEvents$"+no,ik="__reactListeners$"+no,ak="__reactHandles$"+no;function ea(r){var e=r[hn];if(e)return e;for(var t=r.parentNode;t;){if(e=t[$n]||t[hn]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(r=HE(r);r!==null;){if(t=r[hn])return t;r=HE(r)}return e}r=t,t=r.parentNode}return null}o(ea,"Wc");function ru(r){return r=r[hn]||r[$n],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}o(ru,"Cb");function Ka(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(te(33))}o(Ka,"ue");function oh(r){return r[El]||null}o(oh,"Db");var gv=[],Va=-1;function Ni(r){return{current:r}}o(Ni,"Uf");function Qe(r){0>Va||(r.current=gv[Va],gv[Va]=null,Va--)}o(Qe,"E");function He(r,e){Va++,gv[Va]=r.current,r.current=e}o(He,"G");var Pi={},Gt=Ni(Pi),dr=Ni(!1),ha=Pi;function Ls(r,e){var t=r.type.contextTypes;if(!t)return Pi;var n=r.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var i={},a;for(a in t)i[a]=e[a];return n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=e,r.__reactInternalMemoizedMaskedChildContext=i),i}o(Ls,"Yf");function cr(r){return r=r.childContextTypes,r!=null}o(cr,"Zf");function xd(){Qe(dr),Qe(Gt)}o(xd,"$f");function zE(r,e,t){if(Gt.current!==Pi)throw Error(te(168));He(Gt,e),He(dr,t)}o(zE,"ag");function Yw(r,e,t){var n=r.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return t;n=n.getChildContext();for(var i in n)if(!(i in e))throw Error(te(108,KC(r)||"Unknown",i));return ot({},t,n)}o(Yw,"bg");function Dd(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||Pi,ha=Gt.current,He(Gt,r),He(dr,dr.current),!0}o(Dd,"cg");function JE(r,e,t){var n=r.stateNode;if(!n)throw Error(te(169));t?(r=Yw(r,e,ha),n.__reactInternalMemoizedMergedChildContext=r,Qe(dr),Qe(Gt),He(Gt,r)):Qe(dr),He(dr,t)}o(JE,"dg");var On=null,lh=!1,af=!1;function Xw(r){On===null?On=[r]:On.push(r)}o(Xw,"hg");function sk(r){lh=!0,Xw(r)}o(sk,"ig");function Li(){if(!af&&On!==null){af=!0;var r=0,e=Be;try{var t=On;for(Be=1;r<t.length;r++){var n=t[r];do n=n(!0);while(n!==null)}On=null,lh=!1}catch(i){throw On!==null&&(On=On.slice(r+1)),ww(sg,Li),i}finally{Be=e,af=!1}}return null}o(Li,"jg");var qa=[],Ga=0,Nd=null,Ld=0,Pr=[],Mr=0,fa=null,An=1,xn="";function Gi(r,e){qa[Ga++]=Ld,qa[Ga++]=Nd,Nd=r,Ld=e}o(Gi,"tg");function Zw(r,e,t){Pr[Mr++]=An,Pr[Mr++]=xn,Pr[Mr++]=fa,fa=r;var n=An;r=xn;var i=32-Hr(n)-1;n&=~(1<<i),t+=1;var a=32-Hr(e)+i;if(30<a){var s=i-i%5;a=(n&(1<<s)-1).toString(32),n>>=s,i-=s,An=1<<32-Hr(e)+i|t<<i|n,xn=a+r}else An=1<<a|t<<i|n,xn=r}o(Zw,"ug");function pg(r){r.return!==null&&(Gi(r,1),Zw(r,1,0))}o(pg,"vg");function mg(r){for(;r===Nd;)Nd=qa[--Ga],qa[Ga]=null,Ld=qa[--Ga],qa[Ga]=null;for(;r===fa;)fa=Pr[--Mr],Pr[Mr]=null,xn=Pr[--Mr],Pr[Mr]=null,An=Pr[--Mr],Pr[Mr]=null}o(mg,"wg");var br=null,_r=null,Ze=!1,qr=null;function eT(r,e){var t=Ar(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=r,e=r.deletions,e===null?(r.deletions=[t],r.flags|=16):e.push(t)}o(eT,"Ag");function QE(r,e){switch(r.tag){case 5:var t=r.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(r.stateNode=e,br=r,_r=Si(e.firstChild),!0):!1;case 6:return e=r.pendingProps===""||e.nodeType!==3?null:e,e!==null?(r.stateNode=e,br=r,_r=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=fa!==null?{id:An,overflow:xn}:null,r.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=Ar(18,null,null,0),t.stateNode=e,t.return=r,r.child=t,br=r,_r=null,!0):!1;default:return!1}}o(QE,"Cg");function yv(r){return(r.mode&1)!==0&&(r.flags&128)===0}o(yv,"Dg");function Sv(r){if(Ze){var e=_r;if(e){var t=e;if(!QE(r,e)){if(yv(r))throw Error(te(418));e=Si(t.nextSibling);var n=br;e&&QE(r,e)?eT(n,t):(r.flags=r.flags&-4097|2,Ze=!1,br=r)}}else{if(yv(r))throw Error(te(418));r.flags=r.flags&-4097|2,Ze=!1,br=r}}}o(Sv,"Eg");function YE(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;br=r}o(YE,"Fg");function Au(r){if(r!==br)return!1;if(!Ze)return YE(r),Ze=!0,!1;var e;if((e=r.tag!==3)&&!(e=r.tag!==5)&&(e=r.type,e=e!=="head"&&e!=="body"&&!vv(r.type,r.memoizedProps)),e&&(e=_r)){if(yv(r))throw tT(),Error(te(418));for(;e;)eT(r,e),e=Si(e.nextSibling)}if(YE(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(te(317));e:{for(r=r.nextSibling,e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="/$"){if(e===0){_r=Si(r.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}r=r.nextSibling}_r=null}}else _r=br?Si(r.stateNode.nextSibling):null;return!0}o(Au,"Gg");function tT(){for(var r=_r;r;)r=Si(r.nextSibling)}o(tT,"Hg");function Us(){_r=br=null,Ze=!1}o(Us,"Ig");function gg(r){qr===null?qr=[r]:qr.push(r)}o(gg,"Jg");var ok=Gn.ReactCurrentBatchConfig;function wo(r,e,t){if(r=t.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(te(309));var n=t.stateNode}if(!n)throw Error(te(147,r));var i=n,a=""+r;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===a?e.ref:(e=o(function(s){var l=i.refs;s===null?delete l[a]:l[a]=s},"b"),e._stringRef=a,e)}if(typeof r!="string")throw Error(te(284));if(!t._owner)throw Error(te(290,r))}return r}o(wo,"Lg");function xu(r,e){throw r=Object.prototype.toString.call(e),Error(te(31,r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r))}o(xu,"Mg");function XE(r){var e=r._init;return e(r._payload)}o(XE,"Ng");function rT(r){function e(y,S){if(r){var w=y.deletions;w===null?(y.deletions=[S],y.flags|=16):w.push(S)}}o(e,"b");function t(y,S){if(!r)return null;for(;S!==null;)e(y,S),S=S.sibling;return null}o(t,"c");function n(y,S){for(y=new Map;S!==null;)S.key!==null?y.set(S.key,S):y.set(S.index,S),S=S.sibling;return y}o(n,"d");function i(y,S){return y=wi(y,S),y.index=0,y.sibling=null,y}o(i,"e");function a(y,S,w){return y.index=w,r?(w=y.alternate,w!==null?(w=w.index,w<S?(y.flags|=2,S):w):(y.flags|=2,S)):(y.flags|=1048576,S)}o(a,"f");function s(y){return r&&y.alternate===null&&(y.flags|=2),y}o(s,"g");function l(y,S,w,C){return S===null||S.tag!==6?(S=hf(w,y.mode,C),S.return=y,S):(S=i(S,w),S.return=y,S)}o(l,"h");function u(y,S,w,C){var M=w.type;return M===Fa?c(y,S,w.props.children,C,w.key):S!==null&&(S.elementType===M||typeof M=="object"&&M!==null&&M.$$typeof===ai&&XE(M)===S.type)?(C=i(S,w.props),C.ref=wo(y,S,w),C.return=y,C):(C=ud(w.type,w.key,w.props,null,y.mode,C),C.ref=wo(y,S,w),C.return=y,C)}o(u,"k");function d(y,S,w,C){return S===null||S.tag!==4||S.stateNode.containerInfo!==w.containerInfo||S.stateNode.implementation!==w.implementation?(S=ff(w,y.mode,C),S.return=y,S):(S=i(S,w.children||[]),S.return=y,S)}o(d,"l");function c(y,S,w,C,M){return S===null||S.tag!==7?(S=oa(w,y.mode,C,M),S.return=y,S):(S=i(S,w),S.return=y,S)}o(c,"m");function h(y,S,w){if(typeof S=="string"&&S!==""||typeof S=="number")return S=hf(""+S,y.mode,w),S.return=y,S;if(typeof S=="object"&&S!==null){switch(S.$$typeof){case bu:return w=ud(S.type,S.key,S.props,null,y.mode,w),w.ref=wo(y,null,S),w.return=y,w;case ja:return S=ff(S,y.mode,w),S.return=y,S;case ai:var C=S._init;return h(y,C(S._payload),w)}if(Fo(S)||yo(S))return S=oa(S,y.mode,w,null),S.return=y,S;xu(y,S)}return null}o(h,"q");function v(y,S,w,C){var M=S!==null?S.key:null;if(typeof w=="string"&&w!==""||typeof w=="number")return M!==null?null:l(y,S,""+w,C);if(typeof w=="object"&&w!==null){switch(w.$$typeof){case bu:return w.key===M?u(y,S,w,C):null;case ja:return w.key===M?d(y,S,w,C):null;case ai:return M=w._init,v(y,S,M(w._payload),C)}if(Fo(w)||yo(w))return M!==null?null:c(y,S,w,C,null);xu(y,w)}return null}o(v,"r");function g(y,S,w,C,M){if(typeof C=="string"&&C!==""||typeof C=="number")return y=y.get(w)||null,l(S,y,""+C,M);if(typeof C=="object"&&C!==null){switch(C.$$typeof){case bu:return y=y.get(C.key===null?w:C.key)||null,u(S,y,C,M);case ja:return y=y.get(C.key===null?w:C.key)||null,d(S,y,C,M);case ai:var _=C._init;return g(y,S,w,_(C._payload),M)}if(Fo(C)||yo(C))return y=y.get(w)||null,c(S,y,C,M,null);xu(S,C)}return null}o(g,"y");function p(y,S,w,C){for(var M=null,_=null,O=S,b=S=0,F=null;O!==null&&b<w.length;b++){O.index>b?(F=O,O=null):F=O.sibling;var V=v(y,O,w[b],C);if(V===null){O===null&&(O=F);break}r&&O&&V.alternate===null&&e(y,O),S=a(V,S,b),_===null?M=V:_.sibling=V,_=V,O=F}if(b===w.length)return t(y,O),Ze&&Gi(y,b),M;if(O===null){for(;b<w.length;b++)O=h(y,w[b],C),O!==null&&(S=a(O,S,b),_===null?M=O:_.sibling=O,_=O);return Ze&&Gi(y,b),M}for(O=n(y,O);b<w.length;b++)F=g(O,y,b,w[b],C),F!==null&&(r&&F.alternate!==null&&O.delete(F.key===null?b:F.key),S=a(F,S,b),_===null?M=F:_.sibling=F,_=F);return r&&O.forEach(function(z){return e(y,z)}),Ze&&Gi(y,b),M}o(p,"n");function m(y,S,w,C){var M=yo(w);if(typeof M!="function")throw Error(te(150));if(w=M.call(w),w==null)throw Error(te(151));for(var _=M=null,O=S,b=S=0,F=null,V=w.next();O!==null&&!V.done;b++,V=w.next()){O.index>b?(F=O,O=null):F=O.sibling;var z=v(y,O,V.value,C);if(z===null){O===null&&(O=F);break}r&&O&&z.alternate===null&&e(y,O),S=a(z,S,b),_===null?M=z:_.sibling=z,_=z,O=F}if(V.done)return t(y,O),Ze&&Gi(y,b),M;if(O===null){for(;!V.done;b++,V=w.next())V=h(y,V.value,C),V!==null&&(S=a(V,S,b),_===null?M=V:_.sibling=V,_=V);return Ze&&Gi(y,b),M}for(O=n(y,O);!V.done;b++,V=w.next())V=g(O,y,b,V.value,C),V!==null&&(r&&V.alternate!==null&&O.delete(V.key===null?b:V.key),S=a(V,S,b),_===null?M=V:_.sibling=V,_=V);return r&&O.forEach(function(ie){return e(y,ie)}),Ze&&Gi(y,b),M}o(m,"t");function T(y,S,w,C){if(typeof w=="object"&&w!==null&&w.type===Fa&&w.key===null&&(w=w.props.children),typeof w=="object"&&w!==null){switch(w.$$typeof){case bu:e:{for(var M=w.key,_=S;_!==null;){if(_.key===M){if(M=w.type,M===Fa){if(_.tag===7){t(y,_.sibling),S=i(_,w.props.children),S.return=y,y=S;break e}}else if(_.elementType===M||typeof M=="object"&&M!==null&&M.$$typeof===ai&&XE(M)===_.type){t(y,_.sibling),S=i(_,w.props),S.ref=wo(y,_,w),S.return=y,y=S;break e}t(y,_);break}else e(y,_);_=_.sibling}w.type===Fa?(S=oa(w.props.children,y.mode,C,w.key),S.return=y,y=S):(C=ud(w.type,w.key,w.props,null,y.mode,C),C.ref=wo(y,S,w),C.return=y,y=C)}return s(y);case ja:e:{for(_=w.key;S!==null;){if(S.key===_)if(S.tag===4&&S.stateNode.containerInfo===w.containerInfo&&S.stateNode.implementation===w.implementation){t(y,S.sibling),S=i(S,w.children||[]),S.return=y,y=S;break e}else{t(y,S);break}else e(y,S);S=S.sibling}S=ff(w,y.mode,C),S.return=y,y=S}return s(y);case ai:return _=w._init,T(y,S,_(w._payload),C)}if(Fo(w))return p(y,S,w,C);if(yo(w))return m(y,S,w,C);xu(y,w)}return typeof w=="string"&&w!==""||typeof w=="number"?(w=""+w,S!==null&&S.tag===6?(t(y,S.sibling),S=i(S,w),S.return=y,y=S):(t(y,S),S=hf(w,y.mode,C),S.return=y,y=S),s(y)):t(y,S)}return o(T,"J"),T}o(rT,"Og");var js=rT(!0),nT=rT(!1),Ud=Ni(null),jd=null,Ha=null,yg=null;function Sg(){yg=Ha=jd=null}o(Sg,"$g");function Eg(r){var e=Ud.current;Qe(Ud),r._currentValue=e}o(Eg,"ah");function Ev(r,e,t){for(;r!==null;){var n=r.alternate;if((r.childLanes&e)!==e?(r.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),r===t)break;r=r.return}}o(Ev,"bh");function ns(r,e){jd=r,yg=Ha=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&e&&(lr=!0),r.firstContext=null)}o(ns,"ch");function Nr(r){var e=r._currentValue;if(yg!==r)if(r={context:r,memoizedValue:e,next:null},Ha===null){if(jd===null)throw Error(te(308));Ha=r,jd.dependencies={lanes:0,firstContext:r}}else Ha=Ha.next=r;return e}o(Nr,"eh");var ta=null;function _g(r){ta===null?ta=[r]:ta.push(r)}o(_g,"gh");function iT(r,e,t,n){var i=e.interleaved;return i===null?(t.next=t,_g(e)):(t.next=i.next,i.next=t),e.interleaved=t,Wn(r,n)}o(iT,"hh");function Wn(r,e){r.lanes|=e;var t=r.alternate;for(t!==null&&(t.lanes|=e),t=r,r=r.return;r!==null;)r.childLanes|=e,t=r.alternate,t!==null&&(t.childLanes|=e),t=r,r=r.return;return t.tag===3?t.stateNode:null}o(Wn,"ih");var si=!1;function bg(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}o(bg,"kh");function aT(r,e){r=r.updateQueue,e.updateQueue===r&&(e.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}o(aT,"lh");function jn(r,e){return{eventTime:r,lane:e,tag:0,payload:null,callback:null,next:null}}o(jn,"mh");function Ei(r,e,t){var n=r.updateQueue;if(n===null)return null;if(n=n.shared,xe&2){var i=n.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),n.pending=e,Wn(r,t)}return i=n.interleaved,i===null?(e.next=e,_g(n)):(e.next=i.next,i.next=e),n.interleaved=e,Wn(r,t)}o(Ei,"nh");function nd(r,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,og(r,t)}}o(nd,"oh");function ZE(r,e){var t=r.updateQueue,n=r.alternate;if(n!==null&&(n=n.updateQueue,t===n)){var i=null,a=null;if(t=t.firstBaseUpdate,t!==null){do{var s={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};a===null?i=a=s:a=a.next=s,t=t.next}while(t!==null);a===null?i=a=e:a=a.next=e}else i=a=e;t={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:a,shared:n.shared,effects:n.effects},r.updateQueue=t;return}r=t.lastBaseUpdate,r===null?t.firstBaseUpdate=e:r.next=e,t.lastBaseUpdate=e}o(ZE,"ph");function Fd(r,e,t,n){var i=r.updateQueue;si=!1;var a=i.firstBaseUpdate,s=i.lastBaseUpdate,l=i.shared.pending;if(l!==null){i.shared.pending=null;var u=l,d=u.next;u.next=null,s===null?a=d:s.next=d,s=u;var c=r.alternate;c!==null&&(c=c.updateQueue,l=c.lastBaseUpdate,l!==s&&(l===null?c.firstBaseUpdate=d:l.next=d,c.lastBaseUpdate=u))}if(a!==null){var h=i.baseState;s=0,c=d=u=null,l=a;do{var v=l.lane,g=l.eventTime;if((n&v)===v){c!==null&&(c=c.next={eventTime:g,lane:0,tag:l.tag,payload:l.payload,callback:l.callback,next:null});e:{var p=r,m=l;switch(v=e,g=t,m.tag){case 1:if(p=m.payload,typeof p=="function"){h=p.call(g,h,v);break e}h=p;break e;case 3:p.flags=p.flags&-65537|128;case 0:if(p=m.payload,v=typeof p=="function"?p.call(g,h,v):p,v==null)break e;h=ot({},h,v);break e;case 2:si=!0}}l.callback!==null&&l.lane!==0&&(r.flags|=64,v=i.effects,v===null?i.effects=[l]:v.push(l))}else g={eventTime:g,lane:v,tag:l.tag,payload:l.payload,callback:l.callback,next:null},c===null?(d=c=g,u=h):c=c.next=g,s|=v;if(l=l.next,l===null){if(l=i.shared.pending,l===null)break;v=l,l=v.next,v.next=null,i.lastBaseUpdate=v,i.shared.pending=null}}while(!0);if(c===null&&(u=h),i.baseState=u,i.firstBaseUpdate=d,i.lastBaseUpdate=c,e=i.shared.interleaved,e!==null){i=e;do s|=i.lane,i=i.next;while(i!==e)}else a===null&&(i.shared.lanes=0);pa|=s,r.lanes=s,r.memoizedState=h}}o(Fd,"qh");function e_(r,e,t){if(r=e.effects,e.effects=null,r!==null)for(e=0;e<r.length;e++){var n=r[e],i=n.callback;if(i!==null){if(n.callback=null,n=t,typeof i!="function")throw Error(te(191,i));i.call(n)}}}o(e_,"sh");var nu={},gn=Ni(nu),_l=Ni(nu),bl=Ni(nu);function ra(r){if(r===nu)throw Error(te(174));return r}o(ra,"xh");function wg(r,e){switch(He(bl,e),He(_l,r),He(gn,nu),r=e.nodeType,r){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:ev(null,"");break;default:r=r===8?e.parentNode:e,e=r.namespaceURI||null,r=r.tagName,e=ev(e,r)}Qe(gn),He(gn,e)}o(wg,"yh");function Fs(){Qe(gn),Qe(_l),Qe(bl)}o(Fs,"zh");function sT(r){ra(bl.current);var e=ra(gn.current),t=ev(e,r.type);e!==t&&(He(_l,r),He(gn,t))}o(sT,"Ah");function Tg(r){_l.current===r&&(Qe(gn),Qe(_l))}o(Tg,"Bh");var nt=Ni(0);function Bd(r){for(var e=r;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}o(Bd,"Ch");var sf=[];function Rg(){for(var r=0;r<sf.length;r++)sf[r]._workInProgressVersionPrimary=null;sf.length=0}o(Rg,"Eh");var id=Gn.ReactCurrentDispatcher,of=Gn.ReactCurrentBatchConfig,va=0,at=null,Rt=null,At=null,$d=!1,Qo=!1,wl=0,lk=0;function Bt(){throw Error(te(321))}o(Bt,"P");function Ig(r,e){if(e===null)return!1;for(var t=0;t<e.length&&t<r.length;t++)if(!Xr(r[t],e[t]))return!1;return!0}o(Ig,"Mh");function Cg(r,e,t,n,i,a){if(va=a,at=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,id.current=r===null||r.memoizedState===null?hk:fk,r=t(n,i),Qo){a=0;do{if(Qo=!1,wl=0,25<=a)throw Error(te(301));a+=1,At=Rt=null,e.updateQueue=null,id.current=vk,r=t(n,i)}while(Qo)}if(id.current=Wd,e=Rt!==null&&Rt.next!==null,va=0,At=Rt=at=null,$d=!1,e)throw Error(te(300));return r}o(Cg,"Nh");function Og(){var r=wl!==0;return wl=0,r}o(Og,"Sh");function sn(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return At===null?at.memoizedState=At=r:At=At.next=r,At}o(sn,"Th");function Lr(){if(Rt===null){var r=at.alternate;r=r!==null?r.memoizedState:null}else r=Rt.next;var e=At===null?at.memoizedState:At.next;if(e!==null)At=e,Rt=r;else{if(r===null)throw Error(te(310));Rt=r,r={memoizedState:Rt.memoizedState,baseState:Rt.baseState,baseQueue:Rt.baseQueue,queue:Rt.queue,next:null},At===null?at.memoizedState=At=r:At=At.next=r}return At}o(Lr,"Uh");function Tl(r,e){return typeof e=="function"?e(r):e}o(Tl,"Vh");function lf(r){var e=Lr(),t=e.queue;if(t===null)throw Error(te(311));t.lastRenderedReducer=r;var n=Rt,i=n.baseQueue,a=t.pending;if(a!==null){if(i!==null){var s=i.next;i.next=a.next,a.next=s}n.baseQueue=i=a,t.pending=null}if(i!==null){a=i.next,n=n.baseState;var l=s=null,u=null,d=a;do{var c=d.lane;if((va&c)===c)u!==null&&(u=u.next={lane:0,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null}),n=d.hasEagerState?d.eagerState:r(n,d.action);else{var h={lane:c,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null};u===null?(l=u=h,s=n):u=u.next=h,at.lanes|=c,pa|=c}d=d.next}while(d!==null&&d!==a);u===null?s=n:u.next=l,Xr(n,e.memoizedState)||(lr=!0),e.memoizedState=n,e.baseState=s,e.baseQueue=u,t.lastRenderedState=n}if(r=t.interleaved,r!==null){i=r;do a=i.lane,at.lanes|=a,pa|=a,i=i.next;while(i!==r)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}o(lf,"Wh");function uf(r){var e=Lr(),t=e.queue;if(t===null)throw Error(te(311));t.lastRenderedReducer=r;var n=t.dispatch,i=t.pending,a=e.memoizedState;if(i!==null){t.pending=null;var s=i=i.next;do a=r(a,s.action),s=s.next;while(s!==i);Xr(a,e.memoizedState)||(lr=!0),e.memoizedState=a,e.baseQueue===null&&(e.baseState=a),t.lastRenderedState=a}return[a,n]}o(uf,"Xh");function oT(){}o(oT,"Yh");function lT(r,e){var t=at,n=Lr(),i=e(),a=!Xr(n.memoizedState,i);if(a&&(n.memoizedState=i,lr=!0),n=n.queue,kg(cT.bind(null,t,n,r),[r]),n.getSnapshot!==e||a||At!==null&&At.memoizedState.tag&1){if(t.flags|=2048,Rl(9,dT.bind(null,t,n,i,e),void 0,null),Dt===null)throw Error(te(349));va&30||uT(t,e,i)}return i}o(lT,"Zh");function uT(r,e,t){r.flags|=16384,r={getSnapshot:e,value:t},e=at.updateQueue,e===null?(e={lastEffect:null,stores:null},at.updateQueue=e,e.stores=[r]):(t=e.stores,t===null?e.stores=[r]:t.push(r))}o(uT,"di");function dT(r,e,t,n){e.value=t,e.getSnapshot=n,hT(e)&&fT(r)}o(dT,"ci");function cT(r,e,t){return t(function(){hT(e)&&fT(r)})}o(cT,"ai");function hT(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!Xr(r,t)}catch{return!0}}o(hT,"ei");function fT(r){var e=Wn(r,1);e!==null&&zr(e,r,1,-1)}o(fT,"fi");function t_(r){var e=sn();return typeof r=="function"&&(r=r()),e.memoizedState=e.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Tl,lastRenderedState:r},e.queue=r,r=r.dispatch=ck.bind(null,at,r),[e.memoizedState,r]}o(t_,"hi");function Rl(r,e,t,n){return r={tag:r,create:e,destroy:t,deps:n,next:null},e=at.updateQueue,e===null?(e={lastEffect:null,stores:null},at.updateQueue=e,e.lastEffect=r.next=r):(t=e.lastEffect,t===null?e.lastEffect=r.next=r:(n=t.next,t.next=r,r.next=n,e.lastEffect=r)),r}o(Rl,"bi");function vT(){return Lr().memoizedState}o(vT,"ji");function ad(r,e,t,n){var i=sn();at.flags|=r,i.memoizedState=Rl(1|e,t,void 0,n===void 0?null:n)}o(ad,"ki");function uh(r,e,t,n){var i=Lr();n=n===void 0?null:n;var a=void 0;if(Rt!==null){var s=Rt.memoizedState;if(a=s.destroy,n!==null&&Ig(n,s.deps)){i.memoizedState=Rl(e,t,a,n);return}}at.flags|=r,i.memoizedState=Rl(1|e,t,a,n)}o(uh,"li");function r_(r,e){return ad(8390656,8,r,e)}o(r_,"mi");function kg(r,e){return uh(2048,8,r,e)}o(kg,"$h");function pT(r,e){return uh(4,2,r,e)}o(pT,"ni");function mT(r,e){return uh(4,4,r,e)}o(mT,"oi");function gT(r,e){if(typeof e=="function")return r=r(),e(r),function(){e(null)};if(e!=null)return r=r(),e.current=r,function(){e.current=null}}o(gT,"pi");function yT(r,e,t){return t=t!=null?t.concat([r]):null,uh(4,4,gT.bind(null,e,r),t)}o(yT,"qi");function Pg(){}o(Pg,"ri");function ST(r,e){var t=Lr();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&Ig(e,n[1])?n[0]:(t.memoizedState=[r,e],r)}o(ST,"si");function ET(r,e){var t=Lr();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&Ig(e,n[1])?n[0]:(r=r(),t.memoizedState=[r,e],r)}o(ET,"ti");function _T(r,e,t){return va&21?(Xr(t,e)||(t=Iw(),at.lanes|=t,pa|=t,r.baseState=!0),e):(r.baseState&&(r.baseState=!1,lr=!0),r.memoizedState=t)}o(_T,"ui");function uk(r,e){var t=Be;Be=t!==0&&4>t?t:4,r(!0);var n=of.transition;of.transition={};try{r(!1),e()}finally{Be=t,of.transition=n}}o(uk,"vi");function bT(){return Lr().memoizedState}o(bT,"wi");function dk(r,e,t){var n=bi(r);if(t={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null},wT(r))TT(e,t);else if(t=iT(r,e,t,n),t!==null){var i=er();zr(t,r,n,i),RT(t,e,n)}}o(dk,"xi");function ck(r,e,t){var n=bi(r),i={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null};if(wT(r))TT(e,i);else{var a=r.alternate;if(r.lanes===0&&(a===null||a.lanes===0)&&(a=e.lastRenderedReducer,a!==null))try{var s=e.lastRenderedState,l=a(s,t);if(i.hasEagerState=!0,i.eagerState=l,Xr(l,s)){var u=e.interleaved;u===null?(i.next=i,_g(e)):(i.next=u.next,u.next=i),e.interleaved=i;return}}catch{}finally{}t=iT(r,e,i,n),t!==null&&(i=er(),zr(t,r,n,i),RT(t,e,n))}}o(ck,"ii");function wT(r){var e=r.alternate;return r===at||e!==null&&e===at}o(wT,"zi");function TT(r,e){Qo=$d=!0;var t=r.pending;t===null?e.next=e:(e.next=t.next,t.next=e),r.pending=e}o(TT,"Ai");function RT(r,e,t){if(t&4194240){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,og(r,t)}}o(RT,"Bi");var Wd={readContext:Nr,useCallback:Bt,useContext:Bt,useEffect:Bt,useImperativeHandle:Bt,useInsertionEffect:Bt,useLayoutEffect:Bt,useMemo:Bt,useReducer:Bt,useRef:Bt,useState:Bt,useDebugValue:Bt,useDeferredValue:Bt,useTransition:Bt,useMutableSource:Bt,useSyncExternalStore:Bt,useId:Bt,unstable_isNewReconciler:!1},hk={readContext:Nr,useCallback:o(function(r,e){return sn().memoizedState=[r,e===void 0?null:e],r},"useCallback"),useContext:Nr,useEffect:r_,useImperativeHandle:o(function(r,e,t){return t=t!=null?t.concat([r]):null,ad(4194308,4,gT.bind(null,e,r),t)},"useImperativeHandle"),useLayoutEffect:o(function(r,e){return ad(4194308,4,r,e)},"useLayoutEffect"),useInsertionEffect:o(function(r,e){return ad(4,2,r,e)},"useInsertionEffect"),useMemo:o(function(r,e){var t=sn();return e=e===void 0?null:e,r=r(),t.memoizedState=[r,e],r},"useMemo"),useReducer:o(function(r,e,t){var n=sn();return e=t!==void 0?t(e):e,n.memoizedState=n.baseState=e,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:e},n.queue=r,r=r.dispatch=dk.bind(null,at,r),[n.memoizedState,r]},"useReducer"),useRef:o(function(r){var e=sn();return r={current:r},e.memoizedState=r},"useRef"),useState:t_,useDebugValue:Pg,useDeferredValue:o(function(r){return sn().memoizedState=r},"useDeferredValue"),useTransition:o(function(){var r=t_(!1),e=r[0];return r=uk.bind(null,r[1]),sn().memoizedState=r,[e,r]},"useTransition"),useMutableSource:o(function(){},"useMutableSource"),useSyncExternalStore:o(function(r,e,t){var n=at,i=sn();if(Ze){if(t===void 0)throw Error(te(407));t=t()}else{if(t=e(),Dt===null)throw Error(te(349));va&30||uT(n,e,t)}i.memoizedState=t;var a={value:t,getSnapshot:e};return i.queue=a,r_(cT.bind(null,n,a,r),[r]),n.flags|=2048,Rl(9,dT.bind(null,n,a,t,e),void 0,null),t},"useSyncExternalStore"),useId:o(function(){var r=sn(),e=Dt.identifierPrefix;if(Ze){var t=xn,n=An;t=(n&~(1<<32-Hr(n)-1)).toString(32)+t,e=":"+e+"R"+t,t=wl++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=lk++,e=":"+e+"r"+t.toString(32)+":";return r.memoizedState=e},"useId"),unstable_isNewReconciler:!1},fk={readContext:Nr,useCallback:ST,useContext:Nr,useEffect:kg,useImperativeHandle:yT,useInsertionEffect:pT,useLayoutEffect:mT,useMemo:ET,useReducer:lf,useRef:vT,useState:o(function(){return lf(Tl)},"useState"),useDebugValue:Pg,useDeferredValue:o(function(r){var e=Lr();return _T(e,Rt.memoizedState,r)},"useDeferredValue"),useTransition:o(function(){var r=lf(Tl)[0],e=Lr().memoizedState;return[r,e]},"useTransition"),useMutableSource:oT,useSyncExternalStore:lT,useId:bT,unstable_isNewReconciler:!1},vk={readContext:Nr,useCallback:ST,useContext:Nr,useEffect:kg,useImperativeHandle:yT,useInsertionEffect:pT,useLayoutEffect:mT,useMemo:ET,useReducer:uf,useRef:vT,useState:o(function(){return uf(Tl)},"useState"),useDebugValue:Pg,useDeferredValue:o(function(r){var e=Lr();return Rt===null?e.memoizedState=r:_T(e,Rt.memoizedState,r)},"useDeferredValue"),useTransition:o(function(){var r=uf(Tl)[0],e=Lr().memoizedState;return[r,e]},"useTransition"),useMutableSource:oT,useSyncExternalStore:lT,useId:bT,unstable_isNewReconciler:!1};function $r(r,e){if(r&&r.defaultProps){e=ot({},e),r=r.defaultProps;for(var t in r)e[t]===void 0&&(e[t]=r[t]);return e}return e}o($r,"Ci");function _v(r,e,t,n){e=r.memoizedState,t=t(n,e),t=t==null?e:ot({},e,t),r.memoizedState=t,r.lanes===0&&(r.updateQueue.baseState=t)}o(_v,"Di");var dh={isMounted:o(function(r){return(r=r._reactInternals)?ba(r)===r:!1},"isMounted"),enqueueSetState:o(function(r,e,t){r=r._reactInternals;var n=er(),i=bi(r),a=jn(n,i);a.payload=e,t!=null&&(a.callback=t),e=Ei(r,a,i),e!==null&&(zr(e,r,i,n),nd(e,r,i))},"enqueueSetState"),enqueueReplaceState:o(function(r,e,t){r=r._reactInternals;var n=er(),i=bi(r),a=jn(n,i);a.tag=1,a.payload=e,t!=null&&(a.callback=t),e=Ei(r,a,i),e!==null&&(zr(e,r,i,n),nd(e,r,i))},"enqueueReplaceState"),enqueueForceUpdate:o(function(r,e){r=r._reactInternals;var t=er(),n=bi(r),i=jn(t,n);i.tag=2,e!=null&&(i.callback=e),e=Ei(r,i,n),e!==null&&(zr(e,r,n,t),nd(e,r,n))},"enqueueForceUpdate")};function n_(r,e,t,n,i,a,s){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(n,a,s):e.prototype&&e.prototype.isPureReactComponent?!gl(t,n)||!gl(i,a):!0}o(n_,"Fi");function IT(r,e,t){var n=!1,i=Pi,a=e.contextType;return typeof a=="object"&&a!==null?a=Nr(a):(i=cr(e)?ha:Gt.current,n=e.contextTypes,a=(n=n!=null)?Ls(r,i):Pi),e=new e(t,a),r.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=dh,r.stateNode=e,e._reactInternals=r,n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=i,r.__reactInternalMemoizedMaskedChildContext=a),e}o(IT,"Gi");function i_(r,e,t,n){r=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,n),e.state!==r&&dh.enqueueReplaceState(e,e.state,null)}o(i_,"Hi");function bv(r,e,t,n){var i=r.stateNode;i.props=t,i.state=r.memoizedState,i.refs={},bg(r);var a=e.contextType;typeof a=="object"&&a!==null?i.context=Nr(a):(a=cr(e)?ha:Gt.current,i.context=Ls(r,a)),i.state=r.memoizedState,a=e.getDerivedStateFromProps,typeof a=="function"&&(_v(r,e,a,t),i.state=r.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&dh.enqueueReplaceState(i,i.state,null),Fd(r,t,i,n),i.state=r.memoizedState),typeof i.componentDidMount=="function"&&(r.flags|=4194308)}o(bv,"Ii");function Bs(r,e){try{var t="",n=e;do t+=WC(n),n=n.return;while(n);var i=t}catch(a){i=`
Error generating stack: `+a.message+`
`+a.stack}return{value:r,source:e,stack:i,digest:null}}o(Bs,"Ji");function df(r,e,t){return{value:r,source:null,stack:t??null,digest:e??null}}o(df,"Ki");function wv(r,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}o(wv,"Li");var pk=typeof WeakMap=="function"?WeakMap:Map;function CT(r,e,t){t=jn(-1,t),t.tag=3,t.payload={element:null};var n=e.value;return t.callback=function(){Vd||(Vd=!0,xv=n),wv(r,e)},t}o(CT,"Ni");function OT(r,e,t){t=jn(-1,t),t.tag=3;var n=r.type.getDerivedStateFromError;if(typeof n=="function"){var i=e.value;t.payload=function(){return n(i)},t.callback=function(){wv(r,e)}}var a=r.stateNode;return a!==null&&typeof a.componentDidCatch=="function"&&(t.callback=function(){wv(r,e),typeof n!="function"&&(_i===null?_i=new Set([this]):_i.add(this));var s=e.stack;this.componentDidCatch(e.value,{componentStack:s!==null?s:""})}),t}o(OT,"Qi");function a_(r,e,t){var n=r.pingCache;if(n===null){n=r.pingCache=new pk;var i=new Set;n.set(e,i)}else i=n.get(e),i===void 0&&(i=new Set,n.set(e,i));i.has(t)||(i.add(t),r=kk.bind(null,r,e,t),e.then(r,r))}o(a_,"Si");function s_(r){do{var e;if((e=r.tag===13)&&(e=r.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return r;r=r.return}while(r!==null);return null}o(s_,"Ui");function o_(r,e,t,n,i){return r.mode&1?(r.flags|=65536,r.lanes=i,r):(r===e?r.flags|=65536:(r.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=jn(-1,1),e.tag=2,Ei(t,e,1))),t.lanes|=1),r)}o(o_,"Vi");var mk=Gn.ReactCurrentOwner,lr=!1;function Yt(r,e,t,n){e.child=r===null?nT(e,null,t,n):js(e,r.child,t,n)}o(Yt,"Xi");function l_(r,e,t,n,i){t=t.render;var a=e.ref;return ns(e,i),n=Cg(r,e,t,n,a,i),t=Og(),r!==null&&!lr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Kn(r,e,i)):(Ze&&t&&pg(e),e.flags|=1,Yt(r,e,n,i),e.child)}o(l_,"Yi");function u_(r,e,t,n,i){if(r===null){var a=t.type;return typeof a=="function"&&!jg(a)&&a.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=a,kT(r,e,a,n,i)):(r=ud(t.type,null,n,e,e.mode,i),r.ref=e.ref,r.return=e,e.child=r)}if(a=r.child,!(r.lanes&i)){var s=a.memoizedProps;if(t=t.compare,t=t!==null?t:gl,t(s,n)&&r.ref===e.ref)return Kn(r,e,i)}return e.flags|=1,r=wi(a,n),r.ref=e.ref,r.return=e,e.child=r}o(u_,"$i");function kT(r,e,t,n,i){if(r!==null){var a=r.memoizedProps;if(gl(a,n)&&r.ref===e.ref)if(lr=!1,e.pendingProps=n=a,(r.lanes&i)!==0)r.flags&131072&&(lr=!0);else return e.lanes=r.lanes,Kn(r,e,i)}return Tv(r,e,t,n,i)}o(kT,"bj");function PT(r,e,t){var n=e.pendingProps,i=n.children,a=r!==null?r.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},He(Ja,Sr),Sr|=t;else{if(!(t&1073741824))return r=a!==null?a.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:r,cachePool:null,transitions:null},e.updateQueue=null,He(Ja,Sr),Sr|=r,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=a!==null?a.baseLanes:t,He(Ja,Sr),Sr|=n}else a!==null?(n=a.baseLanes|t,e.memoizedState=null):n=t,He(Ja,Sr),Sr|=n;return Yt(r,e,i,t),e.child}o(PT,"dj");function MT(r,e){var t=e.ref;(r===null&&t!==null||r!==null&&r.ref!==t)&&(e.flags|=512,e.flags|=2097152)}o(MT,"gj");function Tv(r,e,t,n,i){var a=cr(t)?ha:Gt.current;return a=Ls(e,a),ns(e,i),t=Cg(r,e,t,n,a,i),n=Og(),r!==null&&!lr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Kn(r,e,i)):(Ze&&n&&pg(e),e.flags|=1,Yt(r,e,t,i),e.child)}o(Tv,"cj");function d_(r,e,t,n,i){if(cr(t)){var a=!0;Dd(e)}else a=!1;if(ns(e,i),e.stateNode===null)sd(r,e),IT(e,t,n),bv(e,t,n,i),n=!0;else if(r===null){var s=e.stateNode,l=e.memoizedProps;s.props=l;var u=s.context,d=t.contextType;typeof d=="object"&&d!==null?d=Nr(d):(d=cr(t)?ha:Gt.current,d=Ls(e,d));var c=t.getDerivedStateFromProps,h=typeof c=="function"||typeof s.getSnapshotBeforeUpdate=="function";h||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(l!==n||u!==d)&&i_(e,s,n,d),si=!1;var v=e.memoizedState;s.state=v,Fd(e,n,s,i),u=e.memoizedState,l!==n||v!==u||dr.current||si?(typeof c=="function"&&(_v(e,t,c,n),u=e.memoizedState),(l=si||n_(e,t,l,n,v,u,d))?(h||typeof s.UNSAFE_componentWillMount!="function"&&typeof s.componentWillMount!="function"||(typeof s.componentWillMount=="function"&&s.componentWillMount(),typeof s.UNSAFE_componentWillMount=="function"&&s.UNSAFE_componentWillMount()),typeof s.componentDidMount=="function"&&(e.flags|=4194308)):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=u),s.props=n,s.state=u,s.context=d,n=l):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{s=e.stateNode,aT(r,e),l=e.memoizedProps,d=e.type===e.elementType?l:$r(e.type,l),s.props=d,h=e.pendingProps,v=s.context,u=t.contextType,typeof u=="object"&&u!==null?u=Nr(u):(u=cr(t)?ha:Gt.current,u=Ls(e,u));var g=t.getDerivedStateFromProps;(c=typeof g=="function"||typeof s.getSnapshotBeforeUpdate=="function")||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(l!==h||v!==u)&&i_(e,s,n,u),si=!1,v=e.memoizedState,s.state=v,Fd(e,n,s,i);var p=e.memoizedState;l!==h||v!==p||dr.current||si?(typeof g=="function"&&(_v(e,t,g,n),p=e.memoizedState),(d=si||n_(e,t,d,n,v,p,u)||!1)?(c||typeof s.UNSAFE_componentWillUpdate!="function"&&typeof s.componentWillUpdate!="function"||(typeof s.componentWillUpdate=="function"&&s.componentWillUpdate(n,p,u),typeof s.UNSAFE_componentWillUpdate=="function"&&s.UNSAFE_componentWillUpdate(n,p,u)),typeof s.componentDidUpdate=="function"&&(e.flags|=4),typeof s.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof s.componentDidUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=p),s.props=n,s.state=p,s.context=u,n=d):(typeof s.componentDidUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=1024),n=!1)}return Rv(r,e,t,n,a,i)}o(d_,"hj");function Rv(r,e,t,n,i,a){MT(r,e);var s=(e.flags&128)!==0;if(!n&&!s)return i&&JE(e,t,!1),Kn(r,e,a);n=e.stateNode,mk.current=e;var l=s&&typeof t.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,r!==null&&s?(e.child=js(e,r.child,null,a),e.child=js(e,null,l,a)):Yt(r,e,l,a),e.memoizedState=n.state,i&&JE(e,t,!0),e.child}o(Rv,"jj");function AT(r){var e=r.stateNode;e.pendingContext?zE(r,e.pendingContext,e.pendingContext!==e.context):e.context&&zE(r,e.context,!1),wg(r,e.containerInfo)}o(AT,"kj");function c_(r,e,t,n,i){return Us(),gg(i),e.flags|=256,Yt(r,e,t,n),e.child}o(c_,"lj");var Iv={dehydrated:null,treeContext:null,retryLane:0};function Cv(r){return{baseLanes:r,cachePool:null,transitions:null}}o(Cv,"nj");function xT(r,e,t){var n=e.pendingProps,i=nt.current,a=!1,s=(e.flags&128)!==0,l;if((l=s)||(l=r!==null&&r.memoizedState===null?!1:(i&2)!==0),l?(a=!0,e.flags&=-129):(r===null||r.memoizedState!==null)&&(i|=1),He(nt,i&1),r===null)return Sv(e),r=e.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(e.mode&1?r.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(s=n.children,r=n.fallback,a?(n=e.mode,a=e.child,s={mode:"hidden",children:s},!(n&1)&&a!==null?(a.childLanes=0,a.pendingProps=s):a=fh(s,n,0,null),r=oa(r,n,t,null),a.return=e,r.return=e,a.sibling=r,e.child=a,e.child.memoizedState=Cv(t),e.memoizedState=Iv,r):Mg(e,s));if(i=r.memoizedState,i!==null&&(l=i.dehydrated,l!==null))return gk(r,e,s,n,l,i,t);if(a){a=n.fallback,s=e.mode,i=r.child,l=i.sibling;var u={mode:"hidden",children:n.children};return!(s&1)&&e.child!==i?(n=e.child,n.childLanes=0,n.pendingProps=u,e.deletions=null):(n=wi(i,u),n.subtreeFlags=i.subtreeFlags&14680064),l!==null?a=wi(l,a):(a=oa(a,s,t,null),a.flags|=2),a.return=e,n.return=e,n.sibling=a,e.child=n,n=a,a=e.child,s=r.child.memoizedState,s=s===null?Cv(t):{baseLanes:s.baseLanes|t,cachePool:null,transitions:s.transitions},a.memoizedState=s,a.childLanes=r.childLanes&~t,e.memoizedState=Iv,n}return a=r.child,r=a.sibling,n=wi(a,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=t),n.return=e,n.sibling=null,r!==null&&(t=e.deletions,t===null?(e.deletions=[r],e.flags|=16):t.push(r)),e.child=n,e.memoizedState=null,n}o(xT,"oj");function Mg(r,e){return e=fh({mode:"visible",children:e},r.mode,0,null),e.return=r,r.child=e}o(Mg,"qj");function Du(r,e,t,n){return n!==null&&gg(n),js(e,r.child,null,t),r=Mg(e,e.pendingProps.children),r.flags|=2,e.memoizedState=null,r}o(Du,"sj");function gk(r,e,t,n,i,a,s){if(t)return e.flags&256?(e.flags&=-257,n=df(Error(te(422))),Du(r,e,s,n)):e.memoizedState!==null?(e.child=r.child,e.flags|=128,null):(a=n.fallback,i=e.mode,n=fh({mode:"visible",children:n.children},i,0,null),a=oa(a,i,s,null),a.flags|=2,n.return=e,a.return=e,n.sibling=a,e.child=n,e.mode&1&&js(e,r.child,null,s),e.child.memoizedState=Cv(s),e.memoizedState=Iv,a);if(!(e.mode&1))return Du(r,e,s,null);if(i.data==="$!"){if(n=i.nextSibling&&i.nextSibling.dataset,n)var l=n.dgst;return n=l,a=Error(te(419)),n=df(a,n,void 0),Du(r,e,s,n)}if(l=(s&r.childLanes)!==0,lr||l){if(n=Dt,n!==null){switch(s&-s){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(n.suspendedLanes|s)?0:i,i!==0&&i!==a.retryLane&&(a.retryLane=i,Wn(r,i),zr(n,r,i,-1))}return Ug(),n=df(Error(te(421))),Du(r,e,s,n)}return i.data==="$?"?(e.flags|=128,e.child=r.child,e=Pk.bind(null,r),i._reactRetry=e,null):(r=a.treeContext,_r=Si(i.nextSibling),br=e,Ze=!0,qr=null,r!==null&&(Pr[Mr++]=An,Pr[Mr++]=xn,Pr[Mr++]=fa,An=r.id,xn=r.overflow,fa=e),e=Mg(e,n.children),e.flags|=4096,e)}o(gk,"rj");function h_(r,e,t){r.lanes|=e;var n=r.alternate;n!==null&&(n.lanes|=e),Ev(r.return,e,t)}o(h_,"vj");function cf(r,e,t,n,i){var a=r.memoizedState;a===null?r.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:t,tailMode:i}:(a.isBackwards=e,a.rendering=null,a.renderingStartTime=0,a.last=n,a.tail=t,a.tailMode=i)}o(cf,"wj");function DT(r,e,t){var n=e.pendingProps,i=n.revealOrder,a=n.tail;if(Yt(r,e,n.children,t),n=nt.current,n&2)n=n&1|2,e.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=e.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&h_(r,t,e);else if(r.tag===19)h_(r,t,e);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break e;for(;r.sibling===null;){if(r.return===null||r.return===e)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}n&=1}if(He(nt,n),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)r=t.alternate,r!==null&&Bd(r)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),cf(e,!1,i,t,a);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(r=i.alternate,r!==null&&Bd(r)===null){e.child=i;break}r=i.sibling,i.sibling=t,t=i,i=r}cf(e,!0,t,null,a);break;case"together":cf(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}o(DT,"xj");function sd(r,e){!(e.mode&1)&&r!==null&&(r.alternate=null,e.alternate=null,e.flags|=2)}o(sd,"ij");function Kn(r,e,t){if(r!==null&&(e.dependencies=r.dependencies),pa|=e.lanes,!(t&e.childLanes))return null;if(r!==null&&e.child!==r.child)throw Error(te(153));if(e.child!==null){for(r=e.child,t=wi(r,r.pendingProps),e.child=t,t.return=e;r.sibling!==null;)r=r.sibling,t=t.sibling=wi(r,r.pendingProps),t.return=e;t.sibling=null}return e.child}o(Kn,"Zi");function yk(r,e,t){switch(e.tag){case 3:AT(e),Us();break;case 5:sT(e);break;case 1:cr(e.type)&&Dd(e);break;case 4:wg(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,i=e.memoizedProps.value;He(Ud,n._currentValue),n._currentValue=i;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(He(nt,nt.current&1),e.flags|=128,null):t&e.child.childLanes?xT(r,e,t):(He(nt,nt.current&1),r=Kn(r,e,t),r!==null?r.sibling:null);He(nt,nt.current&1);break;case 19:if(n=(t&e.childLanes)!==0,r.flags&128){if(n)return DT(r,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),He(nt,nt.current),n)break;return null;case 22:case 23:return e.lanes=0,PT(r,e,t)}return Kn(r,e,t)}o(yk,"yj");var NT,Ov,LT,UT;NT=o(function(r,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)r.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}},"zj");Ov=o(function(){},"Aj");LT=o(function(r,e,t,n){var i=r.memoizedProps;if(i!==n){r=e.stateNode,ra(gn.current);var a=null;switch(t){case"input":i=Qf(r,i),n=Qf(r,n),a=[];break;case"select":i=ot({},i,{value:void 0}),n=ot({},n,{value:void 0}),a=[];break;case"textarea":i=Zf(r,i),n=Zf(r,n),a=[];break;default:typeof i.onClick!="function"&&typeof n.onClick=="function"&&(r.onclick=Ad)}tv(t,n);var s;t=null;for(d in i)if(!n.hasOwnProperty(d)&&i.hasOwnProperty(d)&&i[d]!=null)if(d==="style"){var l=i[d];for(s in l)l.hasOwnProperty(s)&&(t||(t={}),t[s]="")}else d!=="dangerouslySetInnerHTML"&&d!=="children"&&d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&d!=="autoFocus"&&(dl.hasOwnProperty(d)?a||(a=[]):(a=a||[]).push(d,null));for(d in n){var u=n[d];if(l=i!=null?i[d]:void 0,n.hasOwnProperty(d)&&u!==l&&(u!=null||l!=null))if(d==="style")if(l){for(s in l)!l.hasOwnProperty(s)||u&&u.hasOwnProperty(s)||(t||(t={}),t[s]="");for(s in u)u.hasOwnProperty(s)&&l[s]!==u[s]&&(t||(t={}),t[s]=u[s])}else t||(a||(a=[]),a.push(d,t)),t=u;else d==="dangerouslySetInnerHTML"?(u=u?u.__html:void 0,l=l?l.__html:void 0,u!=null&&l!==u&&(a=a||[]).push(d,u)):d==="children"?typeof u!="string"&&typeof u!="number"||(a=a||[]).push(d,""+u):d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&(dl.hasOwnProperty(d)?(u!=null&&d==="onScroll"&&ze("scroll",r),a||l===u||(a=[])):(a=a||[]).push(d,u))}t&&(a=a||[]).push("style",t);var d=a;(e.updateQueue=d)&&(e.flags|=4)}},"Bj");UT=o(function(r,e,t,n){t!==n&&(e.flags|=4)},"Cj");function To(r,e){if(!Ze)switch(r.tailMode){case"hidden":e=r.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?r.tail=null:t.sibling=null;break;case"collapsed":t=r.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e||r.tail===null?r.tail=null:r.tail.sibling=null:n.sibling=null}}o(To,"Dj");function $t(r){var e=r.alternate!==null&&r.alternate.child===r.child,t=0,n=0;if(e)for(var i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags&14680064,n|=i.flags&14680064,i.return=r,i=i.sibling;else for(i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=r,i=i.sibling;return r.subtreeFlags|=n,r.childLanes=t,e}o($t,"S");function Sk(r,e,t){var n=e.pendingProps;switch(mg(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return $t(e),null;case 1:return cr(e.type)&&xd(),$t(e),null;case 3:return n=e.stateNode,Fs(),Qe(dr),Qe(Gt),Rg(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(r===null||r.child===null)&&(Au(e)?e.flags|=4:r===null||r.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,qr!==null&&(Lv(qr),qr=null))),Ov(r,e),$t(e),null;case 5:Tg(e);var i=ra(bl.current);if(t=e.type,r!==null&&e.stateNode!=null)LT(r,e,t,n,i),r.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(te(166));return $t(e),null}if(r=ra(gn.current),Au(e)){n=e.stateNode,t=e.type;var a=e.memoizedProps;switch(n[hn]=e,n[El]=a,r=(e.mode&1)!==0,t){case"dialog":ze("cancel",n),ze("close",n);break;case"iframe":case"object":case"embed":ze("load",n);break;case"video":case"audio":for(i=0;i<$o.length;i++)ze($o[i],n);break;case"source":ze("error",n);break;case"img":case"image":case"link":ze("error",n),ze("load",n);break;case"details":ze("toggle",n);break;case"input":_E(n,a),ze("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!a.multiple},ze("invalid",n);break;case"textarea":wE(n,a),ze("invalid",n)}tv(t,a),i=null;for(var s in a)if(a.hasOwnProperty(s)){var l=a[s];s==="children"?typeof l=="string"?n.textContent!==l&&(a.suppressHydrationWarning!==!0&&Mu(n.textContent,l,r),i=["children",l]):typeof l=="number"&&n.textContent!==""+l&&(a.suppressHydrationWarning!==!0&&Mu(n.textContent,l,r),i=["children",""+l]):dl.hasOwnProperty(s)&&l!=null&&s==="onScroll"&&ze("scroll",n)}switch(t){case"input":wu(n),bE(n,a,!0);break;case"textarea":wu(n),TE(n);break;case"select":case"option":break;default:typeof a.onClick=="function"&&(n.onclick=Ad)}n=i,e.updateQueue=n,n!==null&&(e.flags|=4)}else{s=i.nodeType===9?i:i.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=cw(t)),r==="http://www.w3.org/1999/xhtml"?t==="script"?(r=s.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof n.is=="string"?r=s.createElement(t,{is:n.is}):(r=s.createElement(t),t==="select"&&(s=r,n.multiple?s.multiple=!0:n.size&&(s.size=n.size))):r=s.createElementNS(r,t),r[hn]=e,r[El]=n,NT(r,e,!1,!1),e.stateNode=r;e:{switch(s=rv(t,n),t){case"dialog":ze("cancel",r),ze("close",r),i=n;break;case"iframe":case"object":case"embed":ze("load",r),i=n;break;case"video":case"audio":for(i=0;i<$o.length;i++)ze($o[i],r);i=n;break;case"source":ze("error",r),i=n;break;case"img":case"image":case"link":ze("error",r),ze("load",r),i=n;break;case"details":ze("toggle",r),i=n;break;case"input":_E(r,n),i=Qf(r,n),ze("invalid",r);break;case"option":i=n;break;case"select":r._wrapperState={wasMultiple:!!n.multiple},i=ot({},n,{value:void 0}),ze("invalid",r);break;case"textarea":wE(r,n),i=Zf(r,n),ze("invalid",r);break;default:i=n}tv(t,i),l=i;for(a in l)if(l.hasOwnProperty(a)){var u=l[a];a==="style"?vw(r,u):a==="dangerouslySetInnerHTML"?(u=u?u.__html:void 0,u!=null&&hw(r,u)):a==="children"?typeof u=="string"?(t!=="textarea"||u!=="")&&cl(r,u):typeof u=="number"&&cl(r,""+u):a!=="suppressContentEditableWarning"&&a!=="suppressHydrationWarning"&&a!=="autoFocus"&&(dl.hasOwnProperty(a)?u!=null&&a==="onScroll"&&ze("scroll",r):u!=null&&tg(r,a,u,s))}switch(t){case"input":wu(r),bE(r,n,!1);break;case"textarea":wu(r),TE(r);break;case"option":n.value!=null&&r.setAttribute("value",""+ki(n.value));break;case"select":r.multiple=!!n.multiple,a=n.value,a!=null?Za(r,!!n.multiple,a,!1):n.defaultValue!=null&&Za(r,!!n.multiple,n.defaultValue,!0);break;default:typeof i.onClick=="function"&&(r.onclick=Ad)}switch(t){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return $t(e),null;case 6:if(r&&e.stateNode!=null)UT(r,e,r.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(te(166));if(t=ra(bl.current),ra(gn.current),Au(e)){if(n=e.stateNode,t=e.memoizedProps,n[hn]=e,(a=n.nodeValue!==t)&&(r=br,r!==null))switch(r.tag){case 3:Mu(n.nodeValue,t,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&Mu(n.nodeValue,t,(r.mode&1)!==0)}a&&(e.flags|=4)}else n=(t.nodeType===9?t:t.ownerDocument).createTextNode(n),n[hn]=e,e.stateNode=n}return $t(e),null;case 13:if(Qe(nt),n=e.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(Ze&&_r!==null&&e.mode&1&&!(e.flags&128))tT(),Us(),e.flags|=98560,a=!1;else if(a=Au(e),n!==null&&n.dehydrated!==null){if(r===null){if(!a)throw Error(te(318));if(a=e.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(te(317));a[hn]=e}else Us(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;$t(e),a=!1}else qr!==null&&(Lv(qr),qr=null),a=!0;if(!a)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(n=n!==null,n!==(r!==null&&r.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(r===null||nt.current&1?Ct===0&&(Ct=3):Ug())),e.updateQueue!==null&&(e.flags|=4),$t(e),null);case 4:return Fs(),Ov(r,e),r===null&&yl(e.stateNode.containerInfo),$t(e),null;case 10:return Eg(e.type._context),$t(e),null;case 17:return cr(e.type)&&xd(),$t(e),null;case 19:if(Qe(nt),a=e.memoizedState,a===null)return $t(e),null;if(n=(e.flags&128)!==0,s=a.rendering,s===null)if(n)To(a,!1);else{if(Ct!==0||r!==null&&r.flags&128)for(r=e.child;r!==null;){if(s=Bd(r),s!==null){for(e.flags|=128,To(a,!1),n=s.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=t,t=e.child;t!==null;)a=t,r=n,a.flags&=14680066,s=a.alternate,s===null?(a.childLanes=0,a.lanes=r,a.child=null,a.subtreeFlags=0,a.memoizedProps=null,a.memoizedState=null,a.updateQueue=null,a.dependencies=null,a.stateNode=null):(a.childLanes=s.childLanes,a.lanes=s.lanes,a.child=s.child,a.subtreeFlags=0,a.deletions=null,a.memoizedProps=s.memoizedProps,a.memoizedState=s.memoizedState,a.updateQueue=s.updateQueue,a.type=s.type,r=s.dependencies,a.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),t=t.sibling;return He(nt,nt.current&1|2),e.child}r=r.sibling}a.tail!==null&&ht()>$s&&(e.flags|=128,n=!0,To(a,!1),e.lanes=4194304)}else{if(!n)if(r=Bd(s),r!==null){if(e.flags|=128,n=!0,t=r.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),To(a,!0),a.tail===null&&a.tailMode==="hidden"&&!s.alternate&&!Ze)return $t(e),null}else 2*ht()-a.renderingStartTime>$s&&t!==1073741824&&(e.flags|=128,n=!0,To(a,!1),e.lanes=4194304);a.isBackwards?(s.sibling=e.child,e.child=s):(t=a.last,t!==null?t.sibling=s:e.child=s,a.last=s)}return a.tail!==null?(e=a.tail,a.rendering=e,a.tail=e.sibling,a.renderingStartTime=ht(),e.sibling=null,t=nt.current,He(nt,n?t&1|2:t&1),e):($t(e),null);case 22:case 23:return Lg(),n=e.memoizedState!==null,r!==null&&r.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?Sr&1073741824&&($t(e),e.subtreeFlags&6&&(e.flags|=8192)):$t(e),null;case 24:return null;case 25:return null}throw Error(te(156,e.tag))}o(Sk,"Ej");function Ek(r,e){switch(mg(e),e.tag){case 1:return cr(e.type)&&xd(),r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 3:return Fs(),Qe(dr),Qe(Gt),Rg(),r=e.flags,r&65536&&!(r&128)?(e.flags=r&-65537|128,e):null;case 5:return Tg(e),null;case 13:if(Qe(nt),r=e.memoizedState,r!==null&&r.dehydrated!==null){if(e.alternate===null)throw Error(te(340));Us()}return r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 19:return Qe(nt),null;case 4:return Fs(),null;case 10:return Eg(e.type._context),null;case 22:case 23:return Lg(),null;case 24:return null;default:return null}}o(Ek,"Ij");var Nu=!1,Kt=!1,_k=typeof WeakSet=="function"?WeakSet:Set,ve=null;function za(r,e){var t=r.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(n){ut(r,e,n)}else t.current=null}o(za,"Lj");function kv(r,e,t){try{t()}catch(n){ut(r,e,n)}}o(kv,"Mj");var f_=!1;function bk(r,e){if(hv=kd,r=Ww(),vg(r)){if("selectionStart"in r)var t={start:r.selectionStart,end:r.selectionEnd};else e:{t=(t=r.ownerDocument)&&t.defaultView||window;var n=t.getSelection&&t.getSelection();if(n&&n.rangeCount!==0){t=n.anchorNode;var i=n.anchorOffset,a=n.focusNode;n=n.focusOffset;try{t.nodeType,a.nodeType}catch{t=null;break e}var s=0,l=-1,u=-1,d=0,c=0,h=r,v=null;t:for(;;){for(var g;h!==t||i!==0&&h.nodeType!==3||(l=s+i),h!==a||n!==0&&h.nodeType!==3||(u=s+n),h.nodeType===3&&(s+=h.nodeValue.length),(g=h.firstChild)!==null;)v=h,h=g;for(;;){if(h===r)break t;if(v===t&&++d===i&&(l=s),v===a&&++c===n&&(u=s),(g=h.nextSibling)!==null)break;h=v,v=h.parentNode}h=g}t=l===-1||u===-1?null:{start:l,end:u}}else t=null}t=t||{start:0,end:0}}else t=null;for(fv={focusedElem:r,selectionRange:t},kd=!1,ve=e;ve!==null;)if(e=ve,r=e.child,(e.subtreeFlags&1028)!==0&&r!==null)r.return=e,ve=r;else for(;ve!==null;){e=ve;try{var p=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(p!==null){var m=p.memoizedProps,T=p.memoizedState,y=e.stateNode,S=y.getSnapshotBeforeUpdate(e.elementType===e.type?m:$r(e.type,m),T);y.__reactInternalSnapshotBeforeUpdate=S}break;case 3:var w=e.stateNode.containerInfo;w.nodeType===1?w.textContent="":w.nodeType===9&&w.documentElement&&w.removeChild(w.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(te(163))}}catch(C){ut(e,e.return,C)}if(r=e.sibling,r!==null){r.return=e.return,ve=r;break}ve=e.return}return p=f_,f_=!1,p}o(bk,"Oj");function Yo(r,e,t){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var i=n=n.next;do{if((i.tag&r)===r){var a=i.destroy;i.destroy=void 0,a!==void 0&&kv(e,t,a)}i=i.next}while(i!==n)}}o(Yo,"Pj");function ch(r,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&r)===r){var n=t.create;t.destroy=n()}t=t.next}while(t!==e)}}o(ch,"Qj");function Pv(r){var e=r.ref;if(e!==null){var t=r.stateNode;switch(r.tag){case 5:r=t;break;default:r=t}typeof e=="function"?e(r):e.current=r}}o(Pv,"Rj");function jT(r){var e=r.alternate;e!==null&&(r.alternate=null,jT(e)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(e=r.stateNode,e!==null&&(delete e[hn],delete e[El],delete e[mv],delete e[ik],delete e[ak])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}o(jT,"Sj");function FT(r){return r.tag===5||r.tag===3||r.tag===4}o(FT,"Tj");function v_(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||FT(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}o(v_,"Uj");function Mv(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(r,e):t.insertBefore(r,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(r,t)):(e=t,e.appendChild(r)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=Ad));else if(n!==4&&(r=r.child,r!==null))for(Mv(r,e,t),r=r.sibling;r!==null;)Mv(r,e,t),r=r.sibling}o(Mv,"Vj");function Av(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.insertBefore(r,e):t.appendChild(r);else if(n!==4&&(r=r.child,r!==null))for(Av(r,e,t),r=r.sibling;r!==null;)Av(r,e,t),r=r.sibling}o(Av,"Wj");var Lt=null,Kr=!1;function Yn(r,e,t){for(t=t.child;t!==null;)BT(r,e,t),t=t.sibling}o(Yn,"Yj");function BT(r,e,t){if(mn&&typeof mn.onCommitFiberUnmount=="function")try{mn.onCommitFiberUnmount(nh,t)}catch{}switch(t.tag){case 5:Kt||za(t,e);case 6:var n=Lt,i=Kr;Lt=null,Yn(r,e,t),Lt=n,Kr=i,Lt!==null&&(Kr?(r=Lt,t=t.stateNode,r.nodeType===8?r.parentNode.removeChild(t):r.removeChild(t)):Lt.removeChild(t.stateNode));break;case 18:Lt!==null&&(Kr?(r=Lt,t=t.stateNode,r.nodeType===8?nf(r.parentNode,t):r.nodeType===1&&nf(r,t),pl(r)):nf(Lt,t.stateNode));break;case 4:n=Lt,i=Kr,Lt=t.stateNode.containerInfo,Kr=!0,Yn(r,e,t),Lt=n,Kr=i;break;case 0:case 11:case 14:case 15:if(!Kt&&(n=t.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){i=n=n.next;do{var a=i,s=a.destroy;a=a.tag,s!==void 0&&(a&2||a&4)&&kv(t,e,s),i=i.next}while(i!==n)}Yn(r,e,t);break;case 1:if(!Kt&&(za(t,e),n=t.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=t.memoizedProps,n.state=t.memoizedState,n.componentWillUnmount()}catch(l){ut(t,e,l)}Yn(r,e,t);break;case 21:Yn(r,e,t);break;case 22:t.mode&1?(Kt=(n=Kt)||t.memoizedState!==null,Yn(r,e,t),Kt=n):Yn(r,e,t);break;default:Yn(r,e,t)}}o(BT,"Zj");function p_(r){var e=r.updateQueue;if(e!==null){r.updateQueue=null;var t=r.stateNode;t===null&&(t=r.stateNode=new _k),e.forEach(function(n){var i=Mk.bind(null,r,n);t.has(n)||(t.add(n),n.then(i,i))})}}o(p_,"ak");function Fr(r,e){var t=e.deletions;if(t!==null)for(var n=0;n<t.length;n++){var i=t[n];try{var a=r,s=e,l=s;e:for(;l!==null;){switch(l.tag){case 5:Lt=l.stateNode,Kr=!1;break e;case 3:Lt=l.stateNode.containerInfo,Kr=!0;break e;case 4:Lt=l.stateNode.containerInfo,Kr=!0;break e}l=l.return}if(Lt===null)throw Error(te(160));BT(a,s,i),Lt=null,Kr=!1;var u=i.alternate;u!==null&&(u.return=null),i.return=null}catch(d){ut(i,e,d)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)$T(e,r),e=e.sibling}o(Fr,"ck");function $T(r,e){var t=r.alternate,n=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if(Fr(e,r),en(r),n&4){try{Yo(3,r,r.return),ch(3,r)}catch(m){ut(r,r.return,m)}try{Yo(5,r,r.return)}catch(m){ut(r,r.return,m)}}break;case 1:Fr(e,r),en(r),n&512&&t!==null&&za(t,t.return);break;case 5:if(Fr(e,r),en(r),n&512&&t!==null&&za(t,t.return),r.flags&32){var i=r.stateNode;try{cl(i,"")}catch(m){ut(r,r.return,m)}}if(n&4&&(i=r.stateNode,i!=null)){var a=r.memoizedProps,s=t!==null?t.memoizedProps:a,l=r.type,u=r.updateQueue;if(r.updateQueue=null,u!==null)try{l==="input"&&a.type==="radio"&&a.name!=null&&uw(i,a),rv(l,s);var d=rv(l,a);for(s=0;s<u.length;s+=2){var c=u[s],h=u[s+1];c==="style"?vw(i,h):c==="dangerouslySetInnerHTML"?hw(i,h):c==="children"?cl(i,h):tg(i,c,h,d)}switch(l){case"input":Yf(i,a);break;case"textarea":dw(i,a);break;case"select":var v=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!a.multiple;var g=a.value;g!=null?Za(i,!!a.multiple,g,!1):v!==!!a.multiple&&(a.defaultValue!=null?Za(i,!!a.multiple,a.defaultValue,!0):Za(i,!!a.multiple,a.multiple?[]:"",!1))}i[El]=a}catch(m){ut(r,r.return,m)}}break;case 6:if(Fr(e,r),en(r),n&4){if(r.stateNode===null)throw Error(te(162));i=r.stateNode,a=r.memoizedProps;try{i.nodeValue=a}catch(m){ut(r,r.return,m)}}break;case 3:if(Fr(e,r),en(r),n&4&&t!==null&&t.memoizedState.isDehydrated)try{pl(e.containerInfo)}catch(m){ut(r,r.return,m)}break;case 4:Fr(e,r),en(r);break;case 13:Fr(e,r),en(r),i=r.child,i.flags&8192&&(a=i.memoizedState!==null,i.stateNode.isHidden=a,!a||i.alternate!==null&&i.alternate.memoizedState!==null||(Dg=ht())),n&4&&p_(r);break;case 22:if(c=t!==null&&t.memoizedState!==null,r.mode&1?(Kt=(d=Kt)||c,Fr(e,r),Kt=d):Fr(e,r),en(r),n&8192){if(d=r.memoizedState!==null,(r.stateNode.isHidden=d)&&!c&&r.mode&1)for(ve=r,c=r.child;c!==null;){for(h=ve=c;ve!==null;){switch(v=ve,g=v.child,v.tag){case 0:case 11:case 14:case 15:Yo(4,v,v.return);break;case 1:za(v,v.return);var p=v.stateNode;if(typeof p.componentWillUnmount=="function"){n=v,t=v.return;try{e=n,p.props=e.memoizedProps,p.state=e.memoizedState,p.componentWillUnmount()}catch(m){ut(n,t,m)}}break;case 5:za(v,v.return);break;case 22:if(v.memoizedState!==null){g_(h);continue}}g!==null?(g.return=v,ve=g):g_(h)}c=c.sibling}e:for(c=null,h=r;;){if(h.tag===5){if(c===null){c=h;try{i=h.stateNode,d?(a=i.style,typeof a.setProperty=="function"?a.setProperty("display","none","important"):a.display="none"):(l=h.stateNode,u=h.memoizedProps.style,s=u!=null&&u.hasOwnProperty("display")?u.display:null,l.style.display=fw("display",s))}catch(m){ut(r,r.return,m)}}}else if(h.tag===6){if(c===null)try{h.stateNode.nodeValue=d?"":h.memoizedProps}catch(m){ut(r,r.return,m)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===r)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===r)break e;for(;h.sibling===null;){if(h.return===null||h.return===r)break e;c===h&&(c=null),h=h.return}c===h&&(c=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:Fr(e,r),en(r),n&4&&p_(r);break;case 21:break;default:Fr(e,r),en(r)}}o($T,"dk");function en(r){var e=r.flags;if(e&2){try{e:{for(var t=r.return;t!==null;){if(FT(t)){var n=t;break e}t=t.return}throw Error(te(160))}switch(n.tag){case 5:var i=n.stateNode;n.flags&32&&(cl(i,""),n.flags&=-33);var a=v_(r);Av(r,a,i);break;case 3:case 4:var s=n.stateNode.containerInfo,l=v_(r);Mv(r,l,s);break;default:throw Error(te(161))}}catch(u){ut(r,r.return,u)}r.flags&=-3}e&4096&&(r.flags&=-4097)}o(en,"ek");function wk(r,e,t){ve=r,WT(r)}o(wk,"hk");function WT(r,e,t){for(var n=(r.mode&1)!==0;ve!==null;){var i=ve,a=i.child;if(i.tag===22&&n){var s=i.memoizedState!==null||Nu;if(!s){var l=i.alternate,u=l!==null&&l.memoizedState!==null||Kt;l=Nu;var d=Kt;if(Nu=s,(Kt=u)&&!d)for(ve=i;ve!==null;)s=ve,u=s.child,s.tag===22&&s.memoizedState!==null?y_(i):u!==null?(u.return=s,ve=u):y_(i);for(;a!==null;)ve=a,WT(a),a=a.sibling;ve=i,Nu=l,Kt=d}m_(r)}else i.subtreeFlags&8772&&a!==null?(a.return=i,ve=a):m_(r)}}o(WT,"ik");function m_(r){for(;ve!==null;){var e=ve;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Kt||ch(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!Kt)if(t===null)n.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:$r(e.type,t.memoizedProps);n.componentDidUpdate(i,t.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=e.updateQueue;a!==null&&e_(e,a,n);break;case 3:var s=e.updateQueue;if(s!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}e_(e,s,t)}break;case 5:var l=e.stateNode;if(t===null&&e.flags&4){t=l;var u=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":u.autoFocus&&t.focus();break;case"img":u.src&&(t.src=u.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var d=e.alternate;if(d!==null){var c=d.memoizedState;if(c!==null){var h=c.dehydrated;h!==null&&pl(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(te(163))}Kt||e.flags&512&&Pv(e)}catch(v){ut(e,e.return,v)}}if(e===r){ve=null;break}if(t=e.sibling,t!==null){t.return=e.return,ve=t;break}ve=e.return}}o(m_,"kk");function g_(r){for(;ve!==null;){var e=ve;if(e===r){ve=null;break}var t=e.sibling;if(t!==null){t.return=e.return,ve=t;break}ve=e.return}}o(g_,"gk");function y_(r){for(;ve!==null;){var e=ve;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{ch(4,e)}catch(u){ut(e,t,u)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var i=e.return;try{n.componentDidMount()}catch(u){ut(e,i,u)}}var a=e.return;try{Pv(e)}catch(u){ut(e,a,u)}break;case 5:var s=e.return;try{Pv(e)}catch(u){ut(e,s,u)}}}catch(u){ut(e,e.return,u)}if(e===r){ve=null;break}var l=e.sibling;if(l!==null){l.return=e.return,ve=l;break}ve=e.return}}o(y_,"jk");var Tk=Math.ceil,Kd=Gn.ReactCurrentDispatcher,Ag=Gn.ReactCurrentOwner,xr=Gn.ReactCurrentBatchConfig,xe=0,Dt=null,St=null,jt=0,Sr=0,Ja=Ni(0),Ct=0,Il=null,pa=0,hh=0,xg=0,Xo=null,or=null,Dg=0,$s=1/0,Cn=null,Vd=!1,xv=null,_i=null,Lu=!1,fi=null,qd=0,Zo=0,Dv=null,od=-1,ld=0;function er(){return xe&6?ht():od!==-1?od:od=ht()}o(er,"R$1");function bi(r){return r.mode&1?xe&2&&jt!==0?jt&-jt:ok.transition!==null?(ld===0&&(ld=Iw()),ld):(r=Be,r!==0||(r=window.event,r=r===void 0?16:xw(r.type)),r):1}o(bi,"yi");function zr(r,e,t,n){if(50<Zo)throw Zo=0,Dv=null,Error(te(185));eu(r,t,n),(!(xe&2)||r!==Dt)&&(r===Dt&&(!(xe&2)&&(hh|=t),Ct===4&&ci(r,jt)),hr(r,n),t===1&&xe===0&&!(e.mode&1)&&($s=ht()+500,lh&&Li()))}o(zr,"gi");function hr(r,e){var t=r.callbackNode;oO(r,e);var n=Od(r,r===Dt?jt:0);if(n===0)t!==null&&CE(t),r.callbackNode=null,r.callbackPriority=0;else if(e=n&-n,r.callbackPriority!==e){if(t!=null&&CE(t),e===1)r.tag===0?sk(S_.bind(null,r)):Xw(S_.bind(null,r)),rk(function(){!(xe&6)&&Li()}),t=null;else{switch(Cw(n)){case 1:t=sg;break;case 4:t=Tw;break;case 16:t=Cd;break;case 536870912:t=Rw;break;default:t=Cd}t=QT(t,KT.bind(null,r))}r.callbackPriority=e,r.callbackNode=t}}o(hr,"Dk");function KT(r,e){if(od=-1,ld=0,xe&6)throw Error(te(327));var t=r.callbackNode;if(is()&&r.callbackNode!==t)return null;var n=Od(r,r===Dt?jt:0);if(n===0)return null;if(n&30||n&r.expiredLanes||e)e=Gd(r,n);else{e=n;var i=xe;xe|=2;var a=qT();(Dt!==r||jt!==e)&&(Cn=null,$s=ht()+500,sa(r,e));do try{Ck();break}catch(l){VT(r,l)}while(!0);Sg(),Kd.current=a,xe=i,St!==null?e=0:(Dt=null,jt=0,e=Ct)}if(e!==0){if(e===2&&(i=ov(r),i!==0&&(n=i,e=Nv(r,i))),e===1)throw t=Il,sa(r,0),ci(r,n),hr(r,ht()),t;if(e===6)ci(r,n);else{if(i=r.current.alternate,!(n&30)&&!Rk(i)&&(e=Gd(r,n),e===2&&(a=ov(r),a!==0&&(n=a,e=Nv(r,a))),e===1))throw t=Il,sa(r,0),ci(r,n),hr(r,ht()),t;switch(r.finishedWork=i,r.finishedLanes=n,e){case 0:case 1:throw Error(te(345));case 2:Hi(r,or,Cn);break;case 3:if(ci(r,n),(n&130023424)===n&&(e=Dg+500-ht(),10<e)){if(Od(r,0)!==0)break;if(i=r.suspendedLanes,(i&n)!==n){er(),r.pingedLanes|=r.suspendedLanes&i;break}r.timeoutHandle=pv(Hi.bind(null,r,or,Cn),e);break}Hi(r,or,Cn);break;case 4:if(ci(r,n),(n&4194240)===n)break;for(e=r.eventTimes,i=-1;0<n;){var s=31-Hr(n);a=1<<s,s=e[s],s>i&&(i=s),n&=~a}if(n=i,n=ht()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*Tk(n/1960))-n,10<n){r.timeoutHandle=pv(Hi.bind(null,r,or,Cn),n);break}Hi(r,or,Cn);break;case 5:Hi(r,or,Cn);break;default:throw Error(te(329))}}}return hr(r,ht()),r.callbackNode===t?KT.bind(null,r):null}o(KT,"Gk");function Nv(r,e){var t=Xo;return r.current.memoizedState.isDehydrated&&(sa(r,e).flags|=256),r=Gd(r,e),r!==2&&(e=or,or=t,e!==null&&Lv(e)),r}o(Nv,"Nk");function Lv(r){or===null?or=r:or.push.apply(or,r)}o(Lv,"Fj");function Rk(r){for(var e=r;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var n=0;n<t.length;n++){var i=t[n],a=i.getSnapshot;i=i.value;try{if(!Xr(a(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}o(Rk,"Ok");function ci(r,e){for(e&=~xg,e&=~hh,r.suspendedLanes|=e,r.pingedLanes&=~e,r=r.expirationTimes;0<e;){var t=31-Hr(e),n=1<<t;r[t]=-1,e&=~n}}o(ci,"Ck");function S_(r){if(xe&6)throw Error(te(327));is();var e=Od(r,0);if(!(e&1))return hr(r,ht()),null;var t=Gd(r,e);if(r.tag!==0&&t===2){var n=ov(r);n!==0&&(e=n,t=Nv(r,n))}if(t===1)throw t=Il,sa(r,0),ci(r,e),hr(r,ht()),t;if(t===6)throw Error(te(345));return r.finishedWork=r.current.alternate,r.finishedLanes=e,Hi(r,or,Cn),hr(r,ht()),null}o(S_,"Ek");function Ng(r,e){var t=xe;xe|=1;try{return r(e)}finally{xe=t,xe===0&&($s=ht()+500,lh&&Li())}}o(Ng,"Qk");function ma(r){fi!==null&&fi.tag===0&&!(xe&6)&&is();var e=xe;xe|=1;var t=xr.transition,n=Be;try{if(xr.transition=null,Be=1,r)return r()}finally{Be=n,xr.transition=t,xe=e,!(xe&6)&&Li()}}o(ma,"Rk");function Lg(){Sr=Ja.current,Qe(Ja)}o(Lg,"Hj");function sa(r,e){r.finishedWork=null,r.finishedLanes=0;var t=r.timeoutHandle;if(t!==-1&&(r.timeoutHandle=-1,tk(t)),St!==null)for(t=St.return;t!==null;){var n=t;switch(mg(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&xd();break;case 3:Fs(),Qe(dr),Qe(Gt),Rg();break;case 5:Tg(n);break;case 4:Fs();break;case 13:Qe(nt);break;case 19:Qe(nt);break;case 10:Eg(n.type._context);break;case 22:case 23:Lg()}t=t.return}if(Dt=r,St=r=wi(r.current,null),jt=Sr=e,Ct=0,Il=null,xg=hh=pa=0,or=Xo=null,ta!==null){for(e=0;e<ta.length;e++)if(t=ta[e],n=t.interleaved,n!==null){t.interleaved=null;var i=n.next,a=t.pending;if(a!==null){var s=a.next;a.next=i,n.next=s}t.pending=n}ta=null}return r}o(sa,"Kk");function VT(r,e){do{var t=St;try{if(Sg(),id.current=Wd,$d){for(var n=at.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}$d=!1}if(va=0,At=Rt=at=null,Qo=!1,wl=0,Ag.current=null,t===null||t.return===null){Ct=1,Il=e,St=null;break}e:{var a=r,s=t.return,l=t,u=e;if(e=jt,l.flags|=32768,u!==null&&typeof u=="object"&&typeof u.then=="function"){var d=u,c=l,h=c.tag;if(!(c.mode&1)&&(h===0||h===11||h===15)){var v=c.alternate;v?(c.updateQueue=v.updateQueue,c.memoizedState=v.memoizedState,c.lanes=v.lanes):(c.updateQueue=null,c.memoizedState=null)}var g=s_(s);if(g!==null){g.flags&=-257,o_(g,s,l,a,e),g.mode&1&&a_(a,d,e),e=g,u=d;var p=e.updateQueue;if(p===null){var m=new Set;m.add(u),e.updateQueue=m}else p.add(u);break e}else{if(!(e&1)){a_(a,d,e),Ug();break e}u=Error(te(426))}}else if(Ze&&l.mode&1){var T=s_(s);if(T!==null){!(T.flags&65536)&&(T.flags|=256),o_(T,s,l,a,e),gg(Bs(u,l));break e}}a=u=Bs(u,l),Ct!==4&&(Ct=2),Xo===null?Xo=[a]:Xo.push(a),a=s;do{switch(a.tag){case 3:a.flags|=65536,e&=-e,a.lanes|=e;var y=CT(a,u,e);ZE(a,y);break e;case 1:l=u;var S=a.type,w=a.stateNode;if(!(a.flags&128)&&(typeof S.getDerivedStateFromError=="function"||w!==null&&typeof w.componentDidCatch=="function"&&(_i===null||!_i.has(w)))){a.flags|=65536,e&=-e,a.lanes|=e;var C=OT(a,l,e);ZE(a,C);break e}}a=a.return}while(a!==null)}HT(t)}catch(M){e=M,St===t&&t!==null&&(St=t=t.return);continue}break}while(!0)}o(VT,"Mk");function qT(){var r=Kd.current;return Kd.current=Wd,r===null?Wd:r}o(qT,"Jk");function Ug(){(Ct===0||Ct===3||Ct===2)&&(Ct=4),Dt===null||!(pa&268435455)&&!(hh&268435455)||ci(Dt,jt)}o(Ug,"tj");function Gd(r,e){var t=xe;xe|=2;var n=qT();(Dt!==r||jt!==e)&&(Cn=null,sa(r,e));do try{Ik();break}catch(i){VT(r,i)}while(!0);if(Sg(),xe=t,Kd.current=n,St!==null)throw Error(te(261));return Dt=null,jt=0,Ct}o(Gd,"Ik");function Ik(){for(;St!==null;)GT(St)}o(Ik,"Tk");function Ck(){for(;St!==null&&!XC();)GT(St)}o(Ck,"Lk");function GT(r){var e=JT(r.alternate,r,Sr);r.memoizedProps=r.pendingProps,e===null?HT(r):St=e,Ag.current=null}o(GT,"Uk");function HT(r){var e=r;do{var t=e.alternate;if(r=e.return,e.flags&32768){if(t=Ek(t,e),t!==null){t.flags&=32767,St=t;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{Ct=6,St=null;return}}else if(t=Sk(t,e,Sr),t!==null){St=t;return}if(e=e.sibling,e!==null){St=e;return}St=e=r}while(e!==null);Ct===0&&(Ct=5)}o(HT,"Sk");function Hi(r,e,t){var n=Be,i=xr.transition;try{xr.transition=null,Be=1,Ok(r,e,t,n)}finally{xr.transition=i,Be=n}return null}o(Hi,"Pk");function Ok(r,e,t,n){do is();while(fi!==null);if(xe&6)throw Error(te(327));t=r.finishedWork;var i=r.finishedLanes;if(t===null)return null;if(r.finishedWork=null,r.finishedLanes=0,t===r.current)throw Error(te(177));r.callbackNode=null,r.callbackPriority=0;var a=t.lanes|t.childLanes;if(lO(r,a),r===Dt&&(St=Dt=null,jt=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||Lu||(Lu=!0,QT(Cd,function(){return is(),null})),a=(t.flags&15990)!==0,t.subtreeFlags&15990||a){a=xr.transition,xr.transition=null;var s=Be;Be=1;var l=xe;xe|=4,Ag.current=null,bk(r,t),$T(t,r),zO(fv),kd=!!hv,fv=hv=null,r.current=t,wk(t),ZC(),xe=l,Be=s,xr.transition=a}else r.current=t;if(Lu&&(Lu=!1,fi=r,qd=i),a=r.pendingLanes,a===0&&(_i=null),rO(t.stateNode),hr(r,ht()),e!==null)for(n=r.onRecoverableError,t=0;t<e.length;t++)i=e[t],n(i.value,{componentStack:i.stack,digest:i.digest});if(Vd)throw Vd=!1,r=xv,xv=null,r;return qd&1&&r.tag!==0&&is(),a=r.pendingLanes,a&1?r===Dv?Zo++:(Zo=0,Dv=r):Zo=0,Li(),null}o(Ok,"Wk");function is(){if(fi!==null){var r=Cw(qd),e=xr.transition,t=Be;try{if(xr.transition=null,Be=16>r?16:r,fi===null)var n=!1;else{if(r=fi,fi=null,qd=0,xe&6)throw Error(te(331));var i=xe;for(xe|=4,ve=r.current;ve!==null;){var a=ve,s=a.child;if(ve.flags&16){var l=a.deletions;if(l!==null){for(var u=0;u<l.length;u++){var d=l[u];for(ve=d;ve!==null;){var c=ve;switch(c.tag){case 0:case 11:case 15:Yo(8,c,a)}var h=c.child;if(h!==null)h.return=c,ve=h;else for(;ve!==null;){c=ve;var v=c.sibling,g=c.return;if(jT(c),c===d){ve=null;break}if(v!==null){v.return=g,ve=v;break}ve=g}}}var p=a.alternate;if(p!==null){var m=p.child;if(m!==null){p.child=null;do{var T=m.sibling;m.sibling=null,m=T}while(m!==null)}}ve=a}}if(a.subtreeFlags&2064&&s!==null)s.return=a,ve=s;else e:for(;ve!==null;){if(a=ve,a.flags&2048)switch(a.tag){case 0:case 11:case 15:Yo(9,a,a.return)}var y=a.sibling;if(y!==null){y.return=a.return,ve=y;break e}ve=a.return}}var S=r.current;for(ve=S;ve!==null;){s=ve;var w=s.child;if(s.subtreeFlags&2064&&w!==null)w.return=s,ve=w;else e:for(s=S;ve!==null;){if(l=ve,l.flags&2048)try{switch(l.tag){case 0:case 11:case 15:ch(9,l)}}catch(M){ut(l,l.return,M)}if(l===s){ve=null;break e}var C=l.sibling;if(C!==null){C.return=l.return,ve=C;break e}ve=l.return}}if(xe=i,Li(),mn&&typeof mn.onPostCommitFiberRoot=="function")try{mn.onPostCommitFiberRoot(nh,r)}catch{}n=!0}return n}finally{Be=t,xr.transition=e}}return!1}o(is,"Hk");function E_(r,e,t){e=Bs(t,e),e=CT(r,e,1),r=Ei(r,e,1),e=er(),r!==null&&(eu(r,1,e),hr(r,e))}o(E_,"Xk");function ut(r,e,t){if(r.tag===3)E_(r,r,t);else for(;e!==null;){if(e.tag===3){E_(e,r,t);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(_i===null||!_i.has(n))){r=Bs(t,r),r=OT(e,r,1),e=Ei(e,r,1),r=er(),e!==null&&(eu(e,1,r),hr(e,r));break}}e=e.return}}o(ut,"W");function kk(r,e,t){var n=r.pingCache;n!==null&&n.delete(e),e=er(),r.pingedLanes|=r.suspendedLanes&t,Dt===r&&(jt&t)===t&&(Ct===4||Ct===3&&(jt&130023424)===jt&&500>ht()-Dg?sa(r,0):xg|=t),hr(r,e)}o(kk,"Ti");function zT(r,e){e===0&&(r.mode&1?(e=Iu,Iu<<=1,!(Iu&130023424)&&(Iu=4194304)):e=1);var t=er();r=Wn(r,e),r!==null&&(eu(r,e,t),hr(r,t))}o(zT,"Yk");function Pk(r){var e=r.memoizedState,t=0;e!==null&&(t=e.retryLane),zT(r,t)}o(Pk,"uj");function Mk(r,e){var t=0;switch(r.tag){case 13:var n=r.stateNode,i=r.memoizedState;i!==null&&(t=i.retryLane);break;case 19:n=r.stateNode;break;default:throw Error(te(314))}n!==null&&n.delete(e),zT(r,t)}o(Mk,"bk");var JT;JT=o(function(r,e,t){if(r!==null)if(r.memoizedProps!==e.pendingProps||dr.current)lr=!0;else{if(!(r.lanes&t)&&!(e.flags&128))return lr=!1,yk(r,e,t);lr=!!(r.flags&131072)}else lr=!1,Ze&&e.flags&1048576&&Zw(e,Ld,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;sd(r,e),r=e.pendingProps;var i=Ls(e,Gt.current);ns(e,t),i=Cg(null,e,n,r,i,t);var a=Og();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,cr(n)?(a=!0,Dd(e)):a=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,bg(e),i.updater=dh,e.stateNode=i,i._reactInternals=e,bv(e,n,r,t),e=Rv(null,e,n,!0,a,t)):(e.tag=0,Ze&&a&&pg(e),Yt(null,e,i,t),e=e.child),e;case 16:n=e.elementType;e:{switch(sd(r,e),r=e.pendingProps,i=n._init,n=i(n._payload),e.type=n,i=e.tag=xk(n),r=$r(n,r),i){case 0:e=Tv(null,e,n,r,t);break e;case 1:e=d_(null,e,n,r,t);break e;case 11:e=l_(null,e,n,r,t);break e;case 14:e=u_(null,e,n,$r(n.type,r),t);break e}throw Error(te(306,n,""))}return e;case 0:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:$r(n,i),Tv(r,e,n,i,t);case 1:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:$r(n,i),d_(r,e,n,i,t);case 3:e:{if(AT(e),r===null)throw Error(te(387));n=e.pendingProps,a=e.memoizedState,i=a.element,aT(r,e),Fd(e,n,null,t);var s=e.memoizedState;if(n=s.element,a.isDehydrated)if(a={element:n,isDehydrated:!1,cache:s.cache,pendingSuspenseBoundaries:s.pendingSuspenseBoundaries,transitions:s.transitions},e.updateQueue.baseState=a,e.memoizedState=a,e.flags&256){i=Bs(Error(te(423)),e),e=c_(r,e,n,t,i);break e}else if(n!==i){i=Bs(Error(te(424)),e),e=c_(r,e,n,t,i);break e}else for(_r=Si(e.stateNode.containerInfo.firstChild),br=e,Ze=!0,qr=null,t=nT(e,null,n,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(Us(),n===i){e=Kn(r,e,t);break e}Yt(r,e,n,t)}e=e.child}return e;case 5:return sT(e),r===null&&Sv(e),n=e.type,i=e.pendingProps,a=r!==null?r.memoizedProps:null,s=i.children,vv(n,i)?s=null:a!==null&&vv(n,a)&&(e.flags|=32),MT(r,e),Yt(r,e,s,t),e.child;case 6:return r===null&&Sv(e),null;case 13:return xT(r,e,t);case 4:return wg(e,e.stateNode.containerInfo),n=e.pendingProps,r===null?e.child=js(e,null,n,t):Yt(r,e,n,t),e.child;case 11:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:$r(n,i),l_(r,e,n,i,t);case 7:return Yt(r,e,e.pendingProps,t),e.child;case 8:return Yt(r,e,e.pendingProps.children,t),e.child;case 12:return Yt(r,e,e.pendingProps.children,t),e.child;case 10:e:{if(n=e.type._context,i=e.pendingProps,a=e.memoizedProps,s=i.value,He(Ud,n._currentValue),n._currentValue=s,a!==null)if(Xr(a.value,s)){if(a.children===i.children&&!dr.current){e=Kn(r,e,t);break e}}else for(a=e.child,a!==null&&(a.return=e);a!==null;){var l=a.dependencies;if(l!==null){s=a.child;for(var u=l.firstContext;u!==null;){if(u.context===n){if(a.tag===1){u=jn(-1,t&-t),u.tag=2;var d=a.updateQueue;if(d!==null){d=d.shared;var c=d.pending;c===null?u.next=u:(u.next=c.next,c.next=u),d.pending=u}}a.lanes|=t,u=a.alternate,u!==null&&(u.lanes|=t),Ev(a.return,t,e),l.lanes|=t;break}u=u.next}}else if(a.tag===10)s=a.type===e.type?null:a.child;else if(a.tag===18){if(s=a.return,s===null)throw Error(te(341));s.lanes|=t,l=s.alternate,l!==null&&(l.lanes|=t),Ev(s,t,e),s=a.sibling}else s=a.child;if(s!==null)s.return=a;else for(s=a;s!==null;){if(s===e){s=null;break}if(a=s.sibling,a!==null){a.return=s.return,s=a;break}s=s.return}a=s}Yt(r,e,i.children,t),e=e.child}return e;case 9:return i=e.type,n=e.pendingProps.children,ns(e,t),i=Nr(i),n=n(i),e.flags|=1,Yt(r,e,n,t),e.child;case 14:return n=e.type,i=$r(n,e.pendingProps),i=$r(n.type,i),u_(r,e,n,i,t);case 15:return kT(r,e,e.type,e.pendingProps,t);case 17:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:$r(n,i),sd(r,e),e.tag=1,cr(n)?(r=!0,Dd(e)):r=!1,ns(e,t),IT(e,n,i),bv(e,n,i,t),Rv(null,e,n,!0,r,t);case 19:return DT(r,e,t);case 22:return PT(r,e,t)}throw Error(te(156,e.tag))},"Vk");function QT(r,e){return ww(r,e)}o(QT,"Fk");function Ak(r,e,t,n){this.tag=r,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}o(Ak,"$k");function Ar(r,e,t,n){return new Ak(r,e,t,n)}o(Ar,"Bg");function jg(r){return r=r.prototype,!(!r||!r.isReactComponent)}o(jg,"aj");function xk(r){if(typeof r=="function")return jg(r)?1:0;if(r!=null){if(r=r.$$typeof,r===ng)return 11;if(r===ig)return 14}return 2}o(xk,"Zk");function wi(r,e){var t=r.alternate;return t===null?(t=Ar(r.tag,e,r.key,r.mode),t.elementType=r.elementType,t.type=r.type,t.stateNode=r.stateNode,t.alternate=r,r.alternate=t):(t.pendingProps=e,t.type=r.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=r.flags&14680064,t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,e=r.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=r.sibling,t.index=r.index,t.ref=r.ref,t}o(wi,"Pg");function ud(r,e,t,n,i,a){var s=2;if(n=r,typeof r=="function")jg(r)&&(s=1);else if(typeof r=="string")s=5;else e:switch(r){case Fa:return oa(t.children,i,a,e);case rg:s=8,i|=8;break;case Gf:return r=Ar(12,t,e,i|2),r.elementType=Gf,r.lanes=a,r;case Hf:return r=Ar(13,t,e,i),r.elementType=Hf,r.lanes=a,r;case zf:return r=Ar(19,t,e,i),r.elementType=zf,r.lanes=a,r;case sw:return fh(t,i,a,e);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case iw:s=10;break e;case aw:s=9;break e;case ng:s=11;break e;case ig:s=14;break e;case ai:s=16,n=null;break e}throw Error(te(130,r==null?r:typeof r,""))}return e=Ar(s,t,e,i),e.elementType=r,e.type=n,e.lanes=a,e}o(ud,"Rg");function oa(r,e,t,n){return r=Ar(7,r,n,e),r.lanes=t,r}o(oa,"Tg");function fh(r,e,t,n){return r=Ar(22,r,n,e),r.elementType=sw,r.lanes=t,r.stateNode={isHidden:!1},r}o(fh,"pj");function hf(r,e,t){return r=Ar(6,r,null,e),r.lanes=t,r}o(hf,"Qg");function ff(r,e,t){return e=Ar(4,r.children!==null?r.children:[],r.key,e),e.lanes=t,e.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},e}o(ff,"Sg");function Dk(r,e,t,n,i){this.tag=e,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Gh(0),this.expirationTimes=Gh(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Gh(0),this.identifierPrefix=n,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}o(Dk,"al");function Fg(r,e,t,n,i,a,s,l,u){return r=new Dk(r,e,t,l,u),e===1?(e=1,a===!0&&(e|=8)):e=0,a=Ar(3,null,null,e),r.current=a,a.stateNode=r,a.memoizedState={element:n,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},bg(a),r}o(Fg,"bl");function Nk(r,e,t){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:ja,key:n==null?null:""+n,children:r,containerInfo:e,implementation:t}}o(Nk,"cl");function YT(r){if(!r)return Pi;r=r._reactInternals;e:{if(ba(r)!==r||r.tag!==1)throw Error(te(170));var e=r;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(cr(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(te(171))}if(r.tag===1){var t=r.type;if(cr(t))return Yw(r,t,e)}return e}o(YT,"dl");function XT(r,e,t,n,i,a,s,l,u){return r=Fg(t,n,!0,r,i,a,s,l,u),r.context=YT(null),t=r.current,n=er(),i=bi(t),a=jn(n,i),a.callback=e??null,Ei(t,a,i),r.current.lanes=i,eu(r,i,n),hr(r,n),r}o(XT,"el");function vh(r,e,t,n){var i=e.current,a=er(),s=bi(i);return t=YT(t),e.context===null?e.context=t:e.pendingContext=t,e=jn(a,s),e.payload={element:r},n=n===void 0?null:n,n!==null&&(e.callback=n),r=Ei(i,e,s),r!==null&&(zr(r,i,s,a),nd(r,i,s)),s}o(vh,"fl");function Hd(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}o(Hd,"gl");function __(r,e){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var t=r.retryLane;r.retryLane=t!==0&&t<e?t:e}}o(__,"hl");function Bg(r,e){__(r,e),(r=r.alternate)&&__(r,e)}o(Bg,"il");function Lk(){return null}o(Lk,"jl");var ZT=typeof reportError=="function"?reportError:function(r){console.error(r)};function $g(r){this._internalRoot=r}o($g,"ll");ph.prototype.render=$g.prototype.render=function(r){var e=this._internalRoot;if(e===null)throw Error(te(409));vh(r,e,null,null)};ph.prototype.unmount=$g.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var e=r.containerInfo;ma(function(){vh(null,r,null,null)}),e[$n]=null}};function ph(r){this._internalRoot=r}o(ph,"ml");ph.prototype.unstable_scheduleHydration=function(r){if(r){var e=Pw();r={blockedOn:null,target:r,priority:e};for(var t=0;t<di.length&&e!==0&&e<di[t].priority;t++);di.splice(t,0,r),t===0&&Aw(r)}};function Wg(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}o(Wg,"nl");function mh(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}o(mh,"ol");function b_(){}o(b_,"pl");function Uk(r,e,t,n,i){if(i){if(typeof n=="function"){var a=n;n=o(function(){var d=Hd(s);a.call(d)},"d")}var s=XT(e,n,r,0,null,!1,!1,"",b_);return r._reactRootContainer=s,r[$n]=s.current,yl(r.nodeType===8?r.parentNode:r),ma(),s}for(;i=r.lastChild;)r.removeChild(i);if(typeof n=="function"){var l=n;n=o(function(){var d=Hd(u);l.call(d)},"d")}var u=Fg(r,0,!1,null,null,!1,!1,"",b_);return r._reactRootContainer=u,r[$n]=u.current,yl(r.nodeType===8?r.parentNode:r),ma(function(){vh(e,u,t,n)}),u}o(Uk,"ql");function gh(r,e,t,n,i){var a=t._reactRootContainer;if(a){var s=a;if(typeof i=="function"){var l=i;i=o(function(){var u=Hd(s);l.call(u)},"e")}vh(e,s,r,i)}else s=Uk(t,e,r,i,n);return Hd(s)}o(gh,"rl");Ow=o(function(r){switch(r.tag){case 3:var e=r.stateNode;if(e.current.memoizedState.isDehydrated){var t=Bo(e.pendingLanes);t!==0&&(og(e,t|1),hr(e,ht()),!(xe&6)&&($s=ht()+500,Li()))}break;case 13:ma(function(){var n=Wn(r,1);if(n!==null){var i=er();zr(n,r,1,i)}}),Bg(r,1)}},"Ec");lg=o(function(r){if(r.tag===13){var e=Wn(r,134217728);if(e!==null){var t=er();zr(e,r,134217728,t)}Bg(r,134217728)}},"Fc");kw=o(function(r){if(r.tag===13){var e=bi(r),t=Wn(r,e);if(t!==null){var n=er();zr(t,r,e,n)}Bg(r,e)}},"Gc");Pw=o(function(){return Be},"Hc");Mw=o(function(r,e){var t=Be;try{return Be=r,e()}finally{Be=t}},"Ic");iv=o(function(r,e,t){switch(e){case"input":if(Yf(r,t),e=t.name,t.type==="radio"&&e!=null){for(t=r;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var n=t[e];if(n!==r&&n.form===r.form){var i=oh(n);if(!i)throw Error(te(90));lw(n),Yf(n,i)}}}break;case"textarea":dw(r,t);break;case"select":e=t.value,e!=null&&Za(r,!!t.multiple,e,!1)}},"yb");gw=Ng;yw=ma;var jk={usingClientEntryPoint:!1,Events:[ru,Ka,oh,pw,mw,Ng]},Ro={findFiberByHostInstance:ea,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},Fk={bundleType:Ro.bundleType,version:Ro.version,rendererPackageName:Ro.rendererPackageName,rendererConfig:Ro.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Gn.ReactCurrentDispatcher,findHostInstanceByFiber:o(function(r){return r=_w(r),r===null?null:r.stateNode},"findHostInstanceByFiber"),findFiberByHostInstance:Ro.findFiberByHostInstance||Lk,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Uu=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Uu.isDisabled&&Uu.supportsFiber)try{nh=Uu.inject(Fk),mn=Uu}catch{}}Tr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=jk;Tr.createPortal=function(r,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Wg(e))throw Error(te(200));return Nk(r,e,null,t)};Tr.createRoot=function(r,e){if(!Wg(r))throw Error(te(299));var t=!1,n="",i=ZT;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=Fg(r,1,!1,null,null,t,!1,n,i),r[$n]=e.current,yl(r.nodeType===8?r.parentNode:r),new $g(e)};Tr.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var e=r._reactInternals;if(e===void 0)throw typeof r.render=="function"?Error(te(188)):(r=Object.keys(r).join(","),Error(te(268,r)));return r=_w(e),r=r===null?null:r.stateNode,r};Tr.flushSync=function(r){return ma(r)};Tr.hydrate=function(r,e,t){if(!mh(e))throw Error(te(200));return gh(null,r,e,!0,t)};Tr.hydrateRoot=function(r,e,t){if(!Wg(r))throw Error(te(405));var n=t!=null&&t.hydratedSources||null,i=!1,a="",s=ZT;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(a=t.identifierPrefix),t.onRecoverableError!==void 0&&(s=t.onRecoverableError)),e=XT(e,null,r,1,t??null,i,!1,a,s),r[$n]=e.current,yl(r),n)for(r=0;r<n.length;r++)t=n[r],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new ph(e)};Tr.render=function(r,e,t){if(!mh(e))throw Error(te(200));return gh(null,r,e,!1,t)};Tr.unmountComponentAtNode=function(r){if(!mh(r))throw Error(te(40));return r._reactRootContainer?(ma(function(){gh(null,null,r,!1,function(){r._reactRootContainer=null,r[$n]=null})}),!0):!1};Tr.unstable_batchedUpdates=Ng;Tr.unstable_renderSubtreeIntoContainer=function(r,e,t,n){if(!mh(t))throw Error(te(200));if(r==null||r._reactInternals===void 0)throw Error(te(38));return gh(r,e,t,!1,n)};Tr.version="18.3.1-next-f1338f8080-20240426";function eR(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(eR)}catch(r){console.error(r)}}o(eR,"checkDCE");eR(),ew.exports=Tr;var Bk=ew.exports,tR,w_=Bk;tR=w_.createRoot,w_.hydrateRoot;/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Cl(){return Cl=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Cl.apply(this,arguments)}o(Cl,"_extends$2");var vi;(function(r){r.Pop="POP",r.Push="PUSH",r.Replace="REPLACE"})(vi||(vi={}));const T_="popstate";function $k(r){r===void 0&&(r={});function e(i,a){let{pathname:s="/",search:l="",hash:u=""}=wa(i.location.hash.substr(1));return!s.startsWith("/")&&!s.startsWith(".")&&(s="/"+s),Uv("",{pathname:s,search:l,hash:u},a.state&&a.state.usr||null,a.state&&a.state.key||"default")}o(e,"createHashLocation");function t(i,a){let s=i.document.querySelector("base"),l="";if(s&&s.getAttribute("href")){let u=i.location.href,d=u.indexOf("#");l=d===-1?u:u.slice(0,d)}return l+"#"+(typeof a=="string"?a:zd(a))}o(t,"createHashHref");function n(i,a){Kg(i.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(a)+")")}return o(n,"validateHashLocation"),Kk(e,t,n,r)}o($k,"createHashHistory");function st(r,e){if(r===!1||r===null||typeof r>"u")throw new Error(e)}o(st,"invariant");function Kg(r,e){if(!r){typeof console<"u"&&console.warn(e);try{throw new Error(e)}catch{}}}o(Kg,"warning");function Wk(){return Math.random().toString(36).substr(2,8)}o(Wk,"createKey");function R_(r,e){return{usr:r.state,key:r.key,idx:e}}o(R_,"getHistoryState");function Uv(r,e,t,n){return t===void 0&&(t=null),Cl({pathname:typeof r=="string"?r:r.pathname,search:"",hash:""},typeof e=="string"?wa(e):e,{state:t,key:e&&e.key||n||Wk()})}o(Uv,"createLocation");function zd(r){let{pathname:e="/",search:t="",hash:n=""}=r;return t&&t!=="?"&&(e+=t.charAt(0)==="?"?t:"?"+t),n&&n!=="#"&&(e+=n.charAt(0)==="#"?n:"#"+n),e}o(zd,"createPath");function wa(r){let e={};if(r){let t=r.indexOf("#");t>=0&&(e.hash=r.substr(t),r=r.substr(0,t));let n=r.indexOf("?");n>=0&&(e.search=r.substr(n),r=r.substr(0,n)),r&&(e.pathname=r)}return e}o(wa,"parsePath");function Kk(r,e,t,n){n===void 0&&(n={});let{window:i=document.defaultView,v5Compat:a=!1}=n,s=i.history,l=vi.Pop,u=null,d=c();d==null&&(d=0,s.replaceState(Cl({},s.state,{idx:d}),""));function c(){return(s.state||{idx:null}).idx}o(c,"getIndex");function h(){l=vi.Pop;let T=c(),y=T==null?null:T-d;d=T,u&&u({action:l,location:m.location,delta:y})}o(h,"handlePop");function v(T,y){l=vi.Push;let S=Uv(m.location,T,y);t&&t(S,T),d=c()+1;let w=R_(S,d),C=m.createHref(S);try{s.pushState(w,"",C)}catch(M){if(M instanceof DOMException&&M.name==="DataCloneError")throw M;i.location.assign(C)}a&&u&&u({action:l,location:m.location,delta:1})}o(v,"push");function g(T,y){l=vi.Replace;let S=Uv(m.location,T,y);t&&t(S,T),d=c();let w=R_(S,d),C=m.createHref(S);s.replaceState(w,"",C),a&&u&&u({action:l,location:m.location,delta:0})}o(g,"replace");function p(T){let y=i.location.origin!=="null"?i.location.origin:i.location.href,S=typeof T=="string"?T:zd(T);return S=S.replace(/ $/,"%20"),st(y,"No window.location.(origin|href) available to create URL for href: "+S),new URL(S,y)}o(p,"createURL");let m={get action(){return l},get location(){return r(i,s)},listen(T){if(u)throw new Error("A history only accepts one active listener");return i.addEventListener(T_,h),u=T,()=>{i.removeEventListener(T_,h),u=null}},createHref(T){return e(i,T)},createURL:p,encodeLocation(T){let y=p(T);return{pathname:y.pathname,search:y.search,hash:y.hash}},push:v,replace:g,go(T){return s.go(T)}};return m}o(Kk,"getUrlBasedHistory");var I_;(function(r){r.data="data",r.deferred="deferred",r.redirect="redirect",r.error="error"})(I_||(I_={}));function Vk(r,e,t){return t===void 0&&(t="/"),qk(r,e,t)}o(Vk,"matchRoutes");function qk(r,e,t,n){let i=typeof e=="string"?wa(e):e,a=Ws(i.pathname||"/",t);if(a==null)return null;let s=rR(r);Gk(s);let l=null;for(let u=0;l==null&&u<s.length;++u){let d=nP(a);l=tP(s[u],d)}return l}o(qk,"matchRoutesImpl");function rR(r,e,t,n){e===void 0&&(e=[]),t===void 0&&(t=[]),n===void 0&&(n="");let i=o((a,s,l)=>{let u={relativePath:l===void 0?a.path||"":l,caseSensitive:a.caseSensitive===!0,childrenIndex:s,route:a};u.relativePath.startsWith("/")&&(st(u.relativePath.startsWith(n),'Absolute route path "'+u.relativePath+'" nested under path '+('"'+n+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),u.relativePath=u.relativePath.slice(n.length));let d=Ti([n,u.relativePath]),c=t.concat(u);a.children&&a.children.length>0&&(st(a.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+d+'".')),rR(a.children,e,c,d)),!(a.path==null&&!a.index)&&e.push({path:d,score:Zk(d,a.index),routesMeta:c})},"flattenRoute");return r.forEach((a,s)=>{var l;if(a.path===""||!((l=a.path)!=null&&l.includes("?")))i(a,s);else for(let u of nR(a.path))i(a,s,u)}),e}o(rR,"flattenRoutes");function nR(r){let e=r.split("/");if(e.length===0)return[];let[t,...n]=e,i=t.endsWith("?"),a=t.replace(/\?$/,"");if(n.length===0)return i?[a,""]:[a];let s=nR(n.join("/")),l=[];return l.push(...s.map(u=>u===""?a:[a,u].join("/"))),i&&l.push(...s),l.map(u=>r.startsWith("/")&&u===""?"/":u)}o(nR,"explodeOptionalSegments");function Gk(r){r.sort((e,t)=>e.score!==t.score?t.score-e.score:eP(e.routesMeta.map(n=>n.childrenIndex),t.routesMeta.map(n=>n.childrenIndex)))}o(Gk,"rankRouteBranches");const Hk=/^:[\w-]+$/,zk=3,Jk=2,Qk=1,Yk=10,Xk=-2,C_=o(r=>r==="*","isSplat");function Zk(r,e){let t=r.split("/"),n=t.length;return t.some(C_)&&(n+=Xk),e&&(n+=Jk),t.filter(i=>!C_(i)).reduce((i,a)=>i+(Hk.test(a)?zk:a===""?Qk:Yk),n)}o(Zk,"computeScore");function eP(r,e){return r.length===e.length&&r.slice(0,-1).every((n,i)=>n===e[i])?r[r.length-1]-e[e.length-1]:0}o(eP,"compareIndexes");function tP(r,e,t){let{routesMeta:n}=r,i={},a="/",s=[];for(let l=0;l<n.length;++l){let u=n[l],d=l===n.length-1,c=a==="/"?e:e.slice(a.length)||"/",h=jv({path:u.relativePath,caseSensitive:u.caseSensitive,end:d},c),v=u.route;if(!h)return null;Object.assign(i,h.params),s.push({params:i,pathname:Ti([a,h.pathname]),pathnameBase:oP(Ti([a,h.pathnameBase])),route:v}),h.pathnameBase!=="/"&&(a=Ti([a,h.pathnameBase]))}return s}o(tP,"matchRouteBranch");function jv(r,e){typeof r=="string"&&(r={path:r,caseSensitive:!1,end:!0});let[t,n]=rP(r.path,r.caseSensitive,r.end),i=e.match(t);if(!i)return null;let a=i[0],s=a.replace(/(.)\/+$/,"$1"),l=i.slice(1);return{params:n.reduce((d,c,h)=>{let{paramName:v,isOptional:g}=c;if(v==="*"){let m=l[h]||"";s=a.slice(0,a.length-m.length).replace(/(.)\/+$/,"$1")}const p=l[h];return g&&!p?d[v]=void 0:d[v]=(p||"").replace(/%2F/g,"/"),d},{}),pathname:a,pathnameBase:s,pattern:r}}o(jv,"matchPath");function rP(r,e,t){e===void 0&&(e=!1),t===void 0&&(t=!0),Kg(r==="*"||!r.endsWith("*")||r.endsWith("/*"),'Route path "'+r+'" will be treated as if it were '+('"'+r.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+r.replace(/\*$/,"/*")+'".'));let n=[],i="^"+r.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(s,l,u)=>(n.push({paramName:l,isOptional:u!=null}),u?"/?([^\\/]+)?":"/([^\\/]+)"));return r.endsWith("*")?(n.push({paramName:"*"}),i+=r==="*"||r==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):t?i+="\\/*$":r!==""&&r!=="/"&&(i+="(?:(?=\\/|$))"),[new RegExp(i,e?void 0:"i"),n]}o(rP,"compilePath");function nP(r){try{return r.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(e){return Kg(!1,'The URL path "'+r+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+e+").")),r}}o(nP,"decodePath");function Ws(r,e){if(e==="/")return r;if(!r.toLowerCase().startsWith(e.toLowerCase()))return null;let t=e.endsWith("/")?e.length-1:e.length,n=r.charAt(t);return n&&n!=="/"?null:r.slice(t)||"/"}o(Ws,"stripBasename");function iP(r,e){e===void 0&&(e="/");let{pathname:t,search:n="",hash:i=""}=typeof r=="string"?wa(r):r;return{pathname:t?t.startsWith("/")?t:aP(t,e):e,search:lP(n),hash:uP(i)}}o(iP,"resolvePath");function aP(r,e){let t=e.replace(/\/+$/,"").split("/");return r.split("/").forEach(i=>{i===".."?t.length>1&&t.pop():i!=="."&&t.push(i)}),t.length>1?t.join("/"):"/"}o(aP,"resolvePathname");function vf(r,e,t,n){return"Cannot include a '"+r+"' character in a manually specified "+("`to."+e+"` field ["+JSON.stringify(n)+"].  Please separate it out to the ")+("`to."+t+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}o(vf,"getInvalidPathError");function sP(r){return r.filter((e,t)=>t===0||e.route.path&&e.route.path.length>0)}o(sP,"getPathContributingMatches");function Vg(r,e){let t=sP(r);return e?t.map((n,i)=>i===t.length-1?n.pathname:n.pathnameBase):t.map(n=>n.pathnameBase)}o(Vg,"getResolveToMatches");function qg(r,e,t,n){n===void 0&&(n=!1);let i;typeof r=="string"?i=wa(r):(i=Cl({},r),st(!i.pathname||!i.pathname.includes("?"),vf("?","pathname","search",i)),st(!i.pathname||!i.pathname.includes("#"),vf("#","pathname","hash",i)),st(!i.search||!i.search.includes("#"),vf("#","search","hash",i)));let a=r===""||i.pathname==="",s=a?"/":i.pathname,l;if(s==null)l=t;else{let h=e.length-1;if(!n&&s.startsWith("..")){let v=s.split("/");for(;v[0]==="..";)v.shift(),h-=1;i.pathname=v.join("/")}l=h>=0?e[h]:"/"}let u=iP(i,l),d=s&&s!=="/"&&s.endsWith("/"),c=(a||s===".")&&t.endsWith("/");return!u.pathname.endsWith("/")&&(d||c)&&(u.pathname+="/"),u}o(qg,"resolveTo");const Ti=o(r=>r.join("/").replace(/\/\/+/g,"/"),"joinPaths"),oP=o(r=>r.replace(/\/+$/,"").replace(/^\/*/,"/"),"normalizePathname"),lP=o(r=>!r||r==="?"?"":r.startsWith("?")?r:"?"+r,"normalizeSearch"),uP=o(r=>!r||r==="#"?"":r.startsWith("#")?r:"#"+r,"normalizeHash");function dP(r){return r!=null&&typeof r.status=="number"&&typeof r.statusText=="string"&&typeof r.internal=="boolean"&&"data"in r}o(dP,"isRouteErrorResponse");const iR=["post","put","patch","delete"];new Set(iR);const cP=["get",...iR];new Set(cP);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Ol(){return Ol=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Ol.apply(this,arguments)}o(Ol,"_extends$1");const yh=W.createContext(null),aR=W.createContext(null),Hn=W.createContext(null),Sh=W.createContext(null),En=W.createContext({outlet:null,matches:[],isDataRoute:!1}),sR=W.createContext(null);function hP(r,e){let{relative:t}=e===void 0?{}:e;io()||st(!1);let{basename:n,navigator:i}=W.useContext(Hn),{hash:a,pathname:s,search:l}=Eh(r,{relative:t}),u=s;return n!=="/"&&(u=s==="/"?n:Ti([n,s])),i.createHref({pathname:u,search:l,hash:a})}o(hP,"useHref");function io(){return W.useContext(Sh)!=null}o(io,"useInRouterContext");function _n(){return io()||st(!1),W.useContext(Sh).location}o(_n,"useLocation");function oR(r){W.useContext(Hn).static||W.useLayoutEffect(r)}o(oR,"useIsomorphicLayoutEffect");function ao(){let{isDataRoute:r}=W.useContext(En);return r?IP():fP()}o(ao,"useNavigate");function fP(){io()||st(!1);let r=W.useContext(yh),{basename:e,future:t,navigator:n}=W.useContext(Hn),{matches:i}=W.useContext(En),{pathname:a}=_n(),s=JSON.stringify(Vg(i,t.v7_relativeSplatPath)),l=W.useRef(!1);return oR(()=>{l.current=!0}),W.useCallback(function(d,c){if(c===void 0&&(c={}),!l.current)return;if(typeof d=="number"){n.go(d);return}let h=qg(d,JSON.parse(s),a,c.relative==="path");r==null&&e!=="/"&&(h.pathname=h.pathname==="/"?e:Ti([e,h.pathname])),(c.replace?n.replace:n.push)(h,c.state,c)},[e,n,s,a,r])}o(fP,"useNavigateUnstable");const vP=W.createContext(null);function pP(r){let e=W.useContext(En).outlet;return e&&W.createElement(vP.Provider,{value:r},e)}o(pP,"useOutlet");function so(){let{matches:r}=W.useContext(En),e=r[r.length-1];return e?e.params:{}}o(so,"useParams");function Eh(r,e){let{relative:t}=e===void 0?{}:e,{future:n}=W.useContext(Hn),{matches:i}=W.useContext(En),{pathname:a}=_n(),s=JSON.stringify(Vg(i,n.v7_relativeSplatPath));return W.useMemo(()=>qg(r,JSON.parse(s),a,t==="path"),[r,s,a,t])}o(Eh,"useResolvedPath");function mP(r,e){return gP(r,e)}o(mP,"useRoutes");function gP(r,e,t,n){io()||st(!1);let{navigator:i}=W.useContext(Hn),{matches:a}=W.useContext(En),s=a[a.length-1],l=s?s.params:{};s&&s.pathname;let u=s?s.pathnameBase:"/";s&&s.route;let d=_n(),c;if(e){var h;let T=typeof e=="string"?wa(e):e;u==="/"||(h=T.pathname)!=null&&h.startsWith(u)||st(!1),c=T}else c=d;let v=c.pathname||"/",g=v;if(u!=="/"){let T=u.replace(/^\//,"").split("/");g="/"+v.replace(/^\//,"").split("/").slice(T.length).join("/")}let p=Vk(r,{pathname:g}),m=_P(p&&p.map(T=>Object.assign({},T,{params:Object.assign({},l,T.params),pathname:Ti([u,i.encodeLocation?i.encodeLocation(T.pathname).pathname:T.pathname]),pathnameBase:T.pathnameBase==="/"?u:Ti([u,i.encodeLocation?i.encodeLocation(T.pathnameBase).pathname:T.pathnameBase])})),a,t,n);return e&&m?W.createElement(Sh.Provider,{value:{location:Ol({pathname:"/",search:"",hash:"",state:null,key:"default"},c),navigationType:vi.Pop}},m):m}o(gP,"useRoutesImpl");function yP(){let r=RP(),e=dP(r)?r.status+" "+r.statusText:r instanceof Error?r.message:JSON.stringify(r),t=r instanceof Error?r.stack:null,i={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return W.createElement(W.Fragment,null,W.createElement("h2",null,"Unexpected Application Error!"),W.createElement("h3",{style:{fontStyle:"italic"}},e),t?W.createElement("pre",{style:i},t):null,null)}o(yP,"DefaultErrorComponent");const SP=W.createElement(yP,null),yy=class yy extends W.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||t.revalidation!=="idle"&&e.revalidation==="idle"?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:e.error!==void 0?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){console.error("React Router caught the following error during render",e,t)}render(){return this.state.error!==void 0?W.createElement(En.Provider,{value:this.props.routeContext},W.createElement(sR.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};o(yy,"RenderErrorBoundary");let Fv=yy;function EP(r){let{routeContext:e,match:t,children:n}=r,i=W.useContext(yh);return i&&i.static&&i.staticContext&&(t.route.errorElement||t.route.ErrorBoundary)&&(i.staticContext._deepestRenderedBoundaryId=t.route.id),W.createElement(En.Provider,{value:e},n)}o(EP,"RenderedRoute");function _P(r,e,t,n){var i;if(e===void 0&&(e=[]),t===void 0&&(t=null),n===void 0&&(n=null),r==null){var a;if(!t)return null;if(t.errors)r=t.matches;else if((a=n)!=null&&a.v7_partialHydration&&e.length===0&&!t.initialized&&t.matches.length>0)r=t.matches;else return null}let s=r,l=(i=t)==null?void 0:i.errors;if(l!=null){let c=s.findIndex(h=>h.route.id&&(l==null?void 0:l[h.route.id])!==void 0);c>=0||st(!1),s=s.slice(0,Math.min(s.length,c+1))}let u=!1,d=-1;if(t&&n&&n.v7_partialHydration)for(let c=0;c<s.length;c++){let h=s[c];if((h.route.HydrateFallback||h.route.hydrateFallbackElement)&&(d=c),h.route.id){let{loaderData:v,errors:g}=t,p=h.route.loader&&v[h.route.id]===void 0&&(!g||g[h.route.id]===void 0);if(h.route.lazy||p){u=!0,d>=0?s=s.slice(0,d+1):s=[s[0]];break}}}return s.reduceRight((c,h,v)=>{let g,p=!1,m=null,T=null;t&&(g=l&&h.route.id?l[h.route.id]:void 0,m=h.route.errorElement||SP,u&&(d<0&&v===0?(CP("route-fallback"),p=!0,T=null):d===v&&(p=!0,T=h.route.hydrateFallbackElement||null)));let y=e.concat(s.slice(0,v+1)),S=o(()=>{let w;return g?w=m:p?w=T:h.route.Component?w=W.createElement(h.route.Component,null):h.route.element?w=h.route.element:w=c,W.createElement(EP,{match:h,routeContext:{outlet:c,matches:y,isDataRoute:t!=null},children:w})},"getChildren");return t&&(h.route.ErrorBoundary||h.route.errorElement||v===0)?W.createElement(Fv,{location:t.location,revalidation:t.revalidation,component:m,error:g,children:S(),routeContext:{outlet:null,matches:y,isDataRoute:!0}}):S()},null)}o(_P,"_renderMatches");var lR=function(r){return r.UseBlocker="useBlocker",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r}(lR||{}),uR=function(r){return r.UseBlocker="useBlocker",r.UseLoaderData="useLoaderData",r.UseActionData="useActionData",r.UseRouteError="useRouteError",r.UseNavigation="useNavigation",r.UseRouteLoaderData="useRouteLoaderData",r.UseMatches="useMatches",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r.UseRouteId="useRouteId",r}(uR||{});function bP(r){let e=W.useContext(yh);return e||st(!1),e}o(bP,"useDataRouterContext$1");function wP(r){let e=W.useContext(aR);return e||st(!1),e}o(wP,"useDataRouterState");function TP(r){let e=W.useContext(En);return e||st(!1),e}o(TP,"useRouteContext");function dR(r){let e=TP(),t=e.matches[e.matches.length-1];return t.route.id||st(!1),t.route.id}o(dR,"useCurrentRouteId");function RP(){var r;let e=W.useContext(sR),t=wP(),n=dR();return e!==void 0?e:(r=t.errors)==null?void 0:r[n]}o(RP,"useRouteError");function IP(){let{router:r}=bP(lR.UseNavigateStable),e=dR(uR.UseNavigateStable),t=W.useRef(!1);return oR(()=>{t.current=!0}),W.useCallback(function(i,a){a===void 0&&(a={}),t.current&&(typeof i=="number"?r.navigate(i):r.navigate(i,Ol({fromRouteId:e},a)))},[r,e])}o(IP,"useNavigateStable");const O_={};function CP(r,e,t){O_[r]||(O_[r]=!0)}o(CP,"warningOnce");function OP(r,e){r==null||r.v7_startTransition,r==null||r.v7_relativeSplatPath}o(OP,"logV6DeprecationWarnings");function Gg(r){let{to:e,replace:t,state:n,relative:i}=r;io()||st(!1);let{future:a,static:s}=W.useContext(Hn),{matches:l}=W.useContext(En),{pathname:u}=_n(),d=ao(),c=qg(e,Vg(l,a.v7_relativeSplatPath),u,i==="path"),h=JSON.stringify(c);return W.useEffect(()=>d(JSON.parse(h),{replace:t,state:n,relative:i}),[d,h,i,t,n]),null}o(Gg,"Navigate");function kP(r){return pP(r.context)}o(kP,"Outlet");function bt(r){st(!1)}o(bt,"Route");function PP(r){let{basename:e="/",children:t=null,location:n,navigationType:i=vi.Pop,navigator:a,static:s=!1,future:l}=r;io()&&st(!1);let u=e.replace(/^\/*/,"/"),d=W.useMemo(()=>({basename:u,navigator:a,static:s,future:Ol({v7_relativeSplatPath:!1},l)}),[u,l,a,s]);typeof n=="string"&&(n=wa(n));let{pathname:c="/",search:h="",hash:v="",state:g=null,key:p="default"}=n,m=W.useMemo(()=>{let T=Ws(c,u);return T==null?null:{location:{pathname:T,search:h,hash:v,state:g,key:p},navigationType:i}},[u,c,h,v,g,p,i]);return m==null?null:W.createElement(Hn.Provider,{value:d},W.createElement(Sh.Provider,{children:t,value:m}))}o(PP,"Router");function MP(r){let{children:e,location:t}=r;return mP(Bv(e),t)}o(MP,"Routes");new Promise(()=>{});function Bv(r,e){e===void 0&&(e=[]);let t=[];return W.Children.forEach(r,(n,i)=>{if(!W.isValidElement(n))return;let a=[...e,i];if(n.type===W.Fragment){t.push.apply(t,Bv(n.props.children,a));return}n.type!==bt&&st(!1),!n.props.index||!n.props.children||st(!1);let s={id:n.props.id||a.join("-"),caseSensitive:n.props.caseSensitive,element:n.props.element,Component:n.props.Component,index:n.props.index,path:n.props.path,loader:n.props.loader,action:n.props.action,errorElement:n.props.errorElement,ErrorBoundary:n.props.ErrorBoundary,hasErrorBoundary:n.props.ErrorBoundary!=null||n.props.errorElement!=null,shouldRevalidate:n.props.shouldRevalidate,handle:n.props.handle,lazy:n.props.lazy};n.props.children&&(s.children=Bv(n.props.children,a)),t.push(s)}),t}o(Bv,"createRoutesFromChildren");/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Jd(){return Jd=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Jd.apply(this,arguments)}o(Jd,"_extends");function cR(r,e){if(r==null)return{};var t={},n=Object.keys(r),i,a;for(a=0;a<n.length;a++)i=n[a],!(e.indexOf(i)>=0)&&(t[i]=r[i]);return t}o(cR,"_objectWithoutPropertiesLoose$1");function AP(r){return!!(r.metaKey||r.altKey||r.ctrlKey||r.shiftKey)}o(AP,"isModifiedEvent");function xP(r,e){return r.button===0&&(!e||e==="_self")&&!AP(r)}o(xP,"shouldProcessLinkClick");const DP=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],NP=["aria-current","caseSensitive","className","end","style","to","viewTransition","children"],LP="6";try{window.__reactRouterVersion=LP}catch{}const UP=W.createContext({isTransitioning:!1}),jP="startTransition",k_=kC[jP];function FP(r){let{basename:e,children:t,future:n,window:i}=r,a=W.useRef();a.current==null&&(a.current=$k({window:i,v5Compat:!0}));let s=a.current,[l,u]=W.useState({action:s.action,location:s.location}),{v7_startTransition:d}=n||{},c=W.useCallback(h=>{d&&k_?k_(()=>u(h)):u(h)},[u,d]);return W.useLayoutEffect(()=>s.listen(c),[s,c]),W.useEffect(()=>OP(n),[n]),W.createElement(PP,{basename:e,children:t,location:l.location,navigationType:l.action,navigator:s,future:n})}o(FP,"HashRouter");const BP=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",$P=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Hg=W.forwardRef(o(function(e,t){let{onClick:n,relative:i,reloadDocument:a,replace:s,state:l,target:u,to:d,preventScrollReset:c,viewTransition:h}=e,v=cR(e,DP),{basename:g}=W.useContext(Hn),p,m=!1;if(typeof d=="string"&&$P.test(d)&&(p=d,BP))try{let w=new URL(window.location.href),C=d.startsWith("//")?new URL(w.protocol+d):new URL(d),M=Ws(C.pathname,g);C.origin===w.origin&&M!=null?d=M+C.search+C.hash:m=!0}catch{}let T=hP(d,{relative:i}),y=VP(d,{replace:s,state:l,target:u,preventScrollReset:c,relative:i,viewTransition:h});function S(w){n&&n(w),w.defaultPrevented||y(w)}return o(S,"handleClick"),W.createElement("a",Jd({},v,{href:p||T,onClick:m||a?n:S,ref:t,target:u}))},"LinkWithRef")),WP=W.forwardRef(o(function(e,t){let{"aria-current":n="page",caseSensitive:i=!1,className:a="",end:s=!1,style:l,to:u,viewTransition:d,children:c}=e,h=cR(e,NP),v=Eh(u,{relative:h.relative}),g=_n(),p=W.useContext(aR),{navigator:m,basename:T}=W.useContext(Hn),y=p!=null&&qP(v)&&d===!0,S=m.encodeLocation?m.encodeLocation(v).pathname:v.pathname,w=g.pathname,C=p&&p.navigation&&p.navigation.location?p.navigation.location.pathname:null;i||(w=w.toLowerCase(),C=C?C.toLowerCase():null,S=S.toLowerCase()),C&&T&&(C=Ws(C,T)||C);const M=S!=="/"&&S.endsWith("/")?S.length-1:S.length;let _=w===S||!s&&w.startsWith(S)&&w.charAt(M)==="/",O=C!=null&&(C===S||!s&&C.startsWith(S)&&C.charAt(S.length)==="/"),b={isActive:_,isPending:O,isTransitioning:y},F=_?n:void 0,V;typeof a=="function"?V=a(b):V=[a,_?"active":null,O?"pending":null,y?"transitioning":null].filter(Boolean).join(" ");let z=typeof l=="function"?l(b):l;return W.createElement(Hg,Jd({},h,{"aria-current":F,className:V,ref:t,style:z,to:u,viewTransition:d}),typeof c=="function"?c(b):c)},"NavLinkWithRef"));var $v;(function(r){r.UseScrollRestoration="useScrollRestoration",r.UseSubmit="useSubmit",r.UseSubmitFetcher="useSubmitFetcher",r.UseFetcher="useFetcher",r.useViewTransitionState="useViewTransitionState"})($v||($v={}));var P_;(function(r){r.UseFetcher="useFetcher",r.UseFetchers="useFetchers",r.UseScrollRestoration="useScrollRestoration"})(P_||(P_={}));function KP(r){let e=W.useContext(yh);return e||st(!1),e}o(KP,"useDataRouterContext");function VP(r,e){let{target:t,replace:n,state:i,preventScrollReset:a,relative:s,viewTransition:l}=e===void 0?{}:e,u=ao(),d=_n(),c=Eh(r,{relative:s});return W.useCallback(h=>{if(xP(h,t)){h.preventDefault();let v=n!==void 0?n:zd(d)===zd(c);u(r,{replace:v,state:i,preventScrollReset:a,relative:s,viewTransition:l})}},[d,u,c,n,i,t,r,a,s,l])}o(VP,"useLinkClickHandler");function qP(r,e){e===void 0&&(e={});let t=W.useContext(UP);t==null&&st(!1);let{basename:n}=KP($v.useViewTransitionState),i=Eh(r,{relative:e.relative});if(!t.isTransitioning)return!1;let a=Ws(t.currentLocation.pathname,n)||t.currentLocation.pathname,s=Ws(t.nextLocation.pathname,n)||t.nextLocation.pathname;return jv(i.pathname,s)!=null||jv(i.pathname,a)!=null}o(qP,"useViewTransitionState");const M_="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function pf(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}o(pf,"readJSON$2");function GP(r){try{const e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}"),n=JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{};return{name:e.name||n.name||"Org",logo:e.logoDataUrl||e.logoUrl||n.logoDataUrl||n.logoUrl||null}}catch{return{name:"Org",logo:null}}}o(GP,"readOrgInfo");function HP(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)\/public/i);return r?decodeURIComponent(r[1]):null}o(HP,"parseOrgIdFromHash$1");function zP(r){const e=pf(`bf_org_settings_${r}`,{}),t=pf(`bf_public_cfg_${r}`,null)||pf(`bf_public_${r}`,null)||null,n=(t==null?void 0:t.title)||(e==null?void 0:e.name)||"Your Organization",i=(t==null?void 0:t.about)||"",a=Array.isArray(t==null?void 0:t.features)?t.features:[],s=Array.isArray(t==null?void 0:t.links)?t.links:[],l=(t==null?void 0:t.logoDataUrl)||(t==null?void 0:t.logoUrl)||(e==null?void 0:e.logoDataUrl)||(e==null?void 0:e.logoUrl)||null;return{title:n,about:i,features:a,links:s,logo:l,enabled:!0}}o(zP,"getPreviewConfig");function Qd(r){const e=(r==null?void 0:r.data)||null,{slug:t}=so(),[n,i]=W.useState(()=>e?{loading:!1,error:"",data:e}:t?{loading:!0,error:"",data:null}:{loading:!1,error:"",data:null}),[a,s]=W.useState([]);W.useEffect(()=>{if(!t||e)return;let m=!0;return(async()=>{try{const T=await fetch(`${M_}/api/public/${encodeURIComponent(t)}`),y=await T.json().catch(()=>({}));if(!m)return;if(!T.ok||y.ok===!1){i({loading:!1,error:y.error||`HTTP ${T.status}`,data:null});return}i({loading:!1,error:"",data:y});const w=await(await fetch(`${M_}/api/public/${encodeURIComponent(t)}/needs`)).json().catch(()=>({}));if(!m)return;s(Array.isArray(w.needs)?w.needs:[])}catch(T){m&&i({loading:!1,error:(T==null?void 0:T.message)||"Load failed",data:null})}})(),()=>{m=!1}},[t,e]);const{pubCfg:l,orgId:u}=W.useMemo(()=>{var y;if(t&&((y=n.data)!=null&&y.public)){const S=n.data.public,w=n.data.orgId||null;return{pubCfg:{title:S.title||t,about:S.about||"",features:Array.isArray(S.features)?S.features:[],links:Array.isArray(S.links)?S.links:[],logo:S.logoDataUrl||S.logoUrl||null,enabled:!0},orgId:w}}const m=HP();return{pubCfg:e!=null&&e.public?{title:e.public.title||"Your Organization",about:e.public.about||"",features:Array.isArray(e.public.features)?e.public.features:[],links:Array.isArray(e.public.links)?e.public.links:[],logo:e.public.logoDataUrl||e.public.logoUrl||null,enabled:!0}:zP(m),orgId:m}},[t,n.data,e]),d=W.useMemo(()=>u?GP(u):{name:"Org",logo:null},[u]),[c,h]=W.useState(""),[v,g]=W.useState(""),p=W.useMemo(()=>a.filter(m=>((m==null?void 0:m.status)??"open")==="open"),[a]);return n.loading?E.jsx("div",{style:{padding:16},children:"Loading"}):n.error?E.jsxs("div",{style:{padding:16,color:"crimson"},children:["Error: ",n.error]}):E.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[E.jsxs("header",{style:{display:"flex",alignItems:"center",gap:12,marginTop:0,borderBottom:"1px solid #eee",paddingBottom:12},children:[d.logo&&E.jsx("img",{src:d.logo,alt:"Org logo",style:{height:48,width:48,borderRadius:8,objectFit:"cover"}}),E.jsx("h1",{style:{margin:0,fontSize:24},children:(l==null?void 0:l.title)||d.name||t||"Public Page"})]}),(l==null?void 0:l.about)&&E.jsx("p",{style:{lineHeight:1.6,marginTop:12},children:l.about}),Array.isArray(l==null?void 0:l.features)&&l.features.length>0&&E.jsxs("div",{className:"card",style:{marginTop:16,padding:12},children:[E.jsx("h3",{className:"section-title",style:{margin:0},children:"What we do"}),E.jsx("ul",{style:{paddingLeft:18,marginTop:8},children:l.features.map((m,T)=>E.jsx("li",{children:m},T))})]}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:12,marginTop:12},children:[E.jsxs("section",{className:"card",style:{padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Open needs"}),E.jsxs("ul",{style:{paddingLeft:18,marginTop:8},children:[p.map(m=>E.jsxs("li",{children:[E.jsx("strong",{children:m.title||"Untitled"}),m.urgency?`  ${m.urgency}`:""]},m.id||m.title)),p.length===0&&E.jsx("li",{className:"helper",children:"No open needs right now."})]})]}),E.jsxs("section",{className:"card",style:{padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Stay in touch"}),E.jsx("div",{className:"helper",children:"Newsletter and pledges can be wired next."})]})]})]})}o(Qd,"PublicPage");function JP(r){let e={};try{e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}")}catch{}try{e={...JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{},...e}}catch{}return e||{}}o(JP,"readSettings");function QP(r){return Array.isArray(r)?r.filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>e.trim()).filter(Boolean):[]}o(QP,"toArray");function YP(r){return Array.isArray(r)?r.map(e=>e&&e.url?{text:e.text||e.url,url:e.url}:null).filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>{const[t,n]=e.split("|").map(i=>(i||"").trim());return n?{text:t||n,url:n}:null}).filter(Boolean):[]}o(YP,"toLinks");function XP(){const{orgId:r}=so(),e=JP(r),t=(e.publicTitle||e.title||e.name||"Public page").trim(),n=(e.publicAbout||e.about||"This is a live preview of your public page.").trim(),i=QP(e.publicFeatures??e.features),a=YP(e.publicLinks??e.links),s={public:{title:t,about:n,features:i.length?i:["Mutual aid & community support","Donations & supplies","Volunteer coordination"],links:a.length?a:[{text:"Website",url:"https://example.org"},{text:"Email",url:"mailto:hello@example.org"}]}};return E.jsx("div",{style:{margin:16},children:E.jsx(Qd,{data:s})})}o(XP,"OrgPublicPreview");function ZP(){return localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token")||""}o(ZP,"getAuthToken");async function it(r,e={}){const t=new Headers(e.headers||{}),n=ZP();n&&t.set("authorization",`Bearer ${n}`),!t.has("content-type")&&e.body&&typeof e.body=="string"&&t.set("content-type","application/json; charset=utf-8");const i=await fetch(r,{...e,headers:t}),a=await i.json().catch(()=>({}));if(!i.ok||(a==null?void 0:a.ok)===!1){const s=(a==null?void 0:a.error)||(a==null?void 0:a.message)||`HTTP_${i.status}`;throw new Error(s)}return a}o(it,"api");function eM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(eM,"getOrgId$5");function A_(){const r=ao(),e=eM(),[t,n]=W.useState(!1),[i,a]=W.useState("..."),[s,l]=W.useState(null);async function u(){if(e){n(!0),a("");try{const g=await it(`/api/orgs/${encodeURIComponent(e)}/dashboard`);l(g)}catch(g){a((g==null?void 0:g.message)||"Failed to load dashboard")}finally{n(!1)}}}o(u,"refresh"),W.useEffect(()=>{u().catch(console.error)},[e]);const d=(s==null?void 0:s.counts)||{},c=Array.isArray(s==null?void 0:s.people)?s.people:[],h=Array.isArray(s==null?void 0:s.needs)?s.needs:[],v=Array.isArray(s==null?void 0:s.activity)?s.activity:[];return e?E.jsxs("div",{style:{padding:16},children:[E.jsxs("div",{className:"card",style:{padding:16,marginBottom:12},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h1",{style:{margin:0,flex:1},children:"Bondfire Dashboard"}),E.jsx("button",{className:"btn",onClick:o(()=>u().catch(console.error),"onClick"),disabled:t,children:t?"Loading":"Refresh"})]}),i&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:i})]}),E.jsxs("div",{className:"grid",style:{gridTemplateColumns:"repeat(auto-fit, minmax(260px, 1fr))",gap:12},children:[E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"People"}),E.jsx("button",{className:"btn",onClick:o(()=>go("people"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.people||0," member",(d.people||0)===1?"":"s"]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[c.map(g=>E.jsx("li",{children:g.name},g.id)),c.length===0&&E.jsx("li",{className:"helper",children:"No people yet."})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Inventory"}),E.jsx("button",{className:"btn",onClick:o(()=>r("inventory"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.inventory||0," item",(d.inventory||0)===1?"":"s"]}),E.jsx("div",{className:"helper",style:{marginTop:10},children:"Manage supplies and public-facing items."})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Needs"}),E.jsx("button",{className:"btn",onClick:o(()=>r("needs"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.needsAll||0," total, ",d.needsOpen||0," open"]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[h.map(g=>E.jsxs("li",{children:[g.title," ",g.status?` ${g.status}`:""]},g.id)),h.length===0&&E.jsx("li",{className:"helper",children:"No needs yet."})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Meetings"}),E.jsx("button",{className:"btn",onClick:o(()=>r("meetings"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.meetingsUpcoming||0," upcoming"]}),E.jsx("div",{className:"helper",style:{marginTop:10},children:"Notes and decisions, tied to people and needs."})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Recent Activity"}),E.jsx("button",{className:"btn",onClick:o(()=>u().catch(console.error),"onClick"),disabled:t,children:"Refresh"})]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[v.map(g=>E.jsxs("li",{children:[E.jsx("strong",{children:g.kind}),": ",g.message]},g.id||`${g.kind}-${g.created_at}`)),v.length===0&&E.jsx("li",{className:"helper",children:"No activity yet."})]})]})]})]}):E.jsx("div",{style:{padding:16},children:"No org selected."})}o(A_,"Overview");const tM="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function x_(r,e={}){const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=r.startsWith("http")?r:`${tM}${r.startsWith("/")?"":"/"}${r}`,i={"Content-Type":"application/json",...e.headers||{}};return t&&(i.Authorization=`Bearer ${t}`),fetch(n,{...e,headers:i,body:e.body?JSON.stringify(e.body):void 0}).then(async a=>{const s=await a.json().catch(()=>({}));if(!a.ok||s.ok===!1)throw new Error(s.error||s.message||`HTTP ${a.status}`);return s})}o(x_,"authFetch$1");function D_(){const[r,e]=W.useState(""),[t,n]=W.useState(""),[i,a]=W.useState([]),[s,l]=W.useState(""),u=ao(),d=o(async()=>{try{const v=await x_("/api/orgs",{method:"GET"});a(Array.isArray(v.orgs)?v.orgs:[])}catch(v){l(v.message||"Failed to load orgs")}},"refreshOrgs");W.useEffect(()=>{d()},[]);const c=o(v=>{v.preventDefault(),l("Org creation is currently done during account creation. (Invite-based org creation coming soon.)"),setTimeout(()=>l(""),2500),e("")},"create"),h=o(async v=>{v.preventDefault();const g=t.trim();if(g){l("");try{await x_("/api/invites/redeem",{method:"POST",body:{code:g}}),n(""),await d(),l("Joined."),setTimeout(()=>l(""),1200)}catch(p){l(p.message||"Join failed")}}},"join");return E.jsxs("div",{className:"grid",style:{gap:12},children:[E.jsxs("div",{className:"card",children:[E.jsx("h1",{style:{margin:"4px 0 8px"},children:"Org Dashboard"}),E.jsx("p",{className:"helper",children:"Choose an organization to enter its workspace, or create/join one."})]}),E.jsx("div",{style:{marginTop:8},children:E.jsx("button",{className:"primary",type:"button",onClick:o(()=>window.location.assign("/#/mfa"),"onClick"),children:"Set up 2FA (recommended)"})}),E.jsxs("div",{className:"grid cols-2",children:[E.jsxs("div",{className:"card",children:[E.jsx("h3",{children:"Create a new org"}),E.jsxs("form",{onSubmit:c,className:"grid",style:{gap:8},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Organization name"}),E.jsx("input",{value:r,onChange:o(v=>e(v.target.value),"onChange"),placeholder:"e.g. Bondfire Team"})]}),E.jsx("button",{className:"primary",type:"submit",children:"Create"})]}),E.jsx("p",{className:"helper",style:{marginTop:8},children:"Org creation currently happens during account creation. Invite codes are for joining existing orgs."})]}),E.jsxs("div",{className:"card",children:[E.jsx("h3",{children:"Join with an invite code"}),E.jsxs("form",{onSubmit:h,className:"grid",style:{gap:8},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Invite code"}),E.jsx("input",{value:t,onChange:o(v=>n(v.target.value),"onChange"),placeholder:"Paste invite code"})]}),E.jsx("button",{className:"primary",type:"submit",children:"Join"})]})]})]}),E.jsxs("div",{className:"card",children:[E.jsx("h3",{children:"Your orgs"}),s?E.jsx("p",{className:s==="Joined."?"success":"error",style:{marginTop:6},children:s}):null,i.length?E.jsx("ul",{style:{display:"grid",gap:8,marginTop:8,listStyle:"none",padding:0},children:i.map(v=>E.jsxs("li",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontWeight:600},children:v.name}),E.jsxs("div",{className:"helper",children:["Role: ",v.role]})]}),E.jsx("button",{className:"btn",onClick:o(()=>u(`/org/${v.id}/overview`),"onClick"),children:"Open"})]},v.id))}):E.jsx("p",{className:"helper",style:{marginTop:6},children:"You dont belong to any orgs yet."})]})]})}o(D_,"OrgDash");const rM=W.createContext(null),N_=o(()=>W.useContext(rM),"useOrg"),hR="bf_store_v2",L_=o(()=>({orgs:[{id:"crman",name:"Chehalis River Mutual Aid Network",slug:"crman",color:"#8a1111",logoDataUrl:null},{id:"bondfire",name:"Bondfire",slug:"bondfire",color:"#8a1111",logoDataUrl:null}],currentOrgId:"crman",people:[],inventory:[],needs:[],meetings:[],pledges:[],newsletters:[],requests:[],files:{}}),"defaultState");function U_(r){return localStorage.setItem(hR,JSON.stringify(r)),r}o(U_,"save");function nM(){try{return JSON.parse(localStorage.getItem(hR))||U_(L_())}catch{return U_(L_())}}o(nM,"load");nM();function iM(){const{orgId:r}=so();return((typeof N_=="function"?N_():{})||{}).orgName,E.jsx("div",{style:{padding:0},children:E.jsx(kP,{})})}o(iM,"InnerSanctum");function aM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(aM,"getOrgId$4");function sM(){const r=aM(),[e,t]=W.useState([]);async function n(){if(!r)return;const u=await it(`/api/orgs/${encodeURIComponent(r)}/people`);t(u.people||[])}o(n,"refresh"),W.useEffect(()=>{n().catch(console.error)},[r]);const[i,a]=W.useState(""),s=W.useMemo(()=>{const u=i.toLowerCase();return e.filter(d=>[d.name,d.role,d.skills,d.phone].filter(Boolean).join(" ").toLowerCase().includes(u))},[e,i]);async function l(u){if(u.preventDefault(),!r)return;const d=new FormData(u.currentTarget),c=String(d.get("name")||"").trim();if(!c)return;const h=String(d.get("role")||""),v=String(d.get("phone")||""),g=String(d.get("skills")||""),p=await it(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c,role:h,phone:v,skills:g})});p!=null&&p.id&&t(m=>[{id:p.id,name:c,role:h,phone:v,skills:g},...m]),u.currentTarget.reset(),setTimeout(()=>{n().catch(console.error)},500)}return o(l,"onAdd"),E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsx("h2",{className:"section-title",children:"People"}),E.jsx("input",{className:"input",value:i,onChange:o(u=>a(u.target.value),"onChange"),placeholder:"Search by name, role, phone, skills"}),E.jsxs("table",{className:"table",style:{marginTop:12},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{children:"Name"}),E.jsx("th",{children:"Role"}),E.jsx("th",{children:"Phone"}),E.jsx("th",{children:"Skills"}),E.jsx("th",{})]})}),E.jsxs("tbody",{children:[s.map(u=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.name,onBlur:o(d=>it(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,name:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.role,onBlur:o(d=>it(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,role:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.phone,onBlur:o(d=>it(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,phone:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.skills,onBlur:o(d=>it(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,skills:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>it(`/api/orgs/${encodeURIComponent(r)}/people?id=${encodeURIComponent(u.id)}`,{method:"DELETE"}).then(()=>n()).catch(console.error),"onClick"),children:"Delete"})})]},u.id)),s.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:5,className:"helper",children:"No people match."})})]})]}),E.jsxs("form",{onSubmit:l,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),E.jsx("input",{className:"input",name:"role",placeholder:"Role"}),E.jsx("input",{className:"input",name:"phone",placeholder:"Phone"}),E.jsx("input",{className:"input",name:"skills",placeholder:"Skills"}),E.jsx("div",{}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Person"})]})]})})}o(sM,"People");function oM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(oM,"getOrgId$3");function lM(){const r=oM(),[e,t]=W.useState([]),[n,i]=W.useState(""),[a,s]=W.useState(!1),[l,u]=W.useState("");async function d(){if(r){s(!0);try{const m=await it(`/api/orgs/${encodeURIComponent(r)}/inventory`);t(Array.isArray(m.inventory)?m.inventory:[])}finally{s(!1)}}}o(d,"refresh"),W.useEffect(()=>{d().catch(console.error)},[r]);const c=W.useMemo(()=>{const m=n.toLowerCase();return e.filter(T=>[T.name,T.category,T.location,T.notes,T.unit].filter(Boolean).join(" ").toLowerCase().includes(m))},[e,n]);async function h(m,T){!r||!m||(await it(`/api/orgs/${encodeURIComponent(r)}/inventory`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m,...T})}),d().catch(console.error))}o(h,"putItem");async function v(m){!r||!m||(await it(`/api/orgs/${encodeURIComponent(r)}/inventory?id=${encodeURIComponent(m)}`,{method:"DELETE"}),d().catch(console.error))}o(v,"delItem");async function g(m){if(m.preventDefault(),!r)return;const T=new FormData(m.currentTarget),y=String(T.get("name")||"").trim();if(!y)return;const S=String(T.get("qty")||""),w=String(T.get("unit")||""),C=String(T.get("category")||""),M=String(T.get("location")||""),_=String(T.get("notes")||""),O=String(T.get("is_public")||"")==="on",b=await it(`/api/orgs/${encodeURIComponent(r)}/inventory`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:y,qty:S,unit:w,category:C,location:M,notes:_,is_public:O})});b!=null&&b.id&&t(F=>[{id:b.id,name:y,qty:S,unit:w,category:C,location:M,notes:_,is_public:O?1:0},...F]),m.currentTarget.reset(),setTimeout(()=>{d().catch(console.error)},500)}o(g,"onAdd");const p={width:"100%",minWidth:80,boxSizing:"border-box"};return E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Inventory"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(m=>i(m.target.value),"onChange"),placeholder:"Search inventory",style:{marginTop:12}}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:980},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"22%"},children:"Name"}),E.jsx("th",{style:{width:"10%"},children:"Qty"}),E.jsx("th",{style:{width:"10%"},children:"Unit"}),E.jsx("th",{style:{width:"14%"},children:"Category"}),E.jsx("th",{style:{width:"14%"},children:"Location"}),E.jsx("th",{style:{width:"22%"},children:"Notes"}),E.jsx("th",{style:{width:"4%"},children:"Pub"}),E.jsx("th",{style:{width:"4%"}})]})}),E.jsxs("tbody",{children:[c.map(m=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.name||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.name||"")&&h(m.id,{name:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"number",step:"any",defaultValue:m.qty===null||typeof m.qty>"u"?"":m.qty,style:p,onBlur:o(T=>{const y=T.target.value,S=y===""?null:Number(y),w=m.qty===null||typeof m.qty>"u"?null:Number(m.qty);S!==w&&h(m.id,{qty:S}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.unit||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.unit||"")&&h(m.id,{unit:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.category||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.category||"")&&h(m.id,{category:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.location||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.location||"")&&h(m.id,{location:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.notes||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.notes||"")&&h(m.id,{notes:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{style:{textAlign:"center"},children:E.jsx("input",{type:"checkbox",defaultChecked:!!m.is_public,onChange:o(T=>h(m.id,{is_public:T.target.checked}).catch(console.error),"onChange")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(m.id).catch(console.error),"onClick"),children:"Delete"})})]},m.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:8,className:"helper",children:"No inventory items match."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),E.jsx("input",{className:"input",name:"qty",placeholder:"Qty",type:"number",step:"any"}),E.jsx("input",{className:"input",name:"unit",placeholder:"Unit"}),E.jsx("input",{className:"input",name:"category",placeholder:"Category"}),E.jsx("input",{className:"input",name:"location",placeholder:"Location"}),E.jsx("input",{className:"input",name:"notes",placeholder:"Notes"}),E.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx("input",{type:"checkbox",name:"is_public"}),"Public"]}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Item"})]})]})})}o(lM,"Inventory");function uM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(uM,"getOrgId$2");function j_(r){if(!r)return"";const e=new Date(Number(r)),t=o(n=>String(n).padStart(2,"0"),"pad");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}T${t(e.getHours())}:${t(e.getMinutes())}`}o(j_,"toInputDT");function ju(r){if(!r)return null;const e=Date.parse(r);return Number.isFinite(e)?e:null}o(ju,"fromInputDT");function dM(){const r=uM(),[e,t]=W.useState([]),[n,i]=W.useState(""),[a,s]=W.useState(!1),[l,u]=W.useState("");async function d(){if(r){s(!0),u("");try{const p=await it(`/api/orgs/${encodeURIComponent(r)}/meetings`);t(Array.isArray(p.meetings)?p.meetings:[])}catch(p){console.error(p),u((p==null?void 0:p.message)||String(p))}finally{s(!1)}}}o(d,"refresh"),W.useEffect(()=>{d().catch(console.error)},[r]);const c=W.useMemo(()=>{const p=n.toLowerCase();return e.filter(m=>`${m.title||""} ${m.location||""} ${m.agenda||""}`.toLowerCase().includes(p))},[e,n]);async function h(p,m){!r||!p||(await it(`/api/orgs/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:p,...m})}),d().catch(console.error))}o(h,"putMeeting");async function v(p){!r||!p||(await it(`/api/orgs/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p)}`,{method:"DELETE"}),d().catch(console.error))}o(v,"delMeeting");async function g(p){if(p.preventDefault(),!r)return;const m=new FormData(p.currentTarget),T=String(m.get("title")||"").trim();if(!T)return;const y=ju(String(m.get("starts_at")||"")),S=ju(String(m.get("ends_at")||"")),w=String(m.get("location")||""),C=String(m.get("agenda")||""),M=await it(`/api/orgs/${encodeURIComponent(r)}/meetings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:T,starts_at:y,ends_at:S,location:w,agenda:C})});M!=null&&M.id&&t(_=>[{id:M.id,title:T,starts_at:y,ends_at:S,location:w,agenda:C},..._]),p.currentTarget.reset(),setTimeout(()=>{d().catch(console.error)},500)}return o(g,"onAdd"),E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Meetings"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(p=>i(p.target.value),"onChange"),placeholder:"Search meetings",style:{marginTop:12}}),l&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:l}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:860},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"26%"},children:"Title"}),E.jsx("th",{style:{width:"20%"},children:"Starts"}),E.jsx("th",{style:{width:"20%"},children:"Ends"}),E.jsx("th",{style:{width:"22%"},children:"Location"}),E.jsx("th",{style:{width:"12%"}})]})}),E.jsxs("tbody",{children:[c.map(p=>E.jsxs("tr",{children:[E.jsxs("td",{children:[E.jsx("input",{className:"input",defaultValue:p.title||"",onBlur:o(m=>{const T=m.target.value||"";T!==(p.title||"")&&h(p.id,{title:T}).catch(console.error)},"onBlur")}),E.jsx("div",{className:"helper",style:{marginTop:6},children:E.jsx(Hg,{to:`/org/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p.id)}`,children:"Open"})})]}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"datetime-local",defaultValue:j_(p.starts_at),onBlur:o(m=>{const T=ju(m.target.value);(T??null)!==(p.starts_at??null)&&h(p.id,{starts_at:T}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"datetime-local",defaultValue:j_(p.ends_at),onBlur:o(m=>{const T=ju(m.target.value);(T??null)!==(p.ends_at??null)&&h(p.id,{ends_at:T}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:p.location||"",onBlur:o(m=>{const T=m.target.value||"";T!==(p.location||"")&&h(p.id,{location:T}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(p.id).catch(console.error),"onClick"),children:"Delete"})})]},p.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:5,className:"helper",children:"No meetings."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid",style:{gap:10,marginTop:12},children:[E.jsx("input",{className:"input",name:"title",placeholder:"Title",required:!0}),E.jsx("input",{className:"input",name:"starts_at",type:"datetime-local"}),E.jsx("input",{className:"input",name:"ends_at",type:"datetime-local"}),E.jsx("input",{className:"input",name:"location",placeholder:"Location"}),E.jsx("input",{className:"input",name:"agenda",placeholder:"Agenda (short)"}),E.jsx("button",{className:"btn",children:"Add Meeting"})]})]})})}o(dM,"Meetings");function cM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(cM,"getOrgId$1");function F_(r){if(!r)return"";const e=new Date(Number(r));if(Number.isNaN(e.getTime()))return"";const t=o(n=>String(n).padStart(2,"0"),"pad");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}T${t(e.getHours())}:${t(e.getMinutes())}`}o(F_,"toLocalDateTimeInput");function B_(r){if(!r)return null;const e=Date.parse(r);return Number.isFinite(e)?e:null}o(B_,"fromLocalDateTimeInput");function hM(){const r=ao(),{meetingId:e}=so(),t=cM(),[n,i]=W.useState(null),[a,s]=W.useState(""),[l,u]=W.useState(!1);async function d(){if(!t||!e)return;const v=await it(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`);i(v.meeting||null)}o(d,"refresh"),W.useEffect(()=>{d().catch(v=>s((v==null?void 0:v.message)||String(v)))},[t,e]);async function c(v){if(!(!t||!e)){u(!0),s("");try{await it(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)}),await d()}catch(g){s((g==null?void 0:g.message)||String(g))}finally{u(!1)}}}o(c,"save");async function h(){if(!(!t||!e)&&confirm("Delete this meeting?")){u(!0),s("");try{await it(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`,{method:"DELETE"}),r(`/org/${encodeURIComponent(t)}/meetings`,{replace:!0})}catch(v){s((v==null?void 0:v.message)||String(v))}finally{u(!1)}}}return o(h,"del"),t?n?E.jsxs("div",{className:"card",style:{margin:16,padding:12},children:[E.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center"},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Meeting"}),E.jsx("button",{className:"btn",onClick:o(()=>r(-1),"onClick"),disabled:l,children:"Back"}),E.jsx("button",{className:"btn",onClick:h,disabled:l,children:"Delete"})]}),a&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:8},children:a}),E.jsxs("div",{className:"grid",style:{gap:10,marginTop:12},children:[E.jsx("input",{className:"input",defaultValue:n.title||"",placeholder:"Title",onBlur:o(v=>{const g=v.target.value||"";g!==(n.title||"")&&c({title:g}).catch(console.error)},"onBlur")}),E.jsxs("div",{className:"grid cols-2",style:{gap:10},children:[E.jsxs("div",{children:[E.jsx("div",{className:"helper",children:"Start"}),E.jsx("input",{className:"input",type:"datetime-local",defaultValue:F_(n.starts_at),onBlur:o(v=>{const g=B_(v.target.value);g!==(n.starts_at??null)&&c({starts_at:g}).catch(console.error)},"onBlur")})]}),E.jsxs("div",{children:[E.jsx("div",{className:"helper",children:"End"}),E.jsx("input",{className:"input",type:"datetime-local",defaultValue:F_(n.ends_at),onBlur:o(v=>{const g=B_(v.target.value);g!==(n.ends_at??null)&&c({ends_at:g}).catch(console.error)},"onBlur")})]})]}),E.jsx("input",{className:"input",defaultValue:n.location||"",placeholder:"Location",onBlur:o(v=>{const g=v.target.value||"";g!==(n.location||"")&&c({location:g}).catch(console.error)},"onBlur")}),E.jsx("textarea",{className:"textarea",defaultValue:n.agenda||"",placeholder:"Agenda",rows:4,onBlur:o(v=>{const g=v.target.value||"";g!==(n.agenda||"")&&c({agenda:g}).catch(console.error)},"onBlur")}),E.jsx("textarea",{className:"textarea",defaultValue:n.notes||"",placeholder:"Notes",rows:6,onBlur:o(v=>{const g=v.target.value||"";g!==(n.notes||"")&&c({notes:g}).catch(console.error)},"onBlur")})]})]}):E.jsx("div",{style:{padding:16},children:a?`Error: ${a}`:"Loading..."}):E.jsx("div",{style:{padding:16},children:"No org selected."})}o(hM,"MeetingDetail");function fM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(fM,"getOrgId");function vM(){const r=fM(),[e,t]=W.useState([]),[n,i]=W.useState(""),[a,s]=W.useState(!1),[l,u]=W.useState("");async function d(){if(r){s(!0),u("");try{const m=await it(`/api/orgs/${encodeURIComponent(r)}/needs`);t(Array.isArray(m.needs)?m.needs:[])}catch(m){console.error(m),u((m==null?void 0:m.message)||String(m))}finally{s(!1)}}}o(d,"refreshNeeds"),W.useEffect(()=>{d().catch(console.error)},[r]);const c=W.useMemo(()=>{const m=n.toLowerCase();return e.filter(T=>[T.title,T.description,T.urgency,T.status].filter(Boolean).join(" ").toLowerCase().includes(m))},[e,n]);async function h(m,T){!r||!m||(await it(`/api/orgs/${encodeURIComponent(r)}/needs`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m,...T})}),d().catch(console.error))}o(h,"putNeed");async function v(m){!r||!m||(await it(`/api/orgs/${encodeURIComponent(r)}/needs?id=${encodeURIComponent(m)}`,{method:"DELETE"}),t(T=>T.filter(y=>y.id!==m)),d().catch(console.error))}o(v,"delNeed");async function g(m){if(m.preventDefault(),!r)return;const T=new FormData(m.currentTarget),y={title:T.get("title"),description:T.get("description")||"",urgency:T.get("urgency")||"",status:T.get("status")||"open",is_public:String(T.get("is_public")||"")==="on"},S=await it(`/api/orgs/${encodeURIComponent(r)}/needs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});S!=null&&S.id?(t(w=>[{id:S.id,...y,created_at:Date.now(),updated_at:Date.now()},...Array.isArray(w)?w:[]]),setTimeout(()=>d().catch(console.error),600)):d().catch(console.error),m.currentTarget.reset()}o(g,"onAdd");const p={width:"100%",minWidth:80,boxSizing:"border-box"};return E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Needs"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(m=>i(m.target.value),"onChange"),placeholder:"Search needs",style:{marginTop:12}}),l&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:l}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:760},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"20%"},children:"Title"}),E.jsx("th",{style:{width:"36%"},children:"Description"}),E.jsx("th",{style:{width:"14%"},children:"Urgency"}),E.jsx("th",{style:{width:"14%"},children:"Status"}),E.jsx("th",{style:{width:"8%"},children:"Public"}),E.jsx("th",{style:{width:"8%"}})]})}),E.jsxs("tbody",{children:[c.map(m=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.title||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.title||"")&&h(m.id,{title:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.description||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.description||"")&&h(m.id,{description:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.urgency||"",style:p,onBlur:o(T=>{const y=T.target.value||"";y!==(m.urgency||"")&&h(m.id,{urgency:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsxs("select",{className:"input",defaultValue:m.status||"open",style:p,onChange:o(T=>h(m.id,{status:T.target.value}).catch(console.error),"onChange"),children:[E.jsx("option",{value:"open",children:"open"}),E.jsx("option",{value:"in-progress",children:"in-progress"}),E.jsx("option",{value:"resolved",children:"resolved"})]})}),E.jsx("td",{style:{textAlign:"center"},children:E.jsx("input",{type:"checkbox",defaultChecked:!!m.is_public,onChange:o(T=>h(m.id,{is_public:T.target.checked}).catch(console.error),"onChange")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(m.id).catch(console.error),"onClick"),children:"Delete"})})]},m.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:6,className:"helper",children:"No needs match."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"title",placeholder:"Title",required:!0}),E.jsx("input",{className:"input",name:"description",placeholder:"Description"}),E.jsx("input",{className:"input",name:"urgency",placeholder:"Urgency (e.g. high)"}),E.jsxs("select",{className:"input",name:"status",defaultValue:"open",children:[E.jsx("option",{value:"open",children:"open"}),E.jsx("option",{value:"in-progress",children:"in-progress"}),E.jsx("option",{value:"resolved",children:"resolved"})]}),E.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx("input",{type:"checkbox",name:"is_public"}),"Public"]}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Need"})]})]})})}o(vM,"Needs");const pM="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function Fu(r,e={}){const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=r.startsWith("http")?r:`${pM}${r.startsWith("/")?"":"/"}${r}`,i={"Content-Type":"application/json",...e.headers||{}};return t&&(i.Authorization=`Bearer ${t}`),fetch(n,{...e,headers:i,body:e.body?JSON.stringify(e.body):void 0}).then(async a=>{const s=await a.json().catch(()=>({}));if(!a.ok||s.ok===!1)throw new Error(s.error||s.message||`HTTP ${a.status}`);return s})}o(Fu,"authFetch");const $_=o(r=>`bf_org_settings_${r}`,"orgSettingsKey"),W_=o((r,e={})=>{try{return JSON.parse(localStorage.getItem(r)||JSON.stringify(e))}catch{return e}},"readJSON$1"),mM=o((r,e)=>localStorage.setItem(r,JSON.stringify(e)),"writeJSON");function gM(){const{orgId:r}=so(),[e,t]=W.useState([]),[n,i]=W.useState(""),[a,s]=W.useState(!1),l=W.useCallback(async()=>{if(r)try{const re=await Fu(`/api/orgs/${encodeURIComponent(r)}/invites`,{method:"GET"});t(Array.isArray(re.invites)?re.invites:[])}catch(re){i(re.message||"Failed to load invites")}},[r]);W.useEffect(()=>{l()},[l]);const u=o(async()=>{if(r){s(!0),i("");try{const re=await Fu(`/api/orgs/${encodeURIComponent(r)}/invites`,{method:"POST",body:{role:"member",expiresInDays:14,maxUses:1}});re!=null&&re.invite?t(Y=>[re.invite,...Y]):await l(),i("Invite created."),setTimeout(()=>i(""),1200)}catch(re){i(re.message||"Failed to create invite")}finally{s(!1)}}},"createInvite"),d=o(async re=>{try{await navigator.clipboard.writeText(re),i("Copied."),setTimeout(()=>i(""),900)}catch{i("Clipboard blocked. Copy it manually.")}},"copyInvite"),[c,h]=W.useState(""),[v,g]=W.useState(null);W.useEffect(()=>{const re=W_($_(r));re.name&&h(re.name),(re.logoDataUrl||re.logoUrl)&&g(re.logoDataUrl||re.logoUrl)},[r]);const p=o(re=>{var me;const Y=(me=re.target.files)==null?void 0:me[0];if(!Y)return;const le=new FileReader;le.onload=()=>g(le.result),le.readAsDataURL(Y)},"onLogo"),m=o(()=>{const re=$_(r),Y=W_(re);mM(re,{...Y,name:(c||"").trim(),logoDataUrl:v}),window.dispatchEvent(new CustomEvent("bf:org_settings_changed",{detail:{orgId:r}})),alert("Organization settings saved.")},"saveBasics"),[T,y]=W.useState(!1),[S,w]=W.useState(""),[C,M]=W.useState(""),[_,O]=W.useState(""),[b,F]=W.useState(""),[V,z]=W.useState(""),[ie,se]=W.useState(""),Pe=o(async()=>{var re;se("");try{const Y=await Fu(`/api/orgs/${encodeURIComponent(r)}/public/generate`,{method:"POST"});w(((re=Y.public)==null?void 0:re.slug)||""),se("Generated new link."),setTimeout(()=>se(""),1200)}catch(Y){se(Y.message)}},"genSlug"),Ce=o(async re=>{var Y,le,me,we,j,Q;re==null||re.preventDefault(),se("");try{const N={enabled:T,slug:(S||"").trim(),title:(C||"").trim(),about:(_||"").trim(),features:(b||"").split(`
`).map(x=>x.trim()).filter(Boolean),links:(V||"").split(`
`).map(x=>{const[A,P]=x.split("|").map(L=>(L||"").trim());return P?{text:A||P,url:P}:null}).filter(Boolean)},D=await Fu(`/api/orgs/${encodeURIComponent(r)}/public/save`,{method:"POST",body:N});w(((Y=D.public)==null?void 0:Y.slug)||N.slug),M(((le=D.public)==null?void 0:le.title)??N.title),O(((me=D.public)==null?void 0:me.about)??N.about),F(Array.isArray((we=D.public)==null?void 0:we.features)?D.public.features.join(`
`):b),z(Array.isArray((j=D.public)==null?void 0:j.links)?D.public.links.map(x=>`${x.text||x.url} | ${x.url}`).join(`
`):V),y(!!((Q=D.public)!=null&&Q.enabled)),se("Saved."),setTimeout(()=>se(""),1200)}catch(N){se(N.message)}},"savePublic"),$e=S?`${location.origin}/#/p/${S}`:"";return E.jsxs("div",{className:"grid",style:{gap:16,padding:16},children:[E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Organization"}),E.jsxs("div",{className:"grid",style:{gap:10},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Name"}),E.jsx("input",{className:"input",value:c,onChange:o(re=>h(re.target.value),"onChange"),placeholder:"Your org name"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Logo"}),E.jsx("input",{className:"input",type:"file",accept:"image/*",onChange:p}),v&&E.jsx("img",{src:v,alt:"Logo preview",style:{width:96,height:96,borderRadius:12,objectFit:"cover",marginTop:8}})]}),E.jsx("div",{children:E.jsx("button",{className:"btn-red",onClick:m,children:"Save"})})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Invites"}),E.jsx("p",{className:"helper",children:"Create a one-time invite code to let someone join this org."}),E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",flexWrap:"wrap"},children:[E.jsx("button",{type:"button",className:"btn-red",onClick:u,disabled:a,title:"Create a new invite code",children:a?"Creating":"Create invite"}),E.jsx("button",{type:"button",className:"btn",onClick:l,children:"Refresh"}),n&&E.jsx("span",{className:n.includes("Failed")?"error":"success",children:n})]}),E.jsx("div",{style:{marginTop:12},children:e.length===0?E.jsx("div",{className:"helper",children:"No invites yet."}):E.jsx("div",{className:"grid",style:{gap:8},children:e.map(re=>{const Y=re.expires_at?new Date(re.expires_at).toLocaleString():"",le=typeof re.uses=="number"?re.uses:0,me=typeof re.max_uses=="number"?re.max_uses:re.maxUses;return E.jsx("div",{className:"card",style:{padding:12,border:"1px solid #222"},children:E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",flexWrap:"wrap"},children:[E.jsx("code",{style:{fontSize:16},children:re.code}),E.jsx("button",{type:"button",className:"btn",onClick:o(()=>d(re.code),"onClick"),children:"Copy"}),E.jsxs("span",{className:"helper",children:["Role: ",re.role||"member","  Uses: ",le,"/",me??"",Y?`  Expires: ${Y}`:""]})]})},re.code)})})})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Public Page"}),E.jsx("p",{className:"helper",children:"Share a readonly page for your org. Only what you enable is shown."}),E.jsxs("form",{onSubmit:Ce,className:"grid",style:{gap:10,marginTop:8},children:[E.jsxs("label",{className:"row",style:{gap:8,alignItems:"center"},children:[E.jsx("input",{type:"checkbox",checked:T,onChange:o(re=>y(re.target.checked),"onChange")}),E.jsx("span",{children:"Enable public page"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Share URL (slug)"}),E.jsxs("div",{className:"row",style:{gap:8},children:[E.jsx("input",{className:"input",style:{flex:1},value:S,onChange:o(re=>w(re.target.value),"onChange"),placeholder:"e.g. bondfire-team"}),E.jsx("button",{type:"button",className:"btn",onClick:Pe,title:"Generate a nice slug",children:"Generate"})]}),S&&E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",marginTop:8},children:[E.jsx("span",{className:"helper",children:"Public link:"}),E.jsx("a",{className:"helper",href:`/#/p/${encodeURIComponent(S)}`,target:"_blank",rel:"noreferrer",children:$e})]})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Title"}),E.jsx("input",{className:"input",value:C,onChange:o(re=>M(re.target.value),"onChange"),placeholder:"Public page title"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"About"}),E.jsx("textarea",{className:"textarea",rows:3,value:_,onChange:o(re=>O(re.target.value),"onChange"),placeholder:"Short description"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Features (one per line)"}),E.jsx("textarea",{className:"textarea",rows:3,value:b,onChange:o(re=>F(re.target.value),"onChange"),placeholder:`Donations tracker
Volunteers
Events`})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Links (Text | URL per line)"}),E.jsx("textarea",{className:"textarea",rows:3,value:V,onChange:o(re=>z(re.target.value),"onChange"),placeholder:`Website | https://example.org
Twitter | https://x.com/yourorg`})]}),E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center"},children:[E.jsx("button",{className:"btn-red",type:"submit",children:"Save"}),ie&&E.jsx("span",{className:ie.includes("Saved")?"success":"error",children:ie})]})]}),T&&E.jsxs("div",{style:{marginTop:16},children:[E.jsx("h3",{style:{margin:"8px 0"},children:"Preview"}),E.jsx(Qd,{data:{public:{title:(C||c||"Public page").trim(),about:(_||"").trim(),features:(b||"").split(`
`).map(re=>re.trim()).filter(Boolean),links:(V||"").split(`
`).map(re=>{const[Y,le]=re.split("|").map(me=>(me||"").trim());return le?{text:Y||le,url:le}:null}).filter(Boolean)}}})]})]})]})}o(gM,"Settings");function K_(r,e,t,n,i,a,s){try{var l=r[a](s),u=l.value}catch(d){return void t(d)}l.done?e(u):Promise.resolve(u).then(n,i)}o(K_,"asyncGeneratorStep");function R(r){return function(){var e=this,t=arguments;return new Promise(function(n,i){var a=r.apply(e,t);function s(u){K_(a,n,i,s,l,"next",u)}o(s,"_next");function l(u){K_(a,n,i,s,l,"throw",u)}o(l,"_throw"),s(void 0)})}}o(R,"_asyncToGenerator");function kl(r){"@babel/helpers - typeof";return kl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},kl(r)}o(kl,"_typeof$b");function yM(r,e){if(kl(r)!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(kl(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}o(yM,"toPrimitive");function SM(r){var e=yM(r,"string");return kl(e)=="symbol"?e:e+""}o(SM,"toPropertyKey");function f(r,e,t){return(e=SM(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(f,"_defineProperty$a");const EM="l",_M="rn",bM={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:EM,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:_M,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var fR=bM;function wM(r){return r.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}o(wM,"escapeRegexp");var TM=RegExp(Object.keys(fR).map(wM).join("|"),"g");function RM(r){return fR[r]}o(RM,"replace_fn");function IM(r){return r.replace(TM,RM)}o(IM,"unhomoglyph");var CM=IM;const OM=th(CM);var _h={exports:{}},vR={};function Ur(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}o(Ur,"RetryOperation");var kM=Ur;Ur.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Ur.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Ur.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Ur.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Ur.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Ur.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Ur.prototype.start=Ur.prototype.try;Ur.prototype.errors=function(){return this._errors};Ur.prototype.attempts=function(){return this._attempts};Ur.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],a=i.message,s=(r[a]||0)+1;r[a]=s,s>=t&&(e=i,t=s)}return e};(function(r){var e=kM;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<n.retries;s++)a.push(this.createTimeout(s,n));return t&&t.forever&&!a.length&&a.push(this.createTimeout(s,n)),a.sort(function(l,u){return l-u}),a},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,a=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return a=Math.min(a,n.maxTimeout),a},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var a in t)typeof t[a]=="function"&&i.push(a)}for(var s=0;s<i.length;s++){var l=i[s],u=t[l];t[l]=o(function(c){var h=r.operation(n),v=Array.prototype.slice.call(arguments,1),g=v.pop();v.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){c.apply(t,v)})},"retryWrapper").bind(t,u),t[l].options=n}}})(vR);var PM=vR;const MM=PM,AM=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Sy=class Sy extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};o(Sy,"AbortError");let Yd=Sy;const xM=o((r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},"decorateErrorWithCounts"),DM=o(r=>AM.includes(r),"isNetworkError"),pR=o((r,e)=>new Promise((t,n)=>{e={onFailedAttempt:o(()=>{},"onFailedAttempt"),retries:10,...e};const i=MM.operation(e);i.attempt(async a=>{try{t(await r(a))}catch(s){if(!(s instanceof Error)){n(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));return}if(s instanceof Yd)i.stop(),n(s.originalError);else if(s instanceof TypeError&&!DM(s.message))i.stop(),n(s);else{xM(s,a,e);try{await e.onFailedAttempt(s)}catch(l){n(l);return}i.retry(s)||n(i.mainError())}}})}),"pRetry");_h.exports=pR;_h.exports.default=pR;var NM=_h.exports.AbortError=Yd,LM=_h.exports;const mR=th(LM);var fs;let iu=(fs=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}},o(fs,"NamespacedValue"),fs);const Ey=class Ey extends iu{constructor(){super(...arguments),f(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}};o(Ey,"ServerControlledNamespacedValue");let Ks=Ey;var vs;let pt=(vs=class extends iu{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}},o(vs,"UnstableValue"),vs);var Vs=function(r){return r.Self="m.self",r.Pin="m.pin",r}({}),au=new pt("m.asset","org.matrix.msc3488.asset"),Ui=new pt("m.ts","org.matrix.msc3488.ts"),su=new pt("m.location","org.matrix.msc3488.location"),Xt=function(r){return r.Read="m.read",r.FullyRead="m.fully_read",r.ReadPrivate="m.read.private",r}({}),ou="main";function V_(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(V_,"ownKeys$o");function q_(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?V_(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):V_(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(q_,"_objectSpread$o");var mf=new Map;function gf(r){return r instanceof String&&(r=r.toString()),mf.has(r)||mf.set(r,r),mf.get(r)}o(gf,"internaliseString");function Wv(r,e){var t=e??new URLSearchParams,n=o(function(l){a!=null&&(Array.isArray(a)?a.forEach(u=>{t.append(l,String(u))}):t.append(l,String(a)))},"_loop");for(var[i,a]of Object.entries(r))n(i);return t}o(Wv,"encodeParams");function G_(r,e,t){var n=q_(q_({},t),{},{[e]:t[r]});return delete n[r],n}o(G_,"replaceParam");function ne(r,e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n!=null&&(r=r.replace(t,encodeURIComponent(n)))}return r}o(ne,"encodeUri");function Xd(r,e,t){var n;if(t){for(n=r.length-1;n>=0;n--)if(e(r[n],n,r))return r.splice(n,1),!0}else for(n=0;n<r.length;n++)if(e(r[n],n,r))return r.splice(n,1),!0;return!1}o(Xd,"removeElement");function gR(r,e){for(var t of e)if(!r.hasOwnProperty(t))throw new Error("Missing required key: "+t)}o(gR,"checkObjectHasKeys");function lu(r){return JSON.parse(JSON.stringify(r))}o(lu,"deepCopy");function qs(r,e){if(r===e)return!0;if(typeof r!=typeof e)return!1;if(typeof r=="number"&&isNaN(r)&&isNaN(e))return!0;if(r===null||e===null)return r===e;if(!(r instanceof Object)||r.constructor!==e.constructor||r.prototype!==e.prototype)return!1;if(r instanceof RegExp||r instanceof Date)return r.toString()===e.toString();if(Array.isArray(r)){if(r.length!==e.length)return!1;for(var t=0;t<r.length;t++)if(!qs(r[t],e[t]))return!1}else{for(var n in e)if(e.hasOwnProperty(n)!==r.hasOwnProperty(n))return!1;for(var i in r)if(e.hasOwnProperty(i)!==r.hasOwnProperty(i)||!qs(r[i],e[i]))return!1}return!0}o(qs,"deepCompare");function Kv(r){if(typeof r!="object"||r==null||Array.isArray(r))return r;var e=[];for(var[t,n]of Object.entries(r))e.push([t,Kv(n)]);return e.sort((i,a)=>dd(i[0],a[0])),e}o(Kv,"deepSortedObjectEntries");function H_(r){return typeof r=="number"&&isFinite(r)}o(H_,"isNumber");function la(r){return typeof r=="string"?OM(r.normalize("NFD").replace(jM,"")):""}o(la,"removeHiddenChars");function Vv(r){return typeof r=="string"?r.replace(/[\u202d-\u202e]/g,""):""}o(Vv,"removeDirectionOverrideChars");function UM(r){return la(r.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}o(UM,"normalize");var jM=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function yR(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}o(yR,"escapeRegExp");function SR(r){return yR(r).replace(/\\\*/g,".*").replace(/\?/g,".")}o(SR,"globToRegexp");function yf(r){return r!=null&&r.endsWith("/")?r.slice(0,-1):r}o(yf,"ensureNoTrailingSlash");function uu(r,e){return new Promise(t=>{setTimeout(t,r,e)})}o(uu,"sleep");function OU(r,e,t){return qv.apply(this,arguments)}o(OU,"logDuration");function qv(){return qv=R(function*(r,e,t){var n=Date.now();try{return yield t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}),qv.apply(this,arguments)}o(qv,"_logDuration");function FM(r,e,t){var n=Date.now();try{return t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}o(FM,"logDurationSync");function ER(r){return r==null}o(ER,"isNullOrUndefined");function Qa(r,e){return Gv.apply(this,arguments)}o(Qa,"promiseMapSeries");function Gv(){return Gv=R(function*(r,e){for(var t of r)yield e(yield t)}),Gv.apply(this,arguments)}o(Gv,"_promiseMapSeries");function ka(r){return Promise.resolve(r())}o(ka,"promiseTry");function BM(r){return mR(e=>r(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}o(BM,"simpleRetryOperation");var Mi=(()=>{for(var r="",e=32;e<=126;e++)r+=String.fromCharCode(e);return r})();function z_(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Mi;return r.padEnd(e,t[0])}o(z_,"alphabetPad");function Pl(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Mi,t=BigInt(e.length);if(r<=t){var n;return(n=e[Number(r)-1])!==null&&n!==void 0?n:""}var i=r/t,a=Number(r%t)-1;return a<0&&(i-=BigInt(Math.abs(a)),a=Number(t)-1),Pl(i,e)+e[a]}o(Pl,"baseToString");function Zd(r){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Mi,t=BigInt(e.length),n=BigInt(0),i=r.length-1,a=BigInt(0);i>=0;i--,a++){var s=r.charCodeAt(i)-e.charCodeAt(0);n+=BigInt(1+s)*t**a}return n}o(Zd,"stringToBase");function $M(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Mi,n=Math.max(r.length,e.length),i=Zd(z_(r,n,t),t),a=Zd(z_(e,n,t),t),s=(i+a)/BigInt(2);return s===i||s==a?Pl(s,t)+t[0]:Pl(s,t)}o($M,"averageBetweenStrings");function Io(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Mi;return Pl(Zd(r,e)+BigInt(1),e)}o(Io,"nextString");function J_(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Mi;return Pl(Zd(r,e)-BigInt(1),e)}o(J_,"prevString");function dd(r,e){return r<e?-1:r>e?1:0}o(dd,"lexicographicCompare");function _R(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[n,i]of Object.entries(e)){if(r[n]instanceof Object&&i){_R(r[n],i);continue}if(i!=null||!t){ec(r,n,i);continue}}return r}o(_R,"recursivelyAssign");function Q_(r){var e;return(e=Ui.findIn(r.getContent()))!==null&&e!==void 0?e:-1}o(Q_,"getContentTimestampWithFallback");function WM(r,e){return Q_(e)-Q_(r)}o(WM,"sortEventsByLatestContentTimestamp");function zg(r){return[Xt.Read,Xt.ReadPrivate].includes(r)}o(zg,"isSupportedReceiptType");function Y_(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,l)=>s===l;if(r.size!==e.size)return!1;for(var[n,i]of r){var a=e.get(n);if(a===void 0||!t(i,a))return!1}return!0}o(Y_,"mapsEqual");function bR(r){return r instanceof Map?na(r):Array.isArray(r)?r.map(e=>bR(e)):r}o(bR,"processMapToObjectValue");function na(r){var e=new Map;for(var[t,n]of r)e.set(t,bR(n));return Object.fromEntries(e.entries())}o(na,"recursiveMapToObject");function el(r){return r==="__proto__"||r==="prototype"||r==="constructor"}o(el,"unsafeProp");function ec(r,e,t){if(el(e))throw new Error("Trying to modify prototype or constructor");r[e]=t}o(ec,"safeSet");function Gr(r){return!(el(r.room_id)||el(r.sender)||el(r.event_id))}o(Gr,"noUnsafeEventProps");const _y=class _y extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}};o(_y,"MapWithDefault");let Jr=_y;var Hv="migrationState",Gs=function(r){return r[r.NOT_STARTED=0]="NOT_STARTED",r[r.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",r[r.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",r[r.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",r[r.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",r[r.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",r}({}),Hs=50;function X_(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(X_,"ownKeys$n");function Z_(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?X_(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):X_(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Z_,"_objectSpread$n");function Bu(r,e){return encodeURIComponent(r)+"/"+encodeURIComponent(e)}o(Bu,"encodeSessionKey");function KM(r){var e=r.split("/"),t=decodeURIComponent(e[0]),n=decodeURIComponent(e[1]);return{senderKey:t,sessionId:n}}o(KM,"decodeSessionKey");const by=class by{constructor(){f(this,"migrationState",Gs.NOT_STARTED),f(this,"account",null),f(this,"crossSigningKeys",null),f(this,"privateKeys",{}),f(this,"sessions",{}),f(this,"inboundGroupSessions",{}),f(this,"inboundGroupSessionsWithheld",{}),f(this,"rooms",{}),f(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return R(function*(){return e.account!==null})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return R(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return R(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){var i=this.privateKeys[n];t(i||null)}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){var n=0;for(var i of Object.values(this.sessions))n+=Object.keys(i).length;t(n)}getEndToEndSession(e,t,n,i){var a=this.sessions[e]||{};i(a[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}storeEndToEndSession(e,t,n,i){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),ec(a,t,n)}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];for(var n of Object.values(e.sessions))for(var i of Object.values(n))if(t.push(i),t.length>=Hs)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t.sessions[n]||{};delete a[i],Object.keys(a).length===0&&delete t.sessions[n]}})()}getEndToEndInboundGroupSession(e,t,n,i){var a=Bu(e,t);i(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,n,i){var a=Bu(e,t);this.inboundGroupSessions[a]=n}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];for(var[n,i]of Object.entries(e.inboundGroupSessions))if(t.push(Z_(Z_({},KM(n)),{},{sessionData:i,needsBackup:n in e.sessionsNeedingBackup})),t.length>=Hs)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:n,sessionId:i}of e){var a=Bu(n,i);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var n=Bu(t.senderKey,t.sessionId);this.sessionsNeedingBackup[n]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}};o(by,"MemoryCryptoStore");let zs=by;var VM=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function qM(r){var e=VM.exec(r);return(e==null?void 0:e[0])===r}o(qM,"validateServerName");var GM=/^[\w-]+$/;function HM(r){var e=GM.exec(r);return(e==null?void 0:e[0])===r}o(HM,"validateMediaId");function bh(r,e,t,n,i){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,s=arguments.length>6?arguments[6]:void 0,l=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[u,d,...c]=e.slice(6).split("/");if(c.length>0||!qM(u)||!HM(d))return"";l&&(s=!0);var h,v=!!t||!!n||!!i,g=v?"thumbnail":"download";l?h="/_matrix/client/v1/media/".concat(g):h="/_matrix/media/v3/".concat(g);var p=new URL("".concat(h,"/").concat(u,"/").concat(d),r);return t&&p.searchParams.set("width",Math.round(t).toString()),n&&p.searchParams.set("height",Math.round(n).toString()),i&&p.searchParams.set("method",i),typeof s=="boolean"&&p.searchParams.set("allow_redirect",JSON.stringify(s)),p.href}o(bh,"getHttpUriForMxc");var wR={exports:{}};(function(r){(function(e,t){r.exports?r.exports=t():e.log=t()})(fC,function(){var e=o(function(){},"noop"),t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],a={},s=null;function l(m,T){var y=m[T];if(typeof y.bind=="function")return y.bind(m);try{return Function.prototype.bind.call(y,m)}catch{return function(){return Function.prototype.apply.apply(y,[m,arguments])}}}o(l,"bindMethod");function u(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}o(u,"traceForIE");function d(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&n?u:console[m]!==void 0?l(console,m):console.log!==void 0?l(console,"log"):e}o(d,"realMethod");function c(){for(var m=this.getLevel(),T=0;T<i.length;T++){var y=i[T];this[y]=T<m?e:this.methodFactory(y,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}o(c,"replaceLoggingMethods");function h(m){return function(){typeof console!==t&&(c.call(this),this[m].apply(this,arguments))}}o(h,"enableLoggingWhenConsoleArrives");function v(m,T,y){return d(m)||h.apply(this,arguments)}o(v,"defaultMethodFactory");function g(m,T){var y=this,S,w,C,M="loglevel";typeof m=="string"?M+=":"+m:typeof m=="symbol"&&(M=void 0);function _(z){var ie=(i[z]||"silent").toUpperCase();if(!(typeof window===t||!M)){try{window.localStorage[M]=ie;return}catch{}try{window.document.cookie=encodeURIComponent(M)+"="+ie+";"}catch{}}}o(_,"persistLevelIfPossible");function O(){var z;if(!(typeof window===t||!M)){try{z=window.localStorage[M]}catch{}if(typeof z===t)try{var ie=window.document.cookie,se=encodeURIComponent(M),Pe=ie.indexOf(se+"=");Pe!==-1&&(z=/^([^;]+)/.exec(ie.slice(Pe+se.length+1))[1])}catch{}return y.levels[z]===void 0&&(z=void 0),z}}o(O,"getPersistedLevel");function b(){if(!(typeof window===t||!M)){try{window.localStorage.removeItem(M)}catch{}try{window.document.cookie=encodeURIComponent(M)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}o(b,"clearPersistedLevel");function F(z){var ie=z;if(typeof ie=="string"&&y.levels[ie.toUpperCase()]!==void 0&&(ie=y.levels[ie.toUpperCase()]),typeof ie=="number"&&ie>=0&&ie<=y.levels.SILENT)return ie;throw new TypeError("log.setLevel() called with invalid level: "+z)}o(F,"normalizeLevel"),y.name=m,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=T||v,y.getLevel=function(){return C??w??S},y.setLevel=function(z,ie){return C=F(z),ie!==!1&&_(C),c.call(y)},y.setDefaultLevel=function(z){w=F(z),O()||y.setLevel(z,!1)},y.resetLevel=function(){C=null,b(),c.call(y)},y.enableAll=function(z){y.setLevel(y.levels.TRACE,z)},y.disableAll=function(z){y.setLevel(y.levels.SILENT,z)},y.rebuild=function(){if(s!==y&&(S=F(s.getLevel())),c.call(y),s===y)for(var z in a)a[z].rebuild()},S=F(s?s.getLevel():"WARN");var V=O();V!=null&&(C=F(V)),c.call(y)}o(g,"Logger"),s=new g,s.getLogger=o(function(T){if(typeof T!="symbol"&&typeof T!="string"||T==="")throw new TypeError("You must supply a name when creating a logger.");var y=a[T];return y||(y=a[T]=new g(T,s.methodFactory)),y},"getLogger");var p=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=p),s},s.getLoggers=o(function(){return a},"getLoggers"),s.default=s,s})})(wR);var zM=wR.exports;const zv=th(zM);var JM="matrix";zv.methodFactory=function(r,e,t){return function(){for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];this.prefix&&i.unshift(this.prefix);var s=r==="error"||r==="warn"||r==="trace"||r==="info"||r==="debug";return s?console[r](...i):console.log(...i)}};function TR(r){var e=JM+(r===void 0?"":"-".concat(r)),t=zv.getLogger(e);return t.getChild===void 0&&(t.prefix=r,t.getChild=n=>{var i=TR((r??"")+n);return i.methodFactory=t.methodFactory,i.rebuild(),i},t.setLevel(zv.levels.DEBUG,!1)),t}o(TR,"getPrefixedLogger");var I=TR();const wy=class wy{constructor(e,t){this.parent=e,f(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.error(this.name,...t)}};o(wy,"LogSpan");let eb=wy;const qc=class qc{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new qc(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];if(i.length===0)t="";else if(i[0]instanceof Error){var s=i.shift();t=s.stack||s.message}else typeof i[0]=="string"?t=i.shift():t="%O";this.debugInstance(e+" "+t,...i)}};o(qc,"DebugLogger");let Jv=qc;var Jg={exports:{}},as=typeof Reflect=="object"?Reflect:null,tb=as&&typeof as.apply=="function"?as.apply:o(function(e,t,n){return Function.prototype.apply.call(e,t,n)},"ReflectApply"),cd;as&&typeof as.ownKeys=="function"?cd=as.ownKeys:Object.getOwnPropertySymbols?cd=o(function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))},"ReflectOwnKeys"):cd=o(function(e){return Object.getOwnPropertyNames(e)},"ReflectOwnKeys");function QM(r){console&&console.warn&&console.warn(r)}o(QM,"ProcessEmitWarning");var RR=Number.isNaN||o(function(e){return e!==e},"NumberIsNaN");function Ke(){Ke.init.call(this)}o(Ke,"EventEmitter");Jg.exports=Ke;Jg.exports.once=eA;Ke.EventEmitter=Ke;Ke.prototype._events=void 0;Ke.prototype._eventsCount=0;Ke.prototype._maxListeners=void 0;var rb=10;function wh(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}o(wh,"checkListener");Object.defineProperty(Ke,"defaultMaxListeners",{enumerable:!0,get:o(function(){return rb},"get"),set:o(function(r){if(typeof r!="number"||r<0||RR(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");rb=r},"set")});Ke.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Ke.prototype.setMaxListeners=o(function(e){if(typeof e!="number"||e<0||RR(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},"setMaxListeners");function IR(r){return r._maxListeners===void 0?Ke.defaultMaxListeners:r._maxListeners}o(IR,"_getMaxListeners");Ke.prototype.getMaxListeners=o(function(){return IR(this)},"getMaxListeners");Ke.prototype.emit=o(function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",a=this._events;if(a!==void 0)i=i&&a.error===void 0;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var l=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw l.context=s,l}var u=a[e];if(u===void 0)return!1;if(typeof u=="function")tb(u,this,t);else for(var d=u.length,c=MR(u,d),n=0;n<d;++n)tb(c[n],this,t);return!0},"emit");function CR(r,e,t,n){var i,a,s;if(wh(t),a=r._events,a===void 0?(a=r._events=Object.create(null),r._eventsCount=0):(a.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),a=r._events),s=a[e]),s===void 0)s=a[e]=t,++r._eventsCount;else if(typeof s=="function"?s=a[e]=n?[t,s]:[s,t]:n?s.unshift(t):s.push(t),i=IR(r),i>0&&s.length>i&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=r,l.type=e,l.count=s.length,QM(l)}return r}o(CR,"_addListener");Ke.prototype.addListener=o(function(e,t){return CR(this,e,t,!1)},"addListener");Ke.prototype.on=Ke.prototype.addListener;Ke.prototype.prependListener=o(function(e,t){return CR(this,e,t,!0)},"prependListener");function YM(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}o(YM,"onceWrapper");function OR(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=YM.bind(n);return i.listener=t,n.wrapFn=i,i}o(OR,"_onceWrap");Ke.prototype.once=o(function(e,t){return wh(t),this.on(e,OR(this,e,t)),this},"once");Ke.prototype.prependOnceListener=o(function(e,t){return wh(t),this.prependListener(e,OR(this,e,t)),this},"prependOnceListener");Ke.prototype.removeListener=o(function(e,t){var n,i,a,s,l;if(wh(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(a=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){l=n[s].listener,a=s;break}if(a<0)return this;a===0?n.shift():XM(n,a),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,l||t)}return this},"removeListener");Ke.prototype.off=Ke.prototype.removeListener;Ke.prototype.removeAllListeners=o(function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var a=Object.keys(n),s;for(i=0;i<a.length;++i)s=a[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},"removeAllListeners");function kR(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?ZM(i):MR(i,i.length)}o(kR,"_listeners");Ke.prototype.listeners=o(function(e){return kR(this,e,!0)},"listeners");Ke.prototype.rawListeners=o(function(e){return kR(this,e,!1)},"rawListeners");Ke.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):PR.call(r,e)};Ke.prototype.listenerCount=PR;function PR(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}o(PR,"listenerCount");Ke.prototype.eventNames=o(function(){return this._eventsCount>0?cd(this._events):[]},"eventNames");function MR(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}o(MR,"arrayClone");function XM(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}o(XM,"spliceOne");function ZM(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}o(ZM,"unwrapListeners");function eA(r,e){return new Promise(function(t,n){function i(s){r.removeListener(e,a),n(s)}o(i,"errorListener");function a(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}o(a,"resolver"),AR(r,e,a,{once:!0}),e!=="error"&&tA(r,i,{once:!0})})}o(eA,"once");function tA(r,e,t){typeof r.on=="function"&&AR(r,"error",e,t)}o(tA,"addErrorHandlerIfEventEmitter");function AR(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,o(function i(a){n.once&&r.removeEventListener(e,i),t(a)},"wrapListener"));else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}o(AR,"eventTargetAgnosticAddListener");var Th=Jg.exports,xR=function(r){return r.NewListener="newListener",r.RemoveListener="removeListener",r.Error="error",r}({});const Ty=class Ty extends Th.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}emitPromised(e){var t=arguments,n=this;return R(function*(){for(var i=t.length,a=new Array(i>1?i-1:0),s=1;s<i;s++)a[s-1]=t[s];var l=n.listeners(e);return Promise.allSettled(l.map(u=>u(...a))).then(()=>l.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}};o(Ty,"TypedEventEmitter");let Ge=Ty;var B=function(r){return r.RoomCanonicalAlias="m.room.canonical_alias",r.RoomCreate="m.room.create",r.RoomJoinRules="m.room.join_rules",r.RoomMember="m.room.member",r.RoomThirdPartyInvite="m.room.third_party_invite",r.RoomPowerLevels="m.room.power_levels",r.RoomName="m.room.name",r.RoomTopic="m.room.topic",r.RoomAvatar="m.room.avatar",r.RoomPinnedEvents="m.room.pinned_events",r.RoomEncryption="m.room.encryption",r.RoomHistoryVisibility="m.room.history_visibility",r.RoomGuestAccess="m.room.guest_access",r.RoomServerAcl="m.room.server_acl",r.RoomTombstone="m.room.tombstone",r.RoomPredecessor="org.matrix.msc3946.room_predecessor",r.PolicyRuleUser="m.policy.rule.user",r.PolicyRuleRoom="m.policy.rule.room",r.PolicyRuleServer="m.policy.rule.server",r.SpaceChild="m.space.child",r.SpaceParent="m.space.parent",r.RoomRedaction="m.room.redaction",r.RoomMessage="m.room.message",r.RoomMessageEncrypted="m.room.encrypted",r.Sticker="m.sticker",r.CallInvite="m.call.invite",r.CallCandidates="m.call.candidates",r.CallAnswer="m.call.answer",r.CallHangup="m.call.hangup",r.CallReject="m.call.reject",r.CallSelectAnswer="m.call.select_answer",r.CallNegotiate="m.call.negotiate",r.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",r.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",r.CallReplaces="m.call.replaces",r.CallAssertedIdentity="m.call.asserted_identity",r.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",r.CallEncryptionKeysPrefix="io.element.call.encryption_keys",r.KeyVerificationRequest="m.key.verification.request",r.KeyVerificationStart="m.key.verification.start",r.KeyVerificationCancel="m.key.verification.cancel",r.KeyVerificationMac="m.key.verification.mac",r.KeyVerificationDone="m.key.verification.done",r.KeyVerificationKey="m.key.verification.key",r.KeyVerificationAccept="m.key.verification.accept",r.KeyVerificationReady="m.key.verification.ready",r.RoomMessageFeedback="m.room.message.feedback",r.Reaction="m.reaction",r.PollStart="org.matrix.msc3381.poll.start",r.Typing="m.typing",r.Receipt="m.receipt",r.Presence="m.presence",r.FullyRead="m.fully_read",r.Tag="m.tag",r.SpaceOrder="org.matrix.msc3230.space_order",r.PushRules="m.push_rules",r.Direct="m.direct",r.IgnoredUserList="m.ignored_user_list",r.RoomKey="m.room_key",r.RoomKeyRequest="m.room_key_request",r.ForwardedRoomKey="m.forwarded_room_key",r.Dummy="m.dummy",r.SecretRequest="m.secret.request",r.SecretSend="m.secret.send",r.GroupCallPrefix="org.matrix.msc3401.call",r.GroupCallMemberPrefix="org.matrix.msc3401.call.member",r.CallNotify="org.matrix.msc4075.call.notify",r.RTCNotification="org.matrix.msc4075.rtc.notification",r}({}),Xe=function(r){return r.Annotation="m.annotation",r.Replace="m.replace",r.Reference="m.reference",r.Thread="m.thread",r.unstable_RTCNotificationParent="org.matrix.msc4075.rtc.notification.parent",r}({}),bn=function(r){return r.Text="m.text",r.Emote="m.emote",r.Notice="m.notice",r.Image="m.image",r.File="m.file",r.Audio="m.audio",r.Location="m.location",r.Video="m.video",r.KeyVerificationRequest="m.key.verification.request",r}({}),tc="type",ss=function(r){return r.Space="m.space",r.UnstableCall="org.matrix.msc3417.call",r.ElementVideo="io.element.video",r}({}),Rh="org.matrix.msgid",Qv=new pt("m.room.purpose","org.matrix.msc3088.purpose"),Yv=new pt("m.enabled","org.matrix.msc3088.enabled"),Xv=new pt("m.data_tree","org.matrix.msc3089.data_tree"),DR=new pt("m.leaf","org.matrix.msc3089.leaf"),Pn=new pt("m.branch","org.matrix.msc3089.branch"),NR=new pt("m.room.marker","org.matrix.msc2716.marker"),Zv=new pt("with_rel_types","org.matrix.msc3912.with_relations"),LR=new pt("io.element.functional_members","io.element.functional_members"),ia=new pt("m.visibility","org.matrix.msc3531.visibility"),ep=new pt("enabled","org.matrix.msc3881.enabled"),rA=new pt("device_id","org.matrix.msc3881.device_id"),UR=new pt("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),rc=new pt("thread_id","org.matrix.msc4023.thread_id"),jR=new iu("membership","io.element.msc4115.membership"),Te=function(r){return r.Ban="ban",r.Invite="invite",r.Join="join",r.Knock="knock",r.Leave="leave",r}({}),ur=function(r){return r.Membership="RoomMember.membership",r.Name="RoomMember.name",r.PowerLevel="RoomMember.powerLevel",r.Typing="RoomMember.typing",r}({});const Ry=class Ry extends Ge{constructor(e,t){super(),this.roomId=e,this.userId=t,f(this,"_isOutOfBand",!1),f(this,"modified",-1),f(this,"requestedProfileInfo",!1),f(this,"typing",!1),f(this,"name",void 0),f(this,"rawDisplayName",void 0),f(this,"powerLevel",0),f(this,"user",void 0),f(this,"membership",void 0),f(this,"disambiguate",!1),f(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,i,a=(n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:"";if(e.getType()===B.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&I.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=aA(this.userId,a,t);var l=this.name;this.name=sA(this.userId,a,this.disambiguate),this.rawDisplayName=Vv((i=e.getDirectionalContent().displayname)!==null&&i!==void 0?i:""),(!this.rawDisplayName||!la(this.rawDisplayName))&&(this.rawDisplayName=this.userId),s!==this.membership&&(this.updateModifiedTime(),this.emit(ur.Membership,e,this,s)),l!==this.name&&(this.updateModifiedTime(),this.emit(ur.Name,e,this,l))}}setPowerLevel(e,t){var n=this.powerLevel;this.powerLevel=e,n!==this.powerLevel&&(this.updateModifiedTime(),this.emit(ur.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;Array.isArray(n)&&(n.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(ur.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Te.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),n=e.getSender();if(t.membership===Te.Join&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),t.membership===Te.Invite&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5?arguments[5]:void 0,l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,u=this.getMxcAvatarUrl();if(!u&&!a)return null;var d=bh(e,u,t,n,i,s,void 0,l);return d||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}};o(Ry,"RoomMember");let ga=Ry;var nA=/@.+:.+/,iA=/[\u200E\u200F\u202A-\u202F]/;function aA(r,e,t){if(!e||e===r||!t)return!1;var n=la(e);if(!n)return!1;if(nA.test(n)||iA.test(e))return!0;var i=t.getUserIdsWithDisplayName(e);return!!i.some(a=>a!==r)}o(aA,"shouldDisambiguate");function sA(r,e,t){return!e||e===r?r:t?Vv(e)+" ("+r+")":la(e)?Vv(e):r}o(sA,"calculateDisplayName");var nr={},Ih={},du={};Object.defineProperty(du,"__esModule",{value:!0});du.NamespacedMap=void 0;function oA(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=lA(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(oA,"_createForOfIteratorHelper$3");function lA(r,e){if(r){if(typeof r=="string")return nb(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return nb(r,e)}}o(lA,"_unsupportedIterableToArray$4");function nb(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(nb,"_arrayLikeToArray$4");function uA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(uA,"_classCallCheck$c");function dA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(dA,"_defineProperties$b");function cA(r,e,t){return e&&dA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(cA,"_createClass$c");function hA(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(hA,"_defineProperty$9");var fA=function(){function r(e){if(uA(this,r),hA(this,"internalMap",new Map),e){var t=oA(e),n;try{for(t.s();!(n=t.n()).done;){var i=n.value;this.set(i[0],i[1])}}catch(a){t.e(a)}finally{t.f()}}}return o(r,"NamespacedMap"),cA(r,[{key:"get",value:o(function(t){return t.name&&this.internalMap.has(t.name)?this.internalMap.get(t.name):t.altName&&this.internalMap.has(t.altName)?this.internalMap.get(t.altName):null},"get")},{key:"set",value:o(function(t,n){t.name&&this.internalMap.set(t.name,n),t.altName&&this.internalMap.set(t.altName,n)},"set")},{key:"has",value:o(function(t){return!!this.get(t)},"has")},{key:"delete",value:o(function(t){t.name&&this.internalMap.delete(t.name),t.altName&&this.internalMap.delete(t.altName)},"_delete")},{key:"hasNamespaced",value:o(function(t){return this.internalMap.has(t)},"hasNamespaced")},{key:"getNamespaced",value:o(function(t){return this.internalMap.get(t)},"getNamespaced")}]),r}();du.NamespacedMap=fA;var zn={};function tp(r){"@babel/helpers - typeof";return tp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tp(r)}o(tp,"_typeof$a");Object.defineProperty(zn,"__esModule",{value:!0});zn.InvalidEventError=void 0;function vA(r,e,t){return Object.defineProperty(r,"prototype",{writable:!1}),r}o(vA,"_createClass$b");function pA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(pA,"_classCallCheck$b");function mA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Ml(r,e)}o(mA,"_inherits$7");function gA(r){var e=FR();return o(function(){var n=Al(r),i;if(e){var a=Al(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return yA(this,i)},"_createSuperInternal")}o(gA,"_createSuper$7");function yA(r,e){if(e&&(tp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return SA(r)}o(yA,"_possibleConstructorReturn$7");function SA(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(SA,"_assertThisInitialized$7");function rp(r){var e=typeof Map=="function"?new Map:void 0;return rp=o(function(n){if(n===null||!EA(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,i)}function i(){return hd(n,arguments,Al(this).constructor)}return o(i,"Wrapper"),i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),Ml(i,n)},"_wrapNativeSuper"),rp(r)}o(rp,"_wrapNativeSuper");function hd(r,e,t){return FR()?hd=Reflect.construct:hd=o(function(i,a,s){var l=[null];l.push.apply(l,a);var u=Function.bind.apply(i,l),d=new u;return s&&Ml(d,s.prototype),d},"_construct"),hd.apply(null,arguments)}o(hd,"_construct");function FR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(FR,"_isNativeReflectConstruct$7");function EA(r){return Function.toString.call(r).indexOf("[native code]")!==-1}o(EA,"_isNativeFunction");function Ml(r,e){return Ml=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),Ml(r,e)}o(Ml,"_setPrototypeOf$7");function Al(r){return Al=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),Al(r)}o(Al,"_getPrototypeOf$7");var _A=function(r){mA(t,r);var e=gA(t);function t(n){return pA(this,t),e.call(this,n)}return o(t,"InvalidEventError"),vA(t)}(rp(Error));zn.InvalidEventError=_A;var oo={},wn={},ji={};Object.defineProperty(ji,"__esModule",{value:!0});ji.ExtensibleEvent=void 0;function bA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(bA,"_classCallCheck$a");function wA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(wA,"_defineProperties$a");function TA(r,e,t){return e&&wA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(TA,"_createClass$a");var RA=function(){function r(e){bA(this,r),this.wireFormat=e}return o(r,"ExtensibleEvent"),TA(r,[{key:"wireContent",get:o(function(){return this.wireFormat.content},"get")}]),r}();ji.ExtensibleEvent=RA;var cu={};Object.defineProperty(cu,"__esModule",{value:!0});cu.isOptionalAString=IA;cu.isProvided=BR;function IA(r){return BR(r)&&typeof r=="string"}o(IA,"isOptionalAString");function BR(r){return r!=null}o(BR,"isProvided$1");var ft={},Zr={};function np(r){"@babel/helpers - typeof";return np=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},np(r)}o(np,"_typeof$9");Object.defineProperty(Zr,"__esModule",{value:!0});Zr.UnstableValue=Zr.NamespacedValue=void 0;function CA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&ip(r,e)}o(CA,"_inherits$6");function ip(r,e){return ip=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),ip(r,e)}o(ip,"_setPrototypeOf$6");function OA(r){var e=MA();return o(function(){var n=nc(r),i;if(e){var a=nc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return kA(this,i)},"_createSuperInternal")}o(OA,"_createSuper$6");function kA(r,e){if(e&&(np(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return PA(r)}o(kA,"_possibleConstructorReturn$6");function PA(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(PA,"_assertThisInitialized$6");function MA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(MA,"_isNativeReflectConstruct$6");function nc(r){return nc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),nc(r)}o(nc,"_getPrototypeOf$6");function $R(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o($R,"_classCallCheck$9");function AA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(AA,"_defineProperties$9");function WR(r,e,t){return e&&AA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(WR,"_createClass$9");var KR=function(){function r(e,t){if($R(this,r),this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return o(r,"NamespacedValue"),WR(r,[{key:"name",get:o(function(){return this.stable?this.stable:this.unstable},"get")},{key:"altName",get:o(function(){return this.stable?this.unstable:null},"get")},{key:"matches",value:o(function(t){return!!this.name&&this.name===t||!!this.altName&&this.altName===t},"matches")},{key:"findIn",value:o(function(t){var n;return this.name&&(n=t==null?void 0:t[this.name]),!n&&this.altName&&(n=t==null?void 0:t[this.altName]),n},"findIn")},{key:"includedIn",value:o(function(t){var n=!1;return this.name&&(n=t.includes(this.name)),!n&&this.altName&&(n=t.includes(this.altName)),n},"includedIn")}]),r}();Zr.NamespacedValue=KR;var xA=function(r){CA(t,r);var e=OA(t);function t(n,i){var a;if($R(this,t),a=e.call(this,n,i),!a.unstable)throw new Error("Unstable value must be supplied");return a}return o(t,"UnstableValue"),WR(t,[{key:"name",get:o(function(){return this.unstable},"get")},{key:"altName",get:o(function(){return this.stable},"get")}]),t}(KR);Zr.UnstableValue=xA;Object.defineProperty(ft,"__esModule",{value:!0});ft.M_TEXT=ft.M_NOTICE=ft.M_MESSAGE=ft.M_HTML=ft.M_EMOTE=void 0;var hu=Zr,DA=new hu.UnstableValue("m.message","org.matrix.msc1767.message");ft.M_MESSAGE=DA;var NA=new hu.UnstableValue("m.text","org.matrix.msc1767.text");ft.M_TEXT=NA;var LA=new hu.UnstableValue("m.html","org.matrix.msc1767.html");ft.M_HTML=LA;var UA=new hu.UnstableValue("m.emote","org.matrix.msc1767.emote");ft.M_EMOTE=UA;var jA=new hu.UnstableValue("m.notice","org.matrix.msc1767.notice");ft.M_NOTICE=jA;var Jn={};Object.defineProperty(Jn,"__esModule",{value:!0});Jn.isEventTypeSame=FA;function FA(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||t.matches(n.altName)}o(FA,"isEventTypeSame$1");function ap(r){"@babel/helpers - typeof";return ap=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ap(r)}o(ap,"_typeof$8");Object.defineProperty(wn,"__esModule",{value:!0});wn.MessageEvent=void 0;var BA=ji,Co=cu,Sf=zn,fr=ft,$A=Jn;function ib(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(ib,"ownKeys$m");function ab(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ib(Object(t),!0).forEach(function(n){ri(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ib(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(ab,"_objectSpread$m");function WA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(WA,"_classCallCheck$8");function sb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(sb,"_defineProperties$8");function KA(r,e,t){return e&&sb(r.prototype,e),t&&sb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(KA,"_createClass$8");function VA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&sp(r,e)}o(VA,"_inherits$5");function sp(r,e){return sp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),sp(r,e)}o(sp,"_setPrototypeOf$5");function qA(r){var e=HA();return o(function(){var n=ic(r),i;if(e){var a=ic(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return GA(this,i)},"_createSuperInternal")}o(qA,"_createSuper$5");function GA(r,e){if(e&&(ap(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return fd(r)}o(GA,"_possibleConstructorReturn$5");function fd(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(fd,"_assertThisInitialized$5");function HA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(HA,"_isNativeReflectConstruct$5");function ic(r){return ic=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ic(r)}o(ic,"_getPrototypeOf$5");function ri(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ri,"_defineProperty$8");var zA=function(r){VA(t,r);var e=qA(t);function t(n){var i;WA(this,t),i=e.call(this,n),ri(fd(i),"text",void 0),ri(fd(i),"html",void 0),ri(fd(i),"renderings",void 0);var a=fr.M_MESSAGE.findIn(i.wireContent),s=fr.M_TEXT.findIn(i.wireContent),l=fr.M_HTML.findIn(i.wireContent);if((0,Co.isProvided)(a)){if(!Array.isArray(a))throw new Sf.InvalidEventError("m.message contents must be an array");var u=a.find(function(c){return!(0,Co.isProvided)(c.mimetype)||c.mimetype==="text/plain"}),d=a.find(function(c){return c.mimetype==="text/html"});if(!u)throw new Sf.InvalidEventError("m.message is missing a plain text representation");i.text=u.body,i.html=d==null?void 0:d.body,i.renderings=a}else if((0,Co.isOptionalAString)(s))i.text=s,i.html=l,i.renderings=[{body:s,mimetype:"text/plain"}],i.html&&i.renderings.push({body:i.html,mimetype:"text/html"});else throw new Sf.InvalidEventError("Missing textual representation for event");return i}return o(t,"MessageEvent"),KA(t,[{key:"isEmote",get:o(function(){return fr.M_EMOTE.matches(this.wireFormat.type)||(0,Co.isProvided)(fr.M_EMOTE.findIn(this.wireFormat.content))},"get")},{key:"isNotice",get:o(function(){return fr.M_NOTICE.matches(this.wireFormat.type)||(0,Co.isProvided)(fr.M_NOTICE.findIn(this.wireFormat.content))},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,$A.isEventTypeSame)(i,fr.M_MESSAGE)},"isEquivalentTo")},{key:"serializeMMessageOnly",value:o(function(){var i=ri({},fr.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var a=this.renderings[0].mimetype;(a===void 0||a==="text/plain")&&(i=ri({},fr.M_TEXT.name,this.renderings[0].body))}return i},"serializeMMessageOnly")},{key:"serialize",value:o(function(){var i;return{type:"m.room.message",content:ab(ab({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(i=this.html)!==null&&i!==void 0?i:void 0})}},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:fr.M_MESSAGE.name,content:(s={},ri(s,fr.M_TEXT.name,i),ri(s,fr.M_HTML.name,a),s)})},"from")}]),t}(BA.ExtensibleEvent);wn.MessageEvent=zA;var lo={};function op(r){"@babel/helpers - typeof";return op=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},op(r)}o(op,"_typeof$7");Object.defineProperty(lo,"__esModule",{value:!0});lo.NoticeEvent=void 0;var JA=wn,$u=ft,QA=Jn;function ob(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ob,"_defineProperty$7");function YA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(YA,"_classCallCheck$7");function lb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(lb,"_defineProperties$7");function XA(r,e,t){return e&&lb(r.prototype,e),t&&lb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(XA,"_createClass$7");function tl(){return typeof Reflect<"u"&&Reflect.get?tl=Reflect.get:tl=o(function(e,t,n){var i=ZA(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},"_get"),tl.apply(this,arguments)}o(tl,"_get$1");function ZA(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=ya(r),r!==null););return r}o(ZA,"_superPropBase$1");function ex(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&lp(r,e)}o(ex,"_inherits$4");function lp(r,e){return lp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),lp(r,e)}o(lp,"_setPrototypeOf$4");function tx(r){var e=ix();return o(function(){var n=ya(r),i;if(e){var a=ya(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return rx(this,i)},"_createSuperInternal")}o(tx,"_createSuper$4");function rx(r,e){if(e&&(op(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return nx(r)}o(rx,"_possibleConstructorReturn$4");function nx(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(nx,"_assertThisInitialized$4");function ix(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(ix,"_isNativeReflectConstruct$4");function ya(r){return ya=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ya(r)}o(ya,"_getPrototypeOf$4");var ax=function(r){ex(t,r);var e=tx(t);function t(n){return YA(this,t),e.call(this,n)}return o(t,"NoticeEvent"),XA(t,[{key:"isNotice",get:o(function(){return!0},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,QA.isEventTypeSame)(i,$u.M_NOTICE)||tl(ya(t.prototype),"isEquivalentTo",this).call(this,i)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i=tl(ya(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.notice",i},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:$u.M_NOTICE.name,content:(s={},ob(s,$u.M_TEXT.name,i),ob(s,$u.M_HTML.name,a),s)})},"from")}]),t}(JA.MessageEvent);lo.NoticeEvent=ax;var uo={};function up(r){"@babel/helpers - typeof";return up=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},up(r)}o(up,"_typeof$6");Object.defineProperty(uo,"__esModule",{value:!0});uo.EmoteEvent=void 0;var sx=wn,Wu=ft,ox=Jn;function ub(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ub,"_defineProperty$6");function lx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(lx,"_classCallCheck$6");function db(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(db,"_defineProperties$6");function ux(r,e,t){return e&&db(r.prototype,e),t&&db(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(ux,"_createClass$6");function rl(){return typeof Reflect<"u"&&Reflect.get?rl=Reflect.get:rl=o(function(e,t,n){var i=dx(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},"_get"),rl.apply(this,arguments)}o(rl,"_get");function dx(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=Sa(r),r!==null););return r}o(dx,"_superPropBase");function cx(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&dp(r,e)}o(cx,"_inherits$3");function dp(r,e){return dp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),dp(r,e)}o(dp,"_setPrototypeOf$3");function hx(r){var e=px();return o(function(){var n=Sa(r),i;if(e){var a=Sa(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return fx(this,i)},"_createSuperInternal")}o(hx,"_createSuper$3");function fx(r,e){if(e&&(up(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return vx(r)}o(fx,"_possibleConstructorReturn$3");function vx(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(vx,"_assertThisInitialized$3");function px(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(px,"_isNativeReflectConstruct$3");function Sa(r){return Sa=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),Sa(r)}o(Sa,"_getPrototypeOf$3");var mx=function(r){cx(t,r);var e=hx(t);function t(n){return lx(this,t),e.call(this,n)}return o(t,"EmoteEvent"),ux(t,[{key:"isEmote",get:o(function(){return!0},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,ox.isEventTypeSame)(i,Wu.M_EMOTE)||rl(Sa(t.prototype),"isEquivalentTo",this).call(this,i)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i=rl(Sa(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.emote",i},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:Wu.M_EMOTE.name,content:(s={},ub(s,Wu.M_TEXT.name,i),ub(s,Wu.M_HTML.name,a),s)})},"from")}]),t}(sx.MessageEvent);uo.EmoteEvent=mx;Object.defineProperty(oo,"__esModule",{value:!0});oo.LEGACY_M_ROOM_MESSAGE=void 0;oo.parseMRoomMessage=_x;var cb=wn,gx=lo,yx=uo,Sx=Zr,Xn=ft;function hb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(hb,"ownKeys$l");function Ir(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hb(Object(t),!0).forEach(function(n){zi(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):hb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Ir,"_objectSpread$l");function zi(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(zi,"_defineProperty$5");var Ex=new Sx.NamespacedValue("m.room.message");oo.LEGACY_M_ROOM_MESSAGE=Ex;function _x(r){var e,t,n;if(Xn.M_MESSAGE.findIn(r.content)||Xn.M_TEXT.findIn(r.content))return new cb.MessageEvent(r);var i=(e=r.content)===null||e===void 0?void 0:e.msgtype,a=(t=r.content)===null||t===void 0?void 0:t.body,s=((n=r.content)===null||n===void 0?void 0:n.format)==="org.matrix.custom.html"?r.content.formatted_body:null;if(i==="m.text"){var l;return new cb.MessageEvent(Ir(Ir({},r),{},{content:Ir(Ir({},r.content),{},(l={},zi(l,Xn.M_TEXT.name,a),zi(l,Xn.M_HTML.name,s),l))}))}else if(i==="m.notice"){var u;return new gx.NoticeEvent(Ir(Ir({},r),{},{content:Ir(Ir({},r.content),{},(u={},zi(u,Xn.M_TEXT.name,a),zi(u,Xn.M_HTML.name,s),u))}))}else if(i==="m.emote"){var d;return new yx.EmoteEvent(Ir(Ir({},r),{},{content:Ir(Ir({},r.content),{},(d={},zi(d,Xn.M_TEXT.name,a),zi(d,Xn.M_HTML.name,s),d))}))}else return null}o(_x,"parseMRoomMessage");var Ch={};Object.defineProperty(Ch,"__esModule",{value:!0});Ch.parseMMessage=Rx;var bx=wn,fb=ft,wx=uo,Tx=lo;function Rx(r){return fb.M_EMOTE.matches(r.type)?new wx.EmoteEvent(r):fb.M_NOTICE.matches(r.type)?new Tx.NoticeEvent(r):new bx.MessageEvent(r)}o(Rx,"parseMMessage");var Ut={};Object.defineProperty(Ut,"__esModule",{value:!0});Ut.M_POLL_START=Ut.M_POLL_RESPONSE=Ut.M_POLL_KIND_UNDISCLOSED=Ut.M_POLL_KIND_DISCLOSED=Ut.M_POLL_END=void 0;var fu=Zr,Ix=new fu.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");Ut.M_POLL_KIND_DISCLOSED=Ix;var Cx=new fu.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");Ut.M_POLL_KIND_UNDISCLOSED=Cx;var Ox=new fu.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");Ut.M_POLL_START=Ox;var kx=new fu.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");Ut.M_POLL_RESPONSE=kx;var Px=new fu.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");Ut.M_POLL_END=Px;var Oh={},Ea={};function cp(r){"@babel/helpers - typeof";return cp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},cp(r)}o(cp,"_typeof$5");Object.defineProperty(Ea,"__esModule",{value:!0});Ea.PollStartEvent=Ea.PollAnswerSubevent=void 0;var Tn=Ut,VR=wn,Wo=ft,vd=zn,Mx=Zr,Ax=Jn,xx=ji;function Dx(r){return jx(r)||Ux(r)||Lx(r)||Nx()}o(Dx,"_toConsumableArray");function Nx(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}o(Nx,"_nonIterableSpread");function Lx(r,e){if(r){if(typeof r=="string")return hp(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return hp(r,e)}}o(Lx,"_unsupportedIterableToArray$3");function Ux(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}o(Ux,"_iterableToArray");function jx(r){if(Array.isArray(r))return hp(r)}o(jx,"_arrayWithoutHoles");function hp(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(hp,"_arrayLikeToArray$3");function vb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(vb,"ownKeys$k");function Fx(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?vb(Object(t),!0).forEach(function(n){ar(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):vb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Fx,"_objectSpread$k");function qR(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(qR,"_classCallCheck$5");function pb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(pb,"_defineProperties$5");function GR(r,e,t){return e&&pb(r.prototype,e),t&&pb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(GR,"_createClass$5");function HR(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&fp(r,e)}o(HR,"_inherits$2");function fp(r,e){return fp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),fp(r,e)}o(fp,"_setPrototypeOf$2");function zR(r){var e=$x();return o(function(){var n=ac(r),i;if(e){var a=ac(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Bx(this,i)},"_createSuperInternal")}o(zR,"_createSuper$2");function Bx(r,e){if(e&&(cp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Xi(r)}o(Bx,"_possibleConstructorReturn$2");function Xi(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(Xi,"_assertThisInitialized$2");function $x(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o($x,"_isNativeReflectConstruct$2");function ac(r){return ac=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ac(r)}o(ac,"_getPrototypeOf$2");function ar(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ar,"_defineProperty$4");var JR=function(r){HR(t,r);var e=zR(t);function t(n){var i;qR(this,t),i=e.call(this,n),ar(Xi(i),"id",void 0);var a=n.content.id;if(!a||typeof a!="string")throw new vd.InvalidEventError("Answer ID must be a non-empty string");return i.id=a,i}return o(t,"PollAnswerSubevent"),GR(t,[{key:"serialize",value:o(function(){return{type:"org.matrix.sdk.poll.answer",content:Fx({id:this.id},this.serializeMMessageOnly())}},"serialize")}],[{key:"from",value:o(function(i,a){return new t({type:"org.matrix.sdk.poll.answer",content:ar({id:i},Wo.M_TEXT.name,a)})},"from")}]),t}(VR.MessageEvent);Ea.PollAnswerSubevent=JR;var Wx=function(r){HR(t,r);var e=zR(t);function t(n){var i;qR(this,t),i=e.call(this,n),ar(Xi(i),"question",void 0),ar(Xi(i),"kind",void 0),ar(Xi(i),"rawKind",void 0),ar(Xi(i),"maxSelections",void 0),ar(Xi(i),"answers",void 0);var a=Tn.M_POLL_START.findIn(i.wireContent);if(!a.question)throw new vd.InvalidEventError("A question is required");if(i.question=new VR.MessageEvent({type:"org.matrix.sdk.poll.question",content:a.question}),i.rawKind=a.kind,Tn.M_POLL_KIND_DISCLOSED.matches(i.rawKind)?i.kind=Tn.M_POLL_KIND_DISCLOSED:i.kind=Tn.M_POLL_KIND_UNDISCLOSED,i.maxSelections=Number.isFinite(a.max_selections)&&a.max_selections>0?a.max_selections:1,!Array.isArray(a.answers))throw new vd.InvalidEventError("Poll answers must be an array");var s=a.answers.slice(0,20).map(function(l){return new JR({type:"org.matrix.sdk.poll.answer",content:l})});if(s.length<=0)throw new vd.InvalidEventError("No answers available");return i.answers=s,i}return o(t,"PollStartEvent"),GR(t,[{key:"isEquivalentTo",value:o(function(i){return(0,Ax.isEventTypeSame)(i,Tn.M_POLL_START)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i;return{type:Tn.M_POLL_START.name,content:(i={},ar(i,Tn.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(a){return a.serialize().content})}),ar(i,Wo.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(a,s){return"".concat(s+1,". ").concat(a.text)}).join(`
`))),i)}},"serialize")}],[{key:"from",value:o(function(i,a,s){var l,u=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new t({type:Tn.M_POLL_START.name,content:(l={},ar(l,Wo.M_TEXT.name,i),ar(l,Tn.M_POLL_START.name,{question:ar({},Wo.M_TEXT.name,i),kind:s instanceof Mx.NamespacedValue?s.name:s,max_selections:u,answers:a.map(function(d){return ar({id:Kx()},Wo.M_TEXT.name,d)})}),l)})},"from")}]),t}(xx.ExtensibleEvent);Ea.PollStartEvent=Wx;var mb="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Kx(){return Dx(Array(16)).map(function(){return mb.charAt(Math.floor(Math.random()*mb.length))}).join("")}o(Kx,"makeId");var vu={},co={};Object.defineProperty(co,"__esModule",{value:!0});co.REFERENCE_RELATION=void 0;var Vx=Zr,qx=new Vx.NamespacedValue("m.reference");co.REFERENCE_RELATION=qx;function vp(r){"@babel/helpers - typeof";return vp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},vp(r)}o(vp,"_typeof$4");Object.defineProperty(vu,"__esModule",{value:!0});vu.PollResponseEvent=void 0;var Gx=ji,Pa=Ut,Hx=zn,Ef=co,zx=Jn;function Jx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(Jx,"_classCallCheck$4");function gb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(gb,"_defineProperties$4");function Qx(r,e,t){return e&&gb(r.prototype,e),t&&gb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(Qx,"_createClass$4");function Yx(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&pp(r,e)}o(Yx,"_inherits$1");function pp(r,e){return pp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),pp(r,e)}o(pp,"_setPrototypeOf$1");function Xx(r){var e=eD();return o(function(){var n=sc(r),i;if(e){var a=sc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Zx(this,i)},"_createSuperInternal")}o(Xx,"_createSuper$1");function Zx(r,e){if(e&&(vp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return pd(r)}o(Zx,"_possibleConstructorReturn$1");function pd(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(pd,"_assertThisInitialized$1");function eD(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(eD,"_isNativeReflectConstruct$1");function sc(r){return sc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),sc(r)}o(sc,"_getPrototypeOf$1");function Oo(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(Oo,"_defineProperty$3");var tD=function(r){Yx(t,r);var e=Xx(t);function t(n){var i;Jx(this,t),i=e.call(this,n),Oo(pd(i),"internalAnswerIds",void 0),Oo(pd(i),"internalSpoiled",void 0),Oo(pd(i),"pollEventId",void 0);var a=i.wireContent["m.relates_to"];if(!Ef.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new Hx.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.validateAgainst(null),i}return o(t,"PollResponseEvent"),Qx(t,[{key:"answerIds",get:o(function(){return this.internalAnswerIds},"get")},{key:"spoiled",get:o(function(){return this.internalSpoiled},"get")},{key:"validateAgainst",value:o(function(i){var a=Pa.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(a==null?void 0:a.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var s=a.answers;if(s.some(function(l){return typeof l!="string"})||s.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(i){if(s.some(function(l){return!i.answers.some(function(u){return u.id===l})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}s=s.slice(0,i.maxSelections)}this.internalAnswerIds=s,this.internalSpoiled=!1},"validateAgainst")},{key:"isEquivalentTo",value:o(function(i){return(0,zx.isEventTypeSame)(i,Pa.M_POLL_RESPONSE)},"isEquivalentTo")},{key:"serialize",value:o(function(){return{type:Pa.M_POLL_RESPONSE.name,content:Oo({"m.relates_to":{rel_type:Ef.REFERENCE_RELATION.name,event_id:this.pollEventId}},Pa.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}},"serialize")}],[{key:"from",value:o(function(i,a){return new t({type:Pa.M_POLL_RESPONSE.name,content:Oo({"m.relates_to":{rel_type:Ef.REFERENCE_RELATION.name,event_id:a}},Pa.M_POLL_RESPONSE.name,{answers:i})})},"from")}]),t}(Gx.ExtensibleEvent);vu.PollResponseEvent=tD;var pu={};function mp(r){"@babel/helpers - typeof";return mp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},mp(r)}o(mp,"_typeof$3");Object.defineProperty(pu,"__esModule",{value:!0});pu.PollEndEvent=void 0;var ko=Ut,rD=zn,_f=co,nD=wn,iD=ft,aD=Jn,sD=ji;function yb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(yb,"ownKeys$j");function oD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?yb(Object(t),!0).forEach(function(n){La(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):yb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(oD,"_objectSpread$j");function lD(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(lD,"_classCallCheck$3");function Sb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(Sb,"_defineProperties$3");function uD(r,e,t){return e&&Sb(r.prototype,e),t&&Sb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(uD,"_createClass$3");function dD(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&gp(r,e)}o(dD,"_inherits");function gp(r,e){return gp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),gp(r,e)}o(gp,"_setPrototypeOf");function cD(r){var e=fD();return o(function(){var n=oc(r),i;if(e){var a=oc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return hD(this,i)},"_createSuperInternal")}o(cD,"_createSuper");function hD(r,e){if(e&&(mp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return yp(r)}o(hD,"_possibleConstructorReturn");function yp(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(yp,"_assertThisInitialized");function fD(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(fD,"_isNativeReflectConstruct");function oc(r){return oc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),oc(r)}o(oc,"_getPrototypeOf");function La(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(La,"_defineProperty$2");var vD=function(r){dD(t,r);var e=cD(t);function t(n){var i;lD(this,t),i=e.call(this,n),La(yp(i),"pollEventId",void 0),La(yp(i),"closingMessage",void 0);var a=i.wireContent["m.relates_to"];if(!_f.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new rD.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.closingMessage=new nD.MessageEvent(i.wireFormat),i}return o(t,"PollEndEvent"),uD(t,[{key:"isEquivalentTo",value:o(function(i){return(0,aD.isEventTypeSame)(i,ko.M_POLL_END)},"isEquivalentTo")},{key:"serialize",value:o(function(){return{type:ko.M_POLL_END.name,content:oD(La({"m.relates_to":{rel_type:_f.REFERENCE_RELATION.name,event_id:this.pollEventId}},ko.M_POLL_END.name,{}),this.closingMessage.serialize().content)}},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:ko.M_POLL_END.name,content:(s={"m.relates_to":{rel_type:_f.REFERENCE_RELATION.name,event_id:i}},La(s,ko.M_POLL_END.name,{}),La(s,iD.M_TEXT.name,a),s)})},"from")}]),t}(sD.ExtensibleEvent);pu.PollEndEvent=vD;Object.defineProperty(Oh,"__esModule",{value:!0});Oh.parseMPoll=yD;var bf=Ut,pD=Ea,mD=vu,gD=pu;function yD(r){return bf.M_POLL_START.matches(r.type)?new pD.PollStartEvent(r):bf.M_POLL_RESPONSE.matches(r.type)?new mD.PollResponseEvent(r):bf.M_POLL_END.matches(r.type)?new gD.PollEndEvent(r):null}o(yD,"parseMPoll");Object.defineProperty(Ih,"__esModule",{value:!0});Ih.ExtensibleEvents=void 0;var SD=du,ED=zn,Eb=oo,wf=Ch,Ku=ft,Tf=Ut,Rf=Oh;function _D(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=bD(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(_D,"_createForOfIteratorHelper$2");function bD(r,e){if(r){if(typeof r=="string")return _b(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return _b(r,e)}}o(bD,"_unsupportedIterableToArray$2");function _b(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(_b,"_arrayLikeToArray$2");function wD(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(wD,"_classCallCheck$2");function bb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(bb,"_defineProperties$2");function TD(r,e,t){return e&&bb(r.prototype,e),t&&bb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(TD,"_createClass$2");function Sp(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(Sp,"_defineProperty$1");var Ep=function(){function r(){wD(this,r),Sp(this,"interpreters",new SD.NamespacedMap([[Eb.LEGACY_M_ROOM_MESSAGE,Eb.parseMRoomMessage],[Ku.M_MESSAGE,wf.parseMMessage],[Ku.M_EMOTE,wf.parseMMessage],[Ku.M_NOTICE,wf.parseMMessage],[Tf.M_POLL_START,Rf.parseMPoll],[Tf.M_POLL_RESPONSE,Rf.parseMPoll],[Tf.M_POLL_END,Rf.parseMPoll]])),Sp(this,"_unknownInterpretOrder",[Ku.M_MESSAGE])}return o(r,"ExtensibleEvents"),TD(r,[{key:"unknownInterpretOrder",get:o(function(){var t;return(t=this._unknownInterpretOrder)!==null&&t!==void 0?t:[]},"get"),set:o(function(t){this._unknownInterpretOrder=t},"set")},{key:"registerInterpreter",value:o(function(t,n){this.interpreters.set(t,n)},"registerInterpreter")},{key:"parse",value:o(function(t){try{if(this.interpreters.hasNamespaced(t.type))return this.interpreters.getNamespaced(t.type)(t);var n=_D(this.unknownInterpretOrder),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;if(this.interpreters.has(a)){var s=this.interpreters.get(a)(t);if(s)return s}}}catch(l){n.e(l)}finally{n.f()}return null}catch(l){if(l instanceof ED.InvalidEventError)return null;throw l}},"parse")}],[{key:"defaultInstance",get:o(function(){return r._defaultInstance},"get")},{key:"unknownInterpretOrder",get:o(function(){return r.defaultInstance.unknownInterpretOrder},"get"),set:o(function(t){r.defaultInstance.unknownInterpretOrder=t},"set")},{key:"registerInterpreter",value:o(function(t,n){r.defaultInstance.registerInterpreter(t,n)},"registerInterpreter")},{key:"parse",value:o(function(t){return r.defaultInstance.parse(t)},"parse")}]),r}();Ih.ExtensibleEvents=Ep;Sp(Ep,"_defaultInstance",new Ep);var QR={};Object.defineProperty(QR,"__esModule",{value:!0});var ho={};Object.defineProperty(ho,"__esModule",{value:!0});ho.LegacyMsgType=void 0;ho.isEventLike=RD;var If=ft,os;ho.LegacyMsgType=os;(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(os||(ho.LegacyMsgType=os={}));function RD(r,e){var t=r.content;return e===os.Text?If.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.text":e===os.Emote?If.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.emote":e===os.Notice?If.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.notice":!1}o(RD,"isEventLike");(function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=Ih;Object.keys(e).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===e[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return e[_]},"get")})});var t=QR;Object.keys(t).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===t[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return t[_]},"get")})});var n=zn;Object.keys(n).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===n[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return n[_]},"get")})});var i=Zr;Object.keys(i).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===i[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return i[_]},"get")})});var a=du;Object.keys(a).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===a[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return a[_]},"get")})});var s=cu;Object.keys(s).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===s[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return s[_]},"get")})});var l=ho;Object.keys(l).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===l[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return l[_]},"get")})});var u=Jn;Object.keys(u).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===u[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return u[_]},"get")})});var d=oo;Object.keys(d).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===d[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return d[_]},"get")})});var c=Ch;Object.keys(c).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===c[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return c[_]},"get")})});var h=Oh;Object.keys(h).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===h[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return h[_]},"get")})});var v=co;Object.keys(v).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===v[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return v[_]},"get")})});var g=ji;Object.keys(g).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===g[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return g[_]},"get")})});var p=ft;Object.keys(p).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===p[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return p[_]},"get")})});var m=wn;Object.keys(m).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===m[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return m[_]},"get")})});var T=uo;Object.keys(T).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===T[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return T[_]},"get")})});var y=lo;Object.keys(y).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===y[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return y[_]},"get")})});var S=Ut;Object.keys(S).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===S[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return S[_]},"get")})});var w=Ea;Object.keys(w).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===w[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return w[_]},"get")})});var C=vu;Object.keys(C).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===C[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return C[_]},"get")})});var M=pu;Object.keys(M).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===M[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return M[_]},"get")})})})(nr);const ID="modulepreload",CD=o(function(r){return"/"+r},"assetsURL"),wb={},OD=o(function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=Promise.allSettled(t.map(u=>{if(u=CD(u),u in wb)return;wb[u]=!0;const d=u.endsWith(".css"),c=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${c}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":ID,d||(h.as="script"),h.crossOrigin="",h.href=u,l&&h.setAttribute("nonce",l),document.head.appendChild(h),d)return new Promise((v,g)=>{h.addEventListener("load",v),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function a(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return o(a,"handlePreloadError"),i.then(s=>{for(const l of s||[])l.status==="rejected"&&a(l.reason);return e().catch(a)})},"preload");function kD(r,e){if(r==null)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.indexOf(n)!==-1)continue;t[n]=r[n]}return t}o(kD,"_objectWithoutPropertiesLoose");function PD(r,e){if(r==null)return{};var t,n,i=kD(r,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);for(n=0;n<a.length;n++)t=a[n],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(r,t)&&(i[t]=r[t])}return i}o(PD,"_objectWithoutProperties");var yr=function(r){return r.DisplayName="User.displayName",r.AvatarUrl="User.avatarUrl",r.Presence="User.presence",r.CurrentlyActive="User.currentlyActive",r.LastPresenceTs="User.lastPresenceTs",r}({});const Gc=class Gc extends Ge{constructor(e){super(),this.userId=e,f(this,"modified",-1),f(this,"displayName",void 0),f(this,"rawDisplayName",void 0),f(this,"avatarUrl",void 0),f(this,"presenceStatusMsg",void 0),f(this,"presence","offline"),f(this,"lastActiveAgo",0),f(this,"lastPresenceTs",0),f(this,"currentlyActive",!1),f(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var n=new Gc(e);return t.reEmitter.reEmit(n,[yr.AvatarUrl,yr.DisplayName,yr.Presence,yr.CurrentlyActive,yr.LastPresenceTs]),n}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push(yr.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(yr.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(yr.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&n.push(yr.CurrentlyActive),this.presence=e.getContent().presence,n.push(yr.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var i of n)this.emit(i,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}};o(Gc,"User");let Fn=Gc;var Ie=function(r){return r.Backward="b",r.Forward="f",r}({});const zt=class zt{static setEventMetadata(e,t,n){e.setMetadata(t,n)}constructor(e){var t,n;this.eventTimelineSet=e,f(this,"roomId",void 0),f(this,"name",void 0),f(this,"events",[]),f(this,"baseIndex",0),f(this,"startState",void 0),f(this,"endState",void 0),f(this,"startToken",null),f(this,"endToken",null),f(this,"prevTimeline",null),f(this,"nextTimeline",null),f(this,"paginationRequests",{[Ie.Backward]:null,[Ie.Forward]:null}),this.roomId=(t=(n=e.room)===null||n===void 0?void 0:n.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new zl(this.roomId),this.endState=new zl(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,n,{timelineWasEmpty:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:i}),(n=this.endState)===null||n===void 0||n.setStateEvents(e,{timelineWasEmpty:i})}forkLive(e){var t=this.getState(e),n=new zt(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t,this.endState=t==null?void 0:t.clone(),n}fork(e){var t=this.getState(e),n=new zt(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t==null?void 0:t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==zt.BACKWARDS)return this.startState;if(e==zt.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===Ie.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===Ie.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==zt.BACKWARDS)return this.prevTimeline;if(e==zt.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==zt.BACKWARDS)this.prevTimeline=e;else if(t==zt.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:n,roomState:i,timelineWasEmpty:a,addToState:s}=t;i||(i=n?this.startState:this.endState);var l=this.getTimelineSet();if(l.room&&(zt.setEventMetadata(e,i,n),s&&e.isState()&&l.room.getUnfilteredTimelineSet()===l)){var u;(u=i)===null||u===void 0||u.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===B.RoomMember&&!n)&&zt.setEventMetadata(e,i,n)}var d;n?d=0:d=this.events.length,this.events.splice(d,0,e),n&&this.baseIndex++}insertEvent(e,t,n,i){var a=this.getTimelineSet();a.room&&(zt.setEventMetadata(e,n,!1),i&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(n.setStateEvents([e],{}),(!e.sender||e.getType()===B.RoomMember)&&zt.setEventMetadata(e,n,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}};o(zt,"EventTimeline");let he=zt;f(he,"BACKWARDS",Ie.Backward);f(he,"FORWARDS",Ie.Forward);var md=function(r){return r.Add="Relations.add",r.Remove="Relations.remove",r.Redaction="Relations.redaction",r}({}),MD=o(function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...n].includes(e)},"matchesEventType");const Iy=class Iy extends Ge{constructor(e,t,n,i){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=i,f(this,"relationEventIds",new Set),f(this,"relations",new Set),f(this,"annotationsByKey",{}),f(this,"annotationsBySender",{}),f(this,"sortedAnnotationsByKey",[]),f(this,"targetEvent",null),f(this,"creationEmitted",!1),f(this,"client",void 0),f(this,"onEventStatus",(s,l)=>{if(!s.isSending()){s.removeListener(Le.Status,this.onEventStatus);return}l===Se.CANCELLED&&(s.removeListener(Le.Status,this.onEventStatus),this.removeEvent(s))}),f(this,"onBeforeRedaction",function(){var s=R(function*(l){if(a.relations.has(l)){if(a.relations.delete(l),a.relationType===Xe.Annotation)a.removeAnnotationFromAggregation(l);else if(a.relationType===Xe.Replace&&a.targetEvent&&!a.targetEvent.isState()){var u=yield a.getLastReplacement();a.targetEvent.makeReplaced(u)}l.removeListener(Le.BeforeRedaction,a.onBeforeRedaction),a.emit(md.Redaction,l)}});return function(l){return s.apply(this,arguments)}}()),this.client=n instanceof Js?n.client:n}addEvent(e){var t=this;return R(function*(){if(!t.relationEventIds.has(e.getId())){var n=e.getRelation();if(!n){I.error("Event must have relation info");return}var i=n.rel_type,a=e.getType();if(t.relationType!==i||!MD(a,t.eventType,t.altEventTypes)){I.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(Le.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Xe.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Xe.Replace&&t.targetEvent&&!t.targetEvent.isState()){var s=yield t.getLastReplacement();t.targetEvent.makeReplaced(s)}e.on(Le.BeforeRedaction,t.onBeforeRedaction),t.emit(md.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return R(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Xe.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Xe.Replace&&t.targetEvent&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();t.targetEvent.makeReplaced(n)}t.emit(md.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i||(i=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,i])),i.add(e),this.sortedAnnotationsByKey.sort((l,u)=>{var d=l[1],c=u[1];return c.size-d.size});var a=e.getSender(),s=this.annotationsBySender[a];s||(s=this.annotationsBySender[a]=new Set),s.add(e)}}removeAnnotationFromAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i&&(i.delete(e),this.sortedAnnotationsByKey.sort((l,u)=>{var d=l[1],c=u[1];return c.size-d.size}));var a=e.getSender(),s=this.annotationsBySender[a];s&&s.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Xe.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Xe.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return R(function*(){if(e.relationType!==Xe.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Xe.Replace),n=t==null?void 0:t.origin_server_ts,i=e.getRelations().reduce((a,s)=>s.getSender()!==e.targetEvent.getSender()||n&&n>s.getTs()||a&&a.getTs()>s.getTs()?a:s,null);return i!=null&&i.shouldAttemptDecryption()&&e.client.getCrypto()?yield i.attemptDecryption(e.client.getCrypto()):i!=null&&i.isBeingDecrypted()&&(yield i.getDecryptionPromise()),i})()}setTargetEvent(e){var t=this;return R(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Xe.Replace&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();n&&t.targetEvent.makeReplaced(n)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(Le.RelationsCreated,this.relationType,this.eventType))}};o(Iy,"Relations");let xl=Iy;const Cy=class Cy{constructor(e,t){this.client=e,this.room=t,f(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var i;return(i=this.relations.get(e))===null||i===void 0||(i=i.get(t))===null||i===void 0?void 0:i.get(n)}getAllChildEventsForEvent(e){var t,n=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,i=[];for(var a of n.values())for(var s of a.values())i.push(...s.getRelations());return i}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var n of t.values())for(var i of n.values())i.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===Se.CANCELLED)){var n=e.getRelation();if(n){var i=o(()=>{if(e.isDecryptionFailure()){e.once(Le.Decrypted,i);return}this.aggregateChildEvent(e,t)},"onEventDecrypted");if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(Le.Decrypted,i);return}var{event_id:a,rel_type:s}=n,l=e.getType(),u=this.relations.get(a);u||(u=new Map,this.relations.set(a,u));var d=u.get(s);d||(d=new Map,u.set(s,d));var c=d.get(l);if(!c){var h,v,g;c=new xl(s,l,this.client),d.set(l,c);var p=(h=this.room)!==null&&h!==void 0?h:t==null?void 0:t.room,m=(v=(g=t==null?void 0:t.findEventById(a))!==null&&g!==void 0?g:p==null?void 0:p.findEventById(a))!==null&&v!==void 0?v:p==null?void 0:p.getPendingEvent(a);m&&c.setTargetEvent(m)}c.addEvent(e)}}}};o(Cy,"RelationsContainer");let lc=Cy;var Ua;Ua=I.log.bind(I);var nl=function(r){return r.Ignore="ignore",r.Replace="replace",r}({});const Oy=class Oy extends Ge{constructor(e){var t,n,i,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,l=arguments.length>3?arguments[3]:void 0,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=l,this.threadListType=u,f(this,"relations",void 0),f(this,"timelineSupport",void 0),f(this,"displayPendingEvents",void 0),f(this,"liveTimeline",void 0),f(this,"timelines",void 0),f(this,"_eventIdToTimeline",new Map),f(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new he(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(n=this.room)===null||n===void 0?void 0:n.relations)!==null&&t!==void 0?t:new lc((i=e==null?void 0:e.client)!==null&&i!==void 0?i:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){var n=!this.timelineSupport||!t,i=this.liveTimeline,a=n?i.forkLive(he.FORWARDS):i.fork(he.FORWARDS);n?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&i.setPaginationToken(t,he.FORWARDS),a.setPaginationToken(e??null,he.BACKWARDS),this.liveTimeline=a,this.emit(ue.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(n){return n.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new he(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i,a){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?he.BACKWARDS:he.FORWARDS,l=t?he.FORWARDS:he.BACKWARDS,u=!1,d=!1;for(var c of e){var h=c.getId(),v=this._eventIdToTimeline.get(h);if(!v){this.addEventToTimeline(c,i,{toStartOfTimeline:t,addToState:n}),d=!0,u=!0;continue}if(d=!1,v==i){Ua("Event "+h+" already in timeline "+i);continue}var g=i.getNeighbouringTimeline(s);if(g){v==g?Ua("Event "+h+" in neighbouring timeline - switching to "+v):Ua("Event "+h+" already in a different timeline "+v),i=v;continue}I.info("Already have timeline for "+h+" - joining timeline "+i+" to "+v);var p=v===this.liveTimeline,m=i===this.liveTimeline,T=s===he.BACKWARDS&&p,y=s===he.FORWARDS&&m;if(T||y){T&&I.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+v+")"),y&&I.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(v,s),v.setNeighbouringTimeline(i,l),i=v,u=!0}if(d||!u){if(s===he.FORWARDS&&i===this.liveTimeline){I.warn({lastEventWasNew:d,didUpdate:u}),I.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(a));return}i.setPaginationToken(a??null,s)}}}addLiveEvent(e,t){var{duplicateStrategy:n,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l}=t;if(this.filter){var u=this.filter.filterRoomTimeline([e]);if(!u.length)return}var d=this._eventIdToTimeline.get(e.getId());if(d){if(n===nl.Replace){Ua("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var c=d.getEvents(),h=0;h<c.length;h++)if(c[h].getId()===e.getId()){a||(a=d.getState(he.FORWARDS)),he.setEventMetadata(e,a,!1),c[h]=e;break}}else Ua("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l})}addEventToTimeline(e,t,n){var{toStartOfTimeline:i,fromCache:a=!1,roomState:s,timelineWasEmpty:l,addToState:u}=n;if(t.getTimelineSet()!==this){var d;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((d=this.thread)===null||d===void 0?void 0:d.id,")"))}var c=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,v="event=".concat(c);e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),I.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((h=this.thread)===null||h===void 0?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:i,roomState:s,timelineWasEmpty:l,addToState:u}),this._eventIdToTimeline.set(c,t);var g={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!a};this.emit(ue.Timeline,e,this.room,!!i,!1,g)}insertEventIntoTimeline(e,t,n,i){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var l,u="event=".concat(s);e.threadRootId&&(u+="(belongs to thread=".concat(e.threadRootId,")")),I.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(u," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((l=this.thread)===null||l===void 0?void 0:l.id,")"));return}var d=e.relationEventId;if(!d){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:n,addToState:i});return}for(var c=this.findEventById(d),h=t.getEvents(),v=c!==void 0?h.indexOf(c):0,g=v;g<h.length;g++){var p=h[g];if(p.getTs()>e.getTs())break}t.insertEvent(e,g,n,i),this._eventIdToTimeline.set(s,t);var m={timeline:t,liveEvent:!1};this.emit(ue.Timeline,e,this.room,!1,!1,m)}handleRemoteEcho(e,t,n){var i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,i)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);var i={timeline:t};this.emit(ue.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;var n=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(n===void 0||i===void 0)return null;if(n===i){for(var a=void 0,s=void 0,l=n.getEvents(),u=0;u<l.length&&(a===void 0||s===void 0);u++){var d=l[u].getId();d==e&&(a=u),d==t&&(s=u)}var c=a-s;return c<0?-1:c>0?1:0}for(var h=n;h;){if(h===i)return-1;h=h.getNeighbouringTimeline(he.FORWARDS)}for(h=n;h;){if(h===i)return 1;h=h.getNeighbouringTimeline(he.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!n&&!i){var a;I.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return n}};o(Oy,"EventTimelineSet");let pi=Oy;var Se=function(r){return r.NOT_SENT="not_sent",r.ENCRYPTING="encrypting",r.SENDING="sending",r.QUEUED="queued",r.SENT="sent",r.CANCELLED="cancelled",r}({});const ky=class ky{constructor(e,t){this.roomId=e}};o(ky,"RoomSummary");let uc=ky;const Py=class Py{constructor(e){this.target=e,f(this,"reEmitters",new WeakMap)}reEmit(e,t){var n=this,i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));var a=o(function(u){if(i.has(u))return 1;var d=o(function(){if(!(u==="error"&&n.target.listenerCount("error")===0)){for(var h=arguments.length,v=new Array(h),g=0;g<h;g++)v[g]=arguments[g];n.target.emit(u,...v,e)}},"forSource");e.on(u,d),i.set(u,d)},"_loop");for(var s of t)a(s)}stopReEmitting(e,t){var n=this.reEmitters.get(e);if(n){for(var i of t)e.off(i,n.get(i)),n.delete(i);n.size===0&&this.reEmitters.delete(e)}}};o(Py,"ReEmitter");let dc=Py;const My=class My extends dc{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}};o(My,"TypedReEmitter");let Ai=My;var Dl=new Ks("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function AD(r,e){if(e.endsWith("*")){var t=e.slice(0,-1);return r.slice(0,t.length)===t}else return r===e}o(AD,"matchesWildcard");const Ay=class Ay{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n,i=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(i),s=[];return this.userId&&i!==null&&i!==void 0&&(n=i[We.name])!==null&&n!==void 0&&n.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,s)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[cs.name]:this.filterJson[cs.name],[hs.name]:this.filterJson[hs.name]}).filter(e=>{var[t,n]=e;return n}))}checkFields(e,t,n,i,a,s){var l={rooms:o(function(y){return e===y},"rooms"),senders:o(function(y){return t===y},"senders"),types:o(function(y){return AD(n,y)},"types")};for(var u in l){var d=l[u],c="not_"+u,h=this.filterJson[c];if(h!=null&&h.some(d))return!1;var v=this.filterJson[u];if(v&&!v.some(d))return!1}var g=this.filterJson.contains_url;if(g!==void 0&&g!==i)return!1;var p=this.filterJson[hs.name];if(p!==void 0&&!this.arrayMatchesFilter(p,a))return!1;var m=this.filterJson[cs.name];return!(m!==void 0&&!this.arrayMatchesFilter(m,s))}arrayMatchesFilter(e,t){return t.length>0&&e.every(n=>t.includes(n))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}};o(Ay,"FilterComponent");let cc=Ay;function Tb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Tb,"ownKeys$i");function Ma(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Tb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Tb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Ma,"_objectSpread$i");function Cf(r,e,t){for(var n=e.split("."),i=r,a=0;a<n.length-1;a++)i[n[a]]||(i[n[a]]={}),i=i[n[a]];i[n[n.length-1]]=t}o(Cf,"setProp");const Hc=class Hc{static fromJson(e,t,n){var i=new Hc(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,f(this,"definition",{}),f(this,"roomFilter",void 0),f(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new cc(n,this.userId),this.roomTimelineFilter=new cc((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){Cf(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n;this.definition=Ma(Ma({},this.definition),{},{room:Ma(Ma({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:Ma(Ma({},(n=this.definition)===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.timeline),{},{[Dl.name]:e})})})}setLazyLoadMembers(e){Cf(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){Cf(this.definition,"room.include_leave",e)}};o(Hc,"Filter");let sr=Hc;f(sr,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function hc(r){return r!=null}o(hc,"isProvided");var xD=new nr.UnstableValue("m.message","org.matrix.msc1767.message"),Qg=new nr.UnstableValue("m.text","org.matrix.msc1767.text"),DD=new nr.UnstableValue("m.html","org.matrix.msc1767.html"),YR=new nr.NamespacedValue("m.reference");function ND(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||hc(n.altName)&&t.matches(n.altName)}o(ND,"isEventTypeSame");var Yg=new iu("m.topic");function Rb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Rb,"ownKeys$h");function LD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Rb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Rb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(LD,"_objectSpread$h");function XR(r,e){return{msgtype:bn.Text,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(XR,"makeHtmlMessage");function ZR(r,e){return{msgtype:bn.Notice,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(ZR,"makeHtmlNotice");function eI(r,e){return{msgtype:bn.Emote,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(eI,"makeHtmlEmote");function tI(r){return{msgtype:bn.Text,body:r}}o(tI,"makeTextMessage");function rI(r){return{msgtype:bn.Notice,body:r}}o(rI,"makeNotice");function nI(r){return{msgtype:bn.Emote,body:r}}o(nI,"makeEmoteMessage");var iI=o((r,e,t,n)=>{var i="at ".concat(new Date(t).toISOString()),a=e===Vs.Self?"User":void 0,s=n?'"'.concat(n,'"'):void 0;return[a,"Location",s,r,i].filter(Boolean).join(" ")},"getTextForLocationEvent"),aI=o((r,e,t,n,i)=>{var a=r??iI(e,i||Vs.Self,t,n),s=t?{[Ui.name]:t}:{};return LD({msgtype:bn.Location,body:a,geo_uri:e,[su.name]:{description:n,uri:e},[au.name]:{type:i||Vs.Self},[Qg.name]:a},s)},"makeLocationContent"),UD=o(r=>{var e,t,n=su.findIn(r),i=au.findIn(r),a=Ui.findIn(r),s=Qg.findIn(r),l=(e=n==null?void 0:n.uri)!==null&&e!==void 0?e:r==null?void 0:r.geo_uri,u=n==null?void 0:n.description,d=(t=i==null?void 0:i.type)!==null&&t!==void 0?t:Vs.Self,c=s??r.body;return aI(c,l,a??void 0,u,d)},"parseLocationEvent"),sI=o((r,e)=>{var t=[];return hc(e)&&t.push({body:e,mimetype:"text/html"}),hc(r)&&t.push({body:r,mimetype:"text/plain"}),{topic:r,[Yg.name]:t}},"makeTopicContent"),jD=o(r=>{var e,t,n,i,a=Yg.findIn(r);if(!Array.isArray(a)){var s;return{text:(s=r.topic)!==null&&s!==void 0?s:void 0}}var l=(e=(t=a==null||(n=a.find(d=>!hc(d.mimetype)||d.mimetype==="text/plain"))===null||n===void 0?void 0:n.body)!==null&&t!==void 0?t:r.topic)!==null&&e!==void 0?e:void 0,u=a==null||(i=a.find(d=>d.mimetype==="text/html"))===null||i===void 0?void 0:i.body;return{text:l,html:u}},"parseTopicContent"),FD=o((r,e,t,n,i)=>({description:t,timeout:r,live:e,[Ui.name]:i||Date.now(),[au.name]:{type:n??Vs.Self}}),"makeBeaconInfoContent"),oI=o(r=>{var e,{description:t,timeout:n,live:i}=r,a=(e=Ui.findIn(r))!==null&&e!==void 0?e:void 0,s=au.findIn(r);return{description:t,timeout:n,live:i,assetType:s==null?void 0:s.type,timestamp:a}},"parseBeaconInfoContent"),BD=o((r,e,t,n)=>({[su.name]:{description:n,uri:r},[Ui.name]:e,"m.relates_to":{rel_type:YR.name,event_id:t}}),"makeBeaconContent"),_p=o(r=>{var e,t=su.findIn(r),n=(e=Ui.findIn(r))!==null&&e!==void 0?e:void 0;return{description:t==null?void 0:t.description,uri:t==null?void 0:t.uri,timestamp:n}},"parseBeaconContent");const $D=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:iI,makeBeaconContent:BD,makeBeaconInfoContent:FD,makeEmoteMessage:nI,makeHtmlEmote:eI,makeHtmlMessage:XR,makeHtmlNotice:ZR,makeLocationContent:aI,makeNotice:rI,makeTextMessage:tI,makeTopicContent:sI,parseBeaconContent:_p,parseBeaconInfoContent:oI,parseLocationEvent:UD,parseTopicContent:jD},Symbol.toStringTag,{value:"Module"}));var Je=function(r){return r.New="Beacon.new",r.Update="Beacon.update",r.LivenessChange="Beacon.LivenessChange",r.Destroy="Beacon.Destroy",r.LocationUpdate="Beacon.LocationUpdate",r}({}),bp=o((r,e,t)=>t>=r&&r+e>=t,"isTimestampInDuration"),fc=o(r=>"".concat(r.getRoomId(),"_").concat(r.getStateKey()),"getBeaconInfoIdentifier");const xy=class xy extends Ge{constructor(e){super(),this.rootEvent=e,f(this,"roomId",void 0),f(this,"_beaconInfo",void 0),f(this,"_isLive",void 0),f(this,"livenessWatchTimeout",void 0),f(this,"_latestLocationEvent",void 0),f(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(Je.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return fc(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&_p(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(fc(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(Je.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(Je.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var n=e.filter(a=>{var s=a.getContent(),l=_p(s);if(!l.uri||!l.timestamp)return!1;var{timestamp:u}=l;return this._beaconInfo.timestamp&&bp(this._beaconInfo.timestamp,this._beaconInfo.timeout,u)&&(!this.latestLocationState||u>this.latestLocationState.timestamp)}),i=(t=n.sort(WM))===null||t===void 0?void 0:t[0];i&&(this._latestLocationEvent=i,this.emit(Je.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=oI(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&bp(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(Je.LivenessChange,this.isLive,this)}}};o(xy,"Beacon");let vc=xy;function Ib(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Ib,"ownKeys$g");function WD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ib(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ib(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(WD,"_objectSpread$g");function lI(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new qt({content:{[e.getId()]:{[t]:{[r]:WD({ts:e.getTs()},!n&&{thread_id:eo(e)})}}},type:B.Receipt,room_id:e.getRoomId()})}o(lI,"synthesizeReceipt");var Aa=0,xa=1;const Dy=class Dy extends Ge{constructor(){super(...arguments),f(this,"receipts",new Jr(()=>new Map)),f(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Xt.Read,[s,l]=(t=(n=this.receipts.get(a))===null||n===void 0?void 0:n.get(e))!==null&&t!==void 0?t:[null,null];return i?s:l??s}compareReceipts(e,t){var n;return(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&n!==void 0?n:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t,n=this.findEventById(e.eventId);if(!n)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===ou){var i=Hl(n);if(i)return!0}else if(n.threadRootId===e.data.thread_id)return!0;return I.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(n.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var n,i,a=this.getReadReceiptForUserId(e,t,Xt.Read),s=this.getReadReceiptForUserId(e,t,Xt.ReadPrivate),l;return a!=null&&a.eventId&&s!==null&&s!==void 0&&s.eventId&&(l=this.compareReceipts(a,s)),l?(i=l<0?s:a)!==null&&i!==void 0?i:null:(n=s??a)!==null&&n!==void 0?n:null}addReceiptToStructure(e,t,n,i,a){var s,l,u=this.receipts.getOrCreate(t),d=u.get(n);d||(d=[null,null],u.set(n,d));var c=d[Aa];if(a){var h;c=(h=d[xa])!==null&&h!==void 0?h:d[Aa]}var v={eventId:e,data:i};if(c){var g=this.compareReceipts(c,v);if(g>=0)return}var p=a?d[Aa]:v,m=a?v:d[xa],T=null;p&&m&&(T=this.getUnfilteredTimelineSet().compareEventOrdering(p.eventId,m.eventId));var y=T===null||T<0,S=(s=d[xa])!==null&&s!==void 0?s:d[Aa];a&&y?d[xa]=v:a||(d[Aa]=v,y||(d[xa]=null));var w=(l=d[xa])!==null&&l!==void 0?l:d[Aa];if(S!==w){if(S&&this.receiptCacheByEventId.get(S.eventId)){var C=S.eventId;this.receiptCacheByEventId.set(C,this.receiptCacheByEventId.get(C).filter(M=>M.type!==t||M.userId!==n)),this.receiptCacheByEventId.get(C).length<1&&this.receiptCacheByEventId.delete(C)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&(t==null?void 0:t.eventId)===n.getId()&&e===n.getSender()&&(this.setUnread(De.Total,0),this.setUnread(De.Highlight,0))}addLocalEchoReceipt(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(lI(e,t,n,i),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return zg(t.type)}).map(function(t){return t.userId})}};o(Dy,"ReadReceipt");let pc=Dy;var KD=new nr.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),VD=new nr.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),qD=new nr.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),Nl=new nr.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),mc=new nr.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),oi=function(r){return r.New="Poll.new",r.End="Poll.end",r.Update="Poll.update",r.Responses="Poll.Responses",r.Destroy="Poll.Destroy",r.UndecryptableRelations="Poll.UndecryptableRelations",r}({}),Cb=o((r,e)=>{var t=r.filter(n=>{if(!n.isDecryptionFailure())return Nl.matches(n.getType())&&n.getTs()<=e});return{responseEvents:t}},"filterResponseRelations");const Ny=class Ny extends Ge{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,f(this,"roomId",void 0),f(this,"pollEvent",void 0),f(this,"_isFetchingResponses",!1),f(this,"relationsNextBatch",void 0),f(this,"responses",null),f(this,"endEvent",void 0),f(this,"undecryptableRelationEventIds",new Set),f(this,"countUndecryptableEvents",i=>{var a=i.filter(l=>l.isDecryptionFailure()).map(l=>l.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==s&&this.emit(oi.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return R(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(mc.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(oi.End)),!!this.responses){var n=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=Cb([e],n);this.countUndecryptableEvents([e]),i.length&&(i.forEach(a=>{this.responses.addEvent(a)}),this.emit(oi.Responses,this.responses))}}fetchResponses(){var e=this;return R(function*(){var t,n;e._isFetchingResponses=!0;var i=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(i.events.map(d=>e.matrixClient.decryptEventIfNeeded(d)));var a=e.responses||new xl("m.reference",Nl.name,e.matrixClient,[Nl.altName]),s=i.events.find(d=>mc.matches(d.getType()));e.validateEndEvent(s)&&(e.endEvent=s,e.refilterResponsesOnEnd(),e.emit(oi.End));var l=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:u}=Cb(i.events,l);u.forEach(d=>{a.addEvent(d)}),e.relationsNextBatch=(n=i.nextBatch)!==null&&n!==void 0?n:void 0,e.responses=a,e.countUndecryptableEvents(i.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(oi.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{if(n.getTs()>t){var i;(i=this.responses)===null||i===void 0||i.removeEvent(n)}}),this.emit(oi.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}};o(Ny,"Poll");let gc=Ny;var uI=o(r=>{var e=r.getType();return nr.M_POLL_START.matches(e)||Nl.matches(e)||mc.matches(e)},"isPollEvent");const Ly=class Ly{constructor(e){f(this,"room",void 0),f(this,"threadedReceipts",void 0),f(this,"unthreadedReceipts",void 0),f(this,"danglingReceipts",void 0),f(this,"onTimelineEvent",t=>{var n=t.getId();if(n){var i=this.danglingReceipts.remove(n);i==null||i.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(n,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new Cp(e),this.unthreadedReceipts=new yc(e),this.danglingReceipts=new Op,e.on(ue.Timeline,this.onTimelineEvent)}add(e,t){for(var[n,i]of Object.entries(e))for(var[a,s]of Object.entries(i))for(var[l,u]of Object.entries(s)){var d=this.room.findEventById(n);d?u.thread_id?this.threadedReceipts.set(u.thread_id,n,a,l,u.ts,t):this.unthreadedReceipts.set(n,a,l,u.ts,t):this.danglingReceipts.add(new Rp(n,a,l,u,t))}}hasUserReadEvent(e,t){var n=this.unthreadedReceipts.get(e);if(n&&kp(n.eventId,t,this.room))return!0;var i=this.room.findEventById(t);if(!i)return I.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=eo(i),s=this.threadedReceipts.get(a,e);return!!(s&&kp(s.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var n,i=e===ou?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))===null||n===void 0?void 0:n.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}};o(Ly,"RoomReceipts");let wp=Ly;const Uy=class Uy{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}};o(Uy,"ReceiptInfo");let Tp=Uy;const jy=class jy{constructor(e,t,n,i,a){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=i,this.synthetic=a}};o(jy,"DanglingReceipt");let Rp=jy;const Fy=class Fy{constructor(e){f(this,"room",void 0),f(this,"real",void 0),f(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&kp(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}};o(Fy,"UserReceipts");let Ip=Fy;const By=class By{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a){var s=Xg(this.data,n,()=>new Ip(this.room)),l=s.getByType(a);l&&GD(l.eventId,e,this.room)||s.set(a,new Tp(e,t,i))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}};o(By,"ReceiptsByUser");let yc=By;const $y=class $y{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a,s){var l=Xg(this.data,e,()=>new yc(this.room));l.set(t,n,i,a,s)}get(e,t){var n;return(n=this.data.get(e))===null||n===void 0?void 0:n.get(t)}};o($y,"ThreadedReceipts");let Cp=$y;const Wy=class Wy{constructor(){f(this,"data",new Map)}add(e){var t=Xg(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}};o(Wy,"DanglingReceipts");let Op=Wy;function Xg(r,e,t){var n=r.get(e);if(n)return n;var i=t();return r.set(e,i),i}o(Xg,"getOrCreate");function kp(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>=0}o(kp,"isAfterOrSame");function GD(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>0}o(GD,"isAfter");function HD(r,e,t){var n=r.findEventById(e),i=r.findEventById(t);if(!n||!i)return null;var a=Hl(n),s=Hl(i);return a&&s?zD(r,e,t,n,i):JD(e,t,n,i)}o(HD,"compareEventOrdering");function zD(r,e,t,n,i){var a=r.getUnfilteredTimelineSet(),s=a.compareEventOrdering(e,t);if(s!==null)return s;var l=a.getTimelineForEvent(e);if(l===a.getLiveTimeline())return 1;var u=a.getTimelineForEvent(t);return u===a.getLiveTimeline()?-1:dI(n,i)}o(zD,"compareEventsInMainTimeline");function JD(r,e,t,n){var i=eo(t),a=eo(n),s=t.getThread();return s&&i===a?s.timelineSet.compareEventOrdering(r,e):dI(t,n)}o(JD,"compareEventsInThreads");function dI(r,e){var t=r.getTs(),n=e.getTs();return t<n?-1:t>n?1:0}o(dI,"guessOrderBasedOnTimestamp");var G=function(r){return r.Get="GET",r.Put="PUT",r.Post="POST",r.Delete="DELETE",r.Options="OPTIONS",r.Head="HEAD",r.Patch="PATCH",r}({});function Ob(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Ob,"ownKeys$f");function QD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ob(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ob(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(QD,"_objectSpread$f");const Ky=class Ky extends Error{constructor(e,t,n){super(e),this.httpStatus=t,this.httpHeaders=n}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var n=Number.parseInt(t)*1e3;if(!Number.isFinite(n))throw new Error("Retry-After header integer value is too large");return n}var i=new Date(t);if(i.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return i.getTime()-Date.now()}return null}};o(Ky,"HTTPError");let Vn=Ky;const zc=class zc extends Vn{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),n&&(s="".concat(s," (").concat(n,")")),super("MatrixError: ".concat(s),t,a),this.url=n,this.event=i,f(this,"errcode",void 0),f(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,n,i,a={};if(this.httpHeaders)for(var[s,l]of this.httpHeaders)a[s]=l;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:QD({errcode:(n=this.errcode)!==null&&n!==void 0?n:"M_UNKNOWN",error:(i=this.data.error)!==null&&i!==void 0?i:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new zc(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}};o(zc,"MatrixError");let dt=zc;function Zg(r,e){if(!(r instanceof Vn)||!r.isRateLimitError())return e;try{var t;return(t=r.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}o(Zg,"safeGetRetryAfterMs");const Vy=class Vy extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}};o(Vy,"ConnectionError");let qn=Vy;const qy=class qy extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}};o(qy,"TokenRefreshError");let Sc=qy;const Gy=class Gy extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}};o(Gy,"TokenRefreshLogoutError");let Ll=Gy;var Pp=function(r){return r.SessionLoggedOut="Session.logged_out",r.NoConsent="no_consent",r}({});/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var kb=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,YD=/\\([\u000b\u0020-\u00ff])/g,XD=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,ZD=e1;function e1(r){if(!r)throw new TypeError("argument string is required");var e=typeof r=="object"?t1(r):r;if(typeof e!="string")throw new TypeError("argument string is required to be a string");var t=e.indexOf(";"),n=t!==-1?e.slice(0,t).trim():e.trim();if(!XD.test(n))throw new TypeError("invalid media type");var i=new r1(n.toLowerCase());if(t!==-1){var a,s,l;for(kb.lastIndex=t;s=kb.exec(e);){if(s.index!==t)throw new TypeError("invalid parameter format");t+=s[0].length,a=s[1].toLowerCase(),l=s[2],l.charCodeAt(0)===34&&(l=l.slice(1,-1),l.indexOf("\\")!==-1&&(l=l.replace(YD,"$1"))),i.parameters[a]=l}if(t!==e.length)throw new TypeError("invalid parameter format")}return i}o(e1,"parse$1");function t1(r){var e;if(typeof r.getHeader=="function"?e=r.getHeader("content-type"):typeof r.headers=="object"&&(e=r.headers&&r.headers["content-type"]),typeof e!="string")throw new TypeError("content-type header is missing from object");return e}o(t1,"getcontenttype");function r1(r){this.parameters=Object.create(null),this.type=r}o(r1,"ContentType");function kh(r){var e=new AbortController;return setTimeout(()=>{e.abort()},r),e.signal}o(kh,"timeoutSignal");function cI(r){var e=new AbortController;function t(){for(var a of r)a.removeEventListener("abort",n)}o(t,"cleanup");function n(){e.abort(),t()}o(n,"onAbort");for(var i of r){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:e.signal,cleanup:t}}o(cI,"anySignal");function ey(r,e){var t,n,i=Pb(r)?new Headers(r.getAllResponseHeaders().trim().split(/[\r\n]+/).map(s=>{var l=s.indexOf(":");return[s.substring(0,l),s.substring(l+1)]})):r.headers,a;try{a=n1(i)}catch(s){return s}return((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e?new dt(JSON.parse(e),r.status,Pb(r)?r.responseURL:r.url,void 0,i):((n=a)===null||n===void 0?void 0:n.type)==="text/plain"?new Vn("Server returned ".concat(r.status," error: ").concat(e),r.status,i):new Vn("Server returned ".concat(r.status," error"),r.status,i)}o(ey,"parseErrorResponse");function Pb(r){return"getResponseHeader"in r}o(Pb,"isXhr");function n1(r){var e=r.get("Content-Type");if(e===null)return null;try{return ZD(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}o(n1,"getResponseContentType");function Mp(r,e){return Ap.apply(this,arguments)}o(Mp,"retryNetworkOperation");function Ap(){return Ap=R(function*(r,e){for(var t=0,n=null;t<r;)try{if(t>0){var i=1e3*Math.pow(2,t);I.log("network operation failed ".concat(t," times, retrying in ").concat(i,"ms...")),yield uu(i)}return yield e()}catch(a){if(a instanceof qn)t+=1,n=a;else throw a}throw n}),Ap.apply(this,arguments)}o(Ap,"_retryNetworkOperation");function hI(r,e,t){return e>4||r instanceof qn&&!t||r.httpStatus&&Math.floor(r.httpStatus/100)===4&&r.httpStatus!==429||r.name==="AbortError"||r.name==="M_TOO_LARGE"?-1:Zg(r,1e3*Math.pow(2,e))}o(hI,"calculateRetryBackoff");var li=function(r){return r.Success="success",r.Failure="failure",r.Logout="logout",r}({}),i1=500,a1=60*1e3;const Hy=class Hy{constructor(e){this.opts=e,f(this,"tokenRefreshPromise",void 0),f(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return R(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return R(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=i1&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var n=this;return R(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return R(function*(){if(e!=null&&e.expiry){var i=e.expiry.getTime()-Date.now();if(i>=a1)return li.Logout}if(!e||(e==null?void 0:e.accessToken)===n.opts.accessToken){var a;(a=n.tokenRefreshPromise)!==null&&a!==void 0||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return li.Success})()}doTokenRefresh(e){var t=this;return R(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var n;return(n=t.opts.logger)===null||n===void 0||n.error("Unable to refresh token - no refresh token or refresh function"),li.Logout}e&&e>1&&(yield uu(1e3*Math.min(32,2**e)));try{var i,a;(i=t.opts.logger)===null||i===void 0||i.debug("Attempting to refresh token");var{accessToken:s,refreshToken:l,expiry:u}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=s,t.opts.refreshToken=l,t.latestTokenRefreshExpiry=u,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",u),li.Success}catch(h){var d;if(h instanceof Ll||h instanceof dt){var c;return(c=t.opts.logger)===null||c===void 0||c.error("Failed to refresh token",h),li.Logout}return(d=t.opts.logger)===null||d===void 0||d.warn("Failed to refresh token",h),li.Failure}})()}};o(Hy,"TokenRefresher");let xp=Hy;function Mb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Mb,"ownKeys$e");function Ab(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Mb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Mb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Ab,"_objectSpread$e");const zy=class zy{constructor(e,t){var n;this.eventEmitter=e,this.opts=t,f(this,"abortController",new AbortController),f(this,"tokenRefresher",void 0),gR(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(n=t.useAuthorizationHeader)!==null&&n!==void 0?n:!0,this.tokenRefresher=new xp(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,i,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var s=void 0,l=void 0;e===G.Get?s=n:l=n;var u=this.getUrl(t,s,i,this.opts.idBaseUrl),d={json:!0,headers:{}};return a&&(d.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,u,l,d)}authedRequest(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,n,i,a)}doAuthedRequest(e,t,n,i,a){var s=arguments,l=this;return R(function*(){var u=s.length>5&&s[5]!==void 0?s[5]:{},d=lu(u);d.abortSignal=u.abortSignal;var c=yield l.tokenRefresher.prepareForRequest();c.accessToken&&(l.opts.useAuthorizationHeader?(d.headers||(d.headers={}),d.headers.Authorization||(d.headers.Authorization="Bearer ".concat(c.accessToken)),i.access_token&&delete i.access_token):i.access_token||(i.access_token=c.accessToken));try{var h=yield l.request(t,n,i,a,d);return h}catch(g){if(!(g instanceof dt))throw g;if(g.errcode==="M_UNKNOWN_TOKEN"){var v=yield l.tokenRefresher.handleUnknownToken(c,e);if(v===li.Success)return l.doAuthedRequest(e+1,t,n,i,a,u);if(v===li.Failure)throw new Sc(g);d!=null&&d.inhibitLogoutEmit||l.eventEmitter.emit(Pp.SessionLoggedOut,g)}else g.errcode=="M_CONSENT_NOT_GIVEN"&&l.eventEmitter.emit(Pp.NoConsent,g.message,g.data.consent_uri);throw g}})()}request(e,t,n,i,a){var s=this.getUrl(t,n,a==null?void 0:a.prefix,a==null?void 0:a.baseUrl);return this.requestOtherUrl(e,s,i,a)}requestOtherUrl(e,t,n){var i=arguments,a=this;return R(function*(){var s,l,u,d,c=i.length>3&&i[3]!==void 0?i[3]:{};if(c.json!==void 0&&c.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var h=a.sanitizeUrlForLogs(t);(s=a.opts.logger)===null||s===void 0||s.debug("FetchHttpApi: --> ".concat(e," ").concat(h));var v=Object.assign({},c.headers||{}),g=!c.rawResponseBody&&c.json!==!1;g&&(v.Accept||(v.Accept="application/json"));var p=(l=c.localTimeoutMs)!==null&&l!==void 0?l:a.opts.localTimeoutMs,m=(u=c.keepAlive)!==null&&u!==void 0?u:!1,T=[a.abortController.signal];p!==void 0&&T.push(kh(p)),c.abortSignal&&T.push(c.abortSignal);var y;c.json!==!1&&(n==null||(d=n.constructor)===null||d===void 0?void 0:d.name)===Object.name?(y=JSON.stringify(n),v["Content-Type"]||(v["Content-Type"]="application/json")):y=n;var{signal:S,cleanup:w}=cI(T),C,M=Date.now();try{var _;C=yield a.fetch(t,{signal:S,method:e,body:y,headers:v,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:m,priority:c.priority}),(_=a.opts.logger)===null||_===void 0||_.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-M,"ms ").concat(C.status,"]"))}catch(b){var O;throw(O=a.opts.logger)===null||O===void 0||O.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-M,"ms ").concat(b,"]")),b.name==="AbortError"?b:new qn("fetch failed",b)}finally{w()}if(!C.ok)throw ey(C,yield C.text());return a.opts.onlyData?c.rawResponseBody?yield C.blob():g?yield C.json():yield C.text():C})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var n=new URLSearchParams;for(var i of t.searchParams.keys())n.append(i,"xxx");var a=n.toString(),s=a?"?".concat(a):"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,n,i){var a=i??this.opts.baseUrl,s=a.endsWith("/")?a.slice(0,-1):a,l=new URL(s+(n??this.opts.prefix)+e);if(this.opts.extraParams||t){var u=Ab(Ab({},this.opts.extraParams),t);Wv(u,l.searchParams)}return l}};o(zy,"FetchHttpApi");let Dp=zy;var wt=function(r){return r.V1="/_matrix/client/v1",r.V3="/_matrix/client/v3",r.Unstable="/_matrix/client/unstable",r}({}),Rn=function(r){return r.V2="/_matrix/identity/v2",r}({}),ls=function(r){return r.V1="/_matrix/media/v1",r.V3="/_matrix/media/v3",r}({}),s1=1e3,o1=0,Of,Dn=[],l1=o(function(){},"debuglog");function xb(r,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),i=2;i<t;i++)n[i-2]=arguments[i];e=e||0,e<0&&(e=0);var a=Date.now()+e,s=o1++,l={runAt:a,func:r,params:n,key:s},u=d1(Dn,function(d){return d.runAt-a});return Dn.splice(u,0,l),ty(),s}o(xb,"setTimeout$1");function Db(r){if(Dn.length!==0){var e;for(e=0;e<Dn.length;e++){var t=Dn[e];if(t.key==r){Dn.splice(e,1);break}}e===0&&ty()}}o(Db,"clearTimeout$1");function ty(){Of&&globalThis.clearTimeout(Of);var r=Dn[0];if(r){var e=Date.now(),t=Math.min(r.runAt-e,s1);Of=globalThis.setTimeout(u1,t)}}o(ty,"scheduleRealCallback");function u1(){for(var r=Date.now(),e=[];;){var t=Dn[0];if(!t||t.runAt>r)break;var n=Dn.shift();l1("runCallbacks: popping",n.key),e.push(n)}ty();for(var i of e)try{i.func.apply(globalThis,i.params)}catch(a){I.error("Uncaught exception in callback function",a)}}o(u1,"runCallbacks");function d1(r,e){for(var t=0,n=r.length;t<n;){var i=t+n>>1,a=e(r[i]);a>0?n=i:t=i+1}return t}o(d1,"binarySearch");const Jy=class Jy extends Dp{constructor(){super(...arguments),f(this,"uploads",[])}uploadContent(e){var t,n,i,a,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=(t=s.includeFilename)!==null&&t!==void 0?t:!0,u=(n=s.abortController)!==null&&n!==void 0?n:new AbortController,d=((i=s.type)!==null&&i!==void 0?i:e.type)||"application/octet-stream",c=(a=s.name)!==null&&a!==void 0?a:e.name,h={loaded:0,total:0,abortController:u},v=Promise.withResolvers();if(globalThis.XMLHttpRequest){var g=new globalThis.XMLHttpRequest,p=o(function(){g.abort(),v.reject(new Error("Timeout"))},"timeoutFn"),m=xb(p,3e4);g.onreadystatechange=function(){switch(g.readyState){case globalThis.XMLHttpRequest.DONE:Db(m);try{if(g.status===0)throw new DOMException(g.statusText,"AbortError");if(!g.responseText)throw new Error("No response body.");g.status>=400?v.reject(ey(g,g.responseText)):v.resolve(JSON.parse(g.responseText))}catch(w){if(w.name==="AbortError"){v.reject(w);return}v.reject(new qn("request failed",w))}break}},g.upload.onprogress=w=>{var C;Db(m),h.loaded=w.loaded,h.total=w.total,m=xb(p,3e4),(C=s.progressHandler)===null||C===void 0||C.call(s,{loaded:w.loaded,total:w.total})};var T=this.getUrl("/upload",void 0,ls.V3);l&&c&&T.searchParams.set("filename",encodeURIComponent(c)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&T.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),g.open(G.Post,T.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&g.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),g.setRequestHeader("Content-Type",d),g.send(e),u.signal.addEventListener("abort",()=>{g.abort()})}else{var y={};l&&c&&(y.filename=c);var S={"Content-Type":d};this.authedRequest(G.Post,"/upload",y,e,{prefix:ls.V3,headers:S,abortSignal:u.signal}).then(w=>this.opts.onlyData?w:w.json()).then(v.resolve,v.reject)}return h.promise=v.promise.finally(()=>{Xd(this.uploads,w=>w===h)}),u.signal.addEventListener("abort",()=>{Xd(this.uploads,w=>w===h),v.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(h),h.promise}cancelUpload(e){var t=this.uploads.find(n=>n.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:ls.V3+"/upload",params:{access_token:this.opts.accessToken}}}};o(Jy,"MatrixHttpApi");let Ec=Jy;var c1=6*60*60*1e3,h1=30*1e3,fI=function(r){return r.Stable="stable",r.Unstable="unstable",r}({});const Qy=class Qy{constructor(e,t){var n=this;this.logger=e,this.http=t,f(this,"capabilities",void 0),f(this,"retryTimeout",void 0),f(this,"refreshTimeout",void 0),f(this,"fetchCapabilities",R(function*(){var i=yield n.http.authedRequest(G.Get,"/capabilities");return n.capabilities=i.capabilities,n.capabilities})),f(this,"poll",R(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,c1),n.logger.debug("Fetched new server capabilities")}catch(a){n.clearTimeouts();var i=Math.floor(h1+Math.random()*5e3);n.retryTimeout=setTimeout(n.poll,i),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(i,"ms"),a)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}};o(Qy,"ServerCapabilities");let _c=Qy;function Nb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Nb,"ownKeys$d");function Po(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Nb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Nb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Po,"_objectSpread$d");var vI="10",f1=["1","2","3","4","5","6","7","8","9","10"],v1=30,De=function(r){return r.Highlight="highlight",r.Total="total",r}({}),ue=function(r){return r.MyMembership="Room.myMembership",r.Tags="Room.tags",r.AccountData="Room.accountData",r.Receipt="Room.receipt",r.Name="Room.name",r.Redaction="Room.redaction",r.RedactionCancelled="Room.redactionCancelled",r.LocalEchoUpdated="Room.localEchoUpdated",r.Timeline="Room.timeline",r.TimelineReset="Room.timelineReset",r.TimelineRefresh="Room.TimelineRefresh",r.OldStateUpdated="Room.OldStateUpdated",r.CurrentStateUpdated="Room.CurrentStateUpdated",r.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",r.UnreadNotifications="Room.UnreadNotifications",r.Summary="Room.Summary",r}({});const Yy=class Yy extends pc{constructor(e,t,n){var i,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),i=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=a,f(this,"reEmitter",void 0),f(this,"txnToEvent",new Map),f(this,"notificationCounts",{}),f(this,"bumpStamp",void 0),f(this,"threadNotifications",new Map),f(this,"cachedThreadReadReceipts",new Map),f(this,"oldestThreadedReceiptTs",1/0),f(this,"unthreadedReceipts",new Map),f(this,"timelineSets",void 0),f(this,"polls",new Map),f(this,"threadsTimelineSets",[]),f(this,"filteredTimelineSets",{}),f(this,"timelineNeedsRefresh",!1),f(this,"pendingEventList",void 0),f(this,"blacklistUnverifiedDevices",void 0),f(this,"selfMembership",void 0),f(this,"heroes",null),f(this,"getTypeWarning",!1),f(this,"membersPromise",void 0),f(this,"name",void 0),f(this,"normalizedName",void 0),f(this,"tags",{}),f(this,"accountData",new Map),f(this,"summary",null),f(this,"oldState",void 0),f(this,"currentState",void 0),f(this,"relations",void 0),f(this,"threads",new Map),f(this,"visibilityEvents",new Map),f(this,"roomReceipts",new wp(this)),f(this,"threadTimelineSetsPromise",null),f(this,"threadsReady",!1),f(this,"updateThreadRootEvents",(s,l,u)=>{if(s.length){var d;if(this.updateThreadRootEvent((d=this.threadsTimelineSets)===null||d===void 0?void 0:d[0],s,l,u),s.hasCurrentUserParticipated){var c;this.updateThreadRootEvent((c=this.threadsTimelineSets)===null||c===void 0?void 0:c[1],s,l,u)}}}),f(this,"updateThreadRootEvent",(s,l,u,d)=>{s&&l.rootEvent&&(d&&s.removeEvent(l.id),yt.hasServerSideSupport?s.addLiveEvent(l.rootEvent,{duplicateStrategy:nl.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):s.addEventToTimeline(l.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:u,addToState:!1}))}),f(this,"tryApplyRedaction",s=>{if(s.isRedaction()){var l=s.event.redacts,u=l?this.findEventById(l):void 0;u&&this.applyEventAsRedaction(s,u)}else if(s.getType()===B.RoomMember){var d=s.getContent().membership;if(d!==Te.Ban&&!(d===Te.Leave&&s.getStateKey()!==s.getSender()))return;var c=s.getContent()["org.matrix.msc4293.redact_events"];if(c!==!0)return;var h=this.getLiveTimeline().getState(Ie.Forward);if(!h.maySendRedactionForEvent(s,s.getSender()))return;var v=this.getTimelineSets().map(p=>p.getTimelines()).reduce((p,m)=>(p.push(...m),p),[]).map(p=>p.getEvents().filter(m=>m.getSender()===s.getStateKey())).reduce((p,m)=>(p.push(...m),m),[]);for(var g of v)this.applyEventAsRedaction(s,g)}}),this.setMaxListeners(100),this.reEmitter=new Ai(this),a.pendingEventOrdering=a.pendingEventOrdering||Xs.Chronological,this.name=e,this.normalizedName=e,this.relations=new lc(this.client,this),this.on(ue.Receipt,this.onReceipt),this.timelineSets=[new pi(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ue.Timeline,ue.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===Xs.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{var l=this.client.getEventMapper({toDevice:!1,decrypt:!1});s.forEach(function(){var u=R(function*(d){var c=l(d);yield t.decryptEventIfNeeded(c),c.setStatus(Se.NOT_SENT),i.addPendingEvent(c,c.getTxnId())});return function(d){return u.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return R(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Wr.My)]);var n=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=n[0],e.threadsTimelineSets[1]=n[1],n}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return R(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),n=e.getLiveTimeline().getEvents(),i=n.findIndex(s=>s.event.event_id===t),a=n.slice(i).reverse().map(s=>e.client.decryptEventIfNeeded(s));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return R(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(n=>e.client.decryptEventIfNeeded(n));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(B.RoomCreate,"");return(e=t==null?void 0:t.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return R(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var n=t["m.room_versions"];if(!n){n={default:vI,available:{}};for(var i of f1)n.available[i]=fI.Stable}var a=e.checkVersionAgainstCapability(n);if(a.urgent&&a.needsUpgrade){I.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){I.warn("Failed to refresh room version capabilities",s)}if(n=t["m.room_versions"],n)a=e.checkVersionAgainstCapability(n);else return I.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();I.log("[".concat(this.roomId,"] Current version: ").concat(t)),I.log("[".concat(this.roomId,"] Version capability: "),e);var n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;var i=Object.keys(e.available).filter(a=>e.available[a]==="stable");return i.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?I.warn("URGENT upgrade required on ".concat(this.roomId)):I.warn("Non-urgent upgrade required on ".concat(this.roomId))),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(B.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Xd(this.pendingEventList,function(n){return n.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.some(i=>i.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.find(i=>i.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var n=t[t.length-1];return n.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,n=this.getLiveTimeline().getEvents(),i=n[n.length-1],a=this.getLastThread();if(!a)return i;var s=a.events[a.events.length-1];return((e=i==null?void 0:i.getTs())!==null&&e!==void 0?e:0)>((t=s==null?void 0:s.getTs())!==null&&t!==void 0?t:0)?i:s}getLastThread(){return this.getThreads().reduce((e,t)=>{var n,i;if(!e)return t;var a=t.events[t.events.length-1],s=e.events[e.events.length-1];return((n=a==null?void 0:a.getTs())!==null&&n!==void 0?n:0)>=((i=s==null?void 0:s.getTs())!==null&&i!==void 0?i:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Te.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Te.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var n;return(n=this.heroes)===null||n===void 0||(n=n[0])===null||n===void 0?void 0:n.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var n=this.currentState.getMembers(),i=n.find(a=>a.userId!==this.myUserId);return i?i.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(LR.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),n=0;if(this.getMembers().forEach(m=>{m.membership!=="join"&&m.membership!=="invite"||t.includes(m.userId)||n++}),!(n>2)){var i=(e=this.heroes)===null||e===void 0?void 0:e.filter(m=>!t.includes(m.userId)),a=Array.isArray(i)&&i.length;if(a){for(var s of i)if(s.fromMSC4186){var u=new ga(this.roomId,s.userId);return u.setMembershipEvent(new qt({event_id:"$"+this.roomId+s.userId+new Date().getTime(),type:B.RoomMember,state_key:s.userId,content:{displayname:s.displayName,avatar_url:s.avatarUrl}})),u}else{var l=this.getMember(s.userId);if(l)return l}var d=i.map(m=>this.getMember(m.userId)).find(m=>!!m);if(d)return d}var c=this.getMembers(),h=c==null?void 0:c.filter(m=>!t.includes(m.userId));if(h.length<=2){var v=h.find(m=>m.userId!==this.myUserId);if(v)return v}if(a){var g=i.map(m=>this.client.getUser(m.userId)).find(m=>!!m);if(g){var p=new ga(this.roomId,g.userId);return p.user=g,p}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Te.Leave&&this.cleanupAfterLeaving(),this.emit(ue.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return R(function*(){var t=e.client.store.getSyncToken(),n=yield e.client.members(e.roomId,void 0,Te.Leave,t??void 0);return n.chunk})()}loadMembers(){var e=this;return R(function*(){var t=!1,n=yield e.client.store.getOutOfBandMembers(e.roomId);(n===null||e.hasEncryptionStateEvent())&&(t=!0,n=yield e.loadMembersFromServer(),I.log("LL: got ".concat(n.length," ")+"members from server for room ".concat(e.roomId)));var i=n.filter(Gr).map(e.client.getEventMapper());return{memberEvents:i,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var n=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var s;return(s=a.events.member)===null||s===void 0?void 0:s.event});I.log("LL: telling store to write ".concat(n.length)+" members for room ".concat(this.roomId));var i=this.client.store;return i.setOutOfBandMembers(this.roomId,n).catch(a=>{I.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{I.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return R(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{I.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),I.log(e)})}refreshLiveTimeline(){var e=this;return R(function*(){var t=e.getLiveTimeline(),n=t.getPaginationToken(he.FORWARDS),i=t.getPaginationToken(he.BACKWARDS),a=t.getEvents(),s=a[a.length-1];I.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(s&&s.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(n," ")+"backwardPaginationToken=".concat(i));var l=e.getUnfilteredTimelineSet(),u;s?(e.resetLiveTimeline(null,null),e.emit(ue.TimelineRefresh,e,l),u=yield e.client.getEventTimeline(l,s.getId())):u=yield e.client.getLatestTimeline(l);var d=l.getLiveTimeline();!d||d.getPaginationToken(Ie.Forward)===null&&d.getPaginationToken(Ie.Backward)===null&&d.getEvents().length===0?(I.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),u.setPaginationToken(n,he.FORWARDS),l.setLiveTimeline(u),e.fixUpLegacyTimelineFields()):I.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ue.TimelineRefresh,e,l)})()}resetLiveTimeline(e,t){for(var n of this.timelineSets)n.resetLiveTimeline(e??void 0,t??void 0);for(var i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(he.BACKWARDS),this.currentState=this.getLiveTimeline().getState(he.FORWARDS),e!==this.oldState&&this.emit(ue.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ue.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[ke.Events,ke.Members,ke.NewMember,ke.Update,ke.Marker,Je.New,Je.Update,Je.Destroy,Je.LivenessChange]),this.reEmitter.reEmit(this.currentState,[ke.Events,ke.Members,ke.NewMember,ke.Update,ke.Marker,Je.New,Je.Update,Je.Destroy,Je.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],n=!1,i=e.getContent();for(var a of Object.values(i))for(var[s,l]of Object.entries(a))if(zg(s)&&l){for(var[u,d]of Object.entries(l))if(!(!d||typeof d!="object")){var c=d;u===this.client.getUserId()&&(c.thread_id===void 0?n=!0:typeof c.thread_id=="string"&&t.push(c.thread_id))}}n&&(t=this.getThreads().filter(M=>this.getThreadUnreadNotificationCount(M.id,De.Total)>0||this.getThreadUnreadNotificationCount(M.id,De.Highlight)>0).map(M=>M.id),t.push("main"));for(var h of t){var v,g=20,p=h==="main"?this.getLiveTimeline():(v=this.getThread(h))===null||v===void 0?void 0:v.liveTimeline;if(!p){I.warn("Couldn't find timeline for thread ID ".concat(h," in room ").concat(this.roomId));continue}for(var m=p.getEvents(),T=0,y=m.length-1;y>=0;y--){var S;if(y===m.length-g)return;var w=m[y];if(this.hasUserReadEvent(this.client.getUserId(),w.getId()))break;var C=this.client.getPushActionsForEvent(w);T+=C!=null&&(S=C.tweaks)!==null&&S!==void 0&&S.highlight?1:0}h==="main"?this.setUnreadNotificationCount(De.Highlight,T):this.setThreadUnreadNotificationCount(h,De.Highlight,T)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var n=this.getThreads(),i=0;i<n.length;i++){var a=n[i];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:De.Total,t=this.getRoomUnreadNotificationCount(e);for(var n of this.threadNotifications.values()){var i;t+=(i=n[e])!==null&&i!==void 0?i:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:De.Total,n=arguments.length>1?arguments[1]:void 0,i=!!n.threadRootId&&!n.isThreadRoot;return(e=i?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:De.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:De.Total;return(t=(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n[i])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,n;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((n=e.total)!==null&&n!==void 0?n:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var i,a,s=Po({highlight:(i=this.threadNotifications.get(e))===null||i===void 0?void 0:i.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:n});this.threadNotifications.set(e,s),this.emit(ue.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var n,i;if(((n=t.highlight)!==null&&n!==void 0?n:0)>0)return De.Highlight;((i=t.total)!==null&&i!==void 0?i:0)>0&&!e&&(e=De.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[n,i]of this.threadNotifications)e.includes(n)||(i.total=0,t||(i.highlight=0));this.emit(ue.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ue.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,n=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(s=>({userId:s,fromMSC4186:!1})),i=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(n)&&(this.heroes=n.filter(s=>s.userId!=this.myUserId)),this.emit(ue.Summary,e)}setMSC4186SummaryData(e,t,n){e&&(this.heroes=e.filter(i=>i.user_id!==this.myUserId).map(i=>({userId:i.user_id,displayName:i.displayname,avatarUrl:i.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),n!==void 0&&Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),this.emit(ue.Summary,{"m.heroes":this.heroes?this.heroes.map(i=>i.userId):[],"m.joined_member_count":t,"m.invited_member_count":n})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,l=this.currentState.getStateEvents(B.RoomAvatar,"");if(!l&&!a)return null;var u=l?l.getContent().url:null;return u?bh(e,u,t,n,i,void 0,void 0,s):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents(B.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(B.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(B.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,n,i,a){i.getTimelineSet().addEventsToTimeline(e,t,n,i,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Te.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return R(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Te.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Te.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(B.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var n=this.getMember(e);return n?n.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:i},this.opts),s=new pi(this,a);this.reEmitter.reEmit(s,[ue.Timeline,ue.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s));var l=this.getLiveTimeline();if(t){l.getEvents().forEach(function(c){s.addLiveEvent(c,{addToState:!1})});for(var u=l;u.getNeighbouringTimeline(he.BACKWARDS);)u=u.getNeighbouringTimeline(he.BACKWARDS);s.getLiveTimeline().setPaginationToken(u.getPaginationToken(he.BACKWARDS),he.BACKWARDS)}else if(n){var d=l.getPaginationToken(Ie.Forward);s.getLiveTimeline().setPaginationToken(d,Ie.Backward)}return s}getThreadListFilter(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:Wr.All,i=t.client.getUserId(),a=new sr(i),s={room:{timeline:{[hs.name]:[We.name]}}};n===Wr.My&&(s.room.timeline[cs.name]=[i]),a.setDefinition(s);var l=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(n),a);return a.filterId=l,a})()}createThreadTimelineSet(e){var t=this;return R(function*(){var n;if(yt.hasServerSideListSupport)n=new pi(t,Po(Po({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Wr.All),t.reEmitter.reEmit(n,[ue.Timeline,ue.TimelineReset]);else if(yt.hasServerSideSupport){var i=yield t.getThreadListFilter(e);n=t.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else n=new pi(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,s]=a;if(s.length!==0){var l=s.timeline.some(u=>u.getSender()===t.client.getUserId());(e!==Wr.My||l)&&n.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return n})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var n of e)he.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}fetchRoomThreads(){var e=this;return R(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(yt.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Wr.All),e.fetchRoomThreadList(Wr.My)]);else{var t=yield e.getThreadListFilter(),{chunk:n}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,Ie.Backward,t);if(!n.length)return;var i=n.map(e.client.getEventMapper()).sort((v,g)=>{var p=v.getServerAggregatedRelation(We.name),m=g.getServerAggregatedRelation(We.name);return p.latest_event.origin_server_ts-m.latest_event.origin_server_ts}),a,s=e.getLiveTimeline().getState(he.FORWARDS);for(var l of i){var u,d={duplicateStrategy:nl.Ignore,fromCache:!1,addToState:!1,roomState:s};(u=e.threadsTimelineSets[0])===null||u===void 0||u.addLiveEvent(l,d);var c=l.getServerAggregatedRelation(We.name);if(c!=null&&c.current_user_participated){var h;(h=e.threadsTimelineSets[1])===null||h===void 0||h.addLiveEvent(l,d),a=l}}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(Zt.NewReply,e.onThreadReply),e.on(Zt.Update,e.onThreadUpdate),e.on(Zt.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return R(function*(){for(var n of e)try{if(!n.isEncrypted()&&!uI(n))continue;yield t.client.decryptEventIfNeeded(n),t.processPollEvent(n)}catch(i){I.warn("Error processing poll event",n.getId(),i)}})()}processPollEvent(e){var t=this;return R(function*(){if(e.isDecryptionFailure()){e.once(Le.Decrypted,s=>{t.processPollEvent(s)});return}if(nr.M_POLL_START.matches(e.getType())){try{var n=new gc(e,t.client,t);t.polls.set(e.getId(),n),t.emit(oi.New,n),e.once(Le.BeforeRedaction,s=>{t.polls.delete(s.getId())})}catch{}return}var i=e.relationEventId;if(i&&t.polls.has(i)){var a=t.polls.get(i);a==null||a.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return R(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var n=e===Wr.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:i,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,Ie.Backward,n.threadListType,n.getFilter());if(n.getLiveTimeline().setPaginationToken(a??null,Ie.Backward),!!i.length){var s=i.map(t.client.getEventMapper());t.processThreadRoots(s,!0);var l=t.getLiveTimeline().getState(he.FORWARDS);for(var u of s)n.addLiveEvent(u,{duplicateStrategy:nl.Replace,fromCache:!1,roomState:l,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var n=this.getTimelineForEvent(e.id),i=n==null||(t=n.getEvents())===null||t===void 0?void 0:t.find(s=>s.getId()===e.id);i?e.clearEventMetadata(i):I.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i;if(!((i=this.client)!==null&&i!==void 0&&i.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||n!=null&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(We.name),s=e.getAssociatedId(),l=e.threadRootId;if(s&&!a&&(l===s||n!=null&&n.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var u;if(s){var d;u=(d=this.findEventById(s))!==null&&d!==void 0?d:t==null?void 0:t.find(c=>c.getId()===s)}return u&&!a?this.eventShouldLiveIn(u,t,n):l!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:l}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getThread(e);if(i)i.addEvents(t,n);else{var a,s=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(l=>l.getId()===e);this.createThread(e,s,t,n)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var n={};for(var i of e){var a,{threadId:s,shouldLiveInThread:l}=this.eventShouldLiveIn(i);l&&!n[s]&&(n[s]=[]),(a=n[s])===null||a===void 0||a.push(i)}Object.entries(n).map(u=>{var[d,c]=u;return this.addThreadedEvents(d,c,t)})}createThread(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var s=this.relations.getAllChildEventsForEvent(t.getId());s!=null&&s.length&&(i=i.concat(s.filter(u=>!u.isRelation(Xe.Replace))))}var l=new yt(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(n=this.cachedThreadReadReceipts.get(e))!==null&&n!==void 0?n:[]});return this.reEmitter.reEmit(l,[Zt.Delete,Zt.Update,Zt.NewReply,ue.Timeline,ue.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(l.id,l),l.addEvents(i,!1),this.threadsReady&&l.initialEventsFetched&&this.updateThreadRootEvents(l,a,!1),this.emit(Zt.New,l,a),l}applyEventAsRedaction(e,t){var n=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var i=this.currentState.getStateEvents(t.getType(),t.getStateKey());(i==null?void 0:i.getId())===t.getId()&&this.currentState.setStateEvents([t])}this.emit(ue.Redaction,e,this,n),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[n,i]of this.txnToEvent)if(i.getId()===e.getId()){I.debug("processLiveEvent: found sent event without txn ID: ",n,e.getId());var a=e.getUnsigned();a.transaction_id=n,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:n,timelineWasEmpty:i,fromCache:a,addToState:s}=t;for(var l of this.timelineSets)l.addLiveEvent(e,{duplicateStrategy:n,fromCache:a,timelineWasEmpty:i,addToState:s});e.sender&&e.getType()!==B.RoomRedaction&&this.addReceipt(lI(e.sender.userId,e,Xt.Read),!0)}addPendingEvent(e,t){if(e.status!==Se.SENDING&&e.status!==Se.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(he.setEventMetadata(e,this.getLiveTimeline().getState(he.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(s=>s.status===Se.NOT_SENT)&&(I.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(Se.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n=e.event.redacts,i=this.pendingEventList.find(s=>s.getId()===n);!i&&n&&(i=this.findEventById(n)),i&&(i.markLocallyRedacted(e),this.emit(ue.Redaction,e,this,i.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(ue.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Po(Po({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var n=t.type===B.RoomMessageEncrypted,i=this.hasEncryptionStateEvent();return n||!i});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var n=t.getId(),i=e.getId(),a=t.status;I.debug("Got remote echo for event ".concat(n," -> ").concat(i," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:s,threadId:l}=this.eventShouldLiveIn(e),u=l?this.getThread(l):null;if(u==null||u.setEventMetadata(t),u==null||u.timelineSet.handleRemoteEcho(t,n,i),s)for(var d of this.timelineSets)d.handleRemoteEcho(t,n,i);this.emit(ue.LocalEchoUpdated,t,this,n,a)}updatePendingEvent(e,t,n){if(I.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(n)),t==Se.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==Se.SENT){var i=this.getTimelineForEvent(n);if(i){var a=this.findEventById(n),s=a==null?void 0:a.getUnsigned().transaction_id;if(!s&&a){var l=a.getUnsigned();l.transaction_id=e.getTxnId(),a.setUnsigned(l),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var u=e.status,d=e.getId();if(!u)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var c=p1[u];if(!(c!=null&&c.includes(t)))throw new Error("Invalid EventStatus transition ".concat(u,"->").concat(t));if(e.setStatus(t),t==Se.SENT){e.replaceLocalEventId(n);var{shouldLiveInRoom:h,threadId:v}=this.eventShouldLiveIn(e),g=v?this.getThread(v):void 0;if(g==null||g.setEventMetadata(e),g==null||g.timelineSet.replaceEventId(d,n),h)for(var p of this.timelineSets)p.replaceEventId(d,n)}else if(t==Se.CANCELLED){if(this.pendingEventList){var m=this.getPendingEvent(d);this.removePendingEvent(d),m!=null&&m.isRedaction()&&this.revertRedactionLocalEcho(m)}this.removeEvent(d)}this.savePendingEvents(),this.emit(ue.LocalEchoUpdated,e,this,d,u)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(ue.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(he.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(he.FORWARDS)+")");if(t.getNeighbouringTimeline(he.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return R(function*(){var{duplicateStrategy:i,fromCache:a,timelineWasEmpty:s=!1,addToState:l}=t;if(i&&["replace","ignore"].indexOf(i)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var u=n.findThreadRoots(e),d={},c={duplicateStrategy:i,fromCache:a,timelineWasEmpty:s,addToState:l},h=[...e];for(var v of e){var g;if(n.processLiveEvent(v),v.getUnsigned().transaction_id){var p=n.txnToEvent.get(v.getUnsigned().transaction_id);if(p){n.handleRemoteEcho(v,p);continue}}var{shouldLiveInRoom:m,shouldLiveInThread:T,threadId:y=""}=n.eventShouldLiveIn(v,h,u);if(!T&&!m&&v.isRelation())try{var S=new qt(yield n.client.fetchRoomEvent(n.roomId,v.relationEventId));if(h.push(S),S.threadRootId){u.add(S.threadRootId);var w=v.getUnsigned();w[rc.name]=S.threadRootId,v.setUnsigned(w)}({shouldLiveInRoom:m,shouldLiveInThread:T,threadId:y=""}=n.eventShouldLiveIn(v,h,u))}catch(C){I.error("Failed to load parent event of unhandled relation",C)}T&&!d[y]&&(d[y]=[]),(g=d[y])===null||g===void 0||g.push(v),m?n.addLiveEvent(v,c):!T&&v.isRelation()&&n.relations.aggregateChildEvent(v)}Object.entries(d).forEach(C=>{var[M,_]=C;n.addThreadedEvents(M,_,!1)})})()}partitionThreadedEvents(e){var t=0,n=1,i=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((s,l)=>{var{shouldLiveInRoom:u,shouldLiveInThread:d,threadId:c}=this.eventShouldLiveIn(l,e,a);return u&&s[t].push(l),d&&(l.setThreadId(c??""),s[n].push(l)),!d&&!u&&s[i].push(l),s},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var n of e){var i=n.threadRootId;i!=null&&t.add(i)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(a=>{Object.keys(n[i][a]).forEach(s=>{var l,u,d,c=n[i][a][s],h=!c.thread_id||c.thread_id===ou,v=h?this:this.threads.get((l=c.thread_id)!==null&&l!==void 0?l:"");if(v){if(v.addReceiptToStructure(i,a,s,c,t),!t&&this.client.isInitialSyncComplete()&&s===this.client.getUserId()){var g=v.timeline[v.timeline.length-1];g&&i===g.getId()&&s===g.getSender()&&(v.setUnread(De.Total,0),v.setUnread(De.Highlight,0))}}else{var p;this.cachedThreadReadReceipts.set(c.thread_id,[...(p=this.cachedThreadReadReceipts.get(c.thread_id))!==null&&p!==void 0?p:[],{eventId:i,receiptType:a,userId:s,receipt:c,synthetic:t}])}var m=this.client.getUserId();s===m&&!h&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>((u=(d=this.unthreadedReceipts.get(s))===null||d===void 0?void 0:d.ts)!==null&&u!==void 0?u:0)&&this.unthreadedReceipts.set(s,c)})})}),this.emit(ue.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===B.Typing?this.currentState.setTypingEvent(t):t.getType()===B.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var n of this.timelineSets){var i=n.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(B.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Te.Invite){var n=e.getUnsigned().invite_room_state||[];n.forEach(a=>{var s=this.currentState.getStateEvents(a.type,a.state_key);s||this.currentState.setStateEvents([new qt({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var i=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=UM(this.name),this.summary=new uc(this.roomId,{title:this.name}),i!==this.name&&this.emit(ue.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ue.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var n=t.getType(),i=this.accountData.get(n);this.accountData.set(n,t),this.emit(ue.AccountData,t,this,i)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===Te.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(B.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(B.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Te.Join,n=this.currentState.getStateEvents(B.RoomPowerLevels,""),i=n&&n.getContent(),a=this.getMember(e);return i&&a&&i.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(B.RoomCreate,"");if(!e){this.getTypeWarning||(I.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[tc]}isSpaceRoom(){return this.getType()===ss.Space}isCallRoom(){return this.getType()===ss.UnstableCall}isElementVideoRoom(){return this.getType()===ss.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(he.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case nn.Actual:return e.name;case nn.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(Lb(e.names,e.count));default:return Lb(e.names,e.count)}case nn.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var n=this.currentState.getStateEvents(B.RoomName,"");if(n!=null&&n.getContent().name)return this.roomNameGenerator({type:nn.Actual,name:n.getContent().name})}var i=this.getCanonicalAlias();if(i)return this.roomNameGenerator({type:nn.Actual,name:i});var a=this.currentState.getJoinedMemberCount(),s=this.currentState.getInvitedMemberCount(),l=a+s-1,u=this.getFunctionalMembers(),d=[];if(this.heroes)this.heroes.forEach(y=>{if(u.includes(y.userId)){l--;return}if(y.displayName)d.push(y.displayName);else{var S=this.getMember(y.userId);d.push(S?S.name:y.userId)}});else{var c=this.currentState.getMembers().filter(y=>y.userId!==e&&(y.membership===Te.Invite||y.membership===Te.Join));c=c.filter(y=>{var{userId:S}=y;return u.includes(S)?(l--,!1):!0});var h=new Intl.Collator;c.sort((y,S)=>h.compare(y.userId,S.userId)),c=c.slice(0,5),d=c.map(y=>y.name)}if(l)return this.roomNameGenerator({type:nn.Generated,names:d,count:l});var v=this.getMyMembership();if(v==Te.Join){var g=this.currentState.getStateEvents(B.RoomThirdPartyInvite);if(g!=null&&g.length){var p=g.map(y=>y.getContent().display_name);return this.roomNameGenerator({type:nn.Generated,subtype:"Inviting",names:p,count:p.length+1})}}var m=d;m.length||(m=this.currentState.getMembers().filter(y=>y.userId!==e&&y.membership!==Te.Invite&&y.membership!==Te.Join).map(y=>y.name));var T;return m.length&&(T=this.roomNameGenerator({type:nn.Generated,names:m,count:m.length+1})),this.roomNameGenerator({type:nn.EmptyRoom,oldName:T})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var n=e.getSender();if(n){var i=ia.name&&this.currentState.maySendStateEvent(ia.name,n)||ia.altName&&this.currentState.maySendStateEvent(ia.altName,n);if(i){var a=this.visibilityEvents.get(t.eventId);if(a){for(var s=a.length-1,l=Math.max(0,a.length-v1);s>=l;--s){var u=a[s];if(u.getTs()<e.getTs())break}s===-1?a.unshift(e):a.splice(s+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var d=this.findEventById(t.eventId);d&&d.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),n=t==null?void 0:t.event_id,i=this.visibilityEvents.get(n);if(i){var a=i.findIndex(d=>d.getId()===e.getId());if(a!==-1&&(i.splice(a,1),a===i.length)){var s=this.findEventById(n);if(!s)return;if(a===0)this.visibilityEvents.delete(n),s.applyVisibilityEvent();else{var l=i[i.length-1],u=l.asVisibilityChange();if(!u)throw new Error("at this stage, visibility changes should be well-formed");s.applyVisibilityEvent(u)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(i))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(i=>this.getThreadUnreadNotificationCount(i.id,De.Total)>0);for(var n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return HD(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(he.FORWARDS))===null||e===void 0)&&e.getStateEvents(B.RoomEncryption,""))}};o(Yy,"Room");let Js=Yy;var p1={[Se.ENCRYPTING]:[Se.SENDING,Se.NOT_SENT,Se.CANCELLED],[Se.SENDING]:[Se.ENCRYPTING,Se.QUEUED,Se.NOT_SENT,Se.SENT],[Se.QUEUED]:[Se.SENDING,Se.NOT_SENT,Se.CANCELLED],[Se.SENT]:[],[Se.NOT_SENT]:[Se.SENDING,Se.QUEUED,Se.CANCELLED],[Se.CANCELLED]:[]},nn=function(r){return r[r.EmptyRoom=0]="EmptyRoom",r[r.Generated=1]="Generated",r[r.Actual=2]="Actual",r}({});function Lb(r,e){var t=e-1;if(r.length){if(r.length===1&&t<=1)return r[0];if(r.length===2&&t<=2)return"".concat(r[0]," and ").concat(r[1]);var n=t>1;return n?"".concat(r[0]," and ").concat(t," others"):"".concat(r[0]," and 1 other")}else return"Empty room"}o(Lb,"memberNamesToRoomName");var Tt=function(r){return r[r.Stable=0]="Stable",r[r.Unstable=1]="Unstable",r[r.Unsupported=2]="Unsupported",r}({}),It=function(r){return r.Thread="Thread",r.ThreadUnreadNotifications="ThreadUnreadNotifications",r.LoginTokenRequest="LoginTokenRequest",r.RelationBasedRedactions="RelationBasedRedactions",r.AccountDataDeletion="AccountDataDeletion",r.RelationsRecursion="RelationsRecursion",r.IntentionalMentions="IntentionalMentions",r}({}),m1={[It.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[It.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[It.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[It.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[It.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[It.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[It.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function g1(r){return Np.apply(this,arguments)}o(g1,"buildFeatureSupportMap");function Np(){return Np=R(function*(r){var e=new Map;for(var[t,n]of Object.entries(m1)){var i,a,s,l,u=(i=(a=r.versions)===null||a===void 0?void 0:a.includes(n.matrixVersion||""))!==null&&i!==void 0?i:!1,d=(s=(l=n.unstablePrefixes)===null||l===void 0?void 0:l.every(c=>{var h;return((h=r.unstable_features)===null||h===void 0?void 0:h[c])===!0}))!==null&&s!==void 0?s:!1;u?e.set(t,Tt.Stable):d?e.set(t,Tt.Unstable):e.set(t,Tt.Unsupported)}return e}),Np.apply(this,arguments)}o(Np,"_buildFeatureSupportMap");function Ub(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Ub,"ownKeys$c");function bc(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ub(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ub(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(bc,"_objectSpread$c");var jb=80*1e3,y1=3,Ue=function(r){return r.Error="ERROR",r.Prepared="PREPARED",r.Stopped="STOPPED",r.Syncing="SYNCING",r.Catchup="CATCHUP",r.Reconnecting="RECONNECTING",r}({}),S1=["org.matrix.msc2716v3"];function Fb(r,e){return"FILTER_SYNC_".concat(r)+(e?"_"+e:"")}o(Fb,"getFilterName");var pI=function(r){return r.Offline="offline",r.Online="online",r.Unavailable="unavailable",r}({});function mI(r){return bc({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:Xs.Chronological,threadSupport:!1},r)}o(mI,"defaultClientOpts");function gI(r){return bc({canResetEntireTimeline:o(e=>!1,"canResetEntireTimeline")},r)}o(gI,"defaultSyncApiOpts");const Xy=class Xy{constructor(e,t,n){var i=this;this.client=e,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"_peekRoom",null),f(this,"currentSyncRequest",void 0),f(this,"abortController",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"catchingUp",!1),f(this,"running",!1),f(this,"keepAliveTimer",void 0),f(this,"connectionReturnedResolvers",void 0),f(this,"notifEvents",[]),f(this,"failedSyncCount",0),f(this,"storeIsInvalid",!1),f(this,"presence",void 0),f(this,"getPushRules",R(function*(){try{i.syncOpts.logger.debug("Getting push rules...");var a=yield i.client.getPushRules();i.syncOpts.logger.debug("Got push rules"),i.client.pushRules=a}catch(s){return i.syncOpts.logger.error("Getting push rules failed",s),i.shouldAbortSync(s)?void 0:(i.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,s),i.getPushRules())}})),f(this,"buildDefaultFilter",()=>{var a=new sr(this.client.credentials.userId);return this.client.canSupport.get(It.ThreadUnreadNotifications)!==Tt.Unsupported&&a.setUnreadThreadNotifications(!0),a}),f(this,"prepareLazyLoadingForSync",R(function*(){i.syncOpts.logger.debug("Prepare lazy loading for sync..."),i.client.isGuest()&&(i.opts.lazyLoadMembers=!1),i.opts.lazyLoadMembers&&(i.syncOpts.logger.debug("Enabling lazy load on sync filter..."),i.opts.filter||(i.opts.filter=i.buildDefaultFilter()),i.opts.filter.setLazyLoadMembers(!0))})),f(this,"storeClientOptions",R(function*(){try{i.syncOpts.logger.debug("Storing client options..."),yield i.client.storeClientOptions(),i.syncOpts.logger.debug("Stored client options")}catch(a){throw i.syncOpts.logger.error("Storing client options failed",a),a}})),f(this,"getFilter",R(function*(){i.syncOpts.logger.debug("Getting filter...");var a;i.opts.filter?a=i.opts.filter:a=i.buildDefaultFilter();var s;try{s=yield i.client.getOrCreateFilter(Fb(i.client.credentials.userId),a)}catch(l){return i.syncOpts.logger.error("Getting filter failed",l),i.shouldAbortSync(l)?{}:(i.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,l),i.getFilter())}return{filter:a,filterId:s}})),f(this,"savedSyncPromise",void 0),f(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=mI(t),this.syncOpts=gI(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ue.Timeline,ue.TimelineReset])}createRoom(e){var t=yI(this.client,e,this.opts);return t.on(ke.Marker,(n,i)=>{this.onMarkerStateEvent(t,n,i)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:n}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var i=S1.includes(e.getVersion())||t.getSender()===e.getCreator();i?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ue.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return R(function*(){var t,n=e.client,i=new sr(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+jb,s=yield n.getOrCreateFilter(Fb(n.credentials.userId,"LEFT_ROOMS"),i),l={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},u=yield n.http.authedRequest(G.Get,"/sync",l,void 0,{localTimeoutMs:a}),d=[];(t=u.rooms)!==null&&t!==void 0&&t.leave&&(d=e.mapSyncResponseToRoomArray(u.rooms.leave));var c=yield Promise.all(d.map(function(){var h=R(function*(v){var g=v.room;if(v.isBrandNewRoom){v.timeline=v.timeline||{prev_batch:null,events:[]},g.getLiveTimeline().setPaginationToken(v.timeline.prev_batch,he.BACKWARDS);var{timelineEvents:p}=yield e.mapAndInjectRoomEvents(v);return g.recalculate(),n.store.storeRoom(g),n.emit(de.Room,g),e.processEventsForNotifs(g,p),g}});return function(v){return h.apply(this,arguments)}}()));return c.filter(Boolean)})()}peek(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,n).then(a=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var l=lu(a.state).map(i.getEventMapper()),u=a.state.map(i.getEventMapper()),d=a.messages.chunk.map(i.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(i.getEventMapper()).forEach(function(c){var h=i.store.getUser(c.getContent().user_id);h?h.setPresenceEvent(c):(h=Fn.createUser(c.getContent().user_id,i),h.setPresenceEvent(c),i.store.storeUser(h)),i.emit(de.Event,c)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(l),this._peekRoom.currentState.setStateEvents(u),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(d.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),i.store.storeRoom(this._peekRoom),i.emit(de.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,i=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(G.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal}).then(function(){var a=R(function*(s){if(i._peekRoom!==e){i.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}s.chunk.filter(function(u){return u.type==="m.presence"}).map(i.client.getEventMapper()).forEach(u=>{var d=i.client.store.getUser(u.getContent().user_id);d?d.setPresenceEvent(u):(d=Fn.createUser(u.getContent().user_id,i.client),d.setPresenceEvent(u),i.client.store.storeUser(d)),i.client.emit(de.Event,u)});var l=s.chunk.filter(function(u){return u.room_id===e.roomId&&u.event_id}).map(i.client.getEventMapper());yield e.addLiveEvents(l,{addToState:!0}),i.peekPoll(e,s.end)});return function(s){return a.apply(this,arguments)}}(),a=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var n=this;return R(function*(){yield e;var i=n.startKeepAlives();n.updateSyncState(Ue.Error,{error:t}),yield i})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Ue.Error,{error:e}),!0):!1}sync(){var e=this;return R(function*(){var t,n;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(n=t.addEventListener)===null||n===void 0||n.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var i=e.client.store.getSavedSyncToken().then(c=>(e.syncOpts.logger.debug("Got saved sync token"),c));e.savedSyncPromise=e.client.store.getSavedSync().then(c=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!c)),c)return e.syncFromCache(c)}).catch(c=>{e.syncOpts.logger.error("Getting saved sync failed",c)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:s}=yield e.getFilter();if(s){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var l=a,u=yield i;if(u)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var d=e.buildDefaultFilter();d.setDefinition(s.getDefinition()),d.setTimelineLimit(e.opts.initialSyncLimit),l=JSON.stringify(d.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:l},u)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,n;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(n=this.abortController)===null||n===void 0||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return R(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var n=e.nextBatch;t.client.store.setSyncToken(n);var i={nextSyncToken:n,catchingUp:!1,fromCache:!0},a={next_batch:n,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(i,a)}catch(s){t.syncOpts.logger.error("Error processing cached sync",s)}t.storeIsInvalid||t.updateSyncState(Ue.Prepared,i)})()}doSync(e){var t=this;return R(function*(){for(;t.running;){var n=t.client.store.getSyncToken(),i=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,n)),i=yield t.currentSyncRequest}catch(l){var a=yield t.onSyncError(l);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(i.next_batch),t.failedSyncCount=0;var s={oldSyncToken:n??void 0,nextSyncToken:i.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(s,i)}catch(l){t.syncOpts.logger.error("Caught /sync error",l),t.client.emit(de.SyncUnexpectedError,l)}yield t.client.store.setSyncData(i),s.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(Ue.Prepared,s),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(s)),t.updateSyncState(Ue.Syncing,s),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Ue.Stopped))})()}doSyncRequest(e,t){var n,i=this.getSyncParams(e,t);return this.client.http.authedRequest(G.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+jb,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal})}getSyncParams(e,t){var n=this.opts.pollTimeout;(this.getSyncState()!==Ue.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);var i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());var a={filter:i,timeout:n,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=pI.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[Ue.Reconnecting,Ue.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return R(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Ue.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var n=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=y1?Ue.Error:Ue.Reconnecting,{error:e});var i=yield n;return i&&t.getSyncState()===Ue.Error&&t.updateSyncState(Ue.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return R(function*(){var i,a,s,l,u=n.client;if(Array.isArray((i=t.presence)===null||i===void 0?void 0:i.events)&&t.presence.events.filter(Gr).map(u.getEventMapper()).forEach(function(y){var S=u.store.getUser(y.getSender());S?S.setPresenceEvent(y):(S=Fn.createUser(y.getSender(),u),S.setPresenceEvent(y),u.store.storeUser(S)),u.emit(de.Event,y)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var d=t.account_data.events.filter(Gr).map(u.getEventMapper()),c=d.reduce((y,S)=>(y[S.getType()]=u.store.getAccountData(S.getType()),y),{});u.store.storeAccountDataEvents(d),d.forEach(function(y){if(y.getType()===B.PushRules){var S=y.getContent();u.setPushRules(S)}var w=c[y.getType()];return u.emit(de.AccountData,y,w),y})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var h=t.to_device.events.filter(Gr),v;n.syncOpts.cryptoCallbacks?v=yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h):v=h.map(y=>({message:y,encryptionInfo:null})),SI(v,u)}else n.catchingUp=!1;var g=[],p=[],m=[],T=[];t.rooms&&(t.rooms.invite&&(g=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(p=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(m=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(T=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Qa(g,function(){var y=R(function*(S){var w=S.room,C=n.mapSyncEventsFormat(S.invite_state,w);yield n.injectRoomEvents(w,C,void 0),S.isBrandNewRoom?(w.recalculate(),u.store.storeRoom(w),u.emit(de.Room,w)):w.recalculate(),C.forEach(function(M){u.emit(de.Event,M)})});return function(S){return y.apply(this,arguments)}}()),yield Qa(p,function(){var y=R(function*(S){var w,C=S.room,M=n.mapSyncEventsFormat(S.state,C),_=n.mapSyncEventsFormat(S["org.matrix.msc4222.state_after"],C),O=n.mapSyncEventsFormat(S.timeline,C,!1),b=n.mapSyncEventsFormat(S.ephemeral),F=n.mapSyncEventsFormat(S.account_data),V=S["org.matrix.msc4222.state_after"]?_:M.concat(O),z=n.isRoomEncrypted(C,V);if(S.unread_notifications){if(!z||S.unread_notifications.notification_count===0){var ie;C.setUnreadNotificationCount(De.Total,(ie=S.unread_notifications.notification_count)!==null&&ie!==void 0?ie:0)}if(!z||C.getUnreadNotificationCount(De.Highlight)<=0){var se;C.setUnreadNotificationCount(De.Highlight,(se=S.unread_notifications.highlight_count)!==null&&se!==void 0?se:0)}}var Pe=(w=S[Dl.name])!==null&&w!==void 0?w:S[Dl.altName];if(Pe){C.resetThreadUnreadNotificationCountFromSync(Object.keys(Pe));for(var[Ce,$e]of Object.entries(Pe)){if(!z||$e.notification_count===0){var re;C.setThreadUnreadNotificationCount(Ce,De.Total,(re=$e.notification_count)!==null&&re!==void 0?re:0)}var Y=C.getThreadUnreadNotificationCount(Ce,De.Highlight)<=0;if(!z||z&&Y){var le;C.setThreadUnreadNotificationCount(Ce,De.Highlight,(le=$e.highlight_count)!==null&&le!==void 0?le:0)}}}else C.resetThreadUnreadNotificationCountFromSync();if(S.timeline=S.timeline||{},S.isBrandNewRoom)S.timeline.prev_batch!==null&&C.getLiveTimeline().setPaginationToken(S.timeline.prev_batch,he.BACKWARDS);else if(S.timeline.limited){for(var me=!0,we=O.length-1;we>=0;we--){var j=O[we].getId();if(C.getTimelineForEvent(j)){n.syncOpts.logger.debug("Already have event ".concat(j," in limited sync - not resetting")),me=!1,O.splice(0,we);break}}if(me){var Q;C.resetLiveTimeline(S.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(C.roomId)?null:(Q=e.oldSyncToken)!==null&&Q!==void 0?Q:null),u.resetNotifTimelineSet()}}if(n.syncOpts.cryptoCallbacks)for(var N of V)N.isState()&&N.getType()===B.RoomEncryption&&N.getStateKey()===""&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(C,N));try{"org.matrix.msc4222.state_after"in S?yield n.injectRoomEvents(C,void 0,_,O,e.fromCache):yield n.injectRoomEvents(C,M,void 0,O,e.fromCache)}catch(x){n.syncOpts.logger.error("Failed to process events on room ".concat(C.roomId,":"),x)}S.summary&&C.setSummary(S.summary),C.addEphemeralEvents(b),C.addAccountData(F),C.recalculate(),S.isBrandNewRoom&&(u.store.storeRoom(C),u.emit(de.Room,C)),n.processEventsForNotifs(C,O);var D=o(x=>u.emit(de.Event,x),"emitEvent");M.forEach(D),O.forEach(D),b.forEach(D),F.forEach(D),C.decryptCriticalEvents()});return function(S){return y.apply(this,arguments)}}()),yield Qa(m,function(){var y=R(function*(S){var w=S.room,{timelineEvents:C,stateEvents:M,stateAfterEvents:_}=yield n.mapAndInjectRoomEvents(S),O=n.mapSyncEventsFormat(S.account_data);w.addAccountData(O),w.recalculate(),S.isBrandNewRoom&&(u.store.storeRoom(w),u.emit(de.Room,w)),n.processEventsForNotifs(w,C),M==null||M.forEach(function(b){u.emit(de.Event,b)}),_==null||_.forEach(function(b){u.emit(de.Event,b)}),C.forEach(function(b){u.emit(de.Event,b)}),O.forEach(function(b){u.emit(de.Event,b)})});return function(S){return y.apply(this,arguments)}}()),yield Qa(T,function(){var y=R(function*(S){var w=S.room,C=n.mapSyncEventsFormat(S.knock_state,w);yield n.injectRoomEvents(w,C,void 0),S.isBrandNewRoom?(w.recalculate(),u.store.storeRoom(w),u.emit(de.Room,w)):w.recalculate(),C.forEach(function(M){u.emit(de.Event,M)})});return function(S){return y.apply(this,arguments)}}()),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(y,S){return y.getTs()-S.getTs()}),n.notifEvents.forEach(function(y){var S;(S=u.getNotifTimelineSet())===null||S===void 0||S.addLiveEvent(y,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(s=n.syncOpts.cryptoCallbacks)===null||s===void 0?void 0:s.processKeyCounts(t.device_one_time_keys_count,(l=t.device_unused_fallback_key_types)!==null&&l!==void 0?l:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var n=o(()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)},"success");this.client.http.request(G.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{n()},i=>{i.httpStatus==400||i.httpStatus==404?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(Ue.Error,{error:i}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(n=>!el(n)).map(n=>{var i=t.store.getRoom(n),a=!1;return i||(i=this.createRoom(n),a=!0),bc(bc({},e[n]),{},{room:i,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var i=this.client.getEventMapper({decrypt:n});return e.events.filter(Gr).map(function(a){return t&&(a.room_id=t.roomId),i(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Te.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var l=n.events.member;(l==null?void 0:l.getContent().membership)===Te.Invite&&(l.getContent().avatar_url=s.avatar_url,l.getContent().displayname=s.displayname,n.setMembershipEvent(l,e.currentState))},function(s){})}})}}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===B.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return R(function*(){var n=t.mapSyncEventsFormat(e.state,e.room),i=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,i,a):yield t.injectRoomEvents(e.room,n,void 0,a),{timelineEvents:a,stateEvents:n,stateAfterEvents:i}})()}injectRoomEvents(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:!1,u=n??t,d=e.getLiveTimeline(),c=d.getEvents().length==0;if(c){for(var h of u)s.client.getPushActionsForEvent(h);d.initialiseState(u,{timelineWasEmpty:c})}s.resolveInvites(e),e.recalculate(),c||(e.oldState.setStateEvents(u),e.currentState.setStateEvents(u)),yield e.addLiveEvents(i||[],{fromCache:l,timelineWasEmpty:c,addToState:n===void 0}),s.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var n of t){var i,a=this.client.getPushActionsForEvent(n);a!=null&&a.notify&&(i=a.tweaks)!==null&&i!==void 0&&i.highlight&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(de.Sync,this.syncState,n,t)}};o(Xy,"SyncApi");let fn=Xy;function yI(r,e,t){var{timelineSupport:n}=r,i=new Js(e,r,r.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:n});return r.reEmitter.reEmit(i,[ue.Name,ue.Redaction,ue.RedactionCancelled,ue.Receipt,ue.Tags,ue.LocalEchoUpdated,ue.AccountData,ue.MyMembership,ue.Timeline,ue.TimelineReset,ke.Events,ke.Members,ke.NewMember,ke.Update,Je.New,Je.Update,Je.Destroy,Je.LivenessChange]),i.on(ke.NewMember,(a,s,l)=>{var u;l.user=(u=r.getUser(l.userId))!==null&&u!==void 0?u:void 0,r.reEmitter.reEmit(l,[ur.Name,ur.Typing,ur.PowerLevel,ur.Membership])}),i}o(yI,"_createAndReEmitRoom");function SI(r,e){var t=[];r.map(n=>{if(n.message.type==="m.key.verification.cancel"){var i=n.message.content.transaction_id;i&&t.push(i)}return n}).forEach(function(n){{var i=n.message,a=i.content,s=new qt(Object.assign({},i));if(i.type==="m.key.verification.start"||i.type==="m.key.verification.request"){var l=a.transaction_id;t.includes(l)&&s.flagCancelled()}n.encryptionInfo&&s.makeEncrypted(B.RoomMessageEncrypted,{ciphertext:""},n.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(de.ToDeviceEvent,s)}e.emit(de.ReceivedToDeviceMessage,n)})}o(SI,"processToDeviceMessages");const Zy=class Zy{constructor(){f(this,"accountData",new Map),f(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return R(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return R(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return R(function*(){return Promise.resolve()})()}destroy(){return R(function*(){})()}};o(Zy,"StubStore");let Lp=Zy;const Nt=[];for(let r=0;r<256;++r)Nt.push((r+256).toString(16).slice(1));function E1(r,e=0){return(Nt[r[e+0]]+Nt[r[e+1]]+Nt[r[e+2]]+Nt[r[e+3]]+"-"+Nt[r[e+4]]+Nt[r[e+5]]+"-"+Nt[r[e+6]]+Nt[r[e+7]]+"-"+Nt[r[e+8]]+Nt[r[e+9]]+"-"+Nt[r[e+10]]+Nt[r[e+11]]+Nt[r[e+12]]+Nt[r[e+13]]+Nt[r[e+14]]+Nt[r[e+15]]).toLowerCase()}o(E1,"unsafeStringify");let kf;const _1=new Uint8Array(16);function b1(){if(!kf){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");kf=crypto.getRandomValues.bind(crypto)}return kf(_1)}o(b1,"rng");const w1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Bb={randomUUID:w1};function T1(r,e,t){var i;if(Bb.randomUUID&&!r)return Bb.randomUUID();r=r||{};const n=r.random??((i=r.rng)==null?void 0:i.call(r))??b1();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,E1(n)}o(T1,"v4");var EI={},_I={exports:{}},$b=_I.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:o(function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"},"format")},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:o(function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"},"format")},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:o(function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"},"format")},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:o(function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")},"format")},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:o(function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"},"format")},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:o(function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e},"format")},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:o(function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e},"format")},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:o(function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"},"format")},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:o(function(r){return r.params?"rid:%s %s %s":"rid:%s %s"},"format")},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:o(function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")},"format")},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:o(function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")},"format")},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:o(function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")},"format")},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:o(function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e},"format")},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys($b).forEach(function(r){var e=$b[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var bI=_I.exports;(function(r){var e=o(function(l){return String(Number(l))===l?Number(l):l},"toIntIfInt"),t=o(function(l,u,d,c){if(c&&!d)u[c]=e(l[1]);else for(var h=0;h<d.length;h+=1)l[h+1]!=null&&(u[d[h]]=e(l[h+1]))},"attachProperties"),n=o(function(l,u,d){var c=l.name&&l.names;l.push&&!u[l.push]?u[l.push]=[]:c&&!u[l.name]&&(u[l.name]={});var h=l.push?{}:c?u[l.name]:u;t(d.match(l.reg),h,l.names,l.name),l.push&&u[l.push].push(h)},"parseReg"),i=bI,a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(l){var u={},d=[],c=u;return l.split(/(\r\n|\r|\n)/).filter(a).forEach(function(h){var v=h[0],g=h.slice(2);v==="m"&&(d.push({rtp:[],fmtp:[]}),c=d[d.length-1]);for(var p=0;p<(i[v]||[]).length;p+=1){var m=i[v][p];if(m.reg.test(g))return n(m,c,g)}}),u.media=d,u};var s=o(function(l,u){var d=u.split(/=(.+)/,2);return d.length===2?l[d[0]]=e(d[1]):d.length===1&&u.length>1&&(l[d[0]]=void 0),l},"paramReducer");r.parseParams=function(l){return l.split(/;\s?/).reduce(s,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(l){return l.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(l){for(var u=[],d=l.split(" ").map(e),c=0;c<d.length;c+=3)u.push({component:d[c],ip:d[c+1],port:d[c+2]});return u},r.parseImageAttributes=function(l){return l.split(" ").map(function(u){return u.substring(1,u.length-1).split(",").reduce(s,{})})},r.parseSimulcastStreamList=function(l){return l.split(";").map(function(u){return u.split(",").map(function(d){var c,h=!1;return d[0]!=="~"?c=e(d):(c=e(d.substring(1,d.length)),h=!0),{scid:c,paused:h}})})}})(EI);var Pf=bI,R1=/%[sdv%]/g,I1=o(function(r){var e=1,t=arguments,n=t.length;return r.replace(R1,function(i){if(e>=n)return i;var a=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(a);case"%d":return Number(a);case"%v":return""}})},"format"),Mo=o(function(r,e,t){var n=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[r+"="+n];if(e.names)for(var a=0;a<e.names.length;a+=1){var s=e.names[a];e.name?i.push(t[e.name][s]):i.push(t[e.names[a]])}else i.push(t[e.name]);return I1.apply(null,i)},"makeLine"),C1=["v","o","s","i","u","e","p","c","b","t","r","z","a"],O1=["i","c","b","a"],k1=o(function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(a){a.payloads==null&&(a.payloads="")});var t=e.outerOrder||C1,n=e.innerOrder||O1,i=[];return t.forEach(function(a){Pf[a].forEach(function(s){s.name in r&&r[s.name]!=null?i.push(Mo(a,s,r)):s.push in r&&r[s.push]!=null&&r[s.push].forEach(function(l){i.push(Mo(a,s,l))})})}),r.media.forEach(function(a){i.push(Mo("m",Pf.m[0],a)),n.forEach(function(s){Pf[s].forEach(function(l){l.name in a&&a[l.name]!=null?i.push(Mo(s,l,a)):l.push in a&&a[l.push]!=null&&a[l.push].forEach(function(u){i.push(Mo(s,l,u))})})})}),i.join(`\r
`)+`\r
`},"writer$1"),Ta=EI,P1=k1,M1=P1,wI=Ta.parse;Ta.parseParams;Ta.parseFmtpConfig;Ta.parsePayloads;Ta.parseRemoteCandidates;Ta.parseImageAttributes;Ta.parseSimulcastStreamList;function ry(r,e){if(typeof r.toBase64=="function")return r.toBase64(e);var t=btoa(r.reduce((n,i)=>n+String.fromCharCode(i),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}o(ry,"toBase64$1");function il(r){return ry(r,{alphabet:"base64",omitPadding:!1})}o(il,"encodeBase64");function TI(r){return ry(r,{alphabet:"base64",omitPadding:!0})}o(TI,"encodeUnpaddedBase64");function Ph(r){return ry(r,{alphabet:"base64url",omitPadding:!0})}o(Ph,"encodeUnpaddedBase64Url");function A1(r,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(r,e):Uint8Array.from(atob(r),t=>t.charCodeAt(0))}o(A1,"fromBase64");function ua(r){return A1(r.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}o(ua,"decodeBase64");var x1="abcdefghijklmnopqrstuvwxyz",D1="ABCDEFGHIJKLMNOPQRSTUVWXYZ",N1="0123456789";function L1(r){var e=new Uint8Array(r);return globalThis.crypto.getRandomValues(e),Ph(e)}o(L1,"secureRandomBase64Url");function Ri(r){return U1(r,D1+x1+N1)}o(Ri,"secureRandomString");function U1(r,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(r<1||r>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,n=new Uint8Array(Math.floor(r*1.3)),i=n.length,a=[];a.length<r;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var s=n[i++];s<t&&a.push(e[s%e.length])}return a.join("")}o(U1,"secureRandomStringFrom");var Zn="org.matrix.msc3077.sdp_stream_metadata",qe=function(r){return r.Usermedia="m.usermedia",r.Screenshare="m.screenshare",r}({}),al=null,Up=0,j1=o(()=>(al===null&&(al=new AudioContext),Up++,al),"acquireContext"),F1=o(()=>{if(Up--,Up===0){var r;(r=al)===null||r===void 0||r.close(),al=null}},"releaseContext"),B1=200,jp=-60,$1=8,an=function(r){return r.NewStream="new_stream",r.MuteStateChanged="mute_state_changed",r.LocalVolumeChanged="local_volume_changed",r.VolumeChanged="volume_changed",r.ConnectedChanged="connected_changed",r.Speaking="speaking",r.Disposed="disposed",r}({});const Jc=class Jc extends Ge{constructor(e){super(),f(this,"stream",void 0),f(this,"sdpMetadataStreamId",void 0),f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"purpose",void 0),f(this,"speakingVolumeSamples",void 0),f(this,"client",void 0),f(this,"call",void 0),f(this,"roomId",void 0),f(this,"audioMuted",void 0),f(this,"videoMuted",void 0),f(this,"localVolume",1),f(this,"measuringVolumeActivity",!1),f(this,"audioContext",void 0),f(this,"analyser",void 0),f(this,"frequencyBinCount",void 0),f(this,"speakingThreshold",jp),f(this,"speaking",!1),f(this,"volumeLooperTimeout",void 0),f(this,"_disposed",!1),f(this,"_connected",!1),f(this,"onAddTrack",()=>{this.emit(an.NewStream,this.stream)}),f(this,"onCallState",t=>{t===_e.Connected?this.connected=!0:t===_e.Connecting&&(this.connected=!1)}),f(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(an.VolumeChanged,t);var i=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.emit(an.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,B1)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array($1).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(Oe.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(an.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var n=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),n&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(an.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=j1()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t==null?void 0:t.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(an.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(an.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return I.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===qe.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new Jc({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(Oe.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,F1()),this._disposed=!0,this.emit(an.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(an.LocalVolumeChanged,e)}};o(Jc,"CallFeed");let Mn=Jc;var W1=3e3,Fp=function(r){return r.Incoming="Call.incoming",r}({});const eS=class eS{constructor(e){f(this,"calls",void 0),f(this,"callEventBuffer",void 0),f(this,"nextSeqByCall",new Map),f(this,"toDeviceEventBuffers",new Map),f(this,"client",void 0),f(this,"candidateEventsByCall",void 0),f(this,"eventBufferPromiseChain",void 0),f(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),f(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),f(this,"onToDeviceEvent",t=>{var n=t.getContent();if(!n.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(n.call_id)||this.nextSeqByCall.set(n.call_id,0),n.seq===void 0){this.callEventBuffer.push(t);return}var i=this.nextSeqByCall.get(n.call_id)||0;if(n.seq!==i){this.toDeviceEventBuffers.has(n.call_id)||this.toDeviceEventBuffers.set(n.call_id,[]);var a=this.toDeviceEventBuffers.get(n.call_id),s=a.findIndex(c=>c.getContent().seq>n.seq);s===-1?a.push(t):a.splice(s,0,t)}else{var l=n.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(l,n.seq+1);for(var u=this.toDeviceEventBuffers.get(l),d=u&&u.shift();d&&d.getContent().seq===this.nextSeqByCall.get(l);)this.callEventBuffer.push(d),this.nextSeqByCall.set(l,d.getContent().seq+1),d=u.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(de.Sync,this.onSync),this.client.on(ue.Timeline,this.onRoomTimeline),this.client.on(de.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(de.Sync,this.onSync),this.client.removeListener(ue.Timeline,this.onRoomTimeline),this.client.removeListener(de.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return R(function*(){yield Promise.all(e.map(c=>t.client.decryptEventIfNeeded(c)));var n=e.filter(c=>{var h=c.getType();return h.startsWith("m.call.")||h.startsWith("org.matrix.call.")}),i=new Set;for(var a of n){var s=a.getType();(s===B.CallAnswer||s===B.CallHangup)&&i.add(a.getContent().call_id)}for(var l of n){var u=l.getType(),d=l.getContent().call_id;if(!(u===B.CallInvite&&i.has(d)))try{yield t.handleCallEvent(l)}catch(c){I.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",c)}}})()}handleCallEvent(e){var t=this;return R(function*(){var n;t.client.emit(de.ReceivedVoipEvent,e);var i=e.getContent(),a=e.getRoomId()||((n=t.client.groupCallEventHandler.getGroupCallById(i.conf_id))===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.roomId),s=i.conf_id,l=e.getType(),u=e.getSender(),d=i.call_id?t.calls.get(i.call_id):void 0,c,h;if(s){if(h=t.client.groupCallEventHandler.getGroupCallById(s),!h){I.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(s,", type=").concat(l,")"));return}if(c=i.device_id,!c){I.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(u,")")),h.emit(Ve.Error,new Tc(u));return}if(i.dest_session_id!==t.client.getSessionId()){I.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var v=u===t.client.credentials.userId&&(c===void 0||c===t.client.getDeviceId());if(a){if(l===B.CallInvite){var g,p,m;if(v||e.getLocalAge()>i.lifetime-W1||d&&d.state===_e.Ended||(d&&I.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(i.call_id,")")),i.invitee&&i.invitee!==t.client.getUserId()))return;var T=((g=t.client.getTurnServersExpiry())!==null&&g!==void 0?g:0)-Date.now();if(I.info("CallEventHandler handleCallEvent() current turn creds expire in "+T+" ms"),d=(p=Bl(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:c,groupCallId:s,opponentSessionId:i.sender_session_id}))!==null&&p!==void 0?p:void 0,!d){I.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(i.call_id,")"));return}d.callId=i.call_id;var y=(m=h)===null||m===void 0?void 0:m.getGroupCallStats();y&&d.initStats(y);try{yield d.initWithInvite(e)}catch(F){if(F instanceof Vr)if(F.code===sl.UnknownDevice){var S;(S=h)===null||S===void 0||S.emit(Ve.Error,F)}else I.error(F)}if(t.calls.set(d.callId,d),t.candidateEventsByCall.get(d.callId))for(var w of t.candidateEventsByCall.get(d.callId))d.onRemoteIceCandidatesReceived(w);var C;for(var M of t.calls.values()){var _,O=[_e.WaitLocalMedia,_e.CreateOffer,_e.InviteSent].includes(M.state);if(d.roomId===M.roomId&&M.direction===ni.Outbound&&((_=d.getOpponentMember())===null||_===void 0?void 0:_.userId)===M.invitee&&O){C=M;break}}C?C.callId>d.callId?(I.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(d.callId,", outgoingId=").concat(C.callId,")")),C.replacedBy(d)):(I.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(d.callId,", outgoingId=").concat(C.callId,")")),d.hangup(Re.Replaced,!0)):t.client.emit(Fp.Incoming,d);return}else if(l===B.CallCandidates){if(v)return;d?d.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(i.call_id)||t.candidateEventsByCall.set(i.call_id,[]),t.candidateEventsByCall.get(i.call_id).push(e));return}else if([B.CallHangup,B.CallReject].includes(l)){if(d)d.state!==_e.Ended&&(l===B.CallHangup?d.onHangupReceived(i):d.onRejectReceived(i),d.state===_e.Ended&&t.calls.delete(i.call_id));else{var b;d=(b=Bl(t.client,a,{opponentDeviceId:c,opponentSessionId:i.sender_session_id}))!==null&&b!==void 0?b:void 0,d&&(d.callId=i.call_id,d.initWithHangup(e),t.calls.set(i.call_id,d))}return}if(!d||!d.hasPeerConnection){I.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(l,")"));return}if(e.getContent().party_id!==d.ourPartyId)switch(l){case B.CallAnswer:v?d.state===_e.Ringing&&d.onAnsweredElsewhere(i):d.onAnswerReceived(e);break;case B.CallSelectAnswer:d.onSelectAnswerReceived(e);break;case B.CallNegotiate:d.onNegotiateReceived(e);break;case B.CallAssertedIdentity:case B.CallAssertedIdentityPrefix:d.onAssertedIdentityReceived(e);break;case B.CallSDPStreamMetadataChanged:case B.CallSDPStreamMetadataChangedPrefix:d.onSDPStreamMetadataChangedReceived(e);break}}})()}};o(eS,"CallEventHandler");let Bp=eS;var $p=function(r){return r.Incoming="GroupCall.incoming",r.Outgoing="GroupCall.outgoing",r.Ended="GroupCall.ended",r.Participants="GroupCall.participants",r}({});const tS=class tS{constructor(e){this.client=e,f(this,"groupCalls",new Map),f(this,"roomDeferreds",new Map),f(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),f(this,"onRoomStateChanged",(t,n)=>{var i=t.getType();if(i===B.GroupCallPrefix){var a=t.getStateKey(),s=t.getContent(),l=this.groupCalls.get(n.roomId);!l&&!s["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):l&&l.groupCallId===a?s["m.terminated"]||t.isRedacted()?l.terminate(!1):s["m.type"]!==l.type&&I.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(n.roomId,")")):l&&l.groupCallId!==a&&I.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(n.roomId,")"))}})}start(){var e=this;return R(function*(){e.client.getSyncState()!==Ue.Syncing&&(I.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(i=>{var a=o(()=>{if(e.client.getSyncState()===Ue.Syncing)return e.client.off(de.Sync,a),i()},"onSync");e.client.on(de.Sync,a)}));var t=e.client.getRooms();for(var n of t)e.createGroupCallForRoom(n);e.client.on(de.Room,e.onRoomsChanged),e.client.on(ke.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(de.Room,this.onRoomsChanged),this.client.removeListener(ke.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var n;t={prom:new Promise(i=>{n=i})},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(B.GroupCallPrefix),n=t.sort((s,l)=>l.getTs()-s.getTs());for(var i of n){var a=i.getContent();if(!(a["m.terminated"]||i.isRedacted())){I.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(i.getStateKey(),", ts=").concat(i.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(i);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(t);if(!i){I.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),s=n["m.type"];if(!Object.values(Mh).includes(s)){I.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(t,")"));return}var l=n["m.intent"];if(!Object.values(RI).includes(l)){I.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(t,")"));return}var u=!!n["io.element.ptt"],d;if(n!=null&&n.dataChannelsEnabled&&n!==null&&n!==void 0&&n.dataChannelOptions){var{ordered:c,maxPacketLifeTime:h,maxRetransmits:v,protocol:g}=n.dataChannelOptions;d={ordered:c,maxPacketLifeTime:h,maxRetransmits:v,protocol:g}}var p=new Fl(this.client,i,s,u,l,a,(n==null?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,d,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,p),this.client.emit($p.Incoming,p),p}};o(tS,"GroupCallEventHandler");let Wp=tS;const rS=class rS{constructor(){f(this,"bandwidth",{}),f(this,"bitrate",{}),f(this,"packetLoss",{}),f(this,"transport",[])}};o(rS,"ConnectionStats");let Kp=rS;const nS=class nS{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,n=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:n?Math.round(n/1e3):0}}};o(nS,"ConnectionStatsBuilder");let Vp=nS;const iS=class iS{static buildReport(e,t,n,i){var a=e==null?void 0:e.get(t.localCandidateId),s=e==null?void 0:e.get(t.remoteCandidateId);if(s&&a){var l=s.ip!==void 0?s.ip:s.address,u=s.port,d="".concat(l,":").concat(u),c=a.ip!==void 0?a.ip:a.address,h=a.port,v="".concat(c,":").concat(h),g=s.protocol;n.some(p=>p.ip===d&&p.type===g&&p.localIp===v)||n.push({ip:d,type:g,localIp:v,isFocus:i,localCandidateType:a.candidateType,remoteCandidateType:s.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return n}};o(iS,"TransportStatsBuilder");let qp=iS;const aS=class aS{constructor(){f(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var n;return this.ssrcToMid[t].forEach((i,a)=>{if(i.find(s=>s==e)){n=a;return}}),n}parse(e,t){var n=wI(e),i=new Map;n.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var s,l=[];(s=a.ssrcs)===null||s===void 0||s.forEach(u=>{u.attribute==="cname"&&l.push("".concat(u.id))}),i.set("".concat(a.mid),l)}}),this.ssrcToMid[t]=i}getSsrcToMidMap(e){return this.ssrcToMid[e]}};o(aS,"MediaSsrcHandler");let Gp=aS;const sS=class sS{constructor(e){this.pc=e}getLocalTracks(e){var t=o(n=>n!==null&&n.kind===e,"isNotNullAndKind");return this.pc.getTransceivers().filter(n=>n.currentDirection==="sendonly"||n.currentDirection==="sendrecv").filter(n=>n.sender!==null).map(n=>n.sender).map(n=>n.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}};o(sS,"MediaTrackHandler");let Hp=sS;const oS=class oS{constructor(e,t,n){this.trackId=e,this.type=t,this.kind=n,f(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),f(this,"bitrate",{download:0,upload:0}),f(this,"resolution",{width:-1,height:-1}),f(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),f(this,"framerate",0),f(this,"jitter",0),f(this,"codec",""),f(this,"isAlive",!0),f(this,"isMuted",!1),f(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}};o(oS,"MediaTrackStats");let zp=oS;const lS=class lS{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,f(this,"track2stats",new Map)}findTrack2Stats(e,t){var n;if(e.trackIdentifier)n=e.trackIdentifier;else if(e.mid)n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var i=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!i)return;n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(n){var a=this.track2stats.get(n);if(!a){var s=this.mediaTrackHandler.getTackById(n);if(s!==void 0){var l=s.kind==="audio"?s.kind:"video";a=new zp(n,t,l),this.track2stats.set(n,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}};o(lS,"MediaTrackStatsHandler");let Jp=lS;const uS=class uS{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}};o(uS,"ValueFormatter");let kn=uS;const Qc=class Qc{static buildFramerateResolution(e,t){var n={height:t.frameHeight,width:t.frameWidth},i=t.framesPerSecond;n.height&&n.width&&e.setResolution(n),e.setFramerate(Math.round(i||0))}static calculateSimulcastFramerate(e,t,n,i){var a=e.getFramerate();if(!a){if(n){var s=t.timestamp-n.timestamp;if(s>0&&t.framesSent){var l=t.framesSent-n.framesSent;a=l/s*1e3}}if(!a)return}a=i?Math.round(a/i):0,e.setFramerate(a)}static buildCodec(e,t,n){var i=e==null?void 0:e.get(n.codecId);if(i){var a=i.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,n){e.setBitrate({download:Qc.calculateBitrate(t.bytesReceived,n.bytesReceived,t.timestamp,n.timestamp),upload:0})}static buildBitrateSend(e,t,n){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,n.bytesSent,t.timestamp,n.timestamp)})}static buildPacketsLost(e,t,n){var i=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[i];(!a||a<0)&&(a=0);var s=kn.getNonNegativeValue(n[i]),l=Math.max(0,a-s),u=kn.getNonNegativeValue(t.packetsLost),d=kn.getNonNegativeValue(n.packetsLost),c=Math.max(0,u-d);e.setLoss({packetsTotal:l+c,packetsLost:c,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,n,i){var a=kn.getNonNegativeValue(e),s=kn.getNonNegativeValue(t),l=Math.max(0,a-s),u=n-i,d=0;return u>0&&(d=Math.round(l*8/u)),d}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}var i=e.getType()==="remote"?t.receiver.track:t==null||(n=t.sender)===null||n===void 0?void 0:n.track;if(i==null){e.alive=!1;return}if(i.readyState==="ended"){e.alive=!1;return}e.muted=i.muted,e.enabled=i.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i=e.filter(s=>s.getType()==="remote"),a=i.filter(s=>s.kind==="audio");return i.forEach(s=>{var l=s.kind==="video"?t:n;if(l.count++,s.alive&&s.muted&&l.muted++,l.maxJitter<s.getJitter()&&(l.maxJitter=s.getJitter()),l.maxPacketLoss<s.getLoss().packetsLost&&(l.maxPacketLoss=s.getLoss().packetsLost),a.length>0){var u,d;l.concealedAudio+=(u=s.getAudioConcealment())===null||u===void 0?void 0:u.concealedAudio,l.totalAudio+=(d=s.getAudioConcealment())===null||d===void 0?void 0:d.totalAudioDuration}}),{audioTrackSummary:n,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var n=t==null?void 0:t.jitter;if(n!==void 0){var i=kn.getNonNegativeValue(n);e.setJitter(Math.round(i*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var n=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived),i=n*(t==null?void 0:t.concealedSamples),a=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(i,a)}}};o(Qc,"TrackStatsBuilder");let gr=Qc;const Ya=class Ya{static build(e){var t={},n={download:0,upload:0},i={download:0,upload:0},a=0,s=0,l={local:new Map,remote:new Map},u={local:new Map,remote:new Map},d={local:new Map,remote:new Map},c=new Map,h=new Map,v=0,g=0,p=0,m=0,T=0,y=0;for(var[S,w]of e){var C=w.getLoss(),M=C.isDownloadStream?"download":"upload";if(n[M]+=C.packetsTotal,i[M]+=C.packetsLost,a+=w.getBitrate().download,s+=w.getBitrate().upload,w.kind==="audio"){var _=w.getAudioConcealment();T+=_.concealedAudio,y+=_.totalAudioDuration,v+=w.getBitrate().download,g+=w.getBitrate().upload}else p+=w.getBitrate().download,m+=w.getBitrate().upload;l[w.getType()].set(S,w.getResolution()),u[w.getType()].set(S,w.getFramerate()),d[w.getType()].set(S,w.getCodec()),w.getType()==="remote"&&(c.set(S,w.getJitter()),w.kind==="audio"&&h.set(S,w.getAudioConcealment())),w.resetBitrate()}return t.bitrate={upload:s,download:a},t.bitrate.audio={upload:g,download:v},t.bitrate.video={upload:m,download:p},t.packetLoss={total:Ya.calculatePacketLoss(i.download+i.upload,n.download+n.upload),download:Ya.calculatePacketLoss(i.download,n.download),upload:Ya.calculatePacketLoss(i.upload,n.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:T,totalAudioDuration:y},t.framerate=u,t.resolution=l,t.codec=d,t.jitter=c,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}};o(Ya,"ConnectionStatsReportBuilder");let Qp=Ya;const Zi=class Zi{static buildCallFeedReport(e,t,n){var i=n.getTransceivers(),a=[],s=[];return i.forEach(l=>{var u,d=(u=l.sender)!==null&&u!==void 0&&u.track?Zi.buildTrackStats(l.sender.track,"sender"):null,c=Zi.buildTrackStats(l.receiver.track,"receiver");a.push({mid:l.mid==null?"null":l.mid,direction:l.direction,currentDirection:l.currentDirection==null?"null":l.currentDirection,sender:d,receiver:c})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:s}}static buildTrackStats(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,s=(n=e.getConstraints())===null||n===void 0?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:s??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:i}}static expandCallFeedReport(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(i=>{var a=i.stream.getAudioTracks(),s=i.stream.getVideoTracks(),l=a.length>0?Zi.buildTrackStats(i.stream.getAudioTracks()[0],i.purpose):null,u=s.length>0?Zi.buildTrackStats(i.stream.getVideoTracks()[0],i.purpose):null,d={stream:i.stream.id,type:i.isLocal()?"local":"remote",audio:l,video:u,purpose:i.purpose,prefix:n,isVideoMuted:i.isVideoMuted(),isAudioMuted:i.isAudioMuted()};e.callFeeds.push(d)}),e}};o(Zi,"CallFeedStatsReporter");let Ul=Zi;function Wb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Wb,"ownKeys$b");function Vu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Wb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Wb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Vu,"_objectSpread$b");const dS=class dS{constructor(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=n,this.emitter=i,this.isFocus=a,f(this,"isActive",!0),f(this,"previousStatsReport",void 0),f(this,"currentStatsReport",void 0),f(this,"connectionStats",new Kp),f(this,"trackStats",void 0),n.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new Jp(new Gp,new Hp(n))}processStats(e,t){var n=this;return R(function*(){var i={isFirstCollection:n.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var a=n.pc.getStats();if(typeof(a==null?void 0:a.then)=="function")return a.then(s=>{var l,u;n.currentStatsReport=typeof(s==null?void 0:s.result)=="function"?s.result():s;try{n.processStatsReport(e,t)}catch(c){return n.handleError(c),i}n.previousStatsReport=n.currentStatsReport,i.receivedMedia=n.connectionStats.bitrate.download,i.receivedAudioMedia=((l=n.connectionStats.bitrate.audio)===null||l===void 0?void 0:l.download)||0,i.receivedVideoMedia=((u=n.connectionStats.bitrate.video)===null||u===void 0?void 0:u.download)||0;var d=gr.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return Vu(Vu({},i),{},{audioTrackSummary:d.audioTrackSummary,videoTrackSummary:d.videoTrackSummary})}).catch(s=>(n.handleError(s),i));n.isActive=!1}return Promise.resolve(i)})()}processStatsReport(e,t){var n,i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)===null||n===void 0||n.forEach(a=>{var s=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=Vp.buildBandwidthReport(a),this.connectionStats.transport=qp.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var l=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!l)return;if(s&&gr.buildPacketsLost(l,a,s),a.type==="inbound-rtp"){gr.buildFramerateResolution(l,a),s&&gr.buildBitrateReceived(l,a,s);var u=this.trackStats.findTransceiverByTrackId(l.trackId);gr.setTrackStatsState(l,u),gr.buildJitter(l,a),gr.buildAudioConcealment(l,a)}else s&&(i.set(l.trackId,kn.getNonNegativeValue(a.bytesSent)),gr.buildBitrateSend(l,a,s));gr.buildCodec(this.currentStatsReport,l,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var d=this.trackStats.findLocalVideoTrackStats(a);if(!d)return;gr.buildFramerateResolution(d,a),gr.calculateSimulcastFramerate(d,a,s,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(Ul.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,I.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=Qp.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(Vu(Vu({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}};o(dS,"CallStatsReportGatherer");let Yp=dS;var Nn=function(r){return r.CONNECTION_STATS="StatsReport.connection_stats",r.CALL_FEED_REPORT="StatsReport.call_feed_report",r.BYTE_SENT_STATS="StatsReport.byte_sent_stats",r.SUMMARY_STATS="StatsReport.summary_stats",r}({});const cS=class cS extends Ge{emitByteSendReport(e){this.emit(Nn.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(Nn.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(Nn.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(Nn.SUMMARY_STATS,e)}};o(cS,"StatsReportEmitter");let Xp=cS;const hS=class hS{constructor(e){this.emitter=e}build(e){var t=e.filter(c=>!c.isFirstCollection),n=t.length,i=e.length;if(n!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},s=0,l=0;t.forEach(c=>{this.countTrackListReceivedMedia(a,c),this.countConcealedAudio(a,c),s=this.buildMaxJitter(s,c),l=this.buildMaxPacketLoss(l,c)});var u=5,d={percentageReceivedMedia:Number((a.receivedMedia/n).toFixed(u)),percentageReceivedVideoMedia:Number((a.receivedVideo/n).toFixed(u)),percentageReceivedAudioMedia:Number((a.receivedAudio/n).toFixed(u)),maxJitter:s,maxPacketLoss:l,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(u):0),peerConnections:i};this.emitter.emitSummaryStatsReport(d)}}static extendSummaryReport(e,t){var n=[],i=[];for(var a of t){i.push(a);for(var s of a[1])n.push(s)}e.opponentDevicesInCall=Math.max(0,n.length-1),e.opponentUsersInCall=Math.max(0,i.length-1),e.diffDevicesToPeerConnections=Math.max(0,n.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,n.length-1)==0?0:e.peerConnections/(n.length-1)}countTrackListReceivedMedia(e,t){var n=!1,i=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,n=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,i=!0),i&&n&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}};o(hS,"SummaryStatsReportGatherer");let wc=hS;const fS=class fS{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=n,f(this,"timer",void 0),f(this,"gatherers",new Map),f(this,"reports",new Xp),f(this,"summaryStatsReportGatherer",new wc(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,n){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new Yp(e,t,n,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var n;(n=this.getStatsReportGatherer(e))===null||n===void 0||n.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{I.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}};o(fS,"GroupCallStats");let Zp=fS;function Kb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Kb,"ownKeys$a");function qu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Kb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Kb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(qu,"_objectSpread$a");var RI=function(r){return r.Ring="m.ring",r.Prompt="m.prompt",r.Room="m.room",r}({}),Mh=function(r){return r.Video="m.video",r.Voice="m.voice",r}({}),K1=function(r){return r.CallEnded="call_ended",r}({}),Ve=function(r){return r.GroupCallStateChanged="group_call_state_changed",r.ActiveSpeakerChanged="active_speaker_changed",r.CallsChanged="calls_changed",r.UserMediaFeedsChanged="user_media_feeds_changed",r.ScreenshareFeedsChanged="screenshare_feeds_changed",r.LocalScreenshareStateChanged="local_screenshare_state_changed",r.LocalMuteStateChanged="local_mute_state_changed",r.ParticipantsChanged="participants_changed",r.Error="group_call_error",r}({}),Ko=function(r){return r.ConnectionStats="GroupCall.connection_stats",r.ByteSentStats="GroupCall.byte_sent_stats",r.SummaryStats="GroupCall.summary_stats",r.CallFeedStats="GroupCall.call_feed_stats",r}({}),sl=function(r){return r.NoUserMedia="no_user_media",r.UnknownDevice="unknown_device",r.PlaceCallFailed="place_call_failed",r}({});const vS=class vS extends Error{constructor(e,t,n){n?(super(t+": "+n),f(this,"code",void 0)):(super(t),f(this,"code",void 0)),this.code=e}};o(vS,"GroupCallError");let jl=vS;const pS=class pS extends jl{constructor(e){super(sl.UnknownDevice,"No device found for "+e),this.userId=e}};o(pS,"GroupCallUnknownDeviceError");let Tc=pS;var rt=function(r){return r.LocalCallFeedUninitialized="local_call_feed_uninitialized",r.InitializingLocalCallFeed="initializing_local_call_feed",r.LocalCallFeedInitialized="local_call_feed_initialized",r.Entered="entered",r.Ended="ended",r}({}),Vb=1e3*60*60;function Gu(r){var e;return((e=r.getOpponentMember())===null||e===void 0?void 0:e.userId)||r.invitee||null}o(Gu,"getCallUserId");const mS=class mS extends Ge{constructor(e,t,n,i,a,s,l,u,d){var c,h,v=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,g=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=n,this.isPtt=i,this.intent=a,this.dataChannelsEnabled=l,this.dataChannelOptions=u,this.useLivekit=v,f(this,"activeSpeakerInterval",1e3),f(this,"retryCallInterval",5e3),f(this,"participantTimeout",1e3*15),f(this,"pttMaxTransmitTime",1e3*20),f(this,"activeSpeaker",void 0),f(this,"localCallFeed",void 0),f(this,"localScreenshareFeed",void 0),f(this,"localDesktopCapturerSourceId",void 0),f(this,"userMediaFeeds",[]),f(this,"screenshareFeeds",[]),f(this,"groupCallId",void 0),f(this,"allowCallWithoutVideoAndAudio",void 0),f(this,"calls",new Map),f(this,"callHandlers",new Map),f(this,"activeSpeakerLoopInterval",void 0),f(this,"retryCallLoopInterval",void 0),f(this,"retryCallCounts",new Map),f(this,"reEmitter",void 0),f(this,"transmitTimer",null),f(this,"participantsExpirationTimer",null),f(this,"resendMemberStateTimer",null),f(this,"initWithAudioMuted",!1),f(this,"initWithVideoMuted",!1),f(this,"initCallFeedPromise",void 0),f(this,"_livekitServiceURL",void 0),f(this,"stats",void 0),f(this,"statsCollectIntervalTime",0),f(this,"onConnectionStats",p=>{this.emit(Ko.ConnectionStats,{report:p})}),f(this,"onByteSentStats",p=>{this.emit(Ko.ByteSentStats,{report:p})}),f(this,"onSummaryStats",p=>{wc.extendSummaryReport(p,this.participants),this.emit(Ko.SummaryStats,{report:p})}),f(this,"onCallFeedReport",p=>{this.localCallFeed&&(p=Ul.expandCallFeedReport(p,[this.localCallFeed],"from-local-feed"));var m=[];this.forEachCall(T=>{T.callId===p.callId&&T.getFeeds().forEach(y=>m.push(y))}),p=Ul.expandCallFeedReport(p,m,"from-call-feed"),this.emit(Ko.CallFeedStats,{report:p})}),f(this,"_state",rt.LocalCallFeedUninitialized),f(this,"_participants",new Map),f(this,"_creationTs",null),f(this,"_enteredViaAnotherSession",!1),f(this,"onIncomingCall",p=>{var m,T;if(p.roomId===this.room.roomId){if(p.state!==_e.Ringing){I.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!p.groupCallId||p.groupCallId!==this.groupCallId){I.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),p.reject();return}var y=(m=p.getOpponentMember())===null||m===void 0?void 0:m.userId;if(y===void 0){I.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){I.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var S=(T=this.calls.get(y))!==null&&T!==void 0?T:new Map,w=S.get(p.getOpponentDeviceId());if((w==null?void 0:w.callId)!==p.callId){I.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(y,", callId=").concat(p.callId,")")),w&&w.hangup(Re.Replaced,!1),S.set(p.getOpponentDeviceId(),p),this.calls.set(y,S),this.initCall(p);var C=this.getLocalFeeds().map(_=>_.clone());if(!this.callExpected(p))for(var M of C)mt(M.stream.getAudioTracks(),!1),mt(M.stream.getVideoTracks(),!1);p.answerWithCallFeeds(C),this.emit(Ve.CallsChanged,this.calls)}}}),f(this,"onRetryCallLoop",()=>{var p=!1;for(var[{userId:m},T]of this.participants){var y=this.calls.get(m),S=this.retryCallCounts.get(m);for(var[w,C]of T){var M,_,O=y==null?void 0:y.get(w),b=(M=(_=S)===null||_===void 0?void 0:_.get(w))!==null&&M!==void 0?M:0;(O==null?void 0:O.getOpponentSessionId())!==C.sessionId&&this.wantsOutgoingCall(m,w)&&b<3&&(S===void 0&&(S=new Map,this.retryCallCounts.set(m,S)),S.set(w,b+1),p=!0)}}p&&this.placeOutgoingCalls()}),f(this,"onCallFeedsChanged",p=>{var m=Gu(p),T=p.getOpponentDeviceId();if(!m)throw new Error("Cannot change call feeds without user id");var y=this.getUserMediaFeed(m,T),S=p.remoteUsermediaFeed,w=S!==y,C=this.calls.get(m),M=C==null?void 0:C.get(T);if((M==null?void 0:M.callId)===p.callId){w&&(!y&&S?this.addUserMediaFeed(S):y&&S?this.replaceUserMediaFeed(y,S):y&&!S&&this.removeUserMediaFeed(y));var _=this.getScreenshareFeed(m,T),O=p.remoteScreensharingFeed,b=O!==_;b&&(!_&&O?this.addScreenshareFeed(O):_&&O?this.replaceScreenshareFeed(_,O):_&&!O&&this.removeScreenshareFeed(_))}}),f(this,"onCallStateChanged",(p,m,T)=>{var y;if(m!==_e.Ended){var S=this.localCallFeed.isAudioMuted();p.localUsermediaStream&&p.isMicrophoneMuted()!==S&&p.setMicrophoneMuted(S);var w=this.localCallFeed.isVideoMuted();p.localUsermediaStream&&p.isLocalVideoMuted()!==w&&p.setLocalVideoMuted(w);var C=(y=p.getOpponentMember())===null||y===void 0?void 0:y.userId;if(m===_e.Connected&&C){var M=this.retryCallCounts.get(C);M==null||M.delete(p.getOpponentDeviceId()),(M==null?void 0:M.size)===0&&this.retryCallCounts.delete(C)}}}),f(this,"onCallHangup",p=>{var m,T;if(p.hangupReason!==Re.Replaced){var y=(m=(T=p.getOpponentMember())===null||T===void 0?void 0:T.userId)!==null&&m!==void 0?m:this.room.getMember(p.invitee).userId,S=this.calls.get(y);(S==null?void 0:S.get(p.getOpponentDeviceId()))===p&&(this.disposeCall(p,p.hangupReason),S.delete(p.getOpponentDeviceId()),S.size===0&&this.calls.delete(y),this.emit(Ve.CallsChanged,this.calls))}}),f(this,"onCallReplaced",(p,m)=>{var T=p.getOpponentMember().userId,y=this.calls.get(T);y===void 0&&(y=new Map,this.calls.set(T,y)),p.hangup(Re.Replaced,!1),this.initCall(m),y.set(p.getOpponentDeviceId(),m),this.emit(Ve.CallsChanged,this.calls)}),f(this,"onActiveSpeakerLoop",()=>{var p=void 0,m=void 0;for(var T of this.userMediaFeeds)if(!(T.isLocal()&&this.userMediaFeeds.length>1)){var y=T.speakingVolumeSamples.reduce((w,C)=>w+Math.max(C,jp)),S=y/T.speakingVolumeSamples.length;(!p||S>p)&&(p=S,m=T)}m&&this.activeSpeaker!==m&&p&&p>jp&&(this.activeSpeaker=m,this.emit(Ve.ActiveSpeakerChanged,this.activeSpeaker))}),f(this,"onRoomState",()=>this.updateParticipants()),f(this,"onParticipantsChanged",()=>{this.forEachCall(p=>{var m=this.callExpected(p);for(var T of p.getLocalFeeds())mt(T.stream.getAudioTracks(),!T.isAudioMuted()&&m),mt(T.stream.getVideoTracks(),!T.isVideoMuted()&&m)}),this.state===rt.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),f(this,"onStateChanged",(p,m)=>{(p===rt.Entered||m===rt.Entered||p===rt.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(T=>I.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),T)))}),f(this,"onLocalFeedsChanged",()=>{this.state===rt.Entered&&this.updateMemberState().catch(p=>I.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),p))}),this.reEmitter=new dc(this),this.groupCallId=s??Ji(),this._livekitServiceURL=g,this.creationTs=(c=(h=t.currentState.getStateEvents(B.GroupCallPrefix,this.groupCallId))===null||h===void 0?void 0:h.getTs())!==null&&c!==void 0?c:null,this.updateParticipants(),t.on(ke.Update,this.onRoomState),this.on(Ve.ParticipantsChanged,this.onParticipantsChanged),this.on(Ve.GroupCallStateChanged,this.onStateChanged),this.on(Ve.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!d}create(){var e=this;return R(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit($p.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return R(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,B.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Ve.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,n=o((a,s)=>a.sessionId===s.sessionId&&a.screensharing===s.screensharing,"participantStateEqual"),i=o((a,s)=>Y_(a,s,n),"deviceMapsEqual");Y_(e,t,i)||(this._participants=e,this.emit(Ve.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var n of t.values())e(n)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,n=Gu(e),i=n===null?null:this.room.getMember(n),a=e.getOpponentDeviceId();return i!==null&&a!==void 0&&((t=this.participants.get(i))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return R(function*(){if(e.useLivekit){I.info("Livekit group call: not starting local call feed.");return}if(e.state!==rt.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=rt.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return R(function*(){I.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Mh.Video)}catch(i){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=rt.LocalCallFeedUninitialized,i}if(e._state!==rt.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var n=new Mn({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:qe.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});mt(t.getAudioTracks(),!n.isAudioMuted()),mt(t.getVideoTracks(),!n.isVideoMuted()),e.localCallFeed=n,e.addUserMediaFeed(n),e.state=rt.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return R(function*(){if(t.localCallFeed){var n=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var i=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();I.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(n.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(i,", vidShouldBeMuted=").concat(a,")")),mt(e.getAudioTracks(),!i),mt(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(n)}})()}enter(){var e=this;return R(function*(){if(e.state===rt.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==rt.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));I.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=rt.Entered,e.client.on(Fp.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===rt.Entered&&(this.forEachCall(t=>t.hangup(Re.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Fp.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=rt.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(ke.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit($p.Ended,t),t.state=rt.Ended,n){var i=t.room.currentState.getStateEvents(B.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,B.GroupCallPrefix,qu(qu({},i.getContent()),{},{"m.terminated":K1.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(s=>{var l;return(l=s.localUsermediaFeed)===null||l===void 0?void 0:l.setAudioVideoMuted(e,null)});var i=function(){var s=R(function*(){var l=[];t.forEachCall(u=>l.push(u.sendMetadataUpdate())),yield Promise.all(l).catch(u=>I.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),u))});return o(function(){return s.apply(this,arguments)},"sendUpdates")}();if(n&&(yield i()),t.localCallFeed){I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),mt(t.localCallFeed.stream.getAudioTracks(),!e)}else I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(s=>mt(s.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(s))),t.emit(Ve.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield i()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return R(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((n==null?void 0:n.getTracks().length)===0)return I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(n),t.localCallFeed.setAudioVideoMuted(null,e),mt(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var i=[];return t.forEachCall(a=>i.push(a.setLocalVideoMuted(e))),yield Promise.all(i),t.forEachCall(a=>mt(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(Ve.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(e===n.isScreensharing())return e;if(e)try{I.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield n.client.getMediaHandler().getScreensharingStream(i),s=o(function*(d){var c=o(()=>{n.setScreensharingEnabled(!1),d.removeEventListener("ended",c)},"onTrackEnded");d.addEventListener("ended",c)},"_loop");for(var l of a.getTracks())yield*s(l);return I.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=i.desktopCapturerSourceId,n.localScreenshareFeed=new Mn({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:a,purpose:qe.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(Ve.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(u=>u.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(u){if(i.throwOnFail)throw u;return I.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),u),n.emit(Ve.Error,new jl(sl.NoUserMedia,"Failed to get screen-sharing stream: ",u)),!1}else return n.forEachCall(u=>{u.localScreensharingFeed&&u.removeLocalFeed(u.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(Ve.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var n=this.client.getUserId(),i=this.client.getDeviceId();return e>=n&&(e!==n||t>i)}placeOutgoingCalls(){var e=this,t=!1,n=o(function(l){var u,d=(u=e.calls.get(l))!==null&&u!==void 0?u:new Map,c=o(function(p){var m=d.get(p);if((m==null?void 0:m.getOpponentSessionId())!==v.sessionId&&e.wantsOutgoingCall(l,p)){t=!0,m!==void 0&&(I.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(l,", deviceId=").concat(p,", callId=").concat(m.callId,")")),m.hangup(Re.NewSession,!1));var T=Bl(e.client,e.room.roomId,{invitee:l,opponentDeviceId:p,opponentSessionId:v.sessionId,groupCallId:e.groupCallId});T===null?(I.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(l,", device=").concat(p,")")),d.delete(p)):(e.initCall(T),d.set(p,T),I.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(l,", deviceId=").concat(p,", sessionId=").concat(v.sessionId,")")),T.placeCallWithCallFeeds(e.getLocalFeeds().map(y=>y.clone()),v.screensharing).then(()=>{e.dataChannelsEnabled&&T.createDataChannel("datachannel",e.dataChannelOptions)}).catch(y=>{I.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(l,")"),y),y instanceof Vr&&y.code===sl.UnknownDevice?e.emit(Ve.Error,y):e.emit(Ve.Error,new jl(sl.PlaceCallFailed,"Failed to place call to ".concat(l))),T.hangup(Re.SignallingFailed,!1),d.get(p)===T&&d.delete(p)}))}},"_loop3");for(var[h,v]of a)c(h);d.size>0?e.calls.set(l,d):e.calls.delete(l)},"_loop2");for(var[{userId:i},a]of this.participants)n(i);t&&this.emit(Ve.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(B.GroupCallMemberPrefix):this.room.currentState.getStateEvents(B.GroupCallMemberPrefix,e)}initCall(e){var t=Gu(e);if(!t)throw new Error("Cannot init call without user id");var n=o(()=>this.onCallFeedsChanged(e),"onCallFeedsChanged"),i=o((u,d)=>this.onCallStateChanged(e,u,d),"onCallStateChanged"),a=this.onCallHangup,s=o(u=>this.onCallReplaced(e,u),"onCallReplaced"),l=this.callHandlers.get(t);l===void 0&&(l=new Map,this.callHandlers.set(t,l)),l.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:i,onCallHangup:a,onCallReplaced:s}),e.on(Oe.FeedsChanged,n),e.on(Oe.State,i),e.on(Oe.Hangup,a),e.on(Oe.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(Oe)),e.initStats(this.getGroupCallStats()),n()}disposeCall(e,t){var n=Gu(e),i=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(n),{onCallFeedsChanged:s,onCallStateChanged:l,onCallHangup:u,onCallReplaced:d}=a.get(i);if(e.removeListener(Oe.FeedsChanged,s),e.removeListener(Oe.State,l),e.removeListener(Oe.Hangup,u),e.removeListener(Oe.Replaced,d),a.delete(n),a.size===0&&this.callHandlers.delete(n),e.hangupReason!==Re.Replaced){var c=this.getUserMediaFeed(n,i);c&&this.removeUserMediaFeed(c);var h=this.getScreenshareFeed(n,i);h&&this.removeScreenshareFeed(h)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(n=>n.userId===e&&n.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Ve.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var n=this.userMediaFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Ve.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Ve.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Ve.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(n=>n.userId===e&&n.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Ve.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var n=this.screenshareFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(Ve.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Ve.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){I.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===rt.Ended){this.participants=new Map;return}var t=new Map,n=Date.now(),i=this.state===rt.Entered||this.enteredViaAnotherSession,a=1/0;for(var s of this.getMemberStateEvents()){var l=this.room.getMember(s.getStateKey()),u=s.getContent(),d=Array.isArray(u["m.calls"])?u["m.calls"]:[],c=d.find(T=>T["m.call_id"]===this.groupCallId),h=Array.isArray(c==null?void 0:c["m.devices"])?c["m.devices"]:[],v=h.filter(T=>typeof T.device_id=="string"&&typeof T.session_id=="string"&&typeof T.expires_ts=="number"&&T.expires_ts>n&&Array.isArray(T.feeds));if(!i&&(l==null?void 0:l.userId)===this.client.getUserId()&&(v=v.filter(T=>T.device_id!==this.client.getDeviceId())),v.length>0&&(l==null?void 0:l.membership)===Te.Join){var g=new Map;t.set(l,g);for(var p of v)g.set(p.device_id,{sessionId:p.session_id,screensharing:p.feeds.some(T=>T.purpose===qe.Screenshare)}),p.expires_ts<a&&(a=p.expires_ts)}}if(i){var m=t.get(e);m===void 0&&(m=new Map,t.set(e,m)),m.has(this.client.getDeviceId())||m.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(T=>T.purpose===qe.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-n))}updateDevices(e){var t=arguments,n=this;return R(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1,s=Date.now(),l=n.client.getUserId(),u=n.getMemberStateEvents(l),d=(i=u==null?void 0:u.getContent())!==null&&i!==void 0?i:{},c=Array.isArray(d["m.calls"])?d["m.calls"]:[],h=null,v=[];for(var g of c)g["m.call_id"]===n.groupCallId?h=g:v.push(g);h===null&&(h={});var p=Array.isArray(h["m.devices"])?h["m.devices"]:[],m=p.filter(w=>typeof w.device_id=="string"&&typeof w.session_id=="string"&&typeof w.expires_ts=="number"&&w.expires_ts>s&&Array.isArray(w.feeds)),T=e(m);if(T!==null){var y=[...v];T.length>0&&y.push(qu(qu({},h),{},{"m.call_id":n.groupCallId,"m.devices":T}));var S={"m.calls":y};yield n.client.sendStateEvent(n.room.roomId,B.GroupCallMemberPrefix,S,l,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return R(function*(){yield e.updateDevices(t=>[...t.filter(n=>n.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+Vb,feeds:e.getLocalFeeds().map(n=>({purpose:n.purpose}))}])})()}updateMemberState(){var e=this;return R(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===rt.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(R(function*(){I.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){I.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),Vb*3/4)):yield e.updateDevices(t=>t.filter(n=>n.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return R(function*(){var{devices:t}=yield e.client.getDevices(),n=new Map(t.map(i=>[i.device_id,i]));yield e.updateDevices(i=>{var a=i.filter(s=>{var l=n.get(s.device_id);return(l==null?void 0:l.last_seen_ts)!==void 0&&!(s.device_id===e.client.getDeviceId()&&e.state!==rt.Entered&&!e.enteredViaAnotherSession)});return a.length===i.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new Zp(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(Nn.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(Nn.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(Nn.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(Nn.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}};o(mS,"GroupCall");let Fl=mS;function qb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(qb,"ownKeys$9");function Hu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?qb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):qb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Hu,"_objectSpread$9");var _e=function(r){return r.Fledgling="fledgling",r.InviteSent="invite_sent",r.WaitLocalMedia="wait_local_media",r.CreateOffer="create_offer",r.CreateAnswer="create_answer",r.Connecting="connecting",r.Connected="connected",r.Ringing="ringing",r.Ended="ended",r}({}),Gb=function(r){return r.Voice="voice",r.Video="video",r}({}),ni=function(r){return r.Inbound="inbound",r.Outbound="outbound",r}({}),lt=function(r){return r.Local="local",r.Remote="remote",r}({}),Oe=function(r){return r.Hangup="hangup",r.State="state",r.Error="error",r.Replaced="replaced",r.LocalHoldUnhold="local_hold_unhold",r.RemoteHoldUnhold="remote_hold_unhold",r.HoldUnhold="hold_unhold",r.FeedsChanged="feeds_changed",r.AssertedIdentityChanged="asserted_identity_changed",r.LengthChanged="length_changed",r.DataChannel="datachannel",r.SendVoipEvent="send_voip_event",r.PeerConnectionCreated="peer_connection_created",r}({}),Re=function(r){return r.UserHangup="user_hangup",r.LocalOfferFailed="local_offer_failed",r.NoUserMedia="no_user_media",r.UnknownDevices="unknown_devices",r.SendInvite="send_invite",r.CreateAnswer="create_answer",r.CreateOffer="create_offer",r.SendAnswer="send_answer",r.SetRemoteDescription="set_remote_description",r.SetLocalDescription="set_local_description",r.AnsweredElsewhere="answered_elsewhere",r.IceFailed="ice_failed",r.InviteTimeout="invite_timeout",r.Replaced="replaced",r.SignallingFailed="signalling_timeout",r.UserBusy="user_busy",r.Transferred="transferred",r.NewSession="new_session",r}({}),V1="1",q1="stun:turn.matrix.org",Mf=60*1e3,G1=1e3,H1=30*1e3,z1=2*1e3;const gS=class gS extends Error{constructor(e,t,n){super(t+": "+n),f(this,"code",void 0),this.code=e}};o(gS,"CallError");let Vr=gS;function Ji(){return Date.now().toString()+Ri(16)}o(Ji,"genCallID");function Hb(r){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:r?12e3:void 0}];return e}o(Hb,"getCodecParamMods");function Br(r,e){return r+":"+e}o(Br,"getTransceiverKey");const yS=class yS extends Ge{constructor(e){var t,n;if(super(),t=this,f(this,"roomId",void 0),f(this,"callId",void 0),f(this,"invitee",void 0),f(this,"hangupParty",void 0),f(this,"hangupReason",void 0),f(this,"direction",void 0),f(this,"ourPartyId",void 0),f(this,"peerConn",void 0),f(this,"toDeviceSeq",0),f(this,"isPtt",!1),f(this,"_state",_e.Fledgling),f(this,"client",void 0),f(this,"forceTURN",void 0),f(this,"turnServers",void 0),f(this,"candidateSendQueue",[]),f(this,"candidateSendTries",0),f(this,"candidatesEnded",!1),f(this,"feeds",[]),f(this,"transceivers",new Map),f(this,"inviteOrAnswerSent",!1),f(this,"waitForLocalAVStream",!1),f(this,"successor",void 0),f(this,"opponentMember",void 0),f(this,"opponentVersion",void 0),f(this,"opponentPartyId",void 0),f(this,"opponentCaps",void 0),f(this,"iceDisconnectedTimeout",void 0),f(this,"iceReconnectionTimeOut",void 0),f(this,"inviteTimeout",void 0),f(this,"removeTrackListeners",new Map),f(this,"remoteOnHold",!1),f(this,"callStatsAtEnd",void 0),f(this,"makingOffer",!1),f(this,"ignoreOffer",!1),f(this,"isSettingRemoteAnswerPending",!1),f(this,"responsePromiseChain",void 0),f(this,"remoteCandidateBuffer",new Map),f(this,"remoteAssertedIdentity",void 0),f(this,"remoteSDPStreamMetadata",void 0),f(this,"callLengthInterval",void 0),f(this,"callStartTime",void 0),f(this,"opponentDeviceId",void 0),f(this,"hasOpponentDeviceInfo",void 0),f(this,"opponentSessionId",void 0),f(this,"groupCallId",void 0),f(this,"stopVideoTrackTimer",void 0),f(this,"isOnlyDataChannelAllowed",void 0),f(this,"stats",void 0),f(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&I.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),I.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),f(this,"onIceGatheringStateChange",a=>{var s;I.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((s=this.peerConn)===null||s===void 0?void 0:s.iceGatheringState)==="complete"&&(this.queueCandidate(null),I.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),f(this,"getLocalOfferFailed",a=>{I.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(Oe.Error,new Vr(Re.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate(lt.Local,Re.LocalOfferFailed,!1)}),f(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}I.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(Oe.Error,new Vr(Re.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate(lt.Local,Re.NoUserMedia,!1)}),f(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}I.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(Oe.Error,new Vr(Re.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate(lt.Local,Re.IceFailed,!1)}),f(this,"onIceConnectionStateChanged",()=>{var a,s,l,u,d,c;if(!this.callHasEnded()){if(I.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((s=this.peerConn)===null||s===void 0?void 0:s.connectionState,")")),["connected","completed"].includes((l=(u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)!==null&&l!==void 0?l:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=_e.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(Oe.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},G1));else if(((d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)=="failed"){var h;if(this.candidatesEnded=!1,(h=this.peerConn)!==null&&h!==void 0&&h.restartIce){var v;this.candidatesEnded=!1,I.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,")")),this.peerConn.restartIce()}else I.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Re.IceFailed,!1)}else((c=this.peerConn)===null||c===void 0?void 0:c.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var p,m,T;I.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((p=this.peerConn)===null||p===void 0?void 0:p.iceConnectionState,", conn=").concat((m=this.peerConn)===null||m===void 0?void 0:m.connectionState,")")),(T=this.peerConn)!==null&&T!==void 0&&T.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},z1),this.iceDisconnectedTimeout=setTimeout(()=>{I.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Re.IceFailed,!1)},H1),this.state=_e.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var g of this.getRemoteFeeds())g.setAudioVideoMuted(!0,!0)}}),f(this,"onSignallingStateChanged",()=>{var a;I.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),f(this,"onTrack",a=>{if(a.streams.length===0){I.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var s=a.streams[0];if(this.pushRemoteFeed(s),!this.removeTrackListeners.has(s)){var l=o(()=>{s.getTracks().length===0&&(I.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(s.id,")")),this.deleteFeedByStream(s),s.removeEventListener("removetrack",l),this.removeTrackListeners.delete(s))},"onRemoveTrack");s.addEventListener("removetrack",l),this.removeTrackListeners.set(s,l)}}),f(this,"onDataChannel",a=>{this.emit(Oe.DataChannel,a.channel,this)}),f(this,"onNegotiationNeeded",R(function*(){if(I.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==_e.CreateOffer&&t.opponentVersion===0){I.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),f(this,"onHangupReceived",a=>{I.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===_e.Ringing?this.terminate(lt.Remote,a.reason||Re.UserHangup,!0):I.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),f(this,"onRejectReceived",a=>{I.debug("Call ".concat(this.callId," onRejectReceived() running"));var s=[_e.InviteSent,_e.Ringing].includes(this.state)||this.state===_e.Fledgling&&this.direction===ni.Inbound;s?this.terminate(lt.Remote,a.reason||Re.UserHangup,!0):I.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),f(this,"onAnsweredElsewhere",a=>{I.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(lt.Remote,Re.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(n=e.forceTURN)!==null&&n!==void 0?n:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[q1]});for(var i of this.turnServers)gR(i,["urls"]);this.callId=Ji(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return R(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return R(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var n=this.peerConn.createDataChannel(e,t);return this.emit(Oe.DataChannel,n,this),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(Oe.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?Gb.Video:Gb.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===qe.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===qe.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(Br(qe.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(Br(qe.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===qe.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===qe.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===qe.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===qe.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return R(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw n?(e.hasOpponentDeviceInfo=!1,new Tc(n)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n){I.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Mn({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:i,videoMuted:a})),this.emit(Oe.FeedsChanged,this.feeds,this),I.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(n,")"))}pushRemoteFeedWithoutMetadata(e){var t,n=this.getOpponentMember().userId,i=qe.Usermedia,a=(t=this.feeds.find(s=>!s.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){I.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Mn({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(Oe.FeedsChanged,this.feeds,this),I.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.client.getUserId();if(mt(e.getAudioTracks(),!0),mt(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new Mn({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){var t=this,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(s=>e.stream.id===s.stream.id)){I.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),n){var i=o(function(){I.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var l=Br(e.purpose,a.kind);if(t.transceivers.has(l)){var u=t.transceivers.get(l);u.sender.replaceTrack(a),u.direction=u.direction==="inactive"?"sendonly":"sendrecv"}else{var d=t.peerConn.addTrack(a,e.stream),c=t.peerConn.getTransceivers().find(h=>h.sender===d);c?t.transceivers.set(l,c):I.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}},"_loop2");for(var a of e.stream.getTracks())i()}I.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(Oe.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=Br(e.purpose,"audio"),n=Br(e.purpose,"video");for(var i of[t,n])if(this.transceivers.has(i)){var a=this.transceivers.get(i);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===qe.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(Oe.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){I.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(Oe.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return R(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return R(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),n=[];return t.forEach(i=>{n.push(i)}),n}})()}initWithInvite(e){var t=this;return R(function*(){var n,i=e.getContent();t.direction=ni.Inbound;var a=yield t.client.checkTurnServers();a||I.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var s=i[Zn];s?t.updateRemoteSDPStreamMetadata(s):I.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(Oe.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(i.offer),I.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(i.offer.type)),yield t.addBufferedIceCandidates()}catch(c){I.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),c),t.terminate(lt.Local,Re.SetRemoteDescription,!1);return}var l=(n=t.feeds.find(c=>!c.isLocal()))===null||n===void 0?void 0:n.stream;if(!t.isOnlyDataChannelAllowed&&(!l||l.getTracks().length===0)){I.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(lt.Local,Re.SetRemoteDescription,!1);return}if(t.state=_e.Ringing,e.getLocalAge()){var u=setTimeout(()=>{if(t.state==_e.Ringing){var c;I.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=lt.Remote,t.state=_e.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(c=t.stats)===null||c===void 0||c.removeStatsReportGatherer(t.callId),t.emit(Oe.Hangup,t)}},i.lifetime-e.getLocalAge()),d=o(c=>{c!==_e.Ringing&&(clearTimeout(u),t.off(Oe.State,d))},"onState");t.on(Oe.State,d)}})()}initWithHangup(e){this.state=_e.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(I.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n," because the other side isn't sending it either.")),!1):!ER(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(I.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n,"=").concat(e," because the other side doesn't support it. Answering with ").concat(n,"=").concat(t,".")),t):e??t}answer(e,t){var n=this;return R(function*(){if(!n.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!n.localUsermediaStream&&!n.waitForLocalAVStream){var i=n.state,a=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),s=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=_e.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var l,u=yield n.client.getMediaHandler().getUserMediaStream(a,s);n.waitForLocalAVStream=!1;var d=new Mn({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(l=n.client.getDeviceId())!==null&&l!==void 0?l:void 0,stream:u,purpose:qe.Usermedia,audioMuted:!1,videoMuted:!1}),c=[d];n.localScreensharingFeed&&c.push(n.localScreensharingFeed),n.answerWithCallFeeds(c)}catch(h){if(s)I.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=i,n.waitForLocalAVStream=!1,yield n.answer(a,!1);else{n.getUserMediaFailed(h);return}}}else n.waitForLocalAVStream&&(n.state=_e.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){I.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===_e.WaitLocalMedia?(I.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[_e.CreateOffer,_e.InviteSent].includes(this.state)&&(e.direction===ni.Outbound?e.queueGotCallFeedsForAnswer([]):(I.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(Oe.Replaced,e,this),this.hangup(Re.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(I.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(lt.Local,e,!t),![_e.Fledgling,_e.WaitLocalMedia].includes(this.state))){var n={};(this.opponentVersion&&this.opponentVersion!==0||e!==Re.UserHangup)&&(n.reason=e),this.sendVoipEvent(B.CallHangup,n)}}reject(){if(this.state!==_e.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){I.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Re.UserHangup,!0);return}I.debug("Rejecting call: "+this.callId),this.terminate(lt.Local,Re.UserHangup,!0),this.sendVoipEvent(B.CallReject,{})}upgradeCall(e,t){var n=this;return R(function*(){if(!(!e&&!t)&&n.opponentSupportsSDPStreamMetadata())try{I.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var i=e||n.hasLocalUserMediaAudioTrack,a=t||n.hasLocalUserMediaVideoTrack,s=yield n.client.getMediaHandler().getUserMediaStream(i,a,!1);yield n.updateLocalUsermediaStream(s,e,t)}catch(l){I.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),l),n.emit(Oe.Error,new Vr(Re.NoUserMedia,"Failed to get camera access: ",l),n)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var n=this;return R(function*(){if(e&&n.isScreensharing())return I.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return I.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(I.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var i=yield n.client.getMediaHandler().getScreensharingStream(t);return i?(n.pushNewLocalFeed(i,qe.Screenshare),!0):!1}catch(u){return I.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),u),!1}else{var a=n.transceivers.get(Br(qe.Screenshare,"audio")),s=n.transceivers.get(Br(qe.Screenshare,"video"));for(var l of[a,s])l&&l.sender&&n.peerConn.removeTrack(l.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return R(function*(){if(I.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var i,a=yield n.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var s=a.getTracks().find(v=>v.kind==="video"),l=(i=n.transceivers.get(Br(qe.Usermedia,"video")))===null||i===void 0?void 0:i.sender;return l==null||l.replaceTrack(s??null),n.pushNewLocalFeed(a,qe.Screenshare,!1),!0}catch(v){return I.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),v),!1}else{var u,d,c=(u=n.localUsermediaStream)===null||u===void 0?void 0:u.getTracks().find(v=>v.kind==="video"),h=(d=n.transceivers.get(Br(qe.Usermedia,"video")))===null||d===void 0?void 0:d.sender;return h==null||h.replaceTrack(c??null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,s=n.localUsermediaFeed,l=i||!s.isAudioMuted()&&!n.remoteOnHold,u=a||!s.isVideoMuted()&&!n.remoteOnHold;I.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(l,", video=").concat(u,")")),mt(e.getAudioTracks(),l),mt(e.getVideoTracks(),u);for(var d of n.localUsermediaStream.getTracks())n.localUsermediaStream.removeTrack(d),d.stop();for(var c of e.getTracks())n.localUsermediaStream.addTrack(c);var h=o(function*(){var p=Br(qe.Usermedia,v.kind),m=n.transceivers.get(p),T=m==null?void 0:m.sender,y=!1;if(T)try{I.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")")),yield T.replaceTrack(v),m.direction=m.direction==="inactive"?"sendonly":"sendrecv",y=!0}catch(C){I.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),C)}if(!y){I.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")"));var S=n.peerConn.addTrack(v,n.localUsermediaStream),w=n.peerConn.getTransceivers().find(C=>C.sender===S);w?n.transceivers.set(p,w):I.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}},"_loop22");for(var v of e.getTracks())yield*h()})()}setLocalVideoMuted(e){var t=this;return R(function*(){var n;if(I.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var i;return(i=t.localUsermediaFeed)===null||i===void 0||i.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var s of t.localUsermediaStream.getVideoTracks())s.stop(),t.localUsermediaStream.removeTrack(s)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return R(function*(){var n;return I.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(Oe.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==_e.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var n;if(((n=t.track)===null||n===void 0?void 0:n.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;I.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),mt(this.localUsermediaStream.getAudioTracks(),!e),mt(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return R(function*(){yield e.sendVoipEvent(B.CallSDPStreamMetadataChangedPrefix,{[Zn]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var n of e)this.pushLocalFeed(n);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=_e.CreateOffer,I.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return R(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[Zn]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var n=e.discardDuplicateCandidates();I.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(n," candidates that will be sent in answer"));try{yield e.sendVoipEvent(B.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(s){e.state=_e.Ringing,s instanceof dt&&s.event&&e.client.cancelPendingEvent(s.event);var i=Re.SendAnswer,a="Failed to send answer";throw s.name=="UnknownDeviceError"&&(i=Re.UnknownDevices,a="Unknown devices present in the room"),e.emit(Oe.Error,new Vr(i,a,s),e),s}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var n=wI(e.sdp);n.media.forEach(i=>{var a=new Map,s=new Map;for(var l of i.rtp)a.set(l.payload,l.codec),s.set(l.codec,l.payload);for(var u of t)if(u.mediaType===i.type){if(!s.has(u.codec)){I.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(u.codec," as it's not present."));continue}var d=[];u.enableDtx!==void 0&&d.push("usedtx=".concat(u.enableDtx?"1":"0")),u.maxAverageBitrate!==void 0&&d.push("maxaveragebitrate=".concat(u.maxAverageBitrate));var c=!1;for(var h of i.fmtp)a.get(h.payload)===u.codec&&(c=!0,h.config+=";"+d.join(";"));c||i.fmtp.push({payload:s.get(u.codec),config:d.join(";")})}}),e.sdp=M1(n)}createOffer(){var e=this;return R(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,Hb(e.isPtt)),t})()}createAnswer(){var e=this;return R(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,Hb(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return R(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var n of e)t.pushLocalFeed(n);t.state=_e.CreateAnswer;var i;try{t.getRidOfRTXCodecs(),i=yield t.createAnswer()}catch(a){I.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate(lt.Local,Re.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(i),t.callHasEnded()||(t.state=_e.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){I.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate(lt.Local,Re.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return R(function*(){if(!t.callHasEnded()){var n=e.getContent(),i=n.candidates;if(!i){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=n.version===0?null:n.party_id||null;if(t.opponentPartyId===void 0){if(a){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(i.length," candidates until we pick an opponent"));var s=t.remoteCandidateBuffer.get(a)||[];s.push(...i),t.remoteCandidateBuffer.set(a,s)}return}if(!t.partyIdMatches(n)){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(n.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(i)}})()}onAnswerReceived(e){var t=this;return R(function*(){var n=e.getContent();if(I.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(n.party_id,")")),t.callHasEnded()){I.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){I.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(n.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=_e.Connecting;var i=n[Zn];i?t.updateRemoteSDPStreamMetadata(i):I.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(n.answer),t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(n.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate(lt.Local,Re.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(B.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){I.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return R(function*(){if(t.direction!==ni.Inbound){I.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var n=e.getContent().selected_party_id;if(n==null){I.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}n!==t.ourPartyId&&(I.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(n,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(lt.Remote,Re.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return R(function*(){var n=e.getContent(),i=n.description;if(!i||!i.sdp||!i.type){I.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===ni.Inbound,s=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),l=i.type==="offer"&&!s;if(t.ignoreOffer=!a&&l,t.ignoreOffer){I.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var u=t.isLocalOnHold(),d=n[Zn];d?t.updateRemoteSDPStreamMetadata(d):I.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=i.type=="answer",yield t.peerConn.setRemoteDescription(i),t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(i.type)),i.type==="offer"){var c,h;try{t.getRidOfRTXCodecs(),h=yield t.createAnswer()}catch(g){I.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),g),t.terminate(lt.Local,Re.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(h),I.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(B.CallNegotiate,{lifetime:Mf,description:(c=t.peerConn.localDescription)===null||c===void 0?void 0:c.toJSON(),[Zn]:t.getLocalSDPStreamMetadata(!0)})}}catch(g){t.isSettingRemoteAnswerPending=!1,I.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),g)}var v=t.isLocalOnHold();u!==v&&(t.emit(Oe.LocalHoldUnhold,v,t),t.emit(Oe.HoldUnhold,v))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=_R(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var n,i=t.stream.id,a=this.remoteSDPStreamMetadata[i];t.setAudioVideoMuted(a==null?void 0:a.audio_muted,a==null?void 0:a.video_muted),t.purpose=(n=this.remoteSDPStreamMetadata[i])===null||n===void 0?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),n=t[Zn];this.updateRemoteSDPStreamMetadata(n)}onAssertedIdentityReceived(e){var t=this;return R(function*(){var n=e.getContent();n.asserted_identity&&(t.remoteAssertedIdentity={id:n.asserted_identity.id,displayName:n.asserted_identity.display_name},t.emit(Oe.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===_e.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return R(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return R(function*(){if(I.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){I.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(c){I.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),c),e.terminate(lt.Local,Re.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(c){I.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),c),e.terminate(lt.Local,Re.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(c=>{setTimeout(c,200)})),!e.callHasEnded()){var n=e.state===_e.CreateOffer?B.CallInvite:B.CallNegotiate,i={lifetime:Mf};if(n===B.CallInvite&&e.invitee&&(i.invitee=e.invitee),e.state===_e.CreateOffer){var a;i.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var s;i.description=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}i.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},i[Zn]=e.getLocalSDPStreamMetadata(!0);var l=e.discardDuplicateCandidates();I.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(l," candidates that will be sent in offer"));try{yield e.sendVoipEvent(n,i)}catch(c){I.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),c),c instanceof dt&&c.event&&e.client.cancelPendingEvent(c.event);var u=Re.SignallingFailed,d="Signalling failed";e.state===_e.CreateOffer&&(u=Re.SendInvite,d="Failed to send invite"),c.name=="UnknownDeviceError"&&(u=Re.UnknownDevices,d="Unknown devices present in the room"),e.emit(Oe.Error,new Vr(u,d,c),e),e.terminate(lt.Local,u,!1);return}e.sendCandidateQueue(),e.state===_e.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=_e.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===_e.InviteSent&&e.hangup(Re.InviteTimeout,!1)},Mf))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(Br(qe.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,n=RTCRtpSender.getCapabilities("video").codecs,i=[];for(var a of[...t,...n])if(a.mimeType!=="video/rtx"){i.push(a);try{e.setCodecPreferences(i)}catch(s){I.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,s),i.pop()}}}}}sendVoipEvent(e,t){var n=this;return R(function*(){var i=Hu(Hu({},t),{},{version:V1,call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var a,s=n.toDeviceSeq++,l=Hu(Hu({},i),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:s,[Rh]:T1()});n.emit(Oe.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||((a=n.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:n.opponentDeviceId,content:l},n);var u=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo){I.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield n.client.sendToDevice(e,new Map([[u,new Map([[n.opponentDeviceId,l]])]]))}else{var d;n.emit(Oe.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:i,userId:n.invitee||((d=n.getOpponentMember())===null||d===void 0?void 0:d.userId)},n),yield n.client.sendEvent(n.roomId,e,i)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===_e.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===ni.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],n=0;n<this.candidateSendQueue.length;n++){var i=this.candidateSendQueue[n];i.candidate===""?t.push(i):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return R(function*(){var n=yield t.client.getProfileInfo(e),i=Ji(),a={replacement_id:Ji(),target_user:{id:e,display_name:n.displayname,avatar_url:n.avatar_url},create_call:i};yield t.sendVoipEvent(B.CallReplaces,a),yield t.terminate(lt.Local,Re.Transferred,!0)})()}transferToCall(e){var t=this;return R(function*(){var n,i,a=(n=e.getOpponentMember())===null||n===void 0?void 0:n.userId,s=a?yield t.client.getProfileInfo(a):void 0,l=(i=t.getOpponentMember())===null||i===void 0?void 0:i.userId,u=l?yield t.client.getProfileInfo(l):void 0,d=Ji(),c={replacement_id:Ji(),target_user:{id:l,display_name:u==null?void 0:u.displayname,avatar_url:u==null?void 0:u.avatar_url},await_call:d};yield e.sendVoipEvent(B.CallReplaces,c);var h={replacement_id:Ji(),target_user:{id:a,display_name:s==null?void 0:s.displayname,avatar_url:s==null?void 0:s.avatar_url},create_call:d};yield t.sendVoipEvent(B.CallReplaces,h),yield t.terminate(lt.Local,Re.Transferred,!0),yield e.terminate(lt.Local,Re.Transferred,!0)})()}terminate(e,t,n){var i=this;return R(function*(){var a;if(!i.callHasEnded()){i.hangupParty=e,i.hangupReason=t,i.state=_e.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),i.iceDisconnectedTimeout!==void 0&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),i.stopVideoTrackTimer!==void 0&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0);for(var[s,l]of i.removeTrackListeners)s.removeEventListener("removetrack",l);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&i.peerConn.signalingState!=="closed"&&i.peerConn.close(),(a=i.stats)===null||a===void 0||a.removeStatsReportGatherer(i.callId),n&&i.emit(Oe.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}})()}stopAllMedia(){I.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===qe.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===qe.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){I.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(xR.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return R(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var n={candidates:t.map(l=>l.toJSON())};e.candidatesEnded&&n.candidates.push({candidate:""}),I.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(B.CallCandidates,n),e.candidateSendTries=0,e.sendCandidateQueue()}catch(l){if(l instanceof dt&&l.event&&e.client.cancelPendingEvent(l.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){I.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),l);var i=Re.SignallingFailed,a="Signalling failed";e.emit(Oe.Error,new Vr(i,a,l),e),e.hangup(i,!1);return}var s=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,I.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(s,"ms"),l),setTimeout(()=>{e.sendCandidateQueue()},s)}}})()}placeCall(e,t){var n=this;return R(function*(){if(!e)throw new Error("You CANNOT start a call without audio");n.state=_e.WaitLocalMedia;var i;try{var a,s=yield n.client.getMediaHandler().getUserMediaStream(e,t);mt(s.getAudioTracks(),!0),mt(s.getVideoTracks(),!0),i=new Mn({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(a=n.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:s,purpose:qe.Usermedia,audioMuted:!1,videoMuted:!1})}catch(l){n.getUserMediaFailed(l);return}try{yield n.placeCallWithCallFeeds([i])}catch(l){n.placeCallFailed(l);return}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;n.checkForErrorListener(),n.direction=ni.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n);var a=yield n.client.checkTurnServers();a||I.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(Oe.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,i)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var n=this.getOpponentMember(),i=n?n.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,i,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,n=e.getContent();if(I.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var i;(i=this.stats)===null||i===void 0||i.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return R(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(I.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return R(function*(){for(var n of e){(n.sdpMid===null||n.sdpMid===void 0)&&(n.sdpMLineIndex===null||n.sdpMLineIndex===void 0)?I.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):I.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(n.sdpMid,", candidate=").concat(n.candidate,")"));try{yield t.peerConn.addIceCandidate(n)}catch(i){t.ignoreOffer?I.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),i):I.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),i)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}};o(yS,"MatrixCall");let em=yS;function mt(r,e){for(var t of r)t.enabled=e}o(mt,"setTracksEnabled");function tm(){if(typeof window>"u"||typeof document>"u")return!1;try{var r,e,t,n=!!((r=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&r!==void 0?r:navigator.mediaDevices);if(!n)return I.error("WebRTC is not supported in this browser / environment"),!1}catch(i){return I.error("Exception thrown when trying to access WebRTC",i),!1}return!0}o(tm,"supportsMatrixCall");function Bl(r,e,t){if(!tm())return null;var n=t?t.forceTURN:!1,i={client:r,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:r.getTurnServers(),forceTURN:r.forceTURN||n,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},a=new em(i);return r.reEmitter.reEmit(a,Object.values(Oe)),a}o(Bl,"createNewMatrixCall");var Ii=function(r){return r.DontNotify="dont_notify",r.Notify="notify",r.Coalesce="coalesce",r}({}),ny=function(r){return r.Highlight="highlight",r.Sound="sound",r}({}),J1=function(r){return r.ExactEquals="==",r.LessThan="<",r.GreaterThan=">",r.GreaterThanOrEqual=">=",r.LessThanOrEqual="<=",r}({}),Q1="2";function Y1(r){return r==="==2"||r==="2"}o(Y1,"isDmMemberCountCondition");var gt=function(r){return r.EventMatch="event_match",r.EventPropertyIs="event_property_is",r.EventPropertyContains="event_property_contains",r.ContainsDisplayName="contains_display_name",r.RoomMemberCount="room_member_count",r.SenderNotificationPermission="sender_notification_permission",r.CallStarted="call_started",r.CallStartedPrefix="org.matrix.msc3914.call_started",r}({}),xt=function(r){return r.Override="override",r.ContentSpecific="content",r.RoomSpecific="room",r.SenderSpecific="sender",r.Underride="underride",r}({}),Mt=function(r){return r.Master=".m.rule.master",r.IsUserMention=".m.rule.is_user_mention",r.IsRoomMention=".m.rule.is_room_mention",r.ContainsDisplayName=".m.rule.contains_display_name",r.ContainsUserName=".m.rule.contains_user_name",r.AtRoomNotification=".m.rule.roomnotif",r.DM=".m.rule.room_one_to_one",r.EncryptedDM=".m.rule.encrypted_room_one_to_one",r.Message=".m.rule.message",r.EncryptedMessage=".m.rule.encrypted",r.InviteToSelf=".m.rule.invite_for_me",r.MemberEvent=".m.rule.member_event",r.IncomingCall=".m.rule.call",r.SuppressNotices=".m.rule.suppress_notices",r.Tombstone=".m.rule.tombstone",r.PollStart=".m.rule.poll_start",r.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",r.PollEnd=".m.rule.poll_end",r.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",r.PollStartOneToOne=".m.rule.poll_start_one_to_one",r.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",r.PollEndOneToOne=".m.rule.poll_end_one_to_one",r.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",r}({});function zb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(zb,"ownKeys$8");function Jb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):zb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Jb,"_objectSpread$8");var Qb=[xt.Override,xt.ContentSpecific,xt.RoomSpecific,xt.SenderSpecific,xt.Underride],X1={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:gt.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:gt.SenderNotificationPermission,key:"room"}],actions:[Ii.Notify,{set_tweak:ny.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:gt.EventMatch,key:"type",pattern:"m.reaction"}],actions:[Ii.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:gt.EventMatch,key:"type",pattern:B.RoomServerAcl},{kind:gt.EventMatch,key:"state_key",pattern:""}],actions:[]}},iy=Symbol("UserDefinedRules"),Z1=[Mt.Master,iy,Mt.SuppressNotices,Mt.InviteToSelf,Mt.MemberEvent,Mt.IsUserMention,Mt.ContainsDisplayName,Mt.IsRoomMention,Mt.AtRoomNotification,Mt.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],eN={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:gt.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:gt.CallStarted}],actions:[Ii.Notify,{set_tweak:ny.Sound,value:"default"}]}},tN=[iy,Mt.IncomingCall,".org.matrix.msc3914.rule.room.call",Mt.EncryptedDM,Mt.DM,Mt.Message,Mt.EncryptedMessage];function Yb(r,e,t,n,i){var a=t.filter(p=>p.default),s=t.filter(p=>!p.default);function l(p){p===iy?d.push(...s):p in n?(r.warn("Adding default global ".concat(e," push rule ").concat(p)),d.push(n[p])):r.warn("Missing default global ".concat(e," push rule ").concat(p))}o(l,"insertDefaultPushRule");var u=0,d=[];for(var c of a){var h=i.indexOf(c.rule_id);if(h===-1){d.push(c);continue}for(;h>u;){var v=i[u];l(v),u+=1}d.push(c),u+=1}for(var g of i.slice(u))l(g);return d}o(Yb,"mergeRulesWithDefaults");const un=class un{constructor(e){this.client=e,f(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var n of e)n===Ii.Notify?t.notify=!0:typeof n=="object"&&(n.value===void 0&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t){var n=JSON.parse(JSON.stringify(t));return n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]),n.global.override=Yb(e,xt.Override,n.global.override,X1,Z1),n.global.underride=Yb(e,xt.Underride,n.global.underride,eN,tN),n}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[i,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],s="".concat(t,"-").concat(n,"-").concat(e);return un.cachedGlobToRegex[s]||(un.cachedGlobToRegex[s]=new RegExp(i+"("+SR(e)+")"+a,n)),un.cachedGlobToRegex[s]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var i of n)if(i.conditions)for(var a of i.conditions)a.kind===gt.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,un.partsForDottedKey(a.key)));t.forEach(s=>this.parsedKeys.delete(s))}matchingRuleFromKindSet(e,t){for(var n of Qb){var i=t[n];if(i){for(var a of i)if(a.enabled){var s=this.templateRuleToRaw(n,a);if(s&&this.ruleMatchesEvent(s,e))return Jb(Jb({},a),{},{kind:n})}}}return null}templateRuleToRaw(e,t){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case xt.Underride:case xt.Override:n.conditions=t.conditions;break;case xt.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:gt.EventMatch,key:"room_id",value:t.rule_id});break;case xt.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:gt.EventMatch,key:"user_id",value:t.rule_id});break;case xt.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:gt.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case gt.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case gt.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case gt.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case gt.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case gt.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case gt.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case gt.CallStarted:case gt.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var n=e.key;if(!n)return!1;var i=this.client.getRoom(t.getRoomId());return i!=null&&i.currentState?i.currentState.mayTriggerNotifOfType(n,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var s=a[1],l=parseInt(a[2]);if(isNaN(l))return!1;switch(s){case"":case"==":return i==l;case"<":return i<l;case">":return i>l;case"<=":return i<=l;case">=":return i>=l;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n,i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||typeof i.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),s=a==null||(n=a.currentState)===null||n===void 0?void 0:n.getMember(this.client.credentials.userId);if(!s)return!1;var l=s.name,u=new RegExp("(^|\\W)"+yR(l)+"(\\W|$)","i");return i.body.search(u)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var n=this.valueForDottedKey(e.key,t);if(typeof n!="string")return!1;if(e.value)return e.value===n;if(typeof e.pattern!="string")return!1;var i=un.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!n.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var n=this.valueForDottedKey(e.key,t);return Array.isArray(n)?n.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||qs(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],n="",i=!1;for(var a of e){if(i){a==="\\"||a==="."?n+=a:n+="\\"+a,i=!1;continue}a=="."?(t.push(n),n=""):a=="\\"?i=!0:n+=a}return i&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){var n=this.parsedKeys.get(e);n===void 0&&(n=un.partsForDottedKey(e),this.parsedKeys.set(e,n));var i,a=n[0],s=0;for(a==="content"?(i=t.getContent(),++s):a==="type"?(i=t.getType(),++s):i=t.event;s<n.length;++s){if(ER(i))return;var l=n[s];i=i[l]}return i}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};var i=un.actionListToActionsObject(n.actions);return i.tweaks.highlight===void 0&&(i.tweaks.highlight=n.kind==xt.ContentSpecific),{actions:i,rule:n}}ruleMatchesEvent(e,t){var n;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===Mt.ContainsUserName||e.rule_id===Mt.ContainsDisplayName||e.rule_id===Mt.AtRoomNotification)?!1:!((n=e.conditions)!==null&&n!==void 0&&n.some(i=>!this.eventFulfillsCondition(i,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,n=this.getPushRuleAndKindById(e);return(t=n==null?void 0:n.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var n;if(((n=this.client.pushRules)===null||n===void 0?void 0:n[t])!==void 0){for(var i of Qb)if(this.client.pushRules[t][i]!==void 0){for(var a of this.client.pushRules[t][i])if(a.rule_id===e)return{rule:a,kind:i}}}}return null}};o(un,"PushProcessor");let $l=un;f($l,"cachedGlobToRegex",{});var Wl=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],rN=Wl[0],nN=Wl[Wl.length-1],Er=function(r){return r.SUCCESS="SUCCESS",r.IGNORE="IGNORE",r.PROMPT="PROMPT",r.FAIL_PROMPT="FAIL_PROMPT",r.FAIL_ERROR="FAIL_ERROR",r}({}),jr=function(r){return r.Invalid="Invalid homeserver discovery response",r.GenericFailure="Failed to get autodiscovery configuration from server",r.InvalidHsBaseUrl="Invalid base_url for m.homeserver",r.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",r.InvalidIsBaseUrl="Invalid base_url for m.identity_server",r.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",r.InvalidIs="Invalid identity server discovery response",r.MissingWellknown="No .well-known JSON file found",r.InvalidJson="Invalid JSON",r.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",r}({});const Ne=class Ne{static fromDiscoveryConfig(e){var t=this;return R(function*(){var n,i={"m.homeserver":{state:Ne.FAIL_ERROR,error:Ne.ERROR_INVALID,base_url:null},"m.identity_server":{state:Ne.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return I.error("No m.homeserver key in config"),i["m.homeserver"].state=Ne.FAIL_PROMPT,i["m.homeserver"].error=Ne.ERROR_INVALID,Promise.resolve(i);if(!e["m.homeserver"].base_url)return I.error("No m.homeserver base_url in config"),i["m.homeserver"].state=Ne.FAIL_PROMPT,i["m.homeserver"].error=Ne.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return I.error("Invalid base_url for m.homeserver"),i["m.homeserver"].error=Ne.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var s=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!s||!Array.isArray((n=s.raw)===null||n===void 0?void 0:n.versions))return I.error("Invalid /versions response"),i["m.homeserver"].error=Ne.ERROR_INVALID_HOMESERVER,i["m.homeserver"].base_url=a,Promise.resolve(i);var l=new Set(s.raw.versions),u=!1;for(var d of Wl)if(l.has(d)){u=!0;break}if(!u)return I.error("Homeserver does not meet version requirements"),i["m.homeserver"].error=Ne.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,i["m.homeserver"].base_url=a,Promise.resolve(i);i["m.homeserver"]={state:Ne.SUCCESS,error:null,base_url:a};var c="";if(e["m.identity_server"]){var h={"m.homeserver":i["m.homeserver"],"m.identity_server":{state:Ne.FAIL_PROMPT,error:Ne.ERROR_INVALID_IS,base_url:null}};if(c=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!c)return I.error("Invalid base_url for m.identity_server"),h["m.identity_server"].error=Ne.ERROR_INVALID_IS_BASE_URL,Promise.resolve(h);var v=yield t.fetchWellKnownObject("".concat(c,"/_matrix/identity/v2"));if(!(v!=null&&v.raw)||v.action!==Er.SUCCESS)return I.error("Invalid /v2 response"),h["m.identity_server"].error=Ne.ERROR_INVALID_IDENTITY_SERVER,h["m.identity_server"].base_url=c,Promise.resolve(h)}return c&&c.toString().length>0&&(i["m.identity_server"]={state:Ne.SUCCESS,error:null,base_url:c}),Object.keys(e).forEach(g=>{if(g==="m.homeserver"||g==="m.identity_server"){var p=["error","state","base_url"];for(var m of Object.keys(e[g]))p.includes(m)||(i[g][m]=e[g][m])}else i[g]=e[g]}),Promise.resolve(i)})()}static findClientConfig(e){var t=this;return R(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n={"m.homeserver":{state:Ne.FAIL_ERROR,error:Ne.ERROR_INVALID,base_url:null},"m.identity_server":{state:Ne.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(i,"/.well-known/matrix/client"));return!a||a.action!==Er.SUCCESS?(I.error("No response or error when parsing .well-known"),a.reason&&I.error(a.reason),a.action===Er.IGNORE?n["m.homeserver"]={state:Ne.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=Ne.FAIL_PROMPT,n["m.homeserver"].error=Ne.ERROR_INVALID),Promise.resolve(n)):Ne.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return R(function*(){var n;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var i=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return i?(n=i.raw)!==null&&n!==void 0?n:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,n;try{n=new URL(e)}catch(l){I.error("Could not parse url",l)}if(!((t=n)!==null&&t!==void 0&&t.hostname)||n.protocol!=="http:"&&n.protocol!=="https:")return!1;var i=n.port?":".concat(n.port):"",a=n.pathname?n.pathname:"",s="".concat(n.protocol,"//").concat(n.hostname).concat(i).concat(a);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(l){return I.error(l),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){Ne.fetchFn=e}static fetchWellKnownObject(e){return R(function*(){var t;try{if(t=yield Ne.fetch(e,{method:G.Get,signal:kh(5e3)}),t.status===404)return{raw:{},action:Er.IGNORE,reason:Ne.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:Er.FAIL_PROMPT,reason:"General failure"}}catch(s){var n=s,i="";return typeof n=="object"&&(i=n==null?void 0:n.message),{error:n,raw:{},action:Er.FAIL_PROMPT,reason:i||"General failure"}}try{return{raw:yield t.json(),action:Er.SUCCESS}}catch(s){var a=s;return{error:a,raw:{},action:Er.FAIL_PROMPT,reason:(a==null?void 0:a.name)==="SyntaxError"?Ne.ERROR_INVALID_JSON:Ne.ERROR_INVALID}}})()}};o(Ne,"AutoDiscovery");let Et=Ne;f(Et,"ERROR_INVALID",jr.Invalid);f(Et,"ERROR_GENERIC_FAILURE",jr.GenericFailure);f(Et,"ERROR_INVALID_HS_BASE_URL",jr.InvalidHsBaseUrl);f(Et,"ERROR_INVALID_HOMESERVER",jr.InvalidHomeserver);f(Et,"ERROR_INVALID_IS_BASE_URL",jr.InvalidIsBaseUrl);f(Et,"ERROR_INVALID_IDENTITY_SERVER",jr.InvalidIdentityServer);f(Et,"ERROR_INVALID_IS",jr.InvalidIs);f(Et,"ERROR_MISSING_WELLKNOWN",jr.MissingWellknown);f(Et,"ERROR_INVALID_JSON",jr.InvalidJson);f(Et,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",jr.UnsupportedHomeserverSpecVersion);f(Et,"ALL_ERRORS",Object.keys(jr));f(Et,"FAIL_ERROR",Er.FAIL_ERROR);f(Et,"FAIL_PROMPT",Er.FAIL_PROMPT);f(Et,"PROMPT",Er.PROMPT);f(Et,"SUCCESS",Er.SUCCESS);f(Et,"fetchFn",void 0);var rm=function(r){return r.IS="SERVICE_TYPE_IS",r.IM="SERVICE_TYPE_IM",r}({});const SS=class SS{constructor(e){this.ourEvent=e,f(this,"timeline",void 0),f(this,"ourEventIndex",0),f(this,"paginateTokens",{[Ie.Backward]:null,[Ie.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?Ie.Backward:Ie.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?Ie.Backward:Ie.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}};o(SS,"EventContext");let nm=SS;const Yc=class Yc{static fromJson(e,t){var n=e.context||{},i=(n.events_before||[]).map(t),a=(n.events_after||[]).map(t),s=new nm(t(e.result)),l=s.ourEvent.threadRootId;return i=i.filter(u=>u.threadRootId===l),a=a.filter(u=>u.threadRootId===l),s.setPaginateToken(n.start,!0),s.addEvents(i,!0),s.addEvents(a,!1),s.setPaginateToken(n.end,!1),new Yc(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}};o(Yc,"SearchResult");let Rc=Yc;var iN=function(r){return r.Public="public",r.Private="private",r}({}),ay=function(r){return r.PrivateChat="private_chat",r.TrustedPrivateChat="trusted_private_chat",r.PublicChat="public_chat",r}({}),II=function(r){return r.Public="public",r.Invite="invite",r.Private="private",r.Knock="knock",r.Restricted="restricted",r}({}),aN=function(r){return r.RoomMembership="m.room_membership",r}({}),Ic=function(r){return r.CanJoin="can_join",r.Forbidden="forbidden",r}({}),sy=function(r){return r.Invited="invited",r.Joined="joined",r.Shared="shared",r.WorldReadable="world_readable",r}({});function Xb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Xb,"ownKeys$7");function Zb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Xb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Xb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Zb,"_objectSpread$7");function sN(r,e){var t=!!e.preventReEmit,n=e.decrypt!==!1;function i(a){var s=r.getRoom(a.room_id),l;s&&a.state_key===void 0&&(l=s.findEventById(a.event_id)),!l||l.status?l=new qt(a):(l.setUnsigned(Zb(Zb({},l.getUnsigned()),a.unsigned)),t=!0);var u=l.getServerAggregatedRelation(Xe.Replace);if(u!=null&&u.content){var d=i(u);l.makeReplaced(d)}var c=s==null?void 0:s.findThreadForEvent(l);return c&&l.setThread(c),l.isEncrypted()&&(t||r.reEmitter.reEmit(l,[Le.Decrypted]),n&&r.decryptEventIfNeeded(l)),t||(r.reEmitter.reEmit(l,[Le.Replaced,Le.VisibilityChange]),s==null||s.reEmitter.reEmit(l,[Le.BeforeRedaction])),l}return o(i,"mapper"),i}o(sN,"eventMapperFor");function e0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(e0,"ownKeys$6");function ei(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?e0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):e0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(ei,"_objectSpread$6");const ES=class ES{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return R(function*(){yield e.client.sendStateEvent(e.roomId,Pn.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,Pn.name,ei(ei({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,Pn.name,ei(ei({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return R(function*(){var t=yield e.getFileEvent(),n=t.getOriginalContent().file,i=e.client.mxcUrlToHttp(n.url);if(!i)throw new Error("No HTTP URL available for ".concat(n.url));return{info:n,httpUrl:i}})()}getFileEvent(){var e=this;return R(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var n=t.getUnfilteredTimelineSet().findEventById(e.id);!n&&t.getLiveTimeline().getState(he.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),n=t.getUnfilteredTimelineSet().findEventById(e.id);if(!n)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(n),n})()}createNewVersion(e,t,n,i){var a=this;return R(function*(){var s=yield a.directory.createFile(e,t,n,ei(ei({},i??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Xe.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,Pn.name,{active:!0,name:e,version:a.version+1},s.event_id),yield a.client.sendStateEvent(a.roomId,Pn.name,ei(ei({},a.indexEvent.getContent()),{},{active:!1}),a.id),s})()}getVersionHistory(){var e=this;return R(function*(){var t=[];t.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw new Error("Invalid or unknown room");var i=[...n.getLiveTimeline().getEvents()].reverse(),a,s=yield e.getFileEvent();do if(a=i.find(u=>u.replacingEventId()===s.getId()),a){var l=e.directory.getFile(a.getId());if(l)t.push(l),s=a;else break}while(a);return t})()}};o(ES,"MSC3089Branch");let Cc=ES;function t0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(t0,"ownKeys$5");function $i(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?t0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):t0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o($i,"_objectSpread$5");var oN={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[B.RoomPowerLevels]:100,[B.RoomHistoryVisibility]:100,[B.RoomTombstone]:100,[B.RoomEncryption]:100,[B.RoomName]:50,[B.RoomMessage]:50,[B.RoomMessageEncrypted]:50,[B.Sticker]:50},users:{}},Da=function(r){return r.Viewer="viewer",r.Editor="editor",r.Owner="owner",r}({});const _S=class _S{constructor(e,t){if(this.client=e,this.roomId=t,f(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(B.SpaceParent);return e!=null&&e.length?e.every(t=>{var n;return!((n=t.getContent())!==null&&n!==void 0&&n.via)}):!0}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,B.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=[n.retryInvite(e)];i&&a.push(...n.getDirectories().map(s=>s.invite(e,i))),yield Promise.all(a)})()}retryInvite(e){var t=this;return BM(R(function*(){yield t.client.invite(t.roomId,e).catch(n=>{throw(n==null?void 0:n.errcode)==="M_FORBIDDEN"?new mR.AbortError(n):n})}))}setPermissions(e,t){var n=this;return R(function*(){var i,a=n.room.currentState.getStateEvents(B.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var s=(a==null?void 0:a.getContent())||{},l=s.users_default||0,u=s.events_default||50,d=((i=s.events)===null||i===void 0?void 0:i[B.RoomPowerLevels])||100,c=s.users||{};switch(t){case Da.Viewer:c[e]=l;break;case Da.Editor:c[e]=u;break;case Da.Owner:c[e]=d;break;default:throw new Error("Invalid role: "+t)}s.users=c,yield n.client.sendStateEvent(n.roomId,B.RoomPowerLevels,s,"")})()}getPermissions(e){var t,n,i=this.room.currentState.getStateEvents(B.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var a=(i==null?void 0:i.getContent())||{},s=a.users_default||0,l=a.events_default||50,u=((t=a.events)===null||t===void 0?void 0:t[B.RoomPowerLevels])||100,d=((n=a.users)===null||n===void 0?void 0:n[e])||s;return d>=u?Da.Owner:d>=l?Da.Editor:Da.Viewer}createDirectory(e){var t=this;return R(function*(){var n=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,B.SpaceChild,{via:[t.client.getDomain()]},n.roomId),yield t.client.sendStateEvent(n.roomId,B.SpaceParent,{via:[t.client.getDomain()]},t.roomId),n})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(B.SpaceChild);for(var n of t)try{var i=n.getStateKey();if(i){var a=this.client.unstableGetFileTreeSpace(i);a&&e.push(a)}}catch(s){I.warn("Unable to create tree space instance for listing. Are we joined?",s)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return R(function*(){var t=e.getDirectories();for(var n of t)yield n.delete();var i=[Te.Invite,Te.Knock,Te.Join],a=e.room.currentState.getStateEvents(B.RoomMember);for(var s of a){var l=s.getStateKey()!==e.client.getUserId();if(l&&i.includes(s.getContent().membership)){var u=s.getStateKey();if(!u)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,u,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(n=>({roomId:n.getStateKey(),order:n.getContent().order})).filter(n=>n.roomId);return t.sort((n,i)=>{if(n.order&&!i.order)return-1;if(!n.order&&i.order)return 1;if(!n.order&&!i.order){var a,s,l,u,d=this.client.getRoom(n.roomId),c=this.client.getRoom(i.roomId);if(!d||!c)return dd(n.roomId,i.roomId);var h=(a=(s=d.currentState.getStateEvents(B.RoomCreate,""))===null||s===void 0?void 0:s.getTs())!==null&&a!==void 0?a:0,v=(l=(u=c.currentState.getStateEvents(B.RoomCreate,""))===null||u===void 0?void 0:u.getTs())!==null&&l!==void 0?l:0;return h===v?dd(n.roomId,i.roomId):h-v}else return dd(n.order,i.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(B.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var n=t.getStateKey();if(!n)throw new Error("No state key found for parent");var i=this.client.getRoom(n);if(!i)throw new Error("Unable to locate room for parent");return i}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(B.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex(i=>i.roomId===this.roomId)}setOrder(e){var t=this;return R(function*(){var n;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var i=t.getParentRoom(),a=i.currentState.getStateEvents(B.SpaceChild),s=t.getOrderedChildren(a);e=Math.max(Math.min(e,s.length-1),0);var l=t.getOrder(),u=l<e;u&&e===s.length-1?e--:!u&&e===0&&e++;var d=s[u?e:e-1],c=s[u?e+1:e],h=Mi[0],v=!1;if(!d)c!=null&&c.order&&(h=J_(c.order));else if(e===s.length-1)c!=null&&c.order&&(h=Io(c.order));else{var g=d==null?void 0:d.order,p=c==null?void 0:c.order;g&&p?g===p?h=Io(g):h=$M(g,p):g?h=Io(g):p?h=J_(p):v=!0}if(v){for(var m,T=0;T<=e;T++){var y=s[T];if(T===0&&(m=y.order),y.order)m=y.order;else{var S;m=m?Io(m):Mi[0];var w=i.currentState.getStateEvents(B.SpaceChild,y.roomId),C=(S=w==null?void 0:w.getContent())!==null&&S!==void 0?S:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,B.SpaceChild,$i($i({},C),{},{order:m}),y.roomId)}}m&&(h=Io(m))}var M=i.currentState.getStateEvents(B.SpaceChild,t.roomId),_=(n=M==null?void 0:M.getContent())!==null&&n!==void 0?n:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,B.SpaceChild,$i($i({},_),{},{order:h}),t.roomId)})()}createFile(e,t,n,i){var a=this;return R(function*(){var{content_uri:s}=yield a.client.uploadContent(t,{includeFilename:!1});n.url=s;var l={msgtype:bn.File,body:e,url:s,file:n};i=i??{},i["m.new_content"]&&(i["m.new_content"]=l);var u=yield a.client.sendMessage(a.roomId,$i($i($i({},i),l),{},{[DR.name]:{}}));return yield a.client.sendStateEvent(a.roomId,Pn.name,{active:!0,name:e},u.event_id),u})()}getFile(e){var t=this.room.currentState.getStateEvents(Pn.name,e);return t?new Cc(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(Pn.name))!==null&&e!==void 0?e:[];return t.map(n=>new Cc(this.client,n,this))}};o(_S,"MSC3089TreeSpace");let Oc=_S;var CI=function(r){return r.Recent="recent",r.Rank="rank",r}({}),Qi=function(r){return r.LocalStreamsChanged="local_streams_changed",r}({});const bS=class bS extends Ge{constructor(e){super(),this.client=e,f(this,"audioInput",void 0),f(this,"audioSettings",void 0),f(this,"videoInput",void 0),f(this,"localUserMediaStream",void 0),f(this,"userMediaStreams",[]),f(this,"screensharingStreams",[]),f(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return R(function*(){I.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return R(function*(){I.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return R(function*(){I.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return R(function*(){I.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return R(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var n of e.client.callEventHandler.calls.values())t.set(n.callId,{audio:n.hasLocalUserMediaAudioTrack,video:n.hasLocalUserMediaVideoTrack});for(var i of e.userMediaStreams){I.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(i.id,")"));for(var a of i.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var s of e.client.callEventHandler.calls.values())if(!(s.callHasEnded()||!t.has(s.callId))){var{audio:l,video:u}=t.get(s.callId);I.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(s.callId,")"));var d=yield e.getUserMediaStream(l,u);s.callHasEnded()||(yield s.updateLocalUsermediaStream(d))}for(var c of e.client.groupCallEventHandler.groupCalls.values())if(c.localCallFeed){I.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(c.groupCallId,")"));var h=yield e.getUserMediaStream(!0,c.type===Mh.Video);c.state!==rt.Ended&&(yield c.updateLocalUsermediaStream(h))}e.emit(Qi.LocalStreamsChanged)}})()}hasAudioDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return I.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return I.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0;return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,a)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,a),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var i=this;return R(function*(){var a=e&&(yield i.hasAudioDevice()),s=t&&(yield i.hasVideoDevice()),l,u=!0;if(i.localUserMediaStream){var d,c;a!==i.localUserMediaStream.getAudioTracks().length>0&&(u=!1),s!==i.localUserMediaStream.getVideoTracks().length>0&&(u=!1),a&&((d=i.localUserMediaStream.getAudioTracks()[0])===null||d===void 0||(d=d.getSettings())===null||d===void 0?void 0:d.deviceId)!==i.audioInput&&(u=!1),s&&((c=i.localUserMediaStream.getVideoTracks()[0])===null||c===void 0||(c=c.getSettings())===null||c===void 0?void 0:c.deviceId)!==i.videoInput&&(u=!1)}else u=!1;if(u){var p;if(l=i.localUserMediaStream.clone(),I.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((p=i.localUserMediaStream)===null||p===void 0?void 0:p.id," newStreamId=").concat(l.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(s,")")),!a)for(var m of l.getAudioTracks())l.removeTrack(m);if(!s)for(var T of l.getVideoTracks())l.removeTrack(T)}else{var h=i.getUserMediaContraints(a,s);l=yield navigator.mediaDevices.getUserMedia(h),I.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(l.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(s,", constraints=").concat(JSON.stringify(h),")"));for(var v of l.getTracks()){var g=v.getSettings();v.kind==="audio"?i.audioInput=g.deviceId:v.kind==="video"&&(i.videoInput=g.deviceId)}n&&(i.localUserMediaStream=l)}return n&&i.userMediaStreams.push(l),i.emit(Qi.LocalStreamsChanged),l})()}stopUserMediaStream(e){I.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.userMediaStreams.indexOf(e);if(n!==-1&&(I.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(Qi.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var i of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(i.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{},i=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var s=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(I.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getUserMedia(s)):(I.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getDisplayMedia(s))}else{var l=t.screensharingStreams[t.screensharingStreams.length-1];I.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(l.id,")")),a=l.clone()}return i&&t.screensharingStreams.push(a),t.emit(Qi.LocalStreamsChanged),a})()}stopScreensharingStream(e){I.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.screensharingStreams.indexOf(e);n!==-1&&(I.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(n,1)),this.emit(Qi.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){I.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var n of this.screensharingStreams)for(var i of n.getTracks())i.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(Qi.LocalStreamsChanged)}getUserMediaContraints(e,t){var n=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:n??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:n??!1,video:!0}}};o(bS,"MediaHandler");let im=bS;var r0=function(r){return r.RequestFinished="FINISHED",r.Complete="COMPLETE",r}({}),mu=function(r){return r.PreProcess="ExtState.PreProcess",r.PostProcess="ExtState.PostProcess",r}({}),am=function(r){return r.RoomData="SlidingSync.RoomData",r.Lifecycle="SlidingSync.Lifecycle",r}({}),lN=3;const wS=class wS{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return mu.PreProcess}onRequest(e){var t=this;return R(function*(){return e&&(I.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}};o(wS,"ExtensionE2EE");let sm=wS;const TS=class TS{constructor(e,t){this.client=e,this.cryptoCallbacks=t,f(this,"nextBatch",null)}name(){return"to_device"}when(){return mu.PreProcess}onRequest(e){var t=this;return R(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return R(function*(){var n=e.events||[],i;t.cryptoCallbacks?i=yield t.cryptoCallbacks.preprocessToDeviceMessages(n):i=n.map(a=>({message:a,encryptionInfo:null})),SI(i,t.client),t.nextBatch=e.next_batch})()}};o(TS,"ExtensionToDevice");let om=TS;const RS=class RS{constructor(e){this.client=e}name(){return"account_data"}when(){return mu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var n in e.rooms){var i=us(t.client,n,e.rooms[n]),a=t.client.getRoom(n);if(!a){I.warn("got account data for room but room doesn't exist on client:",n);continue}a.addAccountData(i),i.forEach(s=>{t.client.emit(de.Event,s)})}})()}processGlobalAccountData(e){var t=us(this.client,void 0,e),n=t.reduce((i,a)=>(i[a.getType()]=this.client.store.getAccountData(a.getType()),i),{});this.client.store.storeAccountDataEvents(t),t.forEach(i=>{if(i.getType()===B.PushRules){var a=i.getContent();this.client.setPushRules(a)}var s=n[i.getType()];return this.client.emit(de.AccountData,i,s),i})}};o(RS,"ExtensionAccountData");let lm=RS;const IS=class IS{constructor(e){this.client=e}name(){return"typing"}when(){return mu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)OI(t.client,n,[e.rooms[n]])})()}};o(IS,"ExtensionTyping");let um=IS;const CS=class CS{constructor(e){this.client=e}name(){return"receipts"}when(){return mu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)OI(t.client,n,[e.rooms[n]])})()}};o(CS,"ExtensionReceipts");let dm=CS;const OS=class OS{constructor(e,t,n,i){this.slidingSync=e,this.client=t,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"lastPos",null),f(this,"failCount",0),f(this,"notifEvents",[]),this.opts=mI(n),this.syncOpts=gI(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ue.Timeline,ue.TimelineReset]),this.slidingSync.on(am.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(am.RoomData,this.onRoomData.bind(this));var a=[new om(this.client,this.syncOpts.cryptoCallbacks),new lm(this.client),new um(this.client),new dm(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new sm(this.syncOpts.cryptoCallbacks)),a.forEach(s=>{this.slidingSync.registerExtension(s)})}onRoomData(e,t){var n=this;return R(function*(){var i=n.client.store.getRoom(e);if(!i){if(!t.initial){n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}i=yI(n.client,e,n.opts)}yield n.processRoomData(n.client,i,t)})()}onLifecycle(e,t,n){switch(n&&this.syncOpts.logger.debug("onLifecycle",e,n),e){case r0.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(Ue.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(Ue.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case r0.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>lN?Ue.Error:Ue.Reconnecting,{error:new dt(n)}),this.shouldAbortSync(new dt(n)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys((t==null?void 0:t.rooms)||[]).length," rooms"));break}}syncLeftRooms(){return R(function*(){return[]})()}peek(e){return R(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,n=new Js(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[ue.Name,ue.Redaction,ue.RedactionCancelled,ue.Receipt,ue.Tags,ue.LocalEchoUpdated,ue.AccountData,ue.MyMembership,ue.Timeline,ue.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[ke.Events,ke.Members,ke.NewMember,ke.Update]),e.currentState.on(ke.NewMember,(t,n,i)=>{var a;i.user=(a=this.client.getUser(i.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(i,[ur.Name,ur.Typing,ur.PowerLevel,ur.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Ue.Error,{error:e}),!0):!1}processRoomData(e,t,n){var i=this;return R(function*(){n=uN(e,t.roomId,n);var a=us(i.client,t.roomId,n.required_state),s=us(i.client,t.roomId,n.timeline,!1),l=[];if(n.limited||n.initial){var u=new Set;t.getLiveTimeline().getEvents().forEach(S=>{u.add(S.getId())});for(var d=[],c=[],h=!1,v=s.length-1;v>=0;v--){var g=s[v];if(u.has(g.getId())){h=!0;continue}h?d.push(g):c.unshift(g)}s=c,d.length>0&&t.addEventsToTimeline(d,!0,!1,t.getLiveTimeline(),n.prev_batch)}var p=t.hasEncryptionStateEvent();if(n.notification_count!=null&&t.setUnreadNotificationCount(De.Total,n.notification_count),n.highlight_count!=null&&(!p||p&&t.getUnreadNotificationCount(De.Highlight)<=0)&&t.setUnreadNotificationCount(De.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var m=us(i.client,t.roomId,n.invite_state);yield i.injectRoomEvents(t,m),n.initial&&(t.recalculate(),i.client.store.storeRoom(t),i.client.emit(de.Room,t)),m.forEach(S=>{i.client.emit(de.Event,S)});return}if(n.limited){var T;t.getLiveTimeline().setPaginationToken((T=n.prev_batch)!==null&&T!==void 0?T:null,he.BACKWARDS)}yield i.injectRoomEvents(t,a,s,n.num_live),t.addEphemeralEvents(l),t.updateMyMembership(Te.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(de.Room,t)),i.addNotifications(s);var y=function(){var S=R(function*(w){e.emit(de.Event,w),w.isState()&&w.getType()==B.RoomEncryption&&i.syncOpts.cryptoCallbacks&&(yield i.syncOpts.cryptoCallbacks.onCryptoEvent(t,w))});return o(function(C){return S.apply(this,arguments)},"processRoomEvent")}();yield Qa(a,y),yield Qa(s,y),l.forEach(function(S){e.emit(de.Event,S)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:[],s=n.length>3&&n[3]!==void 0?n[3]:0,l=e.getLiveTimeline(),u=l.getEvents().length==0;if(u){for(var d of t)i.client.getPushActionsForEvent(d);l.initialiseState(t)}u||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var c=[];s>0&&(c=a.slice(-1*s),a=a.slice(0,-1*c.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),c.length>0&&(yield e.addLiveEvents(c,{fromCache:!1,addToState:!1})),e.recalculate(),i.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Te.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var l=n.events.member;l.getContent().membership===Te.Invite&&(l.getContent().avatar_url=s.avatar_url,l.getContent().displayname=s.displayname,n.setMembershipEvent(l,e.currentState))},function(s){})}})}}retryImmediately(){return!0}sync(){var e=this;return R(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(n){if(e.syncOpts.logger.error("Getting push rules failed",n),e.shouldAbortSync(n))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(de.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var n=this.client.getPushActionsForEvent(t);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}};o(OS,"SlidingSyncSdk");let kc=OS;function uN(r,e,t){if(!t.name)return t;for(var n of t.required_state)if(n.type===B.RoomName&&n.state_key==="")return n.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:B.RoomName,content:{name:t.name},sender:r.getUserId(),origin_server_ts:new Date().getTime()}),t}o(uN,"ensureNameEvent");function us(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,i=r.getEventMapper({decrypt:n});return t.map(function(a){return a.room_id=e,i(a)})}o(us,"mapEvents");function OI(r,e,t){var n=us(r,e,t),i=r.getRoom(e);if(!i){I.warn("got ephemeral events for room but room doesn't exist on client:",e);return}i.addEphemeralEvents(n),n.forEach(a=>{r.emit(de.Event,a)})}o(OI,"processEphemeralEvents");var oy=new pt("m.beacon_info","org.matrix.msc3672.beacon_info"),cm=new pt("m.beacon","org.matrix.msc3672.beacon");const ll=class ll{static RETRY_BACKOFF_RATELIMIT(e,t,n){return hI(n,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===B.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ll.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ll.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,f(this,"queues",{}),f(this,"activeQueues",[]),f(this,"procFn",null),f(this,"processQueue",n=>{var i=this.peekNextEvent(n);if(!i){this.disableQueue(n);return}this.queues[n].length,Promise.resolve().then(()=>this.procFn(i.event)).then(a=>{this.removeNextEvent(n),i.event.getId(),i.resolvers.resolve(a),this.processQueue(n)},a=>{i.attempts+=1;var s=this.retryAlgorithm(i.event,i.attempts,a);i.attempts,i.event.getId(),s===-1?(I.info("Queue '%s' giving up on event %s",n,i.event.getId()),this.clearQueue(n,a)):setTimeout(this.processQueue,s,n)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(n){return n.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var n=!1;return Xd(this.queues[t],i=>i.event.getId()===e.getId()?(n=!0,!0):!1),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var n=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),I.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){I.info("clearing queue '%s'",e);for(var n;n=this.removeNextEvent(e);)n.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}};o(ll,"MatrixScheduler");let Kl=ll;var n0=20;const kS=class kS{constructor(e,t){var n=this;this.client=e,this.logger=t,f(this,"sending",!1),f(this,"running",!0),f(this,"retryTimeout",null),f(this,"retryAttempts",0),f(this,"sendQueue",R(function*(){if(n.retryTimeout!==null&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!(n.sending||!n.running)){n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;var i;try{for(;n.running&&(i=yield n.client.store.getOldestToDeviceBatch(),i!==null);)yield n.sendBatch(i),yield n.client.store.removeToDeviceBatch(i.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(s){++n.retryAttempts;var a=Kl.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,s);if(a===-1){Math.floor(s.httpStatus/100)===4?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield n.client.store.removeToDeviceBatch(i.id)):n.logger.info("Automatic retry limit reached for to-device messages.");return}n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(a,"ms"),s),n.retryTimeout=setTimeout(n.sendQueue,a)}finally{n.sending=!1}}})),f(this,"onResumedSync",(i,a)=>{i===Ue.Syncing&&a!==Ue.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(de.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(de.Sync,this.onResumedSync)}queueBatch(e){var t=this;return R(function*(){for(var n=[],i=0;i<e.batch.length;i+=n0){var a={eventType:e.eventType,batch:e.batch.slice(i,i+n0),txnId:t.client.makeTxnId()};n.push(a);var s=a.batch.map(l=>"".concat(l.userId,"/").concat(l.deviceId," (msgid ").concat(l.payload[Rh],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),s)}yield t.client.store.saveToDeviceBatches(n),t.sendQueue()})()}sendBatch(e){var t=this;return R(function*(){var n=new Jr(()=>new Map);for(var i of e.batch)n.getOrCreate(i.userId).set(i.deviceId,i.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,n,e.txnId)})()}};o(kS,"ToDeviceMessageQueue");let hm=kS;var Af=new nr.UnstableValue("m.policies","org.matrix.msc3847.policies"),zu=new nr.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),i0=function(r){return r.Ban="m.ban",r}({}),ds=function(r){return r.User="m.policy.user",r.Room="m.policy.room",r.Server="m.policy.server",r}({}),a0={[ds.User]:B.PolicyRuleUser,[ds.Room]:B.PolicyRuleRoom,[ds.Server]:B.PolicyRuleServer};const PS=class PS{constructor(e){this.client=e}addRule(e,t,n){var i=this;return R(function*(){var a=yield i.getOrCreateTargetRoom(),s=yield i.client.sendStateEvent(a.roomId,a0[e],{entity:t,reason:n,recommendation:i0.Ban});return s.event_id})()}removeRule(e){var t=this;return R(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return R(function*(){yield t.client.joinRoom(e);var n=(yield t.getOrCreateSourceRooms()).map(i=>i.roomId);return n.includes(e)?!1:(n.push(e),yield t.withIgnoreInvitesPolicies(i=>{i.sources=n}),!0)})()}getRuleForInvite(e){var t=this;return R(function*(){var{sender:n,roomId:i}=e,a=yield t.getOrCreateSourceRooms(),s=n.split(":")[1],l=i.split(":")[1];for(var u of a){var d=u.getUnfilteredTimelineSet().getLiveTimeline().getState(he.FORWARDS);for(var{scope:c,entities:h}of[{scope:ds.Room,entities:[i]},{scope:ds.User,entities:[n]},{scope:ds.Server,entities:[s,l]}]){var v=d.getStateEvents(a0[c]);for(var g of v){var p=g.getContent();if((p==null?void 0:p.recommendation)==i0.Ban){var m=p==null?void 0:p.entity;if(m){var T=void 0;try{T=new RegExp(SR(m))}catch{continue}for(var y of h)if(y&&T.test(y))return g}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.target;if(typeof n!="string"&&(n=null),n){var i=e.client.getRoom(n);if(i)return i;n=null}return n=(yield e.client.createRoom({name:"Individual Policy Room",preset:ay.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=n}),e.client.getRoom(n)})()}getOrCreateSourceRooms(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.sources,i=!1;Array.isArray(n)||(i=!0,n=[]);var a=n.filter(l=>typeof l=="string").map(l=>e.client.getRoom(l)).filter(l=>!!l);if(a.length!=n.length&&(i=!0),a.length==0){var s=yield e.getOrCreateTargetRoom();i=!0,a=[s]}return i&&(yield e.withIgnoreInvitesPolicies(l=>{l.sources=n})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return R(function*(){var{policies:n,ignoreInvitesPolicies:i}=t.getPoliciesAndIgnoreInvitesPolicies();e(i),n[zu.name]=i,yield t.client.setAccountData(Af.name,n)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Af.name,Af.altName]){var n;if(t){var i=(n=this.client.getAccountData(t))===null||n===void 0?void 0:n.getContent();if(i){e=i;break}}}var a={},s=!1;for(var l of[zu.name,zu.altName])if(l){var u=e[l];if(u&&typeof u=="object"){a=u,s=!0;break}}return s||(e[zu.name]=a),{policies:e,ignoreInvitesPolicies:a}}};o(PS,"IgnoredInvites");let fm=PS;var xf="matrix-js-sdk";function dN(r){if(r.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let d=0;d<e.length;d++)e[d]=255;for(let d=0;d<r.length;d++){const c=r.charAt(d),h=c.charCodeAt(0);if(e[h]!==255)throw new TypeError(c+" is ambiguous");e[h]=d}const t=r.length,n=r.charAt(0),i=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function s(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";let c=0,h=0,v=0;const g=d.length;for(;v!==g&&d[v]===0;)v++,c++;const p=(g-v)*a+1>>>0,m=new Uint8Array(p);for(;v!==g;){let S=d[v],w=0;for(let C=p-1;(S!==0||w<h)&&C!==-1;C--,w++)S+=256*m[C]>>>0,m[C]=S%t>>>0,S=S/t>>>0;if(S!==0)throw new Error("Non-zero carry");h=w,v++}let T=p-h;for(;T!==p&&m[T]===0;)T++;let y=n.repeat(c);for(;T<p;++T)y+=r.charAt(m[T]);return y}o(s,"encode");function l(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;let c=0,h=0,v=0;for(;d[c]===n;)h++,c++;const g=(d.length-c)*i+1>>>0,p=new Uint8Array(g);for(;c<d.length;){const S=d.charCodeAt(c);if(S>255)return;let w=e[S];if(w===255)return;let C=0;for(let M=g-1;(w!==0||C<v)&&M!==-1;M--,C++)w+=t*p[M]>>>0,p[M]=w%256>>>0,w=w/256>>>0;if(w!==0)throw new Error("Non-zero carry");v=C,c++}let m=g-v;for(;m!==g&&p[m]===0;)m++;const T=new Uint8Array(h+(g-m));let y=h;for(;m!==g;)T[y++]=p[m++];return T}o(l,"decodeUnsafe");function u(d){const c=l(d);if(c)return c;throw new Error("Non-base"+t+" character")}return o(u,"decode"),{encode:s,decodeUnsafe:l,decode:u}}o(dN,"base");var cN="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const kU=dN(cN);var Pt=function(r){return r.UserTrustStatusChanged="userTrustStatusChanged",r.KeyBackupStatus="crypto.keyBackupStatus",r.KeyBackupFailed="crypto.keyBackupFailed",r.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",r.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",r.VerificationRequestReceived="crypto.verificationRequestReceived",r.WillUpdateDevices="crypto.willUpdateDevices",r.DevicesUpdated="crypto.devicesUpdated",r.KeysChanged="crossSigning.keysChanged",r.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",r.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",r.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",r.RehydrationStarted="dehydration.RehydrationStarted",r.RehydrationProgress="dehydration.RehydrationProgress",r.RehydrationCompleted="dehydration.RehydrationCompleted",r.RehydrationError="dehydration.RehydrationError",r.DehydrationKeyCached="dehydration.DehydrationKeyCached",r.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",r}({}),s0=function(r){return r.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",r.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",r.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",r.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",r.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",r.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",r.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",r.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",r.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",r.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",r.UNKNOWN_ERROR="UNKNOWN_ERROR",r.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",r.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",r.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",r.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",r.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",r.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",r.OLM_BAD_ROOM="OLM_BAD_ROOM",r.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",r.OLM_BAD_SENDER="OLM_BAD_SENDER",r.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",r.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",r.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",r.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",r}({}),hN=function(r){return r[r.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",r[r.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",r}({});const MS=class MS{constructor(e){this.errorOnVerifiedUserProblems=e,f(this,"kind",hN.AllDevicesIsolationMode)}};o(MS,"AllDevicesIsolationMode");let o0=MS;const AS=class AS{constructor(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n,f(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}};o(AS,"UserVerificationStatus");let l0=AS;const xS=class xS{constructor(e){var t,n,i,a,s;f(this,"signedByOwner",void 0),f(this,"crossSigningVerified",void 0),f(this,"tofu",void 0),f(this,"localVerified",void 0),f(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(n=e.crossSigningVerified)!==null&&n!==void 0?n:!1,this.tofu=(i=e.tofu)!==null&&i!==void 0?i:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(s=e.trustCrossSignedDevices)!==null&&s!==void 0?s:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}};o(xS,"DeviceVerificationStatus");let u0=xS;var PU=function(r){return r.Fetch="fetch",r.LoadKeys="load_keys",r}({}),MU=function(r){return r.Master="master",r.SelfSigning="self_signing",r.UserSigning="user_signing",r}({}),AU=function(r){return r[r.NONE=0]="NONE",r[r.GREY=1]="GREY",r[r.RED=2]="RED",r}({}),xU=function(r){return r[r.UNKNOWN=0]="UNKNOWN",r[r.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",r[r.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",r[r.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",r[r.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",r[r.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",r[r.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",r[r.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",r[r.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",r}({}),fN=new Uint8Array(8);function kI(r,e){return vm.apply(this,arguments)}o(kI,"deriveKeys");function vm(){return vm=R(function*(r,e){var t=yield globalThis.crypto.subtle.importKey("raw",r,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:fN,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),i=n.slice(0,32),a=n.slice(32),s=globalThis.crypto.subtle.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,l])}),vm.apply(this,arguments)}o(vm,"_deriveKeys");function PI(r,e,t,n){return pm.apply(this,arguments)}o(PI,"encryptAESSecretStorageItem");function pm(){return pm=R(function*(r,e,t,n){var i;n?i=ua(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var[a,s]=yield kI(e,t),l=new TextEncoder().encode(r),u=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},a,l),d=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,u);return{iv:il(i),ciphertext:il(new Uint8Array(u)),mac:il(new Uint8Array(d))}}),pm.apply(this,arguments)}o(pm,"_encryptAESSecretStorageItem");function vN(r,e,t){return mm.apply(this,arguments)}o(vN,"decryptAESSecretStorageItem");function mm(){return mm=R(function*(r,e,t){var[n,i]=yield kI(e,t),a=ua(r.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},i,ua(r.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:ua(r.iv),length:64},n,a);return new TextDecoder().decode(new Uint8Array(s))}),mm.apply(this,arguments)}o(mm,"_decryptAESSecretStorageItem");var Yi="m.secret_storage.v1.aes-hmac-sha2";const DS=class DS{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return R(function*(){var t,n=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return n&&(t=n.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,n)=>{var i=o(s=>{if(s.getType()==="m.secret_storage.default_key"){var l=s.getContent(),u=e===null?Object.keys(l).length===0:l.key===e;u&&(this.accountDataAdapter.removeListener(de.AccountData,i),t())}},"listener");this.accountDataAdapter.on(de.AccountData,i);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(s=>{this.accountDataAdapter.removeListener(de.AccountData,i),n(s)})})}addKey(e,t,n){var i=this;return R(function*(){if(e!==Yi)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:s,mac:l}=yield ym(t.key);if(a.iv=s,a.mac=l,!n)do n=Ri(32);while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),a),{keyId:n,keyInfo:a}})()}getKey(e){var t=this;return R(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var n=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return n?[e,n]:null})()}hasKey(e){var t=this;return R(function*(){var n=yield t.getKey(e);return!!n})()}checkKey(e,t){return R(function*(){if(t.algorithm===Yi)if(t.mac){var{mac:n}=yield ym(e,t.iv);return gm(t.mac)===gm(n)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,n){var i=this;return R(function*(){if(t===null){yield i.accountDataAdapter.setAccountData(e,{});return}var a={};if(!n){var s=yield i.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");n=[s]}if(n.length===0)throw new Error("Zero keys given to encrypt with!");for(var l of n){var u=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(l));if(!u)throw new Error("Unknown key: "+l);if(u.algorithm===Yi){var d={[l]:u},[,c]=yield i.getSecretStorageKey(d,e);a[l]=yield c.encrypt(t)}else I.warn("unknown algorithm for secret storage key "+l+": "+u.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return R(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(n){if(!n.encrypted)throw new Error("Content is not encrypted!");var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),l=n.encrypted[a];(s==null?void 0:s.algorithm)===Yi&&l.iv&&l.ciphertext&&l.mac&&(i[a]=s)}if(Object.keys(i).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[u,d]=yield t.getSecretStorageKey(i,e),c=n.encrypted[u];return d.decrypt(c)}})()}isStored(e){var t=this;return R(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(n!=null&&n.encrypted))return null;var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(s){var l=n.encrypted[a];s.algorithm===Yi&&l.iv&&l.ciphertext&&l.mac&&(i[a]=s)}}return Object.keys(i).length?i:null})()}getSecretStorageKey(e,t){var n=this;return R(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var i=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,s]=i;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===Yi){var l={encrypt:o(function(d){return PI(d,s,t)},"encrypt"),decrypt:o(function(d){return vN(d,s,t)},"decrypt")};return[a,l]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}};o(DS,"ServerSideSecretStorageImpl");let Pc=DS;function gm(r){for(var e=r.length;e>=1&&r.charCodeAt(e-1)==61;)e--;return e<r.length?r.substring(0,e):r}o(gm,"trimTrailingEquals");var pN="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function ym(r,e){return PI(pN,r,"",e)}o(ym,"calculateKeyCheck");const mN=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:Yi,ServerSideSecretStorageImpl:Pc,calculateKeyCheck:ym,trimTrailingEquals:gm},Symbol.toStringTag,{value:"Module"}));var MI=o(r=>r.type==="livekit"&&"focus_selection"in r,"isLivekitFocusActive"),AI=1e3*60*60*4,gN=o((r,e)=>{var t,n="Malformed session membership event: ";return typeof r.device_id!="string"&&e.push(n+"device_id must be string"),typeof r.call_id!="string"&&e.push(n+"call_id must be string"),typeof r.application!="string"&&e.push(n+"application must be a string"),typeof((t=r.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(n+"focus_active.type must be a string"),Array.isArray(r.foci_preferred)||e.push(n+"foci_preferred must be an array"),r.created_ts&&typeof r.created_ts!="number"&&e.push(n+"created_ts must be number"),r.scope&&typeof r.scope!="string"&&e.push(n+"scope must be string"),e.length===0},"checkSessionsMembershipData");const NS=class NS{static equal(e,t){return qs(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,f(this,"membershipData",void 0);var n=[];if(gN(t,n))this.membershipData=t;else throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(n.join(" & "),") events this could be a legacy membership event: (").concat(t,")"))}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+((e=this.membershipData.expires)!==null&&e!==void 0?e:AI)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(MI(e))return e.focus_selection}};o(NS,"CallMembership");let Mc=NS;var gd=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({}),ly=function(r){return r.TooNew="TOO_NEW",r}({});const LS=class LS extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}};o(LS,"InvalidCryptoStoreError");let Vl=LS;f(Vl,"TOO_NEW",ly.TooNew);const US=class US extends Error{constructor(e,t){super(e),this.value=t}};o(US,"KeySignatureUploadError");let Sm=US;const jS=class jS extends Error{constructor(){super("MatrixClient has been stopped")}};o(jS,"ClientStoppedError");let Em=jS;const FS=class FS extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}};o(FS,"UnsupportedDelayedEventsEndpointError");let vn=FS;var Wi=function(r){return r.Disconnected="Disconnected",r.Connecting="Connecting",r.ConnectingFailed="ConnectingFailed",r.Connected="Connected",r.Reconnecting="Reconnecting",r.Disconnecting="Disconnecting",r.Stuck="Stuck",r.Unknown="Unknown",r}({}),yd=o((r,e,t)=>r.sender===e&&r.deviceId===t,"isMyMembership");const BS=class BS{constructor(e,t){this.membershipLoopHandler=e,f(this,"logger",void 0),f(this,"running",!1),f(this,"wakeup",n=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),f(this,"_actions",[]),this.logger=(t??I).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return R(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:Ee.SendDelayedEvent}];try{for(var t=o(function*(){e._actions.sort((d,c)=>d.ts-c.ts);var i=e._actions[0],a=void 0,s=new Promise(d=>{e.wakeup=c=>{a=c,d()}});i.ts>Date.now()&&(yield Promise.race([s,uu(i.ts-Date.now())]));var l={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(i.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{l=yield e.membershipLoopHandler(i.type)}catch(d){throw Error("The MembershipManager shut down because of the end condition: ".concat(d))}}e._actions.splice(0,1);var u=a??l;"replace"in u?e._actions=u.replace:"insert"in u&&e._actions.push(...u.insert)},"_loop");e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Ee.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Ee.SendScheduledDelayedLeaveEvent}]})}};o(BS,"ActionScheduler");let _m=BS;var d0=function(r){return r.StatusChanged="StatusChanged",r}({}),Ee=function(r){return r.SendDelayedEvent="SendDelayedEvent",r.SendJoinEvent="SendJoinEvent",r.RestartDelayedEvent="RestartDelayedEvent",r.UpdateExpiry="UpdateExpiry",r.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",r.SendLeaveEvent="SendLeaveEvent",r}({});const ul=class ul extends Ge{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,n){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.focusActive=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=ul.defaultState,this.scheduler.startWithJoin().catch(i=>{this.logger.error("MembershipManager stopped because: ",i),n==null||n(i)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(d0.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var i;(i=this.leavePromiseResolvers)===null||i===void 0||i.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){var t=this;return R(function*(){var n=t.client.getUserId(),i=t.client.getDeviceId();if(!n||!i)return t.logger.error("MembershipManager.onRTCSessionMemberUpdate called without user or device id"),Promise.resolve();if(t._ownMembership=e.find(s=>yd(s,n,i)),t.isActivated()&&!t._ownMembership){var a=[Ee.SendDelayedEvent,Ee.SendJoinEvent];t.logger.warn("Missing own membership: force re-join"),t.state.hasMemberStateEvent=!1,t.scheduler.actions.some(s=>a.includes(s.type))?t.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",t.scheduler.actions):t.scheduler.initiateJoin()}return Promise.resolve()})()}getActiveFocus(){if(this.focusActive)if(MI(this.focusActive)){if(this.focusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e==null?void 0:e.getPreferredFoci()[0]}}else this.logger.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.");else{var t=this.getOldestMembership();return t==null?void 0:t.getPreferredFoci()[0]}}constructor(e,t,n,i,a){super(),this.joinConfig=e,this.room=t,this.client=n,this.getOldestMembership=i,f(this,"activated",!1),f(this,"logger",void 0),f(this,"leavePromiseResolvers",void 0),f(this,"_ownMembership",void 0),f(this,"oldStatus",void 0),f(this,"scheduler",void 0),f(this,"state",void 0),f(this,"deviceId",void 0),f(this,"stateKey",void 0),f(this,"fociPreferred",void 0),f(this,"focusActive",void 0),f(this,"delayedLeaveEventDelayMsOverride",void 0),this.logger=(a??I).getChild("[MembershipManager]");var[s,l]=[this.client.getUserId(),this.client.getDeviceId()];if(s===null)throw Error("Missing userId in client");if(l===null)throw Error("Missing deviceId in client");this.deviceId=l,this.stateKey=this.makeMembershipStateKey(s,l),this.state=ul.defaultState,this.scheduler=new _m(u=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(d0.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(u)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1}}get networkErrorRetryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.networkErrorRetryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeout)!==null&&e!==void 0?e:AI}get membershipEventExpiryHeadroomMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryHeadroomMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeoutHeadroom)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+this.membershipEventExpiryMs*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,n,i,a;return(e=(t=(n=this.delayedLeaveEventDelayMsOverride)!==null&&n!==void 0?n:(i=this.joinConfig)===null||i===void 0?void 0:i.delayedLeaveEventDelayMs)!==null&&t!==void 0?t:(a=this.joinConfig)===null||a===void 0?void 0:a.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventRestartMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return R(function*(){switch(e){case Ee.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Ee.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):Cr(Ee.SendDelayedEvent);case Ee.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):Cr(Ee.SendLeaveEvent):{replace:[]};case Ee.SendJoinEvent:return t.sendJoinEvent();case Ee.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Ee.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return R(function*(){return yield e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},B.GroupCallMemberPrefix,{},e.stateKey).then(t=>(e.resetRateLimitCounter(Ee.SendDelayedEvent),e.state.delayId=t.delay_id,e.state.hasMemberStateEvent?Cr(Ee.RestartDelayedEvent,e.delayedLeaveEventRestartMs):Cr(Ee.SendJoinEvent))).catch(t=>{var n=Ee.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return Cr(n);var i=e.actionUpdateFromErrors(t,n,"sendDelayedStateEvent");if(i)return i;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),Cr(Ee.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return R(function*(){return yield t.client._unstable_updateDelayedEvent(e,gd.Cancel).then(()=>(t.state.delayId=void 0,t.resetRateLimitCounter(Ee.SendDelayedEvent),Df(Ee.SendDelayedEvent))).catch(n=>{var i=Ee.SendDelayedEvent,a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");if(a)return a;if(t.isNotFoundError(n))return t.state.delayId=void 0,Df(i);if(t.isUnsupportedDelayedEndpoint(n))return Df(Ee.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}restartDelayedEvent(e){var t=this;return R(function*(){var n=new Promise((i,a)=>{setTimeout(()=>{a(new NM("Restart delayed event timed out before the HS responded"))},t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_updateDelayedEvent(e,gd.Restart),n]).then(()=>(t.resetRateLimitCounter(Ee.RestartDelayedEvent),Cr(Ee.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(i=>{var a=Ee.RestartDelayedEvent;if(t.isNotFoundError(i))return t.state.delayId=void 0,Cr(Ee.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(i))return{};var s=t.actionUpdateFromErrors(i,a,"updateDelayedEvent");if(s)return s;throw Error("Could not restart delayed event, even though delayed events are supported. "+i)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return R(function*(){return yield t.client._unstable_updateDelayedEvent(e,gd.Send).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(Ee.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(n=>{var i=Ee.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(n))return{};if(t.isNotFoundError(n))return t.state.delayId=void 0,Cr(i);var a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",n),Cr(i))})})()}sendJoinEvent(){var e=this;return R(function*(){return yield e.client.sendStateEvent(e.room.roomId,B.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs),e.stateKey).then(()=>{e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Ee.SendJoinEvent);var t=e.scheduler.actions.filter(n=>n.type!==Ee.UpdateExpiry&&n.type!==Ee.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:Ee.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Ee.UpdateExpiry}]}}).catch(t=>{var n=e.actionUpdateFromErrors(t,Ee.SendJoinEvent,"sendStateEvent");if(n)return n;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return R(function*(){var t=e.state.expireUpdateIterations+1;return yield e.client.sendStateEvent(e.room.roomId,B.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs*t),e.stateKey).then(()=>(e.resetRateLimitCounter(Ee.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Ee.UpdateExpiry}]})).catch(n=>{var i=e.actionUpdateFromErrors(n,Ee.UpdateExpiry,"sendStateEvent");if(i)return i;throw n})})()}sendFallbackLeaveEvent(){var e=this;return R(function*(){return yield e.client.sendStateEvent(e.room.roomId,B.GroupCallMemberPrefix,{},e.stateKey).then(()=>(e.resetRateLimitCounter(Ee.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var n=e.actionUpdateFromErrors(t,Ee.SendLeaveEvent,"sendStateEvent");if(n)return n;throw t})})()}makeMembershipStateKey(e,t){var n="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?n:"_".concat(n)}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:this.deviceId,expires:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}}isNotFoundError(e){return e instanceof dt&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof dt&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,n){var i=this.actionUpdateFromRateLimitError(e,n,t);if(i)return i;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,n){var i;if((e instanceof Vn||e instanceof dt)&&e.isRateLimitError()){var a=(i=this.state.rateLimitRetries.get(n))!==null&&i!==void 0?i:0;if(a<this.maximumRateLimitRetryCount){var s,l=5e3;try{var u;s=(u=e.getRetryAfterMs())!==null&&u!==void 0?u:l,this.logger.info("Rate limited by server, retrying in ".concat(s,"ms"))}catch(d){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(l),d),s=l}return this.state.rateLimitRetries.set(n,a+1),Cr(n,s)}throw Error("Exceeded maximum retries for "+n+" attempts (client."+t+"): "+e)}}actionUpdateFromNetworkErrorRetry(e,t){var n,i=(n=this.state.networkErrorRetries.get(t))!==null&&n!==void 0?n:0,a=this.networkErrorRetryMs/1e3+"s",s="("+i+"/"+this.maximumNetworkErrorRetryCount+")",l=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")l=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+s+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+s,e);else if(e instanceof qn)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+s,e);else if((e instanceof Vn||e instanceof dt)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+s,e);else return;if(i<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,i+1),Cr(t,l);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof vn}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case Ee.SendDelayedEvent:case Ee.SendJoinEvent:return Wi.Connecting;case Ee.UpdateExpiry:return Wi.Connected;case Ee.SendScheduledDelayedLeaveEvent:case Ee.SendLeaveEvent:return Wi.Disconnecting}}else if(e.length===2){var n=e.map(a=>a.type);if((n.includes(Ee.RestartDelayedEvent)||n.includes(Ee.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&n.includes(Ee.UpdateExpiry))return Wi.Connected}else if(e.length===3){var i=e.map(a=>a.type);if(i.filter(a=>a===Ee.RestartDelayedEvent).length===2&&i.includes(Ee.UpdateExpiry))return Wi.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Wi.Unknown):Wi.Disconnected}};o(ul,"MembershipManager");let bm=ul;function Cr(r,e){return{insert:[{ts:Date.now()+(e??0),type:r}]}}o(Cr,"createInsertActionUpdate");function Df(r,e){return{replace:[{ts:Date.now()+0,type:r}]}}o(Df,"createReplaceActionUpdate");var pn=function(r){return r.ReceivedKeys="received_keys",r.NotSupportedError="not_supported_error",r}({});const $S=class $S{constructor(){f(this,"tsBuffer",new Map)}isOutdated(e,t){var n;this.tsBuffer.has(e)||this.tsBuffer.set(e,new Map);var i=(n=this.tsBuffer.get(e))===null||n===void 0?void 0:n.get(t.keyIndex);return i&&i>t.creationTS?!0:(this.tsBuffer.get(e).set(t.keyIndex,t.creationTS),!1)}};o($S,"OutdatedKeyFilter");let wm=$S;function da(r,e){return"".concat(r,":").concat(e)}o(da,"getParticipantId");const WS=class WS extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}};o(WS,"NotSupportedError");let Ac=WS;const KS=class KS extends Ge{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,n,i,a,s){super(),this.userId=e,this.deviceId=t,this.roomId=n,this.client=i,this.statistics=a,f(this,"logger",I),f(this,"onToDeviceEvent",l=>{if(l.getType()===B.CallEncryptionKeysPrefix){var u=this.getValidEventContent(l);u&&l.getSender()&&this.receiveCallKeyEvent(l.getSender(),u)}}),this.setParentLogger(s??I)}start(){this.client.on(de.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(de.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var i=this;return R(function*(){var a={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.deviceId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},s=n.map(l=>({userId:l.userId,deviceId:l.deviceId})).filter(l=>!(l.userId==i.userId&&l.deviceId==i.deviceId));s.length>0?(yield i.client.encryptAndSendToDevice(B.CallEncryptionKeysPrefix,s,a).catch(l=>{var u=l.message;if(u.includes("unknown variant")&&u.includes("send_to_device")||u.includes("not supported"))throw new Ac("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var n=Date.now(),i=n-(typeof t.sent_ts=="number"?t.sent_ts:n);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=i,this.emit(pn.ReceivedKeys,e,t.member.claimed_device_id,t.keys.key,t.keys.index,n)}getValidEventContent(e){var t=e.getContent(),n=t.room_id;if(!n){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(n!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}};o(KS,"ToDeviceKeyTransport");let Tm=KS;var Ah=function(r){return r.EnabledTransportsChanged="enabled_transports_changed",r}({});const VS=class VS extends Ge{constructor(e,t,n){var i;super(),i=this,this.toDeviceTransport=e,this.roomKeyTransport=t,f(this,"logger",void 0),f(this,"_enabled",{toDevice:!0,room:!1}),this.logger=(n??I).getChild("[RoomAndToDeviceTransport]"),this.toDeviceTransport.setParentLogger(this.logger),this.roomKeyTransport.setParentLogger(this.logger),this.roomKeyTransport.on(pn.ReceivedKeys,function(){i._enabled.room||(i.logger.debug("Received room key, enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}));for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i.emit(pn.ReceivedKeys,...s)}),this.toDeviceTransport.on(pn.ReceivedKeys,function(){if(i._enabled.toDevice){for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i.emit(pn.ReceivedKeys,...s)}else i.logger.debug("To Device transport is disabled, ignoring received keys")})}setEnabled(e){(this.enabled.toDevice!==e.toDevice||this.enabled.room!==e.room)&&(this._enabled=e,this.emit(Ah.EnabledTransportsChanged,e))}get enabled(){return this._enabled}start(){this.roomKeyTransport.start(),this.toDeviceTransport.start()}stop(){this.roomKeyTransport.stop(),this.toDeviceTransport.stop()}sendKey(e,t,n){var i=this;return R(function*(){if(i.logger.debug("Sending key with index ".concat(t," to call members (count=").concat(n.length,") via:")+(i._enabled.room?"room transport":"")+(i._enabled.room&&i._enabled.toDevice?"and":"")+(i._enabled.toDevice?"to device transport":"")),i._enabled.room&&(yield i.roomKeyTransport.sendKey(e,t,n)),i._enabled.toDevice)try{yield i.toDeviceTransport.sendKey(e,t,n)}catch(a){a instanceof Ac&&!i._enabled.room&&(i.logger.warn("To device is not supported enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}),yield i.sendKey(e,t,n))}})()}};o(VS,"RoomAndToDeviceTransport");let ql=VS;const qS=class qS{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,n,i,a,s,l){var u=this;this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,f(this,"manageMediaKeys",!1),f(this,"keysEventUpdateTimeout",void 0),f(this,"makeNewKeyTimeout",void 0),f(this,"setNewKeyTimeouts",new Set),f(this,"encryptionKeys",new Map),f(this,"lastEncryptionKeyUpdateRequest",void 0),f(this,"lastMembershipFingerprints",void 0),f(this,"latestGeneratedKeyIndex",-1),f(this,"joinConfig",void 0),f(this,"logger",void 0),f(this,"joined",!1),f(this,"sendEncryptionKeysEvent",function(){var d=R(function*(c){if(u.keysEventUpdateTimeout!==void 0&&(clearTimeout(u.keysEventUpdateTimeout),u.keysEventUpdateTimeout=void 0),u.lastEncryptionKeyUpdateRequest=Date.now(),!!u.joined){var h=u.getKeysForParticipant(u.userId,u.deviceId);if(!h){u.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof c!="number"&&u.latestGeneratedKeyIndex===-1){u.logger.warn("Tried to send encryption keys event but no current key index found!");return}var v=c??u.latestGeneratedKeyIndex;u.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(v," (method parameter: ").concat(c,")"));var g=h[v];try{u.statistics.counters.roomEventEncryptionKeysSent+=1;var p=u.getMemberships().filter(T=>T.sender!=null).map(T=>({userId:T.sender,deviceId:T.deviceId,membershipTs:T.createdTs()}));yield u.transport.sendKey(TI(g),v,p),u.logger.debug("sendEncryptionKeysEvent participantId=".concat(u.userId,":").concat(u.deviceId," numKeys=").concat(h.length," currentKeyIndex=").concat(u.latestGeneratedKeyIndex," keyIndexToSend=").concat(v))}catch(T){if(u.keysEventUpdateTimeout===void 0){var m=Zg(T,5e3);u.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(m),T),u.keysEventUpdateTimeout=setTimeout(()=>void u.sendEncryptionKeysEvent(),m)}else u.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(c){return d.apply(this,arguments)}}()),f(this,"onTransportChanged",()=>{this.requestSendCurrentKey()}),f(this,"onNewKeyReceived",(d,c,h,v,g)=>{this.logger.debug("Received key over key transport ".concat(d,":").concat(c," at index ").concat(v)),this.setEncryptionKey(d,c,v,h,g)}),f(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var d=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(d)}}),this.logger=(l??I).getChild("[EncryptionManager]")}getEncryptionKeys(){var e=new Map;for(var[t,n]of this.encryptionKeys){var i=n.map((a,s)=>({key:a.key,keyIndex:s}));e.set(t,i)}return e}join(e){var t,n,i;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(pn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof ql&&this.transport.on(Ah.EnabledTransportsChanged,this.onTransportChanged),this.transport.start(),(i=this.joinConfig)!==null&&i!==void 0&&i.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(da(this.userId,this.deviceId),[]),this.transport.off(pn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(d=>!yd(d,this.userId,this.deviceId)).map(Nf)),n=new Set(this.getMemberships().filter(d=>!yd(d,this.userId,this.deviceId)).map(Nf)),i=Array.from(t).some(d=>!n.has(d)),a=Array.from(n).some(d=>!t.has(d)),s=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),i)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(s){var l=this.lastMembershipFingerprints,u=Array.from(s).some(d=>!l.has(d))||Array.from(l).some(d=>!s.has(d));u&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=L1(16),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.userId,this.deviceId,n,t,Date.now(),e),n}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>void this.sendEncryptionKeysEvent(),this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e,t){var n;return(n=this.encryptionKeys.get(da(e,t)))===null||n===void 0?void 0:n.map(i=>i.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!yd(e,this.userId,this.deviceId)).map(e=>"".concat(Nf(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,n,i,a){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1;this.logger.debug("Setting encryption key for ".concat(e,":").concat(t," at index ").concat(n));var l=ua(i),u=da(e,t);this.encryptionKeys.has(u)||this.encryptionKeys.set(u,[]);var d=this.encryptionKeys.get(u),c=d[n];if(c){if(c.timestamp>a){this.logger.info("Ignoring new key at index ".concat(n," for ").concat(u," as it is older than existing known key"));return}if(yN(c.key,l)){c.timestamp=a;return}}if(e===this.userId&&t===this.deviceId&&(this.latestGeneratedKeyIndex=n),d[n]={key:l,timestamp:a},s){var h=setTimeout(()=>{this.setNewKeyTimeouts.delete(h),this.logger.info("Delayed-emitting key changed event for ".concat(u," index ").concat(n)),this.onEncryptionKeysChanged(l,n,u)},this.useKeyDelay);this.setNewKeyTimeouts.add(h)}else this.onEncryptionKeysChanged(l,n,u)}};o(qS,"EncryptionManager");let Rm=qS;function yN(r,e){return r===e?!0:!!r&&!!e&&r.length===e.length&&r.every((t,n)=>t===e[n])}o(yN,"keysEqual");var Nf=o(r=>da(r.sender,r.deviceId),"getParticipantIdFromMembership");const GS=class GS extends Ge{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,n,i){super(),this.room=e,this.client=t,this.statistics=n,f(this,"logger",I),this.setParentLogger(i??I)}start(){this.room.on(ue.Timeline,e=>void this.consumeCallEncryptionEvent(e))}stop(){this.room.off(ue.Timeline,e=>void this.consumeCallEncryptionEvent(e))}consumeCallEncryptionEvent(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield n.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){i?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>void n.consumeCallEncryptionEvent(e,!0),1e3));return}else i&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==B.CallEncryptionKeysPrefix)return Promise.resolve();if(!n.room)return n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();n.onEncryptionEvent(e)})()}sendKey(e,t,n){var i=this;return R(function*(){var a={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,B.CallEncryptionKeysPrefix,a)}catch(l){i.logger.error("Failed to send call encryption keys",l);var s=l;throw s.event&&i.client.cancelPendingEvent(s.event),l}})()}onEncryptionEvent(e){var t=e.getSender(),n=e.getContent(),i=n.device_id,a=n.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(i,", callId=").concat(a));return}if(!Array.isArray(n.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&i===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var s=Date.now()-(typeof n.sent_ts=="number"?n.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=s;for(var l of n.keys){if(!l){this.logger.info("Ignoring false-y key in keys event");continue}var u=l.key,d=l.index;!u||d===void 0||d===null||a===void 0||a===null||typeof i!="string"||typeof a!="string"||typeof u!="string"||typeof d!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(i,", encryptionKeyIndex=").concat(d," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(i," encryptionKeyIndex=").concat(d," age=").concat(s,"ms")),this.emit(pn.ReceivedKeys,t,i,u,d,e.getTs()))}}};o(GS,"RoomKeyTransport");let xc=GS;const HS=class HS{constructor(e,t,n,i,a,s,l){this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,f(this,"manageMediaKeys",!1),f(this,"participantKeyRings",new Map),f(this,"outboundSession",null),f(this,"currentKeyDistributionPromise",null),f(this,"useKeyDelay",5e3),f(this,"keyRotationGracePeriodMs",1e4),f(this,"needToEnsureKeyAgain",!1),f(this,"keyBuffer",new wm),f(this,"logger",void 0),f(this,"onTransportChanged",()=>{var u;(u=this.logger)===null||u===void 0||u.info("Transport change detected, restarting key distribution"),this.currentKeyDistributionPromise?this.currentKeyDistributionPromise.then(()=>{this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}).catch(d=>{var c;(c=this.logger)===null||c===void 0||c.error("Failed to restart key distribution",d)}):this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}),f(this,"onNewKeyReceived",(u,d,c,h,v)=>{var g;if(!this.manageMediaKeys){var p;(p=this.logger)===null||p===void 0||p.warn("Received key over transport ".concat(u,":").concat(d," at index ").concat(h," but media keys are disabled"));return}(g=this.logger)===null||g===void 0||g.debug("Received key over transport ".concat(u,":").concat(d," at index ").concat(h));var m=da(u,d),T=ua(c),y={key:T,participantId:m,keyIndex:h,creationTS:v},S=this.keyBuffer.isOutdated(m,y);if(!S)this.addKeyToParticipant(y.key,y.keyIndex,y.participantId),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var w;(w=this.logger)===null||w===void 0||w.info("Received an out of order key for ".concat(u,":").concat(d,", dropping it"))}}),this.logger=l==null?void 0:l.getChild("[EncryptionManager]")}getEncryptionKeys(){return new Map(this.participantKeyRings)}addKeyToParticipant(e,t,n){this.participantKeyRings.has(n)||this.participantKeyRings.set(n,[]),this.participantKeyRings.get(n).push({key:e,keyIndex:t}),this.onEncryptionKeysChanged(e,t,n)}join(e){var t,n,i,a;this.manageMediaKeys=(t=e==null?void 0:e.manageMediaKeys)!==null&&t!==void 0?t:!0,(n=this.logger)===null||n===void 0||n.info("Joining room"),this.useKeyDelay=(i=e==null?void 0:e.useKeyDelay)!==null&&i!==void 0?i:1e3,this.keyRotationGracePeriodMs=(a=e==null?void 0:e.keyRotationGracePeriodMs)!==null&&a!==void 0?a:1e4,this.transport.on(pn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof ql&&this.transport.on(Ah.EnabledTransportsChanged,this.onTransportChanged),this.transport.start()}leave(){this.transport.off(pn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var n;if((n=this.logger)===null||n===void 0||n.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var i;(i=this.logger)===null||i===void 0||i.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution()}rolloutOutboundKey(){var e=this;return R(function*(){var t,n,i=e.outboundSession==null;i&&(e.outboundSession={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0},e.addKeyToParticipant(e.outboundSession.key,e.outboundSession.keyId,da(e.userId,e.deviceId)));var a=e.getMemberships().filter(O=>O.sender!=null).map(O=>({userId:O.sender,deviceId:O.deviceId,membershipTs:O.createdTs()})),s=(t=(n=e.outboundSession)===null||n===void 0?void 0:n.sharedWith)!==null&&t!==void 0?t:[];s=s.filter(O=>!a.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs!=b.membershipTs));var l=s.filter(O=>!a.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs==b.membershipTs)),u=a.filter(O=>!s.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs==b.membershipTs)),d=[],c,h=!1;if(l.length>0){var v=e.createNewOutboundSession();h=!0,d=a,c=v}else if(u.length>0){var g=Date.now(),p=g-e.outboundSession.creationTS;if(p<e.keyRotationGracePeriodMs){var m;(m=e.logger)===null||m===void 0||m.debug("New joiners detected, but the key is recent enough (age:".concat(p,"), keeping it")),d=u,c=e.outboundSession}else{var T;(T=e.logger)===null||T===void 0||T.debug("New joiners detected, rotating the key");var y=e.createNewOutboundSession();h=!0,d=a,c=y}}else return;try{var S,w;if((S=e.logger)===null||S===void 0||S.trace("Sending key..."),yield e.transport.sendKey(il(c.key),c.keyId,d),e.statistics.counters.roomEventEncryptionKeysSent+=1,c.sharedWith.push(...d),(w=e.logger)===null||w===void 0||w.trace("key index:".concat(c.keyId," sent to ").concat(c.sharedWith.map(O=>"".concat(O.userId,":").concat(O.deviceId)).join(","))),h){var C,M;(C=e.logger)===null||C===void 0||C.trace("Delay Rollout for key:".concat(c.keyId,"...")),yield uu(e.useKeyDelay),(M=e.logger)===null||M===void 0||M.trace("...Delayed rollout of index:".concat(c.keyId," ")),e.addKeyToParticipant(c.key,c.keyId,da(e.userId,e.deviceId))}}catch(O){var _;(_=e.logger)===null||_===void 0||_.error("Failed to rollout key",O)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}};o(HS,"RTCEncryptionManager");let Im=HS;var ti=function(r){return r.MembershipsChanged="memberships_changed",r.JoinStateChanged="join_state_changed",r.EncryptionKeyChanged="encryption_key_changed",r.MembershipManagerError="membership_manager_error",r}({});const Xa=class Xa extends Ge{get callId(){return this._callId}static callMembershipsForRoom(e){var t=I.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),n=e.getLiveTimeline().getState(he.FORWARDS);if(!n)throw t.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var i=n.getStateEvents(B.GroupCallMemberPrefix),a=[];for(var s of i){var l=s.getContent(),u=Object.keys(l).length;if(u!==0){var d=[];if(u>1&&"focus_active"in l?d.push(l):u===1&&"memberships"in l&&t.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),d.length!==0)for(var c of d)try{var h,v=new Mc(s,c);if(v.callId!==""||v.scope!=="m.room"){t.info("Ignoring user-scoped call");continue}if(v.isExpired()){t.info("Ignoring expired device membership ".concat(v.sender,"/").concat(v.deviceId));continue}if(!e.hasMembershipState((h=v.sender)!==null&&h!==void 0?h:"",Te.Join)){t.info("Ignoring membership of user ".concat(v.sender," who is not in the room."));continue}a.push(v)}catch(g){t.warn("Couldn't construct call membership: ",g)}}}return a.sort((g,p)=>g.createdTs()-p.createdTs()),a.length>1&&t.debug("Call memberships in room ".concat(e.roomId,", in order: "),a.map(g=>[g.createdTs(),g.sender])),a}static roomSessionForRoom(e,t){var n=Xa.callMembershipsForRoom(t);return new Xa(e,t,n)}get room(){return this.roomSubset}constructor(e,t,n){var i;super(),this.client=e,this.roomSubset=t,this.memberships=n,f(this,"membershipManager",void 0),f(this,"encryptionManager",void 0),f(this,"_callId",void 0),f(this,"joinConfig",void 0),f(this,"logger",void 0),f(this,"pendingNotificationToSend",void 0),f(this,"expiryTimeout",void 0),f(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),f(this,"reEmitter",new Ai(this)),f(this,"onRoomMemberUpdate",()=>{this.recalculateSessionMembers()}),f(this,"onRTCSessionMemberUpdate",()=>{this.recalculateSessionMembers()}),f(this,"recalculateSessionMembers",()=>{var s,l,u,d=this.memberships;this.memberships=Xa.callMembershipsForRoom(this.room),this._callId=(s=this._callId)!==null&&s!==void 0?s:(l=this.memberships[0])===null||l===void 0?void 0:l.callId;var c=d.length!=this.memberships.length||d.some((m,T)=>!Mc.equal(m,this.memberships[T]));if(c){var h,v;this.logger.info("Memberships for call in room ".concat(this.roomSubset.roomId," have changed: emitting (").concat(this.memberships.length," members)")),FM(this.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{this.emit(ti.MembershipsChanged,d,this.memberships)}),(h=this.membershipManager)===null||h===void 0||h.onRTCSessionMemberUpdate(this.memberships);var g=(v=this.membershipManager)===null||v===void 0?void 0:v.ownMembership;if(this.pendingNotificationToSend&&g&&d.length===0){var p;g.eventId&&(p=this.joinConfig)!==null&&p!==void 0&&p.notificationType?this.sendCallNotify(g.eventId,this.joinConfig.notificationType):this.logger.warn("Own membership eventId is undefined, cannot send call notification")}this.memberships.length>0&&(this.pendingNotificationToSend=void 0)}(u=this.encryptionManager)===null||u===void 0||u.onMembershipsUpdate(d),this.setExpiryTimer()}),this.logger=I.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this._callId=(i=n[0])===null||i===void 0?void 0:i.callId;var a=this.roomSubset.getLiveTimeline().getState(he.FORWARDS);a==null||a.on(ke.Members,this.onRoomMemberUpdate),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return R(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var n=e.roomSubset.getLiveTimeline().getState(he.FORWARDS);n==null||n.off(ke.Members,e.onRoomMemberUpdate)})()}joinRoomSession(e,t,n){var i;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=new bm(n,this.roomSubset,this.client,()=>this.getOldestMembership(),this.logger);var a;if(n!=null&&n.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[s,l]=[this.client.getUserId(),this.client.getDeviceId()],[u,d,c]=[this.roomSubset,this.client,this.statistics],h=new xc(u,d,c),v=new Tm(s,l,u.roomId,d,c);a=new ql(v,h,this.logger),this.reEmitter.reEmit(a,[Ah.EnabledTransportsChanged]),this.encryptionManager=new Im(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(g,p,m)=>{this.emit(ti.EncryptionKeyChanged,g,p,m)},this.logger)}else a=new xc(this.roomSubset,this.client,this.statistics),this.encryptionManager=new Rm(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(g,p,m)=>{this.emit(ti.EncryptionKeyChanged,g,p,m)})}this.joinConfig=n,this.pendingNotificationToSend=(i=this.joinConfig)===null||i===void 0?void 0:i.notificationType,this.membershipManager.join(e,t,g=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",g),this.emit(ti.MembershipManagerError,g),this.emit(ti.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(n),this.emit(ti.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var i=t.membershipManager.leave(n);return t.emit(ti.JoinStateChanged,!1),yield i})()}getActiveFocus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if((e==null?void 0:e.getFocusSelection())==="oldest_membership")return e.getPreferredFoci()[0]}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,n)=>{t.forEach(i=>{this.emit(ti.EncryptionKeyChanged,i.key,i.keyIndex,n)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var n=t.getMsUntilExpiry();n!==void 0&&(e===void 0||n<e)&&(e=n)}e!=null&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}sendCallNotify(e,t){this.client.sendEvent(this.roomSubset.roomId,B.CallNotify,{application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:t==="notification"?"notify":t,call_id:this.callId}).catch(n=>this.logger.error("Failed to send call notification",n)),this.client.sendEvent(this.roomSubset.roomId,B.RTCNotification,{"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:Xe.unstable_RTCNotificationParent},sender_ts:Date.now(),lifetime:3e4}).catch(n=>this.logger.error("Failed to send call notification",n))}};o(Xa,"MatrixRTCSession");let Dc=Xa;var c0=function(r){return r.SessionStarted="session_started",r.SessionEnded="session_ended",r}({});const zS=class zS extends Ge{constructor(e,t){super(),this.client=t,f(this,"roomSessions",new Map),f(this,"logger",void 0),f(this,"onRoom",n=>{this.refreshRoom(n)}),f(this,"onRoomState",(n,i)=>{var a=this.client.getRoom(n.getRoomId());if(!a){this.logger.error("Got room state event for unknown room ".concat(n.getRoomId(),"!"));return}n.getType()==B.GroupCallMemberPrefix&&this.refreshRoom(a)}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,n=Dc.roomSessionForRoom(this.client,e);n.memberships.length>0&&this.roomSessions.set(e.roomId,n)}this.client.on(de.Room,this.onRoom),this.client.on(ke.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(de.Room,this.onRoom),this.client.off(ke.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,Dc.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),n=this.getRoomSession(e),i=n.memberships.length>0&&!t;n.onRTCSessionMemberUpdate();var a=n.memberships.length>0;i&&!a?(this.logger.trace("Session ended for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(c0.SessionEnded,e.roomId,this.roomSessions.get(e.roomId))):!i&&a&&(this.logger.trace("Session started for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(c0.SessionStarted,e.roomId,this.roomSessions.get(e.roomId)))}};o(zS,"MatrixRTCSessionManager");let Cm=zS;function Lf(r){return e=>{var t,n;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==r||((n=e.content)===null||n===void 0||(n=n["m.relates_to"])===null||n===void 0?void 0:n.rel_type)===We.name}}o(Lf,"getRelationsThreadFilter");function xI(r){return Om.apply(this,arguments)}o(xI,"sha256");function Om(){return Om=R(function*(r){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(r),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),Om.apply(this,arguments)}o(Om,"_sha");const JS=class JS extends Error{};o(JS,"InvalidTokenError");let aa=JS;aa.prototype.name="InvalidTokenError";function SN(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}o(SN,"b64DecodeUnicode");function EN(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return SN(e)}catch{return atob(e)}}o(EN,"base64UrlDecode");function DI(r,e){if(typeof r!="string")throw new aa("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=r.split(".")[t];if(typeof n!="string")throw new aa(`Invalid token specified: missing part #${t+1}`);let i;try{i=EN(n)}catch(a){throw new aa(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(i)}catch(a){throw new aa(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}o(DI,"jwtDecode");var _N={debug:o(()=>{},"debug"),info:o(()=>{},"info"),warn:o(()=>{},"warn"),error:o(()=>{},"error")},on,ln,Gl=(r=>(r[r.NONE=0]="NONE",r[r.ERROR=1]="ERROR",r[r.WARN=2]="WARN",r[r.INFO=3]="INFO",r[r.DEBUG=4]="DEBUG",r))(Gl||{});(r=>{function e(){on=3,ln=_N}o(e,"reset"),r.reset=e;function t(i){if(!(0<=i&&i<=4))throw new Error("Invalid log level");on=i}o(t,"setLevel"),r.setLevel=t;function n(i){ln=i}o(n,"setLogger"),r.setLogger=n})(Gl||(Gl={}));var Jt,vt=(Jt=class{constructor(e){this._name=e}debug(...e){on>=4&&ln.debug(Jt._format(this._name,this._method),...e)}info(...e){on>=3&&ln.info(Jt._format(this._name,this._method),...e)}warn(...e){on>=2&&ln.warn(Jt._format(this._name,this._method),...e)}error(...e){on>=1&&ln.error(Jt._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const n=new Jt(`${e}.${t}`);return n.debug("begin"),n}static _format(e,t){const n=`[${e}]`;return t?`${n} ${t}:`:n}static debug(e,...t){on>=4&&ln.debug(Jt._format(e),...t)}static info(e,...t){on>=3&&ln.info(Jt._format(e),...t)}static warn(e,...t){on>=2&&ln.warn(Jt._format(e),...t)}static error(e,...t){on>=1&&ln.error(Jt._format(e),...t)}},o(Jt,"_Logger"),Jt);Gl.reset();var ps,Nc=(ps=class{static decode(e){try{return DI(e)}catch(t){throw vt.error("JwtUtils.decode",t),t}}static async generateSignedJwt(e,t,n){const i=Qr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=Qr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(t))),s=`${i}.${a}`,l=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,new TextEncoder().encode(s)),u=Qr.encodeBase64Url(new Uint8Array(l));return`${s}.${u}`}},o(ps,"JwtUtils"),ps),bN="10000000-1000-4000-8000-100000000000",km=o(r=>btoa([...new Uint8Array(r)].map(e=>String.fromCharCode(e)).join("")),"toBase64"),Qt,NI=(Qt=class{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return bN.replace(/[018]/g,t=>(+t^Qt._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return Qt.generateUUIDv4()+Qt.generateUUIDv4()+Qt.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const n=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",n);return km(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw vt.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const i=new TextEncoder().encode([e,t].join(":"));return km(i)}static async hash(e,t){const n=new TextEncoder().encode(t),i=await crypto.subtle.digest(e,n);return new Uint8Array(i)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const n=await Qt.hash("SHA-256",JSON.stringify(t));return Qt.encodeBase64Url(n)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:n,keyPair:i,nonce:a}){let s,l;const u={jti:window.crypto.randomUUID(),htm:n??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(s=await Qt.hash("SHA-256",t),l=Qt.encodeBase64Url(s),u.ath=l),a&&(u.nonce=a);try{const d=await crypto.subtle.exportKey("jwk",i.publicKey),c={alg:"ES256",typ:"dpop+jwt",jwk:{crv:d.crv,kty:d.kty,x:d.x,y:d.y}};return await Nc.generateSignedJwt(c,u,i.privateKey)}catch(d){throw d instanceof TypeError?new Error(`Error exporting dpop public key: ${d.message}`):d}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await Qt.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}},o(Qt,"_CryptoUtils"),Qt);NI.encodeBase64Url=r=>km(r).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var Qr=NI,ms,wN=(ms=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new vt(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},o(ms,"Event"),ms),Un,Lc=(Un=class extends wN{constructor(){super(...arguments),this._logger=new vt(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Un.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Un.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const n=Un.getEpochTime()+e;if(this.expiration===n&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=n;const i=Math.min(e,5);this._timerHandle=setInterval(this._callback,i*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},o(Un,"_Timer"),Un),gs,h0=(gs=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");const i=new URL(e,"http://127.0.0.1")[t==="fragment"?"hash":"search"];return new URLSearchParams(i.slice(1))}},o(gs,"UrlUtils"),gs),Qs=";",ys,Ys=(ys=class extends Error{constructor(e,t){var n,i,a;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw vt.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=(n=e.error_description)!=null?n:null,this.error_uri=(i=e.error_uri)!=null?i:null,this.state=e.userState,this.session_state=(a=e.session_state)!=null?a:null,this.url_state=e.url_state}},o(ys,"ErrorResponse"),ys),Ss,TN=(Ss=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},o(Ss,"ErrorTimeout"),Ss),Es,RN=(Es=class{constructor(){this._logger=new vt("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},o(Es,"InMemoryWebStorage"),Es),_s,Pm=(_s=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},o(_s,"ErrorDPoPNonce"),_s),bs,uy=(bs=class{constructor(e=[],t=null,n={}){this._jwtHandler=t,this._extraHeaders=n,this._logger=new vt("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){const{timeoutInSeconds:n,...i}=t;if(!n)return await fetch(e,i);const a=new AbortController,s=setTimeout(()=>a.abort(),n*1e3);try{return await fetch(e,{...t,signal:a.signal})}catch(l){throw l instanceof DOMException&&l.name==="AbortError"?new TN("Network timed out"):l}finally{clearTimeout(s)}}async getJson(e,{token:t,credentials:n,timeoutInSeconds:i}={}){const a=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};t&&(a.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+t),this._appendExtraHeaders(s);let l;try{a.debug("url:",e),l=await this.fetchWithTimeout(e,{method:"GET",headers:s,timeoutInSeconds:i,credentials:n})}catch(c){throw a.error("Network Error"),c}a.debug("HTTP response received, status",l.status);const u=l.headers.get("Content-Type");if(u&&!this._contentTypes.find(c=>u.startsWith(c))&&a.throw(new Error(`Invalid response Content-Type: ${u??"undefined"}, from URL: ${e}`)),l.ok&&this._jwtHandler&&(u!=null&&u.startsWith("application/jwt")))return await this._jwtHandler(await l.text());let d;try{d=await l.json()}catch(c){throw a.error("Error parsing JSON response",c),l.ok?c:new Error(`${l.statusText} (${l.status})`)}if(!l.ok)throw a.error("Error from server:",d),d.error?new Ys(d):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(d)}`);return d}async postForm(e,{body:t,basicAuth:n,timeoutInSeconds:i,initCredentials:a,extraHeaders:s}){const l=this._logger.create("postForm"),u={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...s};n!==void 0&&(u.Authorization="Basic "+n),this._appendExtraHeaders(u);let d;try{l.debug("url:",e),d=await this.fetchWithTimeout(e,{method:"POST",headers:u,body:t,timeoutInSeconds:i,credentials:a})}catch(g){throw l.error("Network error"),g}l.debug("HTTP response received, status",d.status);const c=d.headers.get("Content-Type");if(c&&!this._contentTypes.find(g=>c.startsWith(g)))throw new Error(`Invalid response Content-Type: ${c??"undefined"}, from URL: ${e}`);const h=await d.text();let v={};if(h)try{v=JSON.parse(h)}catch(g){throw l.error("Error parsing JSON response",g),d.ok?g:new Error(`${d.statusText} (${d.status})`)}if(!d.ok){if(l.error("Error from server:",v),d.headers.has("dpop-nonce")){const g=d.headers.get("dpop-nonce");throw new Pm(g,`${JSON.stringify(v)}`)}throw v.error?new Ys(v,t):new Error(`${d.statusText} (${d.status}): ${JSON.stringify(v)}`)}return v}_appendExtraHeaders(e){const t=this._logger.create("appendExtraHeaders"),n=Object.keys(this._extraHeaders),i=["accept","content-type"],a=["authorization"];n.length!==0&&n.forEach(s=>{if(i.includes(s.toLocaleLowerCase())){t.warn("Protected header could not be set",s,i);return}if(a.includes(s.toLocaleLowerCase())&&Object.keys(e).includes(s)){t.warn("Header could not be overridden",s,a);return}const l=typeof this._extraHeaders[s]=="function"?this._extraHeaders[s]():this._extraHeaders[s];l&&l!==""&&(e[s]=l)})}},o(bs,"JsonService"),bs),ws,LI=(ws=class{constructor(e){this._settings=e,this._logger=new vt("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new uy(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);const t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},t,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){const n=this._logger.create(`_getMetadataProperty('${e}')`),i=await this.getMetadata();if(n.debug("resolved"),i[e]===void 0){if(t===!0){n.warn("Metadata does not contain optional property");return}n.throw(new Error("Metadata does not contain property "+e))}return i[e]}async getSigningKeys(){const e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;const t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);const n=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",n),!Array.isArray(n.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=n.keys,this._signingKeys}},o(ws,"MetadataService"),ws),Ts,xh=(Ts=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new vt("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){return this._logger.create(`get('${e}')`),e=this._prefix+e,await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");const e=await this._store.length,t=[];for(let n=0;n<e;n++){const i=await this._store.key(n);i&&i.indexOf(this._prefix)===0&&t.push(i.substr(this._prefix.length))}return t}},o(Ts,"WebStorageStateStore"),Ts),IN="code",CN="openid",ON="client_secret_post",kN=60*15,Rs,Mm=(Rs=class{constructor({authority:e,metadataUrl:t,metadata:n,signingKeys:i,metadataSeed:a,client_id:s,client_secret:l,response_type:u=IN,scope:d=CN,redirect_uri:c,post_logout_redirect_uri:h,client_authentication:v=ON,prompt:g,display:p,max_age:m,ui_locales:T,acr_values:y,resource:S,response_mode:w,filterProtocolClaims:C=!0,loadUserInfo:M=!1,requestTimeoutInSeconds:_,staleStateAgeInSeconds:O=kN,mergeClaimsStrategy:b={array:"replace"},disablePKCE:F=!1,stateStore:V,revokeTokenAdditionalContentTypes:z,fetchRequestCredentials:ie,refreshTokenAllowedScope:se,extraQueryParams:Pe={},extraTokenParams:Ce={},extraHeaders:$e={},dpop:re,omitScopeWhenRequesting:Y=!1}){var le;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=n,this.metadataSeed=a,this.signingKeys=i,this.client_id=s,this.client_secret=l,this.response_type=u,this.scope=d,this.redirect_uri=c,this.post_logout_redirect_uri=h,this.client_authentication=v,this.prompt=g,this.display=p,this.max_age=m,this.ui_locales=T,this.acr_values=y,this.resource=S,this.response_mode=w,this.filterProtocolClaims=C??!0,this.loadUserInfo=!!M,this.staleStateAgeInSeconds=O,this.mergeClaimsStrategy=b,this.omitScopeWhenRequesting=Y,this.disablePKCE=!!F,this.revokeTokenAdditionalContentTypes=z,this.fetchRequestCredentials=ie||"same-origin",this.requestTimeoutInSeconds=_,V)this.stateStore=V;else{const me=typeof window<"u"?window.localStorage:new RN;this.stateStore=new xh({store:me})}if(this.refreshTokenAllowedScope=se,this.extraQueryParams=Pe,this.extraTokenParams=Ce,this.extraHeaders=$e,this.dpop=re,this.dpop&&!((le=this.dpop)!=null&&le.store))throw new Error("A DPoPStore is required when dpop is enabled")}},o(Rs,"OidcClientSettingsStore"),Rs),Is,PN=(Is=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new vt("UserInfoService"),this._getClaimsFromJwt=async n=>{const i=this._logger.create("_getClaimsFromJwt");try{const a=Nc.decode(n);return i.debug("JWT decoding successful"),a}catch(a){throw i.error("Error parsing JWT response"),a}},this._jsonService=new uy(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){const t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));const n=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",n);const i=await this._jsonService.getJson(n,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",i),i}},o(Is,"UserInfoService"),Is),Cs,UI=(Cs=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new vt("TokenClient"),this._jsonService=new uy(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:n=this._settings.client_id,client_secret:i=this._settings.client_secret,extraHeaders:a,...s}){const l=this._logger.create("exchangeCode");n||l.throw(new Error("A client_id is required")),t||l.throw(new Error("A redirect_uri is required")),s.code||l.throw(new Error("A code is required"));const u=new URLSearchParams({grant_type:e,redirect_uri:t});for(const[v,g]of Object.entries(s))g!=null&&u.set(v,g);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(i==null)throw l.throw(new Error("A client_secret is required")),null;d=Qr.generateBasicAuth(n,i);break;case"client_secret_post":u.append("client_id",n),i&&u.append("client_secret",i);break}const c=await this._metadataService.getTokenEndpoint(!1);l.debug("got token endpoint");const h=await this._jsonService.postForm(c,{body:u,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:a});return l.debug("got response"),h}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,scope:i=this._settings.scope,...a}){const s=this._logger.create("exchangeCredentials");t||s.throw(new Error("A client_id is required"));const l=new URLSearchParams({grant_type:e});this._settings.omitScopeWhenRequesting||l.set("scope",i);for(const[h,v]of Object.entries(a))v!=null&&l.set(h,v);let u;switch(this._settings.client_authentication){case"client_secret_basic":if(n==null)throw s.throw(new Error("A client_secret is required")),null;u=Qr.generateBasicAuth(t,n);break;case"client_secret_post":l.append("client_id",t),n&&l.append("client_secret",n);break}const d=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const c=await this._jsonService.postForm(d,{body:l,basicAuth:u,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return s.debug("got response"),c}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,timeoutInSeconds:i,extraHeaders:a,...s}){const l=this._logger.create("exchangeRefreshToken");t||l.throw(new Error("A client_id is required")),s.refresh_token||l.throw(new Error("A refresh_token is required"));const u=new URLSearchParams({grant_type:e});for(const[v,g]of Object.entries(s))Array.isArray(g)?g.forEach(p=>u.append(v,p)):g!=null&&u.set(v,g);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(n==null)throw l.throw(new Error("A client_secret is required")),null;d=Qr.generateBasicAuth(t,n);break;case"client_secret_post":u.append("client_id",t),n&&u.append("client_secret",n);break}const c=await this._metadataService.getTokenEndpoint(!1);l.debug("got token endpoint");const h=await this._jsonService.postForm(c,{body:u,basicAuth:d,timeoutInSeconds:i,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:a});return l.debug("got response"),h}async revoke(e){var t;const n=this._logger.create("revoke");e.token||n.throw(new Error("A token is required"));const i=await this._metadataService.getRevocationEndpoint(!1);n.debug(`got revocation endpoint, revoking ${(t=e.token_type_hint)!=null?t:"default token type"}`);const a=new URLSearchParams;for(const[s,l]of Object.entries(e))l!=null&&a.set(s,l);a.set("client_id",this._settings.client_id),this._settings.client_secret&&a.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(i,{body:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),n.debug("got response")}},o(Cs,"TokenClient"),Cs),Os,MN=(Os=class{constructor(e,t,n){this._settings=e,this._metadataService=t,this._claimsService=n,this._logger=new vt("ResponseValidator"),this._userInfoService=new PN(this._settings,this._metadataService),this._tokenClient=new UI(this._settings,this._metadataService)}async validateSigninResponse(e,t,n){const i=this._logger.create("validateSigninResponse");this._processSigninState(e,t),i.debug("state processed"),await this._processCode(e,t,n),i.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),i.debug("tokens validated"),await this._processClaims(e,t==null?void 0:t.skipUserInfo,e.isOpenId),i.debug("claims processed")}async validateCredentialsResponse(e,t){const n=this._logger.create("validateCredentialsResponse"),i=e.isOpenId&&!!e.id_token;i&&this._validateIdTokenAttributes(e),n.debug("tokens validated"),await this._processClaims(e,t,i),n.debug("claims processed")}async validateRefreshResponse(e,t){var n,i;const a=this._logger.create("validateRefreshResponse");e.userState=t.data,(n=e.session_state)!=null||(e.session_state=t.session_state),(i=e.scope)!=null||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),a.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);const s=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,s),a.debug("claims processed")}validateSignoutResponse(e,t){const n=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&n.throw(new Error("State does not match")),n.debug("state validated"),e.userState=t.data,e.error)throw n.warn("Response was error",e.error),new Ys(e)}_processSigninState(e,t){var n;const i=this._logger.create("_processSigninState");if(t.id!==e.state&&i.throw(new Error("State does not match")),t.client_id||i.throw(new Error("No client_id on state")),t.authority||i.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&i.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&i.throw(new Error("client_id mismatch on settings vs. signin state")),i.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,(n=e.scope)!=null||(e.scope=t.scope),e.error)throw i.warn("Response was error",e.error),new Ys(e);t.code_verifier&&!e.code&&i.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,n=!0){const i=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token){i.debug("not loading user info");return}i.debug("loading user info");const a=await this._userInfoService.getClaims(e.access_token);i.debug("user info claims received from user info endpoint"),n&&a.sub!==e.profile.sub&&i.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(a)),i.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,n){const i=this._logger.create("_processCode");if(e.code){i.debug("Validating code");const a=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:n,...t.extraTokenParams});Object.assign(e,a)}else i.debug("No code to process")}_validateIdTokenAttributes(e,t){var n;const i=this._logger.create("_validateIdTokenAttributes");i.debug("decoding ID Token JWT");const a=Nc.decode((n=e.id_token)!=null?n:"");if(a.sub||i.throw(new Error("ID Token is missing a subject claim")),t){const s=Nc.decode(t);a.sub!==s.sub&&i.throw(new Error("sub in id_token does not match current sub")),a.auth_time&&a.auth_time!==s.auth_time&&i.throw(new Error("auth_time in id_token does not match original auth_time")),a.azp&&a.azp!==s.azp&&i.throw(new Error("azp in id_token does not match original azp")),!a.azp&&s.azp&&i.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=a}},o(Os,"ResponseValidator"),Os),Ci,Uc=(Ci=class{constructor(e){this.id=e.id||Qr.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=Lc.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new vt("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return vt.createStatic("State","fromStorageString"),Promise.resolve(new Ci(JSON.parse(e)))}static async clearStaleState(e,t){const n=vt.createStatic("State","clearStaleState"),i=Lc.getEpochTime()-t,a=await e.getAllKeys();n.debug("got keys",a);for(let s=0;s<a.length;s++){const l=a[s],u=await e.get(l);let d=!1;if(u)try{const c=await Ci.fromStorageString(u);n.debug("got item from key:",l,c.created),c.created<=i&&(d=!0)}catch(c){n.error("Error parsing state for key:",l,c),d=!0}else n.debug("no item in storage for key:",l),d=!0;d&&(n.debug("removed item for key:",l),e.remove(l))}}},o(Ci,"_State"),Ci),Oi,dy=(Oi=class extends Uc{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?Qr.generateCodeVerifier():e.code_verifier||void 0,n=t?await Qr.generateCodeChallenge(t):void 0;return new Oi({...e,code_verifier:t,code_challenge:n})}toStorageString(){return new vt("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){vt.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return Oi.create(t)}},o(Oi,"_SigninState"),Oi),ca,jI=(ca=class{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:n,redirect_uri:i,response_type:a,scope:s,state_data:l,response_mode:u,request_type:d,client_secret:c,nonce:h,url_state:v,resource:g,skipUserInfo:p,extraQueryParams:m,extraTokenParams:T,disablePKCE:y,dpopJkt:S,omitScopeWhenRequesting:w,...C}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const M=await dy.create({data:l,request_type:d,url_state:v,code_verifier:!y,client_id:n,authority:t,redirect_uri:i,response_mode:u,client_secret:c,scope:s,extraTokenParams:T,skipUserInfo:p}),_=new URL(e);_.searchParams.append("client_id",n),_.searchParams.append("redirect_uri",i),_.searchParams.append("response_type",a),w||_.searchParams.append("scope",s),h&&_.searchParams.append("nonce",h),S&&_.searchParams.append("dpop_jkt",S);let O=M.id;v&&(O=`${O}${Qs}${v}`),_.searchParams.append("state",O),M.code_challenge&&(_.searchParams.append("code_challenge",M.code_challenge),_.searchParams.append("code_challenge_method","S256")),g&&(Array.isArray(g)?g:[g]).forEach(F=>_.searchParams.append("resource",F));for(const[b,F]of Object.entries({response_mode:u,...C,...m}))F!=null&&_.searchParams.append(b,F.toString());return new ca({url:_.href,state:M})}},o(ca,"_SigninRequest"),ca);jI._logger=new vt("SigninRequest");var AN=jI,xN="openid",ks,Sd=(ks=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){const t=decodeURIComponent(this.state).split(Qs);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(Qs))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-Lc.getEpochTime()}set expires_in(e){typeof e=="string"&&(e=Number(e)),e!==void 0&&e>=0&&(this.expires_at=Math.floor(e)+Lc.getEpochTime())}get isOpenId(){var e;return((e=this.scope)==null?void 0:e.split(" ").includes(xN))||!!this.id_token}},o(ks,"SigninResponse"),ks),Ps,DN=(Ps=class{constructor({url:e,state_data:t,id_token_hint:n,post_logout_redirect_uri:i,extraQueryParams:a,request_type:s,client_id:l,url_state:u}){if(this._logger=new vt("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");const d=new URL(e);if(n&&d.searchParams.append("id_token_hint",n),l&&d.searchParams.append("client_id",l),i&&(d.searchParams.append("post_logout_redirect_uri",i),t||u)){this.state=new Uc({data:t,request_type:s,url_state:u});let c=this.state.id;u&&(c=`${c}${Qs}${u}`),d.searchParams.append("state",c)}for(const[c,h]of Object.entries({...a}))h!=null&&d.searchParams.append(c,h.toString());this.url=d.href}},o(Ps,"SignoutRequest"),Ps),Ms,NN=(Ms=class{constructor(e){if(this.state=e.get("state"),this.state){const t=decodeURIComponent(this.state).split(Qs);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(Qs))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},o(Ms,"SignoutResponse"),Ms),LN=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],UN=["sub","iss","aud","exp","iat"],As,jN=(As=class{constructor(e){this._settings=e,this._logger=new vt("ClaimsService")}filterProtocolClaims(e){const t={...e};if(this._settings.filterProtocolClaims){let n;Array.isArray(this._settings.filterProtocolClaims)?n=this._settings.filterProtocolClaims:n=LN;for(const i of n)UN.includes(i)||delete t[i]}return t}mergeClaims(e,t){const n={...e};for(const[i,a]of Object.entries(t))if(n[i]!==a)if(Array.isArray(n[i])||Array.isArray(a))if(this._settings.mergeClaimsStrategy.array=="replace")n[i]=a;else{const s=Array.isArray(n[i])?n[i]:[n[i]];for(const l of Array.isArray(a)?a:[a])s.includes(l)||s.push(l);n[i]=s}else typeof n[i]=="object"&&typeof a=="object"?n[i]=this.mergeClaims(n[i],a):n[i]=a;return n}},o(As,"ClaimsService"),As),xs,FN=(xs=class{constructor(e,t){this.keys=e,this.nonce=t}},o(xs,"DPoPState"),xs),Ds,cy=(Ds=class{constructor(e,t){this._logger=new vt("OidcClient"),this.settings=e instanceof Mm?e:new Mm(e),this.metadataService=t??new LI(this.settings),this._claimsService=new jN(this.settings),this._validator=new MN(this.settings,this.metadataService,this._claimsService),this._tokenClient=new UI(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:n,request_type:i,id_token_hint:a,login_hint:s,skipUserInfo:l,nonce:u,url_state:d,response_type:c=this.settings.response_type,scope:h=this.settings.scope,redirect_uri:v=this.settings.redirect_uri,prompt:g=this.settings.prompt,display:p=this.settings.display,max_age:m=this.settings.max_age,ui_locales:T=this.settings.ui_locales,acr_values:y=this.settings.acr_values,resource:S=this.settings.resource,response_mode:w=this.settings.response_mode,extraQueryParams:C=this.settings.extraQueryParams,extraTokenParams:M=this.settings.extraTokenParams,dpopJkt:_,omitScopeWhenRequesting:O=this.settings.omitScopeWhenRequesting}){const b=this._logger.create("createSigninRequest");if(c!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const F=await this.metadataService.getAuthorizationEndpoint();b.debug("Received authorization endpoint",F);const V=await AN.create({url:F,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:v,response_type:c,scope:h,state_data:e,url_state:d,prompt:g,display:p,max_age:m,ui_locales:T,id_token_hint:a,login_hint:s,acr_values:y,dpopJkt:_,resource:S,request:t,request_uri:n,extraQueryParams:C,extraTokenParams:M,request_type:i,response_mode:w,client_secret:this.settings.client_secret,skipUserInfo:l,nonce:u,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:O});await this.clearStaleState();const z=V.state;return await this.settings.stateStore.set(z.id,z.toStorageString()),V}async readSigninResponseState(e,t=!1){const n=this._logger.create("readSigninResponseState"),i=new Sd(h0.readParams(e,this.settings.response_mode));if(!i.state)throw n.throw(new Error("No state in response")),null;const a=await this.settings.stateStore[t?"remove":"get"](i.state);if(!a)throw n.throw(new Error("No matching state found in storage")),null;return{state:await dy.fromStorageString(a),response:i}}async processSigninResponse(e,t,n=!0){const i=this._logger.create("processSigninResponse"),{state:a,response:s}=await this.readSigninResponseState(e,n);if(i.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const l=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:l}}try{await this._validator.validateSigninResponse(s,a,t)}catch(l){if(l instanceof Pm&&this.settings.dpop){const u=await this.getDpopProof(this.settings.dpop.store,l.nonce);t.DPoP=u,await this._validator.validateSigninResponse(s,a,t)}else throw l}return s}async getDpopProof(e,t){let n,i;return(await e.getAllKeys()).includes(this.settings.client_id)?(i=await e.get(this.settings.client_id),i.nonce!==t&&t&&(i.nonce=t,await e.set(this.settings.client_id,i))):(n=await Qr.generateDPoPKeys(),i=new FN(n,t),await e.set(this.settings.client_id,i)),await Qr.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:i.keys,nonce:i.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:n=!1,extraTokenParams:i={}}){const a=await this._tokenClient.exchangeCredentials({username:e,password:t,...i}),s=new Sd(new URLSearchParams);return Object.assign(s,a),await this._validator.validateCredentialsResponse(s,n),s}async useRefreshToken({state:e,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,extraTokenParams:s}){var l;const u=this._logger.create("useRefreshToken");let d;if(this.settings.refreshTokenAllowedScope===void 0)d=e.scope;else{const v=this.settings.refreshTokenAllowedScope.split(" ");d=(((l=e.scope)==null?void 0:l.split(" "))||[]).filter(p=>v.includes(p)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const v=await this.getDpopProof(this.settings.dpop.store);a={...a,DPoP:v}}let c;try{c=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:d,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,...s})}catch(v){if(v instanceof Pm&&this.settings.dpop)a.DPoP=await this.getDpopProof(this.settings.dpop.store,v.nonce),c=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:d,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,...s});else throw v}const h=new Sd(new URLSearchParams);return Object.assign(h,c),u.debug("validating response",h),await this._validator.validateRefreshResponse(h,{...e,scope:d}),h}async createSignoutRequest({state:e,id_token_hint:t,client_id:n,request_type:i,url_state:a,post_logout_redirect_uri:s=this.settings.post_logout_redirect_uri,extraQueryParams:l=this.settings.extraQueryParams}={}){const u=this._logger.create("createSignoutRequest"),d=await this.metadataService.getEndSessionEndpoint();if(!d)throw u.throw(new Error("No end session endpoint")),null;u.debug("Received end session endpoint",d),!n&&s&&!t&&(n=this.settings.client_id);const c=new DN({url:d,id_token_hint:t,client_id:n,post_logout_redirect_uri:s,state_data:e,extraQueryParams:l,request_type:i,url_state:a});await this.clearStaleState();const h=c.state;return h&&(u.debug("Signout request has state to persist"),await this.settings.stateStore.set(h.id,h.toStorageString())),c}async readSignoutResponseState(e,t=!1){const n=this._logger.create("readSignoutResponseState"),i=new NN(h0.readParams(e,this.settings.response_mode));if(!i.state){if(n.debug("No state in response"),i.error)throw n.warn("Response was error:",i.error),new Ys(i);return{state:void 0,response:i}}const a=await this.settings.stateStore[t?"remove":"get"](i.state);if(!a)throw n.throw(new Error("No matching state found in storage")),null;return{state:await Uc.fromStorageString(a),response:i}}async processSignoutResponse(e){const t=this._logger.create("processSignoutResponse"),{state:n,response:i}=await this.readSignoutResponseState(e,!0);return n?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(i,n)):t.debug("No state from storage; skipping response validation"),i}clearStaleState(){return this._logger.create("clearStaleState"),Uc.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}},o(Ds,"OidcClient"),Ds),Vt=function(r){return r.NotSupported="OIDC authentication not supported",r.Misconfigured="OIDC is misconfigured",r.General="Something went wrong with OIDC discovery",r.OpSupport="Configured OIDC OP does not support required functions",r.DynamicRegistrationNotSupported="Dynamic registration not supported",r.DynamicRegistrationFailed="Dynamic registration failed",r.DynamicRegistrationInvalid="Dynamic registration invalid response",r.CodeExchangeFailed="Failed to exchange code for token",r.InvalidBearerTokenResponse="Invalid bearer token response",r.InvalidIdToken="Invalid ID token",r.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",r}({}),hy=o(r=>!!r&&typeof r=="object"&&!Array.isArray(r),"isRecord"),Ln=o((r,e)=>!r[e]||!ol(r,e)?(I.error("Missing or invalid property: ".concat(e)),!1):!0,"requiredStringProperty"),ol=o((r,e)=>r[e]&&typeof r[e]!="string"?(I.error("Invalid property: ".concat(e)),!1):!0,"optionalStringProperty"),f0=o((r,e)=>r[e]&&(!Array.isArray(r[e])||!r[e].every(t=>typeof t=="string"))?(I.error("Invalid property: ".concat(e)),!1):!0,"optionalStringArrayProperty"),Uf=o((r,e,t)=>{var n=r[e];return!n||!Array.isArray(n)||!n.includes(t)?(I.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},"requiredArrayValue"),FI=o(r=>{if(!hy(r))throw I.error("Issuer configuration not found or malformed"),new Error(Vt.OpSupport);var e=[Ln(r,"issuer"),Ln(r,"authorization_endpoint"),Ln(r,"token_endpoint"),Ln(r,"revocation_endpoint"),ol(r,"registration_endpoint"),ol(r,"account_management_uri"),ol(r,"device_authorization_endpoint"),f0(r,"account_management_actions_supported"),Uf(r,"response_types_supported","code"),Uf(r,"grant_types_supported","authorization_code"),Uf(r,"code_challenge_methods_supported","S256"),f0(r,"prompt_values_supported")].some(t=>!t);if(!e)return r;throw I.error("Issuer configuration not valid"),new Error(Vt.OpSupport)},"validateAuthMetadata"),BI=o(r=>{try{return DI(r)}catch(e){throw I.error("Could not decode id_token",e),e}},"decodeIdToken"),$I=o((r,e,t,n)=>{try{if(!r)throw new Error("No ID token");var i=BI(r);if(i.iss!==e)throw new Error("Invalid issuer");var a=typeof i.aud=="string"?[i.aud]:i.aud;if(!a.includes(t))throw new Error("Invalid audience");if(n!==void 0&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>i.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw I.error("Invalid ID token",s),new Error(Vt.InvalidIdToken)}},"validateIdToken");function WI(r){if(!hy(r))throw I.error("Stored user state not found"),new Error(Vt.MissingOrInvalidStoredState);var e=[Ln(r,"homeserverUrl"),Ln(r,"nonce"),ol(r,"identityServerUrl")].some(t=>!t);if(e)throw new Error(Vt.MissingOrInvalidStoredState)}o(WI,"validateStoredUserState");var BN=o(r=>hy(r)&&Ln(r,"token_type")&&r.token_type.toLowerCase()==="bearer"&&Ln(r,"access_token")&&Ln(r,"refresh_token")&&(!("expires_in"in r)||typeof r.expires_in=="number"),"isValidBearerTokenResponse");function KI(r){if(!BN(r))throw new Error(Vt.InvalidBearerTokenResponse)}o(KI,"validateBearerTokenResponse");function v0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(v0,"ownKeys$4");function jc(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?v0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):v0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(jc,"_objectSpread$4");var Dh=o(r=>{var e=r??Ri(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},"generateScope"),$N=function(){var r=R(function*(e){if(!globalThis.crypto.subtle)return I.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield xI(e);return Ph(t)});return o(function(t){return r.apply(this,arguments)},"generateCodeChallenge")}(),WN=o(r=>{var{redirectUri:e}=r;return{scope:Dh(),redirectUri:e,state:Ri(8),nonce:Ri(8),codeVerifier:Ri(64)}},"generateAuthorizationParams"),KN=function(){var r=R(function*(e,t,n){var{scope:i,redirectUri:a,state:s,nonce:l,codeVerifier:u}=n,d=new URL(e);return d.searchParams.append("response_mode","query"),d.searchParams.append("response_type","code"),d.searchParams.append("redirect_uri",a),d.searchParams.append("client_id",t),d.searchParams.append("state",s),d.searchParams.append("scope",i),d.searchParams.append("nonce",l),d.searchParams.append("code_challenge_method","S256"),d.searchParams.append("code_challenge",yield $N(u)),d.toString()});return o(function(t,n,i){return r.apply(this,arguments)},"generateAuthorizationUrl")}(),VN=function(){var r=R(function*(e){var{metadata:t,redirectUri:n,clientId:i,homeserverUrl:a,identityServerUrl:s,nonce:l,prompt:u,urlState:d}=e,c=Dh(),h=new cy(jc(jc({},t),{},{client_id:i,redirect_uri:n,authority:t.issuer,response_mode:"query",response_type:"code",scope:c,stateStore:new xh({prefix:"mx_oidc_",store:window.sessionStorage})})),v={homeserverUrl:a,nonce:l,identityServerUrl:s},g=yield h.createSigninRequest({state:v,nonce:l,prompt:u,url_state:d});return g.url});return o(function(t){return r.apply(this,arguments)},"generateOidcAuthorizationUrl")}(),qN=o(r=>({id_token:r.id_token,scope:r.scope,expires_at:r.expires_at,refresh_token:r.refresh_token,access_token:r.access_token,token_type:"Bearer"}),"normalizeBearerTokenResponseTokenType"),GN=function(){var r=R(function*(e,t){var n=new URL(window.location.origin);n.searchParams.append("code",e),n.searchParams.append("state",t),Gl.setLogger(I);try{var i=new Sd(n.searchParams),a=new xh({prefix:"mx_oidc_",store:window.sessionStorage}),s=yield a.get(i.state);if(!s)throw new Error(Vt.MissingOrInvalidStoredState);var l=yield dy.fromStorageString(s),u=new cy(jc(jc({},l),{},{stateStore:a})),d=yield u.processSigninResponse(n.href),c=d.userState;WI(c),KI(d),$I(d.id_token,u.settings.authority,u.settings.client_id,c.nonce);var h=qN(d);return{oidcClientSettings:{clientId:u.settings.client_id,issuer:u.settings.authority},tokenResponse:h,homeserverUrl:c.homeserverUrl,identityServerUrl:c.identityServerUrl,idTokenClaims:d.profile}}catch(g){I.error("Oidc login failed",g);var v=g.message;throw Object.values(Vt).includes(v)?g:new Error(Vt.CodeExchangeFailed)}});return o(function(t,n){return r.apply(this,arguments)},"completeAuthorizationCodeGrant")}();function p0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(p0,"ownKeys$3");function m0(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?p0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):p0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(m0,"_objectSpread$3");var fy=function(){var r=R(function*(e){var t=new URL(".well-known/openid-configuration",e),n=yield fetch(t,{method:G.Get,signal:kh(5e3)}),i=yield n.json();return vy(i)});return o(function(t){return r.apply(this,arguments)},"discoverAndValidateOIDCIssuerWellKnown")}(),vy=function(){var r=R(function*(e){var t=FI(e),n=new Mm({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),i=new LI(n);return m0(m0({},t),{},{signingKeys:yield i.getSigningKeys()})});return o(function(t){return r.apply(this,arguments)},"validateAuthMetadataAndKeys")}(),HN="urn:ietf:params:oauth:grant-type:device_code",jf=o((r,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==r.protocol||t.hostname!==r.hostname&&!t.hostname.endsWith(".".concat(r.hostname)))},"urlHasCommonBase"),zN=function(){var r=R(function*(e,t){if(!e.registration_endpoint)throw new Error(Vt.DynamicRegistrationNotSupported);var n=["authorization_code","refresh_token"];if(n.some(c=>!e.grant_types_supported.includes(c)))throw new Error(Vt.DynamicRegistrationNotSupported);var i=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:n,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:jf(i,t.logoUri)?t.logoUri:void 0,policy_uri:jf(i,t.policyUri)?t.policyUri:void 0,tos_uri:jf(i,t.tosUri)?t.tosUri:void 0},s={Accept:"application/json","Content-Type":"application/json"};try{var l=yield fetch(e.registration_endpoint,{method:G.Post,headers:s,body:JSON.stringify(a)});if(l.status>=400)throw new Error(Vt.DynamicRegistrationFailed);var u=yield l.json(),d=u.client_id;if(!d||typeof d!="string")throw new Error(Vt.DynamicRegistrationInvalid);return d}catch(c){throw Object.values(Vt).includes(c.message)?c:(I.error("Dynamic registration request failed",c),new Error(Vt.DynamicRegistrationFailed))}});return o(function(t,n){return r.apply(this,arguments)},"registerOidcClient")}();const QS=class QS{constructor(e,t,n,i,a){this.idTokenClaims=a,f(this,"oidcClientReady",void 0),f(this,"oidcClient",void 0),f(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,i,n)}initialiseOidcClient(e,t,n,i){var a=this;return R(function*(){try{var s,l=yield fy(e),u=Dh(n);a.oidcClient=new cy({metadata:l,signingKeys:(s=l.signingKeys)!==null&&s!==void 0?s:void 0,client_id:t,scope:u,redirect_uri:i,authority:l.issuer,stateStore:new xh({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(d){throw I.error("Failed to initialise OIDC client.",d),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return R(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var n=yield t.inflightRefreshRequest;return n}catch(i){throw i instanceof Ys?new Ll(i):i}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return R(function*(){})()}getNewTokens(e){var t=this;return R(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var n={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},i=Date.now(),a=yield t.oidcClient.useRefreshToken({state:n,timeoutInSeconds:300}),s={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(i+a.expires_in*1e3):void 0};return yield t.persistTokens(s),s})()}};o(QS,"OidcTokenRefresher");let Am=QS;var JN=["server","limit","since"];function g0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(g0,"ownKeys$2");function _t(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?g0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):g0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(_t,"_objectSpread$2");var QN=3e3,y0=10*60*1e3,YN=new pt("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),Xs=function(r){return r.Chronological="chronological",r.Detached="detached",r}({}),XN=new iu("m.get_login_token","org.matrix.msc3882.get_login_token"),VI="uk.half-shot.msc2666",qI="uk.half-shot.msc2666.mutual_rooms",GI="uk.half-shot.msc2666.query_mutual_rooms",cn="org.matrix.msc4140",HI="uk.tcpip.msc4133",tn="$",de=function(r){return r.Sync="sync",r.Event="event",r.ToDeviceEvent="toDeviceEvent",r.ReceivedToDeviceMessage="receivedToDeviceMessage",r.AccountData="accountData",r.Room="Room",r.DeleteRoom="deleteRoom",r.SyncUnexpectedError="sync.unexpectedError",r.ClientWellKnown="WellKnown.client",r.ReceivedVoipEvent="received_voip_event",r.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",r.TurnServers="turnServers",r.TurnServersError="turnServers.error",r}({}),ZN=new pt("action","org.matrix.msc3824.action");const YS=class YS extends Ge{constructor(e){var t,n,i,a;super(),i=this,f(this,"logger",void 0),f(this,"reEmitter",new Ai(this)),f(this,"olmVersion",null),f(this,"usingExternalCrypto",!1),f(this,"_store",void 0),f(this,"deviceId",void 0),f(this,"credentials",void 0),f(this,"legacyPickleKey",void 0),f(this,"scheduler",void 0),f(this,"clientRunning",!1),f(this,"timelineSupport",!1),f(this,"urlPreviewCache",{}),f(this,"identityServer",void 0),f(this,"http",void 0),f(this,"cryptoBackend",void 0),f(this,"cryptoCallbacks",void 0),f(this,"callEventHandler",void 0),f(this,"groupCallEventHandler",void 0),f(this,"supportsCallTransfer",!1),f(this,"forceTURN",!1),f(this,"iceCandidatePoolSize",0),f(this,"idBaseUrl",void 0),f(this,"baseUrl",void 0),f(this,"isVoipWithNoMediaAllowed",void 0),f(this,"useLivekitForGroupCalls",void 0),f(this,"canSupportVoip",!1),f(this,"peekSync",null),f(this,"isGuestAccount",!1),f(this,"ongoingScrollbacks",{}),f(this,"notifTimelineSet",null),f(this,"legacyCryptoStore",void 0),f(this,"verificationMethods",void 0),f(this,"fallbackICEServerAllowed",!1),f(this,"syncApi",void 0),f(this,"roomNameGenerator",void 0),f(this,"pushRules",void 0),f(this,"syncLeftRoomsPromise",void 0),f(this,"syncedLeftRooms",!1),f(this,"clientOpts",void 0),f(this,"clientWellKnownIntervalID",void 0),f(this,"canResetTimelineCallback",void 0),f(this,"canSupport",new Map),f(this,"pushProcessor",new $l(this)),f(this,"serverVersionsPromise",void 0),f(this,"clientWellKnown",void 0),f(this,"clientWellKnownPromise",void 0),f(this,"turnServers",[]),f(this,"turnServersExpiry",0),f(this,"checkTurnServersIntervalID",void 0),f(this,"txnCtr",0),f(this,"mediaHandler",new im(this)),f(this,"sessionId",void 0),f(this,"eventsBeingEncrypted",new Set),f(this,"useE2eForGroupCall",!0),f(this,"toDeviceMessageQueue",void 0),f(this,"livekitServiceURL",void 0),f(this,"_secretStorage",void 0),f(this,"ignoredInvites",void 0),f(this,"matrixRTC",void 0),f(this,"serverCapabilitiesService",void 0),f(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(tm()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(de.Sync,this.startCallEventHandler))}),f(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(de.Sync,this.startMatrixRTC))}),f(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var l,u=((l=this.getRooms())!==null&&l!==void 0?l:[]).filter(h=>h.getUnreadNotificationCount(De.Total)>0);for(var d of u){var c=this.getSafeUserId();d.fixupNotifications(c)}this.off(de.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:I,e.baseUrl=yf(e.baseUrl),e.idBaseUrl=yf(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(n=e.usingExternalCrypto)!==null&&n!==void 0?n:!1,this.store=e.store||new Lp,this.deviceId=e.deviceId||null,this.sessionId=Ri(10);var s=e.userId||null;this.credentials={userId:s},this.http=new Ec(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:wt.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var l=R(function*(u){var d=i.getRoom(u.getRoomId());u.status!==Se.SENDING&&i.updatePendingEventStatus(d,u,Se.SENDING);var c=yield i.sendEventHttpRequest(u);return d&&d.updatePendingEvent(u,Se.SENT,c.event_id),c});return function(u){return l.apply(this,arguments)}}()),tm()&&(this.callEventHandler=new Bp(this),this.groupCallEventHandler=new Wp(this),this.canSupportVoip=!0,this.on(de.Sync,this.startCallEventHandler)),this.matrixRTC=new Cm(this.logger,this),this.serverCapabilitiesService=new _c(this.logger,this.http),this.on(de.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new hm(this,this.logger),this.on(Le.Decrypted,l=>{zI(this,l)}),this.ignoredInvites=new fm(this),this._secretStorage=new Pc(this,(a=e.cryptoCallbacks)!==null&&a!==void 0?a:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Fn.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return R(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(de.Sync,t.startMatrixRTC);var n=t.getUserId();n&&t.store.storeUser(new Fn(n)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},y0),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:i,list:a,fwdPagination:s}=yield t.doesServerSupportThread();yt.setServerSideSupport(i),yt.setServerSideListSupport(a),yt.setServerSideFwdPaginationSupport(s)}catch(l){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",l)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new kc(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new fn(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(l=>t.logger.info("Sync startup aborted with an error:",l)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:o(e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,"canResetEntireTimeline"),logger:this.logger.getChild("sync")}}stopClient(){var e,t,n,i,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(de.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(n=this.peekSync)===null||n===void 0||n.stopPeeking(),(i=this.callEventHandler)===null||i===void 0||i.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var i=function(){var a=R(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var l=o(function*(v){var g=new Promise((p,m)=>{e.logger.info("Removing IndexedDB instance ".concat(v));var T=s.deleteDatabase(v);T.onsuccess=y=>{e.logger.info("Removed IndexedDB instance ".concat(v)),p(0)},T.onerror=y=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(v,":"),y),p(0)},T.onblocked=y=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(v))}});yield g},"_loop");for(var u of["".concat((d=t.cryptoDatabasePrefix)!==null&&d!==void 0?d:xf,"::matrix-sdk-crypto"),"".concat((c=t.cryptoDatabasePrefix)!==null&&c!==void 0?c:xf,"::matrix-sdk-crypto-meta")]){var d,c;yield*l(u)}});return o(function(){return a.apply(this,arguments)},"deleteRustSdkStore")}();return n.push(i()),Promise.all(n).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return Bl(this,e)}createGroupCall(e,t,n,i,a,s){var l=this;return R(function*(){if(l.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var u=l.getRoom(e);if(!u)throw new Error("Cannot find room ".concat(e));return new Fl(l,u,t,n,i,void 0,a||l.isVoipWithNoMediaAllowed,s,l.isVoipWithNoMediaAllowed,l.useLivekitForGroupCalls,l.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===Ue.Prepared||e===Ue.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return R(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return R(function*(){var n,i,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var l=t.getDeviceId();if(l===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var u=yield OD(()=>import("./index-qfolVMN9.js"),[]),d=yield u.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:l,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(n=a.cryptoDatabasePrefix)!==null&&n!==void 0?n:xf,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(i=t.legacyPickleKey)!==null&&i!==void 0?i:"DEFAULT_KEY",legacyMigrationProgressListener:o((c,h)=>{t.emit(Pt.LegacyCryptoStoreMigrationProgress,c,h)},"legacyMigrationProgressListener")});d.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=d,t.on(ur.Membership,d.onRoomMembership.bind(d)),t.on(de.Event,c=>{d.onLiveEventFromSync(c)}),t.reEmitter.reEmit(d,[Pt.VerificationRequestReceived,Pt.UserTrustStatusChanged,Pt.KeyBackupStatus,Pt.KeyBackupSessionsRemaining,Pt.KeyBackupFailed,Pt.KeyBackupDecryptionKeyCached,Pt.KeysChanged,Pt.DevicesUpdated,Pt.WillUpdateDevices,Pt.DehydratedDeviceCreated,Pt.DehydratedDeviceUploaded,Pt.RehydrationStarted,Pt.RehydrationProgress,Pt.RehydrationCompleted,Pt.RehydrationError,Pt.DehydrationKeyCached,Pt.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,n){var i;t!==void 0?i=ne("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?i=ne("/room_keys/keys/$roomId",{$roomId:e}):i="/room_keys/keys";var a=n===void 0?void 0:{version:n};return{path:i,queryData:a}}deleteKeysFromBackup(e,t,n){var i=this;return R(function*(){var a=i.makeKeyBackupPath(e,t,n);yield i.http.authedRequest(G.Delete,a.path,a.queryData,void 0,{prefix:wt.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:e?wt.V1:ls.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),n=new Set;for(var i of t){var a,s=(a=i.findPredecessor(e))===null||a===void 0?void 0:a.roomId;s&&n.add(s)}return t.filter(l=>{var u=l.currentState.getStateEvents(B.RoomTombstone,"");return!(u&&n.has(l.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return R(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield Mp(5,()=>n.setAccountDataRaw(e,t));var i=n.store.getAccountData(e);if(i&&qs(i.event.content,t))return{};var a=Promise.withResolvers();function s(u){u.getType()===e&&a.resolve()}o(s,"accountDataListener"),n.addListener(de.AccountData,s);try{var l=yield Mp(5,()=>n.setAccountDataRaw(e,t));return yield a.promise,l}finally{n.removeListener(de.AccountData,s)}})()}setAccountDataRaw(e,t){var n=ne("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(G.Put,n,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return R(function*(){if(t.isInitialSyncComplete()){var n=t.store.getAccountData(e);return n?n.getContent():null}var i=ne("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(G.Get,i)}catch(s){var a;if(((a=s.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw s}})()}deleteAccountData(e){var t=this;return R(function*(){var n=t.canSupport.get(It.AccountDataDeletion);if(n===Tt.Unsupported){yield t.setAccountData(e,{});return}var i=ne("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=n===Tt.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(G.Delete,i,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(B.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(n=>{t.ignored_users[n]={}}),this.setAccountData(B.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return R(function*(){var i,a,s=t.length>1&&t[1]!==void 0?t[1]:{},l=n.getRoom(e),u=l==null?void 0:l.getMember(n.getSafeUserId()),d=u==null?void 0:u.membership,c=d==Te.Invite&&(i=u==null||(a=u.events.member)===null||a===void 0?void 0:a.getSender())!==null&&i!==void 0?i:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(d,", inviter=").concat(c,", opts=").concat(JSON.stringify(s))),d==Te.Join)return l;var h=Promise.resolve();if(s.inviteSignUrl){var v=new URL(s.inviteSignUrl);v.searchParams.set("mxid",n.credentials.userId),h=n.http.requestOtherUrl(G.Post,v)}var g={};s.viaServers&&(g.server_name=s.viaServers,g.via=s.viaServers);var p={},m=yield h;m&&(p.third_party_signed=m);var T=ne("/join/$roomid",{$roomid:e}),y=yield n.http.authedRequest(G.Post,T,g,p),S=y.room_id;s.acceptSharedHistory&&c&&n.cryptoBackend&&(yield n.cryptoBackend.maybeAcceptKeyBundle(S,c));var w=n.getRoom(S);if(w!=null&&w.hasMembershipState(n.credentials.userId,Te.Join))return w;var C=new fn(n,n.clientOpts,n.buildSyncApiOptions());return C.createRoom(S)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=this.getRoom(e);if(n!=null&&n.hasMembershipState(this.credentials.userId,Te.Knock))return Promise.resolve({room_id:n.roomId});var i=ne("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};t.viaServers&&(a.server_name=t.viaServers,a.via=t.viaServers);var s={};return t.reason&&(s.reason=t.reason),this.http.authedRequest(G.Post,i,a,s)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,Se.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![Se.QUEUED,Se.NOT_SENT,Se.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===Se.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===Se.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,Se.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,B.RoomName,{name:t})}setRoomTopic(e,t,n){var i=sI(t,n);return this.sendStateEvent(e,B.RoomTopic,i)}getRoomTags(e){var t=ne("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(G.Get,t)}setRoomTag(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=ne("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(G.Put,i,void 0,n)}deleteRoomTag(e,t){var n=ne("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(G.Delete,n)}setRoomAccountData(e,t,n){var i=ne("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(G.Put,i,void 0,n)}setPowerLevel(e,t,n){var i=this;return R(function*(){var a,s;if(i.clientRunning&&i.isInitialSyncComplete()){var l;s=(l=i.getRoom(e))===null||l===void 0||(l=l.currentState)===null||l===void 0||(l=l.getStateEvents(B.RoomPowerLevels,""))===null||l===void 0?void 0:l.getContent()}if(!s)try{s=yield i.getStateEvent(e,B.RoomPowerLevels,"")}catch(c){if(c instanceof dt&&c.errcode==="M_NOT_FOUND")s={};else throw c}s=lu(s),(a=s)!==null&&a!==void 0&&a.users||(s.users={});var u=Array.isArray(t)?t:[t];for(var d of u)n==null?delete s.users[d]:s.users[d]=n;return i.sendStateEvent(e,B.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var n=this;return R(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return R(function*(){return n.sendStateEvent(e,oy.name,t,n.getUserId())})()}sendEvent(e,t,n,i,a){var s,l,u,d;return!(t!=null&&t.startsWith(tn))&&t!==null?(d=i,u=n,l=t,s=null):(d=a,u=i,l=n,s=t),this.addThreadRelationIfNeeded(u,s,e),this.sendCompleteEvent(e,s,{type:l,content:u},d)}addThreadRelationIfNeeded(e,t,n){var i;if(t&&!((i=e["m.relates_to"])!==null&&i!==void 0&&i.rel_type)){var a,s,l=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=_t(_t({},e["m.relates_to"]),{},{rel_type:We.name,event_id:t,is_falling_back:!l});var u=(s=this.getRoom(n))===null||s===void 0?void 0:s.getThread(t);if(u&&!l){var d,c;e["m.relates_to"]["m.in_reply_to"]={event_id:(d=(c=u.lastReply(h=>h.isRelation(We.name)&&!h.status))===null||c===void 0?void 0:c.getId())!==null&&d!==void 0?d:t}}}}sendCompleteEvent(e,t,n,i,a){var s,l;typeof i=="string"?l=i:(s=i,l=a),l||(l=this.makeTxnId());var u=new qt(Object.assign(n,{event_id:"~"+e+":"+l,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),d=this.getRoom(e),c=t?d==null?void 0:d.getThread(t):void 0;c&&u.setThread(c),s||(this.reEmitter.reEmit(u,[Le.Replaced,Le.VisibilityChange]),d==null||d.reEmitter.reEmit(u,[Le.BeforeRedaction]));var h=u.getAssociatedId();if(h!=null&&h.startsWith("~")){var v=d==null?void 0:d.getPendingEvents().find(p=>p.getId()===h);v==null||v.once(Le.LocalEventIdReplaced,()=>{u.updateAssociatedId(v.getId())})}var g=u.getType();return this.logger.debug("sendEvent of type ".concat(g," in ").concat(e," with txnId ").concat(l).concat(s?" (delayed event)":"")),u.setTxnId(l),u.setStatus(Se.SENDING),s?this.encryptAndSendEvent(d,u,s):(d==null||d.addPendingEvent(u,l),u.status===Se.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(d,u))}encryptAndSendEvent(e,t,n){var i=this;return R(function*(){if(n)return i.sendEventHttpRequest(t,n);try{var a;i.eventsBeingEncrypted.add(t.getId());try{yield i.encryptEventIfNeeded(t,e??void 0)}finally{a=!i.eventsBeingEncrypted.delete(t.getId())}if(a)return{};t.status===Se.ENCRYPTING&&i.updatePendingEventStatus(e,t,Se.SENDING);var s=null;return i.scheduler&&(s=i.scheduler.queueEvent(t),s&&i.scheduler.getQueueForEvent(t).length>1&&i.updatePendingEventStatus(e,t,Se.QUEUED)),s||(s=i.sendEventHttpRequest(t),e&&(s=s.then(l=>(e.updatePendingEvent(t,Se.SENT,l.event_id),l)))),yield s}catch(l){i.logger.error("Error sending event",l);try{t.error=l,i.updatePendingEventStatus(e,t,Se.NOT_SENT)}catch(u){i.logger.error("Exception in error handler!",u)}throw l instanceof dt&&(l.event=t),l}})()}encryptEventIfNeeded(e,t){var n=this;return R(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,Se.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return R(function*(){var i;return e.isEncrypted()||e.getType()===B.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(i=n.cryptoBackend)===null||i===void 0?void 0:i.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var n;return t===B.Reaction?t:(n=this.getRoom(e))!==null&&n!==void 0&&n.hasEncryptionStateEvent()?B.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e,t){var n=e.getTxnId();n||(n=this.makeTxnId(),e.setTxnId(n));var i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:n},a;if(e.isState()){var s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),a=ne(s,i)}else if(e.isRedaction()&&e.event.redacts){var l="/rooms/$roomId/redact/$redactsEventId/$txnId";a=ne(l,_t({$redactsEventId:e.event.redacts},i))}else a=ne("/rooms/$roomId/send/$eventType/$txnId",i);var u=e.getWireContent();return t?this.http.authedRequest(G.Put,a,S0(t),u):this.http.authedRequest(G.Put,a,void 0,u).then(d=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(d.event_id)),d))}redactEvent(e,t,n,i,a){var s,l,u;(s=n)!==null&&s!==void 0&&s.startsWith(tn)||(a=i,i=n,n=t,t=null);var d=(l=a)===null||l===void 0?void 0:l.reason,c={reason:d};if(((u=a)===null||u===void 0?void 0:u.with_rel_types)!==void 0){if(this.canSupport.get(It.RelationBasedRedactions)===Tt.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(n," txnId: ").concat(i," threadId ").concat(t));var h=this.canSupport.get(It.RelationBasedRedactions)===Tt.Stable?Zv.stable:Zv.unstable;c[h]=a.with_rel_types}return this.sendCompleteEvent(e,t,{type:B.RoomRedaction,content:c,redacts:n},i)}sendMessage(e,t,n,i){typeof t!="string"&&t!==null&&(i=n,n=t,t=null);var a=B.RoomMessage,s=n;return this.sendEvent(e,t,a,s,i)}sendTextMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=tI(n);return this.sendMessage(e,t,s,i)}sendNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=rI(n);return this.sendMessage(e,t,s,i)}sendEmoteMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=nI(n);return this.sendMessage(e,t,s,i)}sendImageMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(s=i||"Image",i=n,n=t,t=null);var l={msgtype:bn.Image,url:n,info:i,body:s};return this.sendMessage(e,t,l)}sendStickerMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(s=i||"Sticker",i=n,n=t,t=null);var l={url:n,info:i,body:s};return this.sendEvent(e,t,B.Sticker,l)}sendHtmlMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=XR(n,i);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=ZR(n,i);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(tn))&&t!==null&&(i=n,n=t,t=null);var s=eI(n,i);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,n,i,a,s){var l=this;return R(function*(){if(!(yield l.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","sendDelayedEvent");return l.addThreadRelationIfNeeded(a,n,e),l.sendCompleteEvent(e,n,{type:i,content:a},t,s)})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:"",u=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield s.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","sendDelayedStateEvent");var d={$roomId:e,$eventType:n,$stateKey:l},c=ne("/rooms/$roomId/state/$eventType",d);return l!==void 0&&(c=ne(c+"/$stateKey",d)),s.http.authedRequest(G.Put,c,S0(t),i,u)})()}_unstable_getDelayedEvents(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","getDelayedEvents");var n=e?{from:e}:void 0;return yield t.http.authedRequest(G.Get,"/delayed_events",n,void 0,{prefix:"".concat(wt.Unstable,"/").concat(cn)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","updateDelayedEvent");var s=ne("/delayed_events/$delayId",{$delayId:e}),l={action:t};return yield i.http.authedRequest(G.Post,s,void 0,l,_t(_t({},a),{},{prefix:"".concat(wt.Unstable,"/").concat(cn)}))})()}sendReceipt(e,t,n){var i=arguments,a=this;return R(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:!1;if(a.isGuest())return Promise.resolve({});var l=ne("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),u=!s&&a.supportsThreads(),d=u?_t(_t({},n),{},{thread_id:eo(e)}):n,c=a.http.authedRequest(G.Post,l,void 0,d||{}),h=a.getRoom(e.getRoomId());return h&&a.credentials.userId&&h.addLocalEchoReceipt(a.credentials.userId,e,t,s),c})()}sendReadReceipt(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:Xt.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var s=e.getId(),l=n.getRoom(e.getRoomId());if(l!=null&&l.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));return n.sendReceipt(e,i,{},a)}})()}setRoomReadMarkers(e,t,n,i){var a=this;return R(function*(){var s=a.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var l;if(n){if(l=n.getId(),s!=null&&s.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,n,Xt.Read)}var u;if(i){if(u=i.getId(),s!=null&&s.hasPendingEvent(u))throw new Error("Cannot set read receipt to a pending event (".concat(u,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,i,Xt.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,l,u)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var n=new URL(e);n.hash="",e=n.toString();var i=t+"_"+e;if(i in this.urlPreviewCache)return this.urlPreviewCache[i];var a=this.http.authedRequest(G.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:ls.V3,priority:"low"});return this.urlPreviewCache[i]=a,a}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});var i=ne("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=n||2e4),this.http.authedRequest(G.Put,i,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getRoom(e);if(!i)return[];var a=this.findPredecessorRooms(i,t,n),s=this.findSuccessorRooms(i,t,n);return[...a,i,...s]}findPredecessorRooms(e,t,n){for(var i,a=[],s=new Set([e.roomId]),l=(i=e.findPredecessor(n))===null||i===void 0?void 0:i.roomId;l!==null;){var u;if(l){if(s.has(l))break;s.add(l)}var d=this.getRoom(l);if(d===null)break;if(t){var c=d.currentState.getStateEvents(B.RoomTombstone,"");if(!c||c.getContent().replacement_room!==e.roomId)break}a.splice(0,0,d),e=d,l=(u=e.findPredecessor(n))===null||u===void 0?void 0:u.roomId}return a}findSuccessorRooms(e,t,n){for(var i=[],a=e.currentState.getStateEvents(B.RoomTombstone,"");a;){var s=this.getRoom(a.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var l,u=(l=s.findPredecessor(n))===null||l===void 0?void 0:l.roomId;if(!u||u!==e.roomId)break}i.push(s);var d=new Set(i.map(c=>c.roomId));if(d.size<i.length)return i.slice(0,i.length-1);e=s,a=e.currentState.getStateEvents(B.RoomTombstone,"")}return i}invite(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(typeof a!="object"&&(a={reason:a}),a.shareEncryptedHistory){var s;yield(s=i.cryptoBackend)===null||s===void 0?void 0:s.shareRoomHistoryWithUser(e,t)}return yield i.membershipChange(e,t,Te.Invite,a.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var i=this;return R(function*(){var a,s=ne("/rooms/$roomId/invite",{$roomId:e}),l=i.getIdentityServerUrl(!0);if(!l)return Promise.reject(new dt({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var u={id_server:l,medium:t,address:n};if((a=i.identityServer)!==null&&a!==void 0&&a.getAccessToken){var d=yield i.identityServer.getAccessToken();d&&(u.id_access_token=d)}return i.http.authedRequest(G.Post,s,void 0,u)})()}leave(e){return this.membershipChange(e,void 0,Te.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=this.getRoomUpgradeHistory(e),i=n;if(!t){i=[];for(var a of n)if(i.push(a),a.roomId===e)break}var s={},l=[],u=o(c=>this.leave(c).then(()=>{delete s[c]}).catch(h=>{s[c]=h}),"doLeave");for(var d of i)l.push(u(d.roomId));return Promise.all(l).then(()=>s)}ban(e,t,n){return this.membershipChange(e,t,Te.Ban,n)}forget(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=ne("/rooms/$room_id/forget",{$room_id:e}),s=yield n.http.authedRequest(G.Post,a);return i&&(n.store.removeRoom(e),n.emit(de.DeleteRoom,e)),s})()}unban(e,t){var n=ne("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(G.Post,n,void 0,i)}kick(e,t,n){var i=ne("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:n};return this.http.authedRequest(G.Post,i,void 0,a)}membershipChange(e,t,n,i){var a=ne("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(G.Post,a,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushDetails()}setProfileInfo(e,t){var n=ne("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(G.Put,n,void 0,t)}setDisplayName(e){var t=this;return R(function*(){var n=yield t.setProfileInfo("displayname",{displayname:e}),i=t.getUser(t.getUserId());return i&&(i.displayName=e,i.emit(yr.DisplayName,i.events.presence,i)),n})()}setAvatarUrl(e){var t=this;return R(function*(){var n=yield t.setProfileInfo("avatar_url",{avatar_url:e}),i=t.getUser(t.getUserId());return i&&(i.avatarUrl=e,i.emit(yr.AvatarUrl,i.events.presence,i)),n})()}mxcUrlToHttp(e,t,n,i,a,s,l){return bh(this.baseUrl,e,t,n,i,a,s,l)}setSyncPresence(e){var t=this;return R(function*(){var n;(n=t.syncApi)===null||n===void 0||n.setPresence(e)})()}setPresence(e){var t=this;return R(function*(){var n=ne("/presence/$userId/status",{$userId:t.credentials.userId}),i=["offline","online","unavailable"];if(i.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(G.Put,n,void 0,e)})()}getPresence(e){var t=ne("/presence/$userId/status",{$userId:e});return this.http.authedRequest(G.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var a=Date.now()-i.errorTs;n=Math.max(QN-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;var l=new Promise((u,d)=>{uu(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,Ie.Backward)).then(c=>{var h,v,g=c.chunk.map(this.getEventMapper());if(c.state){var p=c.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(p)}var[m,T,y]=e.partitionThreadedEvents(g);this.processAggregatedTimelineEvents(e,m),e.addEventsToTimeline(m,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,T,!0),y.forEach(S=>e.relations.aggregateChildEvent(S)),e.oldState.paginationToken=(h=c.end)!==null&&h!==void 0?h:null,c.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,g,(v=c.end)!==null&&v!==void 0?v:null,!0),delete this.ongoingScrollbacks[e.roomId],u(e)}).catch(c=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},d(c)})});return i={promise:l},this.ongoingScrollbacks[e.roomId]=i,l}getEventMapper(e){return sN(this,e||{})}getEventTimeline(e,t){var n=this;return R(function*(){var i,a,s,l;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads())return n.getThreadTimeline(e,t);var u=ne("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),d=void 0;(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(d={filter:JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER)});var c=yield n.http.authedRequest(G.Get,u,d);if(!c.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var h=n.getEventMapper(),v=h(c.event);if(v.isRelation(We.name)){n.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var g=[...c.events_after.reverse().map(h),v,...c.events_before.map(h)],p=e.getTimelineForEvent(g[0].getId());p?p.getState(he.BACKWARDS).setUnknownStateEvents(c.state.map(h)):(p=e.addTimeline(),p.initialiseState(c.state.map(h)),p.getState(he.FORWARDS).paginationToken=c.end);var[m,T,y]=e.room.partitionThreadedEvents(g);return e.addEventsToTimeline(m,!0,!1,p,c.start),n.processThreadEvents(e.room,T,!0),n.processAggregatedTimelineEvents(e.room,m),y.forEach(S=>e.relations.aggregateChildEvent(S)),(a=(s=e.getTimelineForEvent(t))!==null&&s!==void 0?s:(l=e.room.findThreadForEvent(v))===null||l===void 0?void 0:l.liveTimeline)!==null&&a!==void 0?a:p})()}getThreadTimeline(e,t){var n=this;return R(function*(){var i;if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var a=ne("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),s={limit:"0"};(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(s.filter=JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER));var l=yield n.http.authedRequest(G.Get,a,s),u=n.getEventMapper(),d=u(l.event);if(e.canContain(d)){var c=n.canSupport.get(It.RelationsRecursion)!==Tt.Unsupported;if(yt.hasServerSideSupport)if(yt.hasServerSideFwdPaginationSupport){var h,v,g;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var p=e.thread,m=yield n.fetchRelations(e.room.roomId,p.id,null,null,{dir:Ie.Backward,from:l.start,recurse:c||void 0}),T=yield n.fetchRelations(e.room.roomId,p.id,null,null,{dir:Ie.Forward,from:l.end,recurse:c||void 0}),y=[...T.chunk.reverse().filter(Lf(p.id)).map(u),d,...m.chunk.filter(Lf(p.id)).map(u)];for(var S of y){var w;yield(w=e.thread)===null||w===void 0?void 0:w.processEvent(S)}var C=e.getTimelineForEvent(d.getId());if(C?C.getState(he.BACKWARDS).setUnknownStateEvents(l.state.map(u)):(C=e.addTimeline(),C.initialiseState(l.state.map(u))),e.addEventsToTimeline(y,!0,!1,C,T.next_batch),!m.next_batch){var M=yield n.fetchRoomEvent(e.room.roomId,p.id);e.addEventsToTimeline([u(M)],!0,!1,C,null)}return C.setPaginationToken((h=m.next_batch)!==null&&h!==void 0?h:null,Ie.Backward),C.setPaginationToken((v=T.next_batch)!==null&&v!==void 0?v:null,Ie.Forward),n.processAggregatedTimelineEvents(e.room,y),(g=e.getTimelineForEvent(t))!==null&&g!==void 0?g:C}else{for(var _,O=e.thread,b=yield n.fetchRelations(e.room.roomId,O.id,We.name,null,{dir:Ie.Backward,from:l.start,recurse:c||void 0}),F=[],V=l.end;V;){var z,ie=yield n.fetchRelations(e.room.roomId,O.id,We.name,null,{dir:Ie.Forward,from:V,recurse:c||void 0});V=(z=ie.next_batch)!==null&&z!==void 0?z:null,F.push(...ie.chunk)}var se=[...F.reverse().map(u),d,...b.chunk.map(u)];for(var Pe of se){var Ce;yield(Ce=e.thread)===null||Ce===void 0?void 0:Ce.processEvent(Pe)}var $e=e.getLiveTimeline();if($e.getState(he.BACKWARDS).setUnknownStateEvents(l.state.map(u)),e.addEventsToTimeline(se,!0,!1,$e,null),!b.next_batch){var re=yield n.fetchRoomEvent(e.room.roomId,O.id);e.addEventsToTimeline([u(re)],!0,!1,$e,null)}return $e.setPaginationToken((_=b.next_batch)!==null&&_!==void 0?_:null,Ie.Backward),$e.setPaginationToken(null,Ie.Forward),n.processAggregatedTimelineEvents(e.room,se),$e}}})()}getLatestTimeline(e){var t=this;return R(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var n;if(e.threadListType!==null){var i,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,Ie.Backward,e.threadListType,e.getFilter());n=(i=a.chunk)===null||i===void 0?void 0:i[0]}else if(e.thread&&yt.hasServerSideSupport){var s,l=t.canSupport.get(It.RelationsRecursion)!==Tt.Unsupported,u=yield t.fetchRelations(e.room.roomId,e.thread.id,We.name,null,{dir:Ie.Backward,limit:1,recurse:l||void 0});n=(s=u.chunk)===null||s===void 0?void 0:s[0]}else{var d,c,h=ne("/rooms/$roomId/messages",{$roomId:e.room.roomId}),v={dir:"b"};(d=t.clientOpts)!==null&&d!==void 0&&d.lazyLoadMembers&&(v.filter=JSON.stringify(sr.LAZY_LOADING_MESSAGES_FILTER));var g=yield t.http.authedRequest(G.Get,h,v);n=(c=g.chunk)===null||c===void 0?void 0:c[0]}if(!n)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,n.event_id)})()}createMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,l=ne("/rooms/$roomId/messages",{$roomId:e}),u={limit:i.toString(),dir:a};t&&(u.from=t);var d=null;if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(d=Object.assign({},sr.LAZY_LOADING_MESSAGES_FILTER)),s){var c;d=d||{},Object.assign(d,(c=s.getRoomTimelineFilterComponent())===null||c===void 0?void 0:c.toJSON())}return d&&(u.filter=JSON.stringify(d)),this.http.authedRequest(G.Get,l,u)}createThreadListMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Ie.Backward,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Wr.All,l=arguments.length>5?arguments[5]:void 0,u=ne("/rooms/$roomId/threads",{$roomId:e}),d={limit:i.toString(),dir:a,include:JI(s)};t&&(d.from=t);var c={};if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(c=_t({},sr.LAZY_LOADING_MESSAGES_FILTER)),l){var h;c=_t(_t({},c),(h=l.getRoomTimelineFilterComponent())===null||h===void 0?void 0:h.toJSON())}Object.keys(c).length&&(d.filter=JSON.stringify(c));var v={prefix:yt.hasServerSideListSupport===Wt.Stable?wt.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(G.Get,u,d,void 0,v).then(g=>{var p;return _t(_t({},g),{},{chunk:(p=g.chunk)===null||p===void 0?void 0:p.reverse(),start:g.prev_batch,end:g.next_batch})})}paginateEventTimeline(e,t){var n=this,i=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,l=e.getTimelineSet().thread;t=t||{};var u=t.backwards||!1;if(i&&!u)throw new Error("paginateNotifTimeline can only paginate backwards");var d=u?he.BACKWARDS:he.FORWARDS,c=e.getPaginationToken(d),h=e.paginationRequests[d];if(h)return h;var v,g,p;if(i){var m;v="/notifications",g={limit:((m=t.limit)!==null&&m!==void 0?m:30).toString(),only:"highlight"},c&&c!=="end"&&(g.from=c),p=this.http.authedRequest(G.Get,v,g).then(function(){var C=R(function*(M){var _=M.next_token,O=[];M.notifications=M.notifications.filter(Gr);for(var b=0;b<M.notifications.length;b++){var F=M.notifications[b],V=n.getEventMapper()(F.event);n.getPushDetailsForEvent(V,!0),V.event.room_id=F.room_id,O[b]=V}var z=e.getTimelineSet();return z.addEventsToTimeline(O,u,!1,e,_),n.processAggregatedTimelineEvents(z.room,O),u&&!M.next_token&&e.setPaginationToken(null,d),!!M.next_token});return function(M){return C.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else if(s!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!yt.hasServerSideFwdPaginationSupport&&d===Ie.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");p=this.createThreadListMessagesRequest(e.getRoomId(),c,t.limit,d,s,e.getFilter()).then(C=>{if(C.state){var M=e.getState(d),_=C.state.filter(Gr).map(this.getEventMapper());M.setUnknownStateEvents(_)}var O=C.end,b=C.chunk.filter(Gr).map(this.getEventMapper()),F=e.getTimelineSet();return F.addEventsToTimeline(b,u,!1,e,O),this.processAggregatedTimelineEvents(a,b),this.processThreadRoots(a,b,u),u&&C.end==C.start&&e.setPaginationToken(null,d),C.end!==C.start}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else if(l){var T,y,S=this.getRoom((T=e.getRoomId())!==null&&T!==void 0?T:void 0);if(!S)throw new Error("Unknown room "+e.getRoomId());var w=this.canSupport.get(It.RelationsRecursion)!==Tt.Unsupported;p=this.fetchRelations((y=e.getRoomId())!==null&&y!==void 0?y:"",l.id,null,null,{dir:d,limit:t.limit,from:c??void 0,recurse:w||void 0}).then(function(){var C=R(function*(M){var _=n.getEventMapper(),O=M.chunk.filter(Gr).filter(Lf(l.id)).map(_);for(var b of O.slice().reverse()){yield l==null?void 0:l.processEvent(b);var F=b.getSender();(!u||(l==null?void 0:l.getEventReadUpTo(F))===null)&&S.addLocalEchoReceipt(F,b,Xt.Read)}var V=M.next_batch,z=e.getTimelineSet();if(z.addEventsToTimeline(O,u,!1,e,V??null),!V&&u){var ie,se,Pe=(ie=l.rootEvent)!==null&&ie!==void 0?ie:_(yield n.fetchRoomEvent((se=e.getRoomId())!==null&&se!==void 0?se:"",l.id));z.addEventsToTimeline([Pe],!0,!1,e,null)}return n.processAggregatedTimelineEvents(z.room,O),u&&!V&&e.setPaginationToken(null,d),!!V});return function(M){return C.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else{if(!a)throw new Error("Unknown room "+e.getRoomId());p=this.createMessagesRequest(e.getRoomId(),c,t.limit,d,e.getFilter()).then(C=>{if(C.state){var M=e.getState(d),_=C.state.filter(Gr).map(this.getEventMapper());M.setUnknownStateEvents(_)}var O=C.end,b=C.chunk.filter(Gr).map(this.getEventMapper()),F=e.getTimelineSet(),[V,,z]=a.partitionThreadedEvents(b);F.addEventsToTimeline(V,u,!1,e,O),this.processAggregatedTimelineEvents(a,V),this.processThreadRoots(a,V.filter(se=>se.getServerAggregatedRelation(We.name)),!1),z.forEach(se=>a.relations.aggregateChildEvent(se));var ie=C.end===void 0||C.end===C.start;return u&&ie&&e.setPaginationToken(null,d),!ie}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}return p}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new fn(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,n)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var n=this.sendStateEvent(e,B.RoomGuestAccess,{guest_access:t.allowJoin?Ic.CanJoin:Ic.Forbidden},""),i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,B.RoomHistoryVisibility,{history_visibility:sy.WorldReadable},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestTokenFromEndpoint(e,t){var n=this;return R(function*(){var i=Object.assign({},t);return n.http.request(G.Post,e,void 0,i)})()}getRoomPushRule(e,t){if(this.pushRules){var n;return(n=this.pushRules[e])===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.find(i=>i.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){var i,a=!1,s=this.getRoomPushRule(e,t);if(s!=null&&s.actions.includes(Ii.DontNotify)&&(a=!0),!n)a&&(i=this.deletePushRule(e,xt.RoomSpecific,s.rule_id));else if(!s)i=this.addPushRule(e,xt.RoomSpecific,t,{actions:[Ii.DontNotify]});else if(!a){var l=Promise.withResolvers();this.deletePushRule(e,xt.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,xt.RoomSpecific,t,{actions:[Ii.DontNotify]}).then(()=>{l.resolve()}).catch(u=>{l.reject(u)})}).catch(u=>{l.reject(u)}),i=l.promise}if(i)return new Promise((u,d)=>{i.then(()=>{this.getPushRules().then(c=>{this.pushRules=c,u()}).catch(c=>{d(c)})}).catch(c=>{this.getPushRules().then(h=>{this.pushRules=h,d(c)}).catch(h=>{d(c)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:CI.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(i=>this.processRoomEventsSearch(n,i))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then(i=>this.processRoomEventsSearch(e,i)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var s=new Set(a.highlights);e.highlights.forEach(g=>{s.add(g)}),e.highlights=Array.from(s);for(var l=this.getEventMapper(),u=(n=(i=a.results)===null||i===void 0?void 0:i.length)!==null&&n!==void 0?n:0,d=0;d<u;d++){var c=Rc.fromJson(a.results[d],l),h=this.getRoom(c.context.getEvent().getRoomId());if(h)for(var v of c.context.getTimeline())v.setMetadata(h.currentState,!1);e.results.push(c)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new fn(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=ne("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(G.Post,t,void 0,e).then(n=>{var i=sr.fromJson(this.credentials.userId,n.filter_id,e);return this.store.storeFilter(i),i})}getFilter(e,t,n){if(n){var i=this.store.getFilter(e,t);if(i)return Promise.resolve(i)}var a=ne("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(G.Get,a).then(s=>{var l=sr.fromJson(e,t,s);return this.store.storeFilter(l),l})}getOrCreateFilter(e,t){var n=this;return R(function*(){var i=n.store.getFilterIdByName(e),a;if(i){try{var s=yield n.getFilter(n.credentials.userId,i,!0);if(s){var l=s.getDefinition(),u=t.getDefinition();qs(l,u)&&(a=i)}}catch(c){if(c.errcode!=="M_UNKNOWN"&&c.errcode!=="M_NOT_FOUND")throw c}a||n.store.setFilterIdByName(e,void 0)}if(a)return a;var d=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,d.filterId),d.filterId})()}getOpenIdToken(){var e=ne("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(G.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(G.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return R(function*(){if(e.canSupportVoip){var t=!1,n=e.turnServersExpiry-Date.now();if(n>y0)e.logger.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var i=yield e.turnServer();if(i.uris){e.logger.debug("Got TURN URIs: "+i.uris+" refresh in "+i.ttl+" secs");var a={urls:i.uris,username:i.username,credential:i.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+i.ttl*1e3,t=!0,e.emit(de.TurnServers,e.turnServers)}}catch(s){e.logger.error("Failed to get TURN URIs",s),s.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(de.TurnServersError,s,!0)):e.emit(de.TurnServersError,s,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=ne("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(G.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=ne("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=ne("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(G.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return R(function*(){var t;e.clientWellKnownPromise=Et.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(de.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(n=>{var[i,a]=n;return e.includes(typeof a)}).reduce((n,i)=>{var[a,s]=i;return n[a]=s,n},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return R(function*(){var n=yield t.doesServerSupportUnstableFeature(VI),i=yield t.doesServerSupportUnstableFeature(qI),a=yield t.doesServerSupportUnstableFeature(GI);if(!n&&!i&&!a)throw Error("Server does not support the Mutual Rooms API");var s,l;a?(s="/uk.half-shot.msc2666/user/mutual_rooms",l={user_id:e}):(s=ne("/uk.half-shot.msc2666/user/".concat(i?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),l={});var u=[],d=null;do{var c={};d!=null&&a&&(c.batch_token=d);var h=yield t.http.authedRequest(G.Get,s,_t(_t({},l),c),void 0,{prefix:wt.Unstable});u.push(...h.joined),h.next_batch_token!==void 0?d=h.next_batch_token:d=null}while(d!=null);return u})()}getVersions(){var e=this;return R(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(G.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(n=>{throw e.serverVersionsPromise=void 0,n});var t=yield e.serverVersionsPromise;return e.canSupport=yield g1(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return R(function*(){var{versions:n}=yield t.getVersions();return n&&n.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return R(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features;return i&&!!i[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return R(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return R(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Wt.Stable,list:Wt.Stable,fwdPagination:Wt.Stable};try{var[t,n,i,a,s,l]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Ed(n,t),list:Ed(a,i),fwdPagination:Ed(l,s)}}catch{return{threads:Wt.None,list:Wt.None,fwdPagination:Wt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,i){var a=arguments,s=this;return R(function*(){var l,u,d=a.length>4&&a[4]!==void 0?a[4]:{dir:Ie.Backward},c=i?s.getEncryptedIfNeededEventType(e,i):null,[h,v]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,n,c,d)]),g=s.getEventMapper(),p=h?g(h):void 0,m=v.chunk.map(g);if(c===B.RoomMessageEncrypted){var T=p?m.concat(p):m;yield Promise.all(T.map(y=>s.decryptEventIfNeeded(y))),i!==null&&(m=m.filter(y=>y.getType()===i))}return p&&n===Xe.Replace&&(m=m.filter(y=>y.getSender()===p.getSender())),{originalEvent:p??null,events:m,nextBatch:(l=v.next_batch)!==null&&l!==void 0?l:null,prevBatch:(u=v.prev_batch)!==null&&u!==void 0?u:null}})()}generateClientSecret(){return Ri(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case rm.IS:return this.http.getUrl("/terms",void 0,Rn.V2,t);case rm.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return n&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=yf(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(G.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,n,i,a,s,l){n&&(i.session=n);var u={auth:i,refresh_token:!0};return e!=null&&(u.username=e),t!=null&&(u.password=t),s!=null&&(u.guest_access_token=s),l!=null&&(u.inhibit_login=l),this.registerRequest(u)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var n={};return t&&(n.kind=t),this.http.request(G.Post,"/register",n,e)}refreshToken(e){var t=o(n=>this.http.authedRequest(G.Post,"/refresh",void 0,{refresh_token:e},{prefix:n,inhibitLogoutEmit:!0}),"performRefreshRequestWithPrefix");return t(wt.V3).catch(n=>{if(n.errcode==="M_UNRECOGNIZED")return t(wt.V1);throw n})}loginFlows(){return this.http.request(G.Get,"/login")}login(e,t){return this.loginRequest(_t(_t({},t),{},{type:e})).then(n=>(n.access_token&&n.user_id&&(this.http.opts.accessToken=n.access_token,this.credentials={userId:n.user_id}),n))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";n&&(a+="/"+n);var s={redirectUrl:e,[ZN.unstable]:i};return this.http.getUrl(a,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return R(function*(){return yield t.http.authedRequest(G.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!1;return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(G.Post,"/logout")})()}deactivateAccount(e,t){var n={};return e&&(n.auth=e),t!==void 0&&(n.erase=t),this.http.authedRequest(G.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){var t=this;return R(function*(){var n={auth:e};return t.http.authedRequest(G.Post,"/login/get_token",void 0,n,{prefix:wt.V1})})()}getFallbackAuthUrl(e,t){var n=ne("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t}).href}createRoom(e){var t=this;return R(function*(){var n,i=(e.invite_3pid||[]).filter(l=>!l.id_access_token);if(i.length>0&&(n=t.identityServer)!==null&&n!==void 0&&n.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var s of i)s.id_access_token=a}return t.http.authedRequest(G.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:Ie.Backward},s=a;yt.hasServerSideFwdPaginationSupport===Wt.Experimental&&(s=G_("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(It.RelationsRecursion)===Tt.Unstable&&(s=G_("recurse","org.matrix.msc3981.recurse",s));var l=Wv(s),u="/rooms/$roomId/relations/$eventId";n!==null?(u+="/$relationType",i!==null&&(u+="/$eventType")):i!==null&&(this.logger.warn("eventType: ".concat(i,` ignored when fetching
            relations as relationType is null`)),i=null);var d=ne(u+"?"+l,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(G.Get,d,void 0,void 0,{prefix:wt.V1})}roomState(e){var t=ne("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(G.Get,t)}fetchRoomEvent(e,t){var n=ne("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(G.Get,n)}members(e,t,n,i){var a={};t&&(a.membership=t),n&&(a.not_membership=n),i&&(a.at=i);var s=Wv(a),l=ne("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(G.Get,l)}upgradeRoom(e,t){var n=ne("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(G.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n){var i={$roomId:e,$eventType:t,$stateKey:n},a=ne("/rooms/$roomId/state/$eventType",i);return n!==void 0&&(a=ne(a+"/$stateKey",i)),this.http.authedRequest(G.Get,a)}sendStateEvent(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},s={$roomId:e,$eventType:t,$stateKey:i},l=ne("/rooms/$roomId/state/$eventType",s);return i!==void 0&&(l=ne(l+"/$stateKey",s)),this.http.authedRequest(G.Put,l,void 0,n,a)}roomInitialSync(e,t){var n,i=ne("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(G.Get,i,{limit:(n=t==null?void 0:t.toString())!==null&&n!==void 0?n:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){var a=this;return R(function*(){var s=ne("/rooms/$roomId/read_markers",{$roomId:e}),l={[Xt.FullyRead]:t,[Xt.Read]:n};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(l[Xt.ReadPrivate]=i),a.http.authedRequest(G.Post,s,void 0,l)})()}getJoinedRooms(){var e=ne("/joined_rooms",{});return this.http.authedRequest(G.Get,e)}getJoinedRoomMembers(e){var t=ne("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(G.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:n,since:i}=e,a=PD(e,JN);if(Object.keys(a).length===0){var s={server:t,limit:n,since:i};return this.http.authedRequest(G.Get,"/publicRooms",s)}else{var l={server:t},u=_t({limit:n,since:i},a);return this.http.authedRequest(G.Post,"/publicRooms",l,u)}}createAlias(e,t){var n=ne("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(G.Put,n,void 0,i)}deleteAlias(e){var t=ne("/directory/room/$alias",{$alias:e});return this.http.authedRequest(G.Delete,t)}getLocalAliases(e){var t=ne("/rooms/$roomId/aliases",{$roomId:e}),n=wt.V3;return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){var t=ne("/directory/room/$alias",{$alias:e});return this.http.authedRequest(G.Get,t)}getRoomDirectoryVisibility(e){var t=ne("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(G.Get,t)}setRoomDirectoryVisibility(e,t){var n=ne("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(G.Put,n,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:n}=e,i={search_term:t};return n!==void 0&&(i.limit=n),this.http.authedRequest(G.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var n=t?ne("/profile/$userId/$info",{$userId:e,$info:t}):ne("/profile/$userId",{$userId:e});return this.http.authedRequest(G.Get,n)}doesServerSupportExtendedProfiles(){var e=this;return R(function*(){return e.doesServerSupportUnstableFeature(HI)})()}getExtendedProfileRequestPrefix(){var e=this;return R(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?wt.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(G.Get,ne("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=yield n.http.authedRequest(G.Get,ne("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()});return i[t]})()}setExtendedProfileProperty(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=n.getUserId();yield n.http.authedRequest(G.Put,ne("/profile/$userId/$key",{$userId:i,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(G.Delete,ne("/profile/$userId/$key",{$userId:n,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();return t.http.authedRequest(G.Patch,ne("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(G.Put,ne("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(G.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return R(function*(){var n="/account/3pid/add";return t.http.authedRequest(G.Post,n,void 0,e)})()}bindThreePid(e){var t=this;return R(function*(){var n="/account/3pid/bind";return t.http.authedRequest(G.Post,n,void 0,e)})()}unbindThreePid(e,t){var n=this;return R(function*(){var i="/account/3pid/unbind",a={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest(G.Post,i,void 0,a)})()}deleteThreePid(e,t){var n="/account/3pid/delete";return this.http.authedRequest(G.Post,n,void 0,{medium:e,address:t})}setPassword(e,t,n){var i="/account/password",a={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(G.Post,i,void 0,a)}getDevices(){return this.http.authedRequest(G.Get,"/devices")}getDevice(e){var t=ne("/devices/$device_id",{$device_id:e});return this.http.authedRequest(G.Get,t)}setDeviceDetails(e,t){var n=ne("/devices/$device_id",{$device_id:e});return this.http.authedRequest(G.Put,n,void 0,t)}deleteDevice(e,t){var n=ne("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(G.Delete,n,void 0,i)}deleteMultipleDevices(e,t){var n={devices:e};t&&(n.auth=t);var i="/delete_devices";return this.http.authedRequest(G.Post,i,void 0,n)}getPushers(){var e=this;return R(function*(){var t=yield e.http.authedRequest(G.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(n=>(n.hasOwnProperty(ep.name)||(n[ep.name]=!0),n))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(G.Post,t,void 0,e)}removePusher(e,t){var n="/pushers/set",i={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(G.Post,n,void 0,i)}setLocalNotificationSettings(e,t){var n="".concat(UR.name,".").concat(e);return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest(G.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=$l.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,i){var a=ne("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,i)}deletePushRule(e,t,n){var i=ne("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Delete,i)}setPushRuleEnabled(e,t,n,i){var a=ne("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,{enabled:i})}setPushRuleActions(e,t,n,i){var a=ne("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,{actions:i})}search(e,t){var{body:n,next_batch:i}=e,a={};return i&&(a.next_batch=i),this.http.authedRequest(G.Post,"/search",a,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(G.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(G.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={device_keys:{}};return t!==void 0&&(n.token=t),e.forEach(i=>{n.device_keys[i]=[]}),this.http.authedRequest(G.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0,i={};t===void 0&&(t="signed_curve25519");for(var[a,s]of e){var l=i[a]||{};ec(i,a,l),ec(l,s,t)}var u={one_time_keys:i};n&&(u.timeout=n);var d="/keys/claim";return this.http.authedRequest(G.Post,d,void 0,u)}getKeyChanges(e,t){var n={from:e,to:t};return this.http.authedRequest(G.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){var n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(G.Post,"/keys/device_signing/upload",void 0,n,{prefix:wt.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,Rn.V2,this.idBaseUrl);return this.http.requestOtherUrl(G.Post,t,e)}requestEmailToken(e,t,n,i,a){var s={client_secret:t,email:e,send_attempt:n==null?void 0:n.toString()};return i&&(s.next_link=i),this.http.idServerRequest(G.Post,"/validate/email/requestToken",s,Rn.V2,a)}requestMsisdnToken(e,t,n,i,a,s){var l={client_secret:n,country:e,phone_number:t,send_attempt:i==null?void 0:i.toString()};return a&&(l.next_link=a),this.http.idServerRequest(G.Post,"/validate/msisdn/requestToken",l,Rn.V2,s)}submitMsisdnToken(e,t,n,i){var a={sid:e,client_secret:t,token:n};return this.http.idServerRequest(G.Post,"/validate/msisdn/submitToken",a,Rn.V2,i??void 0)}submitMsisdnTokenOtherUrl(e,t,n,i){var a={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(G.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest(G.Get,"/hash_details",void 0,Rn.V2,e)}identityHashedLookup(e,t){var n=this;return R(function*(){var i={},a=yield n.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=a.lookup_pepper;var s={};if(a.algorithms.includes("sha256"))i.addresses=yield Promise.all(e.map(function(){var v=R(function*(g){var p=g[0].toLowerCase(),m=g[1].toLowerCase(),T=yield xI("".concat(p," ").concat(m," ").concat(i.pepper)),y=Ph(T);return s[y]=g[0],y});return function(g){return v.apply(this,arguments)}}())),i.algorithm="sha256";else if(a.algorithms.includes("none"))i.addresses=e.map(v=>{var g=v[0].toLowerCase(),p=v[1].toLowerCase(),m="".concat(g," ").concat(p);return s[m]=v[0],m}),i.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var l=yield n.http.idServerRequest(G.Post,"/lookup",i,Rn.V2,t);if(!(l!=null&&l.mappings))return[];var u=[];for(var d of Object.keys(l.mappings)){var c=l.mappings[d],h=s[d];if(!h)throw new Error("Identity server returned more results than expected");u.push({address:h,mxid:c})}return u})()}lookupThreePid(e,t,n){var i=this;return R(function*(){var a=yield i.identityHashedLookup([[t,e]],n),s=a.find(u=>u.address===t);if(!s)return{};var l={address:t,medium:e,mxid:s.mxid};return l})()}bulkLookupThreePids(e,t){var n=this;return R(function*(){var i=yield n.identityHashedLookup(e.map(u=>[u[1],u[0]]),t),a=[],s=o(function*(d){var c=e.find(h=>h[1]===d.address);if(!c)throw new Error("Identity sever returned unexpected results");a.push([c[0],d.address,d.mxid])},"_loop2");for(var l of i)yield*s(l);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest(G.Get,"/account",void 0,Rn.V2,e)}sendToDevice(e,t,n){var i=ne("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),a={messages:na(t)},s=new Map;for(var[l,u]of t)s.set(l,Array.from(u.keys()));return this.logger.debug("PUT ".concat(i),s),this.http.authedRequest(G.Put,i,void 0,a)}encryptAndSendToDevice(e,t,n){var i=this;return R(function*(){if(!i.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield i.cryptoBackend.encryptToDeviceMessages(e,t,n);yield i.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(G.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var n=ne("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(G.Get,n,t)}getThirdpartyUser(e,t){var n=ne("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(G.Get,n,t)}getTerms(e,t){var n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(G.Get,n)}agreeToTerms(e,t,n,i){var a=this.termsUrlForService(e,t),s={Authorization:"Bearer "+n};return this.http.requestOtherUrl(G.Post,a,{user_accepts:i},{headers:s})}reportEvent(e,t,n,i){var a=ne("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(G.Post,a,void 0,{score:n,reason:i})}reportRoom(e,t){var n=ne("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(G.Post,n,void 0,{reason:t})}getRoomHierarchy(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,s=ne("/rooms/$roomId/hierarchy",{$roomId:e}),l={suggested_only:String(i),max_depth:n==null?void 0:n.toString(),from:a,limit:t==null?void 0:t.toString()};return this.http.authedRequest(G.Get,s,l,void 0,{prefix:wt.V1}).catch(u=>{if(u.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(G.Get,s,l,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw u})}unstableCreateFileTree(e){var t=this;return R(function*(){var{room_id:n}=yield t.createRoom({name:e,preset:ay.PrivateChat,power_level_content_override:_t(_t({},oN),{},{users:{[t.getUserId()]:100}}),creation_content:{[tc]:ss.Space},initial_state:[{type:Qv.name,state_key:Xv.name,content:{[Yv.name]:!0}},{type:B.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new Oc(t,n)})()}unstableGetFileTreeSpace(e){var t,n,i=this.getRoom(e);if((i==null?void 0:i.getMyMembership())!==Te.Join)return null;var a=i.currentState.getStateEvents(B.RoomCreate,""),s=i.currentState.getStateEvents(Qv.name,Xv.name);if(!a)throw new Error("Expected single room create event");return!(s!=null&&(t=s.getContent())!==null&&t!==void 0&&t[Yv.name])||((n=a.getContent())===null||n===void 0?void 0:n[tc])!==ss.Space?null:new Oc(this,e)}slidingSync(e,t,n){var i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(G.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:n})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(It.IntentionalMentions)!==Tt.Unsupported}getRoomSummary(e,t){var n=this;return R(function*(){var i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=ne("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest(G.Get,a,{via:t},void 0,i)}catch(l){if(l instanceof dt&&l.errcode==="M_UNRECOGNIZED"){var s=ne("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest(G.Get,s,{via:t},void 0,i)}else throw l}})()}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){this.supportsThreads()&&e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return R(function*(){return e.http.authedRequest(G.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var i=this;return R(function*(){var a=ne("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:n};try{return yield i.http.authedRequest(G.Get,a,s,void 0,{prefix:wt.V1})}catch(l){if(l.errcode==="M_UNRECOGNIZED"&&(l.httpStatus===400||l.httpStatus===404||l.httpStatus===405))return yield i.http.authedRequest(G.Get,a,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw l}})()}getAuthIssuer(){var e=this;return R(function*(){return e.http.request(G.Get,"/auth_issuer",void 0,void 0,{prefix:wt.Unstable+"/org.matrix.msc2965"})})()}getAuthMetadata(){var e=this;return R(function*(){var t;try{t=yield e.http.request(G.Get,"/auth_metadata",void 0,void 0,{prefix:wt.Unstable+"/org.matrix.msc2965"})}catch(i){if(i instanceof dt&&i.errcode==="M_UNRECOGNIZED"){var{issuer:n}=yield e.getAuthIssuer();return fy(n)}throw i}return vy(t)})()}};o(YS,"MatrixClient");let Zs=YS;f(Zs,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function S0(r){return Object.fromEntries(Object.entries(r).map(e=>{var[t,n]=e;return["".concat(cn,".").concat(t),n]}))}o(S0,"getUnstableDelayQueryOpts");function zI(r,e){var t,n=r.getUserId(),i=e.getId(),a=r.getRoom(e.getRoomId());if(!(!a||!n||!i)){if(!a.findEventById(i)){I.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var s=!!e.threadRootId&&!e.isThreadRoot,l;if(s){var u=a.getThread(e.threadRootId);l=u?u.hasUserReadEvent(n,i):!0}else l=a.hasUserReadEvent(n,i);if(!l){var d=r.getPushActionsForEvent(e,!0),c=!!(d!=null&&(t=d.tweaks)!==null&&t!==void 0&&t.highlight);if(c){var h=a.getUnreadCountForEventContext(De.Highlight,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,De.Highlight,h):a.setUnreadNotificationCount(De.Highlight,h)}var v=!!(d!=null&&d.notify);if(v){var g=a.getUnreadCountForEventContext(De.Total,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,De.Total,g):a.setUnreadNotificationCount(De.Total,g)}}}}o(zI,"fixNotificationCountOnDecryption");function eo(r){return Hl(r)?ou:r.threadRootId}o(eo,"threadIdForReceipt");function Hl(r){if(!r.threadRootId||r.isThreadRoot)return!0;if(!r.isRelation())return I.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(r.getId())),!0;if(r.isRelation(We.name))return!1;var e=r.relationEventId===r.threadRootId;return e}o(Hl,"inMainTimelineForReceipt");function E0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(E0,"ownKeys$1");function _0(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?E0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):E0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(_0,"_objectSpread$1");var Zt=function(r){return r.New="Thread.new",r.Update="Thread.update",r.NewReply="Thread.newReply",r.ViewThread="Thread.viewThread",r.Delete="Thread.delete",r}({}),Wt=function(r){return r[r.None=0]="None",r[r.Experimental=1]="Experimental",r[r.Stable=2]="Stable",r}({});function Ed(r,e){return r?Wt.Stable:e?Wt.Experimental:Wt.None}o(Ed,"determineFeatureSupport");const dn=class dn extends pc{constructor(e,t,n){var i,a;if(super(),i=this,this.id=e,this.rootEvent=t,f(this,"timelineSet",void 0),f(this,"_currentUserParticipated",!1),f(this,"reEmitter",void 0),f(this,"lastEvent",void 0),f(this,"replyCount",0),f(this,"lastPendingEvent",void 0),f(this,"pendingReplyCount",0),f(this,"room",void 0),f(this,"client",void 0),f(this,"pendingEventOrdering",void 0),f(this,"processRootEventPromise",void 0),f(this,"initialEventsFetched",!dn.hasServerSideSupport),f(this,"initalEventFetchProm",void 0),f(this,"replayEvents",[]),f(this,"onTimelineReset",R(function*(){yield i.processRootEventPromise,i.processRootEventPromise=void 0})),f(this,"onBeforeRedaction",(s,l)=>{s!=null&&s.isRelation(We.name)&&this.room.eventShouldLiveIn(s).threadId===this.id&&s.getId()!==this.id&&!l.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Zt.Update,this))}),f(this,"onRedaction",function(){var s=R(function*(l,u,d){if(d===i.id)if(i.replyCount<=0){for(var c of i.timeline)i.clearEventMetadata(c);i.lastEvent=i.rootEvent,i._currentUserParticipated=!1,i.emit(Zt.Delete,i)}else{var h;((h=i.lastEvent)===null||h===void 0?void 0:h.getId())===l.getAssociatedId()&&(yield i.processRootEventPromise,i.processRootEventPromise=void 0),yield i.updateThreadMetadata()}});return function(l,u,d){return s.apply(this,arguments)}}()),f(this,"onTimelineEvent",(s,l,u)=>{if(!u){var d=s.getSender();d&&l&&this.shouldSendLocalEchoReceipt(d,s)&&l.addLocalEchoReceipt(d,s,Xt.Read),s.getId()!==this.id&&s.isRelation(We.name)&&this.replyCount++}this.onEcho(s,u??!1)}),f(this,"onLocalEcho",s=>{this.onEcho(s,!1)}),f(this,"onEcho",function(){var s=R(function*(l,u){l.threadRootId===i.id&&i.lastEvent!==l&&(yield i.updateThreadMetadata(),l.isRelation(We.name)&&(u||(i.lastEvent=void 0,i.emit(Zt.NewReply,i,l))))});return function(l,u){return s.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(n!=null&&n.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=(a=n.pendingEventOrdering)!==null&&a!==void 0?a:Xs.Chronological,this.timelineSet=new pi(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Ai(this),this.reEmitter.reEmit(this.timelineSet,[ue.Timeline,ue.TimelineReset]),this.room.on(Le.BeforeRedaction,this.onBeforeRedaction),this.room.on(ue.Redaction,this.onRedaction),this.room.on(ue.LocalEchoUpdated,this.onLocalEcho),this.room.on(ue.TimelineReset,this.onTimelineReset),this.timelineSet.on(ue.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return R(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),n=e.client.getEventMapper();e.rootEvent=n(t)}catch(i){I.error("Failed to fetch thread root to construct thread with",i)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){dn.hasServerSideSupport=e,e!==Wt.Stable&&(cs.setPreferUnstable(!0),hs.setPreferUnstable(!0),We.setPreferUnstable(!0))}static setServerSideListSupport(e){dn.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){dn.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n,i=(n=this.client.canSupport.get(It.RelationsRecursion))!==null&&n!==void 0?n:Tt.Unsupported;if(i===Tt.Unsupported){var a,s=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(s){var l=this.findEventById(s);if(l&&l.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(he.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(n=>this.addEvent(n,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var i=this.lastReply(),a=!i||e.localTimestamp>=i.localTimestamp;if(!dn.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Xe.Annotation)||e.isRelation(Xe.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(We.name)&&!t&&a&&(this.lastEvent=void 0),n&&(this.emit(Zt.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var n,i;if(this.initialEventsFetched){var s,l=(s=this.client.canSupport.get(It.RelationsRecursion))!==null&&s!==void 0?s:Tt.Unsupported;l===Tt.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var a;(a=this.replayEvents)===null||a===void 0||a.push(e)}(n=this.timelineSet.relations)===null||n===void 0||n.aggregateParentEvent(e),(i=this.timelineSet.relations)===null||i===void 0||i.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return R(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:n,userId:i,receipt:a,synthetic:s}of e)this.addReceiptToStructure(t,n,i,a,s)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e==null?void 0:e.getServerAggregatedRelation(We.name)}processRootEvent(){var e=this;return R(function*(){var t=e.getRootEventBundledRelationship();if(dn.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var n=e.client.getEventMapper();e.lastEvent=n(_0(_0({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===Xs.Detached?this.room.getPendingEvents():this.events,t=e.filter(n=>{var i;return n.threadRootId===this.id&&n.isRelation(We.name)&&n.status!==null&&n.getId()!==((i=this.lastEvent)===null||i===void 0?void 0:i.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var n=this;return R(function*(){var i=n.liveTimeline;n.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=n.liveTimeline,s,l;if(e){var u=yield n.client.createMessagesRequest(n.roomId,e,1,Ie.Forward);s=u.end}if(t){var d=yield n.client.createMessagesRequest(n.roomId,t,1,Ie.Backward);l=d.start}t&&i.getPaginationToken(Ie.Forward)===t&&i.setPaginationToken(l??null,Ie.Forward),e&&a.getPaginationToken(Ie.Backward)===e&&a.setPaginationToken(s??null,Ie.Backward)})()}updateThreadFromRootEvent(){var e=this;return R(function*(){dn.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return R(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,Ie.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ue.TimelineReset,e.room,e.timelineSet,!0)}catch(n){I.error("Failed to load start of newly created thread: ",n),e.initialEventsFetched=!1}e.emit(Zt.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return R(function*(){var n,i=(n=t.client.canSupport.get(It.RelationsRecursion))!==null&&n!==void 0?n:Tt.Unsupported;if(i===Tt.Unsupported){for(var a=e.length,s=new Array(a),l=0;l<a;l++)s[l]=e[l];return Promise.all(s.filter(eL).map(function(){var u=R(function*(d){try{var c=yield t.client.relations(t.roomId,d.getId(),Xe.Replace,d.getType(),{limit:1});if(c.events.length){var h=c.events[0];d.makeReplaced(h),t.insertEventIntoTimeline(h)}}catch(v){I.error("Failed to load edits for encrypted thread event",v)}});return function(d){return u.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(he.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[We.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:i=>i.isRelation(We.name),t=this.timeline.length-1;t>=0;t--){var n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof qt}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(n&&i){var a=i.getTs()<this.room.getOldestThreadedReceiptTs(),s=i.getId();if(a&&s)return s}var l=super.getEventReadUpTo(e,t);if(i){var u=this.room.getLastUnthreadedReceiptFor(e);if(!u)return l;for(var d=((c=this.timeline)===null||c===void 0?void 0:c.length)-1;d>=0;--d){var c,h,v=this.timeline[d];if(v.getId()===l)return l;if(v.getTs()<u.ts)return(h=v.getId())!==null&&h!==void 0?h:l}}return l}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,i,a,s,l,u,d=((n=(i=this.lastReply())===null||i===void 0?void 0:i.getTs())!==null&&n!==void 0?n:0)<this.room.getOldestThreadedReceiptTs(),c=(a=(s=this.room.getLastUnthreadedReceiptFor(e))===null||s===void 0?void 0:s.ts)!==null&&a!==void 0?a:0,h=((l=this===null||this===void 0||(u=this.lastReply())===null||u===void 0?void 0:u.getTs())!==null&&l!==void 0?l:0)<c;if(d||h)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}};o(dn,"Thread");let yt=dn;f(yt,"hasServerSideSupport",Wt.None);f(yt,"hasServerSideListSupport",Wt.None);f(yt,"hasServerSideFwdPaginationSupport",Wt.None);function eL(r){return r.isEncrypted()&&(r.isRelation(We.name)||r.isThreadRoot)}o(eL,"isAnEncryptedThreadMessage");var cs=new Ks("related_by_senders","io.element.relation_senders"),hs=new Ks("related_by_rel_types","io.element.relation_types"),We=new Ks("m.thread","io.element.thread"),Wr=function(r){return r[r.My=0]="My",r[r.All=1]="All",r}({});function JI(r){switch(r){case Wr.My:return"participated";default:return"all"}}o(JI,"threadFilterTypeToFilter");const XS=class XS extends Error{constructor(e,t,n){super(t),this.code=e,f(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=tL(this,n)}};o(XS,"DecryptionError");let Fc=XS;function tL(r,e){var t=r.name+"[msg: "+r.message;return e&&(t+=", "+Object.keys(e).map(n=>n+": "+e[n]).join(", ")),t+="]",t}o(tL,"detailedStringForDecryptionError");var b0=Object.freeze({visible:!0}),Le=function(r){return r.Decrypted="Event.decrypted",r.BeforeRedaction="Event.beforeRedaction",r.VisibilityChange="Event.visibilityChange",r.LocalEventIdReplaced="Event.localEventIdReplaced",r.Status="Event.status",r.Replaced="Event.replaced",r.RelationsCreated="Event.relationsCreated",r.SentinelUpdated="Event.sentinelUpdated",r}({});const Xc=class Xc extends Ge{setMetadata(e,t){var n,i,a=this.isState()&&this.getType()===B.RoomMember&&this.getSender()===this.getStateKey(),s=!1;if(a||!((n=this.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)){var l=e.getSentinelMember(this.getSender());l!==this.sender&&(s=!0),this.sender=l}if(a||!((i=this.target)!==null&&i!==void 0&&(i=i.events)!==null&&i!==void 0&&i.member)&&this.getType()===B.RoomMember){var u=e.getSentinelMember(this.getStateKey());u!==this.target&&(s=!0),this.target=u}this.isState()&&t&&(this.forwardLooking=!1),s&&this.emit(Le.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,f(this,"pushDetails",{}),f(this,"_replacingEvent",null),f(this,"_localRedactionEvent",null),f(this,"_isCancelled",!1),f(this,"clearEvent",void 0),f(this,"visibility",b0),f(this,"_hasCachedExtEv",!1),f(this,"_cachedExtEv",void 0),f(this,"_decryptionFailureReason",null),f(this,"senderCurve25519Key",null),f(this,"claimedEd25519Key",null),f(this,"forwardingCurve25519KeyChain",[]),f(this,"untrusted",null),f(this,"decryptionPromise",null),f(this,"retryDecryption",!1),f(this,"txnId",void 0),f(this,"thread",void 0),f(this,"threadId",void 0),f(this,"localTimestamp",void 0),f(this,"sender",null),f(this,"target",null),f(this,"status",null),f(this,"error",null),f(this,"forwardLooking",!0),f(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(i=>{typeof t[i]=="string"&&(t[i]=gf(t[i]))}),["membership","avatar_url","displayname"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0?void 0:a[i])=="string"&&(t.content[i]=gf(t.content[i]))}),["rel_type"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0||(a=a["m.relates_to"])===null||a===void 0?void 0:a[i])=="string"&&(t.content["m.relates_to"][i]=gf(t.content["m.relates_to"][i]))}),this.txnId=t.txn_id;var n=this.getAge();this.localTimestamp=n!==void 0?Date.now()-n:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new Ai(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=nr.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===B.RoomMessageEncrypted)for(var[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var n=this.getContent()[Rh];return"msgid=".concat(n," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if((t==null?void 0:t.rel_type)===We.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var n=this.getUnsigned();if(typeof n[rc.name]=="string")return n[rc.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(We.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return jR.findIn(e)}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===s0.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=n.clearEvent&&!n.isDecryptionFailure(),s=i.forceRedecryptIfUntrusted&&n.isKeySourceUntrusted();if(a&&!s)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(I.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,i),n.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var a=void 0;try{var s=yield e.decryptEvent(n);i.isRetry===!0&&I.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(s),n._decryptionFailureReason=null}catch(u){var l=u instanceof Fc?u.detailedString:String(u);if(a=u,n.retryDecryption){I.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(l));continue}I.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(l)),n.setClearDataForDecryptionFailure(String(u)),n._decryptionFailureReason=u instanceof Fc?u.code:s0.UNKNOWN_ERROR}n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),i.emit!==!1&&n.emit(Le.Decrypted,n,a);return}})()}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(n=e.claimedEd25519Key)!==null&&n!==void 0?n:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:B.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===B.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(Le.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n,i=(t=e==null?void 0:e.visible)!==null&&t!==void 0?t:!0,a=(n=e==null?void 0:e.reason)!==null&&n!==void 0?n:null,s=!1;(this.visibility.visible!==i||!this.visibility.visible&&this.visibility.reason!==a)&&(s=!0),s&&(i?this.visibility=b0:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(Le.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(Le.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var n in this.event)this.event.hasOwnProperty(n)&&!rL.has(n)&&delete this.event[n];this.isEncrypted()&&(this.clearEvent=void 0);var i=this.getType()in w0?w0[this.getType()]:{},a=this.getContent();for(var s in a)a.hasOwnProperty(s)&&!i[s]&&delete a[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var n of t.events){var i;((i=n.getRelation())===null||i===void 0?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var n=e.getLiveTimeline();n.getTimelineSet().insertEventIntoTimeline(this,n,n.getState(he.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===B.RoomRedaction}asVisibilityChange(){if(!ia.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var n=this.getWireContent(),i=!!n.visible,a=n.reason;return a&&typeof a!="string"?null:{visible:i,reason:a,eventId:t}}isVisibilityEvent(){return ia.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var n,i;return(n=(i=this.clearEvent)===null||i===void 0?void 0:i.unsigned.redacted_because)!==null&&n!==void 0?n:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,n=this.getUnsigned(),i=this.getId();this.event=e,n.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=n.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit(Le.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(Le.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(Le.LocalEventIdReplaced,this)}isRelation(e){var t,n=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(n!=null&&n.rel_type)&&[Xe.Replace,Xe.Thread].includes(n.rel_type)?!1:!!(n!=null&&n.rel_type&&n.event_id&&(!e||n.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(Le.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Xe.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Xe.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var n;return(n=this._replacingEvent.getDate())!==null&&n!==void 0?n:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new Xc(JSON.parse(JSON.stringify(this.event)));for(var[t,n]of Object.entries(this))t!=="event"&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=Kv(this.event),n=Kv(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Zt.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[Zt.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}};o(Xc,"MatrixEvent");let qt=Xc;var rL=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),w0={[B.RoomMember]:{membership:1},[B.RoomJoinRules]:{join_rule:1},[B.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},nL=["org.matrix.hydra.11","12"];function iL(r){return nL.includes(r)}o(iL,"shouldUseHydraForRoomVersion");var vr=function(r){return r[r.NotStarted=0]="NotStarted",r[r.InProgress=1]="InProgress",r[r.Finished=2]="Finished",r}(vr||{}),ke=function(r){return r.Events="RoomState.events",r.Members="RoomState.members",r.NewMember="RoomState.newMember",r.Update="RoomState.update",r.BeaconLiveness="RoomState.BeaconLiveness",r.Marker="RoomState.Marker",r}({});const Zc=class Zc extends Ge{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:vr.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,f(this,"reEmitter",new Ai(this)),f(this,"sentinels",{}),f(this,"displayNameToUserIds",new Map),f(this,"userIdsToDisplayNames",{}),f(this,"tokenToInvite",{}),f(this,"joinedMemberCount",null),f(this,"summaryJoinedMemberCount",null),f(this,"invitedMemberCount",null),f(this,"summaryInvitedMemberCount",null),f(this,"modified",-1),f(this,"members",{}),f(this,"events",new Map),f(this,"paginationToken",null),f(this,"beacons",new Map),f(this,"_liveBeaconIds",[]),f(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(B.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(I.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Te.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Te.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new ga(this.roomId,e);var n=this.members[e];n!=null&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new Zc(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=vr.NotStarted,Array.from(this.events.values()).forEach(n=>{e.setStateEvents(Array.from(n.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==vr.Finished&&this.getMembers().forEach(n=>{if(n.isOutOfBand()){var i;(i=e.getMember(n.userId))===null||i===void 0||i.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(n=>!this.events.has(n.getType())||!this.events.get(n.getType()).has(n.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState())){oy.matches(n.getType())&&this.setBeacon(n);var i=this.getStateEventMatching(n);if(this.setStateEvent(n),n.getType()===B.RoomMember){var a;this.updateDisplayNameCache(n.getStateKey(),(a=n.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(n)}this.emit(ke.Events,n,this,i)}}),this.onBeaconLivenessChange(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState()))if(n.getType()===B.RoomMember){var i=n.getStateKey();(n.getContent().membership===Te.Leave||n.getContent().membership===Te.Ban)&&(n.getContent().avatar_url=n.getContent().avatar_url||n.getPrevContent().avatar_url,n.getContent().displayname=n.getContent().displayname||n.getPrevContent().displayname);var a=this.getOrCreateMember(i,n);a.setMembershipEvent(n,this),this.updateMember(a),this.emit(ke.Members,n,this,a)}else if(n.getType()===B.RoomPowerLevels){if(n.getStateKey()!=="")return;var s=Object.values(this.members),l=this.getStateEvents(B.RoomCreate,""),u=T0(this.getRoomVersion(),l);s.forEach(d=>{var c=d.getLastModifiedTime();if(l){var h=R0(d.userId,n,u);d.setPowerLevel(h,n)}c!==d.getLastModifiedTime()&&this.emit(ke.Members,n,this,d)}),this.sentinels={}}else NR.matches(n.getType())&&this.emit(ke.Marker,n,t)}),this.emit(ke.Update,this)}processBeaconEvents(e,t){var n=this;return R(function*(){if(!(!e.length||!n.beacons.size)){var i=[...n.beacons.values()].reduce((d,c)=>(d[c.beaconInfoId]=c,d),{}),a=o((d,c)=>{if(cm.matches(c.getType())){var h=i[d];h&&h.addLocations([c])}},"processBeaconRelation"),s=o(function*(c){var h,v=(h=c.getRelation())===null||h===void 0?void 0:h.event_id;if(!v||!i[v])return{v:void 0};if(!cm.matches(c.getType())&&!c.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(c),a(v,c)}catch{c.isDecryptionFailure()&&c.once(Le.Decrypted,R(function*(){a(v,c)}))}},"_loop"),l;for(var u of e)if(l=yield*s(u),l)return l.v}})()}getOrCreateMember(e,t){var n=this.members[e];return n||(n=new ga(this.roomId,e),this.members[e]=n,this.emit(ke.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=fc(e);if(this.beacons.has(t)){var n=this.beacons.get(t);if(e.isRedacted()){var i;n.beaconInfoId===((i=e.getRedactionEvent())===null||i===void 0?void 0:i.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var a=new vc(e);this.reEmitter.reEmit(a,[Je.New,Je.Update,Je.Destroy,Je.LivenessChange]),this.emit(Je.New,e,a),a.on(Je.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(Je.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(ke.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return(t=(n=this.events.get(e.getType()))===null||n===void 0?void 0:n.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(B.RoomCreate,""),n=this.getStateEvents(B.RoomPowerLevels,"");if(n&&t){var i=R0(e.userId,n,T0(this.getRoomVersion(),t));e.setPowerLevel(i,n)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===vr.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===vr.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===vr.NotStarted&&(this.oobMemberFlags.status=vr.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===vr.InProgress&&(this.oobMemberFlags.status=vr.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])}),I.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=vr.NotStarted}setOutOfBandMembers(e){I.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===vr.InProgress&&(I.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=vr.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(ke.Update,this))}setOutOfBandMember(e){if(e.getType()===B.RoomMember){var t=e.getStateKey(),n=this.getMember(t);if(!(n&&!n.isOutOfBand())){var i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(ke.Members,e,this,i)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(la(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var n=this.getMember(t);if(!n||n.membership===Te.Leave||e.status||e.isRedacted())return!1;var i=this.maySendEvent(B.RoomRedaction,t);return i?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",n.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var n=this.getStateEvents(B.RoomPowerLevels,""),i={};n&&(i=n.getContent());var a=50;return H_(i[e])&&(a=i[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(B.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){var i,a=this.getStateEvents(B.RoomPowerLevels,""),s,l={},u=0,d=0;a&&(s=a.getContent(),l=s.events||{},Number.isSafeInteger(s.state_default)?u=s.state_default:u=50,Number.isSafeInteger(s.events_default)&&(d=s.events_default));var c=n?u:d;Number.isSafeInteger(l[e])&&(c=l[e]);var h=this.getMember(t),v=(i=h==null?void 0:h.powerLevel)!==null&&i!==void 0?i:0;return v>=c}mayTriggerNotifOfType(e,t){var n=this.getMember(t);if(!n)return!1;var i=this.getStateEvents(B.RoomPowerLevels,""),a=50;return i&&i.getContent()&&i.getContent().notifications&&H_(i.getContent().notifications[e])&&(a=i.getContent().notifications[e]),n.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(B.RoomJoinRules,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.join_rule||II.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(B.RoomHistoryVisibility,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.history_visibility||sy.Shared}getGuestAccess(){var e,t=this.getStateEvents(B.RoomGuestAccess,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.guest_access||Ic.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(B.RoomPredecessor,"");if(t){var n=t.getContent(),i=n.predecessor_room_id,a=n.last_known_event_id;typeof a!="string"&&(a=void 0);var s=n.via_servers;if(Array.isArray(s)||(s=void 0),typeof i=="string")return{roomId:i,eventId:a,viaServers:s}}}var l=this.getStateEvents(B.RoomCreate,"");if(l){var u=l.getContent().predecessor;if(u){var d=u.room_id;if(typeof d=="string"){var c=u.event_id;return(typeof c!="string"||c==="")&&(c=void 0),{roomId:d,eventId:c}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var n=this.getStateEvents(B.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){var i=la(n),a=this.displayNameToUserIds.get(i);if(a){var s=a.filter(c=>c!==e);this.displayNameToUserIds.set(i,s)}}this.userIdsToDisplayNames[e]=t;var l=t&&la(t);if(l){var u,d=(u=this.displayNameToUserIds.get(l))!==null&&u!==void 0?u:[];d.push(e),this.displayNameToUserIds.set(l,d)}}};o(Zc,"RoomState");let zl=Zc;function T0(r,e){var t=new Set;if(iL(r)&&e){var n=e.getSender();n&&t.add(n);var i=e.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(a=>t.add(a))}return t}o(T0,"getCreators");function R0(r,e,t){if(t.has(r))return 1/0;var n=e.getDirectionalContent(),i=n.users||{};return i[r]!==void 0&&Number.isInteger(i[r])?i[r]:n.users_default!==void 0?n.users_default:0}o(R0,"powerLevelForUserId");function I0(r){var e=typeof r=="string"&&!!r&&r!=="undefined"&&r!=="null";return e||typeof r=="number"}o(I0,"isValidFilterId");const ZS=class ZS{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};f(this,"rooms",{}),f(this,"users",{}),f(this,"syncToken",null),f(this,"filters",new Jr(()=>new Map)),f(this,"accountData",new Map),f(this,"localStorage",void 0),f(this,"oobMembers",new Map),f(this,"pendingEvents",{}),f(this,"clientOptions",void 0),f(this,"pendingToDeviceBatches",[]),f(this,"nextToDeviceBatchId",0),f(this,"createUser",void 0),f(this,"onRoomMember",(t,n,i)=>{var a;if(i.membership!==Te.Invite){var s=this.users[i.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,i.userId));i.name&&(s.setDisplayName(i.name),i.events.member&&s.setRawDisplayName(i.events.member.getDirectionalContent().displayname)),i.events.member&&i.events.member.getContent().avatar_url&&s.setAvatarUrl(i.events.member.getContent().avatar_url),this.users[s.userId]=s}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(ke.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(ke.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return((n=this.filters.get(e))===null||n===void 0?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var n=this.localStorage.getItem(t);if(I0(n))return n}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var n="mxjssdk_memory_filter_"+e;try{I0(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var n=!Object.keys(t.getContent()).length;n?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new Jr(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return R(function*(){var n;return(n=t.pendingEvents[e])!==null&&n!==void 0?n:[]})()}setPendingEvents(e,t){var n=this;return R(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return R(function*(){})()}};o(ZS,"MemoryStore");let Jl=ZS;var Ff={},Ki={},Ra={};Object.defineProperty(Ra,"__esModule",{value:!0});Ra.WidgetApiDirection=void 0;Ra.invertedDirection=aL;var Vo=function(r){return r.ToWidget="toWidget",r.FromWidget="fromWidget",r}({});Ra.WidgetApiDirection=Vo;function aL(r){if(r===Vo.ToWidget)return Vo.FromWidget;if(r===Vo.FromWidget)return Vo.ToWidget;throw new Error("Invalid direction")}o(aL,"invertedDirection");var yn={};Object.defineProperty(yn,"__esModule",{value:!0});yn.UnstableApiVersion=yn.MatrixApiVersion=yn.CurrentApiVersions=void 0;var xm=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});yn.MatrixApiVersion=xm;var pr=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});yn.UnstableApiVersion=pr;var sL=[xm.Prerelease1,xm.Prerelease2,pr.MSC2762,pr.MSC2762_UPDATE_STATE,pr.MSC2871,pr.MSC2873,pr.MSC2931,pr.MSC2974,pr.MSC2876,pr.MSC3819,pr.MSC3846,pr.MSC3869,pr.MSC3973,pr.MSC4039];yn.CurrentApiVersions=sL;var Ao={},C0;function py(){if(C0)return Ao;C0=1,Object.defineProperty(Ao,"__esModule",{value:!0}),Ao.PostmessageTransport=void 0;var r=Th,e=Bh(),t=["message"];function n(_){"@babel/helpers - typeof";return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(O){return typeof O}:function(O){return O&&typeof Symbol=="function"&&O.constructor===Symbol&&O!==Symbol.prototype?"symbol":typeof O},n(_)}o(n,"_typeof");function i(_,O){if(_==null)return{};var b=a(_,O),F,V;if(Object.getOwnPropertySymbols){var z=Object.getOwnPropertySymbols(_);for(V=0;V<z.length;V++)F=z[V],!(O.indexOf(F)>=0)&&Object.prototype.propertyIsEnumerable.call(_,F)&&(b[F]=_[F])}return b}o(i,"_objectWithoutProperties");function a(_,O){if(_==null)return{};var b={},F=Object.keys(_),V,z;for(z=0;z<F.length;z++)V=F[z],!(O.indexOf(V)>=0)&&(b[V]=_[V]);return b}o(a,"_objectWithoutPropertiesLoose");function s(_,O){var b=Object.keys(_);if(Object.getOwnPropertySymbols){var F=Object.getOwnPropertySymbols(_);O&&(F=F.filter(function(V){return Object.getOwnPropertyDescriptor(_,V).enumerable})),b.push.apply(b,F)}return b}o(s,"ownKeys");function l(_){for(var O=1;O<arguments.length;O++){var b=arguments[O]!=null?arguments[O]:{};O%2?s(Object(b),!0).forEach(function(F){S(_,F,b[F])}):Object.getOwnPropertyDescriptors?Object.defineProperties(_,Object.getOwnPropertyDescriptors(b)):s(Object(b)).forEach(function(F){Object.defineProperty(_,F,Object.getOwnPropertyDescriptor(b,F))})}return _}o(l,"_objectSpread");function u(_,O){if(!(_ instanceof O))throw new TypeError("Cannot call a class as a function")}o(u,"_classCallCheck");function d(_,O){for(var b=0;b<O.length;b++){var F=O[b];F.enumerable=F.enumerable||!1,F.configurable=!0,"value"in F&&(F.writable=!0),Object.defineProperty(_,w(F.key),F)}}o(d,"_defineProperties");function c(_,O,b){return O&&d(_.prototype,O),Object.defineProperty(_,"prototype",{writable:!1}),_}o(c,"_createClass");function h(_,O){if(typeof O!="function"&&O!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(O&&O.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),O&&v(_,O)}o(h,"_inherits");function v(_,O){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(F,V){return F.__proto__=V,F},"_setPrototypeOf"),v(_,O)}o(v,"_setPrototypeOf");function g(_){var O=T();return o(function(){var F=y(_),V;if(O){var z=y(this).constructor;V=Reflect.construct(F,arguments,z)}else V=F.apply(this,arguments);return p(this,V)},"_createSuperInternal")}o(g,"_createSuper");function p(_,O){if(O&&(n(O)==="object"||typeof O=="function"))return O;if(O!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(_)}o(p,"_possibleConstructorReturn");function m(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}o(m,"_assertThisInitialized");function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(T,"_isNativeReflectConstruct");function y(_){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(b){return b.__proto__||Object.getPrototypeOf(b)},"_getPrototypeOf"),y(_)}o(y,"_getPrototypeOf");function S(_,O,b){return O=w(O),O in _?Object.defineProperty(_,O,{value:b,enumerable:!0,configurable:!0,writable:!0}):_[O]=b,_}o(S,"_defineProperty");function w(_){var O=C(_,"string");return n(O)==="symbol"?O:String(O)}o(w,"_toPropertyKey");function C(_,O){if(n(_)!=="object"||_===null)return _;var b=_[Symbol.toPrimitive];if(b!==void 0){var F=b.call(_,O);if(n(F)!=="object")return F;throw new TypeError("@@toPrimitive must return a primitive value.")}return(O==="string"?String:Number)(_)}o(C,"_toPrimitive");var M=function(_){h(b,_);var O=g(b);function b(F,V,z,ie){var se;return u(this,b),se=O.call(this),se.sendDirection=F,se.initialWidgetId=V,se.transportWindow=z,se.inboundWindow=ie,S(m(se),"strictOriginCheck",!1),S(m(se),"targetOrigin","*"),S(m(se),"timeoutSeconds",10),S(m(se),"_ready",!1),S(m(se),"_widgetId",null),S(m(se),"outboundRequests",new Map),S(m(se),"stopController",new AbortController),se._widgetId=V,se}return o(b,"PostmessageTransport"),c(b,[{key:"ready",get:o(function(){return this._ready},"get")},{key:"widgetId",get:o(function(){return this._widgetId||null},"get")},{key:"nextRequestId",get:o(function(){for(var V="widgetapi-".concat(Date.now()),z=0,ie=V;this.outboundRequests.has(ie);)ie="".concat(V,"-").concat(z++);return this.outboundRequests.set(ie,null),ie},"get")},{key:"sendInternal",value:o(function(V){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),V),this.transportWindow.postMessage(V,this.targetOrigin)},"sendInternal")},{key:"reply",value:o(function(V,z){return this.sendInternal(l(l({},V),{},{response:z}))},"reply")},{key:"send",value:o(function(V,z){return this.sendComplete(V,z).then(function(ie){return ie.response})},"send")},{key:"sendComplete",value:o(function(V,z){var ie=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var se={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:V,data:z};return V===e.WidgetApiToWidgetAction.UpdateVisibility&&(se.visible=z.visible),new Promise(function(Pe,Ce){var $e=o(function(j){me(),Pe(j)},"resolve"),re=o(function(j){me(),Ce(j)},"reject"),Y=setTimeout(function(){return re(new Error("Request timed out"))},(ie.timeoutSeconds||1)*1e3),le=o(function(){return re(new Error("Transport stopped"))},"onStop");ie.stopController.signal.addEventListener("abort",le);var me=o(function(){ie.outboundRequests.delete(se.requestId),clearTimeout(Y),ie.stopController.signal.removeEventListener("abort",le)},"cleanUp");ie.outboundRequests.set(se.requestId,{request:se,resolve:$e,reject:re}),ie.sendInternal(se)})},"sendComplete")},{key:"start",value:o(function(){var V=this;this.inboundWindow.addEventListener("message",function(z){V.handleMessage(z)}),this._ready=!0},"start")},{key:"stop",value:o(function(){this._ready=!1,this.stopController.abort()},"stop")},{key:"handleMessage",value:o(function(V){if(!this.stopController.signal.aborted&&V.data&&!(this.strictOriginCheck&&V.origin!==window.origin)){var z=V.data;if(!(!z.action||!z.requestId||!z.widgetId))if(z.response){if(z.api!==this.sendDirection)return;this.handleResponse(z)}else{var ie=z;if(ie.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(ie)}}},"handleMessage")},{key:"handleRequest",value:o(function(V){if(this.widgetId){if(this.widgetId!==V.widgetId)return}else this._widgetId=V.widgetId;this.emit("message",new CustomEvent("message",{detail:V}))},"handleRequest")},{key:"handleResponse",value:o(function(V){if(V.widgetId===this.widgetId){var z=this.outboundRequests.get(V.requestId);if(z)if((0,e.isErrorResponse)(V.response)){var ie=V.response.error,se=ie.message,Pe=i(ie,t);z.reject(new e.WidgetApiResponseError(se,Pe))}else z.resolve(V)}},"handleResponse")}]),b}(r.EventEmitter);return Ao.PostmessageTransport=M,Ao}o(py,"requirePostmessageTransport");var xi={};Object.defineProperty(xi,"__esModule",{value:!0});xi.WidgetApiToWidgetAction=xi.WidgetApiFromWidgetAction=void 0;var oL=function(r){return r.SupportedApiVersions="supported_api_versions",r.Capabilities="capabilities",r.NotifyCapabilities="notify_capabilities",r.ThemeChange="theme_change",r.LanguageChange="language_change",r.TakeScreenshot="screenshot",r.UpdateVisibility="visibility",r.OpenIDCredentials="openid_credentials",r.WidgetConfig="widget_config",r.CloseModalWidget="close_modal",r.ButtonClicked="button_clicked",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.UpdateState="update_state",r.UpdateTurnServers="update_turn_servers",r}({});xi.WidgetApiToWidgetAction=oL;var lL=function(r){return r.SupportedApiVersions="supported_api_versions",r.ContentLoaded="content_loaded",r.SendSticker="m.sticker",r.UpdateAlwaysOnScreen="set_always_on_screen",r.GetOpenIDCredentials="get_openid",r.CloseModalWidget="close_modal",r.OpenModalWidget="open_modal",r.SetModalButtonEnabled="set_button_enabled",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.WatchTurnServers="watch_turn_servers",r.UnwatchTurnServers="unwatch_turn_servers",r.BeeperReadRoomAccountData="com.beeper.read_room_account_data",r.MSC2876ReadEvents="org.matrix.msc2876.read_events",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",r.MSC3869ReadRelations="org.matrix.msc3869.read_relations",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",r.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",r.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});xi.WidgetApiFromWidgetAction=lL;var fo={};Object.defineProperty(fo,"__esModule",{value:!0});fo.OpenIDRequestState=void 0;var uL=function(r){return r.Allowed="allowed",r.Blocked="blocked",r.PendingUserConfirmation="request",r}({});fo.OpenIDRequestState=uL;var gu={};Object.defineProperty(gu,"__esModule",{value:!0});gu.MatrixWidgetType=void 0;var dL=function(r){return r.Custom="m.custom",r.JitsiMeet="m.jitsi",r.Stickerpicker="m.stickerpicker",r}({});gu.MatrixWidgetType=dL;var yu={};Object.defineProperty(yu,"__esModule",{value:!0});yu.BuiltInModalButtonID=void 0;var cL=function(r){return r.Close="m.close",r}({});yu.BuiltInModalButtonID=cL;var Sn={};Object.defineProperty(Sn,"__esModule",{value:!0});Sn.WidgetEventCapability=Sn.EventKind=Sn.EventDirection=void 0;function Ql(r){"@babel/helpers - typeof";return Ql=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ql(r)}o(Ql,"_typeof$2");function hL(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=fL(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(hL,"_createForOfIteratorHelper$1");function fL(r,e){if(r){if(typeof r=="string")return O0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return O0(r,e)}}o(fL,"_unsupportedIterableToArray$1");function O0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(O0,"_arrayLikeToArray$1");function vL(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(vL,"_classCallCheck$1");function k0(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,mL(n.key),n)}}o(k0,"_defineProperties$1");function pL(r,e,t){return e&&k0(r.prototype,e),t&&k0(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(pL,"_createClass$1");function mL(r){var e=gL(r,"string");return Ql(e)==="symbol"?e:String(e)}o(mL,"_toPropertyKey$1");function gL(r,e){if(Ql(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Ql(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}o(gL,"_toPrimitive$1");var mr=function(r){return r.Event="event",r.State="state_event",r.ToDevice="to_device",r.RoomAccount="room_account",r}({});Sn.EventKind=mr;var ii=function(r){return r.Send="send",r.Receive="receive",r}({});Sn.EventDirection=ii;var yL=function(){function r(e,t,n,i,a){vL(this,r),this.direction=e,this.eventType=t,this.kind=n,this.keyStr=i,this.raw=a}return o(r,"WidgetEventCapability"),pL(r,[{key:"matchesAsStateEvent",value:o(function(t,n,i){return this.kind!==mr.State||this.direction!==t||this.eventType!==n?!1:this.keyStr===null||this.keyStr===i},"matchesAsStateEvent")},{key:"matchesAsToDeviceEvent",value:o(function(t,n){return!(this.kind!==mr.ToDevice||this.direction!==t||this.eventType!==n)},"matchesAsToDeviceEvent")},{key:"matchesAsRoomEvent",value:o(function(t,n){var i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==mr.Event||this.direction!==t||this.eventType!==n)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===i)return!0}else return!0;return!1},"matchesAsRoomEvent")},{key:"matchesAsRoomAccountData",value:o(function(t,n){return!(this.kind!==mr.RoomAccount||this.direction!==t||this.eventType!==n)},"matchesAsRoomAccountData")}],[{key:"forStateEvent",value:o(function(t,n,i){n=n.replace(/#/g,"\\#"),i=i!=null?"#".concat(i):"";var a="org.matrix.msc2762.".concat(t,".state_event:").concat(n).concat(i);return r.findEventCapabilities([a])[0]},"forStateEvent")},{key:"forToDeviceEvent",value:o(function(t,n){var i="org.matrix.msc3819.".concat(t,".to_device:").concat(n);return r.findEventCapabilities([i])[0]},"forToDeviceEvent")},{key:"forRoomEvent",value:o(function(t,n){var i="org.matrix.msc2762.".concat(t,".event:").concat(n);return r.findEventCapabilities([i])[0]},"forRoomEvent")},{key:"forRoomMessageEvent",value:o(function(t,n){n=n??"";var i="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(n);return r.findEventCapabilities([i])[0]},"forRoomMessageEvent")},{key:"forRoomAccountData",value:o(function(t,n){var i="com.beeper.capabilities.".concat(t,".room_account_data:").concat(n);return r.findEventCapabilities([i])[0]},"forRoomAccountData")},{key:"findEventCapabilities",value:o(function(t){var n=[],i=hL(t),a;try{for(i.s();!(a=i.n()).done;){var s=a.value,l=null,u=void 0,d=null;if(s.startsWith("org.matrix.msc2762.send.event:")?(l=ii.Send,d=mr.Event,u=s.substring(30)):s.startsWith("org.matrix.msc2762.send.state_event:")?(l=ii.Send,d=mr.State,u=s.substring(36)):s.startsWith("org.matrix.msc3819.send.to_device:")?(l=ii.Send,d=mr.ToDevice,u=s.substring(34)):s.startsWith("org.matrix.msc2762.receive.event:")?(l=ii.Receive,d=mr.Event,u=s.substring(33)):s.startsWith("org.matrix.msc2762.receive.state_event:")?(l=ii.Receive,d=mr.State,u=s.substring(39)):s.startsWith("org.matrix.msc3819.receive.to_device:")?(l=ii.Receive,d=mr.ToDevice,u=s.substring(37)):s.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(l=ii.Receive,d=mr.RoomAccount,u=s.substring(50)),!(l===null||d===null||u===void 0)){var c=u.startsWith("m.room.message#")||d===mr.State,h=null;if(u.includes("#")&&c){var v=u.split("#"),g=v.findIndex(function(p){return!p.endsWith("\\")});u=v.slice(0,g+1).map(function(p){return p.endsWith("\\")?p.substring(0,p.length-1):p}).join("#"),h=v.slice(g+1).join("#")}n.push(new r(l,u,d,h,s))}}}catch(p){i.e(p)}finally{i.f()}return n},"findEventCapabilities")}]),r}();Sn.WidgetEventCapability=yL;var vo={};Object.defineProperty(vo,"__esModule",{value:!0});vo.Symbols=void 0;var SL=function(r){return r.AnyRoom="*",r}({});vo.Symbols=SL;var P0;function EL(){if(P0)return Ki;P0=1;function r(j){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(Q){return typeof Q}:function(Q){return Q&&typeof Symbol=="function"&&Q.constructor===Symbol&&Q!==Symbol.prototype?"symbol":typeof Q},r(j)}o(r,"_typeof"),Object.defineProperty(Ki,"__esModule",{value:!0}),Ki.WidgetApiResponseError=Ki.WidgetApi=void 0;var e=Th,t=Ra,n=yn,i=py(),a=xi,s=fo,l=gu,u=yu,d=Sn,c=vo;function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=o(function(){return j},"_regeneratorRuntime");var j={},Q=Object.prototype,N=Q.hasOwnProperty,D=Object.defineProperty||function(oe,Z,q){oe[Z]=q.value},x=typeof Symbol=="function"?Symbol:{},A=x.iterator||"@@iterator",P=x.asyncIterator||"@@asyncIterator",L=x.toStringTag||"@@toStringTag";function k(oe,Z,q){return Object.defineProperty(oe,Z,{value:q,enumerable:!0,configurable:!0,writable:!0}),oe[Z]}o(k,"define");try{k({},"")}catch{k=o(function(q,H,J){return q[H]=J},"define")}function $(oe,Z,q,H){var J=Z&&Z.prototype instanceof X?Z:X,ee=Object.create(J.prototype),ge=new mo(H||[]);return D(ee,"_invoke",{value:ce(oe,q,ge)}),ee}o($,"wrap");function U(oe,Z,q){try{return{type:"normal",arg:oe.call(Z,q)}}catch(H){return{type:"throw",arg:H}}}o(U,"tryCatch"),j.wrap=$;var K={};function X(){}o(X,"Generator");function pe(){}o(pe,"GeneratorFunction");function ae(){}o(ae,"GeneratorFunctionPrototype");var je={};k(je,A,function(){return this});var be=Object.getPrototypeOf,fe=be&&be(be(Fi([])));fe&&fe!==Q&&N.call(fe,A)&&(je=fe);var Ye=ae.prototype=X.prototype=Object.create(je);function Ot(oe){["next","throw","return"].forEach(function(Z){k(oe,Z,function(q){return this._invoke(Z,q)})})}o(Ot,"defineIteratorMethods");function kt(oe,Z){function q(J,ee,ge,ye){var Ae=U(oe[J],oe,ee);if(Ae.type!=="throw"){var et=Ae.arg,tt=et.value;return tt&&r(tt)=="object"&&N.call(tt,"__await")?Z.resolve(tt.__await).then(function(Ht){q("next",Ht,ge,ye)},function(Ht){q("throw",Ht,ge,ye)}):Z.resolve(tt).then(function(Ht){et.value=Ht,ge(et)},function(Ht){return q("throw",Ht,ge,ye)})}ye(Ae.arg)}o(q,"invoke");var H;D(this,"_invoke",{value:o(function(ee,ge){function ye(){return new Z(function(Ae,et){q(ee,ge,Ae,et)})}return o(ye,"callInvokeWithMethodAndArg"),H=H?H.then(ye,ye):ye()},"value")})}o(kt,"AsyncIterator");function ce(oe,Z,q){var H="suspendedStart";return function(J,ee){if(H==="executing")throw new Error("Generator is already running");if(H==="completed"){if(J==="throw")throw ee;return Ca()}for(q.method=J,q.arg=ee;;){var ge=q.delegate;if(ge){var ye=ct(ge,q);if(ye){if(ye===K)continue;return ye}}if(q.method==="next")q.sent=q._sent=q.arg;else if(q.method==="throw"){if(H==="suspendedStart")throw H="completed",q.arg;q.dispatchException(q.arg)}else q.method==="return"&&q.abrupt("return",q.arg);H="executing";var Ae=U(oe,Z,q);if(Ae.type==="normal"){if(H=q.done?"completed":"suspendedYield",Ae.arg===K)continue;return{value:Ae.arg,done:q.done}}Ae.type==="throw"&&(H="completed",q.method="throw",q.arg=Ae.arg)}}}o(ce,"makeInvokeMethod");function ct(oe,Z){var q=Z.method,H=oe.iterator[q];if(H===void 0)return Z.delegate=null,q==="throw"&&oe.iterator.return&&(Z.method="return",Z.arg=void 0,ct(oe,Z),Z.method==="throw")||q!=="return"&&(Z.method="throw",Z.arg=new TypeError("The iterator does not provide a '"+q+"' method")),K;var J=U(H,oe.iterator,Z.arg);if(J.type==="throw")return Z.method="throw",Z.arg=J.arg,Z.delegate=null,K;var ee=J.arg;return ee?ee.done?(Z[oe.resultName]=ee.value,Z.next=oe.nextLoc,Z.method!=="return"&&(Z.method="next",Z.arg=void 0),Z.delegate=null,K):ee:(Z.method="throw",Z.arg=new TypeError("iterator result is not an object"),Z.delegate=null,K)}o(ct,"maybeInvokeDelegate");function po(oe){var Z={tryLoc:oe[0]};1 in oe&&(Z.catchLoc=oe[1]),2 in oe&&(Z.finallyLoc=oe[2],Z.afterLoc=oe[3]),this.tryEntries.push(Z)}o(po,"pushTryEntry");function Ia(oe){var Z=oe.completion||{};Z.type="normal",delete Z.arg,oe.completion=Z}o(Ia,"resetTryEntry");function mo(oe){this.tryEntries=[{tryLoc:"root"}],oe.forEach(po,this),this.reset(!0)}o(mo,"Context");function Fi(oe){if(oe){var Z=oe[A];if(Z)return Z.call(oe);if(typeof oe.next=="function")return oe;if(!isNaN(oe.length)){var q=-1,H=o(function J(){for(;++q<oe.length;)if(N.call(oe,q))return J.value=oe[q],J.done=!1,J;return J.value=void 0,J.done=!0,J},"next");return H.next=H}}return{next:Ca}}o(Fi,"values");function Ca(){return{value:void 0,done:!0}}return o(Ca,"doneResult"),pe.prototype=ae,D(Ye,"constructor",{value:ae,configurable:!0}),D(ae,"constructor",{value:pe,configurable:!0}),pe.displayName=k(ae,L,"GeneratorFunction"),j.isGeneratorFunction=function(oe){var Z=typeof oe=="function"&&oe.constructor;return!!Z&&(Z===pe||(Z.displayName||Z.name)==="GeneratorFunction")},j.mark=function(oe){return Object.setPrototypeOf?Object.setPrototypeOf(oe,ae):(oe.__proto__=ae,k(oe,L,"GeneratorFunction")),oe.prototype=Object.create(Ye),oe},j.awrap=function(oe){return{__await:oe}},Ot(kt.prototype),k(kt.prototype,P,function(){return this}),j.AsyncIterator=kt,j.async=function(oe,Z,q,H,J){J===void 0&&(J=Promise);var ee=new kt($(oe,Z,q,H),J);return j.isGeneratorFunction(Z)?ee:ee.next().then(function(ge){return ge.done?ge.value:ee.next()})},Ot(Ye),k(Ye,L,"Generator"),k(Ye,A,function(){return this}),k(Ye,"toString",function(){return"[object Generator]"}),j.keys=function(oe){var Z=Object(oe),q=[];for(var H in Z)q.push(H);return q.reverse(),o(function J(){for(;q.length;){var ee=q.pop();if(ee in Z)return J.value=ee,J.done=!1,J}return J.done=!0,J},"next")},j.values=Fi,mo.prototype={constructor:mo,reset:o(function(Z){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Ia),!Z)for(var q in this)q.charAt(0)==="t"&&N.call(this,q)&&!isNaN(+q.slice(1))&&(this[q]=void 0)},"reset"),stop:o(function(){this.done=!0;var Z=this.tryEntries[0].completion;if(Z.type==="throw")throw Z.arg;return this.rval},"stop"),dispatchException:o(function(Z){if(this.done)throw Z;var q=this;function H(et,tt){return ge.type="throw",ge.arg=Z,q.next=et,tt&&(q.method="next",q.arg=void 0),!!tt}o(H,"handle");for(var J=this.tryEntries.length-1;J>=0;--J){var ee=this.tryEntries[J],ge=ee.completion;if(ee.tryLoc==="root")return H("end");if(ee.tryLoc<=this.prev){var ye=N.call(ee,"catchLoc"),Ae=N.call(ee,"finallyLoc");if(ye&&Ae){if(this.prev<ee.catchLoc)return H(ee.catchLoc,!0);if(this.prev<ee.finallyLoc)return H(ee.finallyLoc)}else if(ye){if(this.prev<ee.catchLoc)return H(ee.catchLoc,!0)}else{if(!Ae)throw new Error("try statement without catch or finally");if(this.prev<ee.finallyLoc)return H(ee.finallyLoc)}}}},"dispatchException"),abrupt:o(function(Z,q){for(var H=this.tryEntries.length-1;H>=0;--H){var J=this.tryEntries[H];if(J.tryLoc<=this.prev&&N.call(J,"finallyLoc")&&this.prev<J.finallyLoc){var ee=J;break}}ee&&(Z==="break"||Z==="continue")&&ee.tryLoc<=q&&q<=ee.finallyLoc&&(ee=null);var ge=ee?ee.completion:{};return ge.type=Z,ge.arg=q,ee?(this.method="next",this.next=ee.finallyLoc,K):this.complete(ge)},"abrupt"),complete:o(function(Z,q){if(Z.type==="throw")throw Z.arg;return Z.type==="break"||Z.type==="continue"?this.next=Z.arg:Z.type==="return"?(this.rval=this.arg=Z.arg,this.method="return",this.next="end"):Z.type==="normal"&&q&&(this.next=q),K},"complete"),finish:o(function(Z){for(var q=this.tryEntries.length-1;q>=0;--q){var H=this.tryEntries[q];if(H.finallyLoc===Z)return this.complete(H.completion,H.afterLoc),Ia(H),K}},"finish"),catch:o(function(Z){for(var q=this.tryEntries.length-1;q>=0;--q){var H=this.tryEntries[q];if(H.tryLoc===Z){var J=H.completion;if(J.type==="throw"){var ee=J.arg;Ia(H)}return ee}}throw new Error("illegal catch attempt")},"_catch"),delegateYield:o(function(Z,q,H){return this.delegate={iterator:Fi(Z),resultName:q,nextLoc:H},this.method==="next"&&(this.arg=void 0),K},"delegateYield")},j}o(h,"_regeneratorRuntime");function v(j,Q,N,D,x,A,P){try{var L=j[A](P),k=L.value}catch($){N($);return}L.done?Q(k):Promise.resolve(k).then(D,x)}o(v,"asyncGeneratorStep");function g(j){return function(){var Q=this,N=arguments;return new Promise(function(D,x){var A=j.apply(Q,N);function P(k){v(A,D,x,P,L,"next",k)}o(P,"_next");function L(k){v(A,D,x,P,L,"throw",k)}o(L,"_throw"),P(void 0)})}}o(g,"_asyncToGenerator");function p(j,Q){var N=Object.keys(j);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(j);Q&&(D=D.filter(function(x){return Object.getOwnPropertyDescriptor(j,x).enumerable})),N.push.apply(N,D)}return N}o(p,"ownKeys");function m(j){for(var Q=1;Q<arguments.length;Q++){var N=arguments[Q]!=null?arguments[Q]:{};Q%2?p(Object(N),!0).forEach(function(D){T(j,D,N[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(j,Object.getOwnPropertyDescriptors(N)):p(Object(N)).forEach(function(D){Object.defineProperty(j,D,Object.getOwnPropertyDescriptor(N,D))})}return j}o(m,"_objectSpread");function T(j,Q,N){return Q=w(Q),Q in j?Object.defineProperty(j,Q,{value:N,enumerable:!0,configurable:!0,writable:!0}):j[Q]=N,j}o(T,"_defineProperty");function y(j,Q){for(var N=0;N<Q.length;N++){var D=Q[N];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(j,w(D.key),D)}}o(y,"_defineProperties");function S(j,Q,N){return Q&&y(j.prototype,Q),Object.defineProperty(j,"prototype",{writable:!1}),j}o(S,"_createClass");function w(j){var Q=C(j,"string");return r(Q)==="symbol"?Q:String(Q)}o(w,"_toPropertyKey");function C(j,Q){if(r(j)!=="object"||j===null)return j;var N=j[Symbol.toPrimitive];if(N!==void 0){var D=N.call(j,Q);if(r(D)!=="object")return D;throw new TypeError("@@toPrimitive must return a primitive value.")}return(Q==="string"?String:Number)(j)}o(C,"_toPrimitive");function M(j,Q){if(!(j instanceof Q))throw new TypeError("Cannot call a class as a function")}o(M,"_classCallCheck");function _(j,Q){if(typeof Q!="function"&&Q!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(Q&&Q.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),Object.defineProperty(j,"prototype",{writable:!1}),Q&&Pe(j,Q)}o(_,"_inherits");function O(j){var Q=ie();return o(function(){var D=Ce(j),x;if(Q){var A=Ce(this).constructor;x=Reflect.construct(D,arguments,A)}else x=D.apply(this,arguments);return b(this,x)},"_createSuperInternal")}o(O,"_createSuper");function b(j,Q){if(Q&&(r(Q)==="object"||typeof Q=="function"))return Q;if(Q!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return F(j)}o(b,"_possibleConstructorReturn");function F(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}o(F,"_assertThisInitialized");function V(j){var Q=typeof Map=="function"?new Map:void 0;return V=o(function(D){if(D===null||!se(D))return D;if(typeof D!="function")throw new TypeError("Super expression must either be null or a function");if(typeof Q<"u"){if(Q.has(D))return Q.get(D);Q.set(D,x)}function x(){return z(D,arguments,Ce(this).constructor)}return o(x,"Wrapper"),x.prototype=Object.create(D.prototype,{constructor:{value:x,enumerable:!1,writable:!0,configurable:!0}}),Pe(x,D)},"_wrapNativeSuper"),V(j)}o(V,"_wrapNativeSuper");function z(j,Q,N){return ie()?z=Reflect.construct.bind():z=o(function(x,A,P){var L=[null];L.push.apply(L,A);var k=Function.bind.apply(x,L),$=new k;return P&&Pe($,P.prototype),$},"_construct"),z.apply(null,arguments)}o(z,"_construct");function ie(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(ie,"_isNativeReflectConstruct");function se(j){return Function.toString.call(j).indexOf("[native code]")!==-1}o(se,"_isNativeFunction");function Pe(j,Q){return Pe=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(D,x){return D.__proto__=x,D},"_setPrototypeOf"),Pe(j,Q)}o(Pe,"_setPrototypeOf");function Ce(j){return Ce=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(N){return N.__proto__||Object.getPrototypeOf(N)},"_getPrototypeOf"),Ce(j)}o(Ce,"_getPrototypeOf");function $e(j){return new le(j,0)}o($e,"_awaitAsyncGenerator");function re(j){return function(){return new Y(j.apply(this,arguments))}}o(re,"_wrapAsyncGenerator");function Y(j){var Q,N;function D(A,P){try{var L=j[A](P),k=L.value,$=k instanceof le;Promise.resolve($?k.v:k).then(function(U){if($){var K=A==="return"?"return":"next";if(!k.k||U.done)return D(K,U);U=j[K](U).value}x(L.done?"return":"normal",U)},function(U){D("throw",U)})}catch(U){x("throw",U)}}o(D,"resume");function x(A,P){switch(A){case"return":Q.resolve({value:P,done:!0});break;case"throw":Q.reject(P);break;default:Q.resolve({value:P,done:!1})}(Q=Q.next)?D(Q.key,Q.arg):N=null}o(x,"settle"),this._invoke=function(A,P){return new Promise(function(L,k){var $={key:A,arg:P,resolve:L,reject:k,next:null};N?N=N.next=$:(Q=N=$,D(A,P))})},typeof j.return!="function"&&(this.return=void 0)}o(Y,"_AsyncGenerator"),Y.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Y.prototype.next=function(j){return this._invoke("next",j)},Y.prototype.throw=function(j){return this._invoke("throw",j)},Y.prototype.return=function(j){return this._invoke("return",j)};function le(j,Q){this.v=j,this.k=Q}o(le,"_OverloadYield");var me=function(j){_(N,j);var Q=O(N);function N(D,x){var A;return M(this,N),A=Q.call(this,D),A.data=x,A}return o(N,"WidgetApiResponseError"),S(N)}(V(Error));Ki.WidgetApiResponseError=me,me.prototype.name=me.name;var we=function(j){_(N,j);var Q=O(N);function N(){var D,x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,A=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(M(this,N),D=Q.call(this),D.clientOrigin=A,T(F(D),"transport",void 0),T(F(D),"capabilitiesFinished",!1),T(F(D),"supportsMSC2974Renegotiate",!1),T(F(D),"requestedCapabilities",[]),T(F(D),"approvedCapabilities",void 0),T(F(D),"cachedClientVersions",void 0),T(F(D),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return D.transport=new i.PostmessageTransport(t.WidgetApiDirection.FromWidget,x,window.parent,window),D.transport.targetOrigin=A,D.transport.on("message",D.handleMessage.bind(F(D))),D}return o(N,"WidgetApi"),S(N,[{key:"hasCapability",value:o(function(x){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(x):this.requestedCapabilities.includes(x)},"hasCapability")},{key:"requestCapability",value:o(function(x){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(x)},"requestCapability")},{key:"requestCapabilities",value:o(function(x){var A=this;x.forEach(function(P){return A.requestCapability(P)})},"requestCapabilities")},{key:"requestCapabilityForRoomTimeline",value:o(function(x){this.requestCapability("org.matrix.msc2762.timeline:".concat(x))},"requestCapabilityForRoomTimeline")},{key:"requestCapabilityToSendState",value:o(function(x,A){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Send,x,A).raw)},"requestCapabilityToSendState")},{key:"requestCapabilityToReceiveState",value:o(function(x,A){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Receive,x,A).raw)},"requestCapabilityToReceiveState")},{key:"requestCapabilityToSendToDevice",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Send,x).raw)},"requestCapabilityToSendToDevice")},{key:"requestCapabilityToReceiveToDevice",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Receive,x).raw)},"requestCapabilityToReceiveToDevice")},{key:"requestCapabilityToSendEvent",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Send,x).raw)},"requestCapabilityToSendEvent")},{key:"requestCapabilityToReceiveEvent",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Receive,x).raw)},"requestCapabilityToReceiveEvent")},{key:"requestCapabilityToSendMessage",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Send,x).raw)},"requestCapabilityToSendMessage")},{key:"requestCapabilityToReceiveMessage",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Receive,x).raw)},"requestCapabilityToReceiveMessage")},{key:"requestCapabilityToReceiveRoomAccountData",value:o(function(x){this.requestCapability(d.WidgetEventCapability.forRoomAccountData(d.EventDirection.Receive,x).raw)},"requestCapabilityToReceiveRoomAccountData")},{key:"requestOpenIDConnectToken",value:o(function(){var x=this;return new Promise(function(A,P){x.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(L){var k=L.response;if(k.state===s.OpenIDRequestState.Allowed)A(k);else if(k.state===s.OpenIDRequestState.Blocked)P(new Error("User declined to verify their identity"));else if(k.state===s.OpenIDRequestState.PendingUserConfirmation){var $=o(function U(K){K.preventDefault();var X=K.detail;X.data.original_request_id===L.requestId&&(X.data.state===s.OpenIDRequestState.Allowed?(A(X.data),x.transport.reply(X,{})):X.data.state===s.OpenIDRequestState.Blocked?(P(new Error("User declined to verify their identity")),x.transport.reply(X,{})):(P(new Error("Invalid state on reply: "+k.state)),x.transport.reply(X,{error:{message:"Invalid state"}})),x.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),U))},"handlerFn");x.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),$)}else P(new Error("Invalid state: "+k.state))}).catch(P)})},"requestOpenIDConnectToken")},{key:"updateRequestedCapabilities",value:o(function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()},"updateRequestedCapabilities")},{key:"sendContentLoaded",value:o(function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()},"sendContentLoaded")},{key:"sendSticker",value:o(function(x){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,x).then()},"sendSticker")},{key:"setAlwaysOnScreen",value:o(function(x){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:x}).then(function(A){return A.success})},"setAlwaysOnScreen")},{key:"openModalWidget",value:o(function(x,A){var P=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],L=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},k=arguments.length>4&&arguments[4]!==void 0?arguments[4]:l.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:k,url:x,name:A,buttons:P,data:L}).then()},"openModalWidget")},{key:"closeModalWidget",value:o(function(){var x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,x).then()},"closeModalWidget")},{key:"sendRoomEvent",value:o(function(x,A,P,L,k){return this.sendEvent(x,void 0,A,P,L,k)},"sendRoomEvent")},{key:"sendStateEvent",value:o(function(x,A,P,L,k,$){return this.sendEvent(x,A,P,L,k,$)},"sendStateEvent")},{key:"sendEvent",value:o(function(x,A,P,L,k,$){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,m(m(m(m({type:x,content:P},A!==void 0&&{state_key:A}),L!==void 0&&{room_id:L}),k!==void 0&&{delay:k}),$!==void 0&&{parent_delay_id:$}))},"sendEvent")},{key:"updateDelayedEvent",value:o(function(x,A){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:x,action:A})},"updateDelayedEvent")},{key:"sendToDevice",value:o(function(x,A,P){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:x,encrypted:A,messages:P})},"sendToDevice")},{key:"readRoomAccountData",value:o(function(x,A){var P={type:x};return A&&(A.includes(c.Symbols.AnyRoom)?P.room_ids=c.Symbols.AnyRoom:P.room_ids=A),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,P).then(function(L){return L.events})},"readRoomAccountData")},{key:"readRoomEvents",value:o(function(x,A,P,L,k){var $={type:x,msgtype:P};return A!==void 0&&($.limit=A),L&&(L.includes(c.Symbols.AnyRoom)?$.room_ids=c.Symbols.AnyRoom:$.room_ids=L),k&&($.since=k),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,$).then(function(U){return U.events})},"readRoomEvents")},{key:"readEventRelations",value:function(){var D=g(h().mark(o(function A(P,L,k,$,U,K,X,pe){var ae,je;return h().wrap(o(function(fe){for(;;)switch(fe.prev=fe.next){case 0:return fe.next=2,this.getClientVersions();case 2:if(ae=fe.sent,ae.includes(n.UnstableApiVersion.MSC3869)){fe.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return je={event_id:P,rel_type:k,event_type:$,room_id:L,to:X,from:K,limit:U,direction:pe},fe.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,je));case 7:case"end":return fe.stop()}},"_callee$"),A,this)},"_callee")));function x(A,P,L,k,$,U,K,X){return D.apply(this,arguments)}return o(x,"readEventRelations"),x}()},{key:"readStateEvents",value:o(function(x,A,P,L){var k={type:x,state_key:P===void 0?!0:P};return A!==void 0&&(k.limit=A),L&&(L.includes(c.Symbols.AnyRoom)?k.room_ids=c.Symbols.AnyRoom:k.room_ids=L),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,k).then(function($){return $.events})},"readStateEvents")},{key:"setModalButtonEnabled",value:o(function(x,A){if(x===u.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:x,enabled:A}).then()},"setModalButtonEnabled")},{key:"navigateTo",value:o(function(x){if(!x||!x.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:x}).then()},"navigateTo")},{key:"getTurnServers",value:o(function(){var x=this;return re(h().mark(o(function A(){var P,L;return h().wrap(o(function($){for(;;)switch($.prev=$.next){case 0:if(L=function(){var U=g(h().mark(o(function K(X){return h().wrap(o(function(ae){for(;;)switch(ae.prev=ae.next){case 0:return X.preventDefault(),P(X.detail.data),ae.next=4,x.transport.reply(X.detail,{});case 4:case"end":return ae.stop()}},"_callee2$"),K)},"_callee2")));return o(function(X){return U.apply(this,arguments)},"onUpdateTurnServers")}(),x.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),L),x.turnServerWatchers!==0){$.next=12;break}return $.prev=3,$.next=6,$e(x.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:$.next=12;break;case 8:throw $.prev=8,$.t0=$.catch(3),x.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),L),$.t0;case 12:x.turnServerWatchers++,$.prev=13;case 14:return $.next=17,$e(new Promise(function(U){return P=U}));case 17:return $.next=19,$.sent;case 19:$.next=14;break;case 21:if($.prev=21,x.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),L),x.turnServerWatchers--,x.turnServerWatchers!==0){$.next=27;break}return $.next=27,$e(x.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return $.finish(21);case 28:case"end":return $.stop()}},"_callee3$"),A,null,[[3,8],[13,,21,28]])},"_callee3")))()},"getTurnServers")},{key:"searchUserDirectory",value:function(){var D=g(h().mark(o(function A(P,L){var k,$;return h().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:return K.next=2,this.getClientVersions();case 2:if(k=K.sent,k.includes(n.UnstableApiVersion.MSC3973)){K.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return $={search_term:P,limit:L},K.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,$));case 7:case"end":return K.stop()}},"_callee4$"),A,this)},"_callee4")));function x(A,P){return D.apply(this,arguments)}return o(x,"searchUserDirectory"),x}()},{key:"getMediaConfig",value:function(){var D=g(h().mark(o(function A(){var P,L;return h().wrap(o(function($){for(;;)switch($.prev=$.next){case 0:return $.next=2,this.getClientVersions();case 2:if(P=$.sent,P.includes(n.UnstableApiVersion.MSC4039)){$.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return L={},$.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,L));case 7:case"end":return $.stop()}},"_callee5$"),A,this)},"_callee5")));function x(){return D.apply(this,arguments)}return o(x,"getMediaConfig"),x}()},{key:"uploadFile",value:function(){var D=g(h().mark(o(function A(P){var L,k;return h().wrap(o(function(U){for(;;)switch(U.prev=U.next){case 0:return U.next=2,this.getClientVersions();case 2:if(L=U.sent,L.includes(n.UnstableApiVersion.MSC4039)){U.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return k={file:P},U.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,k));case 7:case"end":return U.stop()}},"_callee6$"),A,this)},"_callee6")));function x(A){return D.apply(this,arguments)}return o(x,"uploadFile"),x}()},{key:"downloadFile",value:function(){var D=g(h().mark(o(function A(P){var L,k;return h().wrap(o(function(U){for(;;)switch(U.prev=U.next){case 0:return U.next=2,this.getClientVersions();case 2:if(L=U.sent,L.includes(n.UnstableApiVersion.MSC4039)){U.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return k={content_uri:P},U.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,k));case 7:case"end":return U.stop()}},"_callee7$"),A,this)},"_callee7")));function x(A){return D.apply(this,arguments)}return o(x,"downloadFile"),x}()},{key:"start",value:o(function(){var x=this;this.transport.start(),this.getClientVersions().then(function(A){A.includes(n.UnstableApiVersion.MSC2974)&&(x.supportsMSC2974Renegotiate=!0)})},"start")},{key:"handleMessage",value:o(function(x){var A=new CustomEvent("action:".concat(x.detail.action),{detail:x.detail,cancelable:!0});if(this.emit("action:".concat(x.detail.action),A),!A.defaultPrevented)switch(x.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(x.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(x.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(x.detail,{});case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(x.detail,{});default:return this.transport.reply(x.detail,{error:{message:"Unknown or unsupported action: "+x.detail.action}})}},"handleMessage")},{key:"replyVersions",value:o(function(x){this.transport.reply(x,{supported_versions:n.CurrentApiVersions})},"replyVersions")},{key:"getClientVersions",value:o(function(){var x=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(A){return x.cachedClientVersions=A.supported_versions,A.supported_versions}).catch(function(A){return console.warn("non-fatal error getting supported client versions: ",A),[]})},"getClientVersions")},{key:"handleCapabilities",value:o(function(x){var A=this;return this.capabilitiesFinished?this.transport.reply(x,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(P){return P.includes(n.UnstableApiVersion.MSC2871)?A.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(L){A.approvedCapabilities=L.detail.data.approved,A.emit("ready")}):A.emit("ready"),A.capabilitiesFinished=!0,A.transport.reply(x,{capabilities:A.requestedCapabilities})})},"handleCapabilities")}]),N}(e.EventEmitter);return Ki.WidgetApi=we,Ki}o(EL,"requireWidgetApi");var xo={},Dr={};Object.defineProperty(Dr,"__esModule",{value:!0});Dr.VideoConferenceCapabilities=Dr.StickerpickerCapabilities=Dr.MatrixCapabilities=void 0;Dr.getTimelineRoomIDFromCapability=RL;Dr.isTimelineCapability=wL;Dr.isTimelineCapabilityFor=TL;var my=function(r){return r.Screenshots="m.capability.screenshot",r.StickerSending="m.sticker",r.AlwaysOnScreen="m.always_on_screen",r.RequiresClient="io.element.requires_client",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC3846TurnServers="town.robin.msc3846.turn_servers",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039UploadFile="org.matrix.msc4039.upload_file",r.MSC4039DownloadFile="org.matrix.msc4039.download_file",r.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});Dr.MatrixCapabilities=my;var _L=[my.StickerSending];Dr.StickerpickerCapabilities=_L;var bL=[my.AlwaysOnScreen];Dr.VideoConferenceCapabilities=bL;function wL(r){return r==null?void 0:r.startsWith("org.matrix.msc2762.timeline:")}o(wL,"isTimelineCapability");function TL(r,e){return r==="org.matrix.msc2762.timeline:".concat(e)}o(TL,"isTimelineCapabilityFor");function RL(r){return r.substring(r.indexOf(":")+1)}o(RL,"getTimelineRoomIDFromCapability");var Su={};Object.defineProperty(Su,"__esModule",{value:!0});Su.SimpleObservable=void 0;function Yl(r){"@babel/helpers - typeof";return Yl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yl(r)}o(Yl,"_typeof$1");function IL(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=CL(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(IL,"_createForOfIteratorHelper");function CL(r,e){if(r){if(typeof r=="string")return M0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return M0(r,e)}}o(CL,"_unsupportedIterableToArray");function M0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(M0,"_arrayLikeToArray");function OL(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(OL,"_classCallCheck");function kL(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,QI(n.key),n)}}o(kL,"_defineProperties");function PL(r,e,t){return e&&kL(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(PL,"_createClass");function ML(r,e,t){return e=QI(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ML,"_defineProperty");function QI(r){var e=AL(r,"string");return Yl(e)==="symbol"?e:String(e)}o(QI,"_toPropertyKey");function AL(r,e){if(Yl(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Yl(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}o(AL,"_toPrimitive");var xL=function(){function r(e){OL(this,r),ML(this,"listeners",[]),e&&this.listeners.push(e)}return o(r,"SimpleObservable"),PL(r,[{key:"onUpdate",value:o(function(t){this.listeners.push(t)},"onUpdate")},{key:"update",value:o(function(t){var n=IL(this.listeners),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;a(t)}}catch(s){n.e(s)}finally{n.f()}},"update")},{key:"close",value:o(function(){this.listeners=[]},"close")}]),r}();Su.SimpleObservable=xL;var Eu={};Object.defineProperty(Eu,"__esModule",{value:!0});Eu.UpdateDelayedEventAction=void 0;var DL=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({});Eu.UpdateDelayedEventAction=DL;var A0;function NL(){if(A0)return xo;A0=1,Object.defineProperty(xo,"__esModule",{value:!0}),xo.ClientWidgetApi=void 0;var r=Th,e=py(),t=Ra,n=xi,i=Dr,a=yn,s=Sn,l=fo,u=Su,d=vo,c=Eu;function h(N){"@babel/helpers - typeof";return h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},h(N)}o(h,"_typeof");function v(N,D){var x=Object.keys(N);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(N);D&&(A=A.filter(function(P){return Object.getOwnPropertyDescriptor(N,P).enumerable})),x.push.apply(x,A)}return x}o(v,"ownKeys");function g(N){for(var D=1;D<arguments.length;D++){var x=arguments[D]!=null?arguments[D]:{};D%2?v(Object(x),!0).forEach(function(A){Y(N,A,x[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(N,Object.getOwnPropertyDescriptors(x)):v(Object(x)).forEach(function(A){Object.defineProperty(N,A,Object.getOwnPropertyDescriptor(x,A))})}return N}o(g,"_objectSpread");function p(N,D){var x=typeof Symbol<"u"&&N[Symbol.iterator]||N["@@iterator"];if(!x){if(Array.isArray(N)||(x=y(N))||D){x&&(N=x);var A=0,P=o(function(){},"F");return{s:P,n:o(function(){return A>=N.length?{done:!0}:{done:!1,value:N[A++]}},"n"),e:o(function(K){throw K},"e"),f:P}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var L=!0,k=!1,$;return{s:o(function(){x=x.call(N)},"s"),n:o(function(){var K=x.next();return L=K.done,K},"n"),e:o(function(K){k=!0,$=K},"e"),f:o(function(){try{!L&&x.return!=null&&x.return()}finally{if(k)throw $}},"f")}}o(p,"_createForOfIteratorHelper");function m(N){return w(N)||S(N)||y(N)||T()}o(m,"_toConsumableArray");function T(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}o(T,"_nonIterableSpread");function y(N,D){if(N){if(typeof N=="string")return C(N,D);var x=Object.prototype.toString.call(N).slice(8,-1);if(x==="Object"&&N.constructor&&(x=N.constructor.name),x==="Map"||x==="Set")return Array.from(N);if(x==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(x))return C(N,D)}}o(y,"_unsupportedIterableToArray");function S(N){if(typeof Symbol<"u"&&N[Symbol.iterator]!=null||N["@@iterator"]!=null)return Array.from(N)}o(S,"_iterableToArray");function w(N){if(Array.isArray(N))return C(N)}o(w,"_arrayWithoutHoles");function C(N,D){(D==null||D>N.length)&&(D=N.length);for(var x=0,A=new Array(D);x<D;x++)A[x]=N[x];return A}o(C,"_arrayLikeToArray");function M(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */M=o(function(){return N},"_regeneratorRuntime");var N={},D=Object.prototype,x=D.hasOwnProperty,A=Object.defineProperty||function(q,H,J){q[H]=J.value},P=typeof Symbol=="function"?Symbol:{},L=P.iterator||"@@iterator",k=P.asyncIterator||"@@asyncIterator",$=P.toStringTag||"@@toStringTag";function U(q,H,J){return Object.defineProperty(q,H,{value:J,enumerable:!0,configurable:!0,writable:!0}),q[H]}o(U,"define");try{U({},"")}catch{U=o(function(J,ee,ge){return J[ee]=ge},"define")}function K(q,H,J,ee){var ge=H&&H.prototype instanceof ae?H:ae,ye=Object.create(ge.prototype),Ae=new Ca(ee||[]);return A(ye,"_invoke",{value:po(q,J,Ae)}),ye}o(K,"wrap");function X(q,H,J){try{return{type:"normal",arg:q.call(H,J)}}catch(ee){return{type:"throw",arg:ee}}}o(X,"tryCatch"),N.wrap=K;var pe={};function ae(){}o(ae,"Generator");function je(){}o(je,"GeneratorFunction");function be(){}o(be,"GeneratorFunctionPrototype");var fe={};U(fe,L,function(){return this});var Ye=Object.getPrototypeOf,Ot=Ye&&Ye(Ye(oe([])));Ot&&Ot!==D&&x.call(Ot,L)&&(fe=Ot);var kt=be.prototype=ae.prototype=Object.create(fe);function ce(q){["next","throw","return"].forEach(function(H){U(q,H,function(J){return this._invoke(H,J)})})}o(ce,"defineIteratorMethods");function ct(q,H){function J(ge,ye,Ae,et){var tt=X(q[ge],q,ye);if(tt.type!=="throw"){var Ht=tt.arg,Qn=Ht.value;return Qn&&h(Qn)=="object"&&x.call(Qn,"__await")?H.resolve(Qn.__await).then(function(Bi){J("next",Bi,Ae,et)},function(Bi){J("throw",Bi,Ae,et)}):H.resolve(Qn).then(function(Bi){Ht.value=Bi,Ae(Ht)},function(Bi){return J("throw",Bi,Ae,et)})}et(tt.arg)}o(J,"invoke");var ee;A(this,"_invoke",{value:o(function(ye,Ae){function et(){return new H(function(tt,Ht){J(ye,Ae,tt,Ht)})}return o(et,"callInvokeWithMethodAndArg"),ee=ee?ee.then(et,et):et()},"value")})}o(ct,"AsyncIterator");function po(q,H,J){var ee="suspendedStart";return function(ge,ye){if(ee==="executing")throw new Error("Generator is already running");if(ee==="completed"){if(ge==="throw")throw ye;return Z()}for(J.method=ge,J.arg=ye;;){var Ae=J.delegate;if(Ae){var et=Ia(Ae,J);if(et){if(et===pe)continue;return et}}if(J.method==="next")J.sent=J._sent=J.arg;else if(J.method==="throw"){if(ee==="suspendedStart")throw ee="completed",J.arg;J.dispatchException(J.arg)}else J.method==="return"&&J.abrupt("return",J.arg);ee="executing";var tt=X(q,H,J);if(tt.type==="normal"){if(ee=J.done?"completed":"suspendedYield",tt.arg===pe)continue;return{value:tt.arg,done:J.done}}tt.type==="throw"&&(ee="completed",J.method="throw",J.arg=tt.arg)}}}o(po,"makeInvokeMethod");function Ia(q,H){var J=H.method,ee=q.iterator[J];if(ee===void 0)return H.delegate=null,J==="throw"&&q.iterator.return&&(H.method="return",H.arg=void 0,Ia(q,H),H.method==="throw")||J!=="return"&&(H.method="throw",H.arg=new TypeError("The iterator does not provide a '"+J+"' method")),pe;var ge=X(ee,q.iterator,H.arg);if(ge.type==="throw")return H.method="throw",H.arg=ge.arg,H.delegate=null,pe;var ye=ge.arg;return ye?ye.done?(H[q.resultName]=ye.value,H.next=q.nextLoc,H.method!=="return"&&(H.method="next",H.arg=void 0),H.delegate=null,pe):ye:(H.method="throw",H.arg=new TypeError("iterator result is not an object"),H.delegate=null,pe)}o(Ia,"maybeInvokeDelegate");function mo(q){var H={tryLoc:q[0]};1 in q&&(H.catchLoc=q[1]),2 in q&&(H.finallyLoc=q[2],H.afterLoc=q[3]),this.tryEntries.push(H)}o(mo,"pushTryEntry");function Fi(q){var H=q.completion||{};H.type="normal",delete H.arg,q.completion=H}o(Fi,"resetTryEntry");function Ca(q){this.tryEntries=[{tryLoc:"root"}],q.forEach(mo,this),this.reset(!0)}o(Ca,"Context");function oe(q){if(q){var H=q[L];if(H)return H.call(q);if(typeof q.next=="function")return q;if(!isNaN(q.length)){var J=-1,ee=o(function ge(){for(;++J<q.length;)if(x.call(q,J))return ge.value=q[J],ge.done=!1,ge;return ge.value=void 0,ge.done=!0,ge},"next");return ee.next=ee}}return{next:Z}}o(oe,"values");function Z(){return{value:void 0,done:!0}}return o(Z,"doneResult"),je.prototype=be,A(kt,"constructor",{value:be,configurable:!0}),A(be,"constructor",{value:je,configurable:!0}),je.displayName=U(be,$,"GeneratorFunction"),N.isGeneratorFunction=function(q){var H=typeof q=="function"&&q.constructor;return!!H&&(H===je||(H.displayName||H.name)==="GeneratorFunction")},N.mark=function(q){return Object.setPrototypeOf?Object.setPrototypeOf(q,be):(q.__proto__=be,U(q,$,"GeneratorFunction")),q.prototype=Object.create(kt),q},N.awrap=function(q){return{__await:q}},ce(ct.prototype),U(ct.prototype,k,function(){return this}),N.AsyncIterator=ct,N.async=function(q,H,J,ee,ge){ge===void 0&&(ge=Promise);var ye=new ct(K(q,H,J,ee),ge);return N.isGeneratorFunction(H)?ye:ye.next().then(function(Ae){return Ae.done?Ae.value:ye.next()})},ce(kt),U(kt,$,"Generator"),U(kt,L,function(){return this}),U(kt,"toString",function(){return"[object Generator]"}),N.keys=function(q){var H=Object(q),J=[];for(var ee in H)J.push(ee);return J.reverse(),o(function ge(){for(;J.length;){var ye=J.pop();if(ye in H)return ge.value=ye,ge.done=!1,ge}return ge.done=!0,ge},"next")},N.values=oe,Ca.prototype={constructor:Ca,reset:o(function(H){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Fi),!H)for(var J in this)J.charAt(0)==="t"&&x.call(this,J)&&!isNaN(+J.slice(1))&&(this[J]=void 0)},"reset"),stop:o(function(){this.done=!0;var H=this.tryEntries[0].completion;if(H.type==="throw")throw H.arg;return this.rval},"stop"),dispatchException:o(function(H){if(this.done)throw H;var J=this;function ee(Ht,Qn){return Ae.type="throw",Ae.arg=H,J.next=Ht,Qn&&(J.method="next",J.arg=void 0),!!Qn}o(ee,"handle");for(var ge=this.tryEntries.length-1;ge>=0;--ge){var ye=this.tryEntries[ge],Ae=ye.completion;if(ye.tryLoc==="root")return ee("end");if(ye.tryLoc<=this.prev){var et=x.call(ye,"catchLoc"),tt=x.call(ye,"finallyLoc");if(et&&tt){if(this.prev<ye.catchLoc)return ee(ye.catchLoc,!0);if(this.prev<ye.finallyLoc)return ee(ye.finallyLoc)}else if(et){if(this.prev<ye.catchLoc)return ee(ye.catchLoc,!0)}else{if(!tt)throw new Error("try statement without catch or finally");if(this.prev<ye.finallyLoc)return ee(ye.finallyLoc)}}}},"dispatchException"),abrupt:o(function(H,J){for(var ee=this.tryEntries.length-1;ee>=0;--ee){var ge=this.tryEntries[ee];if(ge.tryLoc<=this.prev&&x.call(ge,"finallyLoc")&&this.prev<ge.finallyLoc){var ye=ge;break}}ye&&(H==="break"||H==="continue")&&ye.tryLoc<=J&&J<=ye.finallyLoc&&(ye=null);var Ae=ye?ye.completion:{};return Ae.type=H,Ae.arg=J,ye?(this.method="next",this.next=ye.finallyLoc,pe):this.complete(Ae)},"abrupt"),complete:o(function(H,J){if(H.type==="throw")throw H.arg;return H.type==="break"||H.type==="continue"?this.next=H.arg:H.type==="return"?(this.rval=this.arg=H.arg,this.method="return",this.next="end"):H.type==="normal"&&J&&(this.next=J),pe},"complete"),finish:o(function(H){for(var J=this.tryEntries.length-1;J>=0;--J){var ee=this.tryEntries[J];if(ee.finallyLoc===H)return this.complete(ee.completion,ee.afterLoc),Fi(ee),pe}},"finish"),catch:o(function(H){for(var J=this.tryEntries.length-1;J>=0;--J){var ee=this.tryEntries[J];if(ee.tryLoc===H){var ge=ee.completion;if(ge.type==="throw"){var ye=ge.arg;Fi(ee)}return ye}}throw new Error("illegal catch attempt")},"_catch"),delegateYield:o(function(H,J,ee){return this.delegate={iterator:oe(H),resultName:J,nextLoc:ee},this.method==="next"&&(this.arg=void 0),pe},"delegateYield")},N}o(M,"_regeneratorRuntime");function _(N,D,x,A,P,L,k){try{var $=N[L](k),U=$.value}catch(K){x(K);return}$.done?D(U):Promise.resolve(U).then(A,P)}o(_,"asyncGeneratorStep");function O(N){return function(){var D=this,x=arguments;return new Promise(function(A,P){var L=N.apply(D,x);function k(U){_(L,A,P,k,$,"next",U)}o(k,"_next");function $(U){_(L,A,P,k,$,"throw",U)}o($,"_throw"),k(void 0)})}}o(O,"_asyncToGenerator");function b(N,D){if(!(N instanceof D))throw new TypeError("Cannot call a class as a function")}o(b,"_classCallCheck");function F(N,D){for(var x=0;x<D.length;x++){var A=D[x];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(N,le(A.key),A)}}o(F,"_defineProperties");function V(N,D,x){return D&&F(N.prototype,D),Object.defineProperty(N,"prototype",{writable:!1}),N}o(V,"_createClass");function z(N,D){if(typeof D!="function"&&D!==null)throw new TypeError("Super expression must either be null or a function");N.prototype=Object.create(D&&D.prototype,{constructor:{value:N,writable:!0,configurable:!0}}),Object.defineProperty(N,"prototype",{writable:!1}),D&&ie(N,D)}o(z,"_inherits");function ie(N,D){return ie=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(A,P){return A.__proto__=P,A},"_setPrototypeOf"),ie(N,D)}o(ie,"_setPrototypeOf");function se(N){var D=$e();return o(function(){var A=re(N),P;if(D){var L=re(this).constructor;P=Reflect.construct(A,arguments,L)}else P=A.apply(this,arguments);return Pe(this,P)},"_createSuperInternal")}o(se,"_createSuper");function Pe(N,D){if(D&&(h(D)==="object"||typeof D=="function"))return D;if(D!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ce(N)}o(Pe,"_possibleConstructorReturn");function Ce(N){if(N===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return N}o(Ce,"_assertThisInitialized");function $e(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o($e,"_isNativeReflectConstruct");function re(N){return re=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(x){return x.__proto__||Object.getPrototypeOf(x)},"_getPrototypeOf"),re(N)}o(re,"_getPrototypeOf");function Y(N,D,x){return D=le(D),D in N?Object.defineProperty(N,D,{value:x,enumerable:!0,configurable:!0,writable:!0}):N[D]=x,N}o(Y,"_defineProperty");function le(N){var D=me(N,"string");return h(D)==="symbol"?D:String(D)}o(le,"_toPropertyKey");function me(N,D){if(h(N)!=="object"||N===null)return N;var x=N[Symbol.toPrimitive];if(x!==void 0){var A=x.call(N,D);if(h(A)!=="object")return A;throw new TypeError("@@toPrimitive must return a primitive value.")}return(D==="string"?String:Number)(N)}o(me,"_toPrimitive");function we(N){var D,x,A,P=2;for(typeof Symbol<"u"&&(x=Symbol.asyncIterator,A=Symbol.iterator);P--;){if(x&&(D=N[x])!=null)return D.call(N);if(A&&(D=N[A])!=null)return new j(D.call(N));x="@@asyncIterator",A="@@iterator"}throw new TypeError("Object is not async iterable")}o(we,"_asyncIterator");function j(N){function D(x){if(Object(x)!==x)return Promise.reject(new TypeError(x+" is not an object."));var A=x.done;return Promise.resolve(x.value).then(function(P){return{value:P,done:A}})}return o(D,"AsyncFromSyncIteratorContinuation"),j=o(function(A){this.s=A,this.n=A.next},"AsyncFromSyncIterator"),j.prototype={s:null,n:null,next:o(function(){return D(this.n.apply(this.s,arguments))},"next"),return:o(function(A){var P=this.s.return;return P===void 0?Promise.resolve({value:A,done:!0}):D(P.apply(this.s,arguments))},"_return"),throw:o(function(A){var P=this.s.return;return P===void 0?Promise.reject(A):D(P.apply(this.s,arguments))},"_throw")},new j(N)}o(j,"AsyncFromSyncIterator");var Q=function(N){z(x,N);var D=se(x);function x(A,P,L){var k;if(b(this,x),k=D.call(this),k.widget=A,k.iframe=P,k.driver=L,Y(Ce(k),"transport",void 0),Y(Ce(k),"cachedWidgetVersions",null),Y(Ce(k),"contentLoadedActionSent",!1),Y(Ce(k),"allowedCapabilities",new Set),Y(Ce(k),"allowedEvents",[]),Y(Ce(k),"isStopped",!1),Y(Ce(k),"turnServers",null),Y(Ce(k),"contentLoadedWaitTimer",void 0),Y(Ce(k),"pushRoomStateTasks",new Set),Y(Ce(k),"pushRoomStateResult",new Map),Y(Ce(k),"flushRoomStateTask",null),Y(Ce(k),"viewedRoomId",null),!(P!=null&&P.contentWindow))throw new Error("No iframe supplied");if(!A)throw new Error("Invalid widget");if(!L)throw new Error("Invalid driver");return k.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,A.id,P.contentWindow,window),k.transport.targetOrigin=A.origin,k.transport.on("message",k.handleMessage.bind(Ce(k))),P.addEventListener("load",k.onIframeLoad.bind(Ce(k))),k.transport.start(),k}return o(x,"ClientWidgetApi"),V(x,[{key:"hasCapability",value:o(function(P){return this.allowedCapabilities.has(P)},"hasCapability")},{key:"canUseRoomTimeline",value:o(function(P){return this.hasCapability("org.matrix.msc2762.timeline:".concat(d.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(P))},"canUseRoomTimeline")},{key:"canSendRoomEvent",value:o(function(P){var L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(k){return k.matchesAsRoomEvent(s.EventDirection.Send,P,L)})},"canSendRoomEvent")},{key:"canSendStateEvent",value:o(function(P,L){return this.allowedEvents.some(function(k){return k.matchesAsStateEvent(s.EventDirection.Send,P,L)})},"canSendStateEvent")},{key:"canSendToDeviceEvent",value:o(function(P){return this.allowedEvents.some(function(L){return L.matchesAsToDeviceEvent(s.EventDirection.Send,P)})},"canSendToDeviceEvent")},{key:"canReceiveRoomEvent",value:o(function(P){var L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(k){return k.matchesAsRoomEvent(s.EventDirection.Receive,P,L)})},"canReceiveRoomEvent")},{key:"canReceiveStateEvent",value:o(function(P,L){return this.allowedEvents.some(function(k){return k.matchesAsStateEvent(s.EventDirection.Receive,P,L)})},"canReceiveStateEvent")},{key:"canReceiveToDeviceEvent",value:o(function(P){return this.allowedEvents.some(function(L){return L.matchesAsToDeviceEvent(s.EventDirection.Receive,P)})},"canReceiveToDeviceEvent")},{key:"canReceiveRoomAccountData",value:o(function(P){return this.allowedEvents.some(function(L){return L.matchesAsRoomAccountData(s.EventDirection.Receive,P)})},"canReceiveRoomAccountData")},{key:"stop",value:o(function(){this.isStopped=!0,this.transport.stop()},"stop")},{key:"getWidgetVersions",value:function(){var A=O(M().mark(o(function L(){var k;return M().wrap(o(function(U){for(;;)switch(U.prev=U.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){U.next=2;break}return U.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return U.prev=2,U.next=5,this.transport.send(n.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return k=U.sent,this.cachedWidgetVersions=k.supported_versions,U.abrupt("return",k.supported_versions);case 10:return U.prev=10,U.t0=U.catch(2),console.warn("non-fatal error getting supported widget versions: ",U.t0),U.abrupt("return",[]);case 14:case"end":return U.stop()}},"_callee$"),L,this,[[2,10]])},"_callee")));function P(){return A.apply(this,arguments)}return o(P,"getWidgetVersions"),P}()},{key:"beginCapabilities",value:o(function(){var P=this;this.emit("preparing");var L;this.transport.send(n.WidgetApiToWidgetAction.Capabilities,{}).then(function(k){return L=k.capabilities,P.driver.validateCapabilities(new Set(k.capabilities))}).then(function(k){P.allowCapabilities(m(k),L),P.emit("ready")}).catch(function(k){P.emit("error:preparing",k)})},"beginCapabilities")},{key:"allowCapabilities",value:o(function(P,L){var k,$=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),P);var U=p(P),K;try{for(U.s();!(K=U.n()).done;){var X=K.value;this.allowedCapabilities.add(X)}}catch(ce){U.e(ce)}finally{U.f()}var pe=s.WidgetEventCapability.findEventCapabilities(P);(k=this.allowedEvents).push.apply(k,m(pe)),this.transport.send(n.WidgetApiToWidgetAction.NotifyCapabilities,{requested:L,approved:Array.from(this.allowedCapabilities)}).catch(function(ce){console.warn("non-fatal error notifying widget of approved capabilities:",ce)}).then(function(){$.emit("capabilitiesNotified")});var ae=p(P),je;try{for(ae.s();!(je=ae.n()).done;){var be=je.value;if((0,i.isTimelineCapability)(be)){var fe=(0,i.getTimelineRoomIDFromCapability)(be);if(fe===d.Symbols.AnyRoom){var Ye=p(this.driver.getKnownRooms()),Ot;try{for(Ye.s();!(Ot=Ye.n()).done;){var kt=Ot.value;this.pushRoomState(kt)}}catch(ce){Ye.e(ce)}finally{Ye.f()}}else this.pushRoomState(fe)}}}catch(ce){ae.e(ce)}finally{ae.f()}pe.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)},"allowCapabilities")},{key:"onIframeLoad",value:o(function(P){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)},"onIframeLoad")},{key:"handleContentLoadedAction",value:o(function(P){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(P,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(P,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0},"handleContentLoadedAction")},{key:"replyVersions",value:o(function(P){this.transport.reply(P,{supported_versions:a.CurrentApiVersions})},"replyVersions")},{key:"supportsUpdateState",value:function(){var A=O(M().mark(o(function L(){return M().wrap(o(function($){for(;;)switch($.prev=$.next){case 0:return $.next=2,this.getWidgetVersions();case 2:return $.abrupt("return",$.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return $.stop()}},"_callee2$"),L,this)},"_callee2")));function P(){return A.apply(this,arguments)}return o(P,"supportsUpdateState"),P}()},{key:"handleCapabilitiesRenegotiate",value:o(function(P){var L,k=this;this.transport.reply(P,{});var $=((L=P.data)===null||L===void 0?void 0:L.capabilities)||[],U=new Set($.filter(function(K){return!k.hasCapability(K)}));U.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(U).then(function(K){return k.allowCapabilities(m(K),m(U))})},"handleCapabilitiesRenegotiate")},{key:"handleNavigate",value:o(function(P){var L,k,$=this;if(!this.hasCapability(i.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(P,{error:{message:"Missing capability"}});if(!((L=P.data)!==null&&L!==void 0&&L.uri)||!((k=P.data)!==null&&k!==void 0&&k.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(P,{error:{message:"Invalid matrix.to URI"}});var U=o(function(X){console.error("[ClientWidgetApi] Failed to handle navigation: ",X),$.handleDriverError(X,P,"Error handling navigation")},"onErr");try{this.driver.navigate(P.data.uri.toString()).catch(function(K){return U(K)}).then(function(){return $.transport.reply(P,{})})}catch(K){return U(K)}},"handleNavigate")},{key:"handleOIDC",value:o(function(P){var L=this,k=1,$=o(function(pe,ae){return ae=ae||{},k>1?L.transport.send(n.WidgetApiToWidgetAction.OpenIDCredentials,g({state:pe,original_request_id:P.requestId},ae)):L.transport.reply(P,g({state:pe},ae))},"replyState"),U=o(function(pe){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",pe),k>1?$(l.OpenIDRequestState.Blocked):L.transport.reply(P,{error:{message:pe}})},"replyError"),K=new u.SimpleObservable(function(X){if(X.state===l.OpenIDRequestState.PendingUserConfirmation&&k>1)return K.close(),U("client provided out-of-phase response to OIDC flow");if(X.state===l.OpenIDRequestState.PendingUserConfirmation){$(X.state),k++;return}return X.state===l.OpenIDRequestState.Allowed&&!X.token?U("client provided invalid OIDC token for an allowed request"):(X.state===l.OpenIDRequestState.Blocked&&(X.token=void 0),K.close(),$(X.state,X.token))});this.driver.askOpenID(K)},"handleOIDC")},{key:"handleReadRoomAccountData",value:o(function(P){var L=this,k=Promise.resolve([]);return k=this.driver.readRoomAccountData(P.data.type),this.canReceiveRoomAccountData(P.data.type)?k.then(function($){L.transport.reply(P,{events:$})}):this.transport.reply(P,{error:{message:"Cannot read room account data of this type"}})},"handleReadRoomAccountData")},{key:"handleReadEvents",value:function(){var A=O(M().mark(o(function L(k){var $=this,U,K,X,pe,ae,je,be,fe,Ye,Ot;return M().wrap(o(function(ce){for(;;)switch(ce.prev=ce.next){case 0:if(k.data.type){ce.next=2;break}return ce.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(k.data.limit!==void 0&&(!k.data.limit||k.data.limit<0))){ce.next=4;break}return ce.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 4:if(k.data.room_ids!==void 0){ce.next=8;break}U=this.viewedRoomId===null?[]:[this.viewedRoomId],ce.next=30;break;case 8:if(k.data.room_ids!==d.Symbols.AnyRoom){ce.next=12;break}U=this.driver.getKnownRooms().filter(function(ct){return $.canUseRoomTimeline(ct)}),ce.next=30;break;case 12:U=k.data.room_ids,K=p(U),ce.prev=14,K.s();case 16:if((X=K.n()).done){ce.next=22;break}if(pe=X.value,this.canUseRoomTimeline(pe)){ce.next=20;break}return ce.abrupt("return",this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(pe)}}));case 20:ce.next=16;break;case 22:ce.next=27;break;case 24:ce.prev=24,ce.t0=ce.catch(14),K.e(ce.t0);case 27:return ce.prev=27,K.f(),ce.finish(27);case 30:if(ae=k.data.limit||0,je=k.data.since,be=void 0,fe=void 0,k.data.state_key===void 0){ce.next=40;break}if(be=k.data.state_key===!0?void 0:k.data.state_key.toString(),this.canReceiveStateEvent(k.data.type,(Ye=be)!==null&&Ye!==void 0?Ye:null)){ce.next=38;break}return ce.abrupt("return",this.transport.reply(k,{error:{message:"Cannot read state events of this type"}}));case 38:ce.next=43;break;case 40:if(fe=k.data.msgtype,this.canReceiveRoomEvent(k.data.type,fe)){ce.next=43;break}return ce.abrupt("return",this.transport.reply(k,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(k.data.room_ids===void 0&&U.length===0)){ce.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),ce.next=47,k.data.state_key===void 0?this.driver.readRoomEvents(k.data.type,fe,ae,null,je):this.driver.readStateEvents(k.data.type,be,ae,null);case 47:Ot=ce.sent,ce.next=68;break;case 50:return ce.next=52,this.supportsUpdateState();case 52:if(!ce.sent){ce.next=58;break}return ce.next=55,Promise.all(U.map(function(ct){return $.driver.readRoomTimeline(ct,k.data.type,fe,be,ae,je)}));case 55:Ot=ce.sent.flat(1),ce.next=68;break;case 58:if(k.data.state_key!==void 0){ce.next=64;break}return ce.next=61,Promise.all(U.map(function(ct){return $.driver.readRoomTimeline(ct,k.data.type,fe,be,ae,je)}));case 61:ce.t1=ce.sent,ce.next=67;break;case 64:return ce.next=66,Promise.all(U.map(function(ct){return $.driver.readRoomState(ct,k.data.type,be)}));case 66:ce.t1=ce.sent;case 67:Ot=ce.t1.flat(1);case 68:this.transport.reply(k,{events:Ot});case 69:case"end":return ce.stop()}},"_callee3$"),L,this,[[14,24,27,30]])},"_callee3")));function P(L){return A.apply(this,arguments)}return o(P,"handleReadEvents"),P}()},{key:"handleSendEvent",value:o(function(P){var L=this;if(!P.data.type)return this.transport.reply(P,{error:{message:"Invalid request - missing event type"}});if(P.data.room_id&&!this.canUseRoomTimeline(P.data.room_id))return this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}});var k=P.data.delay!==void 0||P.data.parent_delay_id!==void 0;if(k&&!this.hasCapability(i.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(P,{error:{message:"Missing capability"}});var $;if(P.data.state_key!==void 0){if(!this.canSendStateEvent(P.data.type,P.data.state_key))return this.transport.reply(P,{error:{message:"Cannot send state events of this type"}});if(!k)$=this.driver.sendEvent(P.data.type,P.data.content||{},P.data.state_key,P.data.room_id);else{var U,K;$=this.driver.sendDelayedEvent((U=P.data.delay)!==null&&U!==void 0?U:null,(K=P.data.parent_delay_id)!==null&&K!==void 0?K:null,P.data.type,P.data.content||{},P.data.state_key,P.data.room_id)}}else{var X=P.data.content||{},pe=X.msgtype;if(!this.canSendRoomEvent(P.data.type,pe))return this.transport.reply(P,{error:{message:"Cannot send room events of this type"}});if(!k)$=this.driver.sendEvent(P.data.type,X,null,P.data.room_id);else{var ae,je;$=this.driver.sendDelayedEvent((ae=P.data.delay)!==null&&ae!==void 0?ae:null,(je=P.data.parent_delay_id)!==null&&je!==void 0?je:null,P.data.type,X,null,P.data.room_id)}}$.then(function(be){return L.transport.reply(P,g({room_id:be.roomId},"eventId"in be?{event_id:be.eventId}:{delay_id:be.delayId}))}).catch(function(be){console.error("error sending event: ",be),L.handleDriverError(be,P,"Error sending event")})},"handleSendEvent")},{key:"handleUpdateDelayedEvent",value:o(function(P){var L=this;if(!P.data.delay_id)return this.transport.reply(P,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(i.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(P,{error:{message:"Missing capability"}});switch(P.data.action){case c.UpdateDelayedEventAction.Cancel:case c.UpdateDelayedEventAction.Restart:case c.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(P.data.delay_id,P.data.action).then(function(){return L.transport.reply(P,{})}).catch(function(k){console.error("error updating delayed event: ",k),L.handleDriverError(k,P,"Error updating delayed event")});break;default:return this.transport.reply(P,{error:{message:"Invalid request - unsupported action"}})}},"handleUpdateDelayedEvent")},{key:"handleSendToDevice",value:function(){var A=O(M().mark(o(function L(k){return M().wrap(o(function(U){for(;;)switch(U.prev=U.next){case 0:if(k.data.type){U.next=5;break}return U.next=3,this.transport.reply(k,{error:{message:"Invalid request - missing event type"}});case 3:U.next=31;break;case 5:if(k.data.messages){U.next=10;break}return U.next=8,this.transport.reply(k,{error:{message:"Invalid request - missing event contents"}});case 8:U.next=31;break;case 10:if(typeof k.data.encrypted=="boolean"){U.next=15;break}return U.next=13,this.transport.reply(k,{error:{message:"Invalid request - missing encryption flag"}});case 13:U.next=31;break;case 15:if(this.canSendToDeviceEvent(k.data.type)){U.next=20;break}return U.next=18,this.transport.reply(k,{error:{message:"Cannot send to-device events of this type"}});case 18:U.next=31;break;case 20:return U.prev=20,U.next=23,this.driver.sendToDevice(k.data.type,k.data.encrypted,k.data.messages);case 23:return U.next=25,this.transport.reply(k,{});case 25:U.next=31;break;case 27:U.prev=27,U.t0=U.catch(20),console.error("error sending to-device event",U.t0),this.handleDriverError(U.t0,k,"Error sending event");case 31:case"end":return U.stop()}},"_callee4$"),L,this,[[20,27]])},"_callee4")));function P(L){return A.apply(this,arguments)}return o(P,"handleSendToDevice"),P}()},{key:"pollTurnServers",value:function(){var A=O(M().mark(o(function L(k,$){var U,K,X,pe,ae,je;return M().wrap(o(function(fe){for(;;)switch(fe.prev=fe.next){case 0:return fe.prev=0,fe.next=3,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,$);case 3:U=!1,K=!1,fe.prev=5,pe=we(k);case 7:return fe.next=9,pe.next();case 9:if(!(U=!(ae=fe.sent).done)){fe.next=16;break}return je=ae.value,fe.next=13,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,je);case 13:U=!1,fe.next=7;break;case 16:fe.next=22;break;case 18:fe.prev=18,fe.t0=fe.catch(5),K=!0,X=fe.t0;case 22:if(fe.prev=22,fe.prev=23,!(U&&pe.return!=null)){fe.next=27;break}return fe.next=27,pe.return();case 27:if(fe.prev=27,!K){fe.next=30;break}throw X;case 30:return fe.finish(27);case 31:return fe.finish(22);case 32:fe.next=37;break;case 34:fe.prev=34,fe.t1=fe.catch(0),console.error("error polling for TURN servers",fe.t1);case 37:case"end":return fe.stop()}},"_callee5$"),L,this,[[0,34],[5,18,22,32],[23,,27,31]])},"_callee5")));function P(L,k){return A.apply(this,arguments)}return o(P,"pollTurnServers"),P}()},{key:"handleWatchTurnServers",value:function(){var A=O(M().mark(o(function L(k){var $,U,K,X;return M().wrap(o(function(ae){for(;;)switch(ae.prev=ae.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){ae.next=5;break}return ae.next=3,this.transport.reply(k,{error:{message:"Missing capability"}});case 3:ae.next=30;break;case 5:if(!this.turnServers){ae.next=10;break}return ae.next=8,this.transport.reply(k,{});case 8:ae.next=30;break;case 10:return ae.prev=10,$=this.driver.getTurnServers(),ae.next=14,$.next();case 14:if(U=ae.sent,K=U.done,X=U.value,!K){ae.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return ae.next=21,this.transport.reply(k,{});case 21:this.pollTurnServers($,X),this.turnServers=$,ae.next=30;break;case 25:return ae.prev=25,ae.t0=ae.catch(10),console.error("error getting first TURN server results",ae.t0),ae.next=30,this.transport.reply(k,{error:{message:"TURN servers not available"}});case 30:case"end":return ae.stop()}},"_callee6$"),L,this,[[10,25]])},"_callee6")));function P(L){return A.apply(this,arguments)}return o(P,"handleWatchTurnServers"),P}()},{key:"handleUnwatchTurnServers",value:function(){var A=O(M().mark(o(function L(k){return M().wrap(o(function(U){for(;;)switch(U.prev=U.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){U.next=5;break}return U.next=3,this.transport.reply(k,{error:{message:"Missing capability"}});case 3:U.next=15;break;case 5:if(this.turnServers){U.next=10;break}return U.next=8,this.transport.reply(k,{});case 8:U.next=15;break;case 10:return U.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,U.next=15,this.transport.reply(k,{});case 15:case"end":return U.stop()}},"_callee7$"),L,this)},"_callee7")));function P(L){return A.apply(this,arguments)}return o(P,"handleUnwatchTurnServers"),P}()},{key:"handleReadRelations",value:function(){var A=O(M().mark(o(function L(k){var $=this,U,K;return M().wrap(o(function(pe){for(;;)switch(pe.prev=pe.next){case 0:if(k.data.event_id){pe.next=2;break}return pe.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(k.data.limit!==void 0&&k.data.limit<0)){pe.next=4;break}return pe.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(k.data.room_id!==void 0&&!this.canUseRoomTimeline(k.data.room_id))){pe.next=6;break}return pe.abrupt("return",this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(k.data.room_id)}}));case 6:return pe.prev=6,pe.next=9,this.driver.readEventRelations(k.data.event_id,k.data.room_id,k.data.rel_type,k.data.event_type,k.data.from,k.data.to,k.data.limit,k.data.direction);case 9:return U=pe.sent,K=U.chunk.filter(function(ae){return ae.state_key!==void 0?$.canReceiveStateEvent(ae.type,ae.state_key):$.canReceiveRoomEvent(ae.type,ae.content.msgtype)}),pe.abrupt("return",this.transport.reply(k,{chunk:K,prev_batch:U.prevBatch,next_batch:U.nextBatch}));case 14:pe.prev=14,pe.t0=pe.catch(6),console.error("error getting the relations",pe.t0),this.handleDriverError(pe.t0,k,"Unexpected error while reading relations");case 18:case"end":return pe.stop()}},"_callee8$"),L,this,[[6,14]])},"_callee8")));function P(L){return A.apply(this,arguments)}return o(P,"handleReadRelations"),P}()},{key:"handleUserDirectorySearch",value:function(){var A=O(M().mark(o(function L(k){var $;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3973UserDirectorySearch)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:if(typeof k.data.search_term=="string"){K.next=4;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(k.data.limit!==void 0&&k.data.limit<0)){K.next=6;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 6:return K.prev=6,K.next=9,this.driver.searchUserDirectory(k.data.search_term,k.data.limit);case 9:return $=K.sent,K.abrupt("return",this.transport.reply(k,{limited:$.limited,results:$.results.map(function(X){return{user_id:X.userId,display_name:X.displayName,avatar_url:X.avatarUrl}})}));case 13:K.prev=13,K.t0=K.catch(6),console.error("error searching in the user directory",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while searching in the user directory");case 17:case"end":return K.stop()}},"_callee9$"),L,this,[[6,13]])},"_callee9")));function P(L){return A.apply(this,arguments)}return o(P,"handleUserDirectorySearch"),P}()},{key:"handleGetMediaConfig",value:function(){var A=O(M().mark(o(function L(k){var $;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.getMediaConfig();case 5:return $=K.sent,K.abrupt("return",this.transport.reply(k,$));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while getting the media configuration",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while getting the media configuration");case 13:case"end":return K.stop()}},"_callee10$"),L,this,[[2,9]])},"_callee10")));function P(L){return A.apply(this,arguments)}return o(P,"handleGetMediaConfig"),P}()},{key:"handleUploadFile",value:function(){var A=O(M().mark(o(function L(k){var $;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.uploadFile(k.data.file);case 5:return $=K.sent,K.abrupt("return",this.transport.reply(k,{content_uri:$.contentUri}));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while uploading a file",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while uploading a file");case 13:case"end":return K.stop()}},"_callee11$"),L,this,[[2,9]])},"_callee11")));function P(L){return A.apply(this,arguments)}return o(P,"handleUploadFile"),P}()},{key:"handleDownloadFile",value:function(){var A=O(M().mark(o(function L(k){var $;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039DownloadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.downloadFile(k.data.content_uri);case 5:return $=K.sent,K.abrupt("return",this.transport.reply(k,{file:$.file}));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while downloading a file",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while downloading a file");case 13:case"end":return K.stop()}},"_callee12$"),L,this,[[2,9]])},"_callee12")));function P(L){return A.apply(this,arguments)}return o(P,"handleDownloadFile"),P}()},{key:"handleDriverError",value:o(function(P,L,k){var $=this.driver.processError(P);this.transport.reply(L,{error:g({message:k},$)})},"handleDriverError")},{key:"handleMessage",value:o(function(P){if(!this.isStopped){var L=new CustomEvent("action:".concat(P.detail.action),{detail:P.detail,cancelable:!0});if(this.emit("action:".concat(P.detail.action),L),!L.defaultPrevented)switch(P.detail.action){case n.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(P.detail);case n.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(P.detail);case n.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(P.detail);case n.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(P.detail);case n.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(P.detail);case n.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(P.detail);case n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(P.detail);case n.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(P.detail);case n.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(P.detail);case n.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(P.detail);case n.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(P.detail);case n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(P.detail);case n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(P.detail);case n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(P.detail);case n.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(P.detail);case n.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(P.detail);case n.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(P.detail);default:return this.transport.reply(P.detail,{error:{message:"Unknown or unsupported action: "+P.detail.action}})}}},"handleMessage")},{key:"updateTheme",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.ThemeChange,P)},"updateTheme")},{key:"updateLanguage",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.LanguageChange,{lang:P})},"updateLanguage")},{key:"takeScreenshot",value:o(function(){return this.transport.send(n.WidgetApiToWidgetAction.TakeScreenshot,{})},"takeScreenshot")},{key:"updateVisibility",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.UpdateVisibility,{visible:P})},"updateVisibility")},{key:"sendWidgetConfig",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.WidgetConfig,P).then()},"sendWidgetConfig")},{key:"notifyModalWidgetButtonClicked",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.ButtonClicked,{id:P}).then()},"notifyModalWidgetButtonClicked")},{key:"notifyModalWidgetClose",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.CloseModalWidget,P).then()},"notifyModalWidgetClose")},{key:"feedEvent",value:function(){var A=O(M().mark(o(function L(k,$){var U;return M().wrap(o(function(X){for(;;)switch(X.prev=X.next){case 0:if($!==void 0&&this.setViewedRoomId($),!(k.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(k.room_id))){X.next=3;break}return X.abrupt("return");case 3:if(!(k.state_key!==void 0&&k.state_key!==null)){X.next=8;break}if(this.canReceiveStateEvent(k.type,k.state_key)){X.next=6;break}return X.abrupt("return");case 6:X.next=10;break;case 8:if(this.canReceiveRoomEvent(k.type,(U=k.content)===null||U===void 0?void 0:U.msgtype)){X.next=10;break}return X.abrupt("return");case 10:return X.next=12,this.transport.send(n.WidgetApiToWidgetAction.SendEvent,k);case 12:case"end":return X.stop()}},"_callee13$"),L,this)},"_callee13")));function P(L,k){return A.apply(this,arguments)}return o(P,"feedEvent"),P}()},{key:"feedToDevice",value:function(){var A=O(M().mark(o(function L(k,$){return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(!this.canReceiveToDeviceEvent(k.type)){K.next=3;break}return K.next=3,this.transport.send(n.WidgetApiToWidgetAction.SendToDevice,g(g({},k),{},{encrypted:$}));case 3:case"end":return K.stop()}},"_callee14$"),L,this)},"_callee14")));function P(L,k){return A.apply(this,arguments)}return o(P,"feedToDevice"),P}()},{key:"setViewedRoomId",value:o(function(P){this.viewedRoomId=P,P!==null&&!this.canUseRoomTimeline(P)&&this.pushRoomState(P)},"setViewedRoomId")},{key:"flushRoomState",value:function(){var A=O(M().mark(o(function L(){var k,$,U,K,X,pe,ae;return M().wrap(o(function(be){for(;;)switch(be.prev=be.next){case 0:be.prev=0;case 1:return be.next=3,Promise.all(m(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){be.next=1;break}case 4:k=[],$=p(this.pushRoomStateResult.values());try{for($.s();!(U=$.n()).done;){K=U.value,X=p(K.values());try{for(X.s();!(pe=X.n()).done;)ae=pe.value,k.push.apply(k,m(ae.values()))}catch(fe){X.e(fe)}finally{X.f()}}}catch(fe){$.e(fe)}finally{$.f()}return be.next=9,this.getWidgetVersions();case 9:if(!be.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){be.next=12;break}return be.next=12,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:k});case 12:return be.prev=12,this.flushRoomStateTask=null,be.finish(12);case 15:case"end":return be.stop()}},"_callee15$"),L,this,[[0,,12,15]])},"_callee15")));function P(){return A.apply(this,arguments)}return o(P,"flushRoomState"),P}()},{key:"pushRoomState",value:o(function(P){var L=this,k=p(this.allowedEvents),$;try{var U=o(function(){var X=$.value;if(X.kind===s.EventKind.State&&X.direction===s.EventDirection.Receive){var pe,ae,je=L.driver.readRoomState(P,X.eventType,(pe=X.keyStr)!==null&&pe!==void 0?pe:void 0),be=je.then(function(fe){var Ye=p(fe),Ot;try{for(Ye.s();!(Ot=Ye.n()).done;){var kt=Ot.value,ce=L.pushRoomStateResult.get(P);ce===void 0&&(ce=new Map,L.pushRoomStateResult.set(P,ce));var ct=ce.get(X.eventType);ct===void 0&&(ct=new Map,ce.set(X.eventType,ct)),ct.has(kt.state_key)||ct.set(kt.state_key,kt)}}catch(po){Ye.e(po)}finally{Ye.f()}},function(fe){return console.error("Failed to read room state for ".concat(P," (").concat(X.eventType,", ").concat(X.keyStr,")"),fe)}).then(function(){L.pushRoomStateTasks.delete(be)});L.pushRoomStateTasks.add(be),(ae=L.flushRoomStateTask)!==null&&ae!==void 0||(L.flushRoomStateTask=L.flushRoomState()),L.flushRoomStateTask.catch(function(fe){return console.error("Failed to push room state",fe)})}},"_loop");for(k.s();!($=k.n()).done;)U()}catch(K){k.e(K)}finally{k.f()}},"pushRoomState")},{key:"feedStateUpdate",value:function(){var A=O(M().mark(o(function L(k){var $,U;return M().wrap(o(function(X){for(;;)switch(X.prev=X.next){case 0:if(k.state_key!==void 0){X.next=2;break}throw new Error("Not a state event");case 2:if(!((k.room_id===this.viewedRoomId||this.canUseRoomTimeline(k.room_id))&&this.canReceiveStateEvent(k.type,k.state_key))){X.next=21;break}if(this.pushRoomStateTasks.size!==0){X.next=11;break}return X.next=6,this.getWidgetVersions();case 6:if(!X.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){X.next=9;break}return X.next=9,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:[k]});case 9:X.next=21;break;case 11:$=this.pushRoomStateResult.get(k.room_id),$===void 0&&($=new Map,this.pushRoomStateResult.set(k.room_id,$)),U=$.get(k.type),U===void 0&&(U=new Map,$.set(k.type,U)),U.has(k.type)||U.set(k.state_key,k);case 16:return X.next=18,Promise.all(m(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){X.next=16;break}case 19:return X.next=21,this.flushRoomStateTask;case 21:case"end":return X.stop()}},"_callee16$"),L,this)},"_callee16")));function P(L){return A.apply(this,arguments)}return o(P,"feedStateUpdate"),P}()}]),x}(r.EventEmitter);return xo.ClientWidgetApi=Q,xo}o(NL,"requireClientWidgetApi");var gy={};Object.defineProperty(gy,"__esModule",{value:!0});gy.isErrorResponse=LL;function Dm(r){"@babel/helpers - typeof";return Dm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Dm(r)}o(Dm,"_typeof");function LL(r){var e=r.error;return Dm(e)==="object"&&e!==null&&"message"in e&&typeof e.message=="string"}o(LL,"isErrorResponse");var Nh={};Object.defineProperty(Nh,"__esModule",{value:!0});Nh.WidgetKind=void 0;var UL=function(r){return r.Room="room",r.Account="account",r.Modal="modal",r}({});Nh.WidgetKind=UL;var Lh={};Object.defineProperty(Lh,"__esModule",{value:!0});Lh.ModalButtonKind=void 0;var jL=function(r){return r.Primary="m.primary",r.Secondary="m.secondary",r.Warning="m.warning",r.Danger="m.danger",r.Link="m.link",r}({});Lh.ModalButtonKind=jL;var Uh={};Object.defineProperty(Uh,"__esModule",{value:!0});Uh.isValidUrl=FL;function FL(r){if(!r)return!1;try{var e=new URL(r);return!(e.protocol!=="http"&&e.protocol!=="https")}catch(t){if(t instanceof TypeError)return!1;throw t}}o(FL,"isValidUrl");var jh={};Object.defineProperty(jh,"__esModule",{value:!0});jh.assertPresent=BL;function BL(r,e){if(!r[e])throw new Error("".concat(String(e)," is required"))}o(BL,"assertPresent");var Do={},x0;function YI(){if(x0)return Do;x0=1,Object.defineProperty(Do,"__esModule",{value:!0}),Do.Widget=void 0;var r=jh,e=Bh();function t(d){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(c){return typeof c}:function(c){return c&&typeof Symbol=="function"&&c.constructor===Symbol&&c!==Symbol.prototype?"symbol":typeof c},t(d)}o(t,"_typeof");function n(d,c){if(!(d instanceof c))throw new TypeError("Cannot call a class as a function")}o(n,"_classCallCheck");function i(d,c){for(var h=0;h<c.length;h++){var v=c[h];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(d,s(v.key),v)}}o(i,"_defineProperties");function a(d,c,h){return c&&i(d.prototype,c),Object.defineProperty(d,"prototype",{writable:!1}),d}o(a,"_createClass");function s(d){var c=l(d,"string");return t(c)==="symbol"?c:String(c)}o(s,"_toPropertyKey");function l(d,c){if(t(d)!=="object"||d===null)return d;var h=d[Symbol.toPrimitive];if(h!==void 0){var v=h.call(d,c);if(t(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(d)}o(l,"_toPrimitive");var u=function(){function d(c){if(n(this,d),this.definition=c,!this.definition)throw new Error("Definition is required");(0,r.assertPresent)(c,"id"),(0,r.assertPresent)(c,"creatorUserId"),(0,r.assertPresent)(c,"type"),(0,r.assertPresent)(c,"url")}return o(d,"Widget"),a(d,[{key:"creatorUserId",get:o(function(){return this.definition.creatorUserId},"get")},{key:"type",get:o(function(){return this.definition.type},"get")},{key:"id",get:o(function(){return this.definition.id},"get")},{key:"name",get:o(function(){return this.definition.name||null},"get")},{key:"title",get:o(function(){return this.rawData.title||null},"get")},{key:"templateUrl",get:o(function(){return this.definition.url},"get")},{key:"origin",get:o(function(){return new URL(this.templateUrl).origin},"get")},{key:"waitForIframeLoad",get:o(function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)},"get")},{key:"rawData",get:o(function(){return this.definition.data||{}},"get")},{key:"getCompleteUrl",value:o(function(h){return(0,e.runTemplate)(this.templateUrl,this.definition,h)},"getCompleteUrl")}]),d}();return Do.Widget=u,Do}o(YI,"requireWidget");var No={},D0;function $L(){if(D0)return No;D0=1,Object.defineProperty(No,"__esModule",{value:!0}),No.WidgetParser=void 0;var r=YI(),e=Uh;function t(v){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},t(v)}o(t,"_typeof");function n(v,g){var p=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!p){if(Array.isArray(v)||(p=i(v))||g){p&&(v=p);var m=0,T=o(function(){},"F");return{s:T,n:o(function(){return m>=v.length?{done:!0}:{done:!1,value:v[m++]}},"n"),e:o(function(M){throw M},"e"),f:T}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var y=!0,S=!1,w;return{s:o(function(){p=p.call(v)},"s"),n:o(function(){var M=p.next();return y=M.done,M},"n"),e:o(function(M){S=!0,w=M},"e"),f:o(function(){try{!y&&p.return!=null&&p.return()}finally{if(S)throw w}},"f")}}o(n,"_createForOfIteratorHelper");function i(v,g){if(v){if(typeof v=="string")return a(v,g);var p=Object.prototype.toString.call(v).slice(8,-1);if(p==="Object"&&v.constructor&&(p=v.constructor.name),p==="Map"||p==="Set")return Array.from(v);if(p==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(p))return a(v,g)}}o(i,"_unsupportedIterableToArray");function a(v,g){(g==null||g>v.length)&&(g=v.length);for(var p=0,m=new Array(g);p<g;p++)m[p]=v[p];return m}o(a,"_arrayLikeToArray");function s(v,g){if(!(v instanceof g))throw new TypeError("Cannot call a class as a function")}o(s,"_classCallCheck");function l(v,g){for(var p=0;p<g.length;p++){var m=g[p];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(v,d(m.key),m)}}o(l,"_defineProperties");function u(v,g,p){return p&&l(v,p),Object.defineProperty(v,"prototype",{writable:!1}),v}o(u,"_createClass");function d(v){var g=c(v,"string");return t(g)==="symbol"?g:String(g)}o(d,"_toPropertyKey");function c(v,g){if(t(v)!=="object"||v===null)return v;var p=v[Symbol.toPrimitive];if(p!==void 0){var m=p.call(v,g);if(t(m)!=="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}o(c,"_toPrimitive");var h=function(){function v(){s(this,v)}return o(v,"WidgetParser"),u(v,null,[{key:"parseAccountData",value:o(function(p){if(!p)return[];for(var m=[],T=0,y=Object.keys(p);T<y.length;T++){var S=y[T],w=p[S];if(w&&!(w.type!=="m.widget"&&w.type!=="im.vector.modular.widgets")&&w.sender){var C=w.state_key||w.id;if(C===S){var M={content:w.content,sender:w.sender,type:"m.widget",state_key:S,event_id:"$example",room_id:"!example",origin_server_ts:1},_=v.parseRoomWidget(M);_&&m.push(_)}}}return m},"parseAccountData")},{key:"parseWidgetsFromRoomState",value:o(function(p){if(!p)return[];var m=[],T=n(p),y;try{for(T.s();!(y=T.n()).done;){var S=y.value,w=v.parseRoomWidget(S);w&&m.push(w)}}catch(C){T.e(C)}finally{T.f()}return m},"parseWidgetsFromRoomState")},{key:"parseRoomWidget",value:o(function(p){if(!p||p.type!=="m.widget"&&p.type!=="im.vector.modular.widgets")return null;var m=p.content||{},T={id:p.state_key,creatorUserId:m.creatorUserId||p.sender,name:m.name,type:m.type,url:m.url,waitForIframeLoad:m.waitForIframeLoad,data:m.data};return v.processEstimatedWidget(T)},"parseRoomWidget")},{key:"processEstimatedWidget",value:o(function(p){return!p.id||!p.creatorUserId||!p.type||!(0,e.isValidUrl)(p.url)?null:new r.Widget(p)},"processEstimatedWidget")}]),v}();return No.WidgetParser=h,No}o($L,"requireWidgetParser");var Fh={};Object.defineProperty(Fh,"__esModule",{value:!0});Fh.runTemplate=WL;Fh.toString=XI;function WL(r,e,t){for(var n=Object.assign({},e.data,{matrix_room_id:t.widgetRoomId||"",matrix_user_id:t.currentUserId,matrix_display_name:t.userDisplayName||t.currentUserId,matrix_avatar_url:t.userHttpAvatarUrl||"",matrix_widget_id:e.id,"org.matrix.msc2873.client_id":t.clientId||"","org.matrix.msc2873.client_theme":t.clientTheme||"","org.matrix.msc2873.client_language":t.clientLanguage||"","org.matrix.msc3819.matrix_device_id":t.deviceId||"","org.matrix.msc4039.matrix_base_url":t.baseUrl||""}),i=r,a=0,s=Object.keys(n);a<s.length;a++){var l=s[a],u="$".concat(l).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(u,"g");i=i.replace(d,encodeURIComponent(XI(n[l])))}return i}o(WL,"runTemplate");function XI(r){return r==null?"".concat(r):String(r)}o(XI,"toString");var Lo={},N0;function KL(){if(N0)return Lo;N0=1,Object.defineProperty(Lo,"__esModule",{value:!0}),Lo.WidgetDriver=void 0;var r=Bh();function e(u){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(d){return typeof d}:function(d){return d&&typeof Symbol=="function"&&d.constructor===Symbol&&d!==Symbol.prototype?"symbol":typeof d},e(u)}o(e,"_typeof");function t(u,d){if(!(u instanceof d))throw new TypeError("Cannot call a class as a function")}o(t,"_classCallCheck");function n(u,d){for(var c=0;c<d.length;c++){var h=d[c];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(u,a(h.key),h)}}o(n,"_defineProperties");function i(u,d,c){return d&&n(u.prototype,d),Object.defineProperty(u,"prototype",{writable:!1}),u}o(i,"_createClass");function a(u){var d=s(u,"string");return e(d)==="symbol"?d:String(d)}o(a,"_toPropertyKey");function s(u,d){if(e(u)!=="object"||u===null)return u;var c=u[Symbol.toPrimitive];if(c!==void 0){var h=c.call(u,d);if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(u)}o(s,"_toPrimitive");var l=function(){function u(){t(this,u)}return o(u,"WidgetDriver"),i(u,[{key:"validateCapabilities",value:o(function(c){return Promise.resolve(new Set)},"validateCapabilities")},{key:"sendEvent",value:o(function(c,h){return Promise.reject(new Error("Failed to override function"))},"sendEvent")},{key:"sendDelayedEvent",value:o(function(c,h,v,g){return Promise.reject(new Error("Failed to override function"))},"sendDelayedEvent")},{key:"updateDelayedEvent",value:o(function(c,h){return Promise.reject(new Error("Failed to override function"))},"updateDelayedEvent")},{key:"sendToDevice",value:o(function(c,h,v){return Promise.reject(new Error("Failed to override function"))},"sendToDevice")},{key:"readRoomAccountData",value:o(function(c){return Promise.resolve([])},"readRoomAccountData")},{key:"readRoomEvents",value:o(function(c,h,v){return Promise.resolve([])},"readRoomEvents")},{key:"readStateEvents",value:o(function(c,h,v){return Promise.resolve([])},"readStateEvents")},{key:"readRoomTimeline",value:o(function(c,h,v,g,p,m){return g===void 0?this.readRoomEvents(h,v,p,[c],m):this.readStateEvents(h,g,p,[c])},"readRoomTimeline")},{key:"readRoomState",value:o(function(c,h,v){return this.readStateEvents(h,v,Number.MAX_SAFE_INTEGER,[c])},"readRoomState")},{key:"readEventRelations",value:o(function(c,h,v,g,p,m,T,y){return Promise.resolve({chunk:[]})},"readEventRelations")},{key:"askOpenID",value:o(function(c){c.update({state:r.OpenIDRequestState.Blocked})},"askOpenID")},{key:"navigate",value:o(function(c){throw new Error("Navigation is not implemented")},"navigate")},{key:"getTurnServers",value:o(function(){throw new Error("TURN server support is not implemented")},"getTurnServers")},{key:"searchUserDirectory",value:o(function(c,h){return Promise.resolve({limited:!1,results:[]})},"searchUserDirectory")},{key:"getMediaConfig",value:o(function(){throw new Error("Get media config is not implemented")},"getMediaConfig")},{key:"uploadFile",value:o(function(c){throw new Error("Upload file is not implemented")},"uploadFile")},{key:"downloadFile",value:o(function(c){throw new Error("Download file is not implemented")},"downloadFile")},{key:"getKnownRooms",value:o(function(){throw new Error("Querying known rooms is not implemented")},"getKnownRooms")},{key:"processError",value:o(function(c){},"processError")}]),u}();return Lo.WidgetDriver=l,Lo}o(KL,"requireWidgetDriver");var L0;function Bh(){return L0||(L0=1,function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=EL();Object.keys(e).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===e[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return e[b]},"get")})});var t=NL();Object.keys(t).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===t[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return t[b]},"get")})});var n=vo;Object.keys(n).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===n[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return n[b]},"get")})});var i=py();Object.keys(i).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===i[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return i[b]},"get")})});var a=gu;Object.keys(a).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===a[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return a[b]},"get")})});var s=gy;Object.keys(s).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===s[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return s[b]},"get")})});var l=xi;Object.keys(l).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===l[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return l[b]},"get")})});var u=Ra;Object.keys(u).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===u[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return u[b]},"get")})});var d=yn;Object.keys(d).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===d[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return d[b]},"get")})});var c=Dr;Object.keys(c).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===c[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return c[b]},"get")})});var h=fo;Object.keys(h).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===h[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return h[b]},"get")})});var v=Nh;Object.keys(v).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===v[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return v[b]},"get")})});var g=Lh;Object.keys(g).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===g[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return g[b]},"get")})});var p=yu;Object.keys(p).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===p[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return p[b]},"get")})});var m=Eu;Object.keys(m).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===m[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return m[b]},"get")})});var T=Sn;Object.keys(T).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===T[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return T[b]},"get")})});var y=Uh;Object.keys(y).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===y[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return y[b]},"get")})});var S=jh;Object.keys(S).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===S[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return S[b]},"get")})});var w=YI();Object.keys(w).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===w[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return w[b]},"get")})});var C=$L();Object.keys(C).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===C[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return C[b]},"get")})});var M=Fh;Object.keys(M).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===M[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return M[b]},"get")})});var _=Su;Object.keys(_).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===_[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return _[b]},"get")})});var O=KL();Object.keys(O).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===O[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return O[b]},"get")})})}(Ff)),Ff}o(Bh,"requireLib");var kr=Bh();function U0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(U0,"ownKeys");function Ju(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?U0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):U0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Ju,"_objectSpread");function VL(r){var e,t,n,i=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(t&&(e=r[t])!=null)return e.call(r);if(n&&(e=r[n])!=null)return new _d(e.call(r));t="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}o(VL,"_asyncIterator");function _d(r){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(i){return{value:i,done:n}})}return o(e,"AsyncFromSyncIteratorContinuation"),_d=o(function(n){this.s=n,this.n=n.next},"AsyncFromSyncIterator"),_d.prototype={s:null,n:null,next:o(function(){return e(this.n.apply(this.s,arguments))},"next"),return:o(function(n){var i=this.s.return;return i===void 0?Promise.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},"_return"),throw:o(function(n){var i=this.s.return;return i===void 0?Promise.reject(n):e(i.apply(this.s,arguments))},"_throw")},new _d(r)}o(_d,"AsyncFromSyncIterator");var bd=function(r){return r.PendingEventsChanged="PendingEvent.pendingEventsChanged",r}({});const eE=class eE extends Zs{constructor(e,t,n,i,a){var s,l,u,d,c,h,v,g,p,m,T,y,S,w;super(i),s=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,f(this,"room",void 0),f(this,"widgetApiReady",void 0),f(this,"roomStateSynced",void 0),f(this,"lifecycle",void 0),f(this,"syncState",null),f(this,"pendingSendingEventsTxId",[]),f(this,"eventEmitter",new Ge),f(this,"updateTxId",function(){var _=R(function*(O){if(O.getSender()===s.getUserId()&&s.pendingSendingEventsTxId.some(z=>O.getType()===z.type)){for(var b,F=(b=s.pendingSendingEventsTxId.find(z=>z.id===O.getId()))===null||b===void 0?void 0:b.txId;!F&&s.pendingSendingEventsTxId.length>0;){var V;yield new Promise(z=>s.eventEmitter.once(bd.PendingEventsChanged,()=>z())),F=(V=s.pendingSendingEventsTxId.find(z=>z.id===O.getId()))===null||V===void 0?void 0:V.txId}F&&(O.setTxnId(F),O.setUnsigned(Ju(Ju({},O.getUnsigned()),{},{transaction_id:F}))),s.pendingSendingEventsTxId=s.pendingSendingEventsTxId.filter(z=>z.id!==O.getId()),s.pendingSendingEventsTxId.length===0&&s.eventEmitter.emit(bd.PendingEventsChanged)}});return function(O){return _.apply(this,arguments)}}()),f(this,"onEvent",function(){var _=R(function*(O){if(O.preventDefault(),O.detail.data.room_id===s.roomId){var b=new qt(O.detail.data);yield s.updateTxId(b),s.syncApi instanceof fn?(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,void 0,[],[b]):yield s.syncApi.injectRoomEvents(s.room,[],void 0,[b]):(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,[],[b]):I.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),s.emit(de.Event,b),s.setSyncState(Ue.Syncing),I.info("Received event ".concat(b.getId()," ").concat(b.getType()))}else{var{event_id:F,room_id:V}=O.detail.data;I.info("Received event ".concat(F," for a different room ").concat(V,"; discarding"))}yield s.ack(O)});return function(O){return _.apply(this,arguments)}}()),f(this,"onToDevice",function(){var _=R(function*(O){O.preventDefault();var b=new qt({type:O.detail.data.type,sender:O.detail.data.sender,content:O.detail.data.content});O.detail.data.encrypted&&b.makeEncrypted(B.RoomMessageEncrypted,{},"",""),s.emit(de.ToDeviceEvent,b),s.setSyncState(Ue.Syncing),yield s.ack(O)});return function(O){return _.apply(this,arguments)}}()),f(this,"onStateUpdate",function(){var _=R(function*(O){O.preventDefault(),(yield s.supportUpdateState())||I.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var b of O.detail.data.state)if(b.room_id===s.roomId){var F=new qt(b);s.syncApi instanceof fn?yield s.syncApi.injectRoomEvents(s.room,void 0,[F]):yield s.syncApi.injectRoomEvents(s.room,[F]),I.info("Updated state entry ".concat(F.getType()," ").concat(F.getStateKey()," to ").concat(F.getId()))}else{var{event_id:V,room_id:z}=O.detail.data;I.info("Received state entry ".concat(V," for a different room ").concat(z,"; discarding"))}yield s.ack(O)});return function(O){return _.apply(this,arguments)}}());var C=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var _=R(function*(O,b){try{return yield C(O,b)}catch(F){j0(F)}});return function(O,b){return _.apply(this,arguments)}}();var M=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var _=R(function*(O,b){try{return yield M(O,b)}catch(F){j0(F)}});return function(O,b){return _.apply(this,arguments)}}(),this.widgetApiReady=new Promise(_=>this.widgetApi.once("ready",_)),this.roomStateSynced=(l=t.receiveState)!==null&&l!==void 0&&l.length?new Promise(_=>this.widgetApi.once("action:".concat(kr.WidgetApiToWidgetAction.UpdateState),_)):Promise.resolve(),((u=t.sendEvent)!==null&&u!==void 0&&u.length||(d=t.receiveEvent)!==null&&d!==void 0&&d.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(c=t.sendState)!==null&&c!==void 0&&c.length||(h=t.receiveState)!==null&&h!==void 0&&h.length)&&e.requestCapabilityForRoomTimeline(n),(v=t.sendEvent)===null||v===void 0||v.forEach(_=>e.requestCapabilityToSendEvent(_)),(g=t.receiveEvent)===null||g===void 0||g.forEach(_=>e.requestCapabilityToReceiveEvent(_)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(_=>e.requestCapabilityToSendMessage(_)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(_=>e.requestCapabilityToReceiveMessage(_)),(p=t.sendState)===null||p===void 0||p.forEach(_=>{var{eventType:O,stateKey:b}=_;return e.requestCapabilityToSendState(O,b)}),(m=t.receiveState)===null||m===void 0||m.forEach(_=>{var{eventType:O,stateKey:b}=_;return e.requestCapabilityToReceiveState(O,b)}),(T=t.sendToDevice)===null||T===void 0||T.forEach(_=>e.requestCapabilityToSendToDevice(_)),(y=t.receiveToDevice)===null||y===void 0||y.forEach(_=>e.requestCapabilityToReceiveToDevice(_)),t.sendDelayedEvents&&((S=t.sendEvent)!==null&&S!==void 0&&S.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(w=t.sendState)!==null&&w!==void 0&&w.length)&&e.requestCapability(kr.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(kr.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(kr.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(kr.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(kr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(kr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}supportUpdateState(){var e=this;return R(function*(){return(yield e.widgetApi.getClientVersions()).includes(kr.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var i=t.getUserId();if(i&&t.store.storeUser(new Fn(i)),n.slidingSync?t.syncApi=new kc(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new fn(t,n,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,s;yield Promise.all((a=(s=t.capabilities.receiveState)===null||s===void 0?void 0:s.map(function(){var l=R(function*(u){var{eventType:d,stateKey:c}=u,h=yield t.widgetApi.readStateEvents(d,void 0,c,[t.roomId]),v=h.map(g=>new qt(g));t.syncApi instanceof fn?yield t.syncApi.injectRoomEvents(t.room,void 0,v):yield t.syncApi.injectRoomEvents(t.room,v),v.forEach(g=>{t.emit(de.Event,g),I.info("Backfilled event ".concat(g.getId()," ").concat(g.getType()," ").concat(g.getStateKey()))})});return function(u){return l.apply(this,arguments)}}()))!==null&&a!==void 0?a:[])}n.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(Ue.Syncing),I.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(kr.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(kr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(kr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return R(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n){var i=this;return R(function*(){var a=t.event.redacts?Ju(Ju({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(n){var s=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId,"delay"in n?n.delay:void 0,"parent_delay_id"in n?n.parent_delay_id:void 0).catch(rn);return i.validateSendDelayedEventResponse(s)}var l=t.getTxnId();l&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:l});var u;try{u=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId).catch(rn)}catch(d){throw i.updatePendingEventStatus(e,t,Se.NOT_SENT),d}return e.updatePendingEvent(t,Se.SENT,u.event_id),i.pendingSendingEventsTxId.forEach(d=>{d.txId===l&&(d.id=u.event_id)}),i.eventEmitter.emit(bd.PendingEventsChanged),{event_id:u.event_id}})()}sendStateEvent(e,t,n){var i=arguments,a=this;return R(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:"",l=yield a.widgetApi.sendStateEvent(t,s,n,e).catch(rn);if(l.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:l.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield s.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","sendDelayedStateEvent");var u=yield s.widgetApi.sendStateEvent(n,l,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(rn);return s.validateSendDelayedEventResponse(u)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportUnstableFeature(cn)))throw new vn("Server does not support the delayed events API","updateDelayedEvent");return yield n.widgetApi.updateDelayedEvent(e,t).catch(rn),{}})()}encryptAndSendToDevice(e,t,n){var i=this;return R(function*(){var a=new Jr(()=>new Map);for(var{userId:s,deviceId:l}of t)a.getOrCreate(s).set(l,n);yield i.widgetApi.sendToDevice(e,!0,na(a)).catch(rn)})()}sendToDevice(e,t){var n=this;return R(function*(){return yield n.widgetApi.sendToDevice(e,!1,na(t)).catch(rn),{}})()}getOpenIdToken(){var e=this;return R(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(rn);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return R(function*(){var{eventType:n,batch:i}=e,a=new Jr(()=>new Map);for(var{userId:s,deviceId:l,payload:u}of i)a.getOrCreate(s).set(l,u);yield t.widgetApi.sendToDevice(n,!1,na(a)).catch(rn)})()}sendToDeviceViaWidgetApi(e,t,n){var i=this;return R(function*(){yield i.widgetApi.sendToDevice(e,t,na(n)).catch(rn)})()}checkTurnServers(){var e=this;return R(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(de.Sync,e,t)}ack(e){var t=this;return R(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return R(function*(){var t=e.widgetApi.getTurnServers(),n=o(()=>{t.return(void 0)},"onClientStopped");e.lifecycle.signal.addEventListener("abort",n);try{var i=!1,a=!1,s;try{for(var l=VL(t),u;i=!(u=yield l.next()).done;i=!1){var d=u.value;e.turnServers=[{urls:d.uris,username:d.username,credential:d.password}],e.emit(de.TurnServers,e.turnServers),I.log("Received TURN server: ".concat(d.uris))}}catch(c){a=!0,s=c}finally{try{i&&l.return!=null&&(yield l.return())}finally{if(a)throw s}}}catch(c){I.warn("Error watching TURN servers",c)}finally{e.lifecycle.signal.removeEventListener("abort",n)}})()}};o(eE,"RoomWidgetClient");let Bc=eE;function j0(r){throw r instanceof kr.WidgetApiResponseError&&r.data.matrix_api_error?dt.fromWidgetApiErrorData(r.data.matrix_api_error):r}o(j0,"processAndThrow");function rn(r){throw r instanceof Error&&r.message==="Request timed out"?new qn("widget api timeout"):r}o(rn,"timeoutToConnectionError");const tE=class tE{constructor(){f(this,"unthreadedReadReceipts",new Map),f(this,"threadedReadReceipts",new Jr(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e==null||e.forEach(t=>{t.type!==B.Receipt||!t.content||Object.keys(t.content).forEach(n=>{Object.entries(t.content[n]).forEach(i=>{var[a,s]=i;if(zg(a))for(var l of Object.keys(s)){var u=t.content[n][a][l],d={data:t.content[n][a][l],type:a,eventId:n};u.thread_id?this.setThreaded(u.thread_id,l,d):this.setUnthreaded(l,d)}})})})}buildAccumulatedReceiptEvent(e){var t={type:B.Receipt,room_id:e,content:{}},n=new Jr(()=>new Jr(()=>new Map));for(var[i,a]of this.allUnthreaded())n.getOrCreate(a.eventId).getOrCreate(a.type).set(i,a.data);for(var[s,l]of this.allThreaded())n.getOrCreate(l.eventId).getOrCreate(l.type).set(s,l.data);return t.content=na(n),n.size>0?t:null}};o(tE,"ReceiptAccumulator");let Nm=tE;var In=function(r){return r.Invite="invite",r.Leave="leave",r.Join="join",r.Knock="knock",r}({});function qL(r){return"_localTs"in r&&r._localTs!==void 0}o(qL,"isTaggedEvent");const rE=class rE{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,f(this,"accountData",{}),f(this,"inviteRooms",{}),f(this,"knockRooms",{}),f(this,"joinRooms",{}),f(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,In.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,In.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,In.Leave,e.rooms.leave[n],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(n=>{this.accumulateRoom(n,In.Knock,e.rooms.knock[n],t)}))}accumulateRoom(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case In.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case In.Knock:this.accumulateKnockState(e,n);break;case In.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case In.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:I.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var n=this.inviteRooms[e];t.invite_state.events.forEach(i=>{for(var a=!1,s=0;s<n.invite_state.events.length;s++){var l=n.invite_state.events[s];l.type===i.type&&l.state_key==i.state_key&&(n.invite_state.events[s]=i,a=!0)}a||n.invite_state.events.push(i)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var n=this.knockRooms[e];t.knock_state.events.forEach(i=>{for(var a=!1,s=0;s<n.knock_state.events.length;s++){var l=n.knock_state.events[s];l.type===i.type&&l.state_key==i.state_key&&(n.knock_state.events[s]=i,a=!0)}a||n.knock_state.events.push(i)})}}accumulateJoinState(e,t){var n,i,a,s,l,u,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new Nm});var c=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(M=>{c._accountData[M.type]=M}),t.unread_notifications&&(c._unreadNotifications=t.unread_notifications),c._unreadThreadNotifications=(n=(i=t[Dl.stable])!==null&&i!==void 0?i:t[Dl.unstable])!==null&&n!==void 0?n:void 0,t.summary){var h,v,g,p="m.heroes",m="m.invited_member_count",T="m.joined_member_count",y=c._summary,S=t.summary;y[p]=(h=S[p])!==null&&h!==void 0?h:y[p],y[T]=(v=S[T])!==null&&v!==void 0?v:y[T],y[m]=(g=S[m])!==null&&g!==void 0?g:y[m]}if(c._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(c._timeline=[]),(s=t.state)===null||s===void 0||(s=s.events)===null||s===void 0||s.forEach(M=>{Qu(c._currentState,M)}),(l=t["org.matrix.msc4222.state_after"])===null||l===void 0||(l=l.events)===null||l===void 0||l.forEach(M=>{Qu(c._currentState,M)}),(u=t.timeline)===null||u===void 0||(u=u.events)===null||u===void 0||u.forEach((M,_)=>{var O;t["org.matrix.msc4222.state_after"]||Qu(c._currentState,M);var b;if(d)b=M;else{var F;b=Object.assign({},M),b.unsigned!==void 0&&(b.unsigned=Object.assign({},b.unsigned));var V=(F=M.unsigned)===null||F===void 0?void 0:F.age;V!==void 0&&(b._localTs=Date.now()-V)}c._timeline.push({event:b,token:_===0&&(O=t.timeline.prev_batch)!==null&&O!==void 0?O:null})}),c._timeline.length>this.opts.maxTimelineEntries){for(var w=c._timeline.length-this.opts.maxTimelineEntries,C=w;C<c._timeline.length;C++)if(c._timeline[C].token){c._timeline=c._timeline.slice(C,c._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(i=>{t.invite[i]=this.inviteRooms[i]}),Object.keys(this.knockRooms).forEach(i=>{t.knock[i]=this.knockRooms[i]}),Object.keys(this.joinRooms).forEach(i=>{var a=this.joinRooms[i],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:a._unreadNotifications,unread_thread_notifications:a._unreadThreadNotifications,summary:a._summary};Object.keys(a._accountData).forEach(v=>{s.account_data.events.push(a._accountData[v])});var l=a._receipts.buildAccumulatedReceiptEvent(i);l&&s.ephemeral.events.push(l),a._timeline.forEach(v=>{if(!s.timeline.prev_batch){if(!v.token)return;s.timeline.prev_batch=v.token}var g;!e&&qL(v.event)?(g=Object.assign({},v.event),g.unsigned!==void 0&&(g.unsigned=Object.assign({},g.unsigned)),delete g._localTs,g.unsigned=g.unsigned||{},g.unsigned.age=Date.now()-v.event._localTs):g=v.event,s.timeline.events.push(g)});for(var u=Object.create(null),d=s.timeline.events.length-1;d>=0;d--){var c=s.timeline.events[d];if(!(c.state_key===null||c.state_key===void 0)){var h=lu(c);h.unsigned&&(h.unsigned.prev_content&&(h.content=h.unsigned.prev_content),h.unsigned.prev_sender&&(h.sender=h.unsigned.prev_sender)),Qu(u,h)}}Object.keys(a._currentState).forEach(v=>{Object.keys(a._currentState[v]).forEach(g=>{var p=a._currentState[v][g];s["org.matrix.msc4222.state_after"].events.push(p),u[v]&&u[v][g]&&(p=u[v][g]),s.state.events.push(p)})}),t.join[i]=s});var n=[];return Object.keys(this.accountData).forEach(i=>{n.push(this.accountData[i])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}};o(rE,"SyncAccumulator");let $c=rE;function Qu(r,e){e.state_key===null||e.state_key===void 0||!e.type||(r[e.type]||(r[e.type]=Object.create(null)),r[e.type][e.state_key]=e)}o(Qu,"setState");var ZI=function(r){return r[r.Blocked=-1]="Blocked",r[r.Unverified=0]="Unverified",r[r.Verified=1]="Verified",r}({});const nE=class nE{constructor(e){f(this,"deviceId",void 0),f(this,"userId",void 0),f(this,"algorithms",void 0),f(this,"keys",void 0),f(this,"verified",void 0),f(this,"signatures",void 0),f(this,"displayName",void 0),f(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||ZI.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}};o(nE,"Device");let Lm=nE;var F0=o(function(){},"debuglog"),GL=10;const iE=class iE{constructor(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,f(this,"windowLimit",void 0),f(this,"start",void 0),f(this,"end",void 0),f(this,"eventCount",0),this.windowLimit=i.windowLimit||1e3,(n=t.room)===null||n===void 0||n.on(ue.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,n=o(i=>{if(!i)throw new Error("No timeline given to initFields");var a,s=i.getEvents();if(!e)a=s.length;else if(a=s.findIndex(d=>d.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var l=Math.min(s.length,a+Math.ceil(t/2)),u=Math.max(0,l-t);this.start=new Xl(i,u-i.getBaseIndex()),this.end=new Xl(i,l-i.getBaseIndex()),this.eventCount=l-u},"initFields");return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==he.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==he.FORWARDS){var n;return(n=this.end)!==null&&n!==void 0?n:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var n=this.getTimelineIndex(e);if(!n)return!1;var i=e==he.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,F0("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=he.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,i){i&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==he.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var n=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return!!n||!!i}paginate(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0,s=n.length>3&&n[3]!==void 0?n[3]:GL,l=i.getTimelineIndex(e);if(!l)return!1;if(l.pendingPaginate)return l.pendingPaginate;if(i.extend(e,t))return!0;if(!a||s===0)return!1;var u=l.timeline.getPaginationToken(e);if(!u)return!1;var d=i.client.paginateEventTimeline(l.timeline,{backwards:e==he.BACKWARDS,limit:t}).finally(function(){l.pendingPaginate=void 0}).then(c=>c?i.paginate(e,t,!0,s-1):i.paginate(e,t,!1,0));return l.pendingPaginate=d,d})()}unpaginate(e,t){var n=t?this.start:this.end;if(!n)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,F0("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var n,i,a=t.getEvents(),s=0,l=a.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===((n=this.end)===null||n===void 0?void 0:n.timeline)&&(l=this.end.index+t.getBaseIndex());for(var u=s;u<l;u++)e.push(a[u]);if(t===((i=this.end)===null||i===void 0?void 0:i.timeline))break;t=t.getNeighbouringTimeline(he.FORWARDS)}return e}};o(iE,"TimelineWindow");let Um=iE;const aE=class aE{constructor(e,t){this.timeline=e,this.index=t,f(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?he.BACKWARDS:he.FORWARDS);return n?(this.timeline=n,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}};o(aE,"TimelineIndex");let Xl=aE;var Uo="m.login.email.identity",B0="m.login.msisdn",jm=function(r){return r.Password="m.login.password",r.Recaptcha="m.login.recaptcha",r.Terms="m.login.terms",r.Email="m.login.email.identity",r.Msisdn="m.login.msisdn",r.Sso="m.login.sso",r.SsoUnstable="org.matrix.login.sso",r.Dummy="m.login.dummy",r.RegistrationToken="m.login.registration_token",r.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",r}({});const sE=class sE extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,f(this,"name","NoAuthFlowFoundError")}};o(sE,"NoAuthFlowFoundError");let Wc=sE;const oE=class oE{constructor(e){var t=this;f(this,"matrixClient",void 0),f(this,"inputs",void 0),f(this,"clientSecret",void 0),f(this,"requestCallback",void 0),f(this,"busyChangedCallback",void 0),f(this,"stateUpdatedCallback",void 0),f(this,"requestEmailTokenCallback",void 0),f(this,"supportedStages",void 0),f(this,"data",void 0),f(this,"emailSid",void 0),f(this,"requestingEmailToken",!1),f(this,"attemptAuthDeferred",null),f(this,"chosenFlow",null),f(this,"currentStage",null),f(this,"emailAttempt",1),f(this,"submitPromise",null),f(this,"requestEmailToken",R(function*(){if(t.requestingEmailToken)I.warn("Could not request email token: Already requesting");else{I.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var n=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=n.sid,I.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return R(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var n=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var i;(i=e.busyChangedCallback)===null||i===void 0||i.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var s;(s=e.busyChangedCallback)===null||s===void 0||s.call(e,!1)})}return n})()}poll(){var e=this;return R(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Uo&&e.emailSid){var n={sid:e.emailSid,client_secret:e.clientSecret},i=e.matrixClient.getIdentityServerUrl();i&&(n.id_server=new URL(i).host),t={type:Uo,threepid_creds:n}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return R(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var s;(s=n.busyChangedCallback)===null||s===void 0||s.call(n,!0)}for(;n.submitPromise;)try{yield n.submitPromise}catch{}var l;(i=n.data)!==null&&i!==void 0&&i.session?l=Object.assign({session:n.data.session},e):l=e;try{n.submitPromise=n.doRequest(l,a),yield n.submitPromise}finally{if(n.submitPromise=null,!a){var u;(u=n.busyChangedCallback)===null||u===void 0||u.call(n,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield n.requestCallback(e,i);n.attemptAuthDeferred.resolve(a),n.attemptAuthDeferred=null}catch(p){var s,l,u,d,c=p instanceof dt?p:null,h=(s=c==null||(l=c.data)===null||l===void 0?void 0:l.flows)!==null&&s!==void 0?s:null,v=((u=n.data)===null||u===void 0?void 0:u.flows)||!!h;if(!c||c.httpStatus!==401||!c.data||!v)if(i)I.log("Background poll request failed doing UI auth: ignoring",p);else{var g;(g=n.attemptAuthDeferred)===null||g===void 0||g.reject(p)}c&&!c.data&&(c.data={}),c&&!c.data.flows&&!c.data.completed&&!c.data.session&&(c.data.flows=n.data.flows,c.data.completed=n.data.completed,c.data.session=n.data.session),c&&(n.data=c.data);try{n.startNextAuthStage()}catch(m){n.attemptAuthDeferred.reject(m),n.attemptAuthDeferred=null;return}if(!n.emailSid&&(d=n.chosenFlow)!==null&&d!==void 0&&d.stages.includes(jm.Email))try{yield n.requestEmailToken()}catch(m){n.attemptAuthDeferred.reject(m),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");if(this.currentStage=n,n===jm.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var i,a;this.stateUpdatedCallback(n,{errcode:((i=this.data)===null||i===void 0?void 0:i.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(n,n===Uo?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),I.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return I.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(n=>!this.supportedStages.has(n)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],n=!!this.inputs.emailAddress||!!this.emailSid,i=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((c,h)=>this.scoreFlow(c)-this.scoreFlow(h));for(var a of t){var s=!1,l=!1;for(var u of a.stages)u===Uo?s=!0:u==B0&&(l=!0);if(s==n&&l==i)return a}var d=[];throw n&&d.push(Uo),i&&d.push(B0),new Wc("No appropriate authentication flow found",d,t)}firstUncompletedStage(e){var t,n=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(i=>!n.includes(i))}};o(oE,"InteractiveAuth");let Fm=oE;function eC(r,e){return new Promise((t,n)=>{var i=!0,a=r.open(e);a.onupgradeneeded=()=>{i=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{var s=a.result;s.close(),i||r.deleteDatabase(e),t(i)},a.onerror=()=>n(a.error)})}o(eC,"exists");var tC=[r=>{r.createObjectStore("users",{keyPath:["userId"]}),r.createObjectStore("accountData",{keyPath:["type"]}),r.createObjectStore("sync",{keyPath:["clobber"]})},r=>{var e=r.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},r=>{r.createObjectStore("client_options",{keyPath:["clobber"]})},r=>{r.createObjectStore("to_device_queue",{autoIncrement:!0})}],HL=tC.length;function Yu(r,e,t){var n=r.openCursor(e);return new Promise((i,a)=>{var s=[];n.onerror=()=>{var l;a(new Error("Query failed: "+((l=n.error)===null||l===void 0?void 0:l.name)))},n.onsuccess=()=>{var l=n.result;if(!l){i(s);return}s.push(t(l)),l.continue()}})}o(Yu,"selectQuery");function Vi(r){return new Promise((e,t)=>{r.oncomplete=function(n){e(n)},r.onerror=function(){t(r.error)}})}o(Vi,"txnAsPromise");function rC(r){return new Promise((e,t)=>{r.onsuccess=function(n){e(n)},r.onerror=function(){t(r.error)}})}o(rC,"reqAsEventPromise");function zL(r){return new Promise((e,t)=>{r.onsuccess=()=>e(r),r.onerror=n=>t(n)})}o(zL,"reqAsPromise");function Bf(r){return rC(r).then(e=>r.result)}o(Bf,"reqAsCursorPromise");const lE=class lE{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),eC(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,f(this,"dbName",void 0),f(this,"syncAccumulator",void 0),f(this,"db",void 0),f(this,"disconnected",!0),f(this,"_isNewlyCreated",!1),f(this,"syncToDatabasePromise",void 0),f(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new $c}connect(e){var t=this;if(!this.disconnected)return I.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,I.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,HL);return n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;I.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(s)),s<1&&(this._isNewlyCreated=!0),tC.forEach((l,u)=>{s<=u&&l(a)})},n.onblocked=()=>{I.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},I.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),rC(n).then(R(function*(){I.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var i;(i=t.db)===null||i===void 0||i.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e==null||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,n]=e;I.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{var i=this.db.transaction(["oob_membership_events"],"readonly"),a=i.objectStore("oob_membership_events"),s=a.index("room"),l=IDBKeyRange.only(e),u=s.openCursor(l),d=[],c=!1;u.onsuccess=()=>{var h=u.result;if(!h)return!d.length&&!c?t(null):t(d);var v=h.value;v.oob_written?c=!0:d.push(v),h.continue()},u.onerror=h=>{n(h)}}).then(t=>(I.log("LL: got ".concat(t==null?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return R(function*(){I.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var i=n.db.transaction(["oob_membership_events"],"readwrite"),a=i.objectStore("oob_membership_events");t.forEach(l=>{a.put(l)});var s={room_id:e,oob_written:!0,state_key:0};a.put(s),yield Vi(i),I.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return R(function*(){var n=t.db.transaction(["oob_membership_events"],"readonly"),i=n.objectStore("oob_membership_events"),a=i.index("room"),s=IDBKeyRange.only(e),l=Bf(a.openKeyCursor(s,"next")).then(p=>(p==null?void 0:p.primaryKey)[1]),u=Bf(a.openKeyCursor(s,"prev")).then(p=>(p==null?void 0:p.primaryKey)[1]),[d,c]=yield Promise.all([l,u]),h=t.db.transaction(["oob_membership_events"],"readwrite"),v=h.objectStore("oob_membership_events"),g=IDBKeyRange.bound([e,d],[e,c]);I.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,d],[e,c]),yield zL(v.delete(g))})()}clearDatabase(){return new Promise(e=>{var t;I.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{I.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},n.onerror=()=>{var i;I.warn("unable to delete js-sdk store indexeddb: ".concat((i=n.error)===null||i===void 0?void 0:i.name)),e()},n.onsuccess=()=>{I.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(lu(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return R(function*(){return t.syncToDatabasePromise?(I.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return R(function*(){try{var n=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(n.accountData),t.persistSyncData(n.nextBatch,n.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return I.log("Persisting sync data up to",e),ka(()=>{var n=this.db.transaction(["sync"],"readwrite"),i=n.objectStore("sync");return i.put({clobber:"-",nextBatch:e,roomsData:t}),Vi(n).then(()=>{I.log("Persisted sync data up to",e)})})}persistAccountData(e){return ka(()=>{var t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(var i of e)n.put(i);return Vi(t).then()})}persistUserPresenceEvents(e){return ka(()=>{var t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(var i of e)n.put({userId:i[0],event:i[1]});return Vi(t).then()})}getUserPresenceEvents(){return ka(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return Yu(t,void 0,n=>[n.value.userId,n.value.event])})}loadAccountData(){return I.log("LocalIndexedDBStoreBackend: loading account data..."),ka(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return Yu(t,void 0,n=>n.value).then(n=>(I.log("LocalIndexedDBStoreBackend: loaded account data"),n))})}loadSyncData(){return I.log("LocalIndexedDBStoreBackend: loading sync data..."),ka(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return Yu(t,void 0,n=>n.value).then(n=>(I.log("LocalIndexedDBStoreBackend: loaded sync data"),n.length>1&&I.warn("loadSyncData: More than 1 sync row found."),n.length>0?n[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return Yu(t,void 0,n=>{var i;return(i=n.value)===null||i===void 0?void 0:i.options}).then(n=>n[0])})}storeClientOptions(e){var t=this;return R(function*(){var n=t.db.transaction(["client_options"],"readwrite"),i=n.objectStore("client_options");i.put({clobber:"-",options:e}),yield Vi(n)})()}saveToDeviceBatches(e){var t=this;return R(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");for(var a of e)i.add(a);yield Vi(n)})()}getOldestToDeviceBatch(){var e=this;return R(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),n=t.objectStore("to_device_queue"),i=yield Bf(n.openCursor());if(!i)return null;var a=i.value;return{id:i.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return R(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");i.delete(e),yield Vi(n)})()}destroy(){var e=this;return R(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}};o(lE,"LocalIndexedDBStoreBackend");let Kc=lE;const uE=class uE{constructor(e,t){this.workerFactory=e,this.dbName=t,f(this,"worker",void 0),f(this,"nextSeq",0),f(this,"inFlight",{}),f(this,"startPromise",void 0),f(this,"onWorkerMessage",n=>{var i=n.data;if(i.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(i.command=="cmd_success"||i.command=="cmd_fail"){if(i.seq===void 0){I.error("Got reply from worker with no seq");return}var s=this.inFlight[i.seq];if(s===void 0){I.error("Got reply for unknown seq "+i.seq);return}if(delete this.inFlight[i.seq],i.command=="cmd_success")s.resolve(i.result);else{var l=new Error(i.error.message);l.name=i.error.name,s.reject(l)}}else I.warn("Unrecognised message from worker: ",i)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return R(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return R(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{I.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var n,i=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[i]=a,(n=this.worker)===null||n===void 0||n.postMessage({command:e,seq:i,args:t}),a.promise})}destroy(){var e=this;return R(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}};o(uE,"RemoteIndexedDBStoreBackend");let Bm=uE;var JL=1e3*60*5;const dE=class dE extends Jl{static exists(e,t){return Kc.exists(e,t)}constructor(e){if(super(e),f(this,"backend",void 0),f(this,"startedUp",!1),f(this,"syncTs",0),f(this,"userModifiedMap",{}),f(this,"emitter",new Ge),f(this,"onClose",()=>{this.emitter.emit("closed")}),f(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),f(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),f(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),f(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{I.log("Deleted indexeddb data.")},t=>{throw I.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),f(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var n of this.getUsers())this.userModifiedMap[n.userId]!==n.getLastModifiedTime()&&n.events.presence&&(t.push([n.userId,n.events.presence.event]),this.userModifiedMap[n.userId]=n.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),f(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),f(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),f(this,"setOutOfBandMembers",this.degradable((t,n)=>(super.setOutOfBandMembers(t,n),this.backend.setOutOfBandMembers(t,n)),"setOutOfBandMembers")),f(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),f(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),f(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Bm(e.workerFactory,e.dbName):this.backend=new Kc(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(I.log("IndexedDBStore.startup: already started"),Promise.resolve()):(I.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(I.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{I.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[n,i]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(n);i&&a.setPresenceEvent(new qt(i)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>JL}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,i=t?super[t]:null;return R(function*(){for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];try{return yield e.call(n,...s)}catch(u){I.error("IndexedDBStore failure, degrading to MemoryStore",u),n.emitter.emit("degraded",u);try{I.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),I.log("IndexedDBStore delete after degrading succeeded")}catch(d){I.warn("IndexedDBStore delete after degrading failed",d)}if(i)return i.call(n,...s)}})}getPendingEvents(e){var t=o(()=>super.getPendingEvents,"_superprop_getGetPendingEvents"),n=this;return R(function*(){if(!n.localStorage)return t().call(n,e);var i=n.localStorage.getItem($f(e));if(i)try{return JSON.parse(i)}catch(a){I.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var n=o(()=>super.setPendingEvents,"_superprop_getSetPendingEvents"),i=this;return R(function*(){if(!i.localStorage)return n().call(i,e,t);t.length>0?i.localStorage.setItem($f(e),JSON.stringify(t)):i.localStorage.removeItem($f(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}};o(dE,"IndexedDBStore");let $m=dE;function $f(r){return"mx_pending_events_".concat(r)}o($f,"pendingEventsKey");var Yr="crypto.",$0=Yr+"migration",Wf=Yr+"account",QL=Yr+"cross_signing_keys",wd=Yr+"inboundgroupsessions/",YL=Yr+"inboundgroupsessions.withheld/",XL=Yr+"rooms/",Kf=Yr+"sessionsneedingbackup";function Na(r){return Yr+"sessions/"+r}o(Na,"keyEndToEndSessions");function Vf(r,e){return wd+r+"/"+e}o(Vf,"keyEndToEndInboundGroupSession");function ZL(r,e){return YL+r+"/"+e}o(ZL,"keyEndToEndInboundGroupSessionWithheld");function eU(r){return XL+r}o(eU,"keyEndToEndRoomsPrefix");const eh=class eh extends zs{static exists(e){for(var t=e.length,n=0;n<t;n++){var i;if((i=e.key(n))!==null&&i!==void 0&&i.startsWith(Yr))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return R(function*(){return eh.exists(e.store)})()}getMigrationState(){var e=this;return R(function*(){var t;return(t=Or(e.store,$0))!==null&&t!==void 0?t:Gs.NOT_STARTED})()}setMigrationState(e){var t=this;return R(function*(){qi(t.store,$0,e)})()}countEndToEndSessions(e,t){for(var n=0,i=0;i<this.store.length;++i){var a=this.store.key(i);if(a!=null&&a.startsWith(Na(""))){var s=Or(this.store,a);n+=Object.keys(s??{}).length}}t(n)}_getEndToEndSessions(e){var t=Or(this.store,Na(e)),n={};for(var[i,a]of Object.entries(t||{}))typeof a=="string"?n[i]={session:a}:n[i]=a;return n}getEndToEndSession(e,t,n,i){var a,s=this._getEndToEndSessions(e);i((a=s[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,n){var i;n((i=this._getEndToEndSessions(e))!==null&&i!==void 0?i:{})}storeEndToEndSession(e,t,n,i){var a=this._getEndToEndSessions(e)||{};a[t]=n,qi(this.store,Na(e),a)}getEndToEndSessionsBatch(){var e=this;return R(function*(){for(var t=[],n=0;n<e.store.length;++n){var i;if((i=e.store.key(n))!==null&&i!==void 0&&i.startsWith(Na(""))){var a=e.store.key(n).split("/")[1];for(var s of Object.values(e._getEndToEndSessions(a)))if(t.push(s),t.length>=Hs)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t._getEndToEndSessions(n)||{};delete a[i],Object.keys(a).length===0?t.store.removeItem(Na(n)):qi(t.store,Na(n),a)}})()}getEndToEndInboundGroupSession(e,t,n,i){i(Or(this.store,Vf(e,t)),Or(this.store,ZL(e,t)))}storeEndToEndInboundGroupSession(e,t,n,i){qi(this.store,Vf(e,t),n)}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){for(var t=0,n=0;n<e.store.length;++n){var i=e.store.key(n);i!=null&&i.startsWith(wd)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){for(var t=Or(e.store,Kf)||{},n=[],i=0;i<e.store.length;++i){var a=e.store.key(i);if(a!=null&&a.startsWith(wd)){var s=a.slice(wd.length);if(n.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:Or(e.store,a),needsBackup:s in t}),n.length>=Hs)return n}}return n.length===0?null:n})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:n,sessionId:i}of e){var a=Vf(n,i);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var n={},i=eU(""),a=0;a<this.store.length;++a){var s=this.store.key(a);if(s!=null&&s.startsWith(i)){var l=s.slice(i.length);n[l]=Or(this.store,s)}}t(n)}markSessionsNeedingBackup(e){var t=Or(this.store,Kf)||{};for(var n of e)t[n.senderKey+"/"+n.sessionId]=!0;return qi(this.store,Kf,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Wf),Promise.resolve()}getAccount(e,t){var n=Or(this.store,Wf);t(n)}storeAccount(e,t){qi(this.store,Wf,t)}getCrossSigningKeys(e,t){var n=Or(this.store,QL);t(n)}getSecretStorePrivateKey(e,t,n){var i=Or(this.store,Yr+"ssss_cache.".concat(n));t(i)}storeSecretStorePrivateKey(e,t,n){qi(this.store,Yr+"ssss_cache.".concat(t),n)}doTxn(e,t,n){return Promise.resolve(n(null))}};o(eh,"LocalStorageCryptoStore");let Vc=eh;function Or(r,e){try{return JSON.parse(r.getItem(e))}catch(t){I.log("Error: Failed to get key %s: %s",e,t.message),I.log(t.stack)}return null}o(Or,"getJsonItem");function qi(r,e,t){r.setItem(e,JSON.stringify(t))}o(qi,"setJsonItem");const cE=class cE{constructor(e){this.db=e,f(this,"nextTxnId",0),e.onversionchange=()=>{I.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return R(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return R(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return R(function*(){var t=Gs.NOT_STARTED;return yield e.doTxn("readonly",[Fe.STORE_ACCOUNT],n=>{var i=n.objectStore(Fe.STORE_ACCOUNT),a=i.get(Hv);a.onsuccess=()=>{var s;t=(s=a.result)!==null&&s!==void 0?s:Gs.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Fe.STORE_ACCOUNT],n=>{var i=n.objectStore(Fe.STORE_ACCOUNT);i.put(e,Hv)})})()}getAccount(e,t){var n=e.objectStore("account"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}storeAccount(e,t){var n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){var n=e.objectStore("account"),i=n.get("crossSigningKeys");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}getSecretStorePrivateKey(e,t,n){var i=e.objectStore("account"),a=i.get("ssss_cache:".concat(n));a.onsuccess=function(){try{t(a.result||null)}catch(s){ir(e,s)}}}storeSecretStorePrivateKey(e,t,n){var i=e.objectStore("account");i.put(n,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var n=e.objectStore("sessions"),i=n.count();i.onsuccess=function(){try{t(i.result)}catch(a){ir(e,a)}}}getEndToEndSessions(e,t,n){var i=t.objectStore("sessions"),a=i.index("deviceKey"),s=a.openCursor(e),l={};s.onsuccess=function(){var u=s.result;if(u)l[u.value.sessionId]={session:u.value.session,lastReceivedMessageTs:u.value.lastReceivedMessageTs},u.continue();else try{n(l)}catch(d){ir(t,d)}}}getEndToEndSession(e,t,n,i){var a=n.objectStore("sessions"),s=a.get([e,t]);s.onsuccess=function(){try{s.result?i({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):i(null)}catch(l){ir(n,l)}}}storeEndToEndSession(e,t,n,i){var a=i.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Fe.STORE_SESSIONS],n=>{var i=n.objectStore(Fe.STORE_SESSIONS),a=i.openCursor();a.onsuccess=function(){try{var s=a.result;s&&(t.push(s.value),t.length<Hs&&s.continue())}catch(l){ir(n,l)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Fe.STORE_SESSIONS],function(){var n=R(function*(i){try{var a=i.objectStore(Fe.STORE_SESSIONS),s=o(function*(){var c=a.delete([l,u]);yield new Promise(h=>{c.onsuccess=h})},"_loop");for(var{deviceKey:l,sessionId:u}of e)yield*s()}catch(d){ir(i,d)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,n,i){var a=!1,s=!1,l=n.objectStore("inbound_group_sessions"),u=l.get([e,t]);u.onsuccess=function(){try{u.result?a=u.result.session:a=null,s!==!1&&i(a,s)}catch(h){ir(n,h)}};var d=n.objectStore("inbound_group_sessions_withheld"),c=d.get([e,t]);c.onsuccess=function(){try{c.result?s=c.result.session:s=null,a!==!1&&i(a,s)}catch(h){ir(n,h)}}}storeEndToEndInboundGroupSession(e,t,n,i){var a=i.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:n})}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){var t=0;return yield e.doTxn("readonly",[Fe.STORE_INBOUND_GROUP_SESSIONS],n=>{var i=n.objectStore(Fe.STORE_INBOUND_GROUP_SESSIONS),a=i.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Fe.STORE_INBOUND_GROUP_SESSIONS,Fe.STORE_BACKUP],n=>{var i=n.objectStore(Fe.STORE_INBOUND_GROUP_SESSIONS),a=n.objectStore(Fe.STORE_BACKUP),s=i.openCursor();s.onsuccess=function(){try{var l=s.result;if(l){var u=a.get(l.key);u.onsuccess=()=>{t.push({senderKey:l.value.senderCurve25519Key,sessionId:l.value.sessionId,sessionData:l.value.session,needsBackup:u.result!==void 0}),t.length<Hs&&l.continue()}}}catch(d){ir(n,d)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Fe.STORE_INBOUND_GROUP_SESSIONS],function(){var n=R(function*(i){try{var a=i.objectStore(Fe.STORE_INBOUND_GROUP_SESSIONS),s=o(function*(){var c=a.delete([l,u]);yield new Promise(h=>{c.onsuccess=h})},"_loop2");for(var{senderKey:l,sessionId:u}of e)yield*s()}catch(d){ir(i,d)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var n=e.objectStore("device_data"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){ir(e,a)}}}getEndToEndRooms(e,t){var n={},i=e.objectStore("rooms"),a=i.openCursor();a.onsuccess=function(){var s=a.result;if(s)n[s.key]=s.value,s.continue();else try{t(n)}catch(l){ir(e,l)}}}markSessionsNeedingBackup(e,t){var n=this;return R(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var i=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((s,l)=>{var u=i.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});u.onsuccess=s,u.onerror=l})))})()}doTxn(e,t,n){var i=this.db.transaction(t,e),a=nU(i),s=n(i);return a.then(()=>s)}};o(cE,"Backend");let Wm=cE;var nC=[r=>{rU(r)},r=>{r.createObjectStore("account")},r=>{var e=r.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},r=>{r.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("device_data")},r=>{r.createObjectStore("rooms")},r=>{r.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{var e=r.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),r.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},r=>{r.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r=>{r.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],iC=nC.length;function tU(r,e){I.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(iC)),nC.forEach((t,n)=>{e<=n&&t(r)})}o(tU,"upgradeDatabase");function rU(r){var e=r.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}o(rU,"createDatabase");function ir(r,e){r._mx_abortexception=e;try{r.abort()}catch{}}o(ir,"abortWithException");function nU(r){return new Promise((e,t)=>{r.oncomplete=()=>{r._mx_abortexception!==void 0&&t(r._mx_abortexception),e(null)},r.onerror=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(I.log("Error performing indexeddb txn",n),t(r.error))},r.onabort=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(I.log("Error performing indexeddb txn",n),t(r.error))}})}o(nU,"promiseifyTxn");const ui=class ui{static exists(e,t){return eC(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((n,i)=>{var a=!0,s=e.open(t);s.onupgradeneeded=()=>{a=!1},s.onblocked=()=>i(s.error),s.onsuccess=()=>{var l=s.result;if(!a)l.close(),e.deleteDatabase(t),n(!1);else{var u=l.transaction([ui.STORE_ACCOUNT],"readonly"),d=u.objectStore(ui.STORE_ACCOUNT),c=d.get(Hv);c.onsuccess=()=>{var h,v=(h=c.result)!==null&&h!==void 0?h:Gs.NOT_STARTED;n(v===Gs.NOT_STARTED)},c.onerror=()=>{i(c.error)},l.close()}},s.onerror=()=>i(s.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,f(this,"backendPromise",void 0),f(this,"backend",void 0)}containsData(){var e=this;return R(function*(){return ui.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}I.log("connecting to indexeddb ".concat(this.dbName));var n=this.indexedDB.open(this.dbName,iC);n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;tU(a,s)},n.onblocked=()=>{I.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{I.log("Error connecting to indexeddb",i),t(n.error)},n.onsuccess=()=>{var i=n.result;I.log("connected to indexeddb ".concat(this.dbName)),e(new Wm(i))}}).then(e=>e.doTxn("readonly",[ui.STORE_INBOUND_GROUP_SESSIONS,ui.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw I.warn("Crypto DB is too new for us to use!",e),new Vl(ly.TooNew);I.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new Vc(globalThis.localStorage)}catch(t){return I.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new zs}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}I.log("Removing indexeddb instance: ".concat(this.dbName));var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{I.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{I.log("Error deleting data from indexeddb",i),t(n.error)},n.onsuccess=()=>{I.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{I.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}};o(ui,"IndexedDBCryptoStore");let Fe=ui;f(Fe,"STORE_ACCOUNT","account");f(Fe,"STORE_SESSIONS","sessions");f(Fe,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");f(Fe,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");f(Fe,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");f(Fe,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");f(Fe,"STORE_DEVICE_DATA","device_data");f(Fe,"STORE_ROOMS","rooms");f(Fe,"STORE_BACKUP","sessions_needing_backup");var iU=function(r){return r.Email="email",r.Phone="msisdn",r}({}),aU=new pt("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),sU=function(r){return r.Gitlab="gitlab",r.Github="github",r.Apple="apple",r.Google="google",r.Facebook="facebook",r.Twitter="twitter",r}({}),oU=function(r){return r.LOGIN="login",r.REGISTER="register",r}({}),lU="us.cloke.msc4175.tz";const hE=class hE{constructor(e){f(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}};o(hE,"RelatedRelations");let Km=hE;var uU=function(r){return r.Global="Global",r.SetItemError="setItem",r.GetItemError="getItem",r.RemoveItemError="removeItem",r.ClearError="clear",r.QuotaExceededError="QuotaExceededError",r}({});const fE=class fE extends Ge{};o(fE,"LocalStorageErrorsEventsEmitter");let Vm=fE;var dU=new Vm,aC=o(()=>new zs,"cryptoStoreFactory");function sC(r){aC=r}o(sC,"setCryptoStoreFactory");function oC(r){var e,t,n;return r.store=(e=r.store)!==null&&e!==void 0?e:new Jl({localStorage:globalThis.localStorage}),r.scheduler=(t=r.scheduler)!==null&&t!==void 0?t:new Kl,r.cryptoStore=(n=r.cryptoStore)!==null&&n!==void 0?n:aC(),r}o(oC,"amendClientOpts");function qm(r){return new Zs(oC(r))}o(qm,"createClient");function cU(r,e,t,n){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new Bc(r,e,t,oC(n),i)}o(cU,"createRoomWidgetClient");const hU=Object.freeze(Object.defineProperty({__proto__:null,AuthType:jm,AutoDiscovery:Et,AutoDiscoveryAction:Er,AutoDiscoveryError:jr,Beacon:vc,BeaconEvent:Je,CallEvent:Oe,CallFeedEvent:an,Category:In,ClientEvent:de,ClientPrefix:wt,ClientStoppedError:Em,ConditionKind:gt,ConditionOperator:J1,ConnectionError:qn,ContentHelpers:$D,DELEGATED_OIDC_COMPATIBILITY:aU,DEVICE_CODE_SCOPE:HN,DMMemberCountCondition:Q1,DebugLogger:Jv,Device:Lm,DeviceVerification:ZI,Direction:Ie,DuplicateStrategy:nl,EVENT_VISIBILITY_CHANGE_TYPE:ia,EventEmitterEvents:xR,EventStatus:Se,EventTimeline:he,EventTimelineSet:pi,EventType:B,FILTER_RELATED_BY_REL_TYPES:hs,FILTER_RELATED_BY_SENDERS:cs,FeatureSupport:Wt,Filter:sr,GET_LOGIN_TOKEN_CAPABILITY:XN,GroupCall:Fl,GroupCallEvent:Ve,GroupCallIntent:RI,GroupCallState:rt,GroupCallStatsReportEvent:Ko,GroupCallType:Mh,GuestAccess:Ic,HTTPError:Vn,HistoryVisibility:sy,HttpApiEvent:Pp,IdentityPrefix:Rn,IdentityProviderBrand:sU,IndexedDBCryptoStore:Fe,IndexedDBStore:$m,InteractiveAuth:Fm,InvalidCryptoStoreError:Vl,InvalidCryptoStoreState:ly,JoinRule:II,KNOWN_SAFE_ROOM_VERSION:vI,KeySignatureUploadError:Sm,KnownMembership:Te,LOCAL_NOTIFICATION_SETTINGS_PREFIX:UR,LocalStorageCryptoStore:Vc,LocalStorageErrors:uU,LocationAssetType:Vs,MAIN_ROOM_TIMELINE:ou,MAXIMUM_MATRIX_VERSION:nN,MINIMUM_MATRIX_VERSION:rN,MSC3912_RELATION_BASED_REDACTIONS_PROP:Zv,M_ASSET:au,M_BEACON:cm,M_BEACON_INFO:oy,M_HTML:DD,M_LOCATION:su,M_MESSAGE:xD,M_POLL_END:mc,M_POLL_KIND_DISCLOSED:KD,M_POLL_KIND_UNDISCLOSED:VD,M_POLL_RESPONSE:Nl,M_POLL_START:qD,M_TEXT:Qg,M_TIMESTAMP:Ui,M_TOPIC:Yg,MatrixClient:Zs,MatrixError:dt,MatrixEvent:qt,MatrixEventEvent:Le,MatrixHttpApi:Ec,MatrixScheduler:Kl,MediaHandlerEvent:Qi,MediaPrefix:ls,MemoryCryptoStore:zs,MemoryStore:Jl,Method:G,MsgType:bn,NoAuthFlowFoundError:Wc,NotificationCountType:De,OidcError:Vt,OidcTokenRefresher:Am,PUSHER_DEVICE_ID:rA,PUSHER_ENABLED:ep,PendingEventOrdering:Xs,Poll:gc,PollEvent:oi,Preset:ay,ProfileKeyMSC4175Timezone:lU,PushRuleActionName:Ii,PushRuleKind:xt,REFERENCE_RELATION:YR,ReceiptType:Xt,RelatedRelations:Km,RelationType:Xe,Relations:xl,RelationsEvent:md,RestrictedAllowType:aN,Room:Js,RoomCreateTypeField:tc,RoomEvent:ue,RoomMember:ga,RoomMemberEvent:ur,RoomNameType:nn,RoomState:zl,RoomStateEvent:ke,RoomSummary:uc,RoomType:ss,RoomVersionStability:fI,RoomWidgetClient:Bc,RoomWidgetClientEvent:bd,RuleId:Mt,SERVICE_TYPES:rm,SSOAction:oU,SUPPORTED_MATRIX_VERSIONS:Wl,SearchOrderBy:CI,SearchResult:Rc,SecretStorage:mN,ServerCapabilities:_c,SetPresence:pI,SlidingSyncEvent:am,StatsReport:Nn,SyncAccumulator:$c,SyncState:Ue,THREAD_RELATION_TYPE:We,Thread:yt,ThreadEvent:Zt,ThreadFilterType:Wr,ThreepidMedium:iU,TimelineIndex:Xl,TimelineWindow:Um,ToDeviceMessageId:Rh,TokenRefreshError:Sc,TokenRefreshLogoutError:Ll,TweakName:ny,TypedEventEmitter:Ge,UNSIGNED_MEMBERSHIP_FIELD:jR,UNSIGNED_THREAD_ID_FIELD:rc,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:LR,UNSTABLE_MSC2666_MUTUAL_ROOMS:qI,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:GI,UNSTABLE_MSC2666_SHARED_ROOMS:VI,UNSTABLE_MSC2716_MARKER:NR,UNSTABLE_MSC3088_ENABLED:Yv,UNSTABLE_MSC3088_PURPOSE:Qv,UNSTABLE_MSC3089_BRANCH:Pn,UNSTABLE_MSC3089_LEAF:DR,UNSTABLE_MSC3089_TREE_SUBTYPE:Xv,UNSTABLE_MSC3852_LAST_SEEN_UA:YN,UNSTABLE_MSC4133_EXTENDED_PROFILES:HI,UNSTABLE_MSC4140_DELAYED_EVENTS:cn,UnsupportedDelayedEventsEndpointError:vn,UpdateDelayedEventAction:gd,User:Fn,UserEvent:yr,Visibility:iN,anySignal:cI,calculateRetryBackoff:hI,completeAuthorizationCodeGrant:GN,createClient:qm,createNewMatrixCall:Bl,createRoomWidgetClient:cU,decodeBase64:ua,decodeIdToken:BI,determineFeatureSupport:Ed,discoverAndValidateOIDCIssuerWellKnown:fy,encodeBase64:il,encodeUnpaddedBase64:TI,encodeUnpaddedBase64Url:Ph,fixNotificationCountOnDecryption:zI,generateAuthorizationParams:WN,generateAuthorizationUrl:KN,generateOidcAuthorizationUrl:VN,generateScope:Dh,getBeaconInfoIdentifier:fc,getHttpUriForMxc:bh,inMainTimelineForReceipt:Hl,isDmMemberCountCondition:Y1,isEventTypeSame:ND,isPollEvent:uI,isTimestampInDuration:bp,localStorageErrorsEventsEmitter:dU,parseErrorResponse:ey,registerOidcClient:zN,retryNetworkOperation:Mp,safeGetRetryAfterMs:Zg,setCryptoStoreFactory:sC,threadFilterTypeToFilter:JI,threadIdForReceipt:eo,timeoutSignal:kh,validateAuthMetadata:FI,validateAuthMetadataAndKeys:vy,validateBearerTokenResponse:KI,validateIdToken:$I,validateStoredUserState:WI},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var Gm;try{Gm=globalThis.indexedDB}catch{}Gm&&sC(()=>new Fe(Gm,"matrix-js-sdk:crypto"));globalThis.matrixcs=hU;function fU(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}o(fU,"readJSON");function vU(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)/i);return r?decodeURIComponent(r[1]):null}o(vU,"parseOrgIdFromHash");const pU=o(()=>new Date().toLocaleTimeString(),"ts"),W0=o(()=>Math.random().toString(36).slice(2)+Date.now().toString(36),"randId");function mU(){const e=so().orgId||vU(),t=fU(`bf_matrix_${e}`,null),[n,i]=W.useState((t==null?void 0:t.hsUrl)||""),[a,s]=W.useState(""),[l,u]=W.useState(""),[d,c]=W.useState((t==null?void 0:t.userId)||""),[h,v]=W.useState((t==null?void 0:t.accessToken)||""),[g,p]=W.useState((t==null?void 0:t.deviceId)||""),[m,T]=W.useState(""),[y,S]=W.useState(!1),[w,C]=W.useState(!1),[M,_]=W.useState([]),[O,b]=W.useState(null),[F,V]=W.useState([]),[z,ie]=W.useState(""),se=W.useRef(null),Pe=o((...j)=>T(`[${pU()}] ${j.join(" ")}`),"log"),Ce=!!(t!=null&&t.hsUrl&&d&&h);W.useEffect(()=>{if(!(t!=null&&t.hsUrl)||!d||!h)return;const j=qm({baseUrl:t.hsUrl,accessToken:h,userId:d,deviceId:g||void 0});return se.current=j,Pe("Connecting"),(async()=>{try{typeof j.initRustCrypto=="function"?(await j.initRustCrypto({useIndexedDB:!0,storageKey:`bf_chat_${e||"global"}`}),C(!0)):typeof j.initCrypto=="function"?(await j.initCrypto(),C(!0)):(C(!1),Pe("Crypto init not available in this build"))}catch(N){C(!1),Pe("Crypto init failed:",(N==null?void 0:N.message)||N)}j.on("sync",N=>{N==="PREPARED"&&(S(!0),Q())}),j.on("Room.timeline",(N,D,x)=>{x||!O||D.roomId!==O||N.getType()==="m.room.message"&&V(A=>{var P,L;return[...A,{id:N.getId()||W0(),body:((P=N.getContent())==null?void 0:P.body)||"",sender:N.getSender(),ts:N.getTs(),encrypted:!!((L=N.isEncrypted)!=null&&L.call(N))}]})}),j.startClient({initialSyncLimit:30});function Q(){var D,x;const N=(((D=j.getVisibleRooms)==null?void 0:D.call(j))||((x=j.getRooms)==null?void 0:x.call(j))||[]).filter(A=>{var P;return["join","invite"].includes(((P=A.getMyMembership)==null?void 0:P.call(A))||"")}).sort((A,P)=>{var L,k;return(((L=P.getLastActiveTimestamp)==null?void 0:L.call(P))||0)-(((k=A.getLastActiveTimestamp)==null?void 0:k.call(A))||0)});_(N.map(A=>{var P,L;return{id:A.roomId,name:A.name||((P=A.getCanonicalAlias)==null?void 0:P.call(A))||A.roomId,encrypted:!!((L=A.isEncrypted)!=null&&L.call(A))}}))}o(Q,"refreshRooms")})(),()=>{try{j.stopClient(),j.removeAllListeners()}catch{}}},[t==null?void 0:t.hsUrl,d,h,g,e,O]);const $e=o(async j=>{j.preventDefault();try{const Q=n.trim(),N=a.trim(),x=await qm({baseUrl:Q}).login("m.login.password",{identifier:{type:"m.id.user",user:N},password:l});c(x.user_id),v(x.access_token),p(x.device_id||""),localStorage.setItem(`bf_matrix_${e}`,JSON.stringify({hsUrl:Q,userId:x.user_id,accessToken:x.access_token,deviceId:x.device_id||""})),u(""),window.location.hash=window.location.hash}catch(Q){Pe("Login failed:",(Q==null?void 0:Q.message)||"Unknown error")}},"login"),re=o(()=>{try{localStorage.removeItem(`bf_matrix_${e}`)}catch{}if(c(""),v(""),p(""),S(!1),C(!1),_([]),b(null),V([]),ie(""),se.current){try{se.current.stopClient(),se.current.removeAllListeners()}catch{}se.current=null}Pe("Logged out")},"logout"),Y=o(async j=>{var A,P,L;b(j),V([]);const Q=se.current;if(!Q)return;const N=(A=Q.getRoom)==null?void 0:A.call(Q,j);if(!N)return;const D=(P=N.getLiveTimeline)==null?void 0:P.call(N),x=(((L=D==null?void 0:D.getEvents)==null?void 0:L.call(D))||[]).filter(k=>k.getType()==="m.room.message");V(x.map(k=>{var $,U;return{id:k.getId()||W0(),body:(($=k.getContent())==null?void 0:$.body)||"",sender:k.getSender(),ts:k.getTs(),encrypted:!!((U=k.isEncrypted)!=null&&U.call(k))}}))},"selectRoom"),le=o(async j=>{j.preventDefault();const Q=se.current;if(!(!Q||!O||!z.trim()))try{await Q.sendEvent(O,"m.room.message",{msgtype:"m.text",body:z.trim()},""),ie("")}catch(N){Pe("Send failed:",(N==null?void 0:N.message)||"Unknown error")}},"send"),me=o(async()=>{var Q,N;const j=se.current;if(j)try{const D=((Q=j.getCrypto)==null?void 0:Q.call(j))||j.crypto;await((N=D==null?void 0:D.requestRoomKey)==null?void 0:N.call(D)),Pe("Key re-request sent")}catch(D){Pe("Failed to re-request keys:",(D==null?void 0:D.message)||D)}},"reRequestKeys"),we=W.useMemo(()=>M.find(j=>j.id===O)||null,[M,O]);return E.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[E.jsxs("header",{style:{display:"flex",alignItems:"center",gap:8,marginTop:0,borderBottom:"1px solid #222",paddingBottom:12},children:[E.jsx("button",{className:"btn",onClick:re,children:"Logout"}),E.jsx("button",{className:"btn",onClick:me,children:"Re-request keys"}),E.jsx("div",{className:"helper",style:{marginLeft:"auto"},children:m})]}),Ce&&E.jsxs("div",{className:"helper",style:{marginTop:8},children:[E.jsx("strong",{children:"Signed in as:"})," ",d,"  ",E.jsx("strong",{children:"Device:"})," ",g||"(loading)"," ",w?"":"",!w&&E.jsx("div",{style:{marginTop:6},children:"This session is not E2EE-capable yet. If you see this, the crypto WASM dependency is missing or failed to load."}),w&&E.jsxs("div",{style:{marginTop:6},children:["Verification happens in Element: open ",E.jsx("em",{children:"Settings  Sessions"}),", find ",E.jsx("strong",{children:g||"this"})," device, and verify it there."]})]}),Ce?E.jsx(E.Fragment,{children:E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"280px 1fr",gap:12,marginTop:12},children:[E.jsxs("aside",{className:"card",style:{padding:12,minHeight:420},children:[E.jsxs("h3",{className:"section-title",style:{marginTop:0},children:["Rooms ",y?"":"(loading)"]}),E.jsxs("ul",{style:{paddingLeft:18},children:[M.map(j=>E.jsx("li",{children:E.jsxs("a",{href:"#",onClick:o(Q=>{Q.preventDefault(),Y(j.id)},"onClick"),children:[j.name,j.encrypted?" ":""]})},j.id)),M.length===0&&E.jsx("li",{className:"helper",children:"No rooms yet."})]})]}),E.jsxs("main",{className:"card",style:{padding:12,minHeight:420,display:"flex",flexDirection:"column"},children:[E.jsxs("h3",{className:"section-title",style:{marginTop:0,marginBottom:8},children:[we?we.name:"Select a room",we!=null&&we.encrypted?" ":""]}),E.jsx("div",{style:{flex:1,overflow:"auto",border:"1px solid #222",borderRadius:8,padding:8},children:F.length===0?E.jsx("div",{className:"helper",children:"No messages yet."}):F.sort((j,Q)=>j.ts-Q.ts).map(j=>E.jsxs("div",{style:{marginBottom:8},children:[E.jsxs("div",{style:{fontSize:12,color:"#6b7280"},children:[j.sender,"  ",new Date(j.ts).toLocaleString()," ",j.encrypted?"":""]}),E.jsx("div",{children:j.body})]},j.id))}),E.jsxs("form",{onSubmit:le,className:"row",style:{gap:8,marginTop:8},children:[E.jsx("input",{className:"input",placeholder:we?"Type a message":"Pick a room first",value:z,onChange:o(j=>ie(j.target.value),"onChange"),disabled:!we}),E.jsx("button",{className:"btn",disabled:!we||!z.trim(),children:"Send"})]})]})]})}):E.jsxs("section",{className:"card",style:{marginTop:12,padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Sign in to your Matrix homeserver"}),E.jsxs("form",{onSubmit:$e,className:"grid",style:{gap:8,maxWidth:520},children:[E.jsx("input",{className:"input",placeholder:"Homeserver base URL (e.g. https://matrix.org)",value:n,onChange:o(j=>i(j.target.value),"onChange"),required:!0}),E.jsx("input",{className:"input",placeholder:"Username (localpart, without @ and domain)",value:a,onChange:o(j=>s(j.target.value),"onChange"),required:!0}),E.jsx("input",{className:"input",type:"password",placeholder:"Password",value:l,onChange:o(j=>u(j.target.value),"onChange"),required:!0}),E.jsx("button",{className:"btn",children:"Login"})]})]})]})}o(mU,"BondfireChat");function gU(){const r=ao(),e=_n(),t=new URLSearchParams(e.search).get("next")||"/orgs",[n,i]=W.useState("login"),[a,s]=W.useState(""),[l,u]=W.useState(""),[d,c]=W.useState(""),[h,v]=W.useState("Bondfire"),[g,p]=W.useState(""),[m,T]=W.useState(!1);async function y(w){var C;w.preventDefault(),p(""),T(!0);try{const O=await fetch(n==="register"?"/api/auth/register":"/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n==="register"?{email:a,password:l,name:d,orgName:h}:{email:a,password:l})}),b=await O.json().catch(()=>({}));if(!O.ok||!(b!=null&&b.ok)||!(b!=null&&b.token))throw new Error((b==null?void 0:b.error)||(n==="register"?"Register failed":"Login failed"));if(localStorage.setItem("bf_auth_token",b.token),sessionStorage.removeItem("bf_auth_token"),localStorage.removeItem("demo_user"),n==="register"&&((C=b==null?void 0:b.org)!=null&&C.id)){localStorage.setItem("bf_orgs",JSON.stringify([b.org])),r(`/org/${b.org.id}`,{replace:!0});return}const F=await fetch("/api/orgs",{headers:{Authorization:`Bearer ${b.token}`}}),V=await F.json().catch(()=>({}));F.ok&&(V!=null&&V.ok)&&Array.isArray(V.orgs)&&localStorage.setItem("bf_orgs",JSON.stringify(V.orgs)),r("/orgs",{replace:!0})}catch(M){p(typeof M=="string"?M:(M==null?void 0:M.message)||"Auth failed")}finally{T(!1)}}o(y,"handleSubmit");function S(){localStorage.setItem("demo_user","true"),localStorage.removeItem("bf_auth_token"),r(t,{replace:!0})}return o(S,"handleDemo"),E.jsxs("div",{style:{maxWidth:520,margin:"8vh auto",padding:16},children:[E.jsx("h1",{style:{marginBottom:6},children:"Welcome to Bondfire"}),E.jsx("p",{className:"helper",style:{marginTop:0},children:n==="login"?"Sign in to continue, or try the demo mode.":"Create your account and your first org."}),E.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[E.jsx("button",{type:"button",className:n==="login"?"btn-red":"btn",onClick:o(()=>{p(""),i("login")},"onClick"),disabled:m,children:"Sign in"}),E.jsx("button",{type:"button",className:n==="register"?"btn-red":"btn",onClick:o(()=>{p(""),i("register")},"onClick"),disabled:m,children:"Create account"})]}),E.jsxs("form",{onSubmit:y,className:"grid",style:{gap:10,marginTop:12},children:[n==="register"&&E.jsxs(E.Fragment,{children:[E.jsx("input",{className:"input",type:"text",placeholder:"Name",value:d,onChange:o(w=>c(w.target.value),"onChange"),autoFocus:!0}),E.jsx("input",{className:"input",type:"text",placeholder:"Org name",value:h,onChange:o(w=>v(w.target.value),"onChange"),required:!0})]}),E.jsx("input",{className:"input",type:"email",placeholder:"Email",value:a,onChange:o(w=>s(w.target.value),"onChange"),required:!0,autoFocus:n==="login"}),E.jsx("input",{className:"input",type:"password",placeholder:"Password",value:l,onChange:o(w=>u(w.target.value),"onChange"),required:!0}),E.jsx("button",{className:"btn",disabled:m,children:m?"Working":n==="login"?"Sign in":"Create account"})]}),g&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:g}),E.jsx("div",{style:{marginTop:14,display:"flex",gap:8},children:E.jsx("button",{type:"button",className:"btn",onClick:S,disabled:m,children:"Continue as demo"})})]})}o(gU,"SignIn");function lC(){const{pathname:r=""}=_n(),e=r.match(/\/org\/([^/]+)/i);return e?decodeURIComponent(e[1]):null}o(lC,"useOrgIdFromPath");const yU=o(({logoSrc:r="/logo-bondfire.png"})=>{const e=lC(),t=e?`/org/${e}/overview`:"/orgs";return E.jsxs(Hg,{to:t,className:"brand",style:{display:"flex",alignItems:"center",gap:10,textDecoration:"none"},children:[E.jsx("img",{src:r,alt:"Bondfire",width:28,height:28,onError:o(n=>{n.currentTarget.style.display="none"},"onError"),style:{display:"block"}}),E.jsx("span",{style:{color:"var(--bfBrand, #fff)",fontWeight:700},children:"Bondfire"})]})},"Brand");function SU(){const r=lC();if(!r)return null;const e=`/org/${r}`,t={padding:"8px 12px",borderRadius:8,background:"#a40b12",color:"#fff",border:"1px solid #7a0c12",textDecoration:"none",fontWeight:500,transition:"background 0.2s ease, transform 0.1s ease"},n={background:"#8e0a10"},i={background:"#cc0f1a",fontWeight:700};return E.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginRight:12},children:[["Dashboard",`${e}/overview`],["People",`${e}/people`],["Inventory",`${e}/inventory`],["Needs",`${e}/needs`],["Meetings",`${e}/meetings`],["Settings",`${e}/settings`],["Public",`${e}/public`],["Chat",`${e}/chat`]].map(([a,s])=>E.jsx(WP,{to:s,className:"btn",style:o(({isActive:l})=>({...t,...l?i:{}}),"style"),onMouseEnter:o(l=>Object.assign(l.currentTarget.style,n),"onMouseEnter"),onMouseLeave:o(l=>Object.assign(l.currentTarget.style,t),"onMouseLeave"),children:a},s))})}o(SU,"OrgNav");function EU({onLogout:r,showLogout:e}){return E.jsxs("header",{style:{position:"sticky",top:0,zIndex:30,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 14px",borderBottom:"1px solid #1f2937",background:"#0f0f10"},children:[E.jsx(yU,{}),E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx(SU,{}),e&&E.jsx("button",{onClick:r,className:"btn",style:{padding:"8px 12px",borderRadius:8,background:"#a40b12",color:"#fff",border:"1px solid #7a0c12",cursor:"pointer",transition:"background 0.2s ease, transform 0.1s ease"},onMouseEnter:o(t=>t.currentTarget.style.background="#8e0a10","onMouseEnter"),onMouseLeave:o(t=>t.currentTarget.style.background="#a40b12","onMouseLeave"),title:"Logout",children:"Logout"})]})]})}o(EU,"AppHeader");function _U({children:r}){var i,a;if(!((((a=(i=import.meta)==null?void 0:i.env)==null?void 0:a.VITE_REQUIRE_ORG_SECRET)||"off")==="on"))return r;const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=localStorage.getItem("bf_org_secret");return t&&n?r:E.jsx(Gg,{to:"/signin",replace:!0})}o(_U,"OrgSecretGuard");const vE=class vE extends Xm.Component{constructor(e){super(e),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,t){console.error("App error boundary:",e),console.error("App error boundary stack:",e==null?void 0:e.stack),console.error("App error boundary component stack:",t==null?void 0:t.componentStack)}render(){return this.state.error?E.jsxs("div",{style:{padding:16},children:[E.jsx("h2",{style:{color:"crimson"},children:"Something broke."}),E.jsx("pre",{style:{whiteSpace:"pre-wrap"},children:String(this.state.error)})]}):this.props.children}};o(vE,"ErrorBoundary");let Hm=vE;function uC(){return localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token")}o(uC,"getToken");function bU({children:r}){const e=uC(),t=localStorage.getItem("demo_user");return!e&&!t?E.jsx(Gg,{to:"/signin",replace:!0}):r}o(bU,"RequireAuth");function wU(){try{localStorage.removeItem("bf_auth_token"),sessionStorage.removeItem("bf_auth_token"),localStorage.removeItem("demo_user")}catch{}window.location.hash="#/signin",window.location.reload()}o(wU,"logoutEverywhere");function TU(){const r=_n(),e=uC(),t=r.pathname||"/",n=t==="/"||t==="/orgs"||t.startsWith("/p/")||t==="/signin";if(!e||n)return null;const i={position:"fixed",top:10,left:140,zIndex:1e3,padding:"6px 10px",fontSize:12,borderRadius:8,background:"#111",color:"#eee",border:"1px solid #333",cursor:"pointer",opacity:.9};return E.jsx("button",{title:"Logout",style:i,onClick:wU,children:"Logout"})}o(TU,"GlobalLogoutButton");function RU(){const e=_n().pathname||"/",t=e==="/"||e==="/orgs"||e.startsWith("/p/")||e==="/signin";return E.jsxs(E.Fragment,{children:[!t&&E.jsx(EU,{}),E.jsx(TU,{}),E.jsxs(MP,{children:[E.jsx(bt,{path:"/p/:slug",element:E.jsx(Qd,{})}),E.jsx(bt,{path:"/p/*",element:E.jsx(Qd,{})}),E.jsx(bt,{path:"/signin",element:E.jsx(gU,{})}),E.jsx(bt,{path:"/",element:E.jsx(D_,{})}),E.jsx(bt,{path:"/orgs",element:E.jsx(D_,{})}),E.jsxs(bt,{path:"/org/:orgId/*",element:E.jsx(bU,{children:E.jsx(iM,{})}),children:[E.jsx(bt,{index:!0,element:E.jsx(A_,{})}),E.jsx(bt,{path:"overview",element:E.jsx(A_,{})}),E.jsx(bt,{path:"people",element:E.jsx(sM,{})}),E.jsx(bt,{path:"inventory",element:E.jsx(lM,{})}),E.jsx(bt,{path:"needs",element:E.jsx(vM,{})}),E.jsx(bt,{path:"meetings",element:E.jsx(dM,{})}),E.jsx(bt,{path:"meetings/:meetingId",element:E.jsx(hM,{})}),E.jsx(bt,{path:"settings",element:E.jsx(gM,{})}),E.jsx(bt,{path:"public",element:E.jsx(XP,{})}),E.jsx(bt,{path:"chat",element:E.jsx(mU,{})}),E.jsx(bt,{path:"guard/*",element:E.jsx(_U,{})})]}),E.jsx(bt,{path:"*",element:E.jsx(Gg,{to:"/orgs",replace:!0})})]})]})}o(RU,"Shell");function IU(){return E.jsx(FP,{children:E.jsx(Hm,{children:E.jsx(RU,{})})})}o(IU,"App");const dC=new Date().toISOString()+" #"+Math.floor(Math.random()*1e6);console.log("BOND build:",dC);window.__BF_BUILD=dC;tR(document.getElementById("root")).render(E.jsx(Xm.StrictMode,{children:E.jsx(IU,{})}));export{o0 as A,xU as B,Pt as C,hN as D,B as E,Fe as F,Gs as G,sy as H,PU as I,vN as J,Te as K,eb as L,G as M,Yi as S,Ge as T,l0 as U,R as _,f as a,kU as b,Rh as c,ua as d,ne as e,hI as f,th as g,ZI as h,Lm as i,Ai as j,bn as k,OU as l,dt as m,wt as n,Em as o,il as p,bh as q,u0 as r,uu as s,MU as t,Ri as u,Le as v,Jr as w,Fc as x,s0 as y,AU as z};
//# sourceMappingURL=index-5aTWFmy-.js.map
