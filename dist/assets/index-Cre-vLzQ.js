var cC=Object.defineProperty;var o=(r,e)=>cC(r,"name",{value:e,configurable:!0});function hC(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const i in n)if(i!=="default"&&!(i in r)){const a=Object.getOwnPropertyDescriptor(n,i);a&&Object.defineProperty(r,i,a.get?a:{enumerable:!0,get:o(()=>n[i],"get")})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}o(hC,"_mergeNamespaces");o(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}o(t,"getFetchOpts");function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}o(n,"processPreload")},"polyfill")();var fC=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function nh(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}o(nh,"getDefaultExportFromCjs");var V0={exports:{}},ih={},G0={exports:{}},Le={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var eu=Symbol.for("react.element"),vC=Symbol.for("react.portal"),pC=Symbol.for("react.fragment"),mC=Symbol.for("react.strict_mode"),gC=Symbol.for("react.profiler"),yC=Symbol.for("react.provider"),SC=Symbol.for("react.context"),EC=Symbol.for("react.forward_ref"),_C=Symbol.for("react.suspense"),bC=Symbol.for("react.memo"),wC=Symbol.for("react.lazy"),yE=Symbol.iterator;function TC(r){return r===null||typeof r!="object"?null:(r=yE&&r[yE]||r["@@iterator"],typeof r=="function"?r:null)}o(TC,"A$1");var q0={isMounted:o(function(){return!1},"isMounted"),enqueueForceUpdate:o(function(){},"enqueueForceUpdate"),enqueueReplaceState:o(function(){},"enqueueReplaceState"),enqueueSetState:o(function(){},"enqueueSetState")},H0=Object.assign,z0={};function no(r,e,t){this.props=r,this.context=e,this.refs=z0,this.updater=t||q0}o(no,"E$1");no.prototype.isReactComponent={};no.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")};no.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function J0(){}o(J0,"F");J0.prototype=no.prototype;function Ym(r,e,t){this.props=r,this.context=e,this.refs=z0,this.updater=t||q0}o(Ym,"G$1");var Xm=Ym.prototype=new J0;Xm.constructor=Ym;H0(Xm,no.prototype);Xm.isPureReactComponent=!0;var SE=Array.isArray,Q0=Object.prototype.hasOwnProperty,Zm={current:null},Y0={key:!0,ref:!0,__self:!0,__source:!0};function X0(r,e,t){var n,i={},a=null,s=null;if(e!=null)for(n in e.ref!==void 0&&(s=e.ref),e.key!==void 0&&(a=""+e.key),e)Q0.call(e,n)&&!Y0.hasOwnProperty(n)&&(i[n]=e[n]);var l=arguments.length-2;if(l===1)i.children=t;else if(1<l){for(var u=Array(l),d=0;d<l;d++)u[d]=arguments[d+2];i.children=u}if(r&&r.defaultProps)for(n in l=r.defaultProps,l)i[n]===void 0&&(i[n]=l[n]);return{$$typeof:eu,type:r,key:a,ref:s,props:i,_owner:Zm.current}}o(X0,"M$1");function RC(r,e){return{$$typeof:eu,type:r.type,key:e,ref:r.ref,props:r.props,_owner:r._owner}}o(RC,"N$1");function eg(r){return typeof r=="object"&&r!==null&&r.$$typeof===eu}o(eg,"O$1");function IC(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}o(IC,"escape");var EE=/\/+/g;function Kh(r,e){return typeof r=="object"&&r!==null&&r.key!=null?IC(""+r.key):e.toString(36)}o(Kh,"Q$1");function Zu(r,e,t,n,i){var a=typeof r;(a==="undefined"||a==="boolean")&&(r=null);var s=!1;if(r===null)s=!0;else switch(a){case"string":case"number":s=!0;break;case"object":switch(r.$$typeof){case eu:case vC:s=!0}}if(s)return s=r,i=i(s),r=n===""?"."+Kh(s,0):n,SE(i)?(t="",r!=null&&(t=r.replace(EE,"$&/")+"/"),Zu(i,e,t,"",function(d){return d})):i!=null&&(eg(i)&&(i=RC(i,t+(!i.key||s&&s.key===i.key?"":(""+i.key).replace(EE,"$&/")+"/")+r)),e.push(i)),1;if(s=0,n=n===""?".":n+":",SE(r))for(var l=0;l<r.length;l++){a=r[l];var u=n+Kh(a,l);s+=Zu(a,e,t,u,i)}else if(u=TC(r),typeof u=="function")for(r=u.call(r),l=0;!(a=r.next()).done;)a=a.value,u=n+Kh(a,l++),s+=Zu(a,e,t,u,i);else if(a==="object")throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return s}o(Zu,"R$2");function bu(r,e,t){if(r==null)return r;var n=[],i=0;return Zu(r,n,"","",function(a){return e.call(t,a,i++)}),n}o(bu,"S$1");function CC(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}o(CC,"T$1");var nr={current:null},ed={transition:null},OC={ReactCurrentDispatcher:nr,ReactCurrentBatchConfig:ed,ReactCurrentOwner:Zm};function Z0(){throw Error("act(...) is not supported in production builds of React.")}o(Z0,"X$1");Le.Children={map:bu,forEach:o(function(r,e,t){bu(r,function(){e.apply(this,arguments)},t)},"forEach"),count:o(function(r){var e=0;return bu(r,function(){e++}),e},"count"),toArray:o(function(r){return bu(r,function(e){return e})||[]},"toArray"),only:o(function(r){if(!eg(r))throw Error("React.Children.only expected to receive a single React element child.");return r},"only")};Le.Component=no;Le.Fragment=pC;Le.Profiler=gC;Le.PureComponent=Ym;Le.StrictMode=mC;Le.Suspense=_C;Le.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=OC;Le.act=Z0;Le.cloneElement=function(r,e,t){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var n=H0({},r.props),i=r.key,a=r.ref,s=r._owner;if(e!=null){if(e.ref!==void 0&&(a=e.ref,s=Zm.current),e.key!==void 0&&(i=""+e.key),r.type&&r.type.defaultProps)var l=r.type.defaultProps;for(u in e)Q0.call(e,u)&&!Y0.hasOwnProperty(u)&&(n[u]=e[u]===void 0&&l!==void 0?l[u]:e[u])}var u=arguments.length-2;if(u===1)n.children=t;else if(1<u){l=Array(u);for(var d=0;d<u;d++)l[d]=arguments[d+2];n.children=l}return{$$typeof:eu,type:r.type,key:i,ref:a,props:n,_owner:s}};Le.createContext=function(r){return r={$$typeof:SC,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:yC,_context:r},r.Consumer=r};Le.createElement=X0;Le.createFactory=function(r){var e=X0.bind(null,r);return e.type=r,e};Le.createRef=function(){return{current:null}};Le.forwardRef=function(r){return{$$typeof:EC,render:r}};Le.isValidElement=eg;Le.lazy=function(r){return{$$typeof:wC,_payload:{_status:-1,_result:r},_init:CC}};Le.memo=function(r,e){return{$$typeof:bC,type:r,compare:e===void 0?null:e}};Le.startTransition=function(r){var e=ed.transition;ed.transition={};try{r()}finally{ed.transition=e}};Le.unstable_act=Z0;Le.useCallback=function(r,e){return nr.current.useCallback(r,e)};Le.useContext=function(r){return nr.current.useContext(r)};Le.useDebugValue=function(){};Le.useDeferredValue=function(r){return nr.current.useDeferredValue(r)};Le.useEffect=function(r,e){return nr.current.useEffect(r,e)};Le.useId=function(){return nr.current.useId()};Le.useImperativeHandle=function(r,e,t){return nr.current.useImperativeHandle(r,e,t)};Le.useInsertionEffect=function(r,e){return nr.current.useInsertionEffect(r,e)};Le.useLayoutEffect=function(r,e){return nr.current.useLayoutEffect(r,e)};Le.useMemo=function(r,e){return nr.current.useMemo(r,e)};Le.useReducer=function(r,e,t){return nr.current.useReducer(r,e,t)};Le.useRef=function(r){return nr.current.useRef(r)};Le.useState=function(r){return nr.current.useState(r)};Le.useSyncExternalStore=function(r,e,t){return nr.current.useSyncExternalStore(r,e,t)};Le.useTransition=function(){return nr.current.useTransition()};Le.version="18.3.1";G0.exports=Le;var $=G0.exports;const tg=nh($),kC=hC({__proto__:null,default:tg},[$]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var PC=$,MC=Symbol.for("react.element"),AC=Symbol.for("react.fragment"),xC=Object.prototype.hasOwnProperty,DC=PC.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,NC={key:!0,ref:!0,__self:!0,__source:!0};function ew(r,e,t){var n,i={},a=null,s=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(s=e.ref);for(n in e)xC.call(e,n)&&!NC.hasOwnProperty(n)&&(i[n]=e[n]);if(r&&r.defaultProps)for(n in e=r.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:MC,type:r,key:a,ref:s,props:i,_owner:DC.current}}o(ew,"q");ih.Fragment=AC;ih.jsx=ew;ih.jsxs=ew;V0.exports=ih;var E=V0.exports,tw={exports:{}},Ir={},rw={exports:{}},nw={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(r){function e(X,ue){var ge=X.length;X.push(ue);e:for(;0<ge;){var Ce=ge-1>>>1,J=X[Ce];if(0<i(J,ue))X[Ce]=ue,X[ge]=J,ge=Ce;else break e}}o(e,"f");function t(X){return X.length===0?null:X[0]}o(t,"h");function n(X){if(X.length===0)return null;var ue=X[0],ge=X.pop();if(ge!==ue){X[0]=ge;e:for(var Ce=0,J=X.length,ee=J>>>1;Ce<ee;){var N=2*(Ce+1)-1,D=X[N],A=N+1,x=X[A];if(0>i(D,ge))A<J&&0>i(x,D)?(X[Ce]=x,X[A]=ge,Ce=A):(X[Ce]=D,X[N]=ge,Ce=N);else if(A<J&&0>i(x,ge))X[Ce]=x,X[A]=ge,Ce=A;else break e}}return ue}o(n,"k");function i(X,ue){var ge=X.sortIndex-ue.sortIndex;return ge!==0?ge:X.id-ue.id}if(o(i,"g"),typeof performance=="object"&&typeof performance.now=="function"){var a=performance;r.unstable_now=function(){return a.now()}}else{var s=Date,l=s.now();r.unstable_now=function(){return s.now()-l}}var u=[],d=[],c=1,h=null,v=3,g=!1,p=!1,m=!1,w=typeof setTimeout=="function"?setTimeout:null,y=typeof clearTimeout=="function"?clearTimeout:null,S=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function T(X){for(var ue=t(d);ue!==null;){if(ue.callback===null)n(d);else if(ue.startTime<=X)n(d),ue.sortIndex=ue.expirationTime,e(u,ue);else break;ue=t(d)}}o(T,"G");function C(X){if(m=!1,T(X),!p)if(t(u)!==null)p=!0,Ae(M);else{var ue=t(d);ue!==null&&ae(C,ue.startTime-X)}}o(C,"H");function M(X,ue){p=!1,m&&(m=!1,y(b),b=-1),g=!0;var ge=v;try{for(T(ue),h=t(u);h!==null&&(!(h.expirationTime>ue)||X&&!q());){var Ce=h.callback;if(typeof Ce=="function"){h.callback=null,v=h.priorityLevel;var J=Ce(h.expirationTime<=ue);ue=r.unstable_now(),typeof J=="function"?h.callback=J:h===t(u)&&n(u),T(ue)}else n(u);h=t(u)}if(h!==null)var ee=!0;else{var N=t(d);N!==null&&ae(C,N.startTime-ue),ee=!1}return ee}finally{h=null,v=ge,g=!1}}o(M,"J");var _=!1,O=null,b=-1,j=5,B=-1;function q(){return!(r.unstable_now()-B<j)}o(q,"M");function oe(){if(O!==null){var X=r.unstable_now();B=X;var ue=!0;try{ue=O(!0,X)}finally{ue?de():(_=!1,O=null)}}else _=!1}o(oe,"R");var de;if(typeof S=="function")de=o(function(){S(oe)},"S");else if(typeof MessageChannel<"u"){var Ne=new MessageChannel,Oe=Ne.port2;Ne.port1.onmessage=oe,de=o(function(){Oe.postMessage(null)},"S")}else de=o(function(){w(oe,0)},"S");function Ae(X){O=X,_||(_=!0,de())}o(Ae,"I");function ae(X,ue){b=w(function(){X(r.unstable_now())},ue)}o(ae,"K"),r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(X){X.callback=null},r.unstable_continueExecution=function(){p||g||(p=!0,Ae(M))},r.unstable_forceFrameRate=function(X){0>X||125<X?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):j=0<X?Math.floor(1e3/X):5},r.unstable_getCurrentPriorityLevel=function(){return v},r.unstable_getFirstCallbackNode=function(){return t(u)},r.unstable_next=function(X){switch(v){case 1:case 2:case 3:var ue=3;break;default:ue=v}var ge=v;v=ue;try{return X()}finally{v=ge}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(X,ue){switch(X){case 1:case 2:case 3:case 4:case 5:break;default:X=3}var ge=v;v=X;try{return ue()}finally{v=ge}},r.unstable_scheduleCallback=function(X,ue,ge){var Ce=r.unstable_now();switch(typeof ge=="object"&&ge!==null?(ge=ge.delay,ge=typeof ge=="number"&&0<ge?Ce+ge:Ce):ge=Ce,X){case 1:var J=-1;break;case 2:J=250;break;case 5:J=1073741823;break;case 4:J=1e4;break;default:J=5e3}return J=ge+J,X={id:c++,callback:ue,priorityLevel:X,startTime:ge,expirationTime:J,sortIndex:-1},ge>Ce?(X.sortIndex=ge,e(d,X),t(u)===null&&X===t(d)&&(m?(y(b),b=-1):m=!0,ae(C,ge-Ce))):(X.sortIndex=J,e(u,X),p||g||(p=!0,Ae(M))),X},r.unstable_shouldYield=q,r.unstable_wrapCallback=function(X){var ue=v;return function(){var ge=v;v=ue;try{return X.apply(this,arguments)}finally{v=ge}}}})(nw);rw.exports=nw;var LC=rw.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var UC=$,Rr=LC;function ie(r){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+r,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+r+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}o(ie,"p");var iw=new Set,cl={};function Ta(r,e){Us(r,e),Us(r+"Capture",e)}o(Ta,"fa");function Us(r,e){for(cl[r]=e,r=0;r<e.length;r++)iw.add(e[r])}o(Us,"ha");var Kn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Jf=Object.prototype.hasOwnProperty,jC=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,_E={},bE={};function FC(r){return Jf.call(bE,r)?!0:Jf.call(_E,r)?!1:jC.test(r)?bE[r]=!0:(_E[r]=!0,!1)}o(FC,"oa");function BC(r,e,t,n){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:t!==null?!t.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}o(BC,"pa");function $C(r,e,t,n){if(e===null||typeof e>"u"||BC(r,e,t,n))return!0;if(n)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}o($C,"qa");function ir(r,e,t,n,i,a,s){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=r,this.type=e,this.sanitizeURL=a,this.removeEmptyString=s}o(ir,"v");var Bt={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){Bt[r]=new ir(r,0,!1,r,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var e=r[0];Bt[e]=new ir(e,1,!1,r[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(r){Bt[r]=new ir(r,2,!1,r.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){Bt[r]=new ir(r,2,!1,r,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){Bt[r]=new ir(r,3,!1,r.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(r){Bt[r]=new ir(r,3,!0,r,null,!1,!1)});["capture","download"].forEach(function(r){Bt[r]=new ir(r,4,!1,r,null,!1,!1)});["cols","rows","size","span"].forEach(function(r){Bt[r]=new ir(r,6,!1,r,null,!1,!1)});["rowSpan","start"].forEach(function(r){Bt[r]=new ir(r,5,!1,r.toLowerCase(),null,!1,!1)});var rg=/[\-:]([a-z])/g;function ng(r){return r[1].toUpperCase()}o(ng,"sa");"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var e=r.replace(rg,ng);Bt[e]=new ir(e,1,!1,r,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var e=r.replace(rg,ng);Bt[e]=new ir(e,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(r){var e=r.replace(rg,ng);Bt[e]=new ir(e,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(r){Bt[r]=new ir(r,1,!1,r.toLowerCase(),null,!1,!1)});Bt.xlinkHref=new ir("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(r){Bt[r]=new ir(r,1,!1,r.toLowerCase(),null,!0,!0)});function ig(r,e,t,n){var i=Bt.hasOwnProperty(e)?Bt[e]:null;(i!==null?i.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&($C(e,t,i,n)&&(t=null),n||i===null?FC(e)&&(t===null?r.removeAttribute(e):r.setAttribute(e,""+t)):i.mustUseProperty?r[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,n=i.attributeNamespace,t===null?r.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,n?r.setAttributeNS(n,e,t):r.setAttribute(e,t))))}o(ig,"ta");var Jn=UC.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,wu=Symbol.for("react.element"),Ba=Symbol.for("react.portal"),$a=Symbol.for("react.fragment"),ag=Symbol.for("react.strict_mode"),Qf=Symbol.for("react.profiler"),aw=Symbol.for("react.provider"),sw=Symbol.for("react.context"),sg=Symbol.for("react.forward_ref"),Yf=Symbol.for("react.suspense"),Xf=Symbol.for("react.suspense_list"),og=Symbol.for("react.memo"),ui=Symbol.for("react.lazy"),ow=Symbol.for("react.offscreen"),wE=Symbol.iterator;function yo(r){return r===null||typeof r!="object"?null:(r=wE&&r[wE]||r["@@iterator"],typeof r=="function"?r:null)}o(yo,"Ka");var dt=Object.assign,Vh;function jo(r){if(Vh===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);Vh=e&&e[1]||""}return`
`+Vh+r}o(jo,"Ma");var Gh=!1;function qh(r,e){if(!r||Gh)return"";Gh=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=o(function(){throw Error()},"b"),Object.defineProperty(e.prototype,"props",{set:o(function(){throw Error()},"set")}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(d){var n=d}Reflect.construct(r,[],e)}else{try{e.call()}catch(d){n=d}r.call(e.prototype)}else{try{throw Error()}catch(d){n=d}r()}}catch(d){if(d&&n&&typeof d.stack=="string"){for(var i=d.stack.split(`
`),a=n.stack.split(`
`),s=i.length-1,l=a.length-1;1<=s&&0<=l&&i[s]!==a[l];)l--;for(;1<=s&&0<=l;s--,l--)if(i[s]!==a[l]){if(s!==1||l!==1)do if(s--,l--,0>l||i[s]!==a[l]){var u=`
`+i[s].replace(" at new "," at ");return r.displayName&&u.includes("<anonymous>")&&(u=u.replace("<anonymous>",r.displayName)),u}while(1<=s&&0<=l);break}}}finally{Gh=!1,Error.prepareStackTrace=t}return(r=r?r.displayName||r.name:"")?jo(r):""}o(qh,"Oa");function WC(r){switch(r.tag){case 5:return jo(r.type);case 16:return jo("Lazy");case 13:return jo("Suspense");case 19:return jo("SuspenseList");case 0:case 2:case 15:return r=qh(r.type,!1),r;case 11:return r=qh(r.type.render,!1),r;case 1:return r=qh(r.type,!0),r;default:return""}}o(WC,"Pa");function Zf(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case $a:return"Fragment";case Ba:return"Portal";case Qf:return"Profiler";case ag:return"StrictMode";case Yf:return"Suspense";case Xf:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case sw:return(r.displayName||"Context")+".Consumer";case aw:return(r._context.displayName||"Context")+".Provider";case sg:var e=r.render;return r=r.displayName,r||(r=e.displayName||e.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case og:return e=r.displayName||null,e!==null?e:Zf(r.type)||"Memo";case ui:e=r._payload,r=r._init;try{return Zf(r(e))}catch{}}return null}o(Zf,"Qa");function KC(r){var e=r.type;switch(r.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=e.render,r=r.displayName||r.name||"",e.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return Zf(e);case 8:return e===ag?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}o(KC,"Ra");function xi(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}o(xi,"Sa");function lw(r){var e=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}o(lw,"Ta");function VC(r){var e=lw(r)?"checked":"value",t=Object.getOwnPropertyDescriptor(r.constructor.prototype,e),n=""+r[e];if(!r.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,a=t.set;return Object.defineProperty(r,e,{configurable:!0,get:o(function(){return i.call(this)},"get"),set:o(function(s){n=""+s,a.call(this,s)},"set")}),Object.defineProperty(r,e,{enumerable:t.enumerable}),{getValue:o(function(){return n},"getValue"),setValue:o(function(s){n=""+s},"setValue"),stopTracking:o(function(){r._valueTracker=null,delete r[e]},"stopTracking")}}}o(VC,"Ua");function Tu(r){r._valueTracker||(r._valueTracker=VC(r))}o(Tu,"Va");function uw(r){if(!r)return!1;var e=r._valueTracker;if(!e)return!0;var t=e.getValue(),n="";return r&&(n=lw(r)?r.checked?"true":"false":r.value),r=n,r!==t?(e.setValue(r),!0):!1}o(uw,"Wa");function Rd(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}o(Rd,"Xa");function ev(r,e){var t=e.checked;return dt({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??r._wrapperState.initialChecked})}o(ev,"Ya");function TE(r,e){var t=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;t=xi(e.value!=null?e.value:t),r._wrapperState={initialChecked:n,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}o(TE,"Za");function dw(r,e){e=e.checked,e!=null&&ig(r,"checked",e,!1)}o(dw,"ab");function tv(r,e){dw(r,e);var t=xi(e.value),n=e.type;if(t!=null)n==="number"?(t===0&&r.value===""||r.value!=t)&&(r.value=""+t):r.value!==""+t&&(r.value=""+t);else if(n==="submit"||n==="reset"){r.removeAttribute("value");return}e.hasOwnProperty("value")?rv(r,e.type,t):e.hasOwnProperty("defaultValue")&&rv(r,e.type,xi(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(r.defaultChecked=!!e.defaultChecked)}o(tv,"bb");function RE(r,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+r._wrapperState.initialValue,t||e===r.value||(r.value=e),r.defaultValue=e}t=r.name,t!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,t!==""&&(r.name=t)}o(RE,"db");function rv(r,e,t){(e!=="number"||Rd(r.ownerDocument)!==r)&&(t==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+t&&(r.defaultValue=""+t))}o(rv,"cb");var Fo=Array.isArray;function ts(r,e,t,n){if(r=r.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<r.length;t++)i=e.hasOwnProperty("$"+r[t].value),r[t].selected!==i&&(r[t].selected=i),i&&n&&(r[t].defaultSelected=!0)}else{for(t=""+xi(t),e=null,i=0;i<r.length;i++){if(r[i].value===t){r[i].selected=!0,n&&(r[i].defaultSelected=!0);return}e!==null||r[i].disabled||(e=r[i])}e!==null&&(e.selected=!0)}}o(ts,"fb");function nv(r,e){if(e.dangerouslySetInnerHTML!=null)throw Error(ie(91));return dt({},e,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}o(nv,"gb");function IE(r,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(ie(92));if(Fo(t)){if(1<t.length)throw Error(ie(93));t=t[0]}e=t}e==null&&(e=""),t=e}r._wrapperState={initialValue:xi(t)}}o(IE,"hb");function cw(r,e){var t=xi(e.value),n=xi(e.defaultValue);t!=null&&(t=""+t,t!==r.value&&(r.value=t),e.defaultValue==null&&r.defaultValue!==t&&(r.defaultValue=t)),n!=null&&(r.defaultValue=""+n)}o(cw,"ib");function CE(r){var e=r.textContent;e===r._wrapperState.initialValue&&e!==""&&e!==null&&(r.value=e)}o(CE,"jb");function hw(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}o(hw,"kb");function iv(r,e){return r==null||r==="http://www.w3.org/1999/xhtml"?hw(e):r==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":r}o(iv,"lb");var Ru,fw=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction(function(){return r(e,t,n,i)})}:r}(function(r,e){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=e;else{for(Ru=Ru||document.createElement("div"),Ru.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=Ru.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;e.firstChild;)r.appendChild(e.firstChild)}});function hl(r,e){if(e){var t=r.firstChild;if(t&&t===r.lastChild&&t.nodeType===3){t.nodeValue=e;return}}r.textContent=e}o(hl,"ob");var Go={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},GC=["Webkit","ms","Moz","O"];Object.keys(Go).forEach(function(r){GC.forEach(function(e){e=e+r.charAt(0).toUpperCase()+r.substring(1),Go[e]=Go[r]})});function vw(r,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||Go.hasOwnProperty(r)&&Go[r]?(""+e).trim():e+"px"}o(vw,"rb");function pw(r,e){r=r.style;for(var t in e)if(e.hasOwnProperty(t)){var n=t.indexOf("--")===0,i=vw(t,e[t],n);t==="float"&&(t="cssFloat"),n?r.setProperty(t,i):r[t]=i}}o(pw,"sb");var qC=dt({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function av(r,e){if(e){if(qC[r]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(ie(137,r));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(ie(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(ie(61))}if(e.style!=null&&typeof e.style!="object")throw Error(ie(62))}}o(av,"ub");function sv(r,e){if(r.indexOf("-")===-1)return typeof e.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}o(sv,"vb");var ov=null;function lg(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}o(lg,"xb");var lv=null,rs=null,ns=null;function OE(r){if(r=nu(r)){if(typeof lv!="function")throw Error(ie(280));var e=r.stateNode;e&&(e=uh(e),lv(r.stateNode,r.type,e))}}o(OE,"Bb");function mw(r){rs?ns?ns.push(r):ns=[r]:rs=r}o(mw,"Eb");function gw(){if(rs){var r=rs,e=ns;if(ns=rs=null,OE(r),e)for(r=0;r<e.length;r++)OE(e[r])}}o(gw,"Fb");function yw(r,e){return r(e)}o(yw,"Gb");function Sw(){}o(Sw,"Hb");var Hh=!1;function Ew(r,e,t){if(Hh)return r(e,t);Hh=!0;try{return yw(r,e,t)}finally{Hh=!1,(rs!==null||ns!==null)&&(Sw(),gw())}}o(Ew,"Jb");function fl(r,e){var t=r.stateNode;if(t===null)return null;var n=uh(t);if(n===null)return null;t=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(r=r.type,n=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!n;break e;default:r=!1}if(r)return null;if(t&&typeof t!="function")throw Error(ie(231,e,typeof t));return t}o(fl,"Kb");var uv=!1;if(Kn)try{var So={};Object.defineProperty(So,"passive",{get:o(function(){uv=!0},"get")}),window.addEventListener("test",So,So),window.removeEventListener("test",So,So)}catch{uv=!1}function HC(r,e,t,n,i,a,s,l,u){var d=Array.prototype.slice.call(arguments,3);try{e.apply(t,d)}catch(c){this.onError(c)}}o(HC,"Nb");var qo=!1,Id=null,Cd=!1,dv=null,zC={onError:o(function(r){qo=!0,Id=r},"onError")};function JC(r,e,t,n,i,a,s,l,u){qo=!1,Id=null,HC.apply(zC,arguments)}o(JC,"Tb");function QC(r,e,t,n,i,a,s,l,u){if(JC.apply(this,arguments),qo){if(qo){var d=Id;qo=!1,Id=null}else throw Error(ie(198));Cd||(Cd=!0,dv=d)}}o(QC,"Ub");function Ra(r){var e=r,t=r;if(r.alternate)for(;e.return;)e=e.return;else{r=e;do e=r,e.flags&4098&&(t=e.return),r=e.return;while(r)}return e.tag===3?t:null}o(Ra,"Vb");function _w(r){if(r.tag===13){var e=r.memoizedState;if(e===null&&(r=r.alternate,r!==null&&(e=r.memoizedState)),e!==null)return e.dehydrated}return null}o(_w,"Wb");function kE(r){if(Ra(r)!==r)throw Error(ie(188))}o(kE,"Xb");function YC(r){var e=r.alternate;if(!e){if(e=Ra(r),e===null)throw Error(ie(188));return e!==r?null:r}for(var t=r,n=e;;){var i=t.return;if(i===null)break;var a=i.alternate;if(a===null){if(n=i.return,n!==null){t=n;continue}break}if(i.child===a.child){for(a=i.child;a;){if(a===t)return kE(i),r;if(a===n)return kE(i),e;a=a.sibling}throw Error(ie(188))}if(t.return!==n.return)t=i,n=a;else{for(var s=!1,l=i.child;l;){if(l===t){s=!0,t=i,n=a;break}if(l===n){s=!0,n=i,t=a;break}l=l.sibling}if(!s){for(l=a.child;l;){if(l===t){s=!0,t=a,n=i;break}if(l===n){s=!0,n=a,t=i;break}l=l.sibling}if(!s)throw Error(ie(189))}}if(t.alternate!==n)throw Error(ie(190))}if(t.tag!==3)throw Error(ie(188));return t.stateNode.current===t?r:e}o(YC,"Yb");function bw(r){return r=YC(r),r!==null?ww(r):null}o(bw,"Zb");function ww(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var e=ww(r);if(e!==null)return e;r=r.sibling}return null}o(ww,"$b");var Tw=Rr.unstable_scheduleCallback,PE=Rr.unstable_cancelCallback,XC=Rr.unstable_shouldYield,ZC=Rr.unstable_requestPaint,vt=Rr.unstable_now,eO=Rr.unstable_getCurrentPriorityLevel,ug=Rr.unstable_ImmediatePriority,Rw=Rr.unstable_UserBlockingPriority,Od=Rr.unstable_NormalPriority,tO=Rr.unstable_LowPriority,Iw=Rr.unstable_IdlePriority,ah=null,Sn=null;function rO(r){if(Sn&&typeof Sn.onCommitFiberRoot=="function")try{Sn.onCommitFiberRoot(ah,r,void 0,(r.current.flags&128)===128)}catch{}}o(rO,"mc");var Jr=Math.clz32?Math.clz32:aO,nO=Math.log,iO=Math.LN2;function aO(r){return r>>>=0,r===0?32:31-(nO(r)/iO|0)|0}o(aO,"nc");var Iu=64,Cu=4194304;function Bo(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}o(Bo,"tc");function kd(r,e){var t=r.pendingLanes;if(t===0)return 0;var n=0,i=r.suspendedLanes,a=r.pingedLanes,s=t&268435455;if(s!==0){var l=s&~i;l!==0?n=Bo(l):(a&=s,a!==0&&(n=Bo(a)))}else s=t&~i,s!==0?n=Bo(s):a!==0&&(n=Bo(a));if(n===0)return 0;if(e!==0&&e!==n&&!(e&i)&&(i=n&-n,a=e&-e,i>=a||i===16&&(a&4194240)!==0))return e;if(n&4&&(n|=t&16),e=r.entangledLanes,e!==0)for(r=r.entanglements,e&=n;0<e;)t=31-Jr(e),i=1<<t,n|=r[t],e&=~i;return n}o(kd,"uc");function sO(r,e){switch(r){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}o(sO,"vc");function oO(r,e){for(var t=r.suspendedLanes,n=r.pingedLanes,i=r.expirationTimes,a=r.pendingLanes;0<a;){var s=31-Jr(a),l=1<<s,u=i[s];u===-1?(!(l&t)||l&n)&&(i[s]=sO(l,e)):u<=e&&(r.expiredLanes|=l),a&=~l}}o(oO,"wc");function cv(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}o(cv,"xc");function Cw(){var r=Iu;return Iu<<=1,!(Iu&4194240)&&(Iu=64),r}o(Cw,"yc");function zh(r){for(var e=[],t=0;31>t;t++)e.push(r);return e}o(zh,"zc");function tu(r,e,t){r.pendingLanes|=e,e!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,e=31-Jr(e),r[e]=t}o(tu,"Ac");function lO(r,e){var t=r.pendingLanes&~e;r.pendingLanes=e,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=e,r.mutableReadLanes&=e,r.entangledLanes&=e,e=r.entanglements;var n=r.eventTimes;for(r=r.expirationTimes;0<t;){var i=31-Jr(t),a=1<<i;e[i]=0,n[i]=-1,r[i]=-1,t&=~a}}o(lO,"Bc");function dg(r,e){var t=r.entangledLanes|=e;for(r=r.entanglements;t;){var n=31-Jr(t),i=1<<n;i&e|r[n]&e&&(r[n]|=e),t&=~i}}o(dg,"Cc");var Ge=0;function Ow(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}o(Ow,"Dc");var kw,cg,Pw,Mw,Aw,hv=!1,Ou=[],Ei=null,_i=null,bi=null,vl=new Map,pl=new Map,vi=[],uO="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function ME(r,e){switch(r){case"focusin":case"focusout":Ei=null;break;case"dragenter":case"dragleave":_i=null;break;case"mouseover":case"mouseout":bi=null;break;case"pointerover":case"pointerout":vl.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":pl.delete(e.pointerId)}}o(ME,"Sc");function Eo(r,e,t,n,i,a){return r===null||r.nativeEvent!==a?(r={blockedOn:e,domEventName:t,eventSystemFlags:n,nativeEvent:a,targetContainers:[i]},e!==null&&(e=nu(e),e!==null&&cg(e)),r):(r.eventSystemFlags|=n,e=r.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),r)}o(Eo,"Tc");function dO(r,e,t,n,i){switch(e){case"focusin":return Ei=Eo(Ei,r,e,t,n,i),!0;case"dragenter":return _i=Eo(_i,r,e,t,n,i),!0;case"mouseover":return bi=Eo(bi,r,e,t,n,i),!0;case"pointerover":var a=i.pointerId;return vl.set(a,Eo(vl.get(a)||null,r,e,t,n,i)),!0;case"gotpointercapture":return a=i.pointerId,pl.set(a,Eo(pl.get(a)||null,r,e,t,n,i)),!0}return!1}o(dO,"Uc");function xw(r){var e=na(r.target);if(e!==null){var t=Ra(e);if(t!==null){if(e=t.tag,e===13){if(e=_w(t),e!==null){r.blockedOn=e,Aw(r.priority,function(){Pw(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){r.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}r.blockedOn=null}o(xw,"Vc");function td(r){if(r.blockedOn!==null)return!1;for(var e=r.targetContainers;0<e.length;){var t=fv(r.domEventName,r.eventSystemFlags,e[0],r.nativeEvent);if(t===null){t=r.nativeEvent;var n=new t.constructor(t.type,t);ov=n,t.target.dispatchEvent(n),ov=null}else return e=nu(t),e!==null&&cg(e),r.blockedOn=t,!1;e.shift()}return!0}o(td,"Xc");function AE(r,e,t){td(r)&&t.delete(e)}o(AE,"Zc");function cO(){hv=!1,Ei!==null&&td(Ei)&&(Ei=null),_i!==null&&td(_i)&&(_i=null),bi!==null&&td(bi)&&(bi=null),vl.forEach(AE),pl.forEach(AE)}o(cO,"$c");function _o(r,e){r.blockedOn===e&&(r.blockedOn=null,hv||(hv=!0,Rr.unstable_scheduleCallback(Rr.unstable_NormalPriority,cO)))}o(_o,"ad");function ml(r){function e(i){return _o(i,r)}if(o(e,"b"),0<Ou.length){_o(Ou[0],r);for(var t=1;t<Ou.length;t++){var n=Ou[t];n.blockedOn===r&&(n.blockedOn=null)}}for(Ei!==null&&_o(Ei,r),_i!==null&&_o(_i,r),bi!==null&&_o(bi,r),vl.forEach(e),pl.forEach(e),t=0;t<vi.length;t++)n=vi[t],n.blockedOn===r&&(n.blockedOn=null);for(;0<vi.length&&(t=vi[0],t.blockedOn===null);)xw(t),t.blockedOn===null&&vi.shift()}o(ml,"bd");var is=Jn.ReactCurrentBatchConfig,Pd=!0;function hO(r,e,t,n){var i=Ge,a=is.transition;is.transition=null;try{Ge=1,hg(r,e,t,n)}finally{Ge=i,is.transition=a}}o(hO,"ed");function fO(r,e,t,n){var i=Ge,a=is.transition;is.transition=null;try{Ge=4,hg(r,e,t,n)}finally{Ge=i,is.transition=a}}o(fO,"gd");function hg(r,e,t,n){if(Pd){var i=fv(r,e,t,n);if(i===null)af(r,e,n,Md,t),ME(r,n);else if(dO(i,r,e,t,n))n.stopPropagation();else if(ME(r,n),e&4&&-1<uO.indexOf(r)){for(;i!==null;){var a=nu(i);if(a!==null&&kw(a),a=fv(r,e,t,n),a===null&&af(r,e,n,Md,t),a===i)break;i=a}i!==null&&n.stopPropagation()}else af(r,e,n,null,t)}}o(hg,"fd");var Md=null;function fv(r,e,t,n){if(Md=null,r=lg(n),r=na(r),r!==null)if(e=Ra(r),e===null)r=null;else if(t=e.tag,t===13){if(r=_w(e),r!==null)return r;r=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;r=null}else e!==r&&(r=null);return Md=r,null}o(fv,"Yc");function Dw(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(eO()){case ug:return 1;case Rw:return 4;case Od:case tO:return 16;case Iw:return 536870912;default:return 16}default:return 16}}o(Dw,"jd");var mi=null,fg=null,rd=null;function Nw(){if(rd)return rd;var r,e=fg,t=e.length,n,i="value"in mi?mi.value:mi.textContent,a=i.length;for(r=0;r<t&&e[r]===i[r];r++);var s=t-r;for(n=1;n<=s&&e[t-n]===i[a-n];n++);return rd=i.slice(r,1<n?1-n:void 0)}o(Nw,"nd");function nd(r){var e=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&e===13&&(r=13)):r=e,r===10&&(r=13),32<=r||r===13?r:0}o(nd,"od");function ku(){return!0}o(ku,"pd");function xE(){return!1}o(xE,"qd");function Cr(r){function e(t,n,i,a,s){this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=a,this.target=s,this.currentTarget=null;for(var l in r)r.hasOwnProperty(l)&&(t=r[l],this[l]=t?t(a):a[l]);return this.isDefaultPrevented=(a.defaultPrevented!=null?a.defaultPrevented:a.returnValue===!1)?ku:xE,this.isPropagationStopped=xE,this}return o(e,"b"),dt(e.prototype,{preventDefault:o(function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=ku)},"preventDefault"),stopPropagation:o(function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=ku)},"stopPropagation"),persist:o(function(){},"persist"),isPersistent:ku}),e}o(Cr,"rd");var io={eventPhase:0,bubbles:0,cancelable:0,timeStamp:o(function(r){return r.timeStamp||Date.now()},"timeStamp"),defaultPrevented:0,isTrusted:0},vg=Cr(io),ru=dt({},io,{view:0,detail:0}),vO=Cr(ru),Jh,Qh,bo,sh=dt({},ru,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:pg,button:0,buttons:0,relatedTarget:o(function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},"relatedTarget"),movementX:o(function(r){return"movementX"in r?r.movementX:(r!==bo&&(bo&&r.type==="mousemove"?(Jh=r.screenX-bo.screenX,Qh=r.screenY-bo.screenY):Qh=Jh=0,bo=r),Jh)},"movementX"),movementY:o(function(r){return"movementY"in r?r.movementY:Qh},"movementY")}),DE=Cr(sh),pO=dt({},sh,{dataTransfer:0}),mO=Cr(pO),gO=dt({},ru,{relatedTarget:0}),Yh=Cr(gO),yO=dt({},io,{animationName:0,elapsedTime:0,pseudoElement:0}),SO=Cr(yO),EO=dt({},io,{clipboardData:o(function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData},"clipboardData")}),_O=Cr(EO),bO=dt({},io,{data:0}),NE=Cr(bO),wO={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},TO={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},RO={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function IO(r){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(r):(r=RO[r])?!!e[r]:!1}o(IO,"Pd");function pg(){return IO}o(pg,"zd");var CO=dt({},ru,{key:o(function(r){if(r.key){var e=wO[r.key]||r.key;if(e!=="Unidentified")return e}return r.type==="keypress"?(r=nd(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?TO[r.keyCode]||"Unidentified":""},"key"),code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:pg,charCode:o(function(r){return r.type==="keypress"?nd(r):0},"charCode"),keyCode:o(function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},"keyCode"),which:o(function(r){return r.type==="keypress"?nd(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0},"which")}),OO=Cr(CO),kO=dt({},sh,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),LE=Cr(kO),PO=dt({},ru,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:pg}),MO=Cr(PO),AO=dt({},io,{propertyName:0,elapsedTime:0,pseudoElement:0}),xO=Cr(AO),DO=dt({},sh,{deltaX:o(function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},"deltaX"),deltaY:o(function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},"deltaY"),deltaZ:0,deltaMode:0}),NO=Cr(DO),LO=[9,13,27,32],mg=Kn&&"CompositionEvent"in window,Ho=null;Kn&&"documentMode"in document&&(Ho=document.documentMode);var UO=Kn&&"TextEvent"in window&&!Ho,Lw=Kn&&(!mg||Ho&&8<Ho&&11>=Ho),UE=" ",jE=!1;function Uw(r,e){switch(r){case"keyup":return LO.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}o(Uw,"ge");function jw(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}o(jw,"he");var Wa=!1;function jO(r,e){switch(r){case"compositionend":return jw(e);case"keypress":return e.which!==32?null:(jE=!0,UE);case"textInput":return r=e.data,r===UE&&jE?null:r;default:return null}}o(jO,"je");function FO(r,e){if(Wa)return r==="compositionend"||!mg&&Uw(r,e)?(r=Nw(),rd=fg=mi=null,Wa=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return Lw&&e.locale!=="ko"?null:e.data;default:return null}}o(FO,"ke");var BO={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function FE(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e==="input"?!!BO[r.type]:e==="textarea"}o(FE,"me");function Fw(r,e,t,n){mw(n),e=Ad(e,"onChange"),0<e.length&&(t=new vg("onChange","change",null,t,n),r.push({event:t,listeners:e}))}o(Fw,"ne");var zo=null,gl=null;function $O(r){Qw(r,0)}o($O,"re");function oh(r){var e=Ga(r);if(uw(e))return r}o(oh,"te");function WO(r,e){if(r==="change")return e}o(WO,"ve");var Bw=!1;if(Kn){var Xh;if(Kn){var Zh="oninput"in document;if(!Zh){var BE=document.createElement("div");BE.setAttribute("oninput","return;"),Zh=typeof BE.oninput=="function"}Xh=Zh}else Xh=!1;Bw=Xh&&(!document.documentMode||9<document.documentMode)}function $E(){zo&&(zo.detachEvent("onpropertychange",$w),gl=zo=null)}o($E,"Ae");function $w(r){if(r.propertyName==="value"&&oh(gl)){var e=[];Fw(e,gl,r,lg(r)),Ew($O,e)}}o($w,"Be");function KO(r,e,t){r==="focusin"?($E(),zo=e,gl=t,zo.attachEvent("onpropertychange",$w)):r==="focusout"&&$E()}o(KO,"Ce");function VO(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return oh(gl)}o(VO,"De");function GO(r,e){if(r==="click")return oh(e)}o(GO,"Ee");function qO(r,e){if(r==="input"||r==="change")return oh(e)}o(qO,"Fe");function HO(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}o(HO,"Ge");var en=typeof Object.is=="function"?Object.is:HO;function yl(r,e){if(en(r,e))return!0;if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;var t=Object.keys(r),n=Object.keys(e);if(t.length!==n.length)return!1;for(n=0;n<t.length;n++){var i=t[n];if(!Jf.call(e,i)||!en(r[i],e[i]))return!1}return!0}o(yl,"Ie");function WE(r){for(;r&&r.firstChild;)r=r.firstChild;return r}o(WE,"Je");function KE(r,e){var t=WE(r);r=0;for(var n;t;){if(t.nodeType===3){if(n=r+t.textContent.length,r<=e&&n>=e)return{node:t,offset:e-r};r=n}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=WE(t)}}o(KE,"Ke");function Ww(r,e){return r&&e?r===e?!0:r&&r.nodeType===3?!1:e&&e.nodeType===3?Ww(r,e.parentNode):"contains"in r?r.contains(e):r.compareDocumentPosition?!!(r.compareDocumentPosition(e)&16):!1:!1}o(Ww,"Le");function Kw(){for(var r=window,e=Rd();e instanceof r.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)r=e.contentWindow;else break;e=Rd(r.document)}return e}o(Kw,"Me");function gg(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e&&(e==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||e==="textarea"||r.contentEditable==="true")}o(gg,"Ne");function zO(r){var e=Kw(),t=r.focusedElem,n=r.selectionRange;if(e!==t&&t&&t.ownerDocument&&Ww(t.ownerDocument.documentElement,t)){if(n!==null&&gg(t)){if(e=n.start,r=n.end,r===void 0&&(r=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(r,t.value.length);else if(r=(e=t.ownerDocument||document)&&e.defaultView||window,r.getSelection){r=r.getSelection();var i=t.textContent.length,a=Math.min(n.start,i);n=n.end===void 0?a:Math.min(n.end,i),!r.extend&&a>n&&(i=n,n=a,a=i),i=KE(t,a);var s=KE(t,n);i&&s&&(r.rangeCount!==1||r.anchorNode!==i.node||r.anchorOffset!==i.offset||r.focusNode!==s.node||r.focusOffset!==s.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),r.removeAllRanges(),a>n?(r.addRange(e),r.extend(s.node,s.offset)):(e.setEnd(s.node,s.offset),r.addRange(e)))}}for(e=[],r=t;r=r.parentNode;)r.nodeType===1&&e.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)r=e[t],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}o(zO,"Oe");var JO=Kn&&"documentMode"in document&&11>=document.documentMode,Ka=null,vv=null,Jo=null,pv=!1;function VE(r,e,t){var n=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;pv||Ka==null||Ka!==Rd(n)||(n=Ka,"selectionStart"in n&&gg(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),Jo&&yl(Jo,n)||(Jo=n,n=Ad(vv,"onSelect"),0<n.length&&(e=new vg("onSelect","select",null,e,t),r.push({event:e,listeners:n}),e.target=Ka)))}o(VE,"Ue");function Pu(r,e){var t={};return t[r.toLowerCase()]=e.toLowerCase(),t["Webkit"+r]="webkit"+e,t["Moz"+r]="moz"+e,t}o(Pu,"Ve");var Va={animationend:Pu("Animation","AnimationEnd"),animationiteration:Pu("Animation","AnimationIteration"),animationstart:Pu("Animation","AnimationStart"),transitionend:Pu("Transition","TransitionEnd")},ef={},Vw={};Kn&&(Vw=document.createElement("div").style,"AnimationEvent"in window||(delete Va.animationend.animation,delete Va.animationiteration.animation,delete Va.animationstart.animation),"TransitionEvent"in window||delete Va.transitionend.transition);function lh(r){if(ef[r])return ef[r];if(!Va[r])return r;var e=Va[r],t;for(t in e)if(e.hasOwnProperty(t)&&t in Vw)return ef[r]=e[t];return r}o(lh,"Ze");var Gw=lh("animationend"),qw=lh("animationiteration"),Hw=lh("animationstart"),zw=lh("transitionend"),Jw=new Map,GE="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function ji(r,e){Jw.set(r,e),Ta(e,[r])}o(ji,"ff");for(var tf=0;tf<GE.length;tf++){var rf=GE[tf],QO=rf.toLowerCase(),YO=rf[0].toUpperCase()+rf.slice(1);ji(QO,"on"+YO)}ji(Gw,"onAnimationEnd");ji(qw,"onAnimationIteration");ji(Hw,"onAnimationStart");ji("dblclick","onDoubleClick");ji("focusin","onFocus");ji("focusout","onBlur");ji(zw,"onTransitionEnd");Us("onMouseEnter",["mouseout","mouseover"]);Us("onMouseLeave",["mouseout","mouseover"]);Us("onPointerEnter",["pointerout","pointerover"]);Us("onPointerLeave",["pointerout","pointerover"]);Ta("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));Ta("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));Ta("onBeforeInput",["compositionend","keypress","textInput","paste"]);Ta("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));Ta("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));Ta("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var $o="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),XO=new Set("cancel close invalid load scroll toggle".split(" ").concat($o));function qE(r,e,t){var n=r.type||"unknown-event";r.currentTarget=t,QC(n,e,void 0,r),r.currentTarget=null}o(qE,"nf");function Qw(r,e){e=(e&4)!==0;for(var t=0;t<r.length;t++){var n=r[t],i=n.event;n=n.listeners;e:{var a=void 0;if(e)for(var s=n.length-1;0<=s;s--){var l=n[s],u=l.instance,d=l.currentTarget;if(l=l.listener,u!==a&&i.isPropagationStopped())break e;qE(i,l,d),a=u}else for(s=0;s<n.length;s++){if(l=n[s],u=l.instance,d=l.currentTarget,l=l.listener,u!==a&&i.isPropagationStopped())break e;qE(i,l,d),a=u}}}if(Cd)throw r=dv,Cd=!1,dv=null,r}o(Qw,"se");function Xe(r,e){var t=e[Ev];t===void 0&&(t=e[Ev]=new Set);var n=r+"__bubble";t.has(n)||(Yw(e,r,2,!1),t.add(n))}o(Xe,"D");function nf(r,e,t){var n=0;e&&(n|=4),Yw(t,r,n,e)}o(nf,"qf");var Mu="_reactListening"+Math.random().toString(36).slice(2);function Sl(r){if(!r[Mu]){r[Mu]=!0,iw.forEach(function(t){t!=="selectionchange"&&(XO.has(t)||nf(t,!1,r),nf(t,!0,r))});var e=r.nodeType===9?r:r.ownerDocument;e===null||e[Mu]||(e[Mu]=!0,nf("selectionchange",!1,e))}}o(Sl,"sf");function Yw(r,e,t,n){switch(Dw(e)){case 1:var i=hO;break;case 4:i=fO;break;default:i=hg}t=i.bind(null,e,t,r),i=void 0,!uv||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),n?i!==void 0?r.addEventListener(e,t,{capture:!0,passive:i}):r.addEventListener(e,t,!0):i!==void 0?r.addEventListener(e,t,{passive:i}):r.addEventListener(e,t,!1)}o(Yw,"pf");function af(r,e,t,n,i){var a=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var s=n.tag;if(s===3||s===4){var l=n.stateNode.containerInfo;if(l===i||l.nodeType===8&&l.parentNode===i)break;if(s===4)for(s=n.return;s!==null;){var u=s.tag;if((u===3||u===4)&&(u=s.stateNode.containerInfo,u===i||u.nodeType===8&&u.parentNode===i))return;s=s.return}for(;l!==null;){if(s=na(l),s===null)return;if(u=s.tag,u===5||u===6){n=a=s;continue e}l=l.parentNode}}n=n.return}Ew(function(){var d=a,c=lg(t),h=[];e:{var v=Jw.get(r);if(v!==void 0){var g=vg,p=r;switch(r){case"keypress":if(nd(t)===0)break e;case"keydown":case"keyup":g=OO;break;case"focusin":p="focus",g=Yh;break;case"focusout":p="blur",g=Yh;break;case"beforeblur":case"afterblur":g=Yh;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":g=DE;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":g=mO;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":g=MO;break;case Gw:case qw:case Hw:g=SO;break;case zw:g=xO;break;case"scroll":g=vO;break;case"wheel":g=NO;break;case"copy":case"cut":case"paste":g=_O;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":g=LE}var m=(e&4)!==0,w=!m&&r==="scroll",y=m?v!==null?v+"Capture":null:v;m=[];for(var S=d,T;S!==null;){T=S;var C=T.stateNode;if(T.tag===5&&C!==null&&(T=C,y!==null&&(C=fl(S,y),C!=null&&m.push(El(S,C,T)))),w)break;S=S.return}0<m.length&&(v=new g(v,p,null,t,c),h.push({event:v,listeners:m}))}}if(!(e&7)){e:{if(v=r==="mouseover"||r==="pointerover",g=r==="mouseout"||r==="pointerout",v&&t!==ov&&(p=t.relatedTarget||t.fromElement)&&(na(p)||p[Vn]))break e;if((g||v)&&(v=c.window===c?c:(v=c.ownerDocument)?v.defaultView||v.parentWindow:window,g?(p=t.relatedTarget||t.toElement,g=d,p=p?na(p):null,p!==null&&(w=Ra(p),p!==w||p.tag!==5&&p.tag!==6)&&(p=null)):(g=null,p=d),g!==p)){if(m=DE,C="onMouseLeave",y="onMouseEnter",S="mouse",(r==="pointerout"||r==="pointerover")&&(m=LE,C="onPointerLeave",y="onPointerEnter",S="pointer"),w=g==null?v:Ga(g),T=p==null?v:Ga(p),v=new m(C,S+"leave",g,t,c),v.target=w,v.relatedTarget=T,C=null,na(c)===d&&(m=new m(y,S+"enter",p,t,c),m.target=T,m.relatedTarget=w,C=m),w=C,g&&p)t:{for(m=g,y=p,S=0,T=m;T;T=Pa(T))S++;for(T=0,C=y;C;C=Pa(C))T++;for(;0<S-T;)m=Pa(m),S--;for(;0<T-S;)y=Pa(y),T--;for(;S--;){if(m===y||y!==null&&m===y.alternate)break t;m=Pa(m),y=Pa(y)}m=null}else m=null;g!==null&&HE(h,v,g,m,!1),p!==null&&w!==null&&HE(h,w,p,m,!0)}}e:{if(v=d?Ga(d):window,g=v.nodeName&&v.nodeName.toLowerCase(),g==="select"||g==="input"&&v.type==="file")var M=WO;else if(FE(v))if(Bw)M=qO;else{M=VO;var _=KO}else(g=v.nodeName)&&g.toLowerCase()==="input"&&(v.type==="checkbox"||v.type==="radio")&&(M=GO);if(M&&(M=M(r,d))){Fw(h,M,t,c);break e}_&&_(r,v,d),r==="focusout"&&(_=v._wrapperState)&&_.controlled&&v.type==="number"&&rv(v,"number",v.value)}switch(_=d?Ga(d):window,r){case"focusin":(FE(_)||_.contentEditable==="true")&&(Ka=_,vv=d,Jo=null);break;case"focusout":Jo=vv=Ka=null;break;case"mousedown":pv=!0;break;case"contextmenu":case"mouseup":case"dragend":pv=!1,VE(h,t,c);break;case"selectionchange":if(JO)break;case"keydown":case"keyup":VE(h,t,c)}var O;if(mg)e:{switch(r){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else Wa?Uw(r,t)&&(b="onCompositionEnd"):r==="keydown"&&t.keyCode===229&&(b="onCompositionStart");b&&(Lw&&t.locale!=="ko"&&(Wa||b!=="onCompositionStart"?b==="onCompositionEnd"&&Wa&&(O=Nw()):(mi=c,fg="value"in mi?mi.value:mi.textContent,Wa=!0)),_=Ad(d,b),0<_.length&&(b=new NE(b,r,null,t,c),h.push({event:b,listeners:_}),O?b.data=O:(O=jw(t),O!==null&&(b.data=O)))),(O=UO?jO(r,t):FO(r,t))&&(d=Ad(d,"onBeforeInput"),0<d.length&&(c=new NE("onBeforeInput","beforeinput",null,t,c),h.push({event:c,listeners:d}),c.data=O))}Qw(h,e)})}o(af,"hd");function El(r,e,t){return{instance:r,listener:e,currentTarget:t}}o(El,"tf");function Ad(r,e){for(var t=e+"Capture",n=[];r!==null;){var i=r,a=i.stateNode;i.tag===5&&a!==null&&(i=a,a=fl(r,t),a!=null&&n.unshift(El(r,a,i)),a=fl(r,e),a!=null&&n.push(El(r,a,i))),r=r.return}return n}o(Ad,"oe");function Pa(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}o(Pa,"vf");function HE(r,e,t,n,i){for(var a=e._reactName,s=[];t!==null&&t!==n;){var l=t,u=l.alternate,d=l.stateNode;if(u!==null&&u===n)break;l.tag===5&&d!==null&&(l=d,i?(u=fl(t,a),u!=null&&s.unshift(El(t,u,l))):i||(u=fl(t,a),u!=null&&s.push(El(t,u,l)))),t=t.return}s.length!==0&&r.push({event:e,listeners:s})}o(HE,"wf");var ZO=/\r\n?/g,ek=/\u0000|\uFFFD/g;function zE(r){return(typeof r=="string"?r:""+r).replace(ZO,`
`).replace(ek,"")}o(zE,"zf");function Au(r,e,t){if(e=zE(e),zE(r)!==e&&t)throw Error(ie(425))}o(Au,"Af");function xd(){}o(xd,"Bf");var mv=null,gv=null;function yv(r,e){return r==="textarea"||r==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}o(yv,"Ef");var Sv=typeof setTimeout=="function"?setTimeout:void 0,tk=typeof clearTimeout=="function"?clearTimeout:void 0,JE=typeof Promise=="function"?Promise:void 0,rk=typeof queueMicrotask=="function"?queueMicrotask:typeof JE<"u"?function(r){return JE.resolve(null).then(r).catch(nk)}:Sv;function nk(r){setTimeout(function(){throw r})}o(nk,"If");function sf(r,e){var t=e,n=0;do{var i=t.nextSibling;if(r.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(n===0){r.removeChild(i),ml(e);return}n--}else t!=="$"&&t!=="$?"&&t!=="$!"||n++;t=i}while(t);ml(e)}o(sf,"Kf");function wi(r){for(;r!=null;r=r.nextSibling){var e=r.nodeType;if(e===1||e===3)break;if(e===8){if(e=r.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return r}o(wi,"Lf");function QE(r){r=r.previousSibling;for(var e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return r;e--}else t==="/$"&&e++}r=r.previousSibling}return null}o(QE,"Mf");var ao=Math.random().toString(36).slice(2),pn="__reactFiber$"+ao,_l="__reactProps$"+ao,Vn="__reactContainer$"+ao,Ev="__reactEvents$"+ao,ik="__reactListeners$"+ao,ak="__reactHandles$"+ao;function na(r){var e=r[pn];if(e)return e;for(var t=r.parentNode;t;){if(e=t[Vn]||t[pn]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(r=QE(r);r!==null;){if(t=r[pn])return t;r=QE(r)}return e}r=t,t=r.parentNode}return null}o(na,"Wc");function nu(r){return r=r[pn]||r[Vn],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}o(nu,"Cb");function Ga(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(ie(33))}o(Ga,"ue");function uh(r){return r[_l]||null}o(uh,"Db");var _v=[],qa=-1;function Fi(r){return{current:r}}o(Fi,"Uf");function et(r){0>qa||(r.current=_v[qa],_v[qa]=null,qa--)}o(et,"E");function Ye(r,e){qa++,_v[qa]=r.current,r.current=e}o(Ye,"G");var Di={},zt=Fi(Di),hr=Fi(!1),pa=Di;function js(r,e){var t=r.type.contextTypes;if(!t)return Di;var n=r.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var i={},a;for(a in t)i[a]=e[a];return n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=e,r.__reactInternalMemoizedMaskedChildContext=i),i}o(js,"Yf");function fr(r){return r=r.childContextTypes,r!=null}o(fr,"Zf");function Dd(){et(hr),et(zt)}o(Dd,"$f");function YE(r,e,t){if(zt.current!==Di)throw Error(ie(168));Ye(zt,e),Ye(hr,t)}o(YE,"ag");function Xw(r,e,t){var n=r.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return t;n=n.getChildContext();for(var i in n)if(!(i in e))throw Error(ie(108,KC(r)||"Unknown",i));return dt({},t,n)}o(Xw,"bg");function Nd(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||Di,pa=zt.current,Ye(zt,r),Ye(hr,hr.current),!0}o(Nd,"cg");function XE(r,e,t){var n=r.stateNode;if(!n)throw Error(ie(169));t?(r=Xw(r,e,pa),n.__reactInternalMemoizedMergedChildContext=r,et(hr),et(zt),Ye(zt,r)):et(hr),Ye(hr,t)}o(XE,"dg");var Mn=null,dh=!1,of=!1;function Zw(r){Mn===null?Mn=[r]:Mn.push(r)}o(Zw,"hg");function sk(r){dh=!0,Zw(r)}o(sk,"ig");function Bi(){if(!of&&Mn!==null){of=!0;var r=0,e=Ge;try{var t=Mn;for(Ge=1;r<t.length;r++){var n=t[r];do n=n(!0);while(n!==null)}Mn=null,dh=!1}catch(i){throw Mn!==null&&(Mn=Mn.slice(r+1)),Tw(ug,Bi),i}finally{Ge=e,of=!1}}return null}o(Bi,"jg");var Ha=[],za=0,Ld=null,Ud=0,Ar=[],xr=0,ma=null,Nn=1,Ln="";function Ji(r,e){Ha[za++]=Ud,Ha[za++]=Ld,Ld=r,Ud=e}o(Ji,"tg");function eT(r,e,t){Ar[xr++]=Nn,Ar[xr++]=Ln,Ar[xr++]=ma,ma=r;var n=Nn;r=Ln;var i=32-Jr(n)-1;n&=~(1<<i),t+=1;var a=32-Jr(e)+i;if(30<a){var s=i-i%5;a=(n&(1<<s)-1).toString(32),n>>=s,i-=s,Nn=1<<32-Jr(e)+i|t<<i|n,Ln=a+r}else Nn=1<<a|t<<i|n,Ln=r}o(eT,"ug");function yg(r){r.return!==null&&(Ji(r,1),eT(r,1,0))}o(yg,"vg");function Sg(r){for(;r===Ld;)Ld=Ha[--za],Ha[za]=null,Ud=Ha[--za],Ha[za]=null;for(;r===ma;)ma=Ar[--xr],Ar[xr]=null,Ln=Ar[--xr],Ar[xr]=null,Nn=Ar[--xr],Ar[xr]=null}o(Sg,"wg");var Tr=null,wr=null,rt=!1,Hr=null;function tT(r,e){var t=Dr(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=r,e=r.deletions,e===null?(r.deletions=[t],r.flags|=16):e.push(t)}o(tT,"Ag");function ZE(r,e){switch(r.tag){case 5:var t=r.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(r.stateNode=e,Tr=r,wr=wi(e.firstChild),!0):!1;case 6:return e=r.pendingProps===""||e.nodeType!==3?null:e,e!==null?(r.stateNode=e,Tr=r,wr=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=ma!==null?{id:Nn,overflow:Ln}:null,r.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=Dr(18,null,null,0),t.stateNode=e,t.return=r,r.child=t,Tr=r,wr=null,!0):!1;default:return!1}}o(ZE,"Cg");function bv(r){return(r.mode&1)!==0&&(r.flags&128)===0}o(bv,"Dg");function wv(r){if(rt){var e=wr;if(e){var t=e;if(!ZE(r,e)){if(bv(r))throw Error(ie(418));e=wi(t.nextSibling);var n=Tr;e&&ZE(r,e)?tT(n,t):(r.flags=r.flags&-4097|2,rt=!1,Tr=r)}}else{if(bv(r))throw Error(ie(418));r.flags=r.flags&-4097|2,rt=!1,Tr=r}}}o(wv,"Eg");function e_(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;Tr=r}o(e_,"Fg");function xu(r){if(r!==Tr)return!1;if(!rt)return e_(r),rt=!0,!1;var e;if((e=r.tag!==3)&&!(e=r.tag!==5)&&(e=r.type,e=e!=="head"&&e!=="body"&&!yv(r.type,r.memoizedProps)),e&&(e=wr)){if(bv(r))throw rT(),Error(ie(418));for(;e;)tT(r,e),e=wi(e.nextSibling)}if(e_(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(ie(317));e:{for(r=r.nextSibling,e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="/$"){if(e===0){wr=wi(r.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}r=r.nextSibling}wr=null}}else wr=Tr?wi(r.stateNode.nextSibling):null;return!0}o(xu,"Gg");function rT(){for(var r=wr;r;)r=wi(r.nextSibling)}o(rT,"Hg");function Fs(){wr=Tr=null,rt=!1}o(Fs,"Ig");function Eg(r){Hr===null?Hr=[r]:Hr.push(r)}o(Eg,"Jg");var ok=Jn.ReactCurrentBatchConfig;function wo(r,e,t){if(r=t.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(ie(309));var n=t.stateNode}if(!n)throw Error(ie(147,r));var i=n,a=""+r;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===a?e.ref:(e=o(function(s){var l=i.refs;s===null?delete l[a]:l[a]=s},"b"),e._stringRef=a,e)}if(typeof r!="string")throw Error(ie(284));if(!t._owner)throw Error(ie(290,r))}return r}o(wo,"Lg");function Du(r,e){throw r=Object.prototype.toString.call(e),Error(ie(31,r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r))}o(Du,"Mg");function t_(r){var e=r._init;return e(r._payload)}o(t_,"Ng");function nT(r){function e(y,S){if(r){var T=y.deletions;T===null?(y.deletions=[S],y.flags|=16):T.push(S)}}o(e,"b");function t(y,S){if(!r)return null;for(;S!==null;)e(y,S),S=S.sibling;return null}o(t,"c");function n(y,S){for(y=new Map;S!==null;)S.key!==null?y.set(S.key,S):y.set(S.index,S),S=S.sibling;return y}o(n,"d");function i(y,S){return y=Ci(y,S),y.index=0,y.sibling=null,y}o(i,"e");function a(y,S,T){return y.index=T,r?(T=y.alternate,T!==null?(T=T.index,T<S?(y.flags|=2,S):T):(y.flags|=2,S)):(y.flags|=1048576,S)}o(a,"f");function s(y){return r&&y.alternate===null&&(y.flags|=2),y}o(s,"g");function l(y,S,T,C){return S===null||S.tag!==6?(S=vf(T,y.mode,C),S.return=y,S):(S=i(S,T),S.return=y,S)}o(l,"h");function u(y,S,T,C){var M=T.type;return M===$a?c(y,S,T.props.children,C,T.key):S!==null&&(S.elementType===M||typeof M=="object"&&M!==null&&M.$$typeof===ui&&t_(M)===S.type)?(C=i(S,T.props),C.ref=wo(y,S,T),C.return=y,C):(C=dd(T.type,T.key,T.props,null,y.mode,C),C.ref=wo(y,S,T),C.return=y,C)}o(u,"k");function d(y,S,T,C){return S===null||S.tag!==4||S.stateNode.containerInfo!==T.containerInfo||S.stateNode.implementation!==T.implementation?(S=pf(T,y.mode,C),S.return=y,S):(S=i(S,T.children||[]),S.return=y,S)}o(d,"l");function c(y,S,T,C,M){return S===null||S.tag!==7?(S=da(T,y.mode,C,M),S.return=y,S):(S=i(S,T),S.return=y,S)}o(c,"m");function h(y,S,T){if(typeof S=="string"&&S!==""||typeof S=="number")return S=vf(""+S,y.mode,T),S.return=y,S;if(typeof S=="object"&&S!==null){switch(S.$$typeof){case wu:return T=dd(S.type,S.key,S.props,null,y.mode,T),T.ref=wo(y,null,S),T.return=y,T;case Ba:return S=pf(S,y.mode,T),S.return=y,S;case ui:var C=S._init;return h(y,C(S._payload),T)}if(Fo(S)||yo(S))return S=da(S,y.mode,T,null),S.return=y,S;Du(y,S)}return null}o(h,"q");function v(y,S,T,C){var M=S!==null?S.key:null;if(typeof T=="string"&&T!==""||typeof T=="number")return M!==null?null:l(y,S,""+T,C);if(typeof T=="object"&&T!==null){switch(T.$$typeof){case wu:return T.key===M?u(y,S,T,C):null;case Ba:return T.key===M?d(y,S,T,C):null;case ui:return M=T._init,v(y,S,M(T._payload),C)}if(Fo(T)||yo(T))return M!==null?null:c(y,S,T,C,null);Du(y,T)}return null}o(v,"r");function g(y,S,T,C,M){if(typeof C=="string"&&C!==""||typeof C=="number")return y=y.get(T)||null,l(S,y,""+C,M);if(typeof C=="object"&&C!==null){switch(C.$$typeof){case wu:return y=y.get(C.key===null?T:C.key)||null,u(S,y,C,M);case Ba:return y=y.get(C.key===null?T:C.key)||null,d(S,y,C,M);case ui:var _=C._init;return g(y,S,T,_(C._payload),M)}if(Fo(C)||yo(C))return y=y.get(T)||null,c(S,y,C,M,null);Du(S,C)}return null}o(g,"y");function p(y,S,T,C){for(var M=null,_=null,O=S,b=S=0,j=null;O!==null&&b<T.length;b++){O.index>b?(j=O,O=null):j=O.sibling;var B=v(y,O,T[b],C);if(B===null){O===null&&(O=j);break}r&&O&&B.alternate===null&&e(y,O),S=a(B,S,b),_===null?M=B:_.sibling=B,_=B,O=j}if(b===T.length)return t(y,O),rt&&Ji(y,b),M;if(O===null){for(;b<T.length;b++)O=h(y,T[b],C),O!==null&&(S=a(O,S,b),_===null?M=O:_.sibling=O,_=O);return rt&&Ji(y,b),M}for(O=n(y,O);b<T.length;b++)j=g(O,y,b,T[b],C),j!==null&&(r&&j.alternate!==null&&O.delete(j.key===null?b:j.key),S=a(j,S,b),_===null?M=j:_.sibling=j,_=j);return r&&O.forEach(function(q){return e(y,q)}),rt&&Ji(y,b),M}o(p,"n");function m(y,S,T,C){var M=yo(T);if(typeof M!="function")throw Error(ie(150));if(T=M.call(T),T==null)throw Error(ie(151));for(var _=M=null,O=S,b=S=0,j=null,B=T.next();O!==null&&!B.done;b++,B=T.next()){O.index>b?(j=O,O=null):j=O.sibling;var q=v(y,O,B.value,C);if(q===null){O===null&&(O=j);break}r&&O&&q.alternate===null&&e(y,O),S=a(q,S,b),_===null?M=q:_.sibling=q,_=q,O=j}if(B.done)return t(y,O),rt&&Ji(y,b),M;if(O===null){for(;!B.done;b++,B=T.next())B=h(y,B.value,C),B!==null&&(S=a(B,S,b),_===null?M=B:_.sibling=B,_=B);return rt&&Ji(y,b),M}for(O=n(y,O);!B.done;b++,B=T.next())B=g(O,y,b,B.value,C),B!==null&&(r&&B.alternate!==null&&O.delete(B.key===null?b:B.key),S=a(B,S,b),_===null?M=B:_.sibling=B,_=B);return r&&O.forEach(function(oe){return e(y,oe)}),rt&&Ji(y,b),M}o(m,"t");function w(y,S,T,C){if(typeof T=="object"&&T!==null&&T.type===$a&&T.key===null&&(T=T.props.children),typeof T=="object"&&T!==null){switch(T.$$typeof){case wu:e:{for(var M=T.key,_=S;_!==null;){if(_.key===M){if(M=T.type,M===$a){if(_.tag===7){t(y,_.sibling),S=i(_,T.props.children),S.return=y,y=S;break e}}else if(_.elementType===M||typeof M=="object"&&M!==null&&M.$$typeof===ui&&t_(M)===_.type){t(y,_.sibling),S=i(_,T.props),S.ref=wo(y,_,T),S.return=y,y=S;break e}t(y,_);break}else e(y,_);_=_.sibling}T.type===$a?(S=da(T.props.children,y.mode,C,T.key),S.return=y,y=S):(C=dd(T.type,T.key,T.props,null,y.mode,C),C.ref=wo(y,S,T),C.return=y,y=C)}return s(y);case Ba:e:{for(_=T.key;S!==null;){if(S.key===_)if(S.tag===4&&S.stateNode.containerInfo===T.containerInfo&&S.stateNode.implementation===T.implementation){t(y,S.sibling),S=i(S,T.children||[]),S.return=y,y=S;break e}else{t(y,S);break}else e(y,S);S=S.sibling}S=pf(T,y.mode,C),S.return=y,y=S}return s(y);case ui:return _=T._init,w(y,S,_(T._payload),C)}if(Fo(T))return p(y,S,T,C);if(yo(T))return m(y,S,T,C);Du(y,T)}return typeof T=="string"&&T!==""||typeof T=="number"?(T=""+T,S!==null&&S.tag===6?(t(y,S.sibling),S=i(S,T),S.return=y,y=S):(t(y,S),S=vf(T,y.mode,C),S.return=y,y=S),s(y)):t(y,S)}return o(w,"J"),w}o(nT,"Og");var Bs=nT(!0),iT=nT(!1),jd=Fi(null),Fd=null,Ja=null,_g=null;function bg(){_g=Ja=Fd=null}o(bg,"$g");function wg(r){var e=jd.current;et(jd),r._currentValue=e}o(wg,"ah");function Tv(r,e,t){for(;r!==null;){var n=r.alternate;if((r.childLanes&e)!==e?(r.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),r===t)break;r=r.return}}o(Tv,"bh");function as(r,e){Fd=r,_g=Ja=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&e&&(dr=!0),r.firstContext=null)}o(as,"ch");function Ur(r){var e=r._currentValue;if(_g!==r)if(r={context:r,memoizedValue:e,next:null},Ja===null){if(Fd===null)throw Error(ie(308));Ja=r,Fd.dependencies={lanes:0,firstContext:r}}else Ja=Ja.next=r;return e}o(Ur,"eh");var ia=null;function Tg(r){ia===null?ia=[r]:ia.push(r)}o(Tg,"gh");function aT(r,e,t,n){var i=e.interleaved;return i===null?(t.next=t,Tg(e)):(t.next=i.next,i.next=t),e.interleaved=t,Gn(r,n)}o(aT,"hh");function Gn(r,e){r.lanes|=e;var t=r.alternate;for(t!==null&&(t.lanes|=e),t=r,r=r.return;r!==null;)r.childLanes|=e,t=r.alternate,t!==null&&(t.childLanes|=e),t=r,r=r.return;return t.tag===3?t.stateNode:null}o(Gn,"ih");var di=!1;function Rg(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}o(Rg,"kh");function sT(r,e){r=r.updateQueue,e.updateQueue===r&&(e.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}o(sT,"lh");function $n(r,e){return{eventTime:r,lane:e,tag:0,payload:null,callback:null,next:null}}o($n,"mh");function Ti(r,e,t){var n=r.updateQueue;if(n===null)return null;if(n=n.shared,Fe&2){var i=n.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),n.pending=e,Gn(r,t)}return i=n.interleaved,i===null?(e.next=e,Tg(n)):(e.next=i.next,i.next=e),n.interleaved=e,Gn(r,t)}o(Ti,"nh");function id(r,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,dg(r,t)}}o(id,"oh");function r_(r,e){var t=r.updateQueue,n=r.alternate;if(n!==null&&(n=n.updateQueue,t===n)){var i=null,a=null;if(t=t.firstBaseUpdate,t!==null){do{var s={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};a===null?i=a=s:a=a.next=s,t=t.next}while(t!==null);a===null?i=a=e:a=a.next=e}else i=a=e;t={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:a,shared:n.shared,effects:n.effects},r.updateQueue=t;return}r=t.lastBaseUpdate,r===null?t.firstBaseUpdate=e:r.next=e,t.lastBaseUpdate=e}o(r_,"ph");function Bd(r,e,t,n){var i=r.updateQueue;di=!1;var a=i.firstBaseUpdate,s=i.lastBaseUpdate,l=i.shared.pending;if(l!==null){i.shared.pending=null;var u=l,d=u.next;u.next=null,s===null?a=d:s.next=d,s=u;var c=r.alternate;c!==null&&(c=c.updateQueue,l=c.lastBaseUpdate,l!==s&&(l===null?c.firstBaseUpdate=d:l.next=d,c.lastBaseUpdate=u))}if(a!==null){var h=i.baseState;s=0,c=d=u=null,l=a;do{var v=l.lane,g=l.eventTime;if((n&v)===v){c!==null&&(c=c.next={eventTime:g,lane:0,tag:l.tag,payload:l.payload,callback:l.callback,next:null});e:{var p=r,m=l;switch(v=e,g=t,m.tag){case 1:if(p=m.payload,typeof p=="function"){h=p.call(g,h,v);break e}h=p;break e;case 3:p.flags=p.flags&-65537|128;case 0:if(p=m.payload,v=typeof p=="function"?p.call(g,h,v):p,v==null)break e;h=dt({},h,v);break e;case 2:di=!0}}l.callback!==null&&l.lane!==0&&(r.flags|=64,v=i.effects,v===null?i.effects=[l]:v.push(l))}else g={eventTime:g,lane:v,tag:l.tag,payload:l.payload,callback:l.callback,next:null},c===null?(d=c=g,u=h):c=c.next=g,s|=v;if(l=l.next,l===null){if(l=i.shared.pending,l===null)break;v=l,l=v.next,v.next=null,i.lastBaseUpdate=v,i.shared.pending=null}}while(!0);if(c===null&&(u=h),i.baseState=u,i.firstBaseUpdate=d,i.lastBaseUpdate=c,e=i.shared.interleaved,e!==null){i=e;do s|=i.lane,i=i.next;while(i!==e)}else a===null&&(i.shared.lanes=0);ya|=s,r.lanes=s,r.memoizedState=h}}o(Bd,"qh");function n_(r,e,t){if(r=e.effects,e.effects=null,r!==null)for(e=0;e<r.length;e++){var n=r[e],i=n.callback;if(i!==null){if(n.callback=null,n=t,typeof i!="function")throw Error(ie(191,i));i.call(n)}}}o(n_,"sh");var iu={},En=Fi(iu),bl=Fi(iu),wl=Fi(iu);function aa(r){if(r===iu)throw Error(ie(174));return r}o(aa,"xh");function Ig(r,e){switch(Ye(wl,e),Ye(bl,r),Ye(En,iu),r=e.nodeType,r){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:iv(null,"");break;default:r=r===8?e.parentNode:e,e=r.namespaceURI||null,r=r.tagName,e=iv(e,r)}et(En),Ye(En,e)}o(Ig,"yh");function $s(){et(En),et(bl),et(wl)}o($s,"zh");function oT(r){aa(wl.current);var e=aa(En.current),t=iv(e,r.type);e!==t&&(Ye(bl,r),Ye(En,t))}o(oT,"Ah");function Cg(r){bl.current===r&&(et(En),et(bl))}o(Cg,"Bh");var st=Fi(0);function $d(r){for(var e=r;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}o($d,"Ch");var lf=[];function Og(){for(var r=0;r<lf.length;r++)lf[r]._workInProgressVersionPrimary=null;lf.length=0}o(Og,"Eh");var ad=Jn.ReactCurrentDispatcher,uf=Jn.ReactCurrentBatchConfig,ga=0,lt=null,kt=null,xt=null,Wd=!1,Qo=!1,Tl=0,lk=0;function Wt(){throw Error(ie(321))}o(Wt,"P");function kg(r,e){if(e===null)return!1;for(var t=0;t<e.length&&t<r.length;t++)if(!en(r[t],e[t]))return!1;return!0}o(kg,"Mh");function Pg(r,e,t,n,i,a){if(ga=a,lt=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,ad.current=r===null||r.memoizedState===null?hk:fk,r=t(n,i),Qo){a=0;do{if(Qo=!1,Tl=0,25<=a)throw Error(ie(301));a+=1,xt=kt=null,e.updateQueue=null,ad.current=vk,r=t(n,i)}while(Qo)}if(ad.current=Kd,e=kt!==null&&kt.next!==null,ga=0,xt=kt=lt=null,Wd=!1,e)throw Error(ie(300));return r}o(Pg,"Nh");function Mg(){var r=Tl!==0;return Tl=0,r}o(Mg,"Sh");function un(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return xt===null?lt.memoizedState=xt=r:xt=xt.next=r,xt}o(un,"Th");function jr(){if(kt===null){var r=lt.alternate;r=r!==null?r.memoizedState:null}else r=kt.next;var e=xt===null?lt.memoizedState:xt.next;if(e!==null)xt=e,kt=r;else{if(r===null)throw Error(ie(310));kt=r,r={memoizedState:kt.memoizedState,baseState:kt.baseState,baseQueue:kt.baseQueue,queue:kt.queue,next:null},xt===null?lt.memoizedState=xt=r:xt=xt.next=r}return xt}o(jr,"Uh");function Rl(r,e){return typeof e=="function"?e(r):e}o(Rl,"Vh");function df(r){var e=jr(),t=e.queue;if(t===null)throw Error(ie(311));t.lastRenderedReducer=r;var n=kt,i=n.baseQueue,a=t.pending;if(a!==null){if(i!==null){var s=i.next;i.next=a.next,a.next=s}n.baseQueue=i=a,t.pending=null}if(i!==null){a=i.next,n=n.baseState;var l=s=null,u=null,d=a;do{var c=d.lane;if((ga&c)===c)u!==null&&(u=u.next={lane:0,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null}),n=d.hasEagerState?d.eagerState:r(n,d.action);else{var h={lane:c,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null};u===null?(l=u=h,s=n):u=u.next=h,lt.lanes|=c,ya|=c}d=d.next}while(d!==null&&d!==a);u===null?s=n:u.next=l,en(n,e.memoizedState)||(dr=!0),e.memoizedState=n,e.baseState=s,e.baseQueue=u,t.lastRenderedState=n}if(r=t.interleaved,r!==null){i=r;do a=i.lane,lt.lanes|=a,ya|=a,i=i.next;while(i!==r)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}o(df,"Wh");function cf(r){var e=jr(),t=e.queue;if(t===null)throw Error(ie(311));t.lastRenderedReducer=r;var n=t.dispatch,i=t.pending,a=e.memoizedState;if(i!==null){t.pending=null;var s=i=i.next;do a=r(a,s.action),s=s.next;while(s!==i);en(a,e.memoizedState)||(dr=!0),e.memoizedState=a,e.baseQueue===null&&(e.baseState=a),t.lastRenderedState=a}return[a,n]}o(cf,"Xh");function lT(){}o(lT,"Yh");function uT(r,e){var t=lt,n=jr(),i=e(),a=!en(n.memoizedState,i);if(a&&(n.memoizedState=i,dr=!0),n=n.queue,Ag(hT.bind(null,t,n,r),[r]),n.getSnapshot!==e||a||xt!==null&&xt.memoizedState.tag&1){if(t.flags|=2048,Il(9,cT.bind(null,t,n,i,e),void 0,null),Nt===null)throw Error(ie(349));ga&30||dT(t,e,i)}return i}o(uT,"Zh");function dT(r,e,t){r.flags|=16384,r={getSnapshot:e,value:t},e=lt.updateQueue,e===null?(e={lastEffect:null,stores:null},lt.updateQueue=e,e.stores=[r]):(t=e.stores,t===null?e.stores=[r]:t.push(r))}o(dT,"di");function cT(r,e,t,n){e.value=t,e.getSnapshot=n,fT(e)&&vT(r)}o(cT,"ci");function hT(r,e,t){return t(function(){fT(e)&&vT(r)})}o(hT,"ai");function fT(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!en(r,t)}catch{return!0}}o(fT,"ei");function vT(r){var e=Gn(r,1);e!==null&&Qr(e,r,1,-1)}o(vT,"fi");function i_(r){var e=un();return typeof r=="function"&&(r=r()),e.memoizedState=e.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Rl,lastRenderedState:r},e.queue=r,r=r.dispatch=ck.bind(null,lt,r),[e.memoizedState,r]}o(i_,"hi");function Il(r,e,t,n){return r={tag:r,create:e,destroy:t,deps:n,next:null},e=lt.updateQueue,e===null?(e={lastEffect:null,stores:null},lt.updateQueue=e,e.lastEffect=r.next=r):(t=e.lastEffect,t===null?e.lastEffect=r.next=r:(n=t.next,t.next=r,r.next=n,e.lastEffect=r)),r}o(Il,"bi");function pT(){return jr().memoizedState}o(pT,"ji");function sd(r,e,t,n){var i=un();lt.flags|=r,i.memoizedState=Il(1|e,t,void 0,n===void 0?null:n)}o(sd,"ki");function ch(r,e,t,n){var i=jr();n=n===void 0?null:n;var a=void 0;if(kt!==null){var s=kt.memoizedState;if(a=s.destroy,n!==null&&kg(n,s.deps)){i.memoizedState=Il(e,t,a,n);return}}lt.flags|=r,i.memoizedState=Il(1|e,t,a,n)}o(ch,"li");function a_(r,e){return sd(8390656,8,r,e)}o(a_,"mi");function Ag(r,e){return ch(2048,8,r,e)}o(Ag,"$h");function mT(r,e){return ch(4,2,r,e)}o(mT,"ni");function gT(r,e){return ch(4,4,r,e)}o(gT,"oi");function yT(r,e){if(typeof e=="function")return r=r(),e(r),function(){e(null)};if(e!=null)return r=r(),e.current=r,function(){e.current=null}}o(yT,"pi");function ST(r,e,t){return t=t!=null?t.concat([r]):null,ch(4,4,yT.bind(null,e,r),t)}o(ST,"qi");function xg(){}o(xg,"ri");function ET(r,e){var t=jr();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&kg(e,n[1])?n[0]:(t.memoizedState=[r,e],r)}o(ET,"si");function _T(r,e){var t=jr();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&kg(e,n[1])?n[0]:(r=r(),t.memoizedState=[r,e],r)}o(_T,"ti");function bT(r,e,t){return ga&21?(en(t,e)||(t=Cw(),lt.lanes|=t,ya|=t,r.baseState=!0),e):(r.baseState&&(r.baseState=!1,dr=!0),r.memoizedState=t)}o(bT,"ui");function uk(r,e){var t=Ge;Ge=t!==0&&4>t?t:4,r(!0);var n=uf.transition;uf.transition={};try{r(!1),e()}finally{Ge=t,uf.transition=n}}o(uk,"vi");function wT(){return jr().memoizedState}o(wT,"wi");function dk(r,e,t){var n=Ii(r);if(t={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null},TT(r))RT(e,t);else if(t=aT(r,e,t,n),t!==null){var i=rr();Qr(t,r,n,i),IT(t,e,n)}}o(dk,"xi");function ck(r,e,t){var n=Ii(r),i={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null};if(TT(r))RT(e,i);else{var a=r.alternate;if(r.lanes===0&&(a===null||a.lanes===0)&&(a=e.lastRenderedReducer,a!==null))try{var s=e.lastRenderedState,l=a(s,t);if(i.hasEagerState=!0,i.eagerState=l,en(l,s)){var u=e.interleaved;u===null?(i.next=i,Tg(e)):(i.next=u.next,u.next=i),e.interleaved=i;return}}catch{}finally{}t=aT(r,e,i,n),t!==null&&(i=rr(),Qr(t,r,n,i),IT(t,e,n))}}o(ck,"ii");function TT(r){var e=r.alternate;return r===lt||e!==null&&e===lt}o(TT,"zi");function RT(r,e){Qo=Wd=!0;var t=r.pending;t===null?e.next=e:(e.next=t.next,t.next=e),r.pending=e}o(RT,"Ai");function IT(r,e,t){if(t&4194240){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,dg(r,t)}}o(IT,"Bi");var Kd={readContext:Ur,useCallback:Wt,useContext:Wt,useEffect:Wt,useImperativeHandle:Wt,useInsertionEffect:Wt,useLayoutEffect:Wt,useMemo:Wt,useReducer:Wt,useRef:Wt,useState:Wt,useDebugValue:Wt,useDeferredValue:Wt,useTransition:Wt,useMutableSource:Wt,useSyncExternalStore:Wt,useId:Wt,unstable_isNewReconciler:!1},hk={readContext:Ur,useCallback:o(function(r,e){return un().memoizedState=[r,e===void 0?null:e],r},"useCallback"),useContext:Ur,useEffect:a_,useImperativeHandle:o(function(r,e,t){return t=t!=null?t.concat([r]):null,sd(4194308,4,yT.bind(null,e,r),t)},"useImperativeHandle"),useLayoutEffect:o(function(r,e){return sd(4194308,4,r,e)},"useLayoutEffect"),useInsertionEffect:o(function(r,e){return sd(4,2,r,e)},"useInsertionEffect"),useMemo:o(function(r,e){var t=un();return e=e===void 0?null:e,r=r(),t.memoizedState=[r,e],r},"useMemo"),useReducer:o(function(r,e,t){var n=un();return e=t!==void 0?t(e):e,n.memoizedState=n.baseState=e,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:e},n.queue=r,r=r.dispatch=dk.bind(null,lt,r),[n.memoizedState,r]},"useReducer"),useRef:o(function(r){var e=un();return r={current:r},e.memoizedState=r},"useRef"),useState:i_,useDebugValue:xg,useDeferredValue:o(function(r){return un().memoizedState=r},"useDeferredValue"),useTransition:o(function(){var r=i_(!1),e=r[0];return r=uk.bind(null,r[1]),un().memoizedState=r,[e,r]},"useTransition"),useMutableSource:o(function(){},"useMutableSource"),useSyncExternalStore:o(function(r,e,t){var n=lt,i=un();if(rt){if(t===void 0)throw Error(ie(407));t=t()}else{if(t=e(),Nt===null)throw Error(ie(349));ga&30||dT(n,e,t)}i.memoizedState=t;var a={value:t,getSnapshot:e};return i.queue=a,a_(hT.bind(null,n,a,r),[r]),n.flags|=2048,Il(9,cT.bind(null,n,a,t,e),void 0,null),t},"useSyncExternalStore"),useId:o(function(){var r=un(),e=Nt.identifierPrefix;if(rt){var t=Ln,n=Nn;t=(n&~(1<<32-Jr(n)-1)).toString(32)+t,e=":"+e+"R"+t,t=Tl++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=lk++,e=":"+e+"r"+t.toString(32)+":";return r.memoizedState=e},"useId"),unstable_isNewReconciler:!1},fk={readContext:Ur,useCallback:ET,useContext:Ur,useEffect:Ag,useImperativeHandle:ST,useInsertionEffect:mT,useLayoutEffect:gT,useMemo:_T,useReducer:df,useRef:pT,useState:o(function(){return df(Rl)},"useState"),useDebugValue:xg,useDeferredValue:o(function(r){var e=jr();return bT(e,kt.memoizedState,r)},"useDeferredValue"),useTransition:o(function(){var r=df(Rl)[0],e=jr().memoizedState;return[r,e]},"useTransition"),useMutableSource:lT,useSyncExternalStore:uT,useId:wT,unstable_isNewReconciler:!1},vk={readContext:Ur,useCallback:ET,useContext:Ur,useEffect:Ag,useImperativeHandle:ST,useInsertionEffect:mT,useLayoutEffect:gT,useMemo:_T,useReducer:cf,useRef:pT,useState:o(function(){return cf(Rl)},"useState"),useDebugValue:xg,useDeferredValue:o(function(r){var e=jr();return kt===null?e.memoizedState=r:bT(e,kt.memoizedState,r)},"useDeferredValue"),useTransition:o(function(){var r=cf(Rl)[0],e=jr().memoizedState;return[r,e]},"useTransition"),useMutableSource:lT,useSyncExternalStore:uT,useId:wT,unstable_isNewReconciler:!1};function Kr(r,e){if(r&&r.defaultProps){e=dt({},e),r=r.defaultProps;for(var t in r)e[t]===void 0&&(e[t]=r[t]);return e}return e}o(Kr,"Ci");function Rv(r,e,t,n){e=r.memoizedState,t=t(n,e),t=t==null?e:dt({},e,t),r.memoizedState=t,r.lanes===0&&(r.updateQueue.baseState=t)}o(Rv,"Di");var hh={isMounted:o(function(r){return(r=r._reactInternals)?Ra(r)===r:!1},"isMounted"),enqueueSetState:o(function(r,e,t){r=r._reactInternals;var n=rr(),i=Ii(r),a=$n(n,i);a.payload=e,t!=null&&(a.callback=t),e=Ti(r,a,i),e!==null&&(Qr(e,r,i,n),id(e,r,i))},"enqueueSetState"),enqueueReplaceState:o(function(r,e,t){r=r._reactInternals;var n=rr(),i=Ii(r),a=$n(n,i);a.tag=1,a.payload=e,t!=null&&(a.callback=t),e=Ti(r,a,i),e!==null&&(Qr(e,r,i,n),id(e,r,i))},"enqueueReplaceState"),enqueueForceUpdate:o(function(r,e){r=r._reactInternals;var t=rr(),n=Ii(r),i=$n(t,n);i.tag=2,e!=null&&(i.callback=e),e=Ti(r,i,n),e!==null&&(Qr(e,r,n,t),id(e,r,n))},"enqueueForceUpdate")};function s_(r,e,t,n,i,a,s){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(n,a,s):e.prototype&&e.prototype.isPureReactComponent?!yl(t,n)||!yl(i,a):!0}o(s_,"Fi");function CT(r,e,t){var n=!1,i=Di,a=e.contextType;return typeof a=="object"&&a!==null?a=Ur(a):(i=fr(e)?pa:zt.current,n=e.contextTypes,a=(n=n!=null)?js(r,i):Di),e=new e(t,a),r.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=hh,r.stateNode=e,e._reactInternals=r,n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=i,r.__reactInternalMemoizedMaskedChildContext=a),e}o(CT,"Gi");function o_(r,e,t,n){r=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,n),e.state!==r&&hh.enqueueReplaceState(e,e.state,null)}o(o_,"Hi");function Iv(r,e,t,n){var i=r.stateNode;i.props=t,i.state=r.memoizedState,i.refs={},Rg(r);var a=e.contextType;typeof a=="object"&&a!==null?i.context=Ur(a):(a=fr(e)?pa:zt.current,i.context=js(r,a)),i.state=r.memoizedState,a=e.getDerivedStateFromProps,typeof a=="function"&&(Rv(r,e,a,t),i.state=r.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&hh.enqueueReplaceState(i,i.state,null),Bd(r,t,i,n),i.state=r.memoizedState),typeof i.componentDidMount=="function"&&(r.flags|=4194308)}o(Iv,"Ii");function Ws(r,e){try{var t="",n=e;do t+=WC(n),n=n.return;while(n);var i=t}catch(a){i=`
Error generating stack: `+a.message+`
`+a.stack}return{value:r,source:e,stack:i,digest:null}}o(Ws,"Ji");function hf(r,e,t){return{value:r,source:null,stack:t??null,digest:e??null}}o(hf,"Ki");function Cv(r,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}o(Cv,"Li");var pk=typeof WeakMap=="function"?WeakMap:Map;function OT(r,e,t){t=$n(-1,t),t.tag=3,t.payload={element:null};var n=e.value;return t.callback=function(){Gd||(Gd=!0,Uv=n),Cv(r,e)},t}o(OT,"Ni");function kT(r,e,t){t=$n(-1,t),t.tag=3;var n=r.type.getDerivedStateFromError;if(typeof n=="function"){var i=e.value;t.payload=function(){return n(i)},t.callback=function(){Cv(r,e)}}var a=r.stateNode;return a!==null&&typeof a.componentDidCatch=="function"&&(t.callback=function(){Cv(r,e),typeof n!="function"&&(Ri===null?Ri=new Set([this]):Ri.add(this));var s=e.stack;this.componentDidCatch(e.value,{componentStack:s!==null?s:""})}),t}o(kT,"Qi");function l_(r,e,t){var n=r.pingCache;if(n===null){n=r.pingCache=new pk;var i=new Set;n.set(e,i)}else i=n.get(e),i===void 0&&(i=new Set,n.set(e,i));i.has(t)||(i.add(t),r=kk.bind(null,r,e,t),e.then(r,r))}o(l_,"Si");function u_(r){do{var e;if((e=r.tag===13)&&(e=r.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return r;r=r.return}while(r!==null);return null}o(u_,"Ui");function d_(r,e,t,n,i){return r.mode&1?(r.flags|=65536,r.lanes=i,r):(r===e?r.flags|=65536:(r.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=$n(-1,1),e.tag=2,Ti(t,e,1))),t.lanes|=1),r)}o(d_,"Vi");var mk=Jn.ReactCurrentOwner,dr=!1;function Zt(r,e,t,n){e.child=r===null?iT(e,null,t,n):Bs(e,r.child,t,n)}o(Zt,"Xi");function c_(r,e,t,n,i){t=t.render;var a=e.ref;return as(e,i),n=Pg(r,e,t,n,a,i),t=Mg(),r!==null&&!dr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,qn(r,e,i)):(rt&&t&&yg(e),e.flags|=1,Zt(r,e,n,i),e.child)}o(c_,"Yi");function h_(r,e,t,n,i){if(r===null){var a=t.type;return typeof a=="function"&&!$g(a)&&a.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=a,PT(r,e,a,n,i)):(r=dd(t.type,null,n,e,e.mode,i),r.ref=e.ref,r.return=e,e.child=r)}if(a=r.child,!(r.lanes&i)){var s=a.memoizedProps;if(t=t.compare,t=t!==null?t:yl,t(s,n)&&r.ref===e.ref)return qn(r,e,i)}return e.flags|=1,r=Ci(a,n),r.ref=e.ref,r.return=e,e.child=r}o(h_,"$i");function PT(r,e,t,n,i){if(r!==null){var a=r.memoizedProps;if(yl(a,n)&&r.ref===e.ref)if(dr=!1,e.pendingProps=n=a,(r.lanes&i)!==0)r.flags&131072&&(dr=!0);else return e.lanes=r.lanes,qn(r,e,i)}return Ov(r,e,t,n,i)}o(PT,"bj");function MT(r,e,t){var n=e.pendingProps,i=n.children,a=r!==null?r.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ye(Ya,_r),_r|=t;else{if(!(t&1073741824))return r=a!==null?a.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:r,cachePool:null,transitions:null},e.updateQueue=null,Ye(Ya,_r),_r|=r,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=a!==null?a.baseLanes:t,Ye(Ya,_r),_r|=n}else a!==null?(n=a.baseLanes|t,e.memoizedState=null):n=t,Ye(Ya,_r),_r|=n;return Zt(r,e,i,t),e.child}o(MT,"dj");function AT(r,e){var t=e.ref;(r===null&&t!==null||r!==null&&r.ref!==t)&&(e.flags|=512,e.flags|=2097152)}o(AT,"gj");function Ov(r,e,t,n,i){var a=fr(t)?pa:zt.current;return a=js(e,a),as(e,i),t=Pg(r,e,t,n,a,i),n=Mg(),r!==null&&!dr?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,qn(r,e,i)):(rt&&n&&yg(e),e.flags|=1,Zt(r,e,t,i),e.child)}o(Ov,"cj");function f_(r,e,t,n,i){if(fr(t)){var a=!0;Nd(e)}else a=!1;if(as(e,i),e.stateNode===null)od(r,e),CT(e,t,n),Iv(e,t,n,i),n=!0;else if(r===null){var s=e.stateNode,l=e.memoizedProps;s.props=l;var u=s.context,d=t.contextType;typeof d=="object"&&d!==null?d=Ur(d):(d=fr(t)?pa:zt.current,d=js(e,d));var c=t.getDerivedStateFromProps,h=typeof c=="function"||typeof s.getSnapshotBeforeUpdate=="function";h||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(l!==n||u!==d)&&o_(e,s,n,d),di=!1;var v=e.memoizedState;s.state=v,Bd(e,n,s,i),u=e.memoizedState,l!==n||v!==u||hr.current||di?(typeof c=="function"&&(Rv(e,t,c,n),u=e.memoizedState),(l=di||s_(e,t,l,n,v,u,d))?(h||typeof s.UNSAFE_componentWillMount!="function"&&typeof s.componentWillMount!="function"||(typeof s.componentWillMount=="function"&&s.componentWillMount(),typeof s.UNSAFE_componentWillMount=="function"&&s.UNSAFE_componentWillMount()),typeof s.componentDidMount=="function"&&(e.flags|=4194308)):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=u),s.props=n,s.state=u,s.context=d,n=l):(typeof s.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{s=e.stateNode,sT(r,e),l=e.memoizedProps,d=e.type===e.elementType?l:Kr(e.type,l),s.props=d,h=e.pendingProps,v=s.context,u=t.contextType,typeof u=="object"&&u!==null?u=Ur(u):(u=fr(t)?pa:zt.current,u=js(e,u));var g=t.getDerivedStateFromProps;(c=typeof g=="function"||typeof s.getSnapshotBeforeUpdate=="function")||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(l!==h||v!==u)&&o_(e,s,n,u),di=!1,v=e.memoizedState,s.state=v,Bd(e,n,s,i);var p=e.memoizedState;l!==h||v!==p||hr.current||di?(typeof g=="function"&&(Rv(e,t,g,n),p=e.memoizedState),(d=di||s_(e,t,d,n,v,p,u)||!1)?(c||typeof s.UNSAFE_componentWillUpdate!="function"&&typeof s.componentWillUpdate!="function"||(typeof s.componentWillUpdate=="function"&&s.componentWillUpdate(n,p,u),typeof s.UNSAFE_componentWillUpdate=="function"&&s.UNSAFE_componentWillUpdate(n,p,u)),typeof s.componentDidUpdate=="function"&&(e.flags|=4),typeof s.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof s.componentDidUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=p),s.props=n,s.state=p,s.context=u,n=d):(typeof s.componentDidUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||l===r.memoizedProps&&v===r.memoizedState||(e.flags|=1024),n=!1)}return kv(r,e,t,n,a,i)}o(f_,"hj");function kv(r,e,t,n,i,a){AT(r,e);var s=(e.flags&128)!==0;if(!n&&!s)return i&&XE(e,t,!1),qn(r,e,a);n=e.stateNode,mk.current=e;var l=s&&typeof t.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,r!==null&&s?(e.child=Bs(e,r.child,null,a),e.child=Bs(e,null,l,a)):Zt(r,e,l,a),e.memoizedState=n.state,i&&XE(e,t,!0),e.child}o(kv,"jj");function xT(r){var e=r.stateNode;e.pendingContext?YE(r,e.pendingContext,e.pendingContext!==e.context):e.context&&YE(r,e.context,!1),Ig(r,e.containerInfo)}o(xT,"kj");function v_(r,e,t,n,i){return Fs(),Eg(i),e.flags|=256,Zt(r,e,t,n),e.child}o(v_,"lj");var Pv={dehydrated:null,treeContext:null,retryLane:0};function Mv(r){return{baseLanes:r,cachePool:null,transitions:null}}o(Mv,"nj");function DT(r,e,t){var n=e.pendingProps,i=st.current,a=!1,s=(e.flags&128)!==0,l;if((l=s)||(l=r!==null&&r.memoizedState===null?!1:(i&2)!==0),l?(a=!0,e.flags&=-129):(r===null||r.memoizedState!==null)&&(i|=1),Ye(st,i&1),r===null)return wv(e),r=e.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(e.mode&1?r.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(s=n.children,r=n.fallback,a?(n=e.mode,a=e.child,s={mode:"hidden",children:s},!(n&1)&&a!==null?(a.childLanes=0,a.pendingProps=s):a=ph(s,n,0,null),r=da(r,n,t,null),a.return=e,r.return=e,a.sibling=r,e.child=a,e.child.memoizedState=Mv(t),e.memoizedState=Pv,r):Dg(e,s));if(i=r.memoizedState,i!==null&&(l=i.dehydrated,l!==null))return gk(r,e,s,n,l,i,t);if(a){a=n.fallback,s=e.mode,i=r.child,l=i.sibling;var u={mode:"hidden",children:n.children};return!(s&1)&&e.child!==i?(n=e.child,n.childLanes=0,n.pendingProps=u,e.deletions=null):(n=Ci(i,u),n.subtreeFlags=i.subtreeFlags&14680064),l!==null?a=Ci(l,a):(a=da(a,s,t,null),a.flags|=2),a.return=e,n.return=e,n.sibling=a,e.child=n,n=a,a=e.child,s=r.child.memoizedState,s=s===null?Mv(t):{baseLanes:s.baseLanes|t,cachePool:null,transitions:s.transitions},a.memoizedState=s,a.childLanes=r.childLanes&~t,e.memoizedState=Pv,n}return a=r.child,r=a.sibling,n=Ci(a,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=t),n.return=e,n.sibling=null,r!==null&&(t=e.deletions,t===null?(e.deletions=[r],e.flags|=16):t.push(r)),e.child=n,e.memoizedState=null,n}o(DT,"oj");function Dg(r,e){return e=ph({mode:"visible",children:e},r.mode,0,null),e.return=r,r.child=e}o(Dg,"qj");function Nu(r,e,t,n){return n!==null&&Eg(n),Bs(e,r.child,null,t),r=Dg(e,e.pendingProps.children),r.flags|=2,e.memoizedState=null,r}o(Nu,"sj");function gk(r,e,t,n,i,a,s){if(t)return e.flags&256?(e.flags&=-257,n=hf(Error(ie(422))),Nu(r,e,s,n)):e.memoizedState!==null?(e.child=r.child,e.flags|=128,null):(a=n.fallback,i=e.mode,n=ph({mode:"visible",children:n.children},i,0,null),a=da(a,i,s,null),a.flags|=2,n.return=e,a.return=e,n.sibling=a,e.child=n,e.mode&1&&Bs(e,r.child,null,s),e.child.memoizedState=Mv(s),e.memoizedState=Pv,a);if(!(e.mode&1))return Nu(r,e,s,null);if(i.data==="$!"){if(n=i.nextSibling&&i.nextSibling.dataset,n)var l=n.dgst;return n=l,a=Error(ie(419)),n=hf(a,n,void 0),Nu(r,e,s,n)}if(l=(s&r.childLanes)!==0,dr||l){if(n=Nt,n!==null){switch(s&-s){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(n.suspendedLanes|s)?0:i,i!==0&&i!==a.retryLane&&(a.retryLane=i,Gn(r,i),Qr(n,r,i,-1))}return Bg(),n=hf(Error(ie(421))),Nu(r,e,s,n)}return i.data==="$?"?(e.flags|=128,e.child=r.child,e=Pk.bind(null,r),i._reactRetry=e,null):(r=a.treeContext,wr=wi(i.nextSibling),Tr=e,rt=!0,Hr=null,r!==null&&(Ar[xr++]=Nn,Ar[xr++]=Ln,Ar[xr++]=ma,Nn=r.id,Ln=r.overflow,ma=e),e=Dg(e,n.children),e.flags|=4096,e)}o(gk,"rj");function p_(r,e,t){r.lanes|=e;var n=r.alternate;n!==null&&(n.lanes|=e),Tv(r.return,e,t)}o(p_,"vj");function ff(r,e,t,n,i){var a=r.memoizedState;a===null?r.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:t,tailMode:i}:(a.isBackwards=e,a.rendering=null,a.renderingStartTime=0,a.last=n,a.tail=t,a.tailMode=i)}o(ff,"wj");function NT(r,e,t){var n=e.pendingProps,i=n.revealOrder,a=n.tail;if(Zt(r,e,n.children,t),n=st.current,n&2)n=n&1|2,e.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=e.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&p_(r,t,e);else if(r.tag===19)p_(r,t,e);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break e;for(;r.sibling===null;){if(r.return===null||r.return===e)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}n&=1}if(Ye(st,n),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)r=t.alternate,r!==null&&$d(r)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),ff(e,!1,i,t,a);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(r=i.alternate,r!==null&&$d(r)===null){e.child=i;break}r=i.sibling,i.sibling=t,t=i,i=r}ff(e,!0,t,null,a);break;case"together":ff(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}o(NT,"xj");function od(r,e){!(e.mode&1)&&r!==null&&(r.alternate=null,e.alternate=null,e.flags|=2)}o(od,"ij");function qn(r,e,t){if(r!==null&&(e.dependencies=r.dependencies),ya|=e.lanes,!(t&e.childLanes))return null;if(r!==null&&e.child!==r.child)throw Error(ie(153));if(e.child!==null){for(r=e.child,t=Ci(r,r.pendingProps),e.child=t,t.return=e;r.sibling!==null;)r=r.sibling,t=t.sibling=Ci(r,r.pendingProps),t.return=e;t.sibling=null}return e.child}o(qn,"Zi");function yk(r,e,t){switch(e.tag){case 3:xT(e),Fs();break;case 5:oT(e);break;case 1:fr(e.type)&&Nd(e);break;case 4:Ig(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,i=e.memoizedProps.value;Ye(jd,n._currentValue),n._currentValue=i;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(Ye(st,st.current&1),e.flags|=128,null):t&e.child.childLanes?DT(r,e,t):(Ye(st,st.current&1),r=qn(r,e,t),r!==null?r.sibling:null);Ye(st,st.current&1);break;case 19:if(n=(t&e.childLanes)!==0,r.flags&128){if(n)return NT(r,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),Ye(st,st.current),n)break;return null;case 22:case 23:return e.lanes=0,MT(r,e,t)}return qn(r,e,t)}o(yk,"yj");var LT,Av,UT,jT;LT=o(function(r,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)r.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}},"zj");Av=o(function(){},"Aj");UT=o(function(r,e,t,n){var i=r.memoizedProps;if(i!==n){r=e.stateNode,aa(En.current);var a=null;switch(t){case"input":i=ev(r,i),n=ev(r,n),a=[];break;case"select":i=dt({},i,{value:void 0}),n=dt({},n,{value:void 0}),a=[];break;case"textarea":i=nv(r,i),n=nv(r,n),a=[];break;default:typeof i.onClick!="function"&&typeof n.onClick=="function"&&(r.onclick=xd)}av(t,n);var s;t=null;for(d in i)if(!n.hasOwnProperty(d)&&i.hasOwnProperty(d)&&i[d]!=null)if(d==="style"){var l=i[d];for(s in l)l.hasOwnProperty(s)&&(t||(t={}),t[s]="")}else d!=="dangerouslySetInnerHTML"&&d!=="children"&&d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&d!=="autoFocus"&&(cl.hasOwnProperty(d)?a||(a=[]):(a=a||[]).push(d,null));for(d in n){var u=n[d];if(l=i!=null?i[d]:void 0,n.hasOwnProperty(d)&&u!==l&&(u!=null||l!=null))if(d==="style")if(l){for(s in l)!l.hasOwnProperty(s)||u&&u.hasOwnProperty(s)||(t||(t={}),t[s]="");for(s in u)u.hasOwnProperty(s)&&l[s]!==u[s]&&(t||(t={}),t[s]=u[s])}else t||(a||(a=[]),a.push(d,t)),t=u;else d==="dangerouslySetInnerHTML"?(u=u?u.__html:void 0,l=l?l.__html:void 0,u!=null&&l!==u&&(a=a||[]).push(d,u)):d==="children"?typeof u!="string"&&typeof u!="number"||(a=a||[]).push(d,""+u):d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&(cl.hasOwnProperty(d)?(u!=null&&d==="onScroll"&&Xe("scroll",r),a||l===u||(a=[])):(a=a||[]).push(d,u))}t&&(a=a||[]).push("style",t);var d=a;(e.updateQueue=d)&&(e.flags|=4)}},"Bj");jT=o(function(r,e,t,n){t!==n&&(e.flags|=4)},"Cj");function To(r,e){if(!rt)switch(r.tailMode){case"hidden":e=r.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?r.tail=null:t.sibling=null;break;case"collapsed":t=r.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e||r.tail===null?r.tail=null:r.tail.sibling=null:n.sibling=null}}o(To,"Dj");function Kt(r){var e=r.alternate!==null&&r.alternate.child===r.child,t=0,n=0;if(e)for(var i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags&14680064,n|=i.flags&14680064,i.return=r,i=i.sibling;else for(i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=r,i=i.sibling;return r.subtreeFlags|=n,r.childLanes=t,e}o(Kt,"S");function Sk(r,e,t){var n=e.pendingProps;switch(Sg(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Kt(e),null;case 1:return fr(e.type)&&Dd(),Kt(e),null;case 3:return n=e.stateNode,$s(),et(hr),et(zt),Og(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(r===null||r.child===null)&&(xu(e)?e.flags|=4:r===null||r.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,Hr!==null&&(Bv(Hr),Hr=null))),Av(r,e),Kt(e),null;case 5:Cg(e);var i=aa(wl.current);if(t=e.type,r!==null&&e.stateNode!=null)UT(r,e,t,n,i),r.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(ie(166));return Kt(e),null}if(r=aa(En.current),xu(e)){n=e.stateNode,t=e.type;var a=e.memoizedProps;switch(n[pn]=e,n[_l]=a,r=(e.mode&1)!==0,t){case"dialog":Xe("cancel",n),Xe("close",n);break;case"iframe":case"object":case"embed":Xe("load",n);break;case"video":case"audio":for(i=0;i<$o.length;i++)Xe($o[i],n);break;case"source":Xe("error",n);break;case"img":case"image":case"link":Xe("error",n),Xe("load",n);break;case"details":Xe("toggle",n);break;case"input":TE(n,a),Xe("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!a.multiple},Xe("invalid",n);break;case"textarea":IE(n,a),Xe("invalid",n)}av(t,a),i=null;for(var s in a)if(a.hasOwnProperty(s)){var l=a[s];s==="children"?typeof l=="string"?n.textContent!==l&&(a.suppressHydrationWarning!==!0&&Au(n.textContent,l,r),i=["children",l]):typeof l=="number"&&n.textContent!==""+l&&(a.suppressHydrationWarning!==!0&&Au(n.textContent,l,r),i=["children",""+l]):cl.hasOwnProperty(s)&&l!=null&&s==="onScroll"&&Xe("scroll",n)}switch(t){case"input":Tu(n),RE(n,a,!0);break;case"textarea":Tu(n),CE(n);break;case"select":case"option":break;default:typeof a.onClick=="function"&&(n.onclick=xd)}n=i,e.updateQueue=n,n!==null&&(e.flags|=4)}else{s=i.nodeType===9?i:i.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=hw(t)),r==="http://www.w3.org/1999/xhtml"?t==="script"?(r=s.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof n.is=="string"?r=s.createElement(t,{is:n.is}):(r=s.createElement(t),t==="select"&&(s=r,n.multiple?s.multiple=!0:n.size&&(s.size=n.size))):r=s.createElementNS(r,t),r[pn]=e,r[_l]=n,LT(r,e,!1,!1),e.stateNode=r;e:{switch(s=sv(t,n),t){case"dialog":Xe("cancel",r),Xe("close",r),i=n;break;case"iframe":case"object":case"embed":Xe("load",r),i=n;break;case"video":case"audio":for(i=0;i<$o.length;i++)Xe($o[i],r);i=n;break;case"source":Xe("error",r),i=n;break;case"img":case"image":case"link":Xe("error",r),Xe("load",r),i=n;break;case"details":Xe("toggle",r),i=n;break;case"input":TE(r,n),i=ev(r,n),Xe("invalid",r);break;case"option":i=n;break;case"select":r._wrapperState={wasMultiple:!!n.multiple},i=dt({},n,{value:void 0}),Xe("invalid",r);break;case"textarea":IE(r,n),i=nv(r,n),Xe("invalid",r);break;default:i=n}av(t,i),l=i;for(a in l)if(l.hasOwnProperty(a)){var u=l[a];a==="style"?pw(r,u):a==="dangerouslySetInnerHTML"?(u=u?u.__html:void 0,u!=null&&fw(r,u)):a==="children"?typeof u=="string"?(t!=="textarea"||u!=="")&&hl(r,u):typeof u=="number"&&hl(r,""+u):a!=="suppressContentEditableWarning"&&a!=="suppressHydrationWarning"&&a!=="autoFocus"&&(cl.hasOwnProperty(a)?u!=null&&a==="onScroll"&&Xe("scroll",r):u!=null&&ig(r,a,u,s))}switch(t){case"input":Tu(r),RE(r,n,!1);break;case"textarea":Tu(r),CE(r);break;case"option":n.value!=null&&r.setAttribute("value",""+xi(n.value));break;case"select":r.multiple=!!n.multiple,a=n.value,a!=null?ts(r,!!n.multiple,a,!1):n.defaultValue!=null&&ts(r,!!n.multiple,n.defaultValue,!0);break;default:typeof i.onClick=="function"&&(r.onclick=xd)}switch(t){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Kt(e),null;case 6:if(r&&e.stateNode!=null)jT(r,e,r.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(ie(166));if(t=aa(wl.current),aa(En.current),xu(e)){if(n=e.stateNode,t=e.memoizedProps,n[pn]=e,(a=n.nodeValue!==t)&&(r=Tr,r!==null))switch(r.tag){case 3:Au(n.nodeValue,t,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&Au(n.nodeValue,t,(r.mode&1)!==0)}a&&(e.flags|=4)}else n=(t.nodeType===9?t:t.ownerDocument).createTextNode(n),n[pn]=e,e.stateNode=n}return Kt(e),null;case 13:if(et(st),n=e.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(rt&&wr!==null&&e.mode&1&&!(e.flags&128))rT(),Fs(),e.flags|=98560,a=!1;else if(a=xu(e),n!==null&&n.dehydrated!==null){if(r===null){if(!a)throw Error(ie(318));if(a=e.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(ie(317));a[pn]=e}else Fs(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Kt(e),a=!1}else Hr!==null&&(Bv(Hr),Hr=null),a=!0;if(!a)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(n=n!==null,n!==(r!==null&&r.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(r===null||st.current&1?Mt===0&&(Mt=3):Bg())),e.updateQueue!==null&&(e.flags|=4),Kt(e),null);case 4:return $s(),Av(r,e),r===null&&Sl(e.stateNode.containerInfo),Kt(e),null;case 10:return wg(e.type._context),Kt(e),null;case 17:return fr(e.type)&&Dd(),Kt(e),null;case 19:if(et(st),a=e.memoizedState,a===null)return Kt(e),null;if(n=(e.flags&128)!==0,s=a.rendering,s===null)if(n)To(a,!1);else{if(Mt!==0||r!==null&&r.flags&128)for(r=e.child;r!==null;){if(s=$d(r),s!==null){for(e.flags|=128,To(a,!1),n=s.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=t,t=e.child;t!==null;)a=t,r=n,a.flags&=14680066,s=a.alternate,s===null?(a.childLanes=0,a.lanes=r,a.child=null,a.subtreeFlags=0,a.memoizedProps=null,a.memoizedState=null,a.updateQueue=null,a.dependencies=null,a.stateNode=null):(a.childLanes=s.childLanes,a.lanes=s.lanes,a.child=s.child,a.subtreeFlags=0,a.deletions=null,a.memoizedProps=s.memoizedProps,a.memoizedState=s.memoizedState,a.updateQueue=s.updateQueue,a.type=s.type,r=s.dependencies,a.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),t=t.sibling;return Ye(st,st.current&1|2),e.child}r=r.sibling}a.tail!==null&&vt()>Ks&&(e.flags|=128,n=!0,To(a,!1),e.lanes=4194304)}else{if(!n)if(r=$d(s),r!==null){if(e.flags|=128,n=!0,t=r.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),To(a,!0),a.tail===null&&a.tailMode==="hidden"&&!s.alternate&&!rt)return Kt(e),null}else 2*vt()-a.renderingStartTime>Ks&&t!==1073741824&&(e.flags|=128,n=!0,To(a,!1),e.lanes=4194304);a.isBackwards?(s.sibling=e.child,e.child=s):(t=a.last,t!==null?t.sibling=s:e.child=s,a.last=s)}return a.tail!==null?(e=a.tail,a.rendering=e,a.tail=e.sibling,a.renderingStartTime=vt(),e.sibling=null,t=st.current,Ye(st,n?t&1|2:t&1),e):(Kt(e),null);case 22:case 23:return Fg(),n=e.memoizedState!==null,r!==null&&r.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?_r&1073741824&&(Kt(e),e.subtreeFlags&6&&(e.flags|=8192)):Kt(e),null;case 24:return null;case 25:return null}throw Error(ie(156,e.tag))}o(Sk,"Ej");function Ek(r,e){switch(Sg(e),e.tag){case 1:return fr(e.type)&&Dd(),r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 3:return $s(),et(hr),et(zt),Og(),r=e.flags,r&65536&&!(r&128)?(e.flags=r&-65537|128,e):null;case 5:return Cg(e),null;case 13:if(et(st),r=e.memoizedState,r!==null&&r.dehydrated!==null){if(e.alternate===null)throw Error(ie(340));Fs()}return r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 19:return et(st),null;case 4:return $s(),null;case 10:return wg(e.type._context),null;case 22:case 23:return Fg(),null;case 24:return null;default:return null}}o(Ek,"Ij");var Lu=!1,Gt=!1,_k=typeof WeakSet=="function"?WeakSet:Set,ye=null;function Qa(r,e){var t=r.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(n){ht(r,e,n)}else t.current=null}o(Qa,"Lj");function xv(r,e,t){try{t()}catch(n){ht(r,e,n)}}o(xv,"Mj");var m_=!1;function bk(r,e){if(mv=Pd,r=Kw(),gg(r)){if("selectionStart"in r)var t={start:r.selectionStart,end:r.selectionEnd};else e:{t=(t=r.ownerDocument)&&t.defaultView||window;var n=t.getSelection&&t.getSelection();if(n&&n.rangeCount!==0){t=n.anchorNode;var i=n.anchorOffset,a=n.focusNode;n=n.focusOffset;try{t.nodeType,a.nodeType}catch{t=null;break e}var s=0,l=-1,u=-1,d=0,c=0,h=r,v=null;t:for(;;){for(var g;h!==t||i!==0&&h.nodeType!==3||(l=s+i),h!==a||n!==0&&h.nodeType!==3||(u=s+n),h.nodeType===3&&(s+=h.nodeValue.length),(g=h.firstChild)!==null;)v=h,h=g;for(;;){if(h===r)break t;if(v===t&&++d===i&&(l=s),v===a&&++c===n&&(u=s),(g=h.nextSibling)!==null)break;h=v,v=h.parentNode}h=g}t=l===-1||u===-1?null:{start:l,end:u}}else t=null}t=t||{start:0,end:0}}else t=null;for(gv={focusedElem:r,selectionRange:t},Pd=!1,ye=e;ye!==null;)if(e=ye,r=e.child,(e.subtreeFlags&1028)!==0&&r!==null)r.return=e,ye=r;else for(;ye!==null;){e=ye;try{var p=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(p!==null){var m=p.memoizedProps,w=p.memoizedState,y=e.stateNode,S=y.getSnapshotBeforeUpdate(e.elementType===e.type?m:Kr(e.type,m),w);y.__reactInternalSnapshotBeforeUpdate=S}break;case 3:var T=e.stateNode.containerInfo;T.nodeType===1?T.textContent="":T.nodeType===9&&T.documentElement&&T.removeChild(T.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ie(163))}}catch(C){ht(e,e.return,C)}if(r=e.sibling,r!==null){r.return=e.return,ye=r;break}ye=e.return}return p=m_,m_=!1,p}o(bk,"Oj");function Yo(r,e,t){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var i=n=n.next;do{if((i.tag&r)===r){var a=i.destroy;i.destroy=void 0,a!==void 0&&xv(e,t,a)}i=i.next}while(i!==n)}}o(Yo,"Pj");function fh(r,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&r)===r){var n=t.create;t.destroy=n()}t=t.next}while(t!==e)}}o(fh,"Qj");function Dv(r){var e=r.ref;if(e!==null){var t=r.stateNode;switch(r.tag){case 5:r=t;break;default:r=t}typeof e=="function"?e(r):e.current=r}}o(Dv,"Rj");function FT(r){var e=r.alternate;e!==null&&(r.alternate=null,FT(e)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(e=r.stateNode,e!==null&&(delete e[pn],delete e[_l],delete e[Ev],delete e[ik],delete e[ak])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}o(FT,"Sj");function BT(r){return r.tag===5||r.tag===3||r.tag===4}o(BT,"Tj");function g_(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||BT(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}o(g_,"Uj");function Nv(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(r,e):t.insertBefore(r,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(r,t)):(e=t,e.appendChild(r)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=xd));else if(n!==4&&(r=r.child,r!==null))for(Nv(r,e,t),r=r.sibling;r!==null;)Nv(r,e,t),r=r.sibling}o(Nv,"Vj");function Lv(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.insertBefore(r,e):t.appendChild(r);else if(n!==4&&(r=r.child,r!==null))for(Lv(r,e,t),r=r.sibling;r!==null;)Lv(r,e,t),r=r.sibling}o(Lv,"Wj");var Ut=null,Gr=!1;function ti(r,e,t){for(t=t.child;t!==null;)$T(r,e,t),t=t.sibling}o(ti,"Yj");function $T(r,e,t){if(Sn&&typeof Sn.onCommitFiberUnmount=="function")try{Sn.onCommitFiberUnmount(ah,t)}catch{}switch(t.tag){case 5:Gt||Qa(t,e);case 6:var n=Ut,i=Gr;Ut=null,ti(r,e,t),Ut=n,Gr=i,Ut!==null&&(Gr?(r=Ut,t=t.stateNode,r.nodeType===8?r.parentNode.removeChild(t):r.removeChild(t)):Ut.removeChild(t.stateNode));break;case 18:Ut!==null&&(Gr?(r=Ut,t=t.stateNode,r.nodeType===8?sf(r.parentNode,t):r.nodeType===1&&sf(r,t),ml(r)):sf(Ut,t.stateNode));break;case 4:n=Ut,i=Gr,Ut=t.stateNode.containerInfo,Gr=!0,ti(r,e,t),Ut=n,Gr=i;break;case 0:case 11:case 14:case 15:if(!Gt&&(n=t.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){i=n=n.next;do{var a=i,s=a.destroy;a=a.tag,s!==void 0&&(a&2||a&4)&&xv(t,e,s),i=i.next}while(i!==n)}ti(r,e,t);break;case 1:if(!Gt&&(Qa(t,e),n=t.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=t.memoizedProps,n.state=t.memoizedState,n.componentWillUnmount()}catch(l){ht(t,e,l)}ti(r,e,t);break;case 21:ti(r,e,t);break;case 22:t.mode&1?(Gt=(n=Gt)||t.memoizedState!==null,ti(r,e,t),Gt=n):ti(r,e,t);break;default:ti(r,e,t)}}o($T,"Zj");function y_(r){var e=r.updateQueue;if(e!==null){r.updateQueue=null;var t=r.stateNode;t===null&&(t=r.stateNode=new _k),e.forEach(function(n){var i=Mk.bind(null,r,n);t.has(n)||(t.add(n),n.then(i,i))})}}o(y_,"ak");function $r(r,e){var t=e.deletions;if(t!==null)for(var n=0;n<t.length;n++){var i=t[n];try{var a=r,s=e,l=s;e:for(;l!==null;){switch(l.tag){case 5:Ut=l.stateNode,Gr=!1;break e;case 3:Ut=l.stateNode.containerInfo,Gr=!0;break e;case 4:Ut=l.stateNode.containerInfo,Gr=!0;break e}l=l.return}if(Ut===null)throw Error(ie(160));$T(a,s,i),Ut=null,Gr=!1;var u=i.alternate;u!==null&&(u.return=null),i.return=null}catch(d){ht(i,e,d)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)WT(e,r),e=e.sibling}o($r,"ck");function WT(r,e){var t=r.alternate,n=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if($r(e,r),nn(r),n&4){try{Yo(3,r,r.return),fh(3,r)}catch(m){ht(r,r.return,m)}try{Yo(5,r,r.return)}catch(m){ht(r,r.return,m)}}break;case 1:$r(e,r),nn(r),n&512&&t!==null&&Qa(t,t.return);break;case 5:if($r(e,r),nn(r),n&512&&t!==null&&Qa(t,t.return),r.flags&32){var i=r.stateNode;try{hl(i,"")}catch(m){ht(r,r.return,m)}}if(n&4&&(i=r.stateNode,i!=null)){var a=r.memoizedProps,s=t!==null?t.memoizedProps:a,l=r.type,u=r.updateQueue;if(r.updateQueue=null,u!==null)try{l==="input"&&a.type==="radio"&&a.name!=null&&dw(i,a),sv(l,s);var d=sv(l,a);for(s=0;s<u.length;s+=2){var c=u[s],h=u[s+1];c==="style"?pw(i,h):c==="dangerouslySetInnerHTML"?fw(i,h):c==="children"?hl(i,h):ig(i,c,h,d)}switch(l){case"input":tv(i,a);break;case"textarea":cw(i,a);break;case"select":var v=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!a.multiple;var g=a.value;g!=null?ts(i,!!a.multiple,g,!1):v!==!!a.multiple&&(a.defaultValue!=null?ts(i,!!a.multiple,a.defaultValue,!0):ts(i,!!a.multiple,a.multiple?[]:"",!1))}i[_l]=a}catch(m){ht(r,r.return,m)}}break;case 6:if($r(e,r),nn(r),n&4){if(r.stateNode===null)throw Error(ie(162));i=r.stateNode,a=r.memoizedProps;try{i.nodeValue=a}catch(m){ht(r,r.return,m)}}break;case 3:if($r(e,r),nn(r),n&4&&t!==null&&t.memoizedState.isDehydrated)try{ml(e.containerInfo)}catch(m){ht(r,r.return,m)}break;case 4:$r(e,r),nn(r);break;case 13:$r(e,r),nn(r),i=r.child,i.flags&8192&&(a=i.memoizedState!==null,i.stateNode.isHidden=a,!a||i.alternate!==null&&i.alternate.memoizedState!==null||(Ug=vt())),n&4&&y_(r);break;case 22:if(c=t!==null&&t.memoizedState!==null,r.mode&1?(Gt=(d=Gt)||c,$r(e,r),Gt=d):$r(e,r),nn(r),n&8192){if(d=r.memoizedState!==null,(r.stateNode.isHidden=d)&&!c&&r.mode&1)for(ye=r,c=r.child;c!==null;){for(h=ye=c;ye!==null;){switch(v=ye,g=v.child,v.tag){case 0:case 11:case 14:case 15:Yo(4,v,v.return);break;case 1:Qa(v,v.return);var p=v.stateNode;if(typeof p.componentWillUnmount=="function"){n=v,t=v.return;try{e=n,p.props=e.memoizedProps,p.state=e.memoizedState,p.componentWillUnmount()}catch(m){ht(n,t,m)}}break;case 5:Qa(v,v.return);break;case 22:if(v.memoizedState!==null){E_(h);continue}}g!==null?(g.return=v,ye=g):E_(h)}c=c.sibling}e:for(c=null,h=r;;){if(h.tag===5){if(c===null){c=h;try{i=h.stateNode,d?(a=i.style,typeof a.setProperty=="function"?a.setProperty("display","none","important"):a.display="none"):(l=h.stateNode,u=h.memoizedProps.style,s=u!=null&&u.hasOwnProperty("display")?u.display:null,l.style.display=vw("display",s))}catch(m){ht(r,r.return,m)}}}else if(h.tag===6){if(c===null)try{h.stateNode.nodeValue=d?"":h.memoizedProps}catch(m){ht(r,r.return,m)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===r)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===r)break e;for(;h.sibling===null;){if(h.return===null||h.return===r)break e;c===h&&(c=null),h=h.return}c===h&&(c=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:$r(e,r),nn(r),n&4&&y_(r);break;case 21:break;default:$r(e,r),nn(r)}}o(WT,"dk");function nn(r){var e=r.flags;if(e&2){try{e:{for(var t=r.return;t!==null;){if(BT(t)){var n=t;break e}t=t.return}throw Error(ie(160))}switch(n.tag){case 5:var i=n.stateNode;n.flags&32&&(hl(i,""),n.flags&=-33);var a=g_(r);Lv(r,a,i);break;case 3:case 4:var s=n.stateNode.containerInfo,l=g_(r);Nv(r,l,s);break;default:throw Error(ie(161))}}catch(u){ht(r,r.return,u)}r.flags&=-3}e&4096&&(r.flags&=-4097)}o(nn,"ek");function wk(r,e,t){ye=r,KT(r)}o(wk,"hk");function KT(r,e,t){for(var n=(r.mode&1)!==0;ye!==null;){var i=ye,a=i.child;if(i.tag===22&&n){var s=i.memoizedState!==null||Lu;if(!s){var l=i.alternate,u=l!==null&&l.memoizedState!==null||Gt;l=Lu;var d=Gt;if(Lu=s,(Gt=u)&&!d)for(ye=i;ye!==null;)s=ye,u=s.child,s.tag===22&&s.memoizedState!==null?__(i):u!==null?(u.return=s,ye=u):__(i);for(;a!==null;)ye=a,KT(a),a=a.sibling;ye=i,Lu=l,Gt=d}S_(r)}else i.subtreeFlags&8772&&a!==null?(a.return=i,ye=a):S_(r)}}o(KT,"ik");function S_(r){for(;ye!==null;){var e=ye;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Gt||fh(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!Gt)if(t===null)n.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:Kr(e.type,t.memoizedProps);n.componentDidUpdate(i,t.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=e.updateQueue;a!==null&&n_(e,a,n);break;case 3:var s=e.updateQueue;if(s!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}n_(e,s,t)}break;case 5:var l=e.stateNode;if(t===null&&e.flags&4){t=l;var u=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":u.autoFocus&&t.focus();break;case"img":u.src&&(t.src=u.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var d=e.alternate;if(d!==null){var c=d.memoizedState;if(c!==null){var h=c.dehydrated;h!==null&&ml(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ie(163))}Gt||e.flags&512&&Dv(e)}catch(v){ht(e,e.return,v)}}if(e===r){ye=null;break}if(t=e.sibling,t!==null){t.return=e.return,ye=t;break}ye=e.return}}o(S_,"kk");function E_(r){for(;ye!==null;){var e=ye;if(e===r){ye=null;break}var t=e.sibling;if(t!==null){t.return=e.return,ye=t;break}ye=e.return}}o(E_,"gk");function __(r){for(;ye!==null;){var e=ye;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{fh(4,e)}catch(u){ht(e,t,u)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var i=e.return;try{n.componentDidMount()}catch(u){ht(e,i,u)}}var a=e.return;try{Dv(e)}catch(u){ht(e,a,u)}break;case 5:var s=e.return;try{Dv(e)}catch(u){ht(e,s,u)}}}catch(u){ht(e,e.return,u)}if(e===r){ye=null;break}var l=e.sibling;if(l!==null){l.return=e.return,ye=l;break}ye=e.return}}o(__,"jk");var Tk=Math.ceil,Vd=Jn.ReactCurrentDispatcher,Ng=Jn.ReactCurrentOwner,Nr=Jn.ReactCurrentBatchConfig,Fe=0,Nt=null,bt=null,Ft=0,_r=0,Ya=Fi(0),Mt=0,Cl=null,ya=0,vh=0,Lg=0,Xo=null,ur=null,Ug=0,Ks=1/0,Pn=null,Gd=!1,Uv=null,Ri=null,Uu=!1,gi=null,qd=0,Zo=0,jv=null,ld=-1,ud=0;function rr(){return Fe&6?vt():ld!==-1?ld:ld=vt()}o(rr,"R$1");function Ii(r){return r.mode&1?Fe&2&&Ft!==0?Ft&-Ft:ok.transition!==null?(ud===0&&(ud=Cw()),ud):(r=Ge,r!==0||(r=window.event,r=r===void 0?16:Dw(r.type)),r):1}o(Ii,"yi");function Qr(r,e,t,n){if(50<Zo)throw Zo=0,jv=null,Error(ie(185));tu(r,t,n),(!(Fe&2)||r!==Nt)&&(r===Nt&&(!(Fe&2)&&(vh|=t),Mt===4&&pi(r,Ft)),vr(r,n),t===1&&Fe===0&&!(e.mode&1)&&(Ks=vt()+500,dh&&Bi()))}o(Qr,"gi");function vr(r,e){var t=r.callbackNode;oO(r,e);var n=kd(r,r===Nt?Ft:0);if(n===0)t!==null&&PE(t),r.callbackNode=null,r.callbackPriority=0;else if(e=n&-n,r.callbackPriority!==e){if(t!=null&&PE(t),e===1)r.tag===0?sk(b_.bind(null,r)):Zw(b_.bind(null,r)),rk(function(){!(Fe&6)&&Bi()}),t=null;else{switch(Ow(n)){case 1:t=ug;break;case 4:t=Rw;break;case 16:t=Od;break;case 536870912:t=Iw;break;default:t=Od}t=YT(t,VT.bind(null,r))}r.callbackPriority=e,r.callbackNode=t}}o(vr,"Dk");function VT(r,e){if(ld=-1,ud=0,Fe&6)throw Error(ie(327));var t=r.callbackNode;if(ss()&&r.callbackNode!==t)return null;var n=kd(r,r===Nt?Ft:0);if(n===0)return null;if(n&30||n&r.expiredLanes||e)e=Hd(r,n);else{e=n;var i=Fe;Fe|=2;var a=qT();(Nt!==r||Ft!==e)&&(Pn=null,Ks=vt()+500,ua(r,e));do try{Ck();break}catch(l){GT(r,l)}while(!0);bg(),Vd.current=a,Fe=i,bt!==null?e=0:(Nt=null,Ft=0,e=Mt)}if(e!==0){if(e===2&&(i=cv(r),i!==0&&(n=i,e=Fv(r,i))),e===1)throw t=Cl,ua(r,0),pi(r,n),vr(r,vt()),t;if(e===6)pi(r,n);else{if(i=r.current.alternate,!(n&30)&&!Rk(i)&&(e=Hd(r,n),e===2&&(a=cv(r),a!==0&&(n=a,e=Fv(r,a))),e===1))throw t=Cl,ua(r,0),pi(r,n),vr(r,vt()),t;switch(r.finishedWork=i,r.finishedLanes=n,e){case 0:case 1:throw Error(ie(345));case 2:Qi(r,ur,Pn);break;case 3:if(pi(r,n),(n&130023424)===n&&(e=Ug+500-vt(),10<e)){if(kd(r,0)!==0)break;if(i=r.suspendedLanes,(i&n)!==n){rr(),r.pingedLanes|=r.suspendedLanes&i;break}r.timeoutHandle=Sv(Qi.bind(null,r,ur,Pn),e);break}Qi(r,ur,Pn);break;case 4:if(pi(r,n),(n&4194240)===n)break;for(e=r.eventTimes,i=-1;0<n;){var s=31-Jr(n);a=1<<s,s=e[s],s>i&&(i=s),n&=~a}if(n=i,n=vt()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*Tk(n/1960))-n,10<n){r.timeoutHandle=Sv(Qi.bind(null,r,ur,Pn),n);break}Qi(r,ur,Pn);break;case 5:Qi(r,ur,Pn);break;default:throw Error(ie(329))}}}return vr(r,vt()),r.callbackNode===t?VT.bind(null,r):null}o(VT,"Gk");function Fv(r,e){var t=Xo;return r.current.memoizedState.isDehydrated&&(ua(r,e).flags|=256),r=Hd(r,e),r!==2&&(e=ur,ur=t,e!==null&&Bv(e)),r}o(Fv,"Nk");function Bv(r){ur===null?ur=r:ur.push.apply(ur,r)}o(Bv,"Fj");function Rk(r){for(var e=r;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var n=0;n<t.length;n++){var i=t[n],a=i.getSnapshot;i=i.value;try{if(!en(a(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}o(Rk,"Ok");function pi(r,e){for(e&=~Lg,e&=~vh,r.suspendedLanes|=e,r.pingedLanes&=~e,r=r.expirationTimes;0<e;){var t=31-Jr(e),n=1<<t;r[t]=-1,e&=~n}}o(pi,"Ck");function b_(r){if(Fe&6)throw Error(ie(327));ss();var e=kd(r,0);if(!(e&1))return vr(r,vt()),null;var t=Hd(r,e);if(r.tag!==0&&t===2){var n=cv(r);n!==0&&(e=n,t=Fv(r,n))}if(t===1)throw t=Cl,ua(r,0),pi(r,e),vr(r,vt()),t;if(t===6)throw Error(ie(345));return r.finishedWork=r.current.alternate,r.finishedLanes=e,Qi(r,ur,Pn),vr(r,vt()),null}o(b_,"Ek");function jg(r,e){var t=Fe;Fe|=1;try{return r(e)}finally{Fe=t,Fe===0&&(Ks=vt()+500,dh&&Bi())}}o(jg,"Qk");function Sa(r){gi!==null&&gi.tag===0&&!(Fe&6)&&ss();var e=Fe;Fe|=1;var t=Nr.transition,n=Ge;try{if(Nr.transition=null,Ge=1,r)return r()}finally{Ge=n,Nr.transition=t,Fe=e,!(Fe&6)&&Bi()}}o(Sa,"Rk");function Fg(){_r=Ya.current,et(Ya)}o(Fg,"Hj");function ua(r,e){r.finishedWork=null,r.finishedLanes=0;var t=r.timeoutHandle;if(t!==-1&&(r.timeoutHandle=-1,tk(t)),bt!==null)for(t=bt.return;t!==null;){var n=t;switch(Sg(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&Dd();break;case 3:$s(),et(hr),et(zt),Og();break;case 5:Cg(n);break;case 4:$s();break;case 13:et(st);break;case 19:et(st);break;case 10:wg(n.type._context);break;case 22:case 23:Fg()}t=t.return}if(Nt=r,bt=r=Ci(r.current,null),Ft=_r=e,Mt=0,Cl=null,Lg=vh=ya=0,ur=Xo=null,ia!==null){for(e=0;e<ia.length;e++)if(t=ia[e],n=t.interleaved,n!==null){t.interleaved=null;var i=n.next,a=t.pending;if(a!==null){var s=a.next;a.next=i,n.next=s}t.pending=n}ia=null}return r}o(ua,"Kk");function GT(r,e){do{var t=bt;try{if(bg(),ad.current=Kd,Wd){for(var n=lt.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}Wd=!1}if(ga=0,xt=kt=lt=null,Qo=!1,Tl=0,Ng.current=null,t===null||t.return===null){Mt=1,Cl=e,bt=null;break}e:{var a=r,s=t.return,l=t,u=e;if(e=Ft,l.flags|=32768,u!==null&&typeof u=="object"&&typeof u.then=="function"){var d=u,c=l,h=c.tag;if(!(c.mode&1)&&(h===0||h===11||h===15)){var v=c.alternate;v?(c.updateQueue=v.updateQueue,c.memoizedState=v.memoizedState,c.lanes=v.lanes):(c.updateQueue=null,c.memoizedState=null)}var g=u_(s);if(g!==null){g.flags&=-257,d_(g,s,l,a,e),g.mode&1&&l_(a,d,e),e=g,u=d;var p=e.updateQueue;if(p===null){var m=new Set;m.add(u),e.updateQueue=m}else p.add(u);break e}else{if(!(e&1)){l_(a,d,e),Bg();break e}u=Error(ie(426))}}else if(rt&&l.mode&1){var w=u_(s);if(w!==null){!(w.flags&65536)&&(w.flags|=256),d_(w,s,l,a,e),Eg(Ws(u,l));break e}}a=u=Ws(u,l),Mt!==4&&(Mt=2),Xo===null?Xo=[a]:Xo.push(a),a=s;do{switch(a.tag){case 3:a.flags|=65536,e&=-e,a.lanes|=e;var y=OT(a,u,e);r_(a,y);break e;case 1:l=u;var S=a.type,T=a.stateNode;if(!(a.flags&128)&&(typeof S.getDerivedStateFromError=="function"||T!==null&&typeof T.componentDidCatch=="function"&&(Ri===null||!Ri.has(T)))){a.flags|=65536,e&=-e,a.lanes|=e;var C=kT(a,l,e);r_(a,C);break e}}a=a.return}while(a!==null)}zT(t)}catch(M){e=M,bt===t&&t!==null&&(bt=t=t.return);continue}break}while(!0)}o(GT,"Mk");function qT(){var r=Vd.current;return Vd.current=Kd,r===null?Kd:r}o(qT,"Jk");function Bg(){(Mt===0||Mt===3||Mt===2)&&(Mt=4),Nt===null||!(ya&268435455)&&!(vh&268435455)||pi(Nt,Ft)}o(Bg,"tj");function Hd(r,e){var t=Fe;Fe|=2;var n=qT();(Nt!==r||Ft!==e)&&(Pn=null,ua(r,e));do try{Ik();break}catch(i){GT(r,i)}while(!0);if(bg(),Fe=t,Vd.current=n,bt!==null)throw Error(ie(261));return Nt=null,Ft=0,Mt}o(Hd,"Ik");function Ik(){for(;bt!==null;)HT(bt)}o(Ik,"Tk");function Ck(){for(;bt!==null&&!XC();)HT(bt)}o(Ck,"Lk");function HT(r){var e=QT(r.alternate,r,_r);r.memoizedProps=r.pendingProps,e===null?zT(r):bt=e,Ng.current=null}o(HT,"Uk");function zT(r){var e=r;do{var t=e.alternate;if(r=e.return,e.flags&32768){if(t=Ek(t,e),t!==null){t.flags&=32767,bt=t;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{Mt=6,bt=null;return}}else if(t=Sk(t,e,_r),t!==null){bt=t;return}if(e=e.sibling,e!==null){bt=e;return}bt=e=r}while(e!==null);Mt===0&&(Mt=5)}o(zT,"Sk");function Qi(r,e,t){var n=Ge,i=Nr.transition;try{Nr.transition=null,Ge=1,Ok(r,e,t,n)}finally{Nr.transition=i,Ge=n}return null}o(Qi,"Pk");function Ok(r,e,t,n){do ss();while(gi!==null);if(Fe&6)throw Error(ie(327));t=r.finishedWork;var i=r.finishedLanes;if(t===null)return null;if(r.finishedWork=null,r.finishedLanes=0,t===r.current)throw Error(ie(177));r.callbackNode=null,r.callbackPriority=0;var a=t.lanes|t.childLanes;if(lO(r,a),r===Nt&&(bt=Nt=null,Ft=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||Uu||(Uu=!0,YT(Od,function(){return ss(),null})),a=(t.flags&15990)!==0,t.subtreeFlags&15990||a){a=Nr.transition,Nr.transition=null;var s=Ge;Ge=1;var l=Fe;Fe|=4,Ng.current=null,bk(r,t),WT(t,r),zO(gv),Pd=!!mv,gv=mv=null,r.current=t,wk(t),ZC(),Fe=l,Ge=s,Nr.transition=a}else r.current=t;if(Uu&&(Uu=!1,gi=r,qd=i),a=r.pendingLanes,a===0&&(Ri=null),rO(t.stateNode),vr(r,vt()),e!==null)for(n=r.onRecoverableError,t=0;t<e.length;t++)i=e[t],n(i.value,{componentStack:i.stack,digest:i.digest});if(Gd)throw Gd=!1,r=Uv,Uv=null,r;return qd&1&&r.tag!==0&&ss(),a=r.pendingLanes,a&1?r===jv?Zo++:(Zo=0,jv=r):Zo=0,Bi(),null}o(Ok,"Wk");function ss(){if(gi!==null){var r=Ow(qd),e=Nr.transition,t=Ge;try{if(Nr.transition=null,Ge=16>r?16:r,gi===null)var n=!1;else{if(r=gi,gi=null,qd=0,Fe&6)throw Error(ie(331));var i=Fe;for(Fe|=4,ye=r.current;ye!==null;){var a=ye,s=a.child;if(ye.flags&16){var l=a.deletions;if(l!==null){for(var u=0;u<l.length;u++){var d=l[u];for(ye=d;ye!==null;){var c=ye;switch(c.tag){case 0:case 11:case 15:Yo(8,c,a)}var h=c.child;if(h!==null)h.return=c,ye=h;else for(;ye!==null;){c=ye;var v=c.sibling,g=c.return;if(FT(c),c===d){ye=null;break}if(v!==null){v.return=g,ye=v;break}ye=g}}}var p=a.alternate;if(p!==null){var m=p.child;if(m!==null){p.child=null;do{var w=m.sibling;m.sibling=null,m=w}while(m!==null)}}ye=a}}if(a.subtreeFlags&2064&&s!==null)s.return=a,ye=s;else e:for(;ye!==null;){if(a=ye,a.flags&2048)switch(a.tag){case 0:case 11:case 15:Yo(9,a,a.return)}var y=a.sibling;if(y!==null){y.return=a.return,ye=y;break e}ye=a.return}}var S=r.current;for(ye=S;ye!==null;){s=ye;var T=s.child;if(s.subtreeFlags&2064&&T!==null)T.return=s,ye=T;else e:for(s=S;ye!==null;){if(l=ye,l.flags&2048)try{switch(l.tag){case 0:case 11:case 15:fh(9,l)}}catch(M){ht(l,l.return,M)}if(l===s){ye=null;break e}var C=l.sibling;if(C!==null){C.return=l.return,ye=C;break e}ye=l.return}}if(Fe=i,Bi(),Sn&&typeof Sn.onPostCommitFiberRoot=="function")try{Sn.onPostCommitFiberRoot(ah,r)}catch{}n=!0}return n}finally{Ge=t,Nr.transition=e}}return!1}o(ss,"Hk");function w_(r,e,t){e=Ws(t,e),e=OT(r,e,1),r=Ti(r,e,1),e=rr(),r!==null&&(tu(r,1,e),vr(r,e))}o(w_,"Xk");function ht(r,e,t){if(r.tag===3)w_(r,r,t);else for(;e!==null;){if(e.tag===3){w_(e,r,t);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(Ri===null||!Ri.has(n))){r=Ws(t,r),r=kT(e,r,1),e=Ti(e,r,1),r=rr(),e!==null&&(tu(e,1,r),vr(e,r));break}}e=e.return}}o(ht,"W");function kk(r,e,t){var n=r.pingCache;n!==null&&n.delete(e),e=rr(),r.pingedLanes|=r.suspendedLanes&t,Nt===r&&(Ft&t)===t&&(Mt===4||Mt===3&&(Ft&130023424)===Ft&&500>vt()-Ug?ua(r,0):Lg|=t),vr(r,e)}o(kk,"Ti");function JT(r,e){e===0&&(r.mode&1?(e=Cu,Cu<<=1,!(Cu&130023424)&&(Cu=4194304)):e=1);var t=rr();r=Gn(r,e),r!==null&&(tu(r,e,t),vr(r,t))}o(JT,"Yk");function Pk(r){var e=r.memoizedState,t=0;e!==null&&(t=e.retryLane),JT(r,t)}o(Pk,"uj");function Mk(r,e){var t=0;switch(r.tag){case 13:var n=r.stateNode,i=r.memoizedState;i!==null&&(t=i.retryLane);break;case 19:n=r.stateNode;break;default:throw Error(ie(314))}n!==null&&n.delete(e),JT(r,t)}o(Mk,"bk");var QT;QT=o(function(r,e,t){if(r!==null)if(r.memoizedProps!==e.pendingProps||hr.current)dr=!0;else{if(!(r.lanes&t)&&!(e.flags&128))return dr=!1,yk(r,e,t);dr=!!(r.flags&131072)}else dr=!1,rt&&e.flags&1048576&&eT(e,Ud,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;od(r,e),r=e.pendingProps;var i=js(e,zt.current);as(e,t),i=Pg(null,e,n,r,i,t);var a=Mg();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,fr(n)?(a=!0,Nd(e)):a=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,Rg(e),i.updater=hh,e.stateNode=i,i._reactInternals=e,Iv(e,n,r,t),e=kv(null,e,n,!0,a,t)):(e.tag=0,rt&&a&&yg(e),Zt(null,e,i,t),e=e.child),e;case 16:n=e.elementType;e:{switch(od(r,e),r=e.pendingProps,i=n._init,n=i(n._payload),e.type=n,i=e.tag=xk(n),r=Kr(n,r),i){case 0:e=Ov(null,e,n,r,t);break e;case 1:e=f_(null,e,n,r,t);break e;case 11:e=c_(null,e,n,r,t);break e;case 14:e=h_(null,e,n,Kr(n.type,r),t);break e}throw Error(ie(306,n,""))}return e;case 0:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Kr(n,i),Ov(r,e,n,i,t);case 1:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Kr(n,i),f_(r,e,n,i,t);case 3:e:{if(xT(e),r===null)throw Error(ie(387));n=e.pendingProps,a=e.memoizedState,i=a.element,sT(r,e),Bd(e,n,null,t);var s=e.memoizedState;if(n=s.element,a.isDehydrated)if(a={element:n,isDehydrated:!1,cache:s.cache,pendingSuspenseBoundaries:s.pendingSuspenseBoundaries,transitions:s.transitions},e.updateQueue.baseState=a,e.memoizedState=a,e.flags&256){i=Ws(Error(ie(423)),e),e=v_(r,e,n,t,i);break e}else if(n!==i){i=Ws(Error(ie(424)),e),e=v_(r,e,n,t,i);break e}else for(wr=wi(e.stateNode.containerInfo.firstChild),Tr=e,rt=!0,Hr=null,t=iT(e,null,n,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(Fs(),n===i){e=qn(r,e,t);break e}Zt(r,e,n,t)}e=e.child}return e;case 5:return oT(e),r===null&&wv(e),n=e.type,i=e.pendingProps,a=r!==null?r.memoizedProps:null,s=i.children,yv(n,i)?s=null:a!==null&&yv(n,a)&&(e.flags|=32),AT(r,e),Zt(r,e,s,t),e.child;case 6:return r===null&&wv(e),null;case 13:return DT(r,e,t);case 4:return Ig(e,e.stateNode.containerInfo),n=e.pendingProps,r===null?e.child=Bs(e,null,n,t):Zt(r,e,n,t),e.child;case 11:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Kr(n,i),c_(r,e,n,i,t);case 7:return Zt(r,e,e.pendingProps,t),e.child;case 8:return Zt(r,e,e.pendingProps.children,t),e.child;case 12:return Zt(r,e,e.pendingProps.children,t),e.child;case 10:e:{if(n=e.type._context,i=e.pendingProps,a=e.memoizedProps,s=i.value,Ye(jd,n._currentValue),n._currentValue=s,a!==null)if(en(a.value,s)){if(a.children===i.children&&!hr.current){e=qn(r,e,t);break e}}else for(a=e.child,a!==null&&(a.return=e);a!==null;){var l=a.dependencies;if(l!==null){s=a.child;for(var u=l.firstContext;u!==null;){if(u.context===n){if(a.tag===1){u=$n(-1,t&-t),u.tag=2;var d=a.updateQueue;if(d!==null){d=d.shared;var c=d.pending;c===null?u.next=u:(u.next=c.next,c.next=u),d.pending=u}}a.lanes|=t,u=a.alternate,u!==null&&(u.lanes|=t),Tv(a.return,t,e),l.lanes|=t;break}u=u.next}}else if(a.tag===10)s=a.type===e.type?null:a.child;else if(a.tag===18){if(s=a.return,s===null)throw Error(ie(341));s.lanes|=t,l=s.alternate,l!==null&&(l.lanes|=t),Tv(s,t,e),s=a.sibling}else s=a.child;if(s!==null)s.return=a;else for(s=a;s!==null;){if(s===e){s=null;break}if(a=s.sibling,a!==null){a.return=s.return,s=a;break}s=s.return}a=s}Zt(r,e,i.children,t),e=e.child}return e;case 9:return i=e.type,n=e.pendingProps.children,as(e,t),i=Ur(i),n=n(i),e.flags|=1,Zt(r,e,n,t),e.child;case 14:return n=e.type,i=Kr(n,e.pendingProps),i=Kr(n.type,i),h_(r,e,n,i,t);case 15:return PT(r,e,e.type,e.pendingProps,t);case 17:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Kr(n,i),od(r,e),e.tag=1,fr(n)?(r=!0,Nd(e)):r=!1,as(e,t),CT(e,n,i),Iv(e,n,i,t),kv(null,e,n,!0,r,t);case 19:return NT(r,e,t);case 22:return MT(r,e,t)}throw Error(ie(156,e.tag))},"Vk");function YT(r,e){return Tw(r,e)}o(YT,"Fk");function Ak(r,e,t,n){this.tag=r,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}o(Ak,"$k");function Dr(r,e,t,n){return new Ak(r,e,t,n)}o(Dr,"Bg");function $g(r){return r=r.prototype,!(!r||!r.isReactComponent)}o($g,"aj");function xk(r){if(typeof r=="function")return $g(r)?1:0;if(r!=null){if(r=r.$$typeof,r===sg)return 11;if(r===og)return 14}return 2}o(xk,"Zk");function Ci(r,e){var t=r.alternate;return t===null?(t=Dr(r.tag,e,r.key,r.mode),t.elementType=r.elementType,t.type=r.type,t.stateNode=r.stateNode,t.alternate=r,r.alternate=t):(t.pendingProps=e,t.type=r.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=r.flags&14680064,t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,e=r.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=r.sibling,t.index=r.index,t.ref=r.ref,t}o(Ci,"Pg");function dd(r,e,t,n,i,a){var s=2;if(n=r,typeof r=="function")$g(r)&&(s=1);else if(typeof r=="string")s=5;else e:switch(r){case $a:return da(t.children,i,a,e);case ag:s=8,i|=8;break;case Qf:return r=Dr(12,t,e,i|2),r.elementType=Qf,r.lanes=a,r;case Yf:return r=Dr(13,t,e,i),r.elementType=Yf,r.lanes=a,r;case Xf:return r=Dr(19,t,e,i),r.elementType=Xf,r.lanes=a,r;case ow:return ph(t,i,a,e);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case aw:s=10;break e;case sw:s=9;break e;case sg:s=11;break e;case og:s=14;break e;case ui:s=16,n=null;break e}throw Error(ie(130,r==null?r:typeof r,""))}return e=Dr(s,t,e,i),e.elementType=r,e.type=n,e.lanes=a,e}o(dd,"Rg");function da(r,e,t,n){return r=Dr(7,r,n,e),r.lanes=t,r}o(da,"Tg");function ph(r,e,t,n){return r=Dr(22,r,n,e),r.elementType=ow,r.lanes=t,r.stateNode={isHidden:!1},r}o(ph,"pj");function vf(r,e,t){return r=Dr(6,r,null,e),r.lanes=t,r}o(vf,"Qg");function pf(r,e,t){return e=Dr(4,r.children!==null?r.children:[],r.key,e),e.lanes=t,e.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},e}o(pf,"Sg");function Dk(r,e,t,n,i){this.tag=e,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=zh(0),this.expirationTimes=zh(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=zh(0),this.identifierPrefix=n,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}o(Dk,"al");function Wg(r,e,t,n,i,a,s,l,u){return r=new Dk(r,e,t,l,u),e===1?(e=1,a===!0&&(e|=8)):e=0,a=Dr(3,null,null,e),r.current=a,a.stateNode=r,a.memoizedState={element:n,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},Rg(a),r}o(Wg,"bl");function Nk(r,e,t){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Ba,key:n==null?null:""+n,children:r,containerInfo:e,implementation:t}}o(Nk,"cl");function XT(r){if(!r)return Di;r=r._reactInternals;e:{if(Ra(r)!==r||r.tag!==1)throw Error(ie(170));var e=r;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(fr(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(ie(171))}if(r.tag===1){var t=r.type;if(fr(t))return Xw(r,t,e)}return e}o(XT,"dl");function ZT(r,e,t,n,i,a,s,l,u){return r=Wg(t,n,!0,r,i,a,s,l,u),r.context=XT(null),t=r.current,n=rr(),i=Ii(t),a=$n(n,i),a.callback=e??null,Ti(t,a,i),r.current.lanes=i,tu(r,i,n),vr(r,n),r}o(ZT,"el");function mh(r,e,t,n){var i=e.current,a=rr(),s=Ii(i);return t=XT(t),e.context===null?e.context=t:e.pendingContext=t,e=$n(a,s),e.payload={element:r},n=n===void 0?null:n,n!==null&&(e.callback=n),r=Ti(i,e,s),r!==null&&(Qr(r,i,s,a),id(r,i,s)),s}o(mh,"fl");function zd(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}o(zd,"gl");function T_(r,e){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var t=r.retryLane;r.retryLane=t!==0&&t<e?t:e}}o(T_,"hl");function Kg(r,e){T_(r,e),(r=r.alternate)&&T_(r,e)}o(Kg,"il");function Lk(){return null}o(Lk,"jl");var eR=typeof reportError=="function"?reportError:function(r){console.error(r)};function Vg(r){this._internalRoot=r}o(Vg,"ll");gh.prototype.render=Vg.prototype.render=function(r){var e=this._internalRoot;if(e===null)throw Error(ie(409));mh(r,e,null,null)};gh.prototype.unmount=Vg.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var e=r.containerInfo;Sa(function(){mh(null,r,null,null)}),e[Vn]=null}};function gh(r){this._internalRoot=r}o(gh,"ml");gh.prototype.unstable_scheduleHydration=function(r){if(r){var e=Mw();r={blockedOn:null,target:r,priority:e};for(var t=0;t<vi.length&&e!==0&&e<vi[t].priority;t++);vi.splice(t,0,r),t===0&&xw(r)}};function Gg(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}o(Gg,"nl");function yh(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}o(yh,"ol");function R_(){}o(R_,"pl");function Uk(r,e,t,n,i){if(i){if(typeof n=="function"){var a=n;n=o(function(){var d=zd(s);a.call(d)},"d")}var s=ZT(e,n,r,0,null,!1,!1,"",R_);return r._reactRootContainer=s,r[Vn]=s.current,Sl(r.nodeType===8?r.parentNode:r),Sa(),s}for(;i=r.lastChild;)r.removeChild(i);if(typeof n=="function"){var l=n;n=o(function(){var d=zd(u);l.call(d)},"d")}var u=Wg(r,0,!1,null,null,!1,!1,"",R_);return r._reactRootContainer=u,r[Vn]=u.current,Sl(r.nodeType===8?r.parentNode:r),Sa(function(){mh(e,u,t,n)}),u}o(Uk,"ql");function Sh(r,e,t,n,i){var a=t._reactRootContainer;if(a){var s=a;if(typeof i=="function"){var l=i;i=o(function(){var u=zd(s);l.call(u)},"e")}mh(e,s,r,i)}else s=Uk(t,e,r,i,n);return zd(s)}o(Sh,"rl");kw=o(function(r){switch(r.tag){case 3:var e=r.stateNode;if(e.current.memoizedState.isDehydrated){var t=Bo(e.pendingLanes);t!==0&&(dg(e,t|1),vr(e,vt()),!(Fe&6)&&(Ks=vt()+500,Bi()))}break;case 13:Sa(function(){var n=Gn(r,1);if(n!==null){var i=rr();Qr(n,r,1,i)}}),Kg(r,1)}},"Ec");cg=o(function(r){if(r.tag===13){var e=Gn(r,134217728);if(e!==null){var t=rr();Qr(e,r,134217728,t)}Kg(r,134217728)}},"Fc");Pw=o(function(r){if(r.tag===13){var e=Ii(r),t=Gn(r,e);if(t!==null){var n=rr();Qr(t,r,e,n)}Kg(r,e)}},"Gc");Mw=o(function(){return Ge},"Hc");Aw=o(function(r,e){var t=Ge;try{return Ge=r,e()}finally{Ge=t}},"Ic");lv=o(function(r,e,t){switch(e){case"input":if(tv(r,t),e=t.name,t.type==="radio"&&e!=null){for(t=r;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var n=t[e];if(n!==r&&n.form===r.form){var i=uh(n);if(!i)throw Error(ie(90));uw(n),tv(n,i)}}}break;case"textarea":cw(r,t);break;case"select":e=t.value,e!=null&&ts(r,!!t.multiple,e,!1)}},"yb");yw=jg;Sw=Sa;var jk={usingClientEntryPoint:!1,Events:[nu,Ga,uh,mw,gw,jg]},Ro={findFiberByHostInstance:na,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},Fk={bundleType:Ro.bundleType,version:Ro.version,rendererPackageName:Ro.rendererPackageName,rendererConfig:Ro.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Jn.ReactCurrentDispatcher,findHostInstanceByFiber:o(function(r){return r=bw(r),r===null?null:r.stateNode},"findHostInstanceByFiber"),findFiberByHostInstance:Ro.findFiberByHostInstance||Lk,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var ju=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ju.isDisabled&&ju.supportsFiber)try{ah=ju.inject(Fk),Sn=ju}catch{}}Ir.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=jk;Ir.createPortal=function(r,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Gg(e))throw Error(ie(200));return Nk(r,e,null,t)};Ir.createRoot=function(r,e){if(!Gg(r))throw Error(ie(299));var t=!1,n="",i=eR;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=Wg(r,1,!1,null,null,t,!1,n,i),r[Vn]=e.current,Sl(r.nodeType===8?r.parentNode:r),new Vg(e)};Ir.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var e=r._reactInternals;if(e===void 0)throw typeof r.render=="function"?Error(ie(188)):(r=Object.keys(r).join(","),Error(ie(268,r)));return r=bw(e),r=r===null?null:r.stateNode,r};Ir.flushSync=function(r){return Sa(r)};Ir.hydrate=function(r,e,t){if(!yh(e))throw Error(ie(200));return Sh(null,r,e,!0,t)};Ir.hydrateRoot=function(r,e,t){if(!Gg(r))throw Error(ie(405));var n=t!=null&&t.hydratedSources||null,i=!1,a="",s=eR;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(a=t.identifierPrefix),t.onRecoverableError!==void 0&&(s=t.onRecoverableError)),e=ZT(e,null,r,1,t??null,i,!1,a,s),r[Vn]=e.current,Sl(r),n)for(r=0;r<n.length;r++)t=n[r],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new gh(e)};Ir.render=function(r,e,t){if(!yh(e))throw Error(ie(200));return Sh(null,r,e,!1,t)};Ir.unmountComponentAtNode=function(r){if(!yh(r))throw Error(ie(40));return r._reactRootContainer?(Sa(function(){Sh(null,null,r,!1,function(){r._reactRootContainer=null,r[Vn]=null})}),!0):!1};Ir.unstable_batchedUpdates=jg;Ir.unstable_renderSubtreeIntoContainer=function(r,e,t,n){if(!yh(t))throw Error(ie(200));if(r==null||r._reactInternals===void 0)throw Error(ie(38));return Sh(r,e,t,!1,n)};Ir.version="18.3.1-next-f1338f8080-20240426";function tR(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(tR)}catch(r){console.error(r)}}o(tR,"checkDCE");tR(),tw.exports=Ir;var Bk=tw.exports,rR,I_=Bk;rR=I_.createRoot,I_.hydrateRoot;/**
 * @remix-run/router v1.23.0
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Ol(){return Ol=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Ol.apply(this,arguments)}o(Ol,"_extends$2");var yi;(function(r){r.Pop="POP",r.Push="PUSH",r.Replace="REPLACE"})(yi||(yi={}));const C_="popstate";function $k(r){r===void 0&&(r={});function e(i,a){let{pathname:s="/",search:l="",hash:u=""}=Ia(i.location.hash.substr(1));return!s.startsWith("/")&&!s.startsWith(".")&&(s="/"+s),$v("",{pathname:s,search:l,hash:u},a.state&&a.state.usr||null,a.state&&a.state.key||"default")}o(e,"createHashLocation");function t(i,a){let s=i.document.querySelector("base"),l="";if(s&&s.getAttribute("href")){let u=i.location.href,d=u.indexOf("#");l=d===-1?u:u.slice(0,d)}return l+"#"+(typeof a=="string"?a:Jd(a))}o(t,"createHashHref");function n(i,a){qg(i.pathname.charAt(0)==="/","relative pathnames are not supported in hash history.push("+JSON.stringify(a)+")")}return o(n,"validateHashLocation"),Kk(e,t,n,r)}o($k,"createHashHistory");function ut(r,e){if(r===!1||r===null||typeof r>"u")throw new Error(e)}o(ut,"invariant");function qg(r,e){if(!r){typeof console<"u"&&console.warn(e);try{throw new Error(e)}catch{}}}o(qg,"warning");function Wk(){return Math.random().toString(36).substr(2,8)}o(Wk,"createKey");function O_(r,e){return{usr:r.state,key:r.key,idx:e}}o(O_,"getHistoryState");function $v(r,e,t,n){return t===void 0&&(t=null),Ol({pathname:typeof r=="string"?r:r.pathname,search:"",hash:""},typeof e=="string"?Ia(e):e,{state:t,key:e&&e.key||n||Wk()})}o($v,"createLocation");function Jd(r){let{pathname:e="/",search:t="",hash:n=""}=r;return t&&t!=="?"&&(e+=t.charAt(0)==="?"?t:"?"+t),n&&n!=="#"&&(e+=n.charAt(0)==="#"?n:"#"+n),e}o(Jd,"createPath");function Ia(r){let e={};if(r){let t=r.indexOf("#");t>=0&&(e.hash=r.substr(t),r=r.substr(0,t));let n=r.indexOf("?");n>=0&&(e.search=r.substr(n),r=r.substr(0,n)),r&&(e.pathname=r)}return e}o(Ia,"parsePath");function Kk(r,e,t,n){n===void 0&&(n={});let{window:i=document.defaultView,v5Compat:a=!1}=n,s=i.history,l=yi.Pop,u=null,d=c();d==null&&(d=0,s.replaceState(Ol({},s.state,{idx:d}),""));function c(){return(s.state||{idx:null}).idx}o(c,"getIndex");function h(){l=yi.Pop;let w=c(),y=w==null?null:w-d;d=w,u&&u({action:l,location:m.location,delta:y})}o(h,"handlePop");function v(w,y){l=yi.Push;let S=$v(m.location,w,y);t&&t(S,w),d=c()+1;let T=O_(S,d),C=m.createHref(S);try{s.pushState(T,"",C)}catch(M){if(M instanceof DOMException&&M.name==="DataCloneError")throw M;i.location.assign(C)}a&&u&&u({action:l,location:m.location,delta:1})}o(v,"push");function g(w,y){l=yi.Replace;let S=$v(m.location,w,y);t&&t(S,w),d=c();let T=O_(S,d),C=m.createHref(S);s.replaceState(T,"",C),a&&u&&u({action:l,location:m.location,delta:0})}o(g,"replace");function p(w){let y=i.location.origin!=="null"?i.location.origin:i.location.href,S=typeof w=="string"?w:Jd(w);return S=S.replace(/ $/,"%20"),ut(y,"No window.location.(origin|href) available to create URL for href: "+S),new URL(S,y)}o(p,"createURL");let m={get action(){return l},get location(){return r(i,s)},listen(w){if(u)throw new Error("A history only accepts one active listener");return i.addEventListener(C_,h),u=w,()=>{i.removeEventListener(C_,h),u=null}},createHref(w){return e(i,w)},createURL:p,encodeLocation(w){let y=p(w);return{pathname:y.pathname,search:y.search,hash:y.hash}},push:v,replace:g,go(w){return s.go(w)}};return m}o(Kk,"getUrlBasedHistory");var k_;(function(r){r.data="data",r.deferred="deferred",r.redirect="redirect",r.error="error"})(k_||(k_={}));function Vk(r,e,t){return t===void 0&&(t="/"),Gk(r,e,t)}o(Vk,"matchRoutes");function Gk(r,e,t,n){let i=typeof e=="string"?Ia(e):e,a=Vs(i.pathname||"/",t);if(a==null)return null;let s=nR(r);qk(s);let l=null;for(let u=0;l==null&&u<s.length;++u){let d=nP(a);l=tP(s[u],d)}return l}o(Gk,"matchRoutesImpl");function nR(r,e,t,n){e===void 0&&(e=[]),t===void 0&&(t=[]),n===void 0&&(n="");let i=o((a,s,l)=>{let u={relativePath:l===void 0?a.path||"":l,caseSensitive:a.caseSensitive===!0,childrenIndex:s,route:a};u.relativePath.startsWith("/")&&(ut(u.relativePath.startsWith(n),'Absolute route path "'+u.relativePath+'" nested under path '+('"'+n+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),u.relativePath=u.relativePath.slice(n.length));let d=Oi([n,u.relativePath]),c=t.concat(u);a.children&&a.children.length>0&&(ut(a.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+d+'".')),nR(a.children,e,c,d)),!(a.path==null&&!a.index)&&e.push({path:d,score:Zk(d,a.index),routesMeta:c})},"flattenRoute");return r.forEach((a,s)=>{var l;if(a.path===""||!((l=a.path)!=null&&l.includes("?")))i(a,s);else for(let u of iR(a.path))i(a,s,u)}),e}o(nR,"flattenRoutes");function iR(r){let e=r.split("/");if(e.length===0)return[];let[t,...n]=e,i=t.endsWith("?"),a=t.replace(/\?$/,"");if(n.length===0)return i?[a,""]:[a];let s=iR(n.join("/")),l=[];return l.push(...s.map(u=>u===""?a:[a,u].join("/"))),i&&l.push(...s),l.map(u=>r.startsWith("/")&&u===""?"/":u)}o(iR,"explodeOptionalSegments");function qk(r){r.sort((e,t)=>e.score!==t.score?t.score-e.score:eP(e.routesMeta.map(n=>n.childrenIndex),t.routesMeta.map(n=>n.childrenIndex)))}o(qk,"rankRouteBranches");const Hk=/^:[\w-]+$/,zk=3,Jk=2,Qk=1,Yk=10,Xk=-2,P_=o(r=>r==="*","isSplat");function Zk(r,e){let t=r.split("/"),n=t.length;return t.some(P_)&&(n+=Xk),e&&(n+=Jk),t.filter(i=>!P_(i)).reduce((i,a)=>i+(Hk.test(a)?zk:a===""?Qk:Yk),n)}o(Zk,"computeScore");function eP(r,e){return r.length===e.length&&r.slice(0,-1).every((n,i)=>n===e[i])?r[r.length-1]-e[e.length-1]:0}o(eP,"compareIndexes");function tP(r,e,t){let{routesMeta:n}=r,i={},a="/",s=[];for(let l=0;l<n.length;++l){let u=n[l],d=l===n.length-1,c=a==="/"?e:e.slice(a.length)||"/",h=Wv({path:u.relativePath,caseSensitive:u.caseSensitive,end:d},c),v=u.route;if(!h)return null;Object.assign(i,h.params),s.push({params:i,pathname:Oi([a,h.pathname]),pathnameBase:oP(Oi([a,h.pathnameBase])),route:v}),h.pathnameBase!=="/"&&(a=Oi([a,h.pathnameBase]))}return s}o(tP,"matchRouteBranch");function Wv(r,e){typeof r=="string"&&(r={path:r,caseSensitive:!1,end:!0});let[t,n]=rP(r.path,r.caseSensitive,r.end),i=e.match(t);if(!i)return null;let a=i[0],s=a.replace(/(.)\/+$/,"$1"),l=i.slice(1);return{params:n.reduce((d,c,h)=>{let{paramName:v,isOptional:g}=c;if(v==="*"){let m=l[h]||"";s=a.slice(0,a.length-m.length).replace(/(.)\/+$/,"$1")}const p=l[h];return g&&!p?d[v]=void 0:d[v]=(p||"").replace(/%2F/g,"/"),d},{}),pathname:a,pathnameBase:s,pattern:r}}o(Wv,"matchPath");function rP(r,e,t){e===void 0&&(e=!1),t===void 0&&(t=!0),qg(r==="*"||!r.endsWith("*")||r.endsWith("/*"),'Route path "'+r+'" will be treated as if it were '+('"'+r.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+r.replace(/\*$/,"/*")+'".'));let n=[],i="^"+r.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(s,l,u)=>(n.push({paramName:l,isOptional:u!=null}),u?"/?([^\\/]+)?":"/([^\\/]+)"));return r.endsWith("*")?(n.push({paramName:"*"}),i+=r==="*"||r==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):t?i+="\\/*$":r!==""&&r!=="/"&&(i+="(?:(?=\\/|$))"),[new RegExp(i,e?void 0:"i"),n]}o(rP,"compilePath");function nP(r){try{return r.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(e){return qg(!1,'The URL path "'+r+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+e+").")),r}}o(nP,"decodePath");function Vs(r,e){if(e==="/")return r;if(!r.toLowerCase().startsWith(e.toLowerCase()))return null;let t=e.endsWith("/")?e.length-1:e.length,n=r.charAt(t);return n&&n!=="/"?null:r.slice(t)||"/"}o(Vs,"stripBasename");function iP(r,e){e===void 0&&(e="/");let{pathname:t,search:n="",hash:i=""}=typeof r=="string"?Ia(r):r;return{pathname:t?t.startsWith("/")?t:aP(t,e):e,search:lP(n),hash:uP(i)}}o(iP,"resolvePath");function aP(r,e){let t=e.replace(/\/+$/,"").split("/");return r.split("/").forEach(i=>{i===".."?t.length>1&&t.pop():i!=="."&&t.push(i)}),t.length>1?t.join("/"):"/"}o(aP,"resolvePathname");function mf(r,e,t,n){return"Cannot include a '"+r+"' character in a manually specified "+("`to."+e+"` field ["+JSON.stringify(n)+"].  Please separate it out to the ")+("`to."+t+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}o(mf,"getInvalidPathError");function sP(r){return r.filter((e,t)=>t===0||e.route.path&&e.route.path.length>0)}o(sP,"getPathContributingMatches");function Hg(r,e){let t=sP(r);return e?t.map((n,i)=>i===t.length-1?n.pathname:n.pathnameBase):t.map(n=>n.pathnameBase)}o(Hg,"getResolveToMatches");function zg(r,e,t,n){n===void 0&&(n=!1);let i;typeof r=="string"?i=Ia(r):(i=Ol({},r),ut(!i.pathname||!i.pathname.includes("?"),mf("?","pathname","search",i)),ut(!i.pathname||!i.pathname.includes("#"),mf("#","pathname","hash",i)),ut(!i.search||!i.search.includes("#"),mf("#","search","hash",i)));let a=r===""||i.pathname==="",s=a?"/":i.pathname,l;if(s==null)l=t;else{let h=e.length-1;if(!n&&s.startsWith("..")){let v=s.split("/");for(;v[0]==="..";)v.shift(),h-=1;i.pathname=v.join("/")}l=h>=0?e[h]:"/"}let u=iP(i,l),d=s&&s!=="/"&&s.endsWith("/"),c=(a||s===".")&&t.endsWith("/");return!u.pathname.endsWith("/")&&(d||c)&&(u.pathname+="/"),u}o(zg,"resolveTo");const Oi=o(r=>r.join("/").replace(/\/\/+/g,"/"),"joinPaths"),oP=o(r=>r.replace(/\/+$/,"").replace(/^\/*/,"/"),"normalizePathname"),lP=o(r=>!r||r==="?"?"":r.startsWith("?")?r:"?"+r,"normalizeSearch"),uP=o(r=>!r||r==="#"?"":r.startsWith("#")?r:"#"+r,"normalizeHash");function dP(r){return r!=null&&typeof r.status=="number"&&typeof r.statusText=="string"&&typeof r.internal=="boolean"&&"data"in r}o(dP,"isRouteErrorResponse");const aR=["post","put","patch","delete"];new Set(aR);const cP=["get",...aR];new Set(cP);/**
 * React Router v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function kl(){return kl=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},kl.apply(this,arguments)}o(kl,"_extends$1");const Eh=$.createContext(null),sR=$.createContext(null),Qn=$.createContext(null),_h=$.createContext(null),wn=$.createContext({outlet:null,matches:[],isDataRoute:!1}),oR=$.createContext(null);function hP(r,e){let{relative:t}=e===void 0?{}:e;so()||ut(!1);let{basename:n,navigator:i}=$.useContext(Qn),{hash:a,pathname:s,search:l}=bh(r,{relative:t}),u=s;return n!=="/"&&(u=s==="/"?n:Oi([n,s])),i.createHref({pathname:u,search:l,hash:a})}o(hP,"useHref");function so(){return $.useContext(_h)!=null}o(so,"useInRouterContext");function Tn(){return so()||ut(!1),$.useContext(_h).location}o(Tn,"useLocation");function lR(r){$.useContext(Qn).static||$.useLayoutEffect(r)}o(lR,"useIsomorphicLayoutEffect");function oo(){let{isDataRoute:r}=$.useContext(wn);return r?IP():fP()}o(oo,"useNavigate");function fP(){so()||ut(!1);let r=$.useContext(Eh),{basename:e,future:t,navigator:n}=$.useContext(Qn),{matches:i}=$.useContext(wn),{pathname:a}=Tn(),s=JSON.stringify(Hg(i,t.v7_relativeSplatPath)),l=$.useRef(!1);return lR(()=>{l.current=!0}),$.useCallback(function(d,c){if(c===void 0&&(c={}),!l.current)return;if(typeof d=="number"){n.go(d);return}let h=zg(d,JSON.parse(s),a,c.relative==="path");r==null&&e!=="/"&&(h.pathname=h.pathname==="/"?e:Oi([e,h.pathname])),(c.replace?n.replace:n.push)(h,c.state,c)},[e,n,s,a,r])}o(fP,"useNavigateUnstable");const vP=$.createContext(null);function pP(r){let e=$.useContext(wn).outlet;return e&&$.createElement(vP.Provider,{value:r},e)}o(pP,"useOutlet");function lo(){let{matches:r}=$.useContext(wn),e=r[r.length-1];return e?e.params:{}}o(lo,"useParams");function bh(r,e){let{relative:t}=e===void 0?{}:e,{future:n}=$.useContext(Qn),{matches:i}=$.useContext(wn),{pathname:a}=Tn(),s=JSON.stringify(Hg(i,n.v7_relativeSplatPath));return $.useMemo(()=>zg(r,JSON.parse(s),a,t==="path"),[r,s,a,t])}o(bh,"useResolvedPath");function mP(r,e){return gP(r,e)}o(mP,"useRoutes");function gP(r,e,t,n){so()||ut(!1);let{navigator:i}=$.useContext(Qn),{matches:a}=$.useContext(wn),s=a[a.length-1],l=s?s.params:{};s&&s.pathname;let u=s?s.pathnameBase:"/";s&&s.route;let d=Tn(),c;if(e){var h;let w=typeof e=="string"?Ia(e):e;u==="/"||(h=w.pathname)!=null&&h.startsWith(u)||ut(!1),c=w}else c=d;let v=c.pathname||"/",g=v;if(u!=="/"){let w=u.replace(/^\//,"").split("/");g="/"+v.replace(/^\//,"").split("/").slice(w.length).join("/")}let p=Vk(r,{pathname:g}),m=_P(p&&p.map(w=>Object.assign({},w,{params:Object.assign({},l,w.params),pathname:Oi([u,i.encodeLocation?i.encodeLocation(w.pathname).pathname:w.pathname]),pathnameBase:w.pathnameBase==="/"?u:Oi([u,i.encodeLocation?i.encodeLocation(w.pathnameBase).pathname:w.pathnameBase])})),a,t,n);return e&&m?$.createElement(_h.Provider,{value:{location:kl({pathname:"/",search:"",hash:"",state:null,key:"default"},c),navigationType:yi.Pop}},m):m}o(gP,"useRoutesImpl");function yP(){let r=RP(),e=dP(r)?r.status+" "+r.statusText:r instanceof Error?r.message:JSON.stringify(r),t=r instanceof Error?r.stack:null,i={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return $.createElement($.Fragment,null,$.createElement("h2",null,"Unexpected Application Error!"),$.createElement("h3",{style:{fontStyle:"italic"}},e),t?$.createElement("pre",{style:i},t):null,null)}o(yP,"DefaultErrorComponent");const SP=$.createElement(yP,null),_y=class _y extends $.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||t.revalidation!=="idle"&&e.revalidation==="idle"?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:e.error!==void 0?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){console.error("React Router caught the following error during render",e,t)}render(){return this.state.error!==void 0?$.createElement(wn.Provider,{value:this.props.routeContext},$.createElement(oR.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};o(_y,"RenderErrorBoundary");let Kv=_y;function EP(r){let{routeContext:e,match:t,children:n}=r,i=$.useContext(Eh);return i&&i.static&&i.staticContext&&(t.route.errorElement||t.route.ErrorBoundary)&&(i.staticContext._deepestRenderedBoundaryId=t.route.id),$.createElement(wn.Provider,{value:e},n)}o(EP,"RenderedRoute");function _P(r,e,t,n){var i;if(e===void 0&&(e=[]),t===void 0&&(t=null),n===void 0&&(n=null),r==null){var a;if(!t)return null;if(t.errors)r=t.matches;else if((a=n)!=null&&a.v7_partialHydration&&e.length===0&&!t.initialized&&t.matches.length>0)r=t.matches;else return null}let s=r,l=(i=t)==null?void 0:i.errors;if(l!=null){let c=s.findIndex(h=>h.route.id&&(l==null?void 0:l[h.route.id])!==void 0);c>=0||ut(!1),s=s.slice(0,Math.min(s.length,c+1))}let u=!1,d=-1;if(t&&n&&n.v7_partialHydration)for(let c=0;c<s.length;c++){let h=s[c];if((h.route.HydrateFallback||h.route.hydrateFallbackElement)&&(d=c),h.route.id){let{loaderData:v,errors:g}=t,p=h.route.loader&&v[h.route.id]===void 0&&(!g||g[h.route.id]===void 0);if(h.route.lazy||p){u=!0,d>=0?s=s.slice(0,d+1):s=[s[0]];break}}}return s.reduceRight((c,h,v)=>{let g,p=!1,m=null,w=null;t&&(g=l&&h.route.id?l[h.route.id]:void 0,m=h.route.errorElement||SP,u&&(d<0&&v===0?(CP("route-fallback"),p=!0,w=null):d===v&&(p=!0,w=h.route.hydrateFallbackElement||null)));let y=e.concat(s.slice(0,v+1)),S=o(()=>{let T;return g?T=m:p?T=w:h.route.Component?T=$.createElement(h.route.Component,null):h.route.element?T=h.route.element:T=c,$.createElement(EP,{match:h,routeContext:{outlet:c,matches:y,isDataRoute:t!=null},children:T})},"getChildren");return t&&(h.route.ErrorBoundary||h.route.errorElement||v===0)?$.createElement(Kv,{location:t.location,revalidation:t.revalidation,component:m,error:g,children:S(),routeContext:{outlet:null,matches:y,isDataRoute:!0}}):S()},null)}o(_P,"_renderMatches");var uR=function(r){return r.UseBlocker="useBlocker",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r}(uR||{}),dR=function(r){return r.UseBlocker="useBlocker",r.UseLoaderData="useLoaderData",r.UseActionData="useActionData",r.UseRouteError="useRouteError",r.UseNavigation="useNavigation",r.UseRouteLoaderData="useRouteLoaderData",r.UseMatches="useMatches",r.UseRevalidator="useRevalidator",r.UseNavigateStable="useNavigate",r.UseRouteId="useRouteId",r}(dR||{});function bP(r){let e=$.useContext(Eh);return e||ut(!1),e}o(bP,"useDataRouterContext$1");function wP(r){let e=$.useContext(sR);return e||ut(!1),e}o(wP,"useDataRouterState");function TP(r){let e=$.useContext(wn);return e||ut(!1),e}o(TP,"useRouteContext");function cR(r){let e=TP(),t=e.matches[e.matches.length-1];return t.route.id||ut(!1),t.route.id}o(cR,"useCurrentRouteId");function RP(){var r;let e=$.useContext(oR),t=wP(),n=cR();return e!==void 0?e:(r=t.errors)==null?void 0:r[n]}o(RP,"useRouteError");function IP(){let{router:r}=bP(uR.UseNavigateStable),e=cR(dR.UseNavigateStable),t=$.useRef(!1);return lR(()=>{t.current=!0}),$.useCallback(function(i,a){a===void 0&&(a={}),t.current&&(typeof i=="number"?r.navigate(i):r.navigate(i,kl({fromRouteId:e},a)))},[r,e])}o(IP,"useNavigateStable");const M_={};function CP(r,e,t){M_[r]||(M_[r]=!0)}o(CP,"warningOnce");function OP(r,e){r==null||r.v7_startTransition,r==null||r.v7_relativeSplatPath}o(OP,"logV6DeprecationWarnings");function el(r){let{to:e,replace:t,state:n,relative:i}=r;so()||ut(!1);let{future:a,static:s}=$.useContext(Qn),{matches:l}=$.useContext(wn),{pathname:u}=Tn(),d=oo(),c=zg(e,Hg(l,a.v7_relativeSplatPath),u,i==="path"),h=JSON.stringify(c);return $.useEffect(()=>d(JSON.parse(h),{replace:t,state:n,relative:i}),[d,h,i,t,n]),null}o(el,"Navigate");function kP(r){return pP(r.context)}o(kP,"Outlet");function Rt(r){ut(!1)}o(Rt,"Route");function PP(r){let{basename:e="/",children:t=null,location:n,navigationType:i=yi.Pop,navigator:a,static:s=!1,future:l}=r;so()&&ut(!1);let u=e.replace(/^\/*/,"/"),d=$.useMemo(()=>({basename:u,navigator:a,static:s,future:kl({v7_relativeSplatPath:!1},l)}),[u,l,a,s]);typeof n=="string"&&(n=Ia(n));let{pathname:c="/",search:h="",hash:v="",state:g=null,key:p="default"}=n,m=$.useMemo(()=>{let w=Vs(c,u);return w==null?null:{location:{pathname:w,search:h,hash:v,state:g,key:p},navigationType:i}},[u,c,h,v,g,p,i]);return m==null?null:$.createElement(Qn.Provider,{value:d},$.createElement(_h.Provider,{children:t,value:m}))}o(PP,"Router");function MP(r){let{children:e,location:t}=r;return mP(Vv(e),t)}o(MP,"Routes");new Promise(()=>{});function Vv(r,e){e===void 0&&(e=[]);let t=[];return $.Children.forEach(r,(n,i)=>{if(!$.isValidElement(n))return;let a=[...e,i];if(n.type===$.Fragment){t.push.apply(t,Vv(n.props.children,a));return}n.type!==Rt&&ut(!1),!n.props.index||!n.props.children||ut(!1);let s={id:n.props.id||a.join("-"),caseSensitive:n.props.caseSensitive,element:n.props.element,Component:n.props.Component,index:n.props.index,path:n.props.path,loader:n.props.loader,action:n.props.action,errorElement:n.props.errorElement,ErrorBoundary:n.props.ErrorBoundary,hasErrorBoundary:n.props.ErrorBoundary!=null||n.props.errorElement!=null,shouldRevalidate:n.props.shouldRevalidate,handle:n.props.handle,lazy:n.props.lazy};n.props.children&&(s.children=Vv(n.props.children,a)),t.push(s)}),t}o(Vv,"createRoutesFromChildren");/**
 * React Router DOM v6.30.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Qd(){return Qd=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},Qd.apply(this,arguments)}o(Qd,"_extends");function hR(r,e){if(r==null)return{};var t={},n=Object.keys(r),i,a;for(a=0;a<n.length;a++)i=n[a],!(e.indexOf(i)>=0)&&(t[i]=r[i]);return t}o(hR,"_objectWithoutPropertiesLoose$1");function AP(r){return!!(r.metaKey||r.altKey||r.ctrlKey||r.shiftKey)}o(AP,"isModifiedEvent");function xP(r,e){return r.button===0&&(!e||e==="_self")&&!AP(r)}o(xP,"shouldProcessLinkClick");const DP=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","viewTransition"],NP=["aria-current","caseSensitive","className","end","style","to","viewTransition","children"],LP="6";try{window.__reactRouterVersion=LP}catch{}const UP=$.createContext({isTransitioning:!1}),jP="startTransition",A_=kC[jP];function FP(r){let{basename:e,children:t,future:n,window:i}=r,a=$.useRef();a.current==null&&(a.current=$k({window:i,v5Compat:!0}));let s=a.current,[l,u]=$.useState({action:s.action,location:s.location}),{v7_startTransition:d}=n||{},c=$.useCallback(h=>{d&&A_?A_(()=>u(h)):u(h)},[u,d]);return $.useLayoutEffect(()=>s.listen(c),[s,c]),$.useEffect(()=>OP(n),[n]),$.createElement(PP,{basename:e,children:t,location:l.location,navigationType:l.action,navigator:s,future:n})}o(FP,"HashRouter");const BP=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u",$P=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Jg=$.forwardRef(o(function(e,t){let{onClick:n,relative:i,reloadDocument:a,replace:s,state:l,target:u,to:d,preventScrollReset:c,viewTransition:h}=e,v=hR(e,DP),{basename:g}=$.useContext(Qn),p,m=!1;if(typeof d=="string"&&$P.test(d)&&(p=d,BP))try{let T=new URL(window.location.href),C=d.startsWith("//")?new URL(T.protocol+d):new URL(d),M=Vs(C.pathname,g);C.origin===T.origin&&M!=null?d=M+C.search+C.hash:m=!0}catch{}let w=hP(d,{relative:i}),y=VP(d,{replace:s,state:l,target:u,preventScrollReset:c,relative:i,viewTransition:h});function S(T){n&&n(T),T.defaultPrevented||y(T)}return o(S,"handleClick"),$.createElement("a",Qd({},v,{href:p||w,onClick:m||a?n:S,ref:t,target:u}))},"LinkWithRef")),WP=$.forwardRef(o(function(e,t){let{"aria-current":n="page",caseSensitive:i=!1,className:a="",end:s=!1,style:l,to:u,viewTransition:d,children:c}=e,h=hR(e,NP),v=bh(u,{relative:h.relative}),g=Tn(),p=$.useContext(sR),{navigator:m,basename:w}=$.useContext(Qn),y=p!=null&&GP(v)&&d===!0,S=m.encodeLocation?m.encodeLocation(v).pathname:v.pathname,T=g.pathname,C=p&&p.navigation&&p.navigation.location?p.navigation.location.pathname:null;i||(T=T.toLowerCase(),C=C?C.toLowerCase():null,S=S.toLowerCase()),C&&w&&(C=Vs(C,w)||C);const M=S!=="/"&&S.endsWith("/")?S.length-1:S.length;let _=T===S||!s&&T.startsWith(S)&&T.charAt(M)==="/",O=C!=null&&(C===S||!s&&C.startsWith(S)&&C.charAt(S.length)==="/"),b={isActive:_,isPending:O,isTransitioning:y},j=_?n:void 0,B;typeof a=="function"?B=a(b):B=[a,_?"active":null,O?"pending":null,y?"transitioning":null].filter(Boolean).join(" ");let q=typeof l=="function"?l(b):l;return $.createElement(Jg,Qd({},h,{"aria-current":j,className:B,ref:t,style:q,to:u,viewTransition:d}),typeof c=="function"?c(b):c)},"NavLinkWithRef"));var Gv;(function(r){r.UseScrollRestoration="useScrollRestoration",r.UseSubmit="useSubmit",r.UseSubmitFetcher="useSubmitFetcher",r.UseFetcher="useFetcher",r.useViewTransitionState="useViewTransitionState"})(Gv||(Gv={}));var x_;(function(r){r.UseFetcher="useFetcher",r.UseFetchers="useFetchers",r.UseScrollRestoration="useScrollRestoration"})(x_||(x_={}));function KP(r){let e=$.useContext(Eh);return e||ut(!1),e}o(KP,"useDataRouterContext");function VP(r,e){let{target:t,replace:n,state:i,preventScrollReset:a,relative:s,viewTransition:l}=e===void 0?{}:e,u=oo(),d=Tn(),c=bh(r,{relative:s});return $.useCallback(h=>{if(xP(h,t)){h.preventDefault();let v=n!==void 0?n:Jd(d)===Jd(c);u(r,{replace:v,state:i,preventScrollReset:a,relative:s,viewTransition:l})}},[d,u,c,n,i,t,r,a,s,l])}o(VP,"useLinkClickHandler");function GP(r,e){e===void 0&&(e={});let t=$.useContext(UP);t==null&&ut(!1);let{basename:n}=KP(Gv.useViewTransitionState),i=bh(r,{relative:e.relative});if(!t.isTransitioning)return!1;let a=Vs(t.currentLocation.pathname,n)||t.currentLocation.pathname,s=Vs(t.nextLocation.pathname,n)||t.nextLocation.pathname;return Wv(i.pathname,s)!=null||Wv(i.pathname,a)!=null}o(GP,"useViewTransitionState");const D_="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function gf(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}o(gf,"readJSON$2");function qP(r){try{const e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}"),n=JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{};return{name:e.name||n.name||"Org",logo:e.logoDataUrl||e.logoUrl||n.logoDataUrl||n.logoUrl||null}}catch{return{name:"Org",logo:null}}}o(qP,"readOrgInfo");function HP(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)\/public/i);return r?decodeURIComponent(r[1]):null}o(HP,"parseOrgIdFromHash$1");function zP(r){const e=gf(`bf_org_settings_${r}`,{}),t=gf(`bf_public_cfg_${r}`,null)||gf(`bf_public_${r}`,null)||null,n=(t==null?void 0:t.title)||(e==null?void 0:e.name)||"Your Organization",i=(t==null?void 0:t.about)||"",a=Array.isArray(t==null?void 0:t.features)?t.features:[],s=Array.isArray(t==null?void 0:t.links)?t.links:[],l=(t==null?void 0:t.logoDataUrl)||(t==null?void 0:t.logoUrl)||(e==null?void 0:e.logoDataUrl)||(e==null?void 0:e.logoUrl)||null;return{title:n,about:i,features:a,links:s,logo:l,enabled:!0}}o(zP,"getPreviewConfig");function Yd(r){const e=(r==null?void 0:r.data)||null,{slug:t}=lo(),[n,i]=$.useState(()=>e?{loading:!1,error:"",data:e}:t?{loading:!0,error:"",data:null}:{loading:!1,error:"",data:null}),[a,s]=$.useState([]);$.useEffect(()=>{if(!t||e)return;let m=!0;return(async()=>{try{const w=await fetch(`${D_}/api/public/${encodeURIComponent(t)}`),y=await w.json().catch(()=>({}));if(!m)return;if(!w.ok||y.ok===!1){i({loading:!1,error:y.error||`HTTP ${w.status}`,data:null});return}i({loading:!1,error:"",data:y});const T=await(await fetch(`${D_}/api/public/${encodeURIComponent(t)}/needs`)).json().catch(()=>({}));if(!m)return;s(Array.isArray(T.needs)?T.needs:[])}catch(w){m&&i({loading:!1,error:(w==null?void 0:w.message)||"Load failed",data:null})}})(),()=>{m=!1}},[t,e]);const{pubCfg:l,orgId:u}=$.useMemo(()=>{var y;if(t&&((y=n.data)!=null&&y.public)){const S=n.data.public,T=n.data.orgId||null;return{pubCfg:{title:S.title||t,about:S.about||"",features:Array.isArray(S.features)?S.features:[],links:Array.isArray(S.links)?S.links:[],logo:S.logoDataUrl||S.logoUrl||null,enabled:!0},orgId:T}}const m=HP();return{pubCfg:e!=null&&e.public?{title:e.public.title||"Your Organization",about:e.public.about||"",features:Array.isArray(e.public.features)?e.public.features:[],links:Array.isArray(e.public.links)?e.public.links:[],logo:e.public.logoDataUrl||e.public.logoUrl||null,enabled:!0}:zP(m),orgId:m}},[t,n.data,e]),d=$.useMemo(()=>u?qP(u):{name:"Org",logo:null},[u]),[c,h]=$.useState(""),[v,g]=$.useState(""),p=$.useMemo(()=>a.filter(m=>((m==null?void 0:m.status)??"open")==="open"),[a]);return n.loading?E.jsx("div",{style:{padding:16},children:"Loading"}):n.error?E.jsxs("div",{style:{padding:16,color:"crimson"},children:["Error: ",n.error]}):E.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[E.jsxs("header",{style:{display:"flex",alignItems:"center",gap:12,marginTop:0,borderBottom:"1px solid #eee",paddingBottom:12},children:[d.logo&&E.jsx("img",{src:d.logo,alt:"Org logo",style:{height:48,width:48,borderRadius:8,objectFit:"cover"}}),E.jsx("h1",{style:{margin:0,fontSize:24},children:(l==null?void 0:l.title)||d.name||t||"Public Page"})]}),(l==null?void 0:l.about)&&E.jsx("p",{style:{lineHeight:1.6,marginTop:12},children:l.about}),Array.isArray(l==null?void 0:l.features)&&l.features.length>0&&E.jsxs("div",{className:"card",style:{marginTop:16,padding:12},children:[E.jsx("h3",{className:"section-title",style:{margin:0},children:"What we do"}),E.jsx("ul",{style:{paddingLeft:18,marginTop:8},children:l.features.map((m,w)=>E.jsx("li",{children:m},w))})]}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:12,marginTop:12},children:[E.jsxs("section",{className:"card",style:{padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Open needs"}),E.jsxs("ul",{style:{paddingLeft:18,marginTop:8},children:[p.map(m=>E.jsxs("li",{children:[E.jsx("strong",{children:m.title||"Untitled"}),m.urgency?`  ${m.urgency}`:""]},m.id||m.title)),p.length===0&&E.jsx("li",{className:"helper",children:"No open needs right now."})]})]}),E.jsxs("section",{className:"card",style:{padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Stay in touch"}),E.jsx("div",{className:"helper",children:"Newsletter and pledges can be wired next."})]})]})]})}o(Yd,"PublicPage");function JP(r){let e={};try{e=JSON.parse(localStorage.getItem(`bf_org_settings_${r}`)||"{}")}catch{}try{e={...JSON.parse(localStorage.getItem("bf_orgs")||"[]").find(i=>(i==null?void 0:i.id)===r)||{},...e}}catch{}return e||{}}o(JP,"readSettings");function QP(r){return Array.isArray(r)?r.filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>e.trim()).filter(Boolean):[]}o(QP,"toArray");function YP(r){return Array.isArray(r)?r.map(e=>e&&e.url?{text:e.text||e.url,url:e.url}:null).filter(Boolean):typeof r=="string"?r.split(`
`).map(e=>{const[t,n]=e.split("|").map(i=>(i||"").trim());return n?{text:t||n,url:n}:null}).filter(Boolean):[]}o(YP,"toLinks");function XP(){const{orgId:r}=lo(),e=JP(r),t=(e.publicTitle||e.title||e.name||"Public page").trim(),n=(e.publicAbout||e.about||"This is a live preview of your public page.").trim(),i=QP(e.publicFeatures??e.features),a=YP(e.publicLinks??e.links),s={public:{title:t,about:n,features:i.length?i:["Mutual aid & community support","Donations & supplies","Volunteer coordination"],links:a.length?a:[{text:"Website",url:"https://example.org"},{text:"Email",url:"mailto:hello@example.org"}]}};return E.jsx("div",{style:{margin:16},children:E.jsx(Yd,{data:s})})}o(XP,"OrgPublicPreview");function ZP(){return localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token")||""}o(ZP,"getAuthToken");async function ot(r,e={}){const t=new Headers(e.headers||{}),n=ZP();n&&t.set("authorization",`Bearer ${n}`),!t.has("content-type")&&e.body&&typeof e.body=="string"&&t.set("content-type","application/json; charset=utf-8");const i=await fetch(r,{...e,headers:t}),a=await i.json().catch(()=>({}));if(!i.ok||(a==null?void 0:a.ok)===!1){const s=(a==null?void 0:a.error)||(a==null?void 0:a.message)||`HTTP_${i.status}`;throw new Error(s)}return a}o(ot,"api");function eM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(eM,"getOrgId$5");function N_(){const r=oo(),e=eM(),[t,n]=$.useState(!1),[i,a]=$.useState("..."),[s,l]=$.useState(null);async function u(){if(e){n(!0),a("");try{const g=await ot(`/api/orgs/${encodeURIComponent(e)}/dashboard`);l(g)}catch(g){a((g==null?void 0:g.message)||"Failed to load dashboard")}finally{n(!1)}}}o(u,"refresh"),$.useEffect(()=>{u().catch(console.error)},[e]);const d=(s==null?void 0:s.counts)||{},c=Array.isArray(s==null?void 0:s.people)?s.people:[],h=Array.isArray(s==null?void 0:s.needs)?s.needs:[],v=Array.isArray(s==null?void 0:s.activity)?s.activity:[];return e?E.jsxs("div",{style:{padding:16},children:[E.jsxs("div",{className:"card",style:{padding:16,marginBottom:12},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h1",{style:{margin:0,flex:1},children:"Bondfire Dashboard"}),E.jsx("button",{className:"btn",onClick:o(()=>u().catch(console.error),"onClick"),disabled:t,children:t?"Loading":"Refresh"})]}),i&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:i})]}),E.jsxs("div",{className:"grid",style:{gridTemplateColumns:"repeat(auto-fit, minmax(260px, 1fr))",gap:12},children:[E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"People"}),E.jsx("button",{className:"btn",onClick:o(()=>go("people"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.people||0," member",(d.people||0)===1?"":"s"]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[c.map(g=>E.jsx("li",{children:g.name},g.id)),c.length===0&&E.jsx("li",{className:"helper",children:"No people yet."})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Inventory"}),E.jsx("button",{className:"btn",onClick:o(()=>r("inventory"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.inventory||0," item",(d.inventory||0)===1?"":"s"]}),E.jsx("div",{className:"helper",style:{marginTop:10},children:"Manage supplies and public-facing items."})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Needs"}),E.jsx("button",{className:"btn",onClick:o(()=>r("needs"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.needsAll||0," total, ",d.needsOpen||0," open"]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[h.map(g=>E.jsxs("li",{children:[g.title," ",g.status?` ${g.status}`:""]},g.id)),h.length===0&&E.jsx("li",{className:"helper",children:"No needs yet."})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Meetings"}),E.jsx("button",{className:"btn",onClick:o(()=>r("meetings"),"onClick"),children:"View all"})]}),E.jsxs("div",{className:"helper",style:{marginTop:10},children:[d.meetingsUpcoming||0," upcoming"]}),E.jsx("div",{className:"helper",style:{marginTop:10},children:"Notes and decisions, tied to people and needs."})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Recent Activity"}),E.jsx("button",{className:"btn",onClick:o(()=>u().catch(console.error),"onClick"),disabled:t,children:"Refresh"})]}),E.jsxs("ul",{style:{marginTop:10,paddingLeft:18},children:[v.map(g=>E.jsxs("li",{children:[E.jsx("strong",{children:g.kind}),": ",g.message]},g.id||`${g.kind}-${g.created_at}`)),v.length===0&&E.jsx("li",{className:"helper",children:"No activity yet."})]})]})]})]}):E.jsx("div",{style:{padding:16},children:"No org selected."})}o(N_,"Overview");const tM="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function rM(){return localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token")||""}o(rM,"getToken$1");async function yf(r,e={}){const t=rM(),n=r.startsWith("http")?r:`${tM}${r.startsWith("/")?"":"/"}${r}`,i={"Content-Type":"application/json",...e.headers||{}};t&&(i.Authorization=`Bearer ${t}`);const a=await fetch(n,{...e,headers:i,body:e.body?JSON.stringify(e.body):void 0}),s=await a.json().catch(()=>({}));if(!a.ok||s.ok===!1)throw new Error(s.error||s.message||`HTTP ${a.status}`);return s}o(yf,"authFetch$1");function nM(){const r=oo(),[e,t]=$.useState([]),[n,i]=$.useState(!1),[a,s]=$.useState(""),[l,u]=$.useState(""),[d,c]=$.useState(""),h=$.useCallback(async()=>{s("");try{const p=await yf("/api/orgs",{method:"GET"});t(Array.isArray(p.orgs)?p.orgs:[])}catch(p){s(p.message||"Failed to load orgs")}},[]);$.useEffect(()=>{h()},[h]);const v=o(async p=>{var w;p==null||p.preventDefault();const m=(l||"").trim();if(m){i(!0),s("");try{const y=await yf("/api/orgs/create",{method:"POST",body:{name:m}});u(""),await h(),(w=y==null?void 0:y.org)!=null&&w.id&&r(`/org/${encodeURIComponent(y.org.id)}`)}catch(y){s(y.message||"Failed to create org")}finally{i(!1)}}},"createOrg"),g=o(async p=>{var w;p==null||p.preventDefault();const m=(d||"").trim();if(m){i(!0),s("");try{const y=await yf("/api/invites/redeem",{method:"POST",body:{code:m}});c(""),await h(),(w=y==null?void 0:y.org)!=null&&w.id?r(`/org/${encodeURIComponent(y.org.id)}`):s("Joined.")}catch(y){s(y.message||"Failed to join")}finally{i(!1)}}},"joinWithInvite");return E.jsxs("div",{style:{padding:16},children:[E.jsx("h1",{style:{marginTop:0},children:"Org Dashboard"}),E.jsx("p",{className:"helper",children:"Choose an organization to enter its workspace, or create or join one."}),E.jsxs("div",{className:"grid",style:{gap:16,gridTemplateColumns:"1fr 1fr"},children:[E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Create a new org"}),E.jsxs("form",{onSubmit:v,className:"grid",style:{gap:10},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Organization name"}),E.jsx("input",{className:"input",value:l,onChange:o(p=>u(p.target.value),"onChange"),placeholder:"e.g. Bondfire Team"})]}),E.jsx("button",{className:"btn-red",disabled:n||!l.trim(),children:"Create"})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Join with an invite code"}),E.jsxs("form",{onSubmit:g,className:"grid",style:{gap:10},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Invite code"}),E.jsx("input",{className:"input",value:d,onChange:o(p=>c(p.target.value),"onChange"),placeholder:"Paste invite code",autoCapitalize:"characters",autoCorrect:"off"})]}),E.jsx("button",{className:"btn-red",disabled:n||!d.trim(),children:"Join"})]})]})]}),E.jsxs("div",{className:"card",style:{padding:16,marginTop:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[E.jsx("h2",{style:{margin:0,flex:1},children:"Your orgs"}),E.jsx("button",{className:"btn",onClick:h,disabled:n,children:"Refresh"})]}),a&&E.jsx("div",{className:a.toLowerCase().includes("fail")?"error":"helper",style:{marginTop:10},children:a}),e.length===0?E.jsx("div",{className:"helper",style:{marginTop:12},children:"No orgs yet."}):E.jsx("div",{style:{marginTop:12},children:e.map(p=>E.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",padding:"10px 0",borderTop:"1px solid #222"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontWeight:700},children:p.name||p.id}),E.jsxs("div",{className:"helper",children:["Role: ",p.role||"member"]})]}),E.jsx("button",{className:"btn-red",onClick:o(()=>r(`/org/${encodeURIComponent(p.id)}`),"onClick"),children:"Open"})]},p.id))})]})]})}o(nM,"OrgDash");const iM=$.createContext(null),L_=o(()=>$.useContext(iM),"useOrg"),fR="bf_store_v2",U_=o(()=>({orgs:[{id:"crman",name:"Chehalis River Mutual Aid Network",slug:"crman",color:"#8a1111",logoDataUrl:null},{id:"bondfire",name:"Bondfire",slug:"bondfire",color:"#8a1111",logoDataUrl:null}],currentOrgId:"crman",people:[],inventory:[],needs:[],meetings:[],pledges:[],newsletters:[],requests:[],files:{}}),"defaultState");function j_(r){return localStorage.setItem(fR,JSON.stringify(r)),r}o(j_,"save");function aM(){try{return JSON.parse(localStorage.getItem(fR))||j_(U_())}catch{return j_(U_())}}o(aM,"load");aM();function sM(){const{orgId:r}=lo();return((typeof L_=="function"?L_():{})||{}).orgName,E.jsx("div",{style:{padding:0},children:E.jsx(kP,{})})}o(sM,"InnerSanctum");function oM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(oM,"getOrgId$4");function lM(){const r=oM(),[e,t]=$.useState([]);async function n(){if(!r)return;const u=await ot(`/api/orgs/${encodeURIComponent(r)}/people`);t(u.people||[])}o(n,"refresh"),$.useEffect(()=>{n().catch(console.error)},[r]);const[i,a]=$.useState(""),s=$.useMemo(()=>{const u=i.toLowerCase();return e.filter(d=>[d.name,d.role,d.skills,d.phone].filter(Boolean).join(" ").toLowerCase().includes(u))},[e,i]);async function l(u){if(u.preventDefault(),!r)return;const d=new FormData(u.currentTarget),c=String(d.get("name")||"").trim();if(!c)return;const h=String(d.get("role")||""),v=String(d.get("phone")||""),g=String(d.get("skills")||""),p=await ot(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c,role:h,phone:v,skills:g})});p!=null&&p.id&&t(m=>[{id:p.id,name:c,role:h,phone:v,skills:g},...m]),u.currentTarget.reset(),setTimeout(()=>{n().catch(console.error)},500)}return o(l,"onAdd"),E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsx("h2",{className:"section-title",children:"People"}),E.jsx("input",{className:"input",value:i,onChange:o(u=>a(u.target.value),"onChange"),placeholder:"Search by name, role, phone, skills"}),E.jsxs("table",{className:"table",style:{marginTop:12},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{children:"Name"}),E.jsx("th",{children:"Role"}),E.jsx("th",{children:"Phone"}),E.jsx("th",{children:"Skills"}),E.jsx("th",{})]})}),E.jsxs("tbody",{children:[s.map(u=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.name,onBlur:o(d=>ot(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,name:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.role,onBlur:o(d=>ot(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,role:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.phone,onBlur:o(d=>ot(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,phone:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:u.skills,onBlur:o(d=>ot(`/api/orgs/${encodeURIComponent(r)}/people`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id,skills:d.target.value})}).then(()=>n()).catch(console.error),"onBlur")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>ot(`/api/orgs/${encodeURIComponent(r)}/people?id=${encodeURIComponent(u.id)}`,{method:"DELETE"}).then(()=>n()).catch(console.error),"onClick"),children:"Delete"})})]},u.id)),s.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:5,className:"helper",children:"No people match."})})]})]}),E.jsxs("form",{onSubmit:l,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),E.jsx("input",{className:"input",name:"role",placeholder:"Role"}),E.jsx("input",{className:"input",name:"phone",placeholder:"Phone"}),E.jsx("input",{className:"input",name:"skills",placeholder:"Skills"}),E.jsx("div",{}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Person"})]})]})})}o(lM,"People");function uM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(uM,"getOrgId$3");function dM(){const r=uM(),[e,t]=$.useState([]),[n,i]=$.useState(""),[a,s]=$.useState(!1),[l,u]=$.useState("");async function d(){if(r){s(!0);try{const m=await ot(`/api/orgs/${encodeURIComponent(r)}/inventory`);t(Array.isArray(m.inventory)?m.inventory:[])}finally{s(!1)}}}o(d,"refresh"),$.useEffect(()=>{d().catch(console.error)},[r]);const c=$.useMemo(()=>{const m=n.toLowerCase();return e.filter(w=>[w.name,w.category,w.location,w.notes,w.unit].filter(Boolean).join(" ").toLowerCase().includes(m))},[e,n]);async function h(m,w){!r||!m||(await ot(`/api/orgs/${encodeURIComponent(r)}/inventory`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m,...w})}),d().catch(console.error))}o(h,"putItem");async function v(m){!r||!m||(await ot(`/api/orgs/${encodeURIComponent(r)}/inventory?id=${encodeURIComponent(m)}`,{method:"DELETE"}),d().catch(console.error))}o(v,"delItem");async function g(m){if(m.preventDefault(),!r)return;const w=new FormData(m.currentTarget),y=String(w.get("name")||"").trim();if(!y)return;const S=String(w.get("qty")||""),T=String(w.get("unit")||""),C=String(w.get("category")||""),M=String(w.get("location")||""),_=String(w.get("notes")||""),O=String(w.get("is_public")||"")==="on",b=await ot(`/api/orgs/${encodeURIComponent(r)}/inventory`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:y,qty:S,unit:T,category:C,location:M,notes:_,is_public:O})});b!=null&&b.id&&t(j=>[{id:b.id,name:y,qty:S,unit:T,category:C,location:M,notes:_,is_public:O?1:0},...j]),m.currentTarget.reset(),setTimeout(()=>{d().catch(console.error)},500)}o(g,"onAdd");const p={width:"100%",minWidth:80,boxSizing:"border-box"};return E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Inventory"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(m=>i(m.target.value),"onChange"),placeholder:"Search inventory",style:{marginTop:12}}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:980},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"22%"},children:"Name"}),E.jsx("th",{style:{width:"10%"},children:"Qty"}),E.jsx("th",{style:{width:"10%"},children:"Unit"}),E.jsx("th",{style:{width:"14%"},children:"Category"}),E.jsx("th",{style:{width:"14%"},children:"Location"}),E.jsx("th",{style:{width:"22%"},children:"Notes"}),E.jsx("th",{style:{width:"4%"},children:"Pub"}),E.jsx("th",{style:{width:"4%"}})]})}),E.jsxs("tbody",{children:[c.map(m=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.name||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.name||"")&&h(m.id,{name:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"number",step:"any",defaultValue:m.qty===null||typeof m.qty>"u"?"":m.qty,style:p,onBlur:o(w=>{const y=w.target.value,S=y===""?null:Number(y),T=m.qty===null||typeof m.qty>"u"?null:Number(m.qty);S!==T&&h(m.id,{qty:S}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.unit||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.unit||"")&&h(m.id,{unit:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.category||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.category||"")&&h(m.id,{category:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.location||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.location||"")&&h(m.id,{location:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.notes||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.notes||"")&&h(m.id,{notes:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{style:{textAlign:"center"},children:E.jsx("input",{type:"checkbox",defaultChecked:!!m.is_public,onChange:o(w=>h(m.id,{is_public:w.target.checked}).catch(console.error),"onChange")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(m.id).catch(console.error),"onClick"),children:"Delete"})})]},m.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:8,className:"helper",children:"No inventory items match."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"name",placeholder:"Name",required:!0}),E.jsx("input",{className:"input",name:"qty",placeholder:"Qty",type:"number",step:"any"}),E.jsx("input",{className:"input",name:"unit",placeholder:"Unit"}),E.jsx("input",{className:"input",name:"category",placeholder:"Category"}),E.jsx("input",{className:"input",name:"location",placeholder:"Location"}),E.jsx("input",{className:"input",name:"notes",placeholder:"Notes"}),E.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx("input",{type:"checkbox",name:"is_public"}),"Public"]}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Item"})]})]})})}o(dM,"Inventory");function cM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(cM,"getOrgId$2");function F_(r){if(!r)return"";const e=new Date(Number(r)),t=o(n=>String(n).padStart(2,"0"),"pad");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}T${t(e.getHours())}:${t(e.getMinutes())}`}o(F_,"toInputDT");function Fu(r){if(!r)return null;const e=Date.parse(r);return Number.isFinite(e)?e:null}o(Fu,"fromInputDT");function hM(){const r=cM(),[e,t]=$.useState([]),[n,i]=$.useState(""),[a,s]=$.useState(!1),[l,u]=$.useState("");async function d(){if(r){s(!0),u("");try{const p=await ot(`/api/orgs/${encodeURIComponent(r)}/meetings`);t(Array.isArray(p.meetings)?p.meetings:[])}catch(p){console.error(p),u((p==null?void 0:p.message)||String(p))}finally{s(!1)}}}o(d,"refresh"),$.useEffect(()=>{d().catch(console.error)},[r]);const c=$.useMemo(()=>{const p=n.toLowerCase();return e.filter(m=>`${m.title||""} ${m.location||""} ${m.agenda||""}`.toLowerCase().includes(p))},[e,n]);async function h(p,m){!r||!p||(await ot(`/api/orgs/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:p,...m})}),d().catch(console.error))}o(h,"putMeeting");async function v(p){!r||!p||(await ot(`/api/orgs/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p)}`,{method:"DELETE"}),d().catch(console.error))}o(v,"delMeeting");async function g(p){if(p.preventDefault(),!r)return;const m=new FormData(p.currentTarget),w=String(m.get("title")||"").trim();if(!w)return;const y=Fu(String(m.get("starts_at")||"")),S=Fu(String(m.get("ends_at")||"")),T=String(m.get("location")||""),C=String(m.get("agenda")||""),M=await ot(`/api/orgs/${encodeURIComponent(r)}/meetings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:w,starts_at:y,ends_at:S,location:T,agenda:C})});M!=null&&M.id&&t(_=>[{id:M.id,title:w,starts_at:y,ends_at:S,location:T,agenda:C},..._]),p.currentTarget.reset(),setTimeout(()=>{d().catch(console.error)},500)}return o(g,"onAdd"),E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Meetings"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(p=>i(p.target.value),"onChange"),placeholder:"Search meetings",style:{marginTop:12}}),l&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:l}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:860},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"26%"},children:"Title"}),E.jsx("th",{style:{width:"20%"},children:"Starts"}),E.jsx("th",{style:{width:"20%"},children:"Ends"}),E.jsx("th",{style:{width:"22%"},children:"Location"}),E.jsx("th",{style:{width:"12%"}})]})}),E.jsxs("tbody",{children:[c.map(p=>E.jsxs("tr",{children:[E.jsxs("td",{children:[E.jsx("input",{className:"input",defaultValue:p.title||"",onBlur:o(m=>{const w=m.target.value||"";w!==(p.title||"")&&h(p.id,{title:w}).catch(console.error)},"onBlur")}),E.jsx("div",{className:"helper",style:{marginTop:6},children:E.jsx(Jg,{to:`/org/${encodeURIComponent(r)}/meetings/${encodeURIComponent(p.id)}`,children:"Open"})})]}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"datetime-local",defaultValue:F_(p.starts_at),onBlur:o(m=>{const w=Fu(m.target.value);(w??null)!==(p.starts_at??null)&&h(p.id,{starts_at:w}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",type:"datetime-local",defaultValue:F_(p.ends_at),onBlur:o(m=>{const w=Fu(m.target.value);(w??null)!==(p.ends_at??null)&&h(p.id,{ends_at:w}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:p.location||"",onBlur:o(m=>{const w=m.target.value||"";w!==(p.location||"")&&h(p.id,{location:w}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(p.id).catch(console.error),"onClick"),children:"Delete"})})]},p.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:5,className:"helper",children:"No meetings."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid",style:{gap:10,marginTop:12},children:[E.jsx("input",{className:"input",name:"title",placeholder:"Title",required:!0}),E.jsx("input",{className:"input",name:"starts_at",type:"datetime-local"}),E.jsx("input",{className:"input",name:"ends_at",type:"datetime-local"}),E.jsx("input",{className:"input",name:"location",placeholder:"Location"}),E.jsx("input",{className:"input",name:"agenda",placeholder:"Agenda (short)"}),E.jsx("button",{className:"btn",children:"Add Meeting"})]})]})})}o(hM,"Meetings");function fM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(fM,"getOrgId$1");function B_(r){if(!r)return"";const e=new Date(Number(r));if(Number.isNaN(e.getTime()))return"";const t=o(n=>String(n).padStart(2,"0"),"pad");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}T${t(e.getHours())}:${t(e.getMinutes())}`}o(B_,"toLocalDateTimeInput");function $_(r){if(!r)return null;const e=Date.parse(r);return Number.isFinite(e)?e:null}o($_,"fromLocalDateTimeInput");function vM(){const r=oo(),{meetingId:e}=lo(),t=fM(),[n,i]=$.useState(null),[a,s]=$.useState(""),[l,u]=$.useState(!1);async function d(){if(!t||!e)return;const v=await ot(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`);i(v.meeting||null)}o(d,"refresh"),$.useEffect(()=>{d().catch(v=>s((v==null?void 0:v.message)||String(v)))},[t,e]);async function c(v){if(!(!t||!e)){u(!0),s("");try{await ot(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)}),await d()}catch(g){s((g==null?void 0:g.message)||String(g))}finally{u(!1)}}}o(c,"save");async function h(){if(!(!t||!e)&&confirm("Delete this meeting?")){u(!0),s("");try{await ot(`/api/orgs/${encodeURIComponent(t)}/meetings/${encodeURIComponent(e)}`,{method:"DELETE"}),r(`/org/${encodeURIComponent(t)}/meetings`,{replace:!0})}catch(v){s((v==null?void 0:v.message)||String(v))}finally{u(!1)}}}return o(h,"del"),t?n?E.jsxs("div",{className:"card",style:{margin:16,padding:12},children:[E.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center"},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Meeting"}),E.jsx("button",{className:"btn",onClick:o(()=>r(-1),"onClick"),disabled:l,children:"Back"}),E.jsx("button",{className:"btn",onClick:h,disabled:l,children:"Delete"})]}),a&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:8},children:a}),E.jsxs("div",{className:"grid",style:{gap:10,marginTop:12},children:[E.jsx("input",{className:"input",defaultValue:n.title||"",placeholder:"Title",onBlur:o(v=>{const g=v.target.value||"";g!==(n.title||"")&&c({title:g}).catch(console.error)},"onBlur")}),E.jsxs("div",{className:"grid cols-2",style:{gap:10},children:[E.jsxs("div",{children:[E.jsx("div",{className:"helper",children:"Start"}),E.jsx("input",{className:"input",type:"datetime-local",defaultValue:B_(n.starts_at),onBlur:o(v=>{const g=$_(v.target.value);g!==(n.starts_at??null)&&c({starts_at:g}).catch(console.error)},"onBlur")})]}),E.jsxs("div",{children:[E.jsx("div",{className:"helper",children:"End"}),E.jsx("input",{className:"input",type:"datetime-local",defaultValue:B_(n.ends_at),onBlur:o(v=>{const g=$_(v.target.value);g!==(n.ends_at??null)&&c({ends_at:g}).catch(console.error)},"onBlur")})]})]}),E.jsx("input",{className:"input",defaultValue:n.location||"",placeholder:"Location",onBlur:o(v=>{const g=v.target.value||"";g!==(n.location||"")&&c({location:g}).catch(console.error)},"onBlur")}),E.jsx("textarea",{className:"textarea",defaultValue:n.agenda||"",placeholder:"Agenda",rows:4,onBlur:o(v=>{const g=v.target.value||"";g!==(n.agenda||"")&&c({agenda:g}).catch(console.error)},"onBlur")}),E.jsx("textarea",{className:"textarea",defaultValue:n.notes||"",placeholder:"Notes",rows:6,onBlur:o(v=>{const g=v.target.value||"";g!==(n.notes||"")&&c({notes:g}).catch(console.error)},"onBlur")})]})]}):E.jsx("div",{style:{padding:16},children:a?`Error: ${a}`:"Loading..."}):E.jsx("div",{style:{padding:16},children:"No org selected."})}o(vM,"MeetingDetail");function pM(){try{const r=(window.location.hash||"").match(/#\/org\/([^/]+)/);return r&&r[1]?decodeURIComponent(r[1]):null}catch{return null}}o(pM,"getOrgId");function mM(){const r=pM(),[e,t]=$.useState([]),[n,i]=$.useState(""),[a,s]=$.useState(!1),[l,u]=$.useState("");async function d(){if(r){s(!0),u("");try{const m=await ot(`/api/orgs/${encodeURIComponent(r)}/needs`);t(Array.isArray(m.needs)?m.needs:[])}catch(m){console.error(m),u((m==null?void 0:m.message)||String(m))}finally{s(!1)}}}o(d,"refreshNeeds"),$.useEffect(()=>{d().catch(console.error)},[r]);const c=$.useMemo(()=>{const m=n.toLowerCase();return e.filter(w=>[w.title,w.description,w.urgency,w.status].filter(Boolean).join(" ").toLowerCase().includes(m))},[e,n]);async function h(m,w){!r||!m||(await ot(`/api/orgs/${encodeURIComponent(r)}/needs`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m,...w})}),d().catch(console.error))}o(h,"putNeed");async function v(m){!r||!m||(await ot(`/api/orgs/${encodeURIComponent(r)}/needs?id=${encodeURIComponent(m)}`,{method:"DELETE"}),t(w=>w.filter(y=>y.id!==m)),d().catch(console.error))}o(v,"delNeed");async function g(m){if(m.preventDefault(),!r)return;const w=new FormData(m.currentTarget),y={title:w.get("title"),description:w.get("description")||"",urgency:w.get("urgency")||"",status:w.get("status")||"open",is_public:String(w.get("is_public")||"")==="on"},S=await ot(`/api/orgs/${encodeURIComponent(r)}/needs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});S!=null&&S.id?(t(T=>[{id:S.id,...y,created_at:Date.now(),updated_at:Date.now()},...Array.isArray(T)?T:[]]),setTimeout(()=>d().catch(console.error),600)):d().catch(console.error),m.currentTarget.reset()}o(g,"onAdd");const p={width:"100%",minWidth:80,boxSizing:"border-box"};return E.jsx("div",{children:E.jsxs("div",{className:"card",style:{margin:16},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("h2",{className:"section-title",style:{margin:0,flex:1},children:"Needs"}),E.jsx("button",{className:"btn",onClick:o(()=>d().catch(console.error),"onClick"),disabled:a,children:a?"Loading":"Refresh"})]}),E.jsx("input",{className:"input",value:n,onChange:o(m=>i(m.target.value),"onChange"),placeholder:"Search needs",style:{marginTop:12}}),l&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:l}),E.jsx("div",{style:{marginTop:12,overflowX:"auto"},children:E.jsxs("table",{className:"table",style:{width:"100%",tableLayout:"fixed",minWidth:760},children:[E.jsx("thead",{children:E.jsxs("tr",{children:[E.jsx("th",{style:{width:"20%"},children:"Title"}),E.jsx("th",{style:{width:"36%"},children:"Description"}),E.jsx("th",{style:{width:"14%"},children:"Urgency"}),E.jsx("th",{style:{width:"14%"},children:"Status"}),E.jsx("th",{style:{width:"8%"},children:"Public"}),E.jsx("th",{style:{width:"8%"}})]})}),E.jsxs("tbody",{children:[c.map(m=>E.jsxs("tr",{children:[E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.title||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.title||"")&&h(m.id,{title:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.description||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.description||"")&&h(m.id,{description:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsx("input",{className:"input",defaultValue:m.urgency||"",style:p,onBlur:o(w=>{const y=w.target.value||"";y!==(m.urgency||"")&&h(m.id,{urgency:y}).catch(console.error)},"onBlur")})}),E.jsx("td",{children:E.jsxs("select",{className:"input",defaultValue:m.status||"open",style:p,onChange:o(w=>h(m.id,{status:w.target.value}).catch(console.error),"onChange"),children:[E.jsx("option",{value:"open",children:"open"}),E.jsx("option",{value:"in-progress",children:"in-progress"}),E.jsx("option",{value:"resolved",children:"resolved"})]})}),E.jsx("td",{style:{textAlign:"center"},children:E.jsx("input",{type:"checkbox",defaultChecked:!!m.is_public,onChange:o(w=>h(m.id,{is_public:w.target.checked}).catch(console.error),"onChange")})}),E.jsx("td",{children:E.jsx("button",{className:"btn",onClick:o(()=>v(m.id).catch(console.error),"onClick"),children:"Delete"})})]},m.id)),c.length===0&&E.jsx("tr",{children:E.jsx("td",{colSpan:6,className:"helper",children:"No needs match."})})]})]})}),E.jsxs("form",{onSubmit:g,className:"grid cols-3",style:{marginTop:12},children:[E.jsx("input",{className:"input",name:"title",placeholder:"Title",required:!0}),E.jsx("input",{className:"input",name:"description",placeholder:"Description"}),E.jsx("input",{className:"input",name:"urgency",placeholder:"Urgency (e.g. high)"}),E.jsxs("select",{className:"input",name:"status",defaultValue:"open",children:[E.jsx("option",{value:"open",children:"open"}),E.jsx("option",{value:"in-progress",children:"in-progress"}),E.jsx("option",{value:"resolved",children:"resolved"})]}),E.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx("input",{type:"checkbox",name:"is_public"}),"Public"]}),E.jsx("div",{}),E.jsx("button",{className:"btn",children:"Add Need"})]})]})})}o(mM,"Needs");const gM="https://cd6d66fb-dcc4-4662-b6f5-833d2ce723d4-00-1dus12yudmpqy.riker.replit.dev/".replace(/\/+$/,"");function Bu(r,e={}){const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=r.startsWith("http")?r:`${gM}${r.startsWith("/")?"":"/"}${r}`,i={"Content-Type":"application/json",...e.headers||{}};return t&&(i.Authorization=`Bearer ${t}`),fetch(n,{...e,headers:i,body:e.body?JSON.stringify(e.body):void 0}).then(async a=>{const s=await a.json().catch(()=>({}));if(!a.ok||s.ok===!1){const l=s.error||s.message||`HTTP ${a.status}`;throw new Error(l)}return s})}o(Bu,"authFetch");const W_=o(r=>`bf_org_settings_${r}`,"orgSettingsKey"),K_=o((r,e={})=>{try{return JSON.parse(localStorage.getItem(r)||JSON.stringify(e))}catch{return e}},"readJSON$1"),yM=o((r,e)=>localStorage.setItem(r,JSON.stringify(e)),"writeJSON");function SM(){const{orgId:r}=lo(),[e,t]=$.useState([]),[n,i]=$.useState(""),[a,s]=$.useState(!1),l=$.useCallback(async()=>{if(r)try{const ae=await Bu(`/api/orgs/${encodeURIComponent(r)}/invites`,{method:"GET"});t(Array.isArray(ae.invites)?ae.invites:[]),i("")}catch(ae){i(ae.message||"Failed to load invites")}},[r]);$.useEffect(()=>{l()},[l]);const u=o(async()=>{if(r){s(!0),i("");try{const ae=await Bu(`/api/orgs/${encodeURIComponent(r)}/invites`,{method:"POST",body:{role:"member",expiresInDays:14,maxUses:1}});ae!=null&&ae.invite?(t(X=>[ae.invite,...X]),i(`Invite created: ${ae.invite.code}`)):(await l(),i("Invite created."))}catch(ae){i(ae.message||"Failed to create invite")}finally{s(!1)}}},"createInvite"),d=o(async ae=>{try{await navigator.clipboard.writeText(ae),i("Copied."),setTimeout(()=>i(""),900)}catch{i("Clipboard blocked. Copy it manually.")}},"copyInvite"),[c,h]=$.useState(""),[v,g]=$.useState(null);$.useEffect(()=>{const ae=K_(W_(r));ae.name&&h(ae.name),(ae.logoDataUrl||ae.logoUrl)&&g(ae.logoDataUrl||ae.logoUrl)},[r]);const p=o(ae=>{var ge;const X=(ge=ae.target.files)==null?void 0:ge[0];if(!X)return;const ue=new FileReader;ue.onload=()=>g(ue.result),ue.readAsDataURL(X)},"onLogo"),m=o(()=>{const ae=W_(r),X=K_(ae);yM(ae,{...X,name:(c||"").trim(),logoDataUrl:v}),window.dispatchEvent(new CustomEvent("bf:org_settings_changed",{detail:{orgId:r}})),alert("Organization settings saved.")},"saveBasics"),[w,y]=$.useState(!1),[S,T]=$.useState(""),[C,M]=$.useState(""),[_,O]=$.useState(""),[b,j]=$.useState(""),[B,q]=$.useState(""),[oe,de]=$.useState(""),Ne=o(async()=>{var ae;de("");try{const X=await Bu(`/api/orgs/${encodeURIComponent(r)}/public/generate`,{method:"POST"});T(((ae=X.public)==null?void 0:ae.slug)||""),de("Generated new link."),setTimeout(()=>de(""),1200)}catch(X){de(X.message)}},"genSlug"),Oe=o(async ae=>{var X,ue,ge,Ce,J,ee;ae==null||ae.preventDefault(),de("");try{const N={enabled:w,slug:(S||"").trim(),title:(C||"").trim(),about:(_||"").trim(),features:(b||"").split(`
`).map(A=>A.trim()).filter(Boolean),links:(B||"").split(`
`).map(A=>{const[x,P]=A.split("|").map(U=>(U||"").trim());return P?{text:x||P,url:P}:null}).filter(Boolean)},D=await Bu(`/api/orgs/${encodeURIComponent(r)}/public/save`,{method:"POST",body:N});T(((X=D.public)==null?void 0:X.slug)||N.slug),M(((ue=D.public)==null?void 0:ue.title)??N.title),O(((ge=D.public)==null?void 0:ge.about)??N.about),j(Array.isArray((Ce=D.public)==null?void 0:Ce.features)?D.public.features.join(`
`):b),q(Array.isArray((J=D.public)==null?void 0:J.links)?D.public.links.map(A=>`${A.text||A.url} | ${A.url}`).join(`
`):B),y(!!((ee=D.public)!=null&&ee.enabled)),de("Saved."),setTimeout(()=>de(""),1200)}catch(N){de(N.message)}},"savePublic"),Ae=S?`${location.origin}/#/p/${S}`:"";return E.jsxs("div",{className:"grid",style:{gap:16,padding:16},children:[E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Organization"}),E.jsxs("div",{className:"grid",style:{gap:10},children:[E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Name"}),E.jsx("input",{className:"input",value:c,onChange:o(ae=>h(ae.target.value),"onChange"),placeholder:"Your org name"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Logo"}),E.jsx("input",{className:"input",type:"file",accept:"image/*",onChange:p}),v&&E.jsx("img",{src:v,alt:"Logo preview",style:{width:96,height:96,borderRadius:12,objectFit:"cover",marginTop:8}})]}),E.jsx("div",{children:E.jsx("button",{className:"btn-red",onClick:m,children:"Save"})})]})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Invites"}),E.jsx("p",{className:"helper",children:"Generate invite codes so someone can join this org."}),E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",flexWrap:"wrap"},children:[E.jsx("button",{className:"btn-red",onClick:u,disabled:a,children:a?"Generating":"Generate invite"}),E.jsx("button",{className:"btn",type:"button",onClick:l,children:"Refresh"}),n&&E.jsx("span",{className:n.toLowerCase().includes("fail")||n.toLowerCase().includes("http")?"error":"helper",children:n})]}),E.jsx("div",{style:{marginTop:12},children:e.length===0?E.jsx("div",{className:"helper",children:"No invites yet"}):E.jsx("div",{className:"grid",style:{gap:10},children:e.map(ae=>E.jsx("div",{className:"card",style:{padding:12,border:"1px solid #222"},children:E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center"},children:[E.jsx("code",{style:{fontSize:16},children:ae.code}),E.jsx("button",{className:"btn",onClick:o(()=>d(ae.code),"onClick"),children:"Copy"}),E.jsxs("div",{className:"helper",style:{marginLeft:"auto"},children:["role: ",ae.role||"member","  uses: ",ae.uses||0,"/",ae.max_uses||1,ae.expires_at?`  expires: ${new Date(ae.expires_at).toLocaleDateString()}`:""]})]})},ae.code))})})]}),E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h2",{style:{marginTop:0},children:"Public Page"}),E.jsx("p",{className:"helper",children:"Share a readonly page for your org. Only what you enable is shown."}),E.jsxs("form",{onSubmit:Oe,className:"grid",style:{gap:10,marginTop:8},children:[E.jsxs("label",{className:"row",style:{gap:8,alignItems:"center"},children:[E.jsx("input",{type:"checkbox",checked:w,onChange:o(ae=>y(ae.target.checked),"onChange")}),E.jsx("span",{children:"Enable public page"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Share URL (slug)"}),E.jsxs("div",{className:"row",style:{gap:8},children:[E.jsx("input",{className:"input",style:{flex:1},value:S,onChange:o(ae=>T(ae.target.value),"onChange"),placeholder:"e.g. bondfire-team"}),E.jsx("button",{type:"button",className:"btn",onClick:Ne,title:"Generate a nice slug",children:"Generate"})]}),S&&E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center",marginTop:8},children:[E.jsx("span",{className:"helper",children:"Public link:"}),E.jsx("a",{className:"helper",href:`/#/p/${encodeURIComponent(S)}`,target:"_blank",rel:"noreferrer",children:Ae})]})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Title"}),E.jsx("input",{className:"input",value:C,onChange:o(ae=>M(ae.target.value),"onChange"),placeholder:"Public page title"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"About"}),E.jsx("textarea",{className:"textarea",rows:3,value:_,onChange:o(ae=>O(ae.target.value),"onChange"),placeholder:"Short description"})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Features (one per line)"}),E.jsx("textarea",{className:"textarea",rows:3,value:b,onChange:o(ae=>j(ae.target.value),"onChange"),placeholder:`Donations tracker
Volunteers
Events`})]}),E.jsxs("label",{className:"grid",style:{gap:6},children:[E.jsx("span",{className:"helper",children:"Links (Text | URL per line)"}),E.jsx("textarea",{className:"textarea",rows:3,value:B,onChange:o(ae=>q(ae.target.value),"onChange"),placeholder:`Website | https://example.org
Twitter | https://x.com/yourorg`})]}),E.jsxs("div",{className:"row",style:{gap:8,alignItems:"center"},children:[E.jsx("button",{className:"btn-red",type:"submit",children:"Save"}),oe&&E.jsx("span",{className:oe.includes("Saved")?"success":"error",children:oe})]})]}),w&&E.jsxs("div",{style:{marginTop:16},children:[E.jsx("h3",{style:{margin:"8px 0"},children:"Preview"}),E.jsx(Yd,{data:{public:{title:(C||c||"Public page").trim(),about:(_||"").trim(),features:(b||"").split(`
`).map(ae=>ae.trim()).filter(Boolean),links:(B||"").split(`
`).map(ae=>{const[X,ue]=ae.split("|").map(ge=>(ge||"").trim());return ue?{text:X||ue,url:ue}:null}).filter(Boolean)}}})]})]})]})}o(SM,"Settings");function V_(r,e,t,n,i,a,s){try{var l=r[a](s),u=l.value}catch(d){return void t(d)}l.done?e(u):Promise.resolve(u).then(n,i)}o(V_,"asyncGeneratorStep");function R(r){return function(){var e=this,t=arguments;return new Promise(function(n,i){var a=r.apply(e,t);function s(u){V_(a,n,i,s,l,"next",u)}o(s,"_next");function l(u){V_(a,n,i,s,l,"throw",u)}o(l,"_throw"),s(void 0)})}}o(R,"_asyncToGenerator");function Pl(r){"@babel/helpers - typeof";return Pl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Pl(r)}o(Pl,"_typeof$b");function EM(r,e){if(Pl(r)!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Pl(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}o(EM,"toPrimitive");function _M(r){var e=EM(r,"string");return Pl(e)=="symbol"?e:e+""}o(_M,"toPropertyKey");function f(r,e,t){return(e=_M(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(f,"_defineProperty$a");const bM="l",wM="rn",TM={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":",:":","":":","":"::=","":":","":"!",:"!","":"!","":"!!","":"!?",:"?","":"?","":"?",:"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"<","":">",:">",:">",:"4",:"b",:"b",:"d",:"J",:"L",:"P",:"U",:"V",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'",:"'",:"'",:"'",:"'","":"'",:"'","":"'","":"'",:"'",:"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''",:"''",:"''","":"'''","":"'''","":"''''",:"'B",:"'D",:"'n",:"'P",:"'T",:"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"/","":"/",:"/",:"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\",:"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<",:"<",:"<","":"<","":"<",:"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">",:">","":">",:">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2",:"2",:"2","":"2",:"2","":"2","":"","":"","":"","":"","":"","":"",:"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3",:"3",:"3","":"3","":"3",:"3",:"3","":"3","":"3","":"","":"","":"","":"",:"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4",:"4","":"4","":"","":"","":"","":"4,","":"4.",:"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5",:"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6",:"6",:"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8",:"8",:"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a",:"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a",:"a",:"a","":"a","":"a","":"a","":"a","":"a",:"a","":"",:"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A",:"A","":"A","":"A","":"A","":"A","":"A",:"A",:"A",:"A","":"A","":"A","":"A","":"a",:"",:"",:"",:"",:"","":"a/c","":"a/s","":"aa","":"AA",:"ae",:"ae",:"AE",:"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"",:"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b",:"b",:"b",:"b",:"b",:"b",:"B",:"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B",:"B","":"B","":"B","":"B","":"B","":"B",:"B",:"B",:"B","":"B","":"B","":"B","":"B",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b",:"b'",:"bl",:"","":"",:"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c",:"c","":"c",:"c","":"c","":"c","":"","":"C","":"C","":"C",:"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C",:"C",:"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C",:"c",:"c",:"C",:"C",:"C'","":"c/o","":"c/u","":"	","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d",:"d",:"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D",:"D",:"D",:"D","":"D",:"d",:"d",:"d",:"d",:"D",:"D",:"D","":"d","":"",:"d",:"d'",:"d",:"dz",:"dz",:"Dz",:"DZ",:"d",:"D",:"D",:"d","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"e",:"e",:"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e",:"e",:"e","":"","":"E",:"E",:"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E","":"E","":"E","":"E","":"E",:"E","":"E",:"E","":"E","":"E","":"E","":"E",:"",:"","":"e","":"E",:"e","":"",:"",:"","":"","":"","":"",:"","":"o","":"o","":"o",:"","":"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f",:"f","":"f",:"f","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F",:"F","":"F",:"F","":"F","":"F","":"F","":"F","":"F","":"F",:"f",:"F","":"f","":"FAX",:"ff",:"ffi",:"ffl",:"fi",:"fl",:"f",:"","":"","":"",:"",:"g",:"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g",:"g","":"g",:"g",:"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G",:"G",:"G","":"G","":"",:"g",:"",:"",:"",:"g",:"G",:"G'","":"","":"","":"",:"h",:"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h",:"h",:"h",:"h",:"H",:"H",:"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H","":"H","":"H","":"H","":"H","":"H","":"H",:"H",:"H",:"H","":"H","":"H","":"",:"h","":"h",:"h","":"H",:"H",:"h",:"h",:"h",:"H","":"H",:"H",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"i","":"i",:"i","":"i",:"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i",:"i",:"i",:"i",:"i",:"i","":"i","":"i","":"i","":"i","":"i",:"i","":"i","":"i","":"i",:"i","":"i","":"","":"i",:"",:"",:"i","":"i","":"i","":"ii","":"iii",:"ij","":"iv","":"ix",:"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j",:"j",:"j",:"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J",:"J",:"J",:"J","":"J","":"j","":"J",:"J","":"",:"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k",:"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K","":"K","":"K","":"K","":"K","":"K","":"K",:"K",:"K",:"K","":"K","":"K",:"k","":"K",:"K","":"K","":"K",:"K",:"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:bM,:"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l","":"l","":"l","":"l","":"l","":"l","":"l",:"l",:"l",:"l",:"l",:"l","":"l","":"l",:"l",:"l","":"l","":"l",:"l","":"l","":"l","":"l","":"l","":"L","":"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L",:"L",:"L","":"L","":"L","":"L","":"L","":"L","":"L",:"l",:"l",:"l",:"L",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l",:"l","":"l,","":"l.",:"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9",:"lj",:"lJ",:"Lj",:"LJ","":"ll","":"ll","":"ll",:"ll",:"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll",:"lO","":"lO.","":"lO","":"lO","":"lO",:"ls","":"lt","":"lV","":"lX",:"l",:"lz",:"l",:"l",:"l",:"l",:"l",:"l",:"lo","":"l","":"l","":"l","":"","":"","":"",:"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M",:"M",:"M",:"M",:"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n",:"n",:"n",:"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N",:"n",:"n",:"n","":"n","":"n","":"n","":"n","":"n",:"N","":"n",:"nj",:"Nj",:"NJ","":"No","":"",:"","":"",:"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o","":"o","":"o","":"o","":"o","":"o",:"o","":"o",:"o",:"o",:"o","":"o","":"o","":"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"",:"",:"","":"o",:"",:"o","":"o",:"O","":"O",:"O",:"o","":"o",:"o",:"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O",:"O","":"O",:"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O",:"O",:"O","":"O",:"O",:"O","":"o",:"o","":"O,","":"O.",:"o'",:"O'",:"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/",:"oe",:"OE",:"o","":"oo","":"oo","":"oo","":"OO","":"OO",:"o",:"o",:"o",:"o",:"o",:"o",:"o",:"o","":"oo",:"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p",:"p",:"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P","":"P","":"P","":"P","":"P","":"P","":"P",:"P",:"P",:"P","":"P","":"P",:"p","":"p",:"p",:"P'","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q",:"q",:"q",:"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q",:"q","":"QE","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r",:"r","":"r","":"R",:"R",:"R",:"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R",:"R",:"R",:"R","":"R",:"R","":"R","":"R",:"r",:"r","":"r",:"r","":"r",:"r'","":"rn",m:wM,"":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn",:"rn","":"rn","":"Rs","":"","":"",:"","":"","":"",:"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s",:"s",:"s","":"s","":"s","":"s",:"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S",:"S",:"S",:"S",:"S","":"S","":"S","":"S","":"S",:"s","":"s","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"sss",:"st","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"T",:"T","":"T","":"T","":"T","":"T","":"T","":"T",:"t","":"T","":"T",:"",:"T",:"T","":"T",:"t",:"T","":"t",:"","":"T3",:"t","":"TEL","":"tf",:"ts",:"t","":"t",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"",:"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u",:"u",:"u","":"u","":"u","":"u","":"u","":"u",:"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U",:"U",:"U","":"U",:"U","":"U","":"U","":"U",:"",:"","":"u","":"u","":"U",:"U",:"U",:"U'","":"ue","":"uo",:"",:"",:"","":"",:"",:"","":"","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v",:"v","":"v","":"v","":"v","":"v","":"v",:"v",:"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"V",:"V",:"V","":"V","":"V","":"V","":"V","":"V","":"V",:"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w",:"w","":"w",:"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W",:"W",:"W","":"W",:"w","":"w","":"W","":"w","":"",:"","":"","":"","":"x","":"x","":"x","":"x","":"x",:"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x",:"x",:"x",:"x","":"","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"X",:"X","":"X",:"X","":"X","":"X","":"X","":"X","":"X","":"x",:"X","":"X","":"xi","":"xii","":"Xl","":"Xll",:"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y","":"y","":"y",:"y","":"y","":"y","":"y","":"y","":"y","":"y",:"y",:"y",:"y","":"y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y",:"Y",:"Y",:"Y",:"Y","":"Y","":"Y","":"Y","":"Y",:"y","":"y",:"y","":"Y","":"Y",:"Y",:"","":"","":"",:"",:"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z",:"Z",:"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z","":"Z","":"Z","":"Z",:"Z","":"Z","":"Z",:"z",:"z",:"Z",:"z",:"Z","":"z",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"i","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"",:"",:"",:"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"","":"l","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"",:"",:"'",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"","":"l","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:" lo o ",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"l",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"l",:"l",:"l",:"l",:"l",:"l",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"l",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"l",:"l",:"o",:"o",:"o",:"o",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"","":"",:"",:"'","":"/","":"",:"","":"","":"",:"",:"'",:"",:"",:"'",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"<",:"b",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"b",:"b",:"d",:"P",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"J",:"",:"",:"",:"",:"",:"",:"",:"J",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"",:"","":"",:"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"",:"","":"",:"",:"",:"",:"",:"",:"","":"",:"",:"",:"",:"","":"",:"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"",:"",:"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"",:"",:"",:"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"",:"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"",:"",:"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"",:"","":"","":"",:"",:"",:"","":"","":"",:"",:"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"",:"","":"",:"","":"",:"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"",:"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"",:"",:"",:"",:"",:"","":"",:"",:"","":"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"",:"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"",:"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"",:"",:"","":"",:"","":"","":"",:"",:"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"",:"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"",:"","":"","":"","":"",:"",:"","":"","":"","":"","":""};var vR=TM;function RM(r){return r.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}o(RM,"escapeRegexp");var IM=RegExp(Object.keys(vR).map(RM).join("|"),"g");function CM(r){return vR[r]}o(CM,"replace_fn");function OM(r){return r.replace(IM,CM)}o(OM,"unhomoglyph");var kM=OM;const PM=nh(kM);var wh={exports:{}},pR={};function Fr(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}o(Fr,"RetryOperation");var MM=Fr;Fr.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Fr.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Fr.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Fr.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Fr.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Fr.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Fr.prototype.start=Fr.prototype.try;Fr.prototype.errors=function(){return this._errors};Fr.prototype.attempts=function(){return this._attempts};Fr.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],a=i.message,s=(r[a]||0)+1;r[a]=s,s>=t&&(e=i,t=s)}return e};(function(r){var e=MM;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<n.retries;s++)a.push(this.createTimeout(s,n));return t&&t.forever&&!a.length&&a.push(this.createTimeout(s,n)),a.sort(function(l,u){return l-u}),a},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,a=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return a=Math.min(a,n.maxTimeout),a},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var a in t)typeof t[a]=="function"&&i.push(a)}for(var s=0;s<i.length;s++){var l=i[s],u=t[l];t[l]=o(function(c){var h=r.operation(n),v=Array.prototype.slice.call(arguments,1),g=v.pop();v.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){c.apply(t,v)})},"retryWrapper").bind(t,u),t[l].options=n}}})(pR);var AM=pR;const xM=AM,DM=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],by=class by extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};o(by,"AbortError");let Xd=by;const NM=o((r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},"decorateErrorWithCounts"),LM=o(r=>DM.includes(r),"isNetworkError"),mR=o((r,e)=>new Promise((t,n)=>{e={onFailedAttempt:o(()=>{},"onFailedAttempt"),retries:10,...e};const i=xM.operation(e);i.attempt(async a=>{try{t(await r(a))}catch(s){if(!(s instanceof Error)){n(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));return}if(s instanceof Xd)i.stop(),n(s.originalError);else if(s instanceof TypeError&&!LM(s.message))i.stop(),n(s);else{NM(s,a,e);try{await e.onFailedAttempt(s)}catch(l){n(l);return}i.retry(s)||n(i.mainError())}}})}),"pRetry");wh.exports=mR;wh.exports.default=mR;var UM=wh.exports.AbortError=Xd,jM=wh.exports;const gR=nh(jM);var ps;let au=(ps=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}},o(ps,"NamespacedValue"),ps);const wy=class wy extends au{constructor(){super(...arguments),f(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}};o(wy,"ServerControlledNamespacedValue");let Gs=wy;var ms;let gt=(ms=class extends au{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}},o(ms,"UnstableValue"),ms);var qs=function(r){return r.Self="m.self",r.Pin="m.pin",r}({}),su=new gt("m.asset","org.matrix.msc3488.asset"),$i=new gt("m.ts","org.matrix.msc3488.ts"),ou=new gt("m.location","org.matrix.msc3488.location"),er=function(r){return r.Read="m.read",r.FullyRead="m.fully_read",r.ReadPrivate="m.read.private",r}({}),lu="main";function G_(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(G_,"ownKeys$o");function q_(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?G_(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):G_(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(q_,"_objectSpread$o");var Sf=new Map;function Ef(r){return r instanceof String&&(r=r.toString()),Sf.has(r)||Sf.set(r,r),Sf.get(r)}o(Ef,"internaliseString");function qv(r,e){var t=e??new URLSearchParams,n=o(function(l){a!=null&&(Array.isArray(a)?a.forEach(u=>{t.append(l,String(u))}):t.append(l,String(a)))},"_loop");for(var[i,a]of Object.entries(r))n(i);return t}o(qv,"encodeParams");function H_(r,e,t){var n=q_(q_({},t),{},{[e]:t[r]});return delete n[r],n}o(H_,"replaceParam");function se(r,e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n!=null&&(r=r.replace(t,encodeURIComponent(n)))}return r}o(se,"encodeUri");function Zd(r,e,t){var n;if(t){for(n=r.length-1;n>=0;n--)if(e(r[n],n,r))return r.splice(n,1),!0}else for(n=0;n<r.length;n++)if(e(r[n],n,r))return r.splice(n,1),!0;return!1}o(Zd,"removeElement");function yR(r,e){for(var t of e)if(!r.hasOwnProperty(t))throw new Error("Missing required key: "+t)}o(yR,"checkObjectHasKeys");function uu(r){return JSON.parse(JSON.stringify(r))}o(uu,"deepCopy");function Hs(r,e){if(r===e)return!0;if(typeof r!=typeof e)return!1;if(typeof r=="number"&&isNaN(r)&&isNaN(e))return!0;if(r===null||e===null)return r===e;if(!(r instanceof Object)||r.constructor!==e.constructor||r.prototype!==e.prototype)return!1;if(r instanceof RegExp||r instanceof Date)return r.toString()===e.toString();if(Array.isArray(r)){if(r.length!==e.length)return!1;for(var t=0;t<r.length;t++)if(!Hs(r[t],e[t]))return!1}else{for(var n in e)if(e.hasOwnProperty(n)!==r.hasOwnProperty(n))return!1;for(var i in r)if(e.hasOwnProperty(i)!==r.hasOwnProperty(i)||!Hs(r[i],e[i]))return!1}return!0}o(Hs,"deepCompare");function Hv(r){if(typeof r!="object"||r==null||Array.isArray(r))return r;var e=[];for(var[t,n]of Object.entries(r))e.push([t,Hv(n)]);return e.sort((i,a)=>cd(i[0],a[0])),e}o(Hv,"deepSortedObjectEntries");function z_(r){return typeof r=="number"&&isFinite(r)}o(z_,"isNumber");function ca(r){return typeof r=="string"?PM(r.normalize("NFD").replace(BM,"")):""}o(ca,"removeHiddenChars");function zv(r){return typeof r=="string"?r.replace(/[\u202d-\u202e]/g,""):""}o(zv,"removeDirectionOverrideChars");function FM(r){return ca(r.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}o(FM,"normalize");var BM=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function SR(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}o(SR,"escapeRegExp");function ER(r){return SR(r).replace(/\\\*/g,".*").replace(/\?/g,".")}o(ER,"globToRegexp");function _f(r){return r!=null&&r.endsWith("/")?r.slice(0,-1):r}o(_f,"ensureNoTrailingSlash");function du(r,e){return new Promise(t=>{setTimeout(t,r,e)})}o(du,"sleep");function MU(r,e,t){return Jv.apply(this,arguments)}o(MU,"logDuration");function Jv(){return Jv=R(function*(r,e,t){var n=Date.now();try{return yield t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}),Jv.apply(this,arguments)}o(Jv,"_logDuration");function $M(r,e,t){var n=Date.now();try{return t()}finally{var i=Date.now();r.debug("[Perf]: ".concat(e," took ").concat(i-n,"ms"))}}o($M,"logDurationSync");function _R(r){return r==null}o(_R,"isNullOrUndefined");function Xa(r,e){return Qv.apply(this,arguments)}o(Xa,"promiseMapSeries");function Qv(){return Qv=R(function*(r,e){for(var t of r)yield e(yield t)}),Qv.apply(this,arguments)}o(Qv,"_promiseMapSeries");function Ma(r){return Promise.resolve(r())}o(Ma,"promiseTry");function WM(r){return gR(e=>r(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}o(WM,"simpleRetryOperation");var Ni=(()=>{for(var r="",e=32;e<=126;e++)r+=String.fromCharCode(e);return r})();function J_(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ni;return r.padEnd(e,t[0])}o(J_,"alphabetPad");function Ml(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ni,t=BigInt(e.length);if(r<=t){var n;return(n=e[Number(r)-1])!==null&&n!==void 0?n:""}var i=r/t,a=Number(r%t)-1;return a<0&&(i-=BigInt(Math.abs(a)),a=Number(t)-1),Ml(i,e)+e[a]}o(Ml,"baseToString");function ec(r){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ni,t=BigInt(e.length),n=BigInt(0),i=r.length-1,a=BigInt(0);i>=0;i--,a++){var s=r.charCodeAt(i)-e.charCodeAt(0);n+=BigInt(1+s)*t**a}return n}o(ec,"stringToBase");function KM(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ni,n=Math.max(r.length,e.length),i=ec(J_(r,n,t),t),a=ec(J_(e,n,t),t),s=(i+a)/BigInt(2);return s===i||s==a?Ml(s,t)+t[0]:Ml(s,t)}o(KM,"averageBetweenStrings");function Io(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ni;return Ml(ec(r,e)+BigInt(1),e)}o(Io,"nextString");function Q_(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ni;return Ml(ec(r,e)-BigInt(1),e)}o(Q_,"prevString");function cd(r,e){return r<e?-1:r>e?1:0}o(cd,"lexicographicCompare");function bR(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[n,i]of Object.entries(e)){if(r[n]instanceof Object&&i){bR(r[n],i);continue}if(i!=null||!t){tc(r,n,i);continue}}return r}o(bR,"recursivelyAssign");function Y_(r){var e;return(e=$i.findIn(r.getContent()))!==null&&e!==void 0?e:-1}o(Y_,"getContentTimestampWithFallback");function VM(r,e){return Y_(e)-Y_(r)}o(VM,"sortEventsByLatestContentTimestamp");function Qg(r){return[er.Read,er.ReadPrivate].includes(r)}o(Qg,"isSupportedReceiptType");function X_(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,l)=>s===l;if(r.size!==e.size)return!1;for(var[n,i]of r){var a=e.get(n);if(a===void 0||!t(i,a))return!1}return!0}o(X_,"mapsEqual");function wR(r){return r instanceof Map?sa(r):Array.isArray(r)?r.map(e=>wR(e)):r}o(wR,"processMapToObjectValue");function sa(r){var e=new Map;for(var[t,n]of r)e.set(t,wR(n));return Object.fromEntries(e.entries())}o(sa,"recursiveMapToObject");function tl(r){return r==="__proto__"||r==="prototype"||r==="constructor"}o(tl,"unsafeProp");function tc(r,e,t){if(tl(e))throw new Error("Trying to modify prototype or constructor");r[e]=t}o(tc,"safeSet");function zr(r){return!(tl(r.room_id)||tl(r.sender)||tl(r.event_id))}o(zr,"noUnsafeEventProps");const Ty=class Ty extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}};o(Ty,"MapWithDefault");let Yr=Ty;var Yv="migrationState",zs=function(r){return r[r.NOT_STARTED=0]="NOT_STARTED",r[r.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",r[r.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",r[r.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",r[r.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",r[r.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",r}({}),Js=50;function Z_(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Z_,"ownKeys$n");function eb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Z_(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Z_(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(eb,"_objectSpread$n");function $u(r,e){return encodeURIComponent(r)+"/"+encodeURIComponent(e)}o($u,"encodeSessionKey");function GM(r){var e=r.split("/"),t=decodeURIComponent(e[0]),n=decodeURIComponent(e[1]);return{senderKey:t,sessionId:n}}o(GM,"decodeSessionKey");const Ry=class Ry{constructor(){f(this,"migrationState",zs.NOT_STARTED),f(this,"account",null),f(this,"crossSigningKeys",null),f(this,"privateKeys",{}),f(this,"sessions",{}),f(this,"inboundGroupSessions",{}),f(this,"inboundGroupSessionsWithheld",{}),f(this,"rooms",{}),f(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return R(function*(){return e.account!==null})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return R(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return R(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,n){var i=this.privateKeys[n];t(i||null)}storeSecretStorePrivateKey(e,t,n){this.privateKeys[t]=n}countEndToEndSessions(e,t){var n=0;for(var i of Object.values(this.sessions))n+=Object.keys(i).length;t(n)}getEndToEndSession(e,t,n,i){var a=this.sessions[e]||{};i(a[t]||null)}getEndToEndSessions(e,t,n){n(this.sessions[e]||{})}storeEndToEndSession(e,t,n,i){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),tc(a,t,n)}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];for(var n of Object.values(e.sessions))for(var i of Object.values(n))if(t.push(i),t.length>=Js)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t.sessions[n]||{};delete a[i],Object.keys(a).length===0&&delete t.sessions[n]}})()}getEndToEndInboundGroupSession(e,t,n,i){var a=$u(e,t);i(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,n,i){var a=$u(e,t);this.inboundGroupSessions[a]=n}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];for(var[n,i]of Object.entries(e.inboundGroupSessions))if(t.push(eb(eb({},GM(n)),{},{sessionData:i,needsBackup:n in e.sessionsNeedingBackup})),t.length>=Js)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:n,sessionId:i}of e){var a=$u(n,i);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var n=$u(t.senderKey,t.sessionId);this.sessionsNeedingBackup[n]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}};o(Ry,"MemoryCryptoStore");let Qs=Ry;var qM=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function HM(r){var e=qM.exec(r);return(e==null?void 0:e[0])===r}o(HM,"validateServerName");var zM=/^[\w-]+$/;function JM(r){var e=zM.exec(r);return(e==null?void 0:e[0])===r}o(JM,"validateMediaId");function Th(r,e,t,n,i){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,s=arguments.length>6?arguments[6]:void 0,l=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[u,d,...c]=e.slice(6).split("/");if(c.length>0||!HM(u)||!JM(d))return"";l&&(s=!0);var h,v=!!t||!!n||!!i,g=v?"thumbnail":"download";l?h="/_matrix/client/v1/media/".concat(g):h="/_matrix/media/v3/".concat(g);var p=new URL("".concat(h,"/").concat(u,"/").concat(d),r);return t&&p.searchParams.set("width",Math.round(t).toString()),n&&p.searchParams.set("height",Math.round(n).toString()),i&&p.searchParams.set("method",i),typeof s=="boolean"&&p.searchParams.set("allow_redirect",JSON.stringify(s)),p.href}o(Th,"getHttpUriForMxc");var TR={exports:{}};(function(r){(function(e,t){r.exports?r.exports=t():e.log=t()})(fC,function(){var e=o(function(){},"noop"),t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],a={},s=null;function l(m,w){var y=m[w];if(typeof y.bind=="function")return y.bind(m);try{return Function.prototype.bind.call(y,m)}catch{return function(){return Function.prototype.apply.apply(y,[m,arguments])}}}o(l,"bindMethod");function u(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}o(u,"traceForIE");function d(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&n?u:console[m]!==void 0?l(console,m):console.log!==void 0?l(console,"log"):e}o(d,"realMethod");function c(){for(var m=this.getLevel(),w=0;w<i.length;w++){var y=i[w];this[y]=w<m?e:this.methodFactory(y,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}o(c,"replaceLoggingMethods");function h(m){return function(){typeof console!==t&&(c.call(this),this[m].apply(this,arguments))}}o(h,"enableLoggingWhenConsoleArrives");function v(m,w,y){return d(m)||h.apply(this,arguments)}o(v,"defaultMethodFactory");function g(m,w){var y=this,S,T,C,M="loglevel";typeof m=="string"?M+=":"+m:typeof m=="symbol"&&(M=void 0);function _(q){var oe=(i[q]||"silent").toUpperCase();if(!(typeof window===t||!M)){try{window.localStorage[M]=oe;return}catch{}try{window.document.cookie=encodeURIComponent(M)+"="+oe+";"}catch{}}}o(_,"persistLevelIfPossible");function O(){var q;if(!(typeof window===t||!M)){try{q=window.localStorage[M]}catch{}if(typeof q===t)try{var oe=window.document.cookie,de=encodeURIComponent(M),Ne=oe.indexOf(de+"=");Ne!==-1&&(q=/^([^;]+)/.exec(oe.slice(Ne+de.length+1))[1])}catch{}return y.levels[q]===void 0&&(q=void 0),q}}o(O,"getPersistedLevel");function b(){if(!(typeof window===t||!M)){try{window.localStorage.removeItem(M)}catch{}try{window.document.cookie=encodeURIComponent(M)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}o(b,"clearPersistedLevel");function j(q){var oe=q;if(typeof oe=="string"&&y.levels[oe.toUpperCase()]!==void 0&&(oe=y.levels[oe.toUpperCase()]),typeof oe=="number"&&oe>=0&&oe<=y.levels.SILENT)return oe;throw new TypeError("log.setLevel() called with invalid level: "+q)}o(j,"normalizeLevel"),y.name=m,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=w||v,y.getLevel=function(){return C??T??S},y.setLevel=function(q,oe){return C=j(q),oe!==!1&&_(C),c.call(y)},y.setDefaultLevel=function(q){T=j(q),O()||y.setLevel(q,!1)},y.resetLevel=function(){C=null,b(),c.call(y)},y.enableAll=function(q){y.setLevel(y.levels.TRACE,q)},y.disableAll=function(q){y.setLevel(y.levels.SILENT,q)},y.rebuild=function(){if(s!==y&&(S=j(s.getLevel())),c.call(y),s===y)for(var q in a)a[q].rebuild()},S=j(s?s.getLevel():"WARN");var B=O();B!=null&&(C=j(B)),c.call(y)}o(g,"Logger"),s=new g,s.getLogger=o(function(w){if(typeof w!="symbol"&&typeof w!="string"||w==="")throw new TypeError("You must supply a name when creating a logger.");var y=a[w];return y||(y=a[w]=new g(w,s.methodFactory)),y},"getLogger");var p=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=p),s},s.getLoggers=o(function(){return a},"getLoggers"),s.default=s,s})})(TR);var QM=TR.exports;const Xv=nh(QM);var YM="matrix";Xv.methodFactory=function(r,e,t){return function(){for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];this.prefix&&i.unshift(this.prefix);var s=r==="error"||r==="warn"||r==="trace"||r==="info"||r==="debug";return s?console[r](...i):console.log(...i)}};function RR(r){var e=YM+(r===void 0?"":"-".concat(r)),t=Xv.getLogger(e);return t.getChild===void 0&&(t.prefix=r,t.getChild=n=>{var i=RR((r??"")+n);return i.methodFactory=t.methodFactory,i.rebuild(),i},t.setLevel(Xv.levels.DEBUG,!1)),t}o(RR,"getPrefixedLogger");var I=RR();const Iy=class Iy{constructor(e,t){this.parent=e,f(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parent.error(this.name,...t)}};o(Iy,"LogSpan");let tb=Iy;const Hc=class Hc{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new Hc(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];if(i.length===0)t="";else if(i[0]instanceof Error){var s=i.shift();t=s.stack||s.message}else typeof i[0]=="string"?t=i.shift():t="%O";this.debugInstance(e+" "+t,...i)}};o(Hc,"DebugLogger");let Zv=Hc;var Yg={exports:{}},os=typeof Reflect=="object"?Reflect:null,rb=os&&typeof os.apply=="function"?os.apply:o(function(e,t,n){return Function.prototype.apply.call(e,t,n)},"ReflectApply"),hd;os&&typeof os.ownKeys=="function"?hd=os.ownKeys:Object.getOwnPropertySymbols?hd=o(function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))},"ReflectOwnKeys"):hd=o(function(e){return Object.getOwnPropertyNames(e)},"ReflectOwnKeys");function XM(r){console&&console.warn&&console.warn(r)}o(XM,"ProcessEmitWarning");var IR=Number.isNaN||o(function(e){return e!==e},"NumberIsNaN");function He(){He.init.call(this)}o(He,"EventEmitter");Yg.exports=He;Yg.exports.once=rA;He.EventEmitter=He;He.prototype._events=void 0;He.prototype._eventsCount=0;He.prototype._maxListeners=void 0;var nb=10;function Rh(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}o(Rh,"checkListener");Object.defineProperty(He,"defaultMaxListeners",{enumerable:!0,get:o(function(){return nb},"get"),set:o(function(r){if(typeof r!="number"||r<0||IR(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");nb=r},"set")});He.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};He.prototype.setMaxListeners=o(function(e){if(typeof e!="number"||e<0||IR(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},"setMaxListeners");function CR(r){return r._maxListeners===void 0?He.defaultMaxListeners:r._maxListeners}o(CR,"_getMaxListeners");He.prototype.getMaxListeners=o(function(){return CR(this)},"getMaxListeners");He.prototype.emit=o(function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",a=this._events;if(a!==void 0)i=i&&a.error===void 0;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var l=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw l.context=s,l}var u=a[e];if(u===void 0)return!1;if(typeof u=="function")rb(u,this,t);else for(var d=u.length,c=AR(u,d),n=0;n<d;++n)rb(c[n],this,t);return!0},"emit");function OR(r,e,t,n){var i,a,s;if(Rh(t),a=r._events,a===void 0?(a=r._events=Object.create(null),r._eventsCount=0):(a.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),a=r._events),s=a[e]),s===void 0)s=a[e]=t,++r._eventsCount;else if(typeof s=="function"?s=a[e]=n?[t,s]:[s,t]:n?s.unshift(t):s.push(t),i=CR(r),i>0&&s.length>i&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=r,l.type=e,l.count=s.length,XM(l)}return r}o(OR,"_addListener");He.prototype.addListener=o(function(e,t){return OR(this,e,t,!1)},"addListener");He.prototype.on=He.prototype.addListener;He.prototype.prependListener=o(function(e,t){return OR(this,e,t,!0)},"prependListener");function ZM(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}o(ZM,"onceWrapper");function kR(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=ZM.bind(n);return i.listener=t,n.wrapFn=i,i}o(kR,"_onceWrap");He.prototype.once=o(function(e,t){return Rh(t),this.on(e,kR(this,e,t)),this},"once");He.prototype.prependOnceListener=o(function(e,t){return Rh(t),this.prependListener(e,kR(this,e,t)),this},"prependOnceListener");He.prototype.removeListener=o(function(e,t){var n,i,a,s,l;if(Rh(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(a=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){l=n[s].listener,a=s;break}if(a<0)return this;a===0?n.shift():eA(n,a),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,l||t)}return this},"removeListener");He.prototype.off=He.prototype.removeListener;He.prototype.removeAllListeners=o(function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var a=Object.keys(n),s;for(i=0;i<a.length;++i)s=a[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},"removeAllListeners");function PR(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?tA(i):AR(i,i.length)}o(PR,"_listeners");He.prototype.listeners=o(function(e){return PR(this,e,!0)},"listeners");He.prototype.rawListeners=o(function(e){return PR(this,e,!1)},"rawListeners");He.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):MR.call(r,e)};He.prototype.listenerCount=MR;function MR(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}o(MR,"listenerCount");He.prototype.eventNames=o(function(){return this._eventsCount>0?hd(this._events):[]},"eventNames");function AR(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}o(AR,"arrayClone");function eA(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}o(eA,"spliceOne");function tA(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}o(tA,"unwrapListeners");function rA(r,e){return new Promise(function(t,n){function i(s){r.removeListener(e,a),n(s)}o(i,"errorListener");function a(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}o(a,"resolver"),xR(r,e,a,{once:!0}),e!=="error"&&nA(r,i,{once:!0})})}o(rA,"once");function nA(r,e,t){typeof r.on=="function"&&xR(r,"error",e,t)}o(nA,"addErrorHandlerIfEventEmitter");function xR(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,o(function i(a){n.once&&r.removeEventListener(e,i),t(a)},"wrapListener"));else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}o(xR,"eventTargetAgnosticAddListener");var Ih=Yg.exports,DR=function(r){return r.NewListener="newListener",r.RemoveListener="removeListener",r.Error="error",r}({});const Cy=class Cy extends Ih.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return super.emit(e,...n)}emitPromised(e){var t=arguments,n=this;return R(function*(){for(var i=t.length,a=new Array(i>1?i-1:0),s=1;s<i;s++)a[s-1]=t[s];var l=n.listeners(e);return Promise.allSettled(l.map(u=>u(...a))).then(()=>l.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}};o(Cy,"TypedEventEmitter");let Qe=Cy;var F=function(r){return r.RoomCanonicalAlias="m.room.canonical_alias",r.RoomCreate="m.room.create",r.RoomJoinRules="m.room.join_rules",r.RoomMember="m.room.member",r.RoomThirdPartyInvite="m.room.third_party_invite",r.RoomPowerLevels="m.room.power_levels",r.RoomName="m.room.name",r.RoomTopic="m.room.topic",r.RoomAvatar="m.room.avatar",r.RoomPinnedEvents="m.room.pinned_events",r.RoomEncryption="m.room.encryption",r.RoomHistoryVisibility="m.room.history_visibility",r.RoomGuestAccess="m.room.guest_access",r.RoomServerAcl="m.room.server_acl",r.RoomTombstone="m.room.tombstone",r.RoomPredecessor="org.matrix.msc3946.room_predecessor",r.PolicyRuleUser="m.policy.rule.user",r.PolicyRuleRoom="m.policy.rule.room",r.PolicyRuleServer="m.policy.rule.server",r.SpaceChild="m.space.child",r.SpaceParent="m.space.parent",r.RoomRedaction="m.room.redaction",r.RoomMessage="m.room.message",r.RoomMessageEncrypted="m.room.encrypted",r.Sticker="m.sticker",r.CallInvite="m.call.invite",r.CallCandidates="m.call.candidates",r.CallAnswer="m.call.answer",r.CallHangup="m.call.hangup",r.CallReject="m.call.reject",r.CallSelectAnswer="m.call.select_answer",r.CallNegotiate="m.call.negotiate",r.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",r.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",r.CallReplaces="m.call.replaces",r.CallAssertedIdentity="m.call.asserted_identity",r.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",r.CallEncryptionKeysPrefix="io.element.call.encryption_keys",r.KeyVerificationRequest="m.key.verification.request",r.KeyVerificationStart="m.key.verification.start",r.KeyVerificationCancel="m.key.verification.cancel",r.KeyVerificationMac="m.key.verification.mac",r.KeyVerificationDone="m.key.verification.done",r.KeyVerificationKey="m.key.verification.key",r.KeyVerificationAccept="m.key.verification.accept",r.KeyVerificationReady="m.key.verification.ready",r.RoomMessageFeedback="m.room.message.feedback",r.Reaction="m.reaction",r.PollStart="org.matrix.msc3381.poll.start",r.Typing="m.typing",r.Receipt="m.receipt",r.Presence="m.presence",r.FullyRead="m.fully_read",r.Tag="m.tag",r.SpaceOrder="org.matrix.msc3230.space_order",r.PushRules="m.push_rules",r.Direct="m.direct",r.IgnoredUserList="m.ignored_user_list",r.RoomKey="m.room_key",r.RoomKeyRequest="m.room_key_request",r.ForwardedRoomKey="m.forwarded_room_key",r.Dummy="m.dummy",r.SecretRequest="m.secret.request",r.SecretSend="m.secret.send",r.GroupCallPrefix="org.matrix.msc3401.call",r.GroupCallMemberPrefix="org.matrix.msc3401.call.member",r.CallNotify="org.matrix.msc4075.call.notify",r.RTCNotification="org.matrix.msc4075.rtc.notification",r}({}),tt=function(r){return r.Annotation="m.annotation",r.Replace="m.replace",r.Reference="m.reference",r.Thread="m.thread",r.unstable_RTCNotificationParent="org.matrix.msc4075.rtc.notification.parent",r}({}),Rn=function(r){return r.Text="m.text",r.Emote="m.emote",r.Notice="m.notice",r.Image="m.image",r.File="m.file",r.Audio="m.audio",r.Location="m.location",r.Video="m.video",r.KeyVerificationRequest="m.key.verification.request",r}({}),rc="type",ls=function(r){return r.Space="m.space",r.UnstableCall="org.matrix.msc3417.call",r.ElementVideo="io.element.video",r}({}),Ch="org.matrix.msgid",ep=new gt("m.room.purpose","org.matrix.msc3088.purpose"),tp=new gt("m.enabled","org.matrix.msc3088.enabled"),rp=new gt("m.data_tree","org.matrix.msc3089.data_tree"),NR=new gt("m.leaf","org.matrix.msc3089.leaf"),xn=new gt("m.branch","org.matrix.msc3089.branch"),LR=new gt("m.room.marker","org.matrix.msc2716.marker"),np=new gt("with_rel_types","org.matrix.msc3912.with_relations"),UR=new gt("io.element.functional_members","io.element.functional_members"),oa=new gt("m.visibility","org.matrix.msc3531.visibility"),ip=new gt("enabled","org.matrix.msc3881.enabled"),iA=new gt("device_id","org.matrix.msc3881.device_id"),jR=new gt("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),nc=new gt("thread_id","org.matrix.msc4023.thread_id"),FR=new au("membership","io.element.msc4115.membership"),ke=function(r){return r.Ban="ban",r.Invite="invite",r.Join="join",r.Knock="knock",r.Leave="leave",r}({}),cr=function(r){return r.Membership="RoomMember.membership",r.Name="RoomMember.name",r.PowerLevel="RoomMember.powerLevel",r.Typing="RoomMember.typing",r}({});const Oy=class Oy extends Qe{constructor(e,t){super(),this.roomId=e,this.userId=t,f(this,"_isOutOfBand",!1),f(this,"modified",-1),f(this,"requestedProfileInfo",!1),f(this,"typing",!1),f(this,"name",void 0),f(this,"rawDisplayName",void 0),f(this,"powerLevel",0),f(this,"user",void 0),f(this,"membership",void 0),f(this,"disambiguate",!1),f(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var n,i,a=(n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:"";if(e.getType()===F.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&I.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=oA(this.userId,a,t);var l=this.name;this.name=lA(this.userId,a,this.disambiguate),this.rawDisplayName=zv((i=e.getDirectionalContent().displayname)!==null&&i!==void 0?i:""),(!this.rawDisplayName||!ca(this.rawDisplayName))&&(this.rawDisplayName=this.userId),s!==this.membership&&(this.updateModifiedTime(),this.emit(cr.Membership,e,this,s)),l!==this.name&&(this.updateModifiedTime(),this.emit(cr.Name,e,this,l))}}setPowerLevel(e,t){var n=this.powerLevel;this.powerLevel=e,n!==this.powerLevel&&(this.updateModifiedTime(),this.emit(cr.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;Array.isArray(n)&&(n.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(cr.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===ke.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),n=e.getSender();if(t.membership===ke.Join&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),t.membership===ke.Invite&&t.is_direct)return n}}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5?arguments[5]:void 0,l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,u=this.getMxcAvatarUrl();if(!u&&!a)return null;var d=Th(e,u,t,n,i,s,void 0,l);return d||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}};o(Oy,"RoomMember");let Ea=Oy;var aA=/@.+:.+/,sA=/[\u200E\u200F\u202A-\u202F]/;function oA(r,e,t){if(!e||e===r||!t)return!1;var n=ca(e);if(!n)return!1;if(aA.test(n)||sA.test(e))return!0;var i=t.getUserIdsWithDisplayName(e);return!!i.some(a=>a!==r)}o(oA,"shouldDisambiguate");function lA(r,e,t){return!e||e===r?r:t?zv(e)+" ("+r+")":ca(e)?zv(e):r}o(lA,"calculateDisplayName");var ar={},Oh={},cu={};Object.defineProperty(cu,"__esModule",{value:!0});cu.NamespacedMap=void 0;function uA(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=dA(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(uA,"_createForOfIteratorHelper$3");function dA(r,e){if(r){if(typeof r=="string")return ib(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return ib(r,e)}}o(dA,"_unsupportedIterableToArray$4");function ib(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(ib,"_arrayLikeToArray$4");function cA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(cA,"_classCallCheck$c");function hA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(hA,"_defineProperties$b");function fA(r,e,t){return e&&hA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(fA,"_createClass$c");function vA(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(vA,"_defineProperty$9");var pA=function(){function r(e){if(cA(this,r),vA(this,"internalMap",new Map),e){var t=uA(e),n;try{for(t.s();!(n=t.n()).done;){var i=n.value;this.set(i[0],i[1])}}catch(a){t.e(a)}finally{t.f()}}}return o(r,"NamespacedMap"),fA(r,[{key:"get",value:o(function(t){return t.name&&this.internalMap.has(t.name)?this.internalMap.get(t.name):t.altName&&this.internalMap.has(t.altName)?this.internalMap.get(t.altName):null},"get")},{key:"set",value:o(function(t,n){t.name&&this.internalMap.set(t.name,n),t.altName&&this.internalMap.set(t.altName,n)},"set")},{key:"has",value:o(function(t){return!!this.get(t)},"has")},{key:"delete",value:o(function(t){t.name&&this.internalMap.delete(t.name),t.altName&&this.internalMap.delete(t.altName)},"_delete")},{key:"hasNamespaced",value:o(function(t){return this.internalMap.has(t)},"hasNamespaced")},{key:"getNamespaced",value:o(function(t){return this.internalMap.get(t)},"getNamespaced")}]),r}();cu.NamespacedMap=pA;var Yn={};function ap(r){"@babel/helpers - typeof";return ap=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ap(r)}o(ap,"_typeof$a");Object.defineProperty(Yn,"__esModule",{value:!0});Yn.InvalidEventError=void 0;function mA(r,e,t){return Object.defineProperty(r,"prototype",{writable:!1}),r}o(mA,"_createClass$b");function gA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(gA,"_classCallCheck$b");function yA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Al(r,e)}o(yA,"_inherits$7");function SA(r){var e=BR();return o(function(){var n=xl(r),i;if(e){var a=xl(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return EA(this,i)},"_createSuperInternal")}o(SA,"_createSuper$7");function EA(r,e){if(e&&(ap(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _A(r)}o(EA,"_possibleConstructorReturn$7");function _A(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(_A,"_assertThisInitialized$7");function sp(r){var e=typeof Map=="function"?new Map:void 0;return sp=o(function(n){if(n===null||!bA(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,i)}function i(){return fd(n,arguments,xl(this).constructor)}return o(i,"Wrapper"),i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),Al(i,n)},"_wrapNativeSuper"),sp(r)}o(sp,"_wrapNativeSuper");function fd(r,e,t){return BR()?fd=Reflect.construct:fd=o(function(i,a,s){var l=[null];l.push.apply(l,a);var u=Function.bind.apply(i,l),d=new u;return s&&Al(d,s.prototype),d},"_construct"),fd.apply(null,arguments)}o(fd,"_construct");function BR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(BR,"_isNativeReflectConstruct$7");function bA(r){return Function.toString.call(r).indexOf("[native code]")!==-1}o(bA,"_isNativeFunction");function Al(r,e){return Al=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),Al(r,e)}o(Al,"_setPrototypeOf$7");function xl(r){return xl=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),xl(r)}o(xl,"_getPrototypeOf$7");var wA=function(r){yA(t,r);var e=SA(t);function t(n){return gA(this,t),e.call(this,n)}return o(t,"InvalidEventError"),mA(t)}(sp(Error));Yn.InvalidEventError=wA;var uo={},In={},Wi={};Object.defineProperty(Wi,"__esModule",{value:!0});Wi.ExtensibleEvent=void 0;function TA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(TA,"_classCallCheck$a");function RA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(RA,"_defineProperties$a");function IA(r,e,t){return e&&RA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(IA,"_createClass$a");var CA=function(){function r(e){TA(this,r),this.wireFormat=e}return o(r,"ExtensibleEvent"),IA(r,[{key:"wireContent",get:o(function(){return this.wireFormat.content},"get")}]),r}();Wi.ExtensibleEvent=CA;var hu={};Object.defineProperty(hu,"__esModule",{value:!0});hu.isOptionalAString=OA;hu.isProvided=$R;function OA(r){return $R(r)&&typeof r=="string"}o(OA,"isOptionalAString");function $R(r){return r!=null}o($R,"isProvided$1");var pt={},tn={};function op(r){"@babel/helpers - typeof";return op=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},op(r)}o(op,"_typeof$9");Object.defineProperty(tn,"__esModule",{value:!0});tn.UnstableValue=tn.NamespacedValue=void 0;function kA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&lp(r,e)}o(kA,"_inherits$6");function lp(r,e){return lp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),lp(r,e)}o(lp,"_setPrototypeOf$6");function PA(r){var e=xA();return o(function(){var n=ic(r),i;if(e){var a=ic(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return MA(this,i)},"_createSuperInternal")}o(PA,"_createSuper$6");function MA(r,e){if(e&&(op(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return AA(r)}o(MA,"_possibleConstructorReturn$6");function AA(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(AA,"_assertThisInitialized$6");function xA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(xA,"_isNativeReflectConstruct$6");function ic(r){return ic=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ic(r)}o(ic,"_getPrototypeOf$6");function WR(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(WR,"_classCallCheck$9");function DA(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(DA,"_defineProperties$9");function KR(r,e,t){return e&&DA(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(KR,"_createClass$9");var VR=function(){function r(e,t){if(WR(this,r),this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return o(r,"NamespacedValue"),KR(r,[{key:"name",get:o(function(){return this.stable?this.stable:this.unstable},"get")},{key:"altName",get:o(function(){return this.stable?this.unstable:null},"get")},{key:"matches",value:o(function(t){return!!this.name&&this.name===t||!!this.altName&&this.altName===t},"matches")},{key:"findIn",value:o(function(t){var n;return this.name&&(n=t==null?void 0:t[this.name]),!n&&this.altName&&(n=t==null?void 0:t[this.altName]),n},"findIn")},{key:"includedIn",value:o(function(t){var n=!1;return this.name&&(n=t.includes(this.name)),!n&&this.altName&&(n=t.includes(this.altName)),n},"includedIn")}]),r}();tn.NamespacedValue=VR;var NA=function(r){kA(t,r);var e=PA(t);function t(n,i){var a;if(WR(this,t),a=e.call(this,n,i),!a.unstable)throw new Error("Unstable value must be supplied");return a}return o(t,"UnstableValue"),KR(t,[{key:"name",get:o(function(){return this.unstable},"get")},{key:"altName",get:o(function(){return this.stable},"get")}]),t}(VR);tn.UnstableValue=NA;Object.defineProperty(pt,"__esModule",{value:!0});pt.M_TEXT=pt.M_NOTICE=pt.M_MESSAGE=pt.M_HTML=pt.M_EMOTE=void 0;var fu=tn,LA=new fu.UnstableValue("m.message","org.matrix.msc1767.message");pt.M_MESSAGE=LA;var UA=new fu.UnstableValue("m.text","org.matrix.msc1767.text");pt.M_TEXT=UA;var jA=new fu.UnstableValue("m.html","org.matrix.msc1767.html");pt.M_HTML=jA;var FA=new fu.UnstableValue("m.emote","org.matrix.msc1767.emote");pt.M_EMOTE=FA;var BA=new fu.UnstableValue("m.notice","org.matrix.msc1767.notice");pt.M_NOTICE=BA;var Xn={};Object.defineProperty(Xn,"__esModule",{value:!0});Xn.isEventTypeSame=$A;function $A(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||t.matches(n.altName)}o($A,"isEventTypeSame$1");function up(r){"@babel/helpers - typeof";return up=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},up(r)}o(up,"_typeof$8");Object.defineProperty(In,"__esModule",{value:!0});In.MessageEvent=void 0;var WA=Wi,Co=hu,bf=Yn,pr=pt,KA=Xn;function ab(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(ab,"ownKeys$m");function sb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ab(Object(t),!0).forEach(function(n){si(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ab(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(sb,"_objectSpread$m");function VA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(VA,"_classCallCheck$8");function ob(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(ob,"_defineProperties$8");function GA(r,e,t){return e&&ob(r.prototype,e),t&&ob(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(GA,"_createClass$8");function qA(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&dp(r,e)}o(qA,"_inherits$5");function dp(r,e){return dp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),dp(r,e)}o(dp,"_setPrototypeOf$5");function HA(r){var e=JA();return o(function(){var n=ac(r),i;if(e){var a=ac(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return zA(this,i)},"_createSuperInternal")}o(HA,"_createSuper$5");function zA(r,e){if(e&&(up(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return vd(r)}o(zA,"_possibleConstructorReturn$5");function vd(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(vd,"_assertThisInitialized$5");function JA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(JA,"_isNativeReflectConstruct$5");function ac(r){return ac=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ac(r)}o(ac,"_getPrototypeOf$5");function si(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(si,"_defineProperty$8");var QA=function(r){qA(t,r);var e=HA(t);function t(n){var i;VA(this,t),i=e.call(this,n),si(vd(i),"text",void 0),si(vd(i),"html",void 0),si(vd(i),"renderings",void 0);var a=pr.M_MESSAGE.findIn(i.wireContent),s=pr.M_TEXT.findIn(i.wireContent),l=pr.M_HTML.findIn(i.wireContent);if((0,Co.isProvided)(a)){if(!Array.isArray(a))throw new bf.InvalidEventError("m.message contents must be an array");var u=a.find(function(c){return!(0,Co.isProvided)(c.mimetype)||c.mimetype==="text/plain"}),d=a.find(function(c){return c.mimetype==="text/html"});if(!u)throw new bf.InvalidEventError("m.message is missing a plain text representation");i.text=u.body,i.html=d==null?void 0:d.body,i.renderings=a}else if((0,Co.isOptionalAString)(s))i.text=s,i.html=l,i.renderings=[{body:s,mimetype:"text/plain"}],i.html&&i.renderings.push({body:i.html,mimetype:"text/html"});else throw new bf.InvalidEventError("Missing textual representation for event");return i}return o(t,"MessageEvent"),GA(t,[{key:"isEmote",get:o(function(){return pr.M_EMOTE.matches(this.wireFormat.type)||(0,Co.isProvided)(pr.M_EMOTE.findIn(this.wireFormat.content))},"get")},{key:"isNotice",get:o(function(){return pr.M_NOTICE.matches(this.wireFormat.type)||(0,Co.isProvided)(pr.M_NOTICE.findIn(this.wireFormat.content))},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,KA.isEventTypeSame)(i,pr.M_MESSAGE)},"isEquivalentTo")},{key:"serializeMMessageOnly",value:o(function(){var i=si({},pr.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var a=this.renderings[0].mimetype;(a===void 0||a==="text/plain")&&(i=si({},pr.M_TEXT.name,this.renderings[0].body))}return i},"serializeMMessageOnly")},{key:"serialize",value:o(function(){var i;return{type:"m.room.message",content:sb(sb({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(i=this.html)!==null&&i!==void 0?i:void 0})}},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:pr.M_MESSAGE.name,content:(s={},si(s,pr.M_TEXT.name,i),si(s,pr.M_HTML.name,a),s)})},"from")}]),t}(WA.ExtensibleEvent);In.MessageEvent=QA;var co={};function cp(r){"@babel/helpers - typeof";return cp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},cp(r)}o(cp,"_typeof$7");Object.defineProperty(co,"__esModule",{value:!0});co.NoticeEvent=void 0;var YA=In,Wu=pt,XA=Xn;function lb(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(lb,"_defineProperty$7");function ZA(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(ZA,"_classCallCheck$7");function ub(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(ub,"_defineProperties$7");function ex(r,e,t){return e&&ub(r.prototype,e),t&&ub(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(ex,"_createClass$7");function rl(){return typeof Reflect<"u"&&Reflect.get?rl=Reflect.get:rl=o(function(e,t,n){var i=tx(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},"_get"),rl.apply(this,arguments)}o(rl,"_get$1");function tx(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=_a(r),r!==null););return r}o(tx,"_superPropBase$1");function rx(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&hp(r,e)}o(rx,"_inherits$4");function hp(r,e){return hp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),hp(r,e)}o(hp,"_setPrototypeOf$4");function nx(r){var e=sx();return o(function(){var n=_a(r),i;if(e){var a=_a(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return ix(this,i)},"_createSuperInternal")}o(nx,"_createSuper$4");function ix(r,e){if(e&&(cp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ax(r)}o(ix,"_possibleConstructorReturn$4");function ax(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(ax,"_assertThisInitialized$4");function sx(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(sx,"_isNativeReflectConstruct$4");function _a(r){return _a=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),_a(r)}o(_a,"_getPrototypeOf$4");var ox=function(r){rx(t,r);var e=nx(t);function t(n){return ZA(this,t),e.call(this,n)}return o(t,"NoticeEvent"),ex(t,[{key:"isNotice",get:o(function(){return!0},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,XA.isEventTypeSame)(i,Wu.M_NOTICE)||rl(_a(t.prototype),"isEquivalentTo",this).call(this,i)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i=rl(_a(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.notice",i},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:Wu.M_NOTICE.name,content:(s={},lb(s,Wu.M_TEXT.name,i),lb(s,Wu.M_HTML.name,a),s)})},"from")}]),t}(YA.MessageEvent);co.NoticeEvent=ox;var ho={};function fp(r){"@babel/helpers - typeof";return fp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fp(r)}o(fp,"_typeof$6");Object.defineProperty(ho,"__esModule",{value:!0});ho.EmoteEvent=void 0;var lx=In,Ku=pt,ux=Xn;function db(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(db,"_defineProperty$6");function dx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(dx,"_classCallCheck$6");function cb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(cb,"_defineProperties$6");function cx(r,e,t){return e&&cb(r.prototype,e),t&&cb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(cx,"_createClass$6");function nl(){return typeof Reflect<"u"&&Reflect.get?nl=Reflect.get:nl=o(function(e,t,n){var i=hx(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(arguments.length<3?e:n):a.value}},"_get"),nl.apply(this,arguments)}o(nl,"_get");function hx(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=ba(r),r!==null););return r}o(hx,"_superPropBase");function fx(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&vp(r,e)}o(fx,"_inherits$3");function vp(r,e){return vp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),vp(r,e)}o(vp,"_setPrototypeOf$3");function vx(r){var e=gx();return o(function(){var n=ba(r),i;if(e){var a=ba(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return px(this,i)},"_createSuperInternal")}o(vx,"_createSuper$3");function px(r,e){if(e&&(fp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return mx(r)}o(px,"_possibleConstructorReturn$3");function mx(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(mx,"_assertThisInitialized$3");function gx(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(gx,"_isNativeReflectConstruct$3");function ba(r){return ba=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),ba(r)}o(ba,"_getPrototypeOf$3");var yx=function(r){fx(t,r);var e=vx(t);function t(n){return dx(this,t),e.call(this,n)}return o(t,"EmoteEvent"),cx(t,[{key:"isEmote",get:o(function(){return!0},"get")},{key:"isEquivalentTo",value:o(function(i){return(0,ux.isEventTypeSame)(i,Ku.M_EMOTE)||nl(ba(t.prototype),"isEquivalentTo",this).call(this,i)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i=nl(ba(t.prototype),"serialize",this).call(this);return i.content.msgtype="m.emote",i},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:Ku.M_EMOTE.name,content:(s={},db(s,Ku.M_TEXT.name,i),db(s,Ku.M_HTML.name,a),s)})},"from")}]),t}(lx.MessageEvent);ho.EmoteEvent=yx;Object.defineProperty(uo,"__esModule",{value:!0});uo.LEGACY_M_ROOM_MESSAGE=void 0;uo.parseMRoomMessage=wx;var hb=In,Sx=co,Ex=ho,_x=tn,ri=pt;function fb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(fb,"ownKeys$l");function Or(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fb(Object(t),!0).forEach(function(n){Yi(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):fb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Or,"_objectSpread$l");function Yi(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(Yi,"_defineProperty$5");var bx=new _x.NamespacedValue("m.room.message");uo.LEGACY_M_ROOM_MESSAGE=bx;function wx(r){var e,t,n;if(ri.M_MESSAGE.findIn(r.content)||ri.M_TEXT.findIn(r.content))return new hb.MessageEvent(r);var i=(e=r.content)===null||e===void 0?void 0:e.msgtype,a=(t=r.content)===null||t===void 0?void 0:t.body,s=((n=r.content)===null||n===void 0?void 0:n.format)==="org.matrix.custom.html"?r.content.formatted_body:null;if(i==="m.text"){var l;return new hb.MessageEvent(Or(Or({},r),{},{content:Or(Or({},r.content),{},(l={},Yi(l,ri.M_TEXT.name,a),Yi(l,ri.M_HTML.name,s),l))}))}else if(i==="m.notice"){var u;return new Sx.NoticeEvent(Or(Or({},r),{},{content:Or(Or({},r.content),{},(u={},Yi(u,ri.M_TEXT.name,a),Yi(u,ri.M_HTML.name,s),u))}))}else if(i==="m.emote"){var d;return new Ex.EmoteEvent(Or(Or({},r),{},{content:Or(Or({},r.content),{},(d={},Yi(d,ri.M_TEXT.name,a),Yi(d,ri.M_HTML.name,s),d))}))}else return null}o(wx,"parseMRoomMessage");var kh={};Object.defineProperty(kh,"__esModule",{value:!0});kh.parseMMessage=Cx;var Tx=In,vb=pt,Rx=ho,Ix=co;function Cx(r){return vb.M_EMOTE.matches(r.type)?new Rx.EmoteEvent(r):vb.M_NOTICE.matches(r.type)?new Ix.NoticeEvent(r):new Tx.MessageEvent(r)}o(Cx,"parseMMessage");var jt={};Object.defineProperty(jt,"__esModule",{value:!0});jt.M_POLL_START=jt.M_POLL_RESPONSE=jt.M_POLL_KIND_UNDISCLOSED=jt.M_POLL_KIND_DISCLOSED=jt.M_POLL_END=void 0;var vu=tn,Ox=new vu.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");jt.M_POLL_KIND_DISCLOSED=Ox;var kx=new vu.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");jt.M_POLL_KIND_UNDISCLOSED=kx;var Px=new vu.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");jt.M_POLL_START=Px;var Mx=new vu.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");jt.M_POLL_RESPONSE=Mx;var Ax=new vu.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");jt.M_POLL_END=Ax;var Ph={},wa={};function pp(r){"@babel/helpers - typeof";return pp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pp(r)}o(pp,"_typeof$5");Object.defineProperty(wa,"__esModule",{value:!0});wa.PollStartEvent=wa.PollAnswerSubevent=void 0;var Cn=jt,GR=In,Wo=pt,pd=Yn,xx=tn,Dx=Xn,Nx=Wi;function Lx(r){return Bx(r)||Fx(r)||jx(r)||Ux()}o(Lx,"_toConsumableArray");function Ux(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}o(Ux,"_nonIterableSpread");function jx(r,e){if(r){if(typeof r=="string")return mp(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return mp(r,e)}}o(jx,"_unsupportedIterableToArray$3");function Fx(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}o(Fx,"_iterableToArray");function Bx(r){if(Array.isArray(r))return mp(r)}o(Bx,"_arrayWithoutHoles");function mp(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(mp,"_arrayLikeToArray$3");function pb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(pb,"ownKeys$k");function $x(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?pb(Object(t),!0).forEach(function(n){or(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):pb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o($x,"_objectSpread$k");function qR(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(qR,"_classCallCheck$5");function mb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(mb,"_defineProperties$5");function HR(r,e,t){return e&&mb(r.prototype,e),t&&mb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(HR,"_createClass$5");function zR(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&gp(r,e)}o(zR,"_inherits$2");function gp(r,e){return gp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),gp(r,e)}o(gp,"_setPrototypeOf$2");function JR(r){var e=Kx();return o(function(){var n=sc(r),i;if(e){var a=sc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Wx(this,i)},"_createSuperInternal")}o(JR,"_createSuper$2");function Wx(r,e){if(e&&(pp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ta(r)}o(Wx,"_possibleConstructorReturn$2");function ta(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(ta,"_assertThisInitialized$2");function Kx(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(Kx,"_isNativeReflectConstruct$2");function sc(r){return sc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),sc(r)}o(sc,"_getPrototypeOf$2");function or(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(or,"_defineProperty$4");var QR=function(r){zR(t,r);var e=JR(t);function t(n){var i;qR(this,t),i=e.call(this,n),or(ta(i),"id",void 0);var a=n.content.id;if(!a||typeof a!="string")throw new pd.InvalidEventError("Answer ID must be a non-empty string");return i.id=a,i}return o(t,"PollAnswerSubevent"),HR(t,[{key:"serialize",value:o(function(){return{type:"org.matrix.sdk.poll.answer",content:$x({id:this.id},this.serializeMMessageOnly())}},"serialize")}],[{key:"from",value:o(function(i,a){return new t({type:"org.matrix.sdk.poll.answer",content:or({id:i},Wo.M_TEXT.name,a)})},"from")}]),t}(GR.MessageEvent);wa.PollAnswerSubevent=QR;var Vx=function(r){zR(t,r);var e=JR(t);function t(n){var i;qR(this,t),i=e.call(this,n),or(ta(i),"question",void 0),or(ta(i),"kind",void 0),or(ta(i),"rawKind",void 0),or(ta(i),"maxSelections",void 0),or(ta(i),"answers",void 0);var a=Cn.M_POLL_START.findIn(i.wireContent);if(!a.question)throw new pd.InvalidEventError("A question is required");if(i.question=new GR.MessageEvent({type:"org.matrix.sdk.poll.question",content:a.question}),i.rawKind=a.kind,Cn.M_POLL_KIND_DISCLOSED.matches(i.rawKind)?i.kind=Cn.M_POLL_KIND_DISCLOSED:i.kind=Cn.M_POLL_KIND_UNDISCLOSED,i.maxSelections=Number.isFinite(a.max_selections)&&a.max_selections>0?a.max_selections:1,!Array.isArray(a.answers))throw new pd.InvalidEventError("Poll answers must be an array");var s=a.answers.slice(0,20).map(function(l){return new QR({type:"org.matrix.sdk.poll.answer",content:l})});if(s.length<=0)throw new pd.InvalidEventError("No answers available");return i.answers=s,i}return o(t,"PollStartEvent"),HR(t,[{key:"isEquivalentTo",value:o(function(i){return(0,Dx.isEventTypeSame)(i,Cn.M_POLL_START)},"isEquivalentTo")},{key:"serialize",value:o(function(){var i;return{type:Cn.M_POLL_START.name,content:(i={},or(i,Cn.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(a){return a.serialize().content})}),or(i,Wo.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(a,s){return"".concat(s+1,". ").concat(a.text)}).join(`
`))),i)}},"serialize")}],[{key:"from",value:o(function(i,a,s){var l,u=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new t({type:Cn.M_POLL_START.name,content:(l={},or(l,Wo.M_TEXT.name,i),or(l,Cn.M_POLL_START.name,{question:or({},Wo.M_TEXT.name,i),kind:s instanceof xx.NamespacedValue?s.name:s,max_selections:u,answers:a.map(function(d){return or({id:Gx()},Wo.M_TEXT.name,d)})}),l)})},"from")}]),t}(Nx.ExtensibleEvent);wa.PollStartEvent=Vx;var gb="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Gx(){return Lx(Array(16)).map(function(){return gb.charAt(Math.floor(Math.random()*gb.length))}).join("")}o(Gx,"makeId");var pu={},fo={};Object.defineProperty(fo,"__esModule",{value:!0});fo.REFERENCE_RELATION=void 0;var qx=tn,Hx=new qx.NamespacedValue("m.reference");fo.REFERENCE_RELATION=Hx;function yp(r){"@babel/helpers - typeof";return yp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},yp(r)}o(yp,"_typeof$4");Object.defineProperty(pu,"__esModule",{value:!0});pu.PollResponseEvent=void 0;var zx=Wi,Aa=jt,Jx=Yn,wf=fo,Qx=Xn;function Yx(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(Yx,"_classCallCheck$4");function yb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(yb,"_defineProperties$4");function Xx(r,e,t){return e&&yb(r.prototype,e),t&&yb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(Xx,"_createClass$4");function Zx(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Sp(r,e)}o(Zx,"_inherits$1");function Sp(r,e){return Sp=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),Sp(r,e)}o(Sp,"_setPrototypeOf$1");function eD(r){var e=rD();return o(function(){var n=oc(r),i;if(e){var a=oc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return tD(this,i)},"_createSuperInternal")}o(eD,"_createSuper$1");function tD(r,e){if(e&&(yp(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return md(r)}o(tD,"_possibleConstructorReturn$1");function md(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(md,"_assertThisInitialized$1");function rD(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(rD,"_isNativeReflectConstruct$1");function oc(r){return oc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),oc(r)}o(oc,"_getPrototypeOf$1");function Oo(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(Oo,"_defineProperty$3");var nD=function(r){Zx(t,r);var e=eD(t);function t(n){var i;Yx(this,t),i=e.call(this,n),Oo(md(i),"internalAnswerIds",void 0),Oo(md(i),"internalSpoiled",void 0),Oo(md(i),"pollEventId",void 0);var a=i.wireContent["m.relates_to"];if(!wf.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new Jx.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.validateAgainst(null),i}return o(t,"PollResponseEvent"),Xx(t,[{key:"answerIds",get:o(function(){return this.internalAnswerIds},"get")},{key:"spoiled",get:o(function(){return this.internalSpoiled},"get")},{key:"validateAgainst",value:o(function(i){var a=Aa.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(a==null?void 0:a.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var s=a.answers;if(s.some(function(l){return typeof l!="string"})||s.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(i){if(s.some(function(l){return!i.answers.some(function(u){return u.id===l})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}s=s.slice(0,i.maxSelections)}this.internalAnswerIds=s,this.internalSpoiled=!1},"validateAgainst")},{key:"isEquivalentTo",value:o(function(i){return(0,Qx.isEventTypeSame)(i,Aa.M_POLL_RESPONSE)},"isEquivalentTo")},{key:"serialize",value:o(function(){return{type:Aa.M_POLL_RESPONSE.name,content:Oo({"m.relates_to":{rel_type:wf.REFERENCE_RELATION.name,event_id:this.pollEventId}},Aa.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}},"serialize")}],[{key:"from",value:o(function(i,a){return new t({type:Aa.M_POLL_RESPONSE.name,content:Oo({"m.relates_to":{rel_type:wf.REFERENCE_RELATION.name,event_id:a}},Aa.M_POLL_RESPONSE.name,{answers:i})})},"from")}]),t}(zx.ExtensibleEvent);pu.PollResponseEvent=nD;var mu={};function Ep(r){"@babel/helpers - typeof";return Ep=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ep(r)}o(Ep,"_typeof$3");Object.defineProperty(mu,"__esModule",{value:!0});mu.PollEndEvent=void 0;var ko=jt,iD=Yn,Tf=fo,aD=In,sD=pt,oD=Xn,lD=Wi;function Sb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Sb,"ownKeys$j");function uD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sb(Object(t),!0).forEach(function(n){ja(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Sb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(uD,"_objectSpread$j");function dD(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(dD,"_classCallCheck$3");function Eb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(Eb,"_defineProperties$3");function cD(r,e,t){return e&&Eb(r.prototype,e),t&&Eb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(cD,"_createClass$3");function hD(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&_p(r,e)}o(hD,"_inherits");function _p(r,e){return _p=Object.setPrototypeOf||o(function(n,i){return n.__proto__=i,n},"_setPrototypeOf"),_p(r,e)}o(_p,"_setPrototypeOf");function fD(r){var e=pD();return o(function(){var n=lc(r),i;if(e){var a=lc(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return vD(this,i)},"_createSuperInternal")}o(fD,"_createSuper");function vD(r,e){if(e&&(Ep(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return bp(r)}o(vD,"_possibleConstructorReturn");function bp(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}o(bp,"_assertThisInitialized");function pD(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(pD,"_isNativeReflectConstruct");function lc(r){return lc=Object.setPrototypeOf?Object.getPrototypeOf:o(function(t){return t.__proto__||Object.getPrototypeOf(t)},"_getPrototypeOf"),lc(r)}o(lc,"_getPrototypeOf");function ja(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(ja,"_defineProperty$2");var mD=function(r){hD(t,r);var e=fD(t);function t(n){var i;dD(this,t),i=e.call(this,n),ja(bp(i),"pollEventId",void 0),ja(bp(i),"closingMessage",void 0);var a=i.wireContent["m.relates_to"];if(!Tf.REFERENCE_RELATION.matches(a==null?void 0:a.rel_type)||typeof(a==null?void 0:a.event_id)!="string")throw new iD.InvalidEventError("Relationship must be a reference to an event");return i.pollEventId=a.event_id,i.closingMessage=new aD.MessageEvent(i.wireFormat),i}return o(t,"PollEndEvent"),cD(t,[{key:"isEquivalentTo",value:o(function(i){return(0,oD.isEventTypeSame)(i,ko.M_POLL_END)},"isEquivalentTo")},{key:"serialize",value:o(function(){return{type:ko.M_POLL_END.name,content:uD(ja({"m.relates_to":{rel_type:Tf.REFERENCE_RELATION.name,event_id:this.pollEventId}},ko.M_POLL_END.name,{}),this.closingMessage.serialize().content)}},"serialize")}],[{key:"from",value:o(function(i,a){var s;return new t({type:ko.M_POLL_END.name,content:(s={"m.relates_to":{rel_type:Tf.REFERENCE_RELATION.name,event_id:i}},ja(s,ko.M_POLL_END.name,{}),ja(s,sD.M_TEXT.name,a),s)})},"from")}]),t}(lD.ExtensibleEvent);mu.PollEndEvent=mD;Object.defineProperty(Ph,"__esModule",{value:!0});Ph.parseMPoll=ED;var Rf=jt,gD=wa,yD=pu,SD=mu;function ED(r){return Rf.M_POLL_START.matches(r.type)?new gD.PollStartEvent(r):Rf.M_POLL_RESPONSE.matches(r.type)?new yD.PollResponseEvent(r):Rf.M_POLL_END.matches(r.type)?new SD.PollEndEvent(r):null}o(ED,"parseMPoll");Object.defineProperty(Oh,"__esModule",{value:!0});Oh.ExtensibleEvents=void 0;var _D=cu,bD=Yn,_b=uo,If=kh,Vu=pt,Cf=jt,Of=Ph;function wD(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=TD(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(wD,"_createForOfIteratorHelper$2");function TD(r,e){if(r){if(typeof r=="string")return bb(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return bb(r,e)}}o(TD,"_unsupportedIterableToArray$2");function bb(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(bb,"_arrayLikeToArray$2");function RD(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(RD,"_classCallCheck$2");function wb(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}o(wb,"_defineProperties$2");function ID(r,e,t){return e&&wb(r.prototype,e),t&&wb(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(ID,"_createClass$2");function wp(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(wp,"_defineProperty$1");var Tp=function(){function r(){RD(this,r),wp(this,"interpreters",new _D.NamespacedMap([[_b.LEGACY_M_ROOM_MESSAGE,_b.parseMRoomMessage],[Vu.M_MESSAGE,If.parseMMessage],[Vu.M_EMOTE,If.parseMMessage],[Vu.M_NOTICE,If.parseMMessage],[Cf.M_POLL_START,Of.parseMPoll],[Cf.M_POLL_RESPONSE,Of.parseMPoll],[Cf.M_POLL_END,Of.parseMPoll]])),wp(this,"_unknownInterpretOrder",[Vu.M_MESSAGE])}return o(r,"ExtensibleEvents"),ID(r,[{key:"unknownInterpretOrder",get:o(function(){var t;return(t=this._unknownInterpretOrder)!==null&&t!==void 0?t:[]},"get"),set:o(function(t){this._unknownInterpretOrder=t},"set")},{key:"registerInterpreter",value:o(function(t,n){this.interpreters.set(t,n)},"registerInterpreter")},{key:"parse",value:o(function(t){try{if(this.interpreters.hasNamespaced(t.type))return this.interpreters.getNamespaced(t.type)(t);var n=wD(this.unknownInterpretOrder),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;if(this.interpreters.has(a)){var s=this.interpreters.get(a)(t);if(s)return s}}}catch(l){n.e(l)}finally{n.f()}return null}catch(l){if(l instanceof bD.InvalidEventError)return null;throw l}},"parse")}],[{key:"defaultInstance",get:o(function(){return r._defaultInstance},"get")},{key:"unknownInterpretOrder",get:o(function(){return r.defaultInstance.unknownInterpretOrder},"get"),set:o(function(t){r.defaultInstance.unknownInterpretOrder=t},"set")},{key:"registerInterpreter",value:o(function(t,n){r.defaultInstance.registerInterpreter(t,n)},"registerInterpreter")},{key:"parse",value:o(function(t){return r.defaultInstance.parse(t)},"parse")}]),r}();Oh.ExtensibleEvents=Tp;wp(Tp,"_defaultInstance",new Tp);var YR={};Object.defineProperty(YR,"__esModule",{value:!0});var vo={};Object.defineProperty(vo,"__esModule",{value:!0});vo.LegacyMsgType=void 0;vo.isEventLike=CD;var kf=pt,us;vo.LegacyMsgType=us;(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(us||(vo.LegacyMsgType=us={}));function CD(r,e){var t=r.content;return e===us.Text?kf.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.text":e===us.Emote?kf.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.emote":e===us.Notice?kf.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.notice":!1}o(CD,"isEventLike");(function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=Oh;Object.keys(e).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===e[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return e[_]},"get")})});var t=YR;Object.keys(t).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===t[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return t[_]},"get")})});var n=Yn;Object.keys(n).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===n[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return n[_]},"get")})});var i=tn;Object.keys(i).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===i[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return i[_]},"get")})});var a=cu;Object.keys(a).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===a[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return a[_]},"get")})});var s=hu;Object.keys(s).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===s[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return s[_]},"get")})});var l=vo;Object.keys(l).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===l[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return l[_]},"get")})});var u=Xn;Object.keys(u).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===u[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return u[_]},"get")})});var d=uo;Object.keys(d).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===d[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return d[_]},"get")})});var c=kh;Object.keys(c).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===c[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return c[_]},"get")})});var h=Ph;Object.keys(h).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===h[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return h[_]},"get")})});var v=fo;Object.keys(v).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===v[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return v[_]},"get")})});var g=Wi;Object.keys(g).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===g[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return g[_]},"get")})});var p=pt;Object.keys(p).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===p[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return p[_]},"get")})});var m=In;Object.keys(m).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===m[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return m[_]},"get")})});var w=ho;Object.keys(w).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===w[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return w[_]},"get")})});var y=co;Object.keys(y).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===y[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return y[_]},"get")})});var S=jt;Object.keys(S).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===S[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return S[_]},"get")})});var T=wa;Object.keys(T).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===T[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return T[_]},"get")})});var C=pu;Object.keys(C).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===C[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return C[_]},"get")})});var M=mu;Object.keys(M).forEach(function(_){_==="default"||_==="__esModule"||_ in r&&r[_]===M[_]||Object.defineProperty(r,_,{enumerable:!0,get:o(function(){return M[_]},"get")})})})(ar);const OD="modulepreload",kD=o(function(r){return"/"+r},"assetsURL"),Tb={},PD=o(function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));i=Promise.allSettled(t.map(u=>{if(u=kD(u),u in Tb)return;Tb[u]=!0;const d=u.endsWith(".css"),c=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${c}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":OD,d||(h.as="script"),h.crossOrigin="",h.href=u,l&&h.setAttribute("nonce",l),document.head.appendChild(h),d)return new Promise((v,g)=>{h.addEventListener("load",v),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function a(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return o(a,"handlePreloadError"),i.then(s=>{for(const l of s||[])l.status==="rejected"&&a(l.reason);return e().catch(a)})},"preload");function MD(r,e){if(r==null)return{};var t={};for(var n in r)if({}.hasOwnProperty.call(r,n)){if(e.indexOf(n)!==-1)continue;t[n]=r[n]}return t}o(MD,"_objectWithoutPropertiesLoose");function AD(r,e){if(r==null)return{};var t,n,i=MD(r,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);for(n=0;n<a.length;n++)t=a[n],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(r,t)&&(i[t]=r[t])}return i}o(AD,"_objectWithoutProperties");var Er=function(r){return r.DisplayName="User.displayName",r.AvatarUrl="User.avatarUrl",r.Presence="User.presence",r.CurrentlyActive="User.currentlyActive",r.LastPresenceTs="User.lastPresenceTs",r}({});const zc=class zc extends Qe{constructor(e){super(),this.userId=e,f(this,"modified",-1),f(this,"displayName",void 0),f(this,"rawDisplayName",void 0),f(this,"avatarUrl",void 0),f(this,"presenceStatusMsg",void 0),f(this,"presence","offline"),f(this,"lastActiveAgo",0),f(this,"lastPresenceTs",0),f(this,"currentlyActive",!1),f(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var n=new zc(e);return t.reEmitter.reEmit(n,[Er.AvatarUrl,Er.DisplayName,Er.Presence,Er.CurrentlyActive,Er.LastPresenceTs]),n}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push(Er.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push(Er.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push(Er.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&n.push(Er.CurrentlyActive),this.presence=e.getContent().presence,n.push(Er.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var i of n)this.emit(i,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}};o(zc,"User");let Wn=zc;var Me=function(r){return r.Backward="b",r.Forward="f",r}({});const Qt=class Qt{static setEventMetadata(e,t,n){e.setMetadata(t,n)}constructor(e){var t,n;this.eventTimelineSet=e,f(this,"roomId",void 0),f(this,"name",void 0),f(this,"events",[]),f(this,"baseIndex",0),f(this,"startState",void 0),f(this,"endState",void 0),f(this,"startToken",null),f(this,"endToken",null),f(this,"prevTimeline",null),f(this,"nextTimeline",null),f(this,"paginationRequests",{[Me.Backward]:null,[Me.Forward]:null}),this.roomId=(t=(n=e.room)===null||n===void 0?void 0:n.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new Jl(this.roomId),this.endState=new Jl(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,n,{timelineWasEmpty:i}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:i}),(n=this.endState)===null||n===void 0||n.setStateEvents(e,{timelineWasEmpty:i})}forkLive(e){var t=this.getState(e),n=new Qt(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t,this.endState=t==null?void 0:t.clone(),n}fork(e){var t=this.getState(e),n=new Qt(this.eventTimelineSet);return n.startState=t==null?void 0:t.clone(),n.endState=t==null?void 0:t.clone(),n}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==Qt.BACKWARDS)return this.startState;if(e==Qt.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===Me.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===Me.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==Qt.BACKWARDS)return this.prevTimeline;if(e==Qt.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==Qt.BACKWARDS)this.prevTimeline=e;else if(t==Qt.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:n,roomState:i,timelineWasEmpty:a,addToState:s}=t;i||(i=n?this.startState:this.endState);var l=this.getTimelineSet();if(l.room&&(Qt.setEventMetadata(e,i,n),s&&e.isState()&&l.room.getUnfilteredTimelineSet()===l)){var u;(u=i)===null||u===void 0||u.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===F.RoomMember&&!n)&&Qt.setEventMetadata(e,i,n)}var d;n?d=0:d=this.events.length,this.events.splice(d,0,e),n&&this.baseIndex++}insertEvent(e,t,n,i){var a=this.getTimelineSet();a.room&&(Qt.setEventMetadata(e,n,!1),i&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(n.setStateEvents([e],{}),(!e.sender||e.getType()===F.RoomMember)&&Qt.setEventMetadata(e,n,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}toString(){return this.name}};o(Qt,"EventTimeline");let me=Qt;f(me,"BACKWARDS",Me.Backward);f(me,"FORWARDS",Me.Forward);var gd=function(r){return r.Add="Relations.add",r.Remove="Relations.remove",r.Redaction="Relations.redaction",r}({}),xD=o(function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...n].includes(e)},"matchesEventType");const ky=class ky extends Qe{constructor(e,t,n,i){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=i,f(this,"relationEventIds",new Set),f(this,"relations",new Set),f(this,"annotationsByKey",{}),f(this,"annotationsBySender",{}),f(this,"sortedAnnotationsByKey",[]),f(this,"targetEvent",null),f(this,"creationEmitted",!1),f(this,"client",void 0),f(this,"onEventStatus",(s,l)=>{if(!s.isSending()){s.removeListener(We.Status,this.onEventStatus);return}l===we.CANCELLED&&(s.removeListener(We.Status,this.onEventStatus),this.removeEvent(s))}),f(this,"onBeforeRedaction",function(){var s=R(function*(l){if(a.relations.has(l)){if(a.relations.delete(l),a.relationType===tt.Annotation)a.removeAnnotationFromAggregation(l);else if(a.relationType===tt.Replace&&a.targetEvent&&!a.targetEvent.isState()){var u=yield a.getLastReplacement();a.targetEvent.makeReplaced(u)}l.removeListener(We.BeforeRedaction,a.onBeforeRedaction),a.emit(gd.Redaction,l)}});return function(l){return s.apply(this,arguments)}}()),this.client=n instanceof Ys?n.client:n}addEvent(e){var t=this;return R(function*(){if(!t.relationEventIds.has(e.getId())){var n=e.getRelation();if(!n){I.error("Event must have relation info");return}var i=n.rel_type,a=e.getType();if(t.relationType!==i||!xD(a,t.eventType,t.altEventTypes)){I.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(We.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===tt.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===tt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var s=yield t.getLastReplacement();t.targetEvent.makeReplaced(s)}e.on(We.BeforeRedaction,t.onBeforeRedaction),t.emit(gd.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return R(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===tt.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===tt.Replace&&t.targetEvent&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();t.targetEvent.makeReplaced(n)}t.emit(gd.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i||(i=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,i])),i.add(e),this.sortedAnnotationsByKey.sort((l,u)=>{var d=l[1],c=u[1];return c.size-d.size});var a=e.getSender(),s=this.annotationsBySender[a];s||(s=this.annotationsBySender[a]=new Set),s.add(e)}}removeAnnotationFromAggregation(e){var t,{key:n}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(n){var i=this.annotationsByKey[n];i&&(i.delete(e),this.sortedAnnotationsByKey.sort((l,u)=>{var d=l[1],c=u[1];return c.size-d.size}));var a=e.getSender(),s=this.annotationsBySender[a];s&&s.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==tt.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==tt.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return R(function*(){if(e.relationType!==tt.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(tt.Replace),n=t==null?void 0:t.origin_server_ts,i=e.getRelations().reduce((a,s)=>s.getSender()!==e.targetEvent.getSender()||n&&n>s.getTs()||a&&a.getTs()>s.getTs()?a:s,null);return i!=null&&i.shouldAttemptDecryption()&&e.client.getCrypto()?yield i.attemptDecryption(e.client.getCrypto()):i!=null&&i.isBeingDecrypted()&&(yield i.getDecryptionPromise()),i})()}setTargetEvent(e){var t=this;return R(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===tt.Replace&&!t.targetEvent.isState()){var n=yield t.getLastReplacement();n&&t.targetEvent.makeReplaced(n)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(We.RelationsCreated,this.relationType,this.eventType))}};o(ky,"Relations");let Dl=ky;const Py=class Py{constructor(e,t){this.client=e,this.room=t,f(this,"relations",new Map)}getChildEventsForEvent(e,t,n){var i;return(i=this.relations.get(e))===null||i===void 0||(i=i.get(t))===null||i===void 0?void 0:i.get(n)}getAllChildEventsForEvent(e){var t,n=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,i=[];for(var a of n.values())for(var s of a.values())i.push(...s.getRelations());return i}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var n of t.values())for(var i of n.values())i.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===we.CANCELLED)){var n=e.getRelation();if(n){var i=o(()=>{if(e.isDecryptionFailure()){e.once(We.Decrypted,i);return}this.aggregateChildEvent(e,t)},"onEventDecrypted");if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(We.Decrypted,i);return}var{event_id:a,rel_type:s}=n,l=e.getType(),u=this.relations.get(a);u||(u=new Map,this.relations.set(a,u));var d=u.get(s);d||(d=new Map,u.set(s,d));var c=d.get(l);if(!c){var h,v,g;c=new Dl(s,l,this.client),d.set(l,c);var p=(h=this.room)!==null&&h!==void 0?h:t==null?void 0:t.room,m=(v=(g=t==null?void 0:t.findEventById(a))!==null&&g!==void 0?g:p==null?void 0:p.findEventById(a))!==null&&v!==void 0?v:p==null?void 0:p.getPendingEvent(a);m&&c.setTargetEvent(m)}c.addEvent(e)}}}};o(Py,"RelationsContainer");let uc=Py;var Fa;Fa=I.log.bind(I);var il=function(r){return r.Ignore="ignore",r.Replace="replace",r}({});const My=class My extends Qe{constructor(e){var t,n,i,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,l=arguments.length>3?arguments[3]:void 0,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=l,this.threadListType=u,f(this,"relations",void 0),f(this,"timelineSupport",void 0),f(this,"displayPendingEvents",void 0),f(this,"liveTimeline",void 0),f(this,"timelines",void 0),f(this,"_eventIdToTimeline",new Map),f(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new me(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(n=this.room)===null||n===void 0?void 0:n.relations)!==null&&t!==void 0?t:new uc((i=e==null?void 0:e.client)!==null&&i!==void 0?i:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){var n=!this.timelineSupport||!t,i=this.liveTimeline,a=n?i.forkLive(me.FORWARDS):i.fork(me.FORWARDS);n?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&i.setPaginationToken(t,me.FORWARDS),a.setPaginationToken(e??null,me.BACKWARDS),this.liveTimeline=a,this.emit(fe.TimelineReset,this.room,this,n)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(n){return n.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new me(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,i,a){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?me.BACKWARDS:me.FORWARDS,l=t?me.FORWARDS:me.BACKWARDS,u=!1,d=!1;for(var c of e){var h=c.getId(),v=this._eventIdToTimeline.get(h);if(!v){this.addEventToTimeline(c,i,{toStartOfTimeline:t,addToState:n}),d=!0,u=!0;continue}if(d=!1,v==i){Fa("Event "+h+" already in timeline "+i);continue}var g=i.getNeighbouringTimeline(s);if(g){v==g?Fa("Event "+h+" in neighbouring timeline - switching to "+v):Fa("Event "+h+" already in a different timeline "+v),i=v;continue}I.info("Already have timeline for "+h+" - joining timeline "+i+" to "+v);var p=v===this.liveTimeline,m=i===this.liveTimeline,w=s===me.BACKWARDS&&p,y=s===me.FORWARDS&&m;if(w||y){w&&I.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+v+")"),y&&I.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(v,s),v.setNeighbouringTimeline(i,l),i=v,u=!0}if(d||!u){if(s===me.FORWARDS&&i===this.liveTimeline){I.warn({lastEventWasNew:d,didUpdate:u}),I.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(a));return}i.setPaginationToken(a??null,s)}}}addLiveEvent(e,t){var{duplicateStrategy:n,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l}=t;if(this.filter){var u=this.filter.filterRoomTimeline([e]);if(!u.length)return}var d=this._eventIdToTimeline.get(e.getId());if(d){if(n===il.Replace){Fa("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var c=d.getEvents(),h=0;h<c.length;h++)if(c[h].getId()===e.getId()){a||(a=d.getState(me.FORWARDS)),me.setEventMetadata(e,a,!1),c[h]=e;break}}else Fa("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l})}addEventToTimeline(e,t,n){var{toStartOfTimeline:i,fromCache:a=!1,roomState:s,timelineWasEmpty:l,addToState:u}=n;if(t.getTimelineSet()!==this){var d;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((d=this.thread)===null||d===void 0?void 0:d.id,")"))}var c=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,v="event=".concat(c);e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),I.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((h=this.thread)===null||h===void 0?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:i,roomState:s,timelineWasEmpty:l,addToState:u}),this._eventIdToTimeline.set(c,t);var g={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!a};this.emit(fe.Timeline,e,this.room,!!i,!1,g)}insertEventIntoTimeline(e,t,n,i){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var l,u="event=".concat(s);e.threadRootId&&(u+="(belongs to thread=".concat(e.threadRootId,")")),I.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(u," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((l=this.thread)===null||l===void 0?void 0:l.id,")"));return}var d=e.relationEventId;if(!d){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:n,addToState:i});return}for(var c=this.findEventById(d),h=t.getEvents(),v=c!==void 0?h.indexOf(c):0,g=v;g<h.length;g++){var p=h[g];if(p.getTs()>e.getTs())break}t.insertEvent(e,g,n,i),this._eventIdToTimeline.set(s,t);var m={timeline:t,liveEvent:!1};this.emit(fe.Timeline,e,this.room,!1,!1,m)}handleRemoteEcho(e,t,n){var i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,i)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);var i={timeline:t};this.emit(fe.Timeline,n,this.room,void 0,!0,i)}return n}compareEventOrdering(e,t){if(e==t)return 0;var n=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(n===void 0||i===void 0)return null;if(n===i){for(var a=void 0,s=void 0,l=n.getEvents(),u=0;u<l.length&&(a===void 0||s===void 0);u++){var d=l[u].getId();d==e&&(a=u),d==t&&(s=u)}var c=a-s;return c<0?-1:c>0?1:0}for(var h=n;h;){if(h===i)return-1;h=h.getNeighbouringTimeline(me.FORWARDS)}for(h=n;h;){if(h===i)return 1;h=h.getNeighbouringTimeline(me.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!n&&!i){var a;I.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return n}};o(My,"EventTimelineSet");let Si=My;var we=function(r){return r.NOT_SENT="not_sent",r.ENCRYPTING="encrypting",r.SENDING="sending",r.QUEUED="queued",r.SENT="sent",r.CANCELLED="cancelled",r}({});const Ay=class Ay{constructor(e,t){this.roomId=e}};o(Ay,"RoomSummary");let dc=Ay;const xy=class xy{constructor(e){this.target=e,f(this,"reEmitters",new WeakMap)}reEmit(e,t){var n=this,i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));var a=o(function(u){if(i.has(u))return 1;var d=o(function(){if(!(u==="error"&&n.target.listenerCount("error")===0)){for(var h=arguments.length,v=new Array(h),g=0;g<h;g++)v[g]=arguments[g];n.target.emit(u,...v,e)}},"forSource");e.on(u,d),i.set(u,d)},"_loop");for(var s of t)a(s)}stopReEmitting(e,t){var n=this.reEmitters.get(e);if(n){for(var i of t)e.off(i,n.get(i)),n.delete(i);n.size===0&&this.reEmitters.delete(e)}}};o(xy,"ReEmitter");let cc=xy;const Dy=class Dy extends cc{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}};o(Dy,"TypedReEmitter");let Li=Dy;var Nl=new Gs("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function DD(r,e){if(e.endsWith("*")){var t=e.slice(0,-1);return r.slice(0,t.length)===t}else return r===e}o(DD,"matchesWildcard");const Ny=class Ny{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,n,i=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(i),s=[];return this.userId&&i!==null&&i!==void 0&&(n=i[qe.name])!==null&&n!==void 0&&n.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,s)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[fs.name]:this.filterJson[fs.name],[vs.name]:this.filterJson[vs.name]}).filter(e=>{var[t,n]=e;return n}))}checkFields(e,t,n,i,a,s){var l={rooms:o(function(y){return e===y},"rooms"),senders:o(function(y){return t===y},"senders"),types:o(function(y){return DD(n,y)},"types")};for(var u in l){var d=l[u],c="not_"+u,h=this.filterJson[c];if(h!=null&&h.some(d))return!1;var v=this.filterJson[u];if(v&&!v.some(d))return!1}var g=this.filterJson.contains_url;if(g!==void 0&&g!==i)return!1;var p=this.filterJson[vs.name];if(p!==void 0&&!this.arrayMatchesFilter(p,a))return!1;var m=this.filterJson[fs.name];return!(m!==void 0&&!this.arrayMatchesFilter(m,s))}arrayMatchesFilter(e,t){return t.length>0&&e.every(n=>t.includes(n))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}};o(Ny,"FilterComponent");let hc=Ny;function Rb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Rb,"ownKeys$i");function xa(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Rb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Rb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(xa,"_objectSpread$i");function Pf(r,e,t){for(var n=e.split("."),i=r,a=0;a<n.length-1;a++)i[n[a]]||(i[n[a]]={}),i=i[n[a]];i[n[n.length-1]]=t}o(Pf,"setProp");const Jc=class Jc{static fromJson(e,t,n){var i=new Jc(e,t);return i.setDefinition(n),i}constructor(e,t){this.userId=e,this.filterId=t,f(this,"definition",{}),f(this,"roomFilter",void 0),f(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms)),this.roomFilter=new hc(n,this.userId),this.roomTimelineFilter=new hc((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){Pf(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,n;this.definition=xa(xa({},this.definition),{},{room:xa(xa({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:xa(xa({},(n=this.definition)===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.timeline),{},{[Nl.name]:e})})})}setLazyLoadMembers(e){Pf(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){Pf(this.definition,"room.include_leave",e)}};o(Jc,"Filter");let lr=Jc;f(lr,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function fc(r){return r!=null}o(fc,"isProvided");var ND=new ar.UnstableValue("m.message","org.matrix.msc1767.message"),Xg=new ar.UnstableValue("m.text","org.matrix.msc1767.text"),LD=new ar.UnstableValue("m.html","org.matrix.msc1767.html"),XR=new ar.NamespacedValue("m.reference");function UD(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,n=r;return t.matches(n.name)||fc(n.altName)&&t.matches(n.altName)}o(UD,"isEventTypeSame");var Zg=new au("m.topic");function Ib(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Ib,"ownKeys$h");function jD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ib(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ib(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(jD,"_objectSpread$h");function ZR(r,e){return{msgtype:Rn.Text,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(ZR,"makeHtmlMessage");function eI(r,e){return{msgtype:Rn.Notice,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(eI,"makeHtmlNotice");function tI(r,e){return{msgtype:Rn.Emote,format:"org.matrix.custom.html",body:r,formatted_body:e}}o(tI,"makeHtmlEmote");function rI(r){return{msgtype:Rn.Text,body:r}}o(rI,"makeTextMessage");function nI(r){return{msgtype:Rn.Notice,body:r}}o(nI,"makeNotice");function iI(r){return{msgtype:Rn.Emote,body:r}}o(iI,"makeEmoteMessage");var aI=o((r,e,t,n)=>{var i="at ".concat(new Date(t).toISOString()),a=e===qs.Self?"User":void 0,s=n?'"'.concat(n,'"'):void 0;return[a,"Location",s,r,i].filter(Boolean).join(" ")},"getTextForLocationEvent"),sI=o((r,e,t,n,i)=>{var a=r??aI(e,i||qs.Self,t,n),s=t?{[$i.name]:t}:{};return jD({msgtype:Rn.Location,body:a,geo_uri:e,[ou.name]:{description:n,uri:e},[su.name]:{type:i||qs.Self},[Xg.name]:a},s)},"makeLocationContent"),FD=o(r=>{var e,t,n=ou.findIn(r),i=su.findIn(r),a=$i.findIn(r),s=Xg.findIn(r),l=(e=n==null?void 0:n.uri)!==null&&e!==void 0?e:r==null?void 0:r.geo_uri,u=n==null?void 0:n.description,d=(t=i==null?void 0:i.type)!==null&&t!==void 0?t:qs.Self,c=s??r.body;return sI(c,l,a??void 0,u,d)},"parseLocationEvent"),oI=o((r,e)=>{var t=[];return fc(e)&&t.push({body:e,mimetype:"text/html"}),fc(r)&&t.push({body:r,mimetype:"text/plain"}),{topic:r,[Zg.name]:t}},"makeTopicContent"),BD=o(r=>{var e,t,n,i,a=Zg.findIn(r);if(!Array.isArray(a)){var s;return{text:(s=r.topic)!==null&&s!==void 0?s:void 0}}var l=(e=(t=a==null||(n=a.find(d=>!fc(d.mimetype)||d.mimetype==="text/plain"))===null||n===void 0?void 0:n.body)!==null&&t!==void 0?t:r.topic)!==null&&e!==void 0?e:void 0,u=a==null||(i=a.find(d=>d.mimetype==="text/html"))===null||i===void 0?void 0:i.body;return{text:l,html:u}},"parseTopicContent"),$D=o((r,e,t,n,i)=>({description:t,timeout:r,live:e,[$i.name]:i||Date.now(),[su.name]:{type:n??qs.Self}}),"makeBeaconInfoContent"),lI=o(r=>{var e,{description:t,timeout:n,live:i}=r,a=(e=$i.findIn(r))!==null&&e!==void 0?e:void 0,s=su.findIn(r);return{description:t,timeout:n,live:i,assetType:s==null?void 0:s.type,timestamp:a}},"parseBeaconInfoContent"),WD=o((r,e,t,n)=>({[ou.name]:{description:n,uri:r},[$i.name]:e,"m.relates_to":{rel_type:XR.name,event_id:t}}),"makeBeaconContent"),Rp=o(r=>{var e,t=ou.findIn(r),n=(e=$i.findIn(r))!==null&&e!==void 0?e:void 0;return{description:t==null?void 0:t.description,uri:t==null?void 0:t.uri,timestamp:n}},"parseBeaconContent");const KD=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:aI,makeBeaconContent:WD,makeBeaconInfoContent:$D,makeEmoteMessage:iI,makeHtmlEmote:tI,makeHtmlMessage:ZR,makeHtmlNotice:eI,makeLocationContent:sI,makeNotice:nI,makeTextMessage:rI,makeTopicContent:oI,parseBeaconContent:Rp,parseBeaconInfoContent:lI,parseLocationEvent:FD,parseTopicContent:BD},Symbol.toStringTag,{value:"Module"}));var Ze=function(r){return r.New="Beacon.new",r.Update="Beacon.update",r.LivenessChange="Beacon.LivenessChange",r.Destroy="Beacon.Destroy",r.LocationUpdate="Beacon.LocationUpdate",r}({}),Ip=o((r,e,t)=>t>=r&&r+e>=t,"isTimestampInDuration"),vc=o(r=>"".concat(r.getRoomId(),"_").concat(r.getStateKey()),"getBeaconInfoIdentifier");const Ly=class Ly extends Qe{constructor(e){super(),this.rootEvent=e,f(this,"roomId",void 0),f(this,"_beaconInfo",void 0),f(this,"_isLive",void 0),f(this,"livenessWatchTimeout",void 0),f(this,"_latestLocationEvent",void 0),f(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(Ze.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return vc(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Rp(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(vc(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(Ze.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(Ze.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var n=e.filter(a=>{var s=a.getContent(),l=Rp(s);if(!l.uri||!l.timestamp)return!1;var{timestamp:u}=l;return this._beaconInfo.timestamp&&Ip(this._beaconInfo.timestamp,this._beaconInfo.timeout,u)&&(!this.latestLocationState||u>this.latestLocationState.timestamp)}),i=(t=n.sort(VM))===null||t===void 0?void 0:t[0];i&&(this._latestLocationEvent=i,this.emit(Ze.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=lI(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&Ip(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(Ze.LivenessChange,this.isLive,this)}}};o(Ly,"Beacon");let pc=Ly;function Cb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Cb,"ownKeys$g");function VD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Cb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Cb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(VD,"_objectSpread$g");function uI(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new Ht({content:{[e.getId()]:{[t]:{[r]:VD({ts:e.getTs()},!n&&{thread_id:ro(e)})}}},type:F.Receipt,room_id:e.getRoomId()})}o(uI,"synthesizeReceipt");var Da=0,Na=1;const Uy=class Uy extends Qe{constructor(){super(...arguments),f(this,"receipts",new Yr(()=>new Map)),f(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:er.Read,[s,l]=(t=(n=this.receipts.get(a))===null||n===void 0?void 0:n.get(e))!==null&&t!==void 0?t:[null,null];return i?s:l??s}compareReceipts(e,t){var n;return(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&n!==void 0?n:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t,n=this.findEventById(e.eventId);if(!n)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===lu){var i=zl(n);if(i)return!0}else if(n.threadRootId===e.data.thread_id)return!0;return I.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(n.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var n,i,a=this.getReadReceiptForUserId(e,t,er.Read),s=this.getReadReceiptForUserId(e,t,er.ReadPrivate),l;return a!=null&&a.eventId&&s!==null&&s!==void 0&&s.eventId&&(l=this.compareReceipts(a,s)),l?(i=l<0?s:a)!==null&&i!==void 0?i:null:(n=s??a)!==null&&n!==void 0?n:null}addReceiptToStructure(e,t,n,i,a){var s,l,u=this.receipts.getOrCreate(t),d=u.get(n);d||(d=[null,null],u.set(n,d));var c=d[Da];if(a){var h;c=(h=d[Na])!==null&&h!==void 0?h:d[Da]}var v={eventId:e,data:i};if(c){var g=this.compareReceipts(c,v);if(g>=0)return}var p=a?d[Da]:v,m=a?v:d[Na],w=null;p&&m&&(w=this.getUnfilteredTimelineSet().compareEventOrdering(p.eventId,m.eventId));var y=w===null||w<0,S=(s=d[Na])!==null&&s!==void 0?s:d[Da];a&&y?d[Na]=v:a||(d[Da]=v,y||(d[Na]=null));var T=(l=d[Na])!==null&&l!==void 0?l:d[Da];if(S!==T){if(S&&this.receiptCacheByEventId.get(S.eventId)){var C=S.eventId;this.receiptCacheByEventId.set(C,this.receiptCacheByEventId.get(C).filter(M=>M.type!==t||M.userId!==n)),this.receiptCacheByEventId.get(C).length<1&&this.receiptCacheByEventId.delete(C)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&(t==null?void 0:t.eventId)===n.getId()&&e===n.getSender()&&(this.setUnread(Be.Total,0),this.setUnread(Be.Highlight,0))}addLocalEchoReceipt(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(uI(e,t,n,i),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return Qg(t.type)}).map(function(t){return t.userId})}};o(Uy,"ReadReceipt");let mc=Uy;var GD=new ar.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),qD=new ar.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),HD=new ar.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),Ll=new ar.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),gc=new ar.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),ci=function(r){return r.New="Poll.new",r.End="Poll.end",r.Update="Poll.update",r.Responses="Poll.Responses",r.Destroy="Poll.Destroy",r.UndecryptableRelations="Poll.UndecryptableRelations",r}({}),Ob=o((r,e)=>{var t=r.filter(n=>{if(!n.isDecryptionFailure())return Ll.matches(n.getType())&&n.getTs()<=e});return{responseEvents:t}},"filterResponseRelations");const jy=class jy extends Qe{constructor(e,t,n){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=n,f(this,"roomId",void 0),f(this,"pollEvent",void 0),f(this,"_isFetchingResponses",!1),f(this,"relationsNextBatch",void 0),f(this,"responses",null),f(this,"endEvent",void 0),f(this,"undecryptableRelationEventIds",new Set),f(this,"countUndecryptableEvents",i=>{var a=i.filter(l=>l.isDecryptionFailure()).map(l=>l.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==s&&this.emit(ci.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return R(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(gc.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(ci.End)),!!this.responses){var n=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=Ob([e],n);this.countUndecryptableEvents([e]),i.length&&(i.forEach(a=>{this.responses.addEvent(a)}),this.emit(ci.Responses,this.responses))}}fetchResponses(){var e=this;return R(function*(){var t,n;e._isFetchingResponses=!0;var i=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(i.events.map(d=>e.matrixClient.decryptEventIfNeeded(d)));var a=e.responses||new Dl("m.reference",Ll.name,e.matrixClient,[Ll.altName]),s=i.events.find(d=>gc.matches(d.getType()));e.validateEndEvent(s)&&(e.endEvent=s,e.refilterResponsesOnEnd(),e.emit(ci.End));var l=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:u}=Ob(i.events,l);u.forEach(d=>{a.addEvent(d)}),e.relationsNextBatch=(n=i.nextBatch)!==null&&n!==void 0?n:void 0,e.responses=a,e.countUndecryptableEvents(i.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(ci.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(n=>{if(n.getTs()>t){var i;(i=this.responses)===null||i===void 0||i.removeEvent(n)}}),this.emit(ci.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,n=e.getSender();return!!n&&(n===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,n))}};o(jy,"Poll");let yc=jy;var dI=o(r=>{var e=r.getType();return ar.M_POLL_START.matches(e)||Ll.matches(e)||gc.matches(e)},"isPollEvent");const Fy=class Fy{constructor(e){f(this,"room",void 0),f(this,"threadedReceipts",void 0),f(this,"unthreadedReceipts",void 0),f(this,"danglingReceipts",void 0),f(this,"onTimelineEvent",t=>{var n=t.getId();if(n){var i=this.danglingReceipts.remove(n);i==null||i.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(n,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new Mp(e),this.unthreadedReceipts=new Sc(e),this.danglingReceipts=new Ap,e.on(fe.Timeline,this.onTimelineEvent)}add(e,t){for(var[n,i]of Object.entries(e))for(var[a,s]of Object.entries(i))for(var[l,u]of Object.entries(s)){var d=this.room.findEventById(n);d?u.thread_id?this.threadedReceipts.set(u.thread_id,n,a,l,u.ts,t):this.unthreadedReceipts.set(n,a,l,u.ts,t):this.danglingReceipts.add(new kp(n,a,l,u,t))}}hasUserReadEvent(e,t){var n=this.unthreadedReceipts.get(e);if(n&&xp(n.eventId,t,this.room))return!0;var i=this.room.findEventById(t);if(!i)return I.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=ro(i),s=this.threadedReceipts.get(a,e);return!!(s&&xp(s.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var n,i=e===lu?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))===null||n===void 0?void 0:n.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}};o(Fy,"RoomReceipts");let Cp=Fy;const By=class By{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}};o(By,"ReceiptInfo");let Op=By;const $y=class $y{constructor(e,t,n,i,a){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=i,this.synthetic=a}};o($y,"DanglingReceipt");let kp=$y;const Wy=class Wy{constructor(e){f(this,"room",void 0),f(this,"real",void 0),f(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&xp(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}};o(Wy,"UserReceipts");let Pp=Wy;const Ky=class Ky{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a){var s=ey(this.data,n,()=>new Pp(this.room)),l=s.getByType(a);l&&zD(l.eventId,e,this.room)||s.set(a,new Op(e,t,i))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}};o(Ky,"ReceiptsByUser");let Sc=Ky;const Vy=class Vy{constructor(e){f(this,"room",void 0),f(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,n,i,a,s){var l=ey(this.data,e,()=>new Sc(this.room));l.set(t,n,i,a,s)}get(e,t){var n;return(n=this.data.get(e))===null||n===void 0?void 0:n.get(t)}};o(Vy,"ThreadedReceipts");let Mp=Vy;const Gy=class Gy{constructor(){f(this,"data",new Map)}add(e){var t=ey(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}};o(Gy,"DanglingReceipts");let Ap=Gy;function ey(r,e,t){var n=r.get(e);if(n)return n;var i=t();return r.set(e,i),i}o(ey,"getOrCreate");function xp(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>=0}o(xp,"isAfterOrSame");function zD(r,e,t){var n=t.compareEventOrdering(r,e);return n!==null&&n>0}o(zD,"isAfter");function JD(r,e,t){var n=r.findEventById(e),i=r.findEventById(t);if(!n||!i)return null;var a=zl(n),s=zl(i);return a&&s?QD(r,e,t,n,i):YD(e,t,n,i)}o(JD,"compareEventOrdering");function QD(r,e,t,n,i){var a=r.getUnfilteredTimelineSet(),s=a.compareEventOrdering(e,t);if(s!==null)return s;var l=a.getTimelineForEvent(e);if(l===a.getLiveTimeline())return 1;var u=a.getTimelineForEvent(t);return u===a.getLiveTimeline()?-1:cI(n,i)}o(QD,"compareEventsInMainTimeline");function YD(r,e,t,n){var i=ro(t),a=ro(n),s=t.getThread();return s&&i===a?s.timelineSet.compareEventOrdering(r,e):cI(t,n)}o(YD,"compareEventsInThreads");function cI(r,e){var t=r.getTs(),n=e.getTs();return t<n?-1:t>n?1:0}o(cI,"guessOrderBasedOnTimestamp");var G=function(r){return r.Get="GET",r.Put="PUT",r.Post="POST",r.Delete="DELETE",r.Options="OPTIONS",r.Head="HEAD",r.Patch="PATCH",r}({});function kb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(kb,"ownKeys$f");function XD(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):kb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(XD,"_objectSpread$f");const qy=class qy extends Error{constructor(e,t,n){super(e),this.httpStatus=t,this.httpHeaders=n}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var n=Number.parseInt(t)*1e3;if(!Number.isFinite(n))throw new Error("Retry-After header integer value is too large");return n}var i=new Date(t);if(i.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return i.getTime()-Date.now()}return null}};o(qy,"HTTPError");let Hn=qy;const Qc=class Qc extends Hn{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),n&&(s="".concat(s," (").concat(n,")")),super("MatrixError: ".concat(s),t,a),this.url=n,this.event=i,f(this,"errcode",void 0),f(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,n,i,a={};if(this.httpHeaders)for(var[s,l]of this.httpHeaders)a[s]=l;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:XD({errcode:(n=this.errcode)!==null&&n!==void 0?n:"M_UNKNOWN",error:(i=this.data.error)!==null&&i!==void 0?i:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new Qc(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}};o(Qc,"MatrixError");let ft=Qc;function ty(r,e){if(!(r instanceof Hn)||!r.isRateLimitError())return e;try{var t;return(t=r.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}o(ty,"safeGetRetryAfterMs");const Hy=class Hy extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}};o(Hy,"ConnectionError");let zn=Hy;const zy=class zy extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}};o(zy,"TokenRefreshError");let Ec=zy;const Jy=class Jy extends Error{constructor(e){var t;super((t=e==null?void 0:e.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}};o(Jy,"TokenRefreshLogoutError");let Ul=Jy;var Dp=function(r){return r.SessionLoggedOut="Session.logged_out",r.NoConsent="no_consent",r}({});/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var Pb=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,ZD=/\\([\u000b\u0020-\u00ff])/g,e1=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,t1=r1;function r1(r){if(!r)throw new TypeError("argument string is required");var e=typeof r=="object"?n1(r):r;if(typeof e!="string")throw new TypeError("argument string is required to be a string");var t=e.indexOf(";"),n=t!==-1?e.slice(0,t).trim():e.trim();if(!e1.test(n))throw new TypeError("invalid media type");var i=new i1(n.toLowerCase());if(t!==-1){var a,s,l;for(Pb.lastIndex=t;s=Pb.exec(e);){if(s.index!==t)throw new TypeError("invalid parameter format");t+=s[0].length,a=s[1].toLowerCase(),l=s[2],l.charCodeAt(0)===34&&(l=l.slice(1,-1),l.indexOf("\\")!==-1&&(l=l.replace(ZD,"$1"))),i.parameters[a]=l}if(t!==e.length)throw new TypeError("invalid parameter format")}return i}o(r1,"parse$1");function n1(r){var e;if(typeof r.getHeader=="function"?e=r.getHeader("content-type"):typeof r.headers=="object"&&(e=r.headers&&r.headers["content-type"]),typeof e!="string")throw new TypeError("content-type header is missing from object");return e}o(n1,"getcontenttype");function i1(r){this.parameters=Object.create(null),this.type=r}o(i1,"ContentType");function Mh(r){var e=new AbortController;return setTimeout(()=>{e.abort()},r),e.signal}o(Mh,"timeoutSignal");function hI(r){var e=new AbortController;function t(){for(var a of r)a.removeEventListener("abort",n)}o(t,"cleanup");function n(){e.abort(),t()}o(n,"onAbort");for(var i of r){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:e.signal,cleanup:t}}o(hI,"anySignal");function ry(r,e){var t,n,i=Mb(r)?new Headers(r.getAllResponseHeaders().trim().split(/[\r\n]+/).map(s=>{var l=s.indexOf(":");return[s.substring(0,l),s.substring(l+1)]})):r.headers,a;try{a=a1(i)}catch(s){return s}return((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e?new ft(JSON.parse(e),r.status,Mb(r)?r.responseURL:r.url,void 0,i):((n=a)===null||n===void 0?void 0:n.type)==="text/plain"?new Hn("Server returned ".concat(r.status," error: ").concat(e),r.status,i):new Hn("Server returned ".concat(r.status," error"),r.status,i)}o(ry,"parseErrorResponse");function Mb(r){return"getResponseHeader"in r}o(Mb,"isXhr");function a1(r){var e=r.get("Content-Type");if(e===null)return null;try{return t1(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}o(a1,"getResponseContentType");function Np(r,e){return Lp.apply(this,arguments)}o(Np,"retryNetworkOperation");function Lp(){return Lp=R(function*(r,e){for(var t=0,n=null;t<r;)try{if(t>0){var i=1e3*Math.pow(2,t);I.log("network operation failed ".concat(t," times, retrying in ").concat(i,"ms...")),yield du(i)}return yield e()}catch(a){if(a instanceof zn)t+=1,n=a;else throw a}throw n}),Lp.apply(this,arguments)}o(Lp,"_retryNetworkOperation");function fI(r,e,t){return e>4||r instanceof zn&&!t||r.httpStatus&&Math.floor(r.httpStatus/100)===4&&r.httpStatus!==429||r.name==="AbortError"||r.name==="M_TOO_LARGE"?-1:ty(r,1e3*Math.pow(2,e))}o(fI,"calculateRetryBackoff");var hi=function(r){return r.Success="success",r.Failure="failure",r.Logout="logout",r}({}),s1=500,o1=60*1e3;const Qy=class Qy{constructor(e){this.opts=e,f(this,"tokenRefreshPromise",void 0),f(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return R(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return R(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=s1&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var n=this;return R(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return R(function*(){if(e!=null&&e.expiry){var i=e.expiry.getTime()-Date.now();if(i>=o1)return hi.Logout}if(!e||(e==null?void 0:e.accessToken)===n.opts.accessToken){var a;(a=n.tokenRefreshPromise)!==null&&a!==void 0||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return hi.Success})()}doTokenRefresh(e){var t=this;return R(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var n;return(n=t.opts.logger)===null||n===void 0||n.error("Unable to refresh token - no refresh token or refresh function"),hi.Logout}e&&e>1&&(yield du(1e3*Math.min(32,2**e)));try{var i,a;(i=t.opts.logger)===null||i===void 0||i.debug("Attempting to refresh token");var{accessToken:s,refreshToken:l,expiry:u}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=s,t.opts.refreshToken=l,t.latestTokenRefreshExpiry=u,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",u),hi.Success}catch(h){var d;if(h instanceof Ul||h instanceof ft){var c;return(c=t.opts.logger)===null||c===void 0||c.error("Failed to refresh token",h),hi.Logout}return(d=t.opts.logger)===null||d===void 0||d.warn("Failed to refresh token",h),hi.Failure}})()}};o(Qy,"TokenRefresher");let Up=Qy;function Ab(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Ab,"ownKeys$e");function xb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ab(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ab(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(xb,"_objectSpread$e");const Yy=class Yy{constructor(e,t){var n;this.eventEmitter=e,this.opts=t,f(this,"abortController",new AbortController),f(this,"tokenRefresher",void 0),yR(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(n=t.useAuthorizationHeader)!==null&&n!==void 0?n:!0,this.tokenRefresher=new Up(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,n,i,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var s=void 0,l=void 0;e===G.Get?s=n:l=n;var u=this.getUrl(t,s,i,this.opts.idBaseUrl),d={json:!0,headers:{}};return a&&(d.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,u,l,d)}authedRequest(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,n,i,a)}doAuthedRequest(e,t,n,i,a){var s=arguments,l=this;return R(function*(){var u=s.length>5&&s[5]!==void 0?s[5]:{},d=uu(u);d.abortSignal=u.abortSignal;var c=yield l.tokenRefresher.prepareForRequest();c.accessToken&&(l.opts.useAuthorizationHeader?(d.headers||(d.headers={}),d.headers.Authorization||(d.headers.Authorization="Bearer ".concat(c.accessToken)),i.access_token&&delete i.access_token):i.access_token||(i.access_token=c.accessToken));try{var h=yield l.request(t,n,i,a,d);return h}catch(g){if(!(g instanceof ft))throw g;if(g.errcode==="M_UNKNOWN_TOKEN"){var v=yield l.tokenRefresher.handleUnknownToken(c,e);if(v===hi.Success)return l.doAuthedRequest(e+1,t,n,i,a,u);if(v===hi.Failure)throw new Ec(g);d!=null&&d.inhibitLogoutEmit||l.eventEmitter.emit(Dp.SessionLoggedOut,g)}else g.errcode=="M_CONSENT_NOT_GIVEN"&&l.eventEmitter.emit(Dp.NoConsent,g.message,g.data.consent_uri);throw g}})()}request(e,t,n,i,a){var s=this.getUrl(t,n,a==null?void 0:a.prefix,a==null?void 0:a.baseUrl);return this.requestOtherUrl(e,s,i,a)}requestOtherUrl(e,t,n){var i=arguments,a=this;return R(function*(){var s,l,u,d,c=i.length>3&&i[3]!==void 0?i[3]:{};if(c.json!==void 0&&c.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var h=a.sanitizeUrlForLogs(t);(s=a.opts.logger)===null||s===void 0||s.debug("FetchHttpApi: --> ".concat(e," ").concat(h));var v=Object.assign({},c.headers||{}),g=!c.rawResponseBody&&c.json!==!1;g&&(v.Accept||(v.Accept="application/json"));var p=(l=c.localTimeoutMs)!==null&&l!==void 0?l:a.opts.localTimeoutMs,m=(u=c.keepAlive)!==null&&u!==void 0?u:!1,w=[a.abortController.signal];p!==void 0&&w.push(Mh(p)),c.abortSignal&&w.push(c.abortSignal);var y;c.json!==!1&&(n==null||(d=n.constructor)===null||d===void 0?void 0:d.name)===Object.name?(y=JSON.stringify(n),v["Content-Type"]||(v["Content-Type"]="application/json")):y=n;var{signal:S,cleanup:T}=hI(w),C,M=Date.now();try{var _;C=yield a.fetch(t,{signal:S,method:e,body:y,headers:v,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:m,priority:c.priority}),(_=a.opts.logger)===null||_===void 0||_.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-M,"ms ").concat(C.status,"]"))}catch(b){var O;throw(O=a.opts.logger)===null||O===void 0||O.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-M,"ms ").concat(b,"]")),b.name==="AbortError"?b:new zn("fetch failed",b)}finally{T()}if(!C.ok)throw ry(C,yield C.text());return a.opts.onlyData?c.rawResponseBody?yield C.blob():g?yield C.json():yield C.text():C})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var n=new URLSearchParams;for(var i of t.searchParams.keys())n.append(i,"xxx");var a=n.toString(),s=a?"?".concat(a):"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,n,i){var a=i??this.opts.baseUrl,s=a.endsWith("/")?a.slice(0,-1):a,l=new URL(s+(n??this.opts.prefix)+e);if(this.opts.extraParams||t){var u=xb(xb({},this.opts.extraParams),t);qv(u,l.searchParams)}return l}};o(Yy,"FetchHttpApi");let jp=Yy;var It=function(r){return r.V1="/_matrix/client/v1",r.V3="/_matrix/client/v3",r.Unstable="/_matrix/client/unstable",r}({}),On=function(r){return r.V2="/_matrix/identity/v2",r}({}),ds=function(r){return r.V1="/_matrix/media/v1",r.V3="/_matrix/media/v3",r}({}),l1=1e3,u1=0,Mf,Un=[],d1=o(function(){},"debuglog");function Db(r,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),i=2;i<t;i++)n[i-2]=arguments[i];e=e||0,e<0&&(e=0);var a=Date.now()+e,s=u1++,l={runAt:a,func:r,params:n,key:s},u=h1(Un,function(d){return d.runAt-a});return Un.splice(u,0,l),ny(),s}o(Db,"setTimeout$1");function Nb(r){if(Un.length!==0){var e;for(e=0;e<Un.length;e++){var t=Un[e];if(t.key==r){Un.splice(e,1);break}}e===0&&ny()}}o(Nb,"clearTimeout$1");function ny(){Mf&&globalThis.clearTimeout(Mf);var r=Un[0];if(r){var e=Date.now(),t=Math.min(r.runAt-e,l1);Mf=globalThis.setTimeout(c1,t)}}o(ny,"scheduleRealCallback");function c1(){for(var r=Date.now(),e=[];;){var t=Un[0];if(!t||t.runAt>r)break;var n=Un.shift();d1("runCallbacks: popping",n.key),e.push(n)}ny();for(var i of e)try{i.func.apply(globalThis,i.params)}catch(a){I.error("Uncaught exception in callback function",a)}}o(c1,"runCallbacks");function h1(r,e){for(var t=0,n=r.length;t<n;){var i=t+n>>1,a=e(r[i]);a>0?n=i:t=i+1}return t}o(h1,"binarySearch");const Xy=class Xy extends jp{constructor(){super(...arguments),f(this,"uploads",[])}uploadContent(e){var t,n,i,a,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=(t=s.includeFilename)!==null&&t!==void 0?t:!0,u=(n=s.abortController)!==null&&n!==void 0?n:new AbortController,d=((i=s.type)!==null&&i!==void 0?i:e.type)||"application/octet-stream",c=(a=s.name)!==null&&a!==void 0?a:e.name,h={loaded:0,total:0,abortController:u},v=Promise.withResolvers();if(globalThis.XMLHttpRequest){var g=new globalThis.XMLHttpRequest,p=o(function(){g.abort(),v.reject(new Error("Timeout"))},"timeoutFn"),m=Db(p,3e4);g.onreadystatechange=function(){switch(g.readyState){case globalThis.XMLHttpRequest.DONE:Nb(m);try{if(g.status===0)throw new DOMException(g.statusText,"AbortError");if(!g.responseText)throw new Error("No response body.");g.status>=400?v.reject(ry(g,g.responseText)):v.resolve(JSON.parse(g.responseText))}catch(T){if(T.name==="AbortError"){v.reject(T);return}v.reject(new zn("request failed",T))}break}},g.upload.onprogress=T=>{var C;Nb(m),h.loaded=T.loaded,h.total=T.total,m=Db(p,3e4),(C=s.progressHandler)===null||C===void 0||C.call(s,{loaded:T.loaded,total:T.total})};var w=this.getUrl("/upload",void 0,ds.V3);l&&c&&w.searchParams.set("filename",encodeURIComponent(c)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&w.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),g.open(G.Post,w.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&g.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),g.setRequestHeader("Content-Type",d),g.send(e),u.signal.addEventListener("abort",()=>{g.abort()})}else{var y={};l&&c&&(y.filename=c);var S={"Content-Type":d};this.authedRequest(G.Post,"/upload",y,e,{prefix:ds.V3,headers:S,abortSignal:u.signal}).then(T=>this.opts.onlyData?T:T.json()).then(v.resolve,v.reject)}return h.promise=v.promise.finally(()=>{Zd(this.uploads,T=>T===h)}),u.signal.addEventListener("abort",()=>{Zd(this.uploads,T=>T===h),v.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(h),h.promise}cancelUpload(e){var t=this.uploads.find(n=>n.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:ds.V3+"/upload",params:{access_token:this.opts.accessToken}}}};o(Xy,"MatrixHttpApi");let _c=Xy;var f1=6*60*60*1e3,v1=30*1e3,vI=function(r){return r.Stable="stable",r.Unstable="unstable",r}({});const Zy=class Zy{constructor(e,t){var n=this;this.logger=e,this.http=t,f(this,"capabilities",void 0),f(this,"retryTimeout",void 0),f(this,"refreshTimeout",void 0),f(this,"fetchCapabilities",R(function*(){var i=yield n.http.authedRequest(G.Get,"/capabilities");return n.capabilities=i.capabilities,n.capabilities})),f(this,"poll",R(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,f1),n.logger.debug("Fetched new server capabilities")}catch(a){n.clearTimeouts();var i=Math.floor(v1+Math.random()*5e3);n.retryTimeout=setTimeout(n.poll,i),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(i,"ms"),a)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}};o(Zy,"ServerCapabilities");let bc=Zy;function Lb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Lb,"ownKeys$d");function Po(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Lb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Lb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Po,"_objectSpread$d");var pI="10",p1=["1","2","3","4","5","6","7","8","9","10"],m1=30,Be=function(r){return r.Highlight="highlight",r.Total="total",r}({}),fe=function(r){return r.MyMembership="Room.myMembership",r.Tags="Room.tags",r.AccountData="Room.accountData",r.Receipt="Room.receipt",r.Name="Room.name",r.Redaction="Room.redaction",r.RedactionCancelled="Room.redactionCancelled",r.LocalEchoUpdated="Room.localEchoUpdated",r.Timeline="Room.timeline",r.TimelineReset="Room.timelineReset",r.TimelineRefresh="Room.TimelineRefresh",r.OldStateUpdated="Room.OldStateUpdated",r.CurrentStateUpdated="Room.CurrentStateUpdated",r.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",r.UnreadNotifications="Room.UnreadNotifications",r.Summary="Room.Summary",r}({});const eS=class eS extends mc{constructor(e,t,n){var i,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),i=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=a,f(this,"reEmitter",void 0),f(this,"txnToEvent",new Map),f(this,"notificationCounts",{}),f(this,"bumpStamp",void 0),f(this,"threadNotifications",new Map),f(this,"cachedThreadReadReceipts",new Map),f(this,"oldestThreadedReceiptTs",1/0),f(this,"unthreadedReceipts",new Map),f(this,"timelineSets",void 0),f(this,"polls",new Map),f(this,"threadsTimelineSets",[]),f(this,"filteredTimelineSets",{}),f(this,"timelineNeedsRefresh",!1),f(this,"pendingEventList",void 0),f(this,"blacklistUnverifiedDevices",void 0),f(this,"selfMembership",void 0),f(this,"heroes",null),f(this,"getTypeWarning",!1),f(this,"membersPromise",void 0),f(this,"name",void 0),f(this,"normalizedName",void 0),f(this,"tags",{}),f(this,"accountData",new Map),f(this,"summary",null),f(this,"oldState",void 0),f(this,"currentState",void 0),f(this,"relations",void 0),f(this,"threads",new Map),f(this,"visibilityEvents",new Map),f(this,"roomReceipts",new Cp(this)),f(this,"threadTimelineSetsPromise",null),f(this,"threadsReady",!1),f(this,"updateThreadRootEvents",(s,l,u)=>{if(s.length){var d;if(this.updateThreadRootEvent((d=this.threadsTimelineSets)===null||d===void 0?void 0:d[0],s,l,u),s.hasCurrentUserParticipated){var c;this.updateThreadRootEvent((c=this.threadsTimelineSets)===null||c===void 0?void 0:c[1],s,l,u)}}}),f(this,"updateThreadRootEvent",(s,l,u,d)=>{s&&l.rootEvent&&(d&&s.removeEvent(l.id),_t.hasServerSideSupport?s.addLiveEvent(l.rootEvent,{duplicateStrategy:il.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):s.addEventToTimeline(l.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:u,addToState:!1}))}),f(this,"tryApplyRedaction",s=>{if(s.isRedaction()){var l=s.event.redacts,u=l?this.findEventById(l):void 0;u&&this.applyEventAsRedaction(s,u)}else if(s.getType()===F.RoomMember){var d=s.getContent().membership;if(d!==ke.Ban&&!(d===ke.Leave&&s.getStateKey()!==s.getSender()))return;var c=s.getContent()["org.matrix.msc4293.redact_events"];if(c!==!0)return;var h=this.getLiveTimeline().getState(Me.Forward);if(!h.maySendRedactionForEvent(s,s.getSender()))return;var v=this.getTimelineSets().map(p=>p.getTimelines()).reduce((p,m)=>(p.push(...m),p),[]).map(p=>p.getEvents().filter(m=>m.getSender()===s.getStateKey())).reduce((p,m)=>(p.push(...m),m),[]);for(var g of v)this.applyEventAsRedaction(s,g)}}),this.setMaxListeners(100),this.reEmitter=new Li(this),a.pendingEventOrdering=a.pendingEventOrdering||eo.Chronological,this.name=e,this.normalizedName=e,this.relations=new uc(this.client,this),this.on(fe.Receipt,this.onReceipt),this.timelineSets=[new Si(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[fe.Timeline,fe.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===eo.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{var l=this.client.getEventMapper({toDevice:!1,decrypt:!1});s.forEach(function(){var u=R(function*(d){var c=l(d);yield t.decryptEventIfNeeded(c),c.setStatus(we.NOT_SENT),i.addPendingEvent(c,c.getTxnId())});return function(d){return u.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return R(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Vr.My)]);var n=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=n[0],e.threadsTimelineSets[1]=n[1],n}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return R(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),n=e.getLiveTimeline().getEvents(),i=n.findIndex(s=>s.event.event_id===t),a=n.slice(i).reverse().map(s=>e.client.decryptEventIfNeeded(s));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return R(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(n=>e.client.decryptEventIfNeeded(n));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(F.RoomCreate,"");return(e=t==null?void 0:t.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return R(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var n=t["m.room_versions"];if(!n){n={default:pI,available:{}};for(var i of p1)n.available[i]=vI.Stable}var a=e.checkVersionAgainstCapability(n);if(a.urgent&&a.needsUpgrade){I.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){I.warn("Failed to refresh room version capabilities",s)}if(n=t["m.room_versions"],n)a=e.checkVersionAgainstCapability(n);else return I.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();I.log("[".concat(this.roomId,"] Current version: ").concat(t)),I.log("[".concat(this.roomId,"] Version capability: "),e);var n={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return n;var i=Object.keys(e.available).filter(a=>e.available[a]==="stable");return i.includes(t)||(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?I.warn("URGENT upgrade required on ".concat(this.roomId)):I.warn("Non-urgent upgrade required on ".concat(this.roomId))),n}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(F.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Zd(this.pendingEventList,function(n){return n.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.some(i=>i.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,n;return(t=(n=this.pendingEventList)===null||n===void 0?void 0:n.find(i=>i.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var n=t[t.length-1];return n.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,n=this.getLiveTimeline().getEvents(),i=n[n.length-1],a=this.getLastThread();if(!a)return i;var s=a.events[a.events.length-1];return((e=i==null?void 0:i.getTs())!==null&&e!==void 0?e:0)>((t=s==null?void 0:s.getTs())!==null&&t!==void 0?t:0)?i:s}getLastThread(){return this.getThreads().reduce((e,t)=>{var n,i;if(!e)return t;var a=t.events[t.events.length-1],s=e.events[e.events.length-1];return((n=a==null?void 0:a.getTs())!==null&&n!==void 0?n:0)>=((i=s==null?void 0:s.getTs())!==null&&i!==void 0?i:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:ke.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===ke.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var n;return(n=this.heroes)===null||n===void 0||(n=n[0])===null||n===void 0?void 0:n.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var n=this.currentState.getMembers(),i=n.find(a=>a.userId!==this.myUserId);return i?i.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(UR.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),n=0;if(this.getMembers().forEach(m=>{m.membership!=="join"&&m.membership!=="invite"||t.includes(m.userId)||n++}),!(n>2)){var i=(e=this.heroes)===null||e===void 0?void 0:e.filter(m=>!t.includes(m.userId)),a=Array.isArray(i)&&i.length;if(a){for(var s of i)if(s.fromMSC4186){var u=new Ea(this.roomId,s.userId);return u.setMembershipEvent(new Ht({event_id:"$"+this.roomId+s.userId+new Date().getTime(),type:F.RoomMember,state_key:s.userId,content:{displayname:s.displayName,avatar_url:s.avatarUrl}})),u}else{var l=this.getMember(s.userId);if(l)return l}var d=i.map(m=>this.getMember(m.userId)).find(m=>!!m);if(d)return d}var c=this.getMembers(),h=c==null?void 0:c.filter(m=>!t.includes(m.userId));if(h.length<=2){var v=h.find(m=>m.userId!==this.myUserId);if(v)return v}if(a){var g=i.map(m=>this.client.getUser(m.userId)).find(m=>!!m);if(g){var p=new Ea(this.roomId,g.userId);return p.user=g,p}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===ke.Leave&&this.cleanupAfterLeaving(),this.emit(fe.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return R(function*(){var t=e.client.store.getSyncToken(),n=yield e.client.members(e.roomId,void 0,ke.Leave,t??void 0);return n.chunk})()}loadMembers(){var e=this;return R(function*(){var t=!1,n=yield e.client.store.getOutOfBandMembers(e.roomId);(n===null||e.hasEncryptionStateEvent())&&(t=!0,n=yield e.loadMembersFromServer(),I.log("LL: got ".concat(n.length," ")+"members from server for room ".concat(e.roomId)));var i=n.filter(zr).map(e.client.getEventMapper());return{memberEvents:i,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var n=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var s;return(s=a.events.member)===null||s===void 0?void 0:s.event});I.log("LL: telling store to write ".concat(n.length)+" members for room ".concat(this.roomId));var i=this.client.store;return i.setOutOfBandMembers(this.roomId,n).catch(a=>{I.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{I.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return R(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{I.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),I.log(e)})}refreshLiveTimeline(){var e=this;return R(function*(){var t=e.getLiveTimeline(),n=t.getPaginationToken(me.FORWARDS),i=t.getPaginationToken(me.BACKWARDS),a=t.getEvents(),s=a[a.length-1];I.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(s&&s.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(n," ")+"backwardPaginationToken=".concat(i));var l=e.getUnfilteredTimelineSet(),u;s?(e.resetLiveTimeline(null,null),e.emit(fe.TimelineRefresh,e,l),u=yield e.client.getEventTimeline(l,s.getId())):u=yield e.client.getLatestTimeline(l);var d=l.getLiveTimeline();!d||d.getPaginationToken(Me.Forward)===null&&d.getPaginationToken(Me.Backward)===null&&d.getEvents().length===0?(I.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),u.setPaginationToken(n,me.FORWARDS),l.setLiveTimeline(u),e.fixUpLegacyTimelineFields()):I.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(fe.TimelineRefresh,e,l)})()}resetLiveTimeline(e,t){for(var n of this.timelineSets)n.resetLiveTimeline(e??void 0,t??void 0);for(var i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(me.BACKWARDS),this.currentState=this.getLiveTimeline().getState(me.FORWARDS),e!==this.oldState&&this.emit(fe.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(fe.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[De.Events,De.Members,De.NewMember,De.Update,De.Marker,Ze.New,Ze.Update,Ze.Destroy,Ze.LivenessChange]),this.reEmitter.reEmit(this.currentState,[De.Events,De.Members,De.NewMember,De.Update,De.Marker,Ze.New,Ze.Update,Ze.Destroy,Ze.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],n=!1,i=e.getContent();for(var a of Object.values(i))for(var[s,l]of Object.entries(a))if(Qg(s)&&l){for(var[u,d]of Object.entries(l))if(!(!d||typeof d!="object")){var c=d;u===this.client.getUserId()&&(c.thread_id===void 0?n=!0:typeof c.thread_id=="string"&&t.push(c.thread_id))}}n&&(t=this.getThreads().filter(M=>this.getThreadUnreadNotificationCount(M.id,Be.Total)>0||this.getThreadUnreadNotificationCount(M.id,Be.Highlight)>0).map(M=>M.id),t.push("main"));for(var h of t){var v,g=20,p=h==="main"?this.getLiveTimeline():(v=this.getThread(h))===null||v===void 0?void 0:v.liveTimeline;if(!p){I.warn("Couldn't find timeline for thread ID ".concat(h," in room ").concat(this.roomId));continue}for(var m=p.getEvents(),w=0,y=m.length-1;y>=0;y--){var S;if(y===m.length-g)return;var T=m[y];if(this.hasUserReadEvent(this.client.getUserId(),T.getId()))break;var C=this.client.getPushActionsForEvent(T);w+=C!=null&&(S=C.tweaks)!==null&&S!==void 0&&S.highlight?1:0}h==="main"?this.setUnreadNotificationCount(Be.Highlight,w):this.setThreadUnreadNotificationCount(h,Be.Highlight,w)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var n=this.getThreads(),i=0;i<n.length;i++){var a=n[i];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Be.Total,t=this.getRoomUnreadNotificationCount(e);for(var n of this.threadNotifications.values()){var i;t+=(i=n[e])!==null&&i!==void 0?i:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Be.Total,n=arguments.length>1?arguments[1]:void 0,i=!!n.threadRootId&&!n.isThreadRoot;return(e=i?this.getThreadUnreadNotificationCount(n.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Be.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Be.Total;return(t=(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n[i])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,n;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((n=e.total)!==null&&n!==void 0?n:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,n){var i,a,s=Po({highlight:(i=this.threadNotifications.get(e))===null||i===void 0?void 0:i.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:n});this.threadNotifications.set(e,s),this.emit(fe.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var n,i;if(((n=t.highlight)!==null&&n!==void 0?n:0)>0)return Be.Highlight;((i=t.total)!==null&&i!==void 0?i:0)>0&&!e&&(e=Be.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[n,i]of this.threadNotifications)e.includes(n)||(i.total=0,t||(i.highlight=0));this.emit(fe.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(fe.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,n=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(s=>({userId:s,fromMSC4186:!1})),i=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(n)&&(this.heroes=n.filter(s=>s.userId!=this.myUserId)),this.emit(fe.Summary,e)}setMSC4186SummaryData(e,t,n){e&&(this.heroes=e.filter(i=>i.user_id!==this.myUserId).map(i=>({userId:i.user_id,displayName:i.displayname,avatarUrl:i.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),n!==void 0&&Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),this.emit(fe.Summary,{"m.heroes":this.heroes?this.heroes.map(i=>i.userId):[],"m.joined_member_count":t,"m.invited_member_count":n})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,l=this.currentState.getStateEvents(F.RoomAvatar,"");if(!l&&!a)return null;var u=l?l.getContent().url:null;return u?Th(e,u,t,n,i,void 0,void 0,s):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents(F.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(F.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(F.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,n,i,a){i.getTimelineSet().addEventsToTimeline(e,t,n,i,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(ke.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return R(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(ke.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(ke.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(F.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var n=this.getMember(e);return n?n.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:n=!0,pendingEvents:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:i},this.opts),s=new Si(this,a);this.reEmitter.reEmit(s,[fe.Timeline,fe.TimelineReset]),n&&(this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s));var l=this.getLiveTimeline();if(t){l.getEvents().forEach(function(c){s.addLiveEvent(c,{addToState:!1})});for(var u=l;u.getNeighbouringTimeline(me.BACKWARDS);)u=u.getNeighbouringTimeline(me.BACKWARDS);s.getLiveTimeline().setPaginationToken(u.getPaginationToken(me.BACKWARDS),me.BACKWARDS)}else if(n){var d=l.getPaginationToken(Me.Forward);s.getLiveTimeline().setPaginationToken(d,Me.Backward)}return s}getThreadListFilter(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:Vr.All,i=t.client.getUserId(),a=new lr(i),s={room:{timeline:{[vs.name]:[qe.name]}}};n===Vr.My&&(s.room.timeline[fs.name]=[i]),a.setDefinition(s);var l=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(n),a);return a.filterId=l,a})()}createThreadTimelineSet(e){var t=this;return R(function*(){var n;if(_t.hasServerSideListSupport)n=new Si(t,Po(Po({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Vr.All),t.reEmitter.reEmit(n,[fe.Timeline,fe.TimelineReset]);else if(_t.hasServerSideSupport){var i=yield t.getThreadListFilter(e);n=t.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else n=new Si(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,s]=a;if(s.length!==0){var l=s.timeline.some(u=>u.getSender()===t.client.getUserId());(e!==Vr.My||l)&&n.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return n})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var n of e)me.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}fetchRoomThreads(){var e=this;return R(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(_t.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Vr.All),e.fetchRoomThreadList(Vr.My)]);else{var t=yield e.getThreadListFilter(),{chunk:n}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,Me.Backward,t);if(!n.length)return;var i=n.map(e.client.getEventMapper()).sort((v,g)=>{var p=v.getServerAggregatedRelation(qe.name),m=g.getServerAggregatedRelation(qe.name);return p.latest_event.origin_server_ts-m.latest_event.origin_server_ts}),a,s=e.getLiveTimeline().getState(me.FORWARDS);for(var l of i){var u,d={duplicateStrategy:il.Ignore,fromCache:!1,addToState:!1,roomState:s};(u=e.threadsTimelineSets[0])===null||u===void 0||u.addLiveEvent(l,d);var c=l.getServerAggregatedRelation(qe.name);if(c!=null&&c.current_user_participated){var h;(h=e.threadsTimelineSets[1])===null||h===void 0||h.addLiveEvent(l,d),a=l}}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(tr.NewReply,e.onThreadReply),e.on(tr.Update,e.onThreadUpdate),e.on(tr.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return R(function*(){for(var n of e)try{if(!n.isEncrypted()&&!dI(n))continue;yield t.client.decryptEventIfNeeded(n),t.processPollEvent(n)}catch(i){I.warn("Error processing poll event",n.getId(),i)}})()}processPollEvent(e){var t=this;return R(function*(){if(e.isDecryptionFailure()){e.once(We.Decrypted,s=>{t.processPollEvent(s)});return}if(ar.M_POLL_START.matches(e.getType())){try{var n=new yc(e,t.client,t);t.polls.set(e.getId(),n),t.emit(ci.New,n),e.once(We.BeforeRedaction,s=>{t.polls.delete(s.getId())})}catch{}return}var i=e.relationEventId;if(i&&t.polls.has(i)){var a=t.polls.get(i);a==null||a.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return R(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var n=e===Vr.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:i,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,Me.Backward,n.threadListType,n.getFilter());if(n.getLiveTimeline().setPaginationToken(a??null,Me.Backward),!!i.length){var s=i.map(t.client.getEventMapper());t.processThreadRoots(s,!0);var l=t.getLiveTimeline().getState(me.FORWARDS);for(var u of s)n.addLiveEvent(u,{duplicateStrategy:il.Replace,fromCache:!1,roomState:l,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var n=this.getTimelineForEvent(e.id),i=n==null||(t=n.getEvents())===null||t===void 0?void 0:t.find(s=>s.getId()===e.id);i?e.clearEventMetadata(i):I.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var n=this.timelineSets.indexOf(t);n>-1&&this.timelineSets.splice(n,1)}eventShouldLiveIn(e,t,n){var i;if(!((i=this.client)!==null&&i!==void 0&&i.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||n!=null&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(qe.name),s=e.getAssociatedId(),l=e.threadRootId;if(s&&!a&&(l===s||n!=null&&n.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var u;if(s){var d;u=(d=this.findEventById(s))!==null&&d!==void 0?d:t==null?void 0:t.find(c=>c.getId()===s)}return u&&!a?this.eventShouldLiveIn(u,t,n):l!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:l}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getThread(e);if(i)i.addEvents(t,n);else{var a,s=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(l=>l.getId()===e);this.createThread(e,s,t,n)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var n={};for(var i of e){var a,{threadId:s,shouldLiveInThread:l}=this.eventShouldLiveIn(i);l&&!n[s]&&(n[s]=[]),(a=n[s])===null||a===void 0||a.push(i)}Object.entries(n).map(u=>{var[d,c]=u;return this.addThreadedEvents(d,c,t)})}createThread(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var s=this.relations.getAllChildEventsForEvent(t.getId());s!=null&&s.length&&(i=i.concat(s.filter(u=>!u.isRelation(tt.Replace))))}var l=new _t(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(n=this.cachedThreadReadReceipts.get(e))!==null&&n!==void 0?n:[]});return this.reEmitter.reEmit(l,[tr.Delete,tr.Update,tr.NewReply,fe.Timeline,fe.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(l.id,l),l.addEvents(i,!1),this.threadsReady&&l.initialEventsFetched&&this.updateThreadRootEvents(l,a,!1),this.emit(tr.New,l,a),l}applyEventAsRedaction(e,t){var n=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var i=this.currentState.getStateEvents(t.getType(),t.getStateKey());(i==null?void 0:i.getId())===t.getId()&&this.currentState.setStateEvents([t])}this.emit(fe.Redaction,e,this,n),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[n,i]of this.txnToEvent)if(i.getId()===e.getId()){I.debug("processLiveEvent: found sent event without txn ID: ",n,e.getId());var a=e.getUnsigned();a.transaction_id=n,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:n,timelineWasEmpty:i,fromCache:a,addToState:s}=t;for(var l of this.timelineSets)l.addLiveEvent(e,{duplicateStrategy:n,fromCache:a,timelineWasEmpty:i,addToState:s});e.sender&&e.getType()!==F.RoomRedaction&&this.addReceipt(uI(e.sender.userId,e,er.Read),!0)}addPendingEvent(e,t){if(e.status!==we.SENDING&&e.status!==we.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(me.setEventMetadata(e,this.getLiveTimeline().getState(me.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(s=>s.status===we.NOT_SENT)&&(I.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(we.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var n=e.event.redacts,i=this.pendingEventList.find(s=>s.getId()===n);!i&&n&&(i=this.findEventById(n)),i&&(i.markLocallyRedacted(e),this.emit(fe.Redaction,e,this,i.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(fe.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Po(Po({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var n=t.type===F.RoomMessageEncrypted,i=this.hasEncryptionStateEvent();return n||!i});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var n=t.getId(),i=e.getId(),a=t.status;I.debug("Got remote echo for event ".concat(n," -> ").concat(i," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:s,threadId:l}=this.eventShouldLiveIn(e),u=l?this.getThread(l):null;if(u==null||u.setEventMetadata(t),u==null||u.timelineSet.handleRemoteEcho(t,n,i),s)for(var d of this.timelineSets)d.handleRemoteEcho(t,n,i);this.emit(fe.LocalEchoUpdated,t,this,n,a)}updatePendingEvent(e,t,n){if(I.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(n)),t==we.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==we.SENT){var i=this.getTimelineForEvent(n);if(i){var a=this.findEventById(n),s=a==null?void 0:a.getUnsigned().transaction_id;if(!s&&a){var l=a.getUnsigned();l.transaction_id=e.getTxnId(),a.setUnsigned(l),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var u=e.status,d=e.getId();if(!u)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var c=g1[u];if(!(c!=null&&c.includes(t)))throw new Error("Invalid EventStatus transition ".concat(u,"->").concat(t));if(e.setStatus(t),t==we.SENT){e.replaceLocalEventId(n);var{shouldLiveInRoom:h,threadId:v}=this.eventShouldLiveIn(e),g=v?this.getThread(v):void 0;if(g==null||g.setEventMetadata(e),g==null||g.timelineSet.replaceEventId(d,n),h)for(var p of this.timelineSets)p.replaceEventId(d,n)}else if(t==we.CANCELLED){if(this.pendingEventList){var m=this.getPendingEvent(d);this.removePendingEvent(d),m!=null&&m.isRedaction()&&this.revertRedactionLocalEcho(m)}this.removeEvent(d)}this.savePendingEvents(),this.emit(fe.LocalEchoUpdated,e,this,d,u)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit(fe.RedactionCancelled,e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(me.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(me.FORWARDS)+")");if(t.getNeighbouringTimeline(me.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return R(function*(){var{duplicateStrategy:i,fromCache:a,timelineWasEmpty:s=!1,addToState:l}=t;if(i&&["replace","ignore"].indexOf(i)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var u=n.findThreadRoots(e),d={},c={duplicateStrategy:i,fromCache:a,timelineWasEmpty:s,addToState:l},h=[...e];for(var v of e){var g;if(n.processLiveEvent(v),v.getUnsigned().transaction_id){var p=n.txnToEvent.get(v.getUnsigned().transaction_id);if(p){n.handleRemoteEcho(v,p);continue}}var{shouldLiveInRoom:m,shouldLiveInThread:w,threadId:y=""}=n.eventShouldLiveIn(v,h,u);if(!w&&!m&&v.isRelation())try{var S=new Ht(yield n.client.fetchRoomEvent(n.roomId,v.relationEventId));if(h.push(S),S.threadRootId){u.add(S.threadRootId);var T=v.getUnsigned();T[nc.name]=S.threadRootId,v.setUnsigned(T)}({shouldLiveInRoom:m,shouldLiveInThread:w,threadId:y=""}=n.eventShouldLiveIn(v,h,u))}catch(C){I.error("Failed to load parent event of unhandled relation",C)}w&&!d[y]&&(d[y]=[]),(g=d[y])===null||g===void 0||g.push(v),m?n.addLiveEvent(v,c):!w&&v.isRelation()&&n.relations.aggregateChildEvent(v)}Object.entries(d).forEach(C=>{var[M,_]=C;n.addThreadedEvents(M,_,!1)})})()}partitionThreadedEvents(e){var t=0,n=1,i=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((s,l)=>{var{shouldLiveInRoom:u,shouldLiveInThread:d,threadId:c}=this.eventShouldLiveIn(l,e,a);return u&&s[t].push(l),d&&(l.setThreadId(c??""),s[n].push(l)),!d&&!u&&s[i].push(l),s},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var n of e){var i=n.threadRootId;i!=null&&t.add(i)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(a=>{Object.keys(n[i][a]).forEach(s=>{var l,u,d,c=n[i][a][s],h=!c.thread_id||c.thread_id===lu,v=h?this:this.threads.get((l=c.thread_id)!==null&&l!==void 0?l:"");if(v){if(v.addReceiptToStructure(i,a,s,c,t),!t&&this.client.isInitialSyncComplete()&&s===this.client.getUserId()){var g=v.timeline[v.timeline.length-1];g&&i===g.getId()&&s===g.getSender()&&(v.setUnread(Be.Total,0),v.setUnread(Be.Highlight,0))}}else{var p;this.cachedThreadReadReceipts.set(c.thread_id,[...(p=this.cachedThreadReadReceipts.get(c.thread_id))!==null&&p!==void 0?p:[],{eventId:i,receiptType:a,userId:s,receipt:c,synthetic:t}])}var m=this.client.getUserId();s===m&&!h&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>((u=(d=this.unthreadedReceipts.get(s))===null||d===void 0?void 0:d.ts)!==null&&u!==void 0?u:0)&&this.unthreadedReceipts.set(s,c)})})}),this.emit(fe.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===F.Typing?this.currentState.setTypingEvent(t):t.getType()===F.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var n of this.timelineSets){var i=n.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(F.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===ke.Invite){var n=e.getUnsigned().invite_room_state||[];n.forEach(a=>{var s=this.currentState.getStateEvents(a.type,a.state_key);s||this.currentState.setStateEvents([new Ht({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var i=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=FM(this.name),this.summary=new dc(this.roomId,{title:this.name}),i!==this.name&&this.emit(fe.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(fe.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var n=t.getType(),i=this.accountData.get(n);this.accountData.set(n,t),this.emit(fe.AccountData,t,this,i)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===ke.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(F.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(F.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===ke.Join,n=this.currentState.getStateEvents(F.RoomPowerLevels,""),i=n&&n.getContent(),a=this.getMember(e);return i&&a&&i.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(F.RoomCreate,"");if(!e){this.getTypeWarning||(I.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[rc]}isSpaceRoom(){return this.getType()===ls.Space}isCallRoom(){return this.getType()===ls.UnstableCall}isElementVideoRoom(){return this.getType()===ls.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(me.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case on.Actual:return e.name;case on.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(Ub(e.names,e.count));default:return Ub(e.names,e.count)}case on.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var n=this.currentState.getStateEvents(F.RoomName,"");if(n!=null&&n.getContent().name)return this.roomNameGenerator({type:on.Actual,name:n.getContent().name})}var i=this.getCanonicalAlias();if(i)return this.roomNameGenerator({type:on.Actual,name:i});var a=this.currentState.getJoinedMemberCount(),s=this.currentState.getInvitedMemberCount(),l=a+s-1,u=this.getFunctionalMembers(),d=[];if(this.heroes)this.heroes.forEach(y=>{if(u.includes(y.userId)){l--;return}if(y.displayName)d.push(y.displayName);else{var S=this.getMember(y.userId);d.push(S?S.name:y.userId)}});else{var c=this.currentState.getMembers().filter(y=>y.userId!==e&&(y.membership===ke.Invite||y.membership===ke.Join));c=c.filter(y=>{var{userId:S}=y;return u.includes(S)?(l--,!1):!0});var h=new Intl.Collator;c.sort((y,S)=>h.compare(y.userId,S.userId)),c=c.slice(0,5),d=c.map(y=>y.name)}if(l)return this.roomNameGenerator({type:on.Generated,names:d,count:l});var v=this.getMyMembership();if(v==ke.Join){var g=this.currentState.getStateEvents(F.RoomThirdPartyInvite);if(g!=null&&g.length){var p=g.map(y=>y.getContent().display_name);return this.roomNameGenerator({type:on.Generated,subtype:"Inviting",names:p,count:p.length+1})}}var m=d;m.length||(m=this.currentState.getMembers().filter(y=>y.userId!==e&&y.membership!==ke.Invite&&y.membership!==ke.Join).map(y=>y.name));var w;return m.length&&(w=this.roomNameGenerator({type:on.Generated,names:m,count:m.length+1})),this.roomNameGenerator({type:on.EmptyRoom,oldName:w})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var n=e.getSender();if(n){var i=oa.name&&this.currentState.maySendStateEvent(oa.name,n)||oa.altName&&this.currentState.maySendStateEvent(oa.altName,n);if(i){var a=this.visibilityEvents.get(t.eventId);if(a){for(var s=a.length-1,l=Math.max(0,a.length-m1);s>=l;--s){var u=a[s];if(u.getTs()<e.getTs())break}s===-1?a.unshift(e):a.splice(s+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var d=this.findEventById(t.eventId);d&&d.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),n=t==null?void 0:t.event_id,i=this.visibilityEvents.get(n);if(i){var a=i.findIndex(d=>d.getId()===e.getId());if(a!==-1&&(i.splice(a,1),a===i.length)){var s=this.findEventById(n);if(!s)return;if(a===0)this.visibilityEvents.delete(n),s.applyVisibilityEvent();else{var l=i[i.length-1],u=l.asVisibilityChange();if(!u)throw new Error("at this stage, visibility changes should be well-formed");s.applyVisibilityEvent(u)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var n=t[t.length-1],i=n.asVisibilityChange();i&&(i.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(i))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(i=>this.getThreadUnreadNotificationCount(i.id,Be.Total)>0);for(var n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return JD(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(me.FORWARDS))===null||e===void 0)&&e.getStateEvents(F.RoomEncryption,""))}};o(eS,"Room");let Ys=eS;var g1={[we.ENCRYPTING]:[we.SENDING,we.NOT_SENT,we.CANCELLED],[we.SENDING]:[we.ENCRYPTING,we.QUEUED,we.NOT_SENT,we.SENT],[we.QUEUED]:[we.SENDING,we.NOT_SENT,we.CANCELLED],[we.SENT]:[],[we.NOT_SENT]:[we.SENDING,we.QUEUED,we.CANCELLED],[we.CANCELLED]:[]},on=function(r){return r[r.EmptyRoom=0]="EmptyRoom",r[r.Generated=1]="Generated",r[r.Actual=2]="Actual",r}({});function Ub(r,e){var t=e-1;if(r.length){if(r.length===1&&t<=1)return r[0];if(r.length===2&&t<=2)return"".concat(r[0]," and ").concat(r[1]);var n=t>1;return n?"".concat(r[0]," and ").concat(t," others"):"".concat(r[0]," and 1 other")}else return"Empty room"}o(Ub,"memberNamesToRoomName");var Ot=function(r){return r[r.Stable=0]="Stable",r[r.Unstable=1]="Unstable",r[r.Unsupported=2]="Unsupported",r}({}),Pt=function(r){return r.Thread="Thread",r.ThreadUnreadNotifications="ThreadUnreadNotifications",r.LoginTokenRequest="LoginTokenRequest",r.RelationBasedRedactions="RelationBasedRedactions",r.AccountDataDeletion="AccountDataDeletion",r.RelationsRecursion="RelationsRecursion",r.IntentionalMentions="IntentionalMentions",r}({}),y1={[Pt.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[Pt.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[Pt.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[Pt.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[Pt.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[Pt.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[Pt.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function S1(r){return Fp.apply(this,arguments)}o(S1,"buildFeatureSupportMap");function Fp(){return Fp=R(function*(r){var e=new Map;for(var[t,n]of Object.entries(y1)){var i,a,s,l,u=(i=(a=r.versions)===null||a===void 0?void 0:a.includes(n.matrixVersion||""))!==null&&i!==void 0?i:!1,d=(s=(l=n.unstablePrefixes)===null||l===void 0?void 0:l.every(c=>{var h;return((h=r.unstable_features)===null||h===void 0?void 0:h[c])===!0}))!==null&&s!==void 0?s:!1;u?e.set(t,Ot.Stable):d?e.set(t,Ot.Unstable):e.set(t,Ot.Unsupported)}return e}),Fp.apply(this,arguments)}o(Fp,"_buildFeatureSupportMap");function jb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(jb,"ownKeys$c");function wc(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):jb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(wc,"_objectSpread$c");var Fb=80*1e3,E1=3,Ve=function(r){return r.Error="ERROR",r.Prepared="PREPARED",r.Stopped="STOPPED",r.Syncing="SYNCING",r.Catchup="CATCHUP",r.Reconnecting="RECONNECTING",r}({}),_1=["org.matrix.msc2716v3"];function Bb(r,e){return"FILTER_SYNC_".concat(r)+(e?"_"+e:"")}o(Bb,"getFilterName");var mI=function(r){return r.Offline="offline",r.Online="online",r.Unavailable="unavailable",r}({});function gI(r){return wc({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:eo.Chronological,threadSupport:!1},r)}o(gI,"defaultClientOpts");function yI(r){return wc({canResetEntireTimeline:o(e=>!1,"canResetEntireTimeline")},r)}o(yI,"defaultSyncApiOpts");const tS=class tS{constructor(e,t,n){var i=this;this.client=e,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"_peekRoom",null),f(this,"currentSyncRequest",void 0),f(this,"abortController",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"catchingUp",!1),f(this,"running",!1),f(this,"keepAliveTimer",void 0),f(this,"connectionReturnedResolvers",void 0),f(this,"notifEvents",[]),f(this,"failedSyncCount",0),f(this,"storeIsInvalid",!1),f(this,"presence",void 0),f(this,"getPushRules",R(function*(){try{i.syncOpts.logger.debug("Getting push rules...");var a=yield i.client.getPushRules();i.syncOpts.logger.debug("Got push rules"),i.client.pushRules=a}catch(s){return i.syncOpts.logger.error("Getting push rules failed",s),i.shouldAbortSync(s)?void 0:(i.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,s),i.getPushRules())}})),f(this,"buildDefaultFilter",()=>{var a=new lr(this.client.credentials.userId);return this.client.canSupport.get(Pt.ThreadUnreadNotifications)!==Ot.Unsupported&&a.setUnreadThreadNotifications(!0),a}),f(this,"prepareLazyLoadingForSync",R(function*(){i.syncOpts.logger.debug("Prepare lazy loading for sync..."),i.client.isGuest()&&(i.opts.lazyLoadMembers=!1),i.opts.lazyLoadMembers&&(i.syncOpts.logger.debug("Enabling lazy load on sync filter..."),i.opts.filter||(i.opts.filter=i.buildDefaultFilter()),i.opts.filter.setLazyLoadMembers(!0))})),f(this,"storeClientOptions",R(function*(){try{i.syncOpts.logger.debug("Storing client options..."),yield i.client.storeClientOptions(),i.syncOpts.logger.debug("Stored client options")}catch(a){throw i.syncOpts.logger.error("Storing client options failed",a),a}})),f(this,"getFilter",R(function*(){i.syncOpts.logger.debug("Getting filter...");var a;i.opts.filter?a=i.opts.filter:a=i.buildDefaultFilter();var s;try{s=yield i.client.getOrCreateFilter(Bb(i.client.credentials.userId),a)}catch(l){return i.syncOpts.logger.error("Getting filter failed",l),i.shouldAbortSync(l)?{}:(i.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,l),i.getFilter())}return{filter:a,filterId:s}})),f(this,"savedSyncPromise",void 0),f(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=gI(t),this.syncOpts=yI(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[fe.Timeline,fe.TimelineReset])}createRoom(e){var t=SI(this.client,e,this.opts);return t.on(De.Marker,(n,i)=>{this.onMarkerStateEvent(t,n,i)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:n}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(n){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var i=_1.includes(e.getVersion())||t.getSender()===e.getCreator();i?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(fe.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return R(function*(){var t,n=e.client,i=new lr(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+Fb,s=yield n.getOrCreateFilter(Bb(n.credentials.userId,"LEFT_ROOMS"),i),l={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},u=yield n.http.authedRequest(G.Get,"/sync",l,void 0,{localTimeoutMs:a}),d=[];(t=u.rooms)!==null&&t!==void 0&&t.leave&&(d=e.mapSyncResponseToRoomArray(u.rooms.leave));var c=yield Promise.all(d.map(function(){var h=R(function*(v){var g=v.room;if(v.isBrandNewRoom){v.timeline=v.timeline||{prev_batch:null,events:[]},g.getLiveTimeline().setPaginationToken(v.timeline.prev_batch,me.BACKWARDS);var{timelineEvents:p}=yield e.mapAndInjectRoomEvents(v);return g.recalculate(),n.store.storeRoom(g),n.emit(ve.Room,g),e.processEventsForNotifs(g,p),g}});return function(v){return h.apply(this,arguments)}}()));return c.filter(Boolean)})()}peek(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,n).then(a=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var l=uu(a.state).map(i.getEventMapper()),u=a.state.map(i.getEventMapper()),d=a.messages.chunk.map(i.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(i.getEventMapper()).forEach(function(c){var h=i.store.getUser(c.getContent().user_id);h?h.setPresenceEvent(c):(h=Wn.createUser(c.getContent().user_id,i),h.setPresenceEvent(c),i.store.storeUser(h)),i.emit(ve.Event,c)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(l),this._peekRoom.currentState.setStateEvents(u),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(d.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),i.store.storeRoom(this._peekRoom),i.emit(ve.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,i=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(G.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal}).then(function(){var a=R(function*(s){if(i._peekRoom!==e){i.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}s.chunk.filter(function(u){return u.type==="m.presence"}).map(i.client.getEventMapper()).forEach(u=>{var d=i.client.store.getUser(u.getContent().user_id);d?d.setPresenceEvent(u):(d=Wn.createUser(u.getContent().user_id,i.client),d.setPresenceEvent(u),i.client.store.storeUser(d)),i.client.emit(ve.Event,u)});var l=s.chunk.filter(function(u){return u.room_id===e.roomId&&u.event_id}).map(i.client.getEventMapper());yield e.addLiveEvents(l,{addToState:!0}),i.peekPoll(e,s.end)});return function(s){return a.apply(this,arguments)}}(),a=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var n=this;return R(function*(){yield e;var i=n.startKeepAlives();n.updateSyncState(Ve.Error,{error:t}),yield i})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Ve.Error,{error:e}),!0):!1}sync(){var e=this;return R(function*(){var t,n;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(n=t.addEventListener)===null||n===void 0||n.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var i=e.client.store.getSavedSyncToken().then(c=>(e.syncOpts.logger.debug("Got saved sync token"),c));e.savedSyncPromise=e.client.store.getSavedSync().then(c=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!c)),c)return e.syncFromCache(c)}).catch(c=>{e.syncOpts.logger.error("Getting saved sync failed",c)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:s}=yield e.getFilter();if(s){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var l=a,u=yield i;if(u)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var d=e.buildDefaultFilter();d.setDefinition(s.getDefinition()),d.setTimelineLimit(e.opts.initialSyncLimit),l=JSON.stringify(d.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:l},u)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,n;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(n=this.abortController)===null||n===void 0||n.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return R(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var n=e.nextBatch;t.client.store.setSyncToken(n);var i={nextSyncToken:n,catchingUp:!1,fromCache:!0},a={next_batch:n,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(i,a)}catch(s){t.syncOpts.logger.error("Error processing cached sync",s)}t.storeIsInvalid||t.updateSyncState(Ve.Prepared,i)})()}doSync(e){var t=this;return R(function*(){for(;t.running;){var n=t.client.store.getSyncToken(),i=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,n)),i=yield t.currentSyncRequest}catch(l){var a=yield t.onSyncError(l);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(i.next_batch),t.failedSyncCount=0;var s={oldSyncToken:n??void 0,nextSyncToken:i.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(s,i)}catch(l){t.syncOpts.logger.error("Caught /sync error",l),t.client.emit(ve.SyncUnexpectedError,l)}yield t.client.store.setSyncData(i),s.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(Ve.Prepared,s),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(s)),t.updateSyncState(Ve.Syncing,s),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Ve.Stopped))})()}doSyncRequest(e,t){var n,i=this.getSyncParams(e,t);return this.client.http.authedRequest(G.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+Fb,abortSignal:(n=this.abortController)===null||n===void 0?void 0:n.signal})}getSyncParams(e,t){var n=this.opts.pollTimeout;(this.getSyncState()!==Ve.Syncing||this.catchingUp)&&(this.catchingUp=!0,n=0);var i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());var a={filter:i,timeout:n,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=mI.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[Ve.Reconnecting,Ve.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return R(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Ve.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var n=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=E1?Ve.Error:Ve.Reconnecting,{error:e});var i=yield n;return i&&t.getSyncState()===Ve.Error&&t.updateSyncState(Ve.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return R(function*(){var i,a,s,l,u=n.client;if(Array.isArray((i=t.presence)===null||i===void 0?void 0:i.events)&&t.presence.events.filter(zr).map(u.getEventMapper()).forEach(function(y){var S=u.store.getUser(y.getSender());S?S.setPresenceEvent(y):(S=Wn.createUser(y.getSender(),u),S.setPresenceEvent(y),u.store.storeUser(S)),u.emit(ve.Event,y)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var d=t.account_data.events.filter(zr).map(u.getEventMapper()),c=d.reduce((y,S)=>(y[S.getType()]=u.store.getAccountData(S.getType()),y),{});u.store.storeAccountDataEvents(d),d.forEach(function(y){if(y.getType()===F.PushRules){var S=y.getContent();u.setPushRules(S)}var T=c[y.getType()];return u.emit(ve.AccountData,y,T),y})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var h=t.to_device.events.filter(zr),v;n.syncOpts.cryptoCallbacks?v=yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h):v=h.map(y=>({message:y,encryptionInfo:null})),EI(v,u)}else n.catchingUp=!1;var g=[],p=[],m=[],w=[];t.rooms&&(t.rooms.invite&&(g=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(p=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(m=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(w=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Xa(g,function(){var y=R(function*(S){var T=S.room,C=n.mapSyncEventsFormat(S.invite_state,T);yield n.injectRoomEvents(T,C,void 0),S.isBrandNewRoom?(T.recalculate(),u.store.storeRoom(T),u.emit(ve.Room,T)):T.recalculate(),C.forEach(function(M){u.emit(ve.Event,M)})});return function(S){return y.apply(this,arguments)}}()),yield Xa(p,function(){var y=R(function*(S){var T,C=S.room,M=n.mapSyncEventsFormat(S.state,C),_=n.mapSyncEventsFormat(S["org.matrix.msc4222.state_after"],C),O=n.mapSyncEventsFormat(S.timeline,C,!1),b=n.mapSyncEventsFormat(S.ephemeral),j=n.mapSyncEventsFormat(S.account_data),B=S["org.matrix.msc4222.state_after"]?_:M.concat(O),q=n.isRoomEncrypted(C,B);if(S.unread_notifications){if(!q||S.unread_notifications.notification_count===0){var oe;C.setUnreadNotificationCount(Be.Total,(oe=S.unread_notifications.notification_count)!==null&&oe!==void 0?oe:0)}if(!q||C.getUnreadNotificationCount(Be.Highlight)<=0){var de;C.setUnreadNotificationCount(Be.Highlight,(de=S.unread_notifications.highlight_count)!==null&&de!==void 0?de:0)}}var Ne=(T=S[Nl.name])!==null&&T!==void 0?T:S[Nl.altName];if(Ne){C.resetThreadUnreadNotificationCountFromSync(Object.keys(Ne));for(var[Oe,Ae]of Object.entries(Ne)){if(!q||Ae.notification_count===0){var ae;C.setThreadUnreadNotificationCount(Oe,Be.Total,(ae=Ae.notification_count)!==null&&ae!==void 0?ae:0)}var X=C.getThreadUnreadNotificationCount(Oe,Be.Highlight)<=0;if(!q||q&&X){var ue;C.setThreadUnreadNotificationCount(Oe,Be.Highlight,(ue=Ae.highlight_count)!==null&&ue!==void 0?ue:0)}}}else C.resetThreadUnreadNotificationCountFromSync();if(S.timeline=S.timeline||{},S.isBrandNewRoom)S.timeline.prev_batch!==null&&C.getLiveTimeline().setPaginationToken(S.timeline.prev_batch,me.BACKWARDS);else if(S.timeline.limited){for(var ge=!0,Ce=O.length-1;Ce>=0;Ce--){var J=O[Ce].getId();if(C.getTimelineForEvent(J)){n.syncOpts.logger.debug("Already have event ".concat(J," in limited sync - not resetting")),ge=!1,O.splice(0,Ce);break}}if(ge){var ee;C.resetLiveTimeline(S.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(C.roomId)?null:(ee=e.oldSyncToken)!==null&&ee!==void 0?ee:null),u.resetNotifTimelineSet()}}if(n.syncOpts.cryptoCallbacks)for(var N of B)N.isState()&&N.getType()===F.RoomEncryption&&N.getStateKey()===""&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(C,N));try{"org.matrix.msc4222.state_after"in S?yield n.injectRoomEvents(C,void 0,_,O,e.fromCache):yield n.injectRoomEvents(C,M,void 0,O,e.fromCache)}catch(A){n.syncOpts.logger.error("Failed to process events on room ".concat(C.roomId,":"),A)}S.summary&&C.setSummary(S.summary),C.addEphemeralEvents(b),C.addAccountData(j),C.recalculate(),S.isBrandNewRoom&&(u.store.storeRoom(C),u.emit(ve.Room,C)),n.processEventsForNotifs(C,O);var D=o(A=>u.emit(ve.Event,A),"emitEvent");M.forEach(D),O.forEach(D),b.forEach(D),j.forEach(D),C.decryptCriticalEvents()});return function(S){return y.apply(this,arguments)}}()),yield Xa(m,function(){var y=R(function*(S){var T=S.room,{timelineEvents:C,stateEvents:M,stateAfterEvents:_}=yield n.mapAndInjectRoomEvents(S),O=n.mapSyncEventsFormat(S.account_data);T.addAccountData(O),T.recalculate(),S.isBrandNewRoom&&(u.store.storeRoom(T),u.emit(ve.Room,T)),n.processEventsForNotifs(T,C),M==null||M.forEach(function(b){u.emit(ve.Event,b)}),_==null||_.forEach(function(b){u.emit(ve.Event,b)}),C.forEach(function(b){u.emit(ve.Event,b)}),O.forEach(function(b){u.emit(ve.Event,b)})});return function(S){return y.apply(this,arguments)}}()),yield Xa(w,function(){var y=R(function*(S){var T=S.room,C=n.mapSyncEventsFormat(S.knock_state,T);yield n.injectRoomEvents(T,C,void 0),S.isBrandNewRoom?(T.recalculate(),u.store.storeRoom(T),u.emit(ve.Room,T)):T.recalculate(),C.forEach(function(M){u.emit(ve.Event,M)})});return function(S){return y.apply(this,arguments)}}()),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(y,S){return y.getTs()-S.getTs()}),n.notifEvents.forEach(function(y){var S;(S=u.getNotifTimelineSet())===null||S===void 0||S.addLiveEvent(y,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(s=n.syncOpts.cryptoCallbacks)===null||s===void 0?void 0:s.processKeyCounts(t.device_one_time_keys_count,(l=t.device_unused_fallback_key_types)!==null&&l!==void 0?l:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var n=o(()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)},"success");this.client.http.request(G.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{n()},i=>{i.httpStatus==400||i.httpStatus==404?this.keepAliveTimer=setTimeout(n,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(Ve.Error,{error:i}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(n=>!tl(n)).map(n=>{var i=t.store.getRoom(n),a=!1;return i||(i=this.createRoom(n),a=!0),wc(wc({},e[n]),{},{room:i,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var i=this.client.getEventMapper({decrypt:n});return e.events.filter(zr).map(function(a){return t&&(a.room_id=t.roomId),i(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(ke.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var l=n.events.member;(l==null?void 0:l.getContent().membership)===ke.Invite&&(l.getContent().avatar_url=s.avatar_url,l.getContent().displayname=s.displayname,n.setMembershipEvent(l,e.currentState))},function(s){})}})}}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===F.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return R(function*(){var n=t.mapSyncEventsFormat(e.state,e.room),i=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,i,a):yield t.injectRoomEvents(e.room,n,void 0,a),{timelineEvents:a,stateEvents:n,stateAfterEvents:i}})()}injectRoomEvents(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:!1,u=n??t,d=e.getLiveTimeline(),c=d.getEvents().length==0;if(c){for(var h of u)s.client.getPushActionsForEvent(h);d.initialiseState(u,{timelineWasEmpty:c})}s.resolveInvites(e),e.recalculate(),c||(e.oldState.setStateEvents(u),e.currentState.setStateEvents(u)),yield e.addLiveEvents(i||[],{fromCache:l,timelineWasEmpty:c,addToState:n===void 0}),s.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var n of t){var i,a=this.client.getPushActionsForEvent(n);a!=null&&a.notify&&(i=a.tweaks)!==null&&i!==void 0&&i.highlight&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ve.Sync,this.syncState,n,t)}};o(tS,"SyncApi");let mn=tS;function SI(r,e,t){var{timelineSupport:n}=r,i=new Ys(e,r,r.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:n});return r.reEmitter.reEmit(i,[fe.Name,fe.Redaction,fe.RedactionCancelled,fe.Receipt,fe.Tags,fe.LocalEchoUpdated,fe.AccountData,fe.MyMembership,fe.Timeline,fe.TimelineReset,De.Events,De.Members,De.NewMember,De.Update,Ze.New,Ze.Update,Ze.Destroy,Ze.LivenessChange]),i.on(De.NewMember,(a,s,l)=>{var u;l.user=(u=r.getUser(l.userId))!==null&&u!==void 0?u:void 0,r.reEmitter.reEmit(l,[cr.Name,cr.Typing,cr.PowerLevel,cr.Membership])}),i}o(SI,"_createAndReEmitRoom");function EI(r,e){var t=[];r.map(n=>{if(n.message.type==="m.key.verification.cancel"){var i=n.message.content.transaction_id;i&&t.push(i)}return n}).forEach(function(n){{var i=n.message,a=i.content,s=new Ht(Object.assign({},i));if(i.type==="m.key.verification.start"||i.type==="m.key.verification.request"){var l=a.transaction_id;t.includes(l)&&s.flagCancelled()}n.encryptionInfo&&s.makeEncrypted(F.RoomMessageEncrypted,{ciphertext:""},n.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(ve.ToDeviceEvent,s)}e.emit(ve.ReceivedToDeviceMessage,n)})}o(EI,"processToDeviceMessages");const rS=class rS{constructor(){f(this,"accountData",new Map),f(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,n,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return R(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return R(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return R(function*(){return Promise.resolve()})()}destroy(){return R(function*(){})()}};o(rS,"StubStore");let Bp=rS;const Lt=[];for(let r=0;r<256;++r)Lt.push((r+256).toString(16).slice(1));function b1(r,e=0){return(Lt[r[e+0]]+Lt[r[e+1]]+Lt[r[e+2]]+Lt[r[e+3]]+"-"+Lt[r[e+4]]+Lt[r[e+5]]+"-"+Lt[r[e+6]]+Lt[r[e+7]]+"-"+Lt[r[e+8]]+Lt[r[e+9]]+"-"+Lt[r[e+10]]+Lt[r[e+11]]+Lt[r[e+12]]+Lt[r[e+13]]+Lt[r[e+14]]+Lt[r[e+15]]).toLowerCase()}o(b1,"unsafeStringify");let Af;const w1=new Uint8Array(16);function T1(){if(!Af){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Af=crypto.getRandomValues.bind(crypto)}return Af(w1)}o(T1,"rng");const R1=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),$b={randomUUID:R1};function I1(r,e,t){var i;if($b.randomUUID&&!r)return $b.randomUUID();r=r||{};const n=r.random??((i=r.rng)==null?void 0:i.call(r))??T1();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,b1(n)}o(I1,"v4");var _I={},bI={exports:{}},Wb=bI.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:o(function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"},"format")},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:o(function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"},"format")},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:o(function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"},"format")},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:o(function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")},"format")},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:o(function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"},"format")},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:o(function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e},"format")},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:o(function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e},"format")},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:o(function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"},"format")},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:o(function(r){return r.params?"rid:%s %s %s":"rid:%s %s"},"format")},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:o(function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")},"format")},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:o(function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")},"format")},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:o(function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")},"format")},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:o(function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e},"format")},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Wb).forEach(function(r){var e=Wb[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var wI=bI.exports;(function(r){var e=o(function(l){return String(Number(l))===l?Number(l):l},"toIntIfInt"),t=o(function(l,u,d,c){if(c&&!d)u[c]=e(l[1]);else for(var h=0;h<d.length;h+=1)l[h+1]!=null&&(u[d[h]]=e(l[h+1]))},"attachProperties"),n=o(function(l,u,d){var c=l.name&&l.names;l.push&&!u[l.push]?u[l.push]=[]:c&&!u[l.name]&&(u[l.name]={});var h=l.push?{}:c?u[l.name]:u;t(d.match(l.reg),h,l.names,l.name),l.push&&u[l.push].push(h)},"parseReg"),i=wI,a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(l){var u={},d=[],c=u;return l.split(/(\r\n|\r|\n)/).filter(a).forEach(function(h){var v=h[0],g=h.slice(2);v==="m"&&(d.push({rtp:[],fmtp:[]}),c=d[d.length-1]);for(var p=0;p<(i[v]||[]).length;p+=1){var m=i[v][p];if(m.reg.test(g))return n(m,c,g)}}),u.media=d,u};var s=o(function(l,u){var d=u.split(/=(.+)/,2);return d.length===2?l[d[0]]=e(d[1]):d.length===1&&u.length>1&&(l[d[0]]=void 0),l},"paramReducer");r.parseParams=function(l){return l.split(/;\s?/).reduce(s,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(l){return l.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(l){for(var u=[],d=l.split(" ").map(e),c=0;c<d.length;c+=3)u.push({component:d[c],ip:d[c+1],port:d[c+2]});return u},r.parseImageAttributes=function(l){return l.split(" ").map(function(u){return u.substring(1,u.length-1).split(",").reduce(s,{})})},r.parseSimulcastStreamList=function(l){return l.split(";").map(function(u){return u.split(",").map(function(d){var c,h=!1;return d[0]!=="~"?c=e(d):(c=e(d.substring(1,d.length)),h=!0),{scid:c,paused:h}})})}})(_I);var xf=wI,C1=/%[sdv%]/g,O1=o(function(r){var e=1,t=arguments,n=t.length;return r.replace(C1,function(i){if(e>=n)return i;var a=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(a);case"%d":return Number(a);case"%v":return""}})},"format"),Mo=o(function(r,e,t){var n=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[r+"="+n];if(e.names)for(var a=0;a<e.names.length;a+=1){var s=e.names[a];e.name?i.push(t[e.name][s]):i.push(t[e.names[a]])}else i.push(t[e.name]);return O1.apply(null,i)},"makeLine"),k1=["v","o","s","i","u","e","p","c","b","t","r","z","a"],P1=["i","c","b","a"],M1=o(function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(a){a.payloads==null&&(a.payloads="")});var t=e.outerOrder||k1,n=e.innerOrder||P1,i=[];return t.forEach(function(a){xf[a].forEach(function(s){s.name in r&&r[s.name]!=null?i.push(Mo(a,s,r)):s.push in r&&r[s.push]!=null&&r[s.push].forEach(function(l){i.push(Mo(a,s,l))})})}),r.media.forEach(function(a){i.push(Mo("m",xf.m[0],a)),n.forEach(function(s){xf[s].forEach(function(l){l.name in a&&a[l.name]!=null?i.push(Mo(s,l,a)):l.push in a&&a[l.push]!=null&&a[l.push].forEach(function(u){i.push(Mo(s,l,u))})})})}),i.join(`\r
`)+`\r
`},"writer$1"),Ca=_I,A1=M1,x1=A1,TI=Ca.parse;Ca.parseParams;Ca.parseFmtpConfig;Ca.parsePayloads;Ca.parseRemoteCandidates;Ca.parseImageAttributes;Ca.parseSimulcastStreamList;function iy(r,e){if(typeof r.toBase64=="function")return r.toBase64(e);var t=btoa(r.reduce((n,i)=>n+String.fromCharCode(i),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}o(iy,"toBase64$1");function al(r){return iy(r,{alphabet:"base64",omitPadding:!1})}o(al,"encodeBase64");function RI(r){return iy(r,{alphabet:"base64",omitPadding:!0})}o(RI,"encodeUnpaddedBase64");function Ah(r){return iy(r,{alphabet:"base64url",omitPadding:!0})}o(Ah,"encodeUnpaddedBase64Url");function D1(r,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(r,e):Uint8Array.from(atob(r),t=>t.charCodeAt(0))}o(D1,"fromBase64");function ha(r){return D1(r.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}o(ha,"decodeBase64");var N1="abcdefghijklmnopqrstuvwxyz",L1="ABCDEFGHIJKLMNOPQRSTUVWXYZ",U1="0123456789";function j1(r){var e=new Uint8Array(r);return globalThis.crypto.getRandomValues(e),Ah(e)}o(j1,"secureRandomBase64Url");function ki(r){return F1(r,L1+N1+U1)}o(ki,"secureRandomString");function F1(r,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(r<1||r>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,n=new Uint8Array(Math.floor(r*1.3)),i=n.length,a=[];a.length<r;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var s=n[i++];s<t&&a.push(e[s%e.length])}return a.join("")}o(F1,"secureRandomStringFrom");var ni="org.matrix.msc3077.sdp_stream_metadata",Je=function(r){return r.Usermedia="m.usermedia",r.Screenshare="m.screenshare",r}({}),sl=null,$p=0,B1=o(()=>(sl===null&&(sl=new AudioContext),$p++,sl),"acquireContext"),$1=o(()=>{if($p--,$p===0){var r;(r=sl)===null||r===void 0||r.close(),sl=null}},"releaseContext"),W1=200,Wp=-60,K1=8,ln=function(r){return r.NewStream="new_stream",r.MuteStateChanged="mute_state_changed",r.LocalVolumeChanged="local_volume_changed",r.VolumeChanged="volume_changed",r.ConnectedChanged="connected_changed",r.Speaking="speaking",r.Disposed="disposed",r}({});const Yc=class Yc extends Qe{constructor(e){super(),f(this,"stream",void 0),f(this,"sdpMetadataStreamId",void 0),f(this,"userId",void 0),f(this,"deviceId",void 0),f(this,"purpose",void 0),f(this,"speakingVolumeSamples",void 0),f(this,"client",void 0),f(this,"call",void 0),f(this,"roomId",void 0),f(this,"audioMuted",void 0),f(this,"videoMuted",void 0),f(this,"localVolume",1),f(this,"measuringVolumeActivity",!1),f(this,"audioContext",void 0),f(this,"analyser",void 0),f(this,"frequencyBinCount",void 0),f(this,"speakingThreshold",Wp),f(this,"speaking",!1),f(this,"volumeLooperTimeout",void 0),f(this,"_disposed",!1),f(this,"_connected",!1),f(this,"onAddTrack",()=>{this.emit(ln.NewStream,this.stream)}),f(this,"onCallState",t=>{t===Ie.Connected?this.connected=!0:t===Ie.Connecting&&(this.connected=!1)}),f(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(ln.VolumeChanged,t);var i=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.emit(ln.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,W1)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(K1).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(xe.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(ln.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var n=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),n&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(ln.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=B1()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t==null?void 0:t.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(ln.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(ln.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return I.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Je.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new Yc({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(xe.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,$1()),this._disposed=!0,this.emit(ln.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(ln.LocalVolumeChanged,e)}};o(Yc,"CallFeed");let Dn=Yc;var V1=3e3,Kp=function(r){return r.Incoming="Call.incoming",r}({});const nS=class nS{constructor(e){f(this,"calls",void 0),f(this,"callEventBuffer",void 0),f(this,"nextSeqByCall",new Map),f(this,"toDeviceEventBuffers",new Map),f(this,"client",void 0),f(this,"candidateEventsByCall",void 0),f(this,"eventBufferPromiseChain",void 0),f(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),f(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),f(this,"onToDeviceEvent",t=>{var n=t.getContent();if(!n.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(n.call_id)||this.nextSeqByCall.set(n.call_id,0),n.seq===void 0){this.callEventBuffer.push(t);return}var i=this.nextSeqByCall.get(n.call_id)||0;if(n.seq!==i){this.toDeviceEventBuffers.has(n.call_id)||this.toDeviceEventBuffers.set(n.call_id,[]);var a=this.toDeviceEventBuffers.get(n.call_id),s=a.findIndex(c=>c.getContent().seq>n.seq);s===-1?a.push(t):a.splice(s,0,t)}else{var l=n.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(l,n.seq+1);for(var u=this.toDeviceEventBuffers.get(l),d=u&&u.shift();d&&d.getContent().seq===this.nextSeqByCall.get(l);)this.callEventBuffer.push(d),this.nextSeqByCall.set(l,d.getContent().seq+1),d=u.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ve.Sync,this.onSync),this.client.on(fe.Timeline,this.onRoomTimeline),this.client.on(ve.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ve.Sync,this.onSync),this.client.removeListener(fe.Timeline,this.onRoomTimeline),this.client.removeListener(ve.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return R(function*(){yield Promise.all(e.map(c=>t.client.decryptEventIfNeeded(c)));var n=e.filter(c=>{var h=c.getType();return h.startsWith("m.call.")||h.startsWith("org.matrix.call.")}),i=new Set;for(var a of n){var s=a.getType();(s===F.CallAnswer||s===F.CallHangup)&&i.add(a.getContent().call_id)}for(var l of n){var u=l.getType(),d=l.getContent().call_id;if(!(u===F.CallInvite&&i.has(d)))try{yield t.handleCallEvent(l)}catch(c){I.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",c)}}})()}handleCallEvent(e){var t=this;return R(function*(){var n;t.client.emit(ve.ReceivedVoipEvent,e);var i=e.getContent(),a=e.getRoomId()||((n=t.client.groupCallEventHandler.getGroupCallById(i.conf_id))===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.roomId),s=i.conf_id,l=e.getType(),u=e.getSender(),d=i.call_id?t.calls.get(i.call_id):void 0,c,h;if(s){if(h=t.client.groupCallEventHandler.getGroupCallById(s),!h){I.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(s,", type=").concat(l,")"));return}if(c=i.device_id,!c){I.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(u,")")),h.emit(ze.Error,new Rc(u));return}if(i.dest_session_id!==t.client.getSessionId()){I.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var v=u===t.client.credentials.userId&&(c===void 0||c===t.client.getDeviceId());if(a){if(l===F.CallInvite){var g,p,m;if(v||e.getLocalAge()>i.lifetime-V1||d&&d.state===Ie.Ended||(d&&I.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(i.call_id,")")),i.invitee&&i.invitee!==t.client.getUserId()))return;var w=((g=t.client.getTurnServersExpiry())!==null&&g!==void 0?g:0)-Date.now();if(I.info("CallEventHandler handleCallEvent() current turn creds expire in "+w+" ms"),d=(p=$l(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:c,groupCallId:s,opponentSessionId:i.sender_session_id}))!==null&&p!==void 0?p:void 0,!d){I.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(i.call_id,")"));return}d.callId=i.call_id;var y=(m=h)===null||m===void 0?void 0:m.getGroupCallStats();y&&d.initStats(y);try{yield d.initWithInvite(e)}catch(j){if(j instanceof qr)if(j.code===ol.UnknownDevice){var S;(S=h)===null||S===void 0||S.emit(ze.Error,j)}else I.error(j)}if(t.calls.set(d.callId,d),t.candidateEventsByCall.get(d.callId))for(var T of t.candidateEventsByCall.get(d.callId))d.onRemoteIceCandidatesReceived(T);var C;for(var M of t.calls.values()){var _,O=[Ie.WaitLocalMedia,Ie.CreateOffer,Ie.InviteSent].includes(M.state);if(d.roomId===M.roomId&&M.direction===oi.Outbound&&((_=d.getOpponentMember())===null||_===void 0?void 0:_.userId)===M.invitee&&O){C=M;break}}C?C.callId>d.callId?(I.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(d.callId,", outgoingId=").concat(C.callId,")")),C.replacedBy(d)):(I.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(d.callId,", outgoingId=").concat(C.callId,")")),d.hangup(Pe.Replaced,!0)):t.client.emit(Kp.Incoming,d);return}else if(l===F.CallCandidates){if(v)return;d?d.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(i.call_id)||t.candidateEventsByCall.set(i.call_id,[]),t.candidateEventsByCall.get(i.call_id).push(e));return}else if([F.CallHangup,F.CallReject].includes(l)){if(d)d.state!==Ie.Ended&&(l===F.CallHangup?d.onHangupReceived(i):d.onRejectReceived(i),d.state===Ie.Ended&&t.calls.delete(i.call_id));else{var b;d=(b=$l(t.client,a,{opponentDeviceId:c,opponentSessionId:i.sender_session_id}))!==null&&b!==void 0?b:void 0,d&&(d.callId=i.call_id,d.initWithHangup(e),t.calls.set(i.call_id,d))}return}if(!d||!d.hasPeerConnection){I.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(l,")"));return}if(e.getContent().party_id!==d.ourPartyId)switch(l){case F.CallAnswer:v?d.state===Ie.Ringing&&d.onAnsweredElsewhere(i):d.onAnswerReceived(e);break;case F.CallSelectAnswer:d.onSelectAnswerReceived(e);break;case F.CallNegotiate:d.onNegotiateReceived(e);break;case F.CallAssertedIdentity:case F.CallAssertedIdentityPrefix:d.onAssertedIdentityReceived(e);break;case F.CallSDPStreamMetadataChanged:case F.CallSDPStreamMetadataChangedPrefix:d.onSDPStreamMetadataChangedReceived(e);break}}})()}};o(nS,"CallEventHandler");let Vp=nS;var Gp=function(r){return r.Incoming="GroupCall.incoming",r.Outgoing="GroupCall.outgoing",r.Ended="GroupCall.ended",r.Participants="GroupCall.participants",r}({});const iS=class iS{constructor(e){this.client=e,f(this,"groupCalls",new Map),f(this,"roomDeferreds",new Map),f(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),f(this,"onRoomStateChanged",(t,n)=>{var i=t.getType();if(i===F.GroupCallPrefix){var a=t.getStateKey(),s=t.getContent(),l=this.groupCalls.get(n.roomId);!l&&!s["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):l&&l.groupCallId===a?s["m.terminated"]||t.isRedacted()?l.terminate(!1):s["m.type"]!==l.type&&I.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(n.roomId,")")):l&&l.groupCallId!==a&&I.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(n.roomId,")"))}})}start(){var e=this;return R(function*(){e.client.getSyncState()!==Ve.Syncing&&(I.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(i=>{var a=o(()=>{if(e.client.getSyncState()===Ve.Syncing)return e.client.off(ve.Sync,a),i()},"onSync");e.client.on(ve.Sync,a)}));var t=e.client.getRooms();for(var n of t)e.createGroupCallForRoom(n);e.client.on(ve.Room,e.onRoomsChanged),e.client.on(De.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(ve.Room,this.onRoomsChanged),this.client.removeListener(De.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var n;t={prom:new Promise(i=>{n=i})},t.resolve=n,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(F.GroupCallPrefix),n=t.sort((s,l)=>l.getTs()-s.getTs());for(var i of n){var a=i.getContent();if(!(a["m.terminated"]||i.isRedacted())){I.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(i.getStateKey(),", ts=").concat(i.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(i);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(t);if(!i){I.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),s=n["m.type"];if(!Object.values(xh).includes(s)){I.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(t,")"));return}var l=n["m.intent"];if(!Object.values(II).includes(l)){I.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(t,")"));return}var u=!!n["io.element.ptt"],d;if(n!=null&&n.dataChannelsEnabled&&n!==null&&n!==void 0&&n.dataChannelOptions){var{ordered:c,maxPacketLifeTime:h,maxRetransmits:v,protocol:g}=n.dataChannelOptions;d={ordered:c,maxPacketLifeTime:h,maxRetransmits:v,protocol:g}}var p=new Bl(this.client,i,s,u,l,a,(n==null?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,d,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,p),this.client.emit(Gp.Incoming,p),p}};o(iS,"GroupCallEventHandler");let qp=iS;const aS=class aS{constructor(){f(this,"bandwidth",{}),f(this,"bitrate",{}),f(this,"packetLoss",{}),f(this,"transport",[])}};o(aS,"ConnectionStats");let Hp=aS;const sS=class sS{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,n=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:n?Math.round(n/1e3):0}}};o(sS,"ConnectionStatsBuilder");let zp=sS;const oS=class oS{static buildReport(e,t,n,i){var a=e==null?void 0:e.get(t.localCandidateId),s=e==null?void 0:e.get(t.remoteCandidateId);if(s&&a){var l=s.ip!==void 0?s.ip:s.address,u=s.port,d="".concat(l,":").concat(u),c=a.ip!==void 0?a.ip:a.address,h=a.port,v="".concat(c,":").concat(h),g=s.protocol;n.some(p=>p.ip===d&&p.type===g&&p.localIp===v)||n.push({ip:d,type:g,localIp:v,isFocus:i,localCandidateType:a.candidateType,remoteCandidateType:s.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return n}};o(oS,"TransportStatsBuilder");let Jp=oS;const lS=class lS{constructor(){f(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var n;return this.ssrcToMid[t].forEach((i,a)=>{if(i.find(s=>s==e)){n=a;return}}),n}parse(e,t){var n=TI(e),i=new Map;n.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var s,l=[];(s=a.ssrcs)===null||s===void 0||s.forEach(u=>{u.attribute==="cname"&&l.push("".concat(u.id))}),i.set("".concat(a.mid),l)}}),this.ssrcToMid[t]=i}getSsrcToMidMap(e){return this.ssrcToMid[e]}};o(lS,"MediaSsrcHandler");let Qp=lS;const uS=class uS{constructor(e){this.pc=e}getLocalTracks(e){var t=o(n=>n!==null&&n.kind===e,"isNotNullAndKind");return this.pc.getTransceivers().filter(n=>n.currentDirection==="sendonly"||n.currentDirection==="sendrecv").filter(n=>n.sender!==null).map(n=>n.sender).map(n=>n.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,n=this.pc.getTransceivers().find(i=>i.mid===e);return n==null||(t=n.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}};o(uS,"MediaTrackHandler");let Yp=uS;const dS=class dS{constructor(e,t,n){this.trackId=e,this.type=t,this.kind=n,f(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),f(this,"bitrate",{download:0,upload:0}),f(this,"resolution",{width:-1,height:-1}),f(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),f(this,"framerate",0),f(this,"jitter",0),f(this,"codec",""),f(this,"isAlive",!0),f(this,"isMuted",!1),f(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}};o(dS,"MediaTrackStats");let Xp=dS;const cS=class cS{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,f(this,"track2stats",new Map)}findTrack2Stats(e,t){var n;if(e.trackIdentifier)n=e.trackIdentifier;else if(e.mid)n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var i=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!i)return;n=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(n){var a=this.track2stats.get(n);if(!a){var s=this.mediaTrackHandler.getTackById(n);if(s!==void 0){var l=s.kind==="audio"?s.kind:"video";a=new Xp(n,t,l),this.track2stats.set(n,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}};o(cS,"MediaTrackStatsHandler");let Zp=cS;const hS=class hS{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}};o(hS,"ValueFormatter");let An=hS;const Xc=class Xc{static buildFramerateResolution(e,t){var n={height:t.frameHeight,width:t.frameWidth},i=t.framesPerSecond;n.height&&n.width&&e.setResolution(n),e.setFramerate(Math.round(i||0))}static calculateSimulcastFramerate(e,t,n,i){var a=e.getFramerate();if(!a){if(n){var s=t.timestamp-n.timestamp;if(s>0&&t.framesSent){var l=t.framesSent-n.framesSent;a=l/s*1e3}}if(!a)return}a=i?Math.round(a/i):0,e.setFramerate(a)}static buildCodec(e,t,n){var i=e==null?void 0:e.get(n.codecId);if(i){var a=i.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,n){e.setBitrate({download:Xc.calculateBitrate(t.bytesReceived,n.bytesReceived,t.timestamp,n.timestamp),upload:0})}static buildBitrateSend(e,t,n){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,n.bytesSent,t.timestamp,n.timestamp)})}static buildPacketsLost(e,t,n){var i=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[i];(!a||a<0)&&(a=0);var s=An.getNonNegativeValue(n[i]),l=Math.max(0,a-s),u=An.getNonNegativeValue(t.packetsLost),d=An.getNonNegativeValue(n.packetsLost),c=Math.max(0,u-d);e.setLoss({packetsTotal:l+c,packetsLost:c,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,n,i){var a=An.getNonNegativeValue(e),s=An.getNonNegativeValue(t),l=Math.max(0,a-s),u=n-i,d=0;return u>0&&(d=Math.round(l*8/u)),d}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}var i=e.getType()==="remote"?t.receiver.track:t==null||(n=t.sender)===null||n===void 0?void 0:n.track;if(i==null){e.alive=!1;return}if(i.readyState==="ended"){e.alive=!1;return}e.muted=i.muted,e.enabled=i.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i=e.filter(s=>s.getType()==="remote"),a=i.filter(s=>s.kind==="audio");return i.forEach(s=>{var l=s.kind==="video"?t:n;if(l.count++,s.alive&&s.muted&&l.muted++,l.maxJitter<s.getJitter()&&(l.maxJitter=s.getJitter()),l.maxPacketLoss<s.getLoss().packetsLost&&(l.maxPacketLoss=s.getLoss().packetsLost),a.length>0){var u,d;l.concealedAudio+=(u=s.getAudioConcealment())===null||u===void 0?void 0:u.concealedAudio,l.totalAudio+=(d=s.getAudioConcealment())===null||d===void 0?void 0:d.totalAudioDuration}}),{audioTrackSummary:n,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var n=t==null?void 0:t.jitter;if(n!==void 0){var i=An.getNonNegativeValue(n);e.setJitter(Math.round(i*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var n=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived),i=n*(t==null?void 0:t.concealedSamples),a=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(i,a)}}};o(Xc,"TrackStatsBuilder");let Sr=Xc;const Za=class Za{static build(e){var t={},n={download:0,upload:0},i={download:0,upload:0},a=0,s=0,l={local:new Map,remote:new Map},u={local:new Map,remote:new Map},d={local:new Map,remote:new Map},c=new Map,h=new Map,v=0,g=0,p=0,m=0,w=0,y=0;for(var[S,T]of e){var C=T.getLoss(),M=C.isDownloadStream?"download":"upload";if(n[M]+=C.packetsTotal,i[M]+=C.packetsLost,a+=T.getBitrate().download,s+=T.getBitrate().upload,T.kind==="audio"){var _=T.getAudioConcealment();w+=_.concealedAudio,y+=_.totalAudioDuration,v+=T.getBitrate().download,g+=T.getBitrate().upload}else p+=T.getBitrate().download,m+=T.getBitrate().upload;l[T.getType()].set(S,T.getResolution()),u[T.getType()].set(S,T.getFramerate()),d[T.getType()].set(S,T.getCodec()),T.getType()==="remote"&&(c.set(S,T.getJitter()),T.kind==="audio"&&h.set(S,T.getAudioConcealment())),T.resetBitrate()}return t.bitrate={upload:s,download:a},t.bitrate.audio={upload:g,download:v},t.bitrate.video={upload:m,download:p},t.packetLoss={total:Za.calculatePacketLoss(i.download+i.upload,n.download+n.upload),download:Za.calculatePacketLoss(i.download,n.download),upload:Za.calculatePacketLoss(i.upload,n.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:w,totalAudioDuration:y},t.framerate=u,t.resolution=l,t.codec=d,t.jitter=c,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}};o(Za,"ConnectionStatsReportBuilder");let em=Za;const ra=class ra{static buildCallFeedReport(e,t,n){var i=n.getTransceivers(),a=[],s=[];return i.forEach(l=>{var u,d=(u=l.sender)!==null&&u!==void 0&&u.track?ra.buildTrackStats(l.sender.track,"sender"):null,c=ra.buildTrackStats(l.receiver.track,"receiver");a.push({mid:l.mid==null?"null":l.mid,direction:l.direction,currentDirection:l.currentDirection==null?"null":l.currentDirection,sender:d,receiver:c})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:s}}static buildTrackStats(e){var t,n,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,s=(n=e.getConstraints())===null||n===void 0?void 0:n.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:s??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:i}}static expandCallFeedReport(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(i=>{var a=i.stream.getAudioTracks(),s=i.stream.getVideoTracks(),l=a.length>0?ra.buildTrackStats(i.stream.getAudioTracks()[0],i.purpose):null,u=s.length>0?ra.buildTrackStats(i.stream.getVideoTracks()[0],i.purpose):null,d={stream:i.stream.id,type:i.isLocal()?"local":"remote",audio:l,video:u,purpose:i.purpose,prefix:n,isVideoMuted:i.isVideoMuted(),isAudioMuted:i.isAudioMuted()};e.callFeeds.push(d)}),e}};o(ra,"CallFeedStatsReporter");let jl=ra;function Kb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Kb,"ownKeys$b");function Gu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Kb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Kb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Gu,"_objectSpread$b");const fS=class fS{constructor(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=n,this.emitter=i,this.isFocus=a,f(this,"isActive",!0),f(this,"previousStatsReport",void 0),f(this,"currentStatsReport",void 0),f(this,"connectionStats",new Hp),f(this,"trackStats",void 0),n.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new Zp(new Qp,new Yp(n))}processStats(e,t){var n=this;return R(function*(){var i={isFirstCollection:n.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var a=n.pc.getStats();if(typeof(a==null?void 0:a.then)=="function")return a.then(s=>{var l,u;n.currentStatsReport=typeof(s==null?void 0:s.result)=="function"?s.result():s;try{n.processStatsReport(e,t)}catch(c){return n.handleError(c),i}n.previousStatsReport=n.currentStatsReport,i.receivedMedia=n.connectionStats.bitrate.download,i.receivedAudioMedia=((l=n.connectionStats.bitrate.audio)===null||l===void 0?void 0:l.download)||0,i.receivedVideoMedia=((u=n.connectionStats.bitrate.video)===null||u===void 0?void 0:u.download)||0;var d=Sr.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return Gu(Gu({},i),{},{audioTrackSummary:d.audioTrackSummary,videoTrackSummary:d.videoTrackSummary})}).catch(s=>(n.handleError(s),i));n.isActive=!1}return Promise.resolve(i)})()}processStatsReport(e,t){var n,i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)===null||n===void 0||n.forEach(a=>{var s=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=zp.buildBandwidthReport(a),this.connectionStats.transport=Jp.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var l=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!l)return;if(s&&Sr.buildPacketsLost(l,a,s),a.type==="inbound-rtp"){Sr.buildFramerateResolution(l,a),s&&Sr.buildBitrateReceived(l,a,s);var u=this.trackStats.findTransceiverByTrackId(l.trackId);Sr.setTrackStatsState(l,u),Sr.buildJitter(l,a),Sr.buildAudioConcealment(l,a)}else s&&(i.set(l.trackId,An.getNonNegativeValue(a.bytesSent)),Sr.buildBitrateSend(l,a,s));Sr.buildCodec(this.currentStatsReport,l,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var d=this.trackStats.findLocalVideoTrackStats(a);if(!d)return;Sr.buildFramerateResolution(d,a),Sr.calculateSimulcastFramerate(d,a,s,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(jl.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,I.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=em.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(Gu(Gu({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}};o(fS,"CallStatsReportGatherer");let tm=fS;var jn=function(r){return r.CONNECTION_STATS="StatsReport.connection_stats",r.CALL_FEED_REPORT="StatsReport.call_feed_report",r.BYTE_SENT_STATS="StatsReport.byte_sent_stats",r.SUMMARY_STATS="StatsReport.summary_stats",r}({});const vS=class vS extends Qe{emitByteSendReport(e){this.emit(jn.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(jn.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(jn.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(jn.SUMMARY_STATS,e)}};o(vS,"StatsReportEmitter");let rm=vS;const pS=class pS{constructor(e){this.emitter=e}build(e){var t=e.filter(c=>!c.isFirstCollection),n=t.length,i=e.length;if(n!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},s=0,l=0;t.forEach(c=>{this.countTrackListReceivedMedia(a,c),this.countConcealedAudio(a,c),s=this.buildMaxJitter(s,c),l=this.buildMaxPacketLoss(l,c)});var u=5,d={percentageReceivedMedia:Number((a.receivedMedia/n).toFixed(u)),percentageReceivedVideoMedia:Number((a.receivedVideo/n).toFixed(u)),percentageReceivedAudioMedia:Number((a.receivedAudio/n).toFixed(u)),maxJitter:s,maxPacketLoss:l,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(u):0),peerConnections:i};this.emitter.emitSummaryStatsReport(d)}}static extendSummaryReport(e,t){var n=[],i=[];for(var a of t){i.push(a);for(var s of a[1])n.push(s)}e.opponentDevicesInCall=Math.max(0,n.length-1),e.opponentUsersInCall=Math.max(0,i.length-1),e.diffDevicesToPeerConnections=Math.max(0,n.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,n.length-1)==0?0:e.peerConnections/(n.length-1)}countTrackListReceivedMedia(e,t){var n=!1,i=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,n=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,i=!0),i&&n&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}};o(pS,"SummaryStatsReportGatherer");let Tc=pS;const mS=class mS{constructor(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=n,f(this,"timer",void 0),f(this,"gatherers",new Map),f(this,"reports",new rm),f(this,"summaryStatsReportGatherer",new Tc(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,n){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new tm(e,t,n,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var n;(n=this.getStatsReportGatherer(e))===null||n===void 0||n.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{I.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}};o(mS,"GroupCallStats");let nm=mS;function Vb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Vb,"ownKeys$a");function qu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Vb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Vb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(qu,"_objectSpread$a");var II=function(r){return r.Ring="m.ring",r.Prompt="m.prompt",r.Room="m.room",r}({}),xh=function(r){return r.Video="m.video",r.Voice="m.voice",r}({}),G1=function(r){return r.CallEnded="call_ended",r}({}),ze=function(r){return r.GroupCallStateChanged="group_call_state_changed",r.ActiveSpeakerChanged="active_speaker_changed",r.CallsChanged="calls_changed",r.UserMediaFeedsChanged="user_media_feeds_changed",r.ScreenshareFeedsChanged="screenshare_feeds_changed",r.LocalScreenshareStateChanged="local_screenshare_state_changed",r.LocalMuteStateChanged="local_mute_state_changed",r.ParticipantsChanged="participants_changed",r.Error="group_call_error",r}({}),Ko=function(r){return r.ConnectionStats="GroupCall.connection_stats",r.ByteSentStats="GroupCall.byte_sent_stats",r.SummaryStats="GroupCall.summary_stats",r.CallFeedStats="GroupCall.call_feed_stats",r}({}),ol=function(r){return r.NoUserMedia="no_user_media",r.UnknownDevice="unknown_device",r.PlaceCallFailed="place_call_failed",r}({});const gS=class gS extends Error{constructor(e,t,n){n?(super(t+": "+n),f(this,"code",void 0)):(super(t),f(this,"code",void 0)),this.code=e}};o(gS,"GroupCallError");let Fl=gS;const yS=class yS extends Fl{constructor(e){super(ol.UnknownDevice,"No device found for "+e),this.userId=e}};o(yS,"GroupCallUnknownDeviceError");let Rc=yS;var at=function(r){return r.LocalCallFeedUninitialized="local_call_feed_uninitialized",r.InitializingLocalCallFeed="initializing_local_call_feed",r.LocalCallFeedInitialized="local_call_feed_initialized",r.Entered="entered",r.Ended="ended",r}({}),Gb=1e3*60*60;function Hu(r){var e;return((e=r.getOpponentMember())===null||e===void 0?void 0:e.userId)||r.invitee||null}o(Hu,"getCallUserId");const SS=class SS extends Qe{constructor(e,t,n,i,a,s,l,u,d){var c,h,v=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,g=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=n,this.isPtt=i,this.intent=a,this.dataChannelsEnabled=l,this.dataChannelOptions=u,this.useLivekit=v,f(this,"activeSpeakerInterval",1e3),f(this,"retryCallInterval",5e3),f(this,"participantTimeout",1e3*15),f(this,"pttMaxTransmitTime",1e3*20),f(this,"activeSpeaker",void 0),f(this,"localCallFeed",void 0),f(this,"localScreenshareFeed",void 0),f(this,"localDesktopCapturerSourceId",void 0),f(this,"userMediaFeeds",[]),f(this,"screenshareFeeds",[]),f(this,"groupCallId",void 0),f(this,"allowCallWithoutVideoAndAudio",void 0),f(this,"calls",new Map),f(this,"callHandlers",new Map),f(this,"activeSpeakerLoopInterval",void 0),f(this,"retryCallLoopInterval",void 0),f(this,"retryCallCounts",new Map),f(this,"reEmitter",void 0),f(this,"transmitTimer",null),f(this,"participantsExpirationTimer",null),f(this,"resendMemberStateTimer",null),f(this,"initWithAudioMuted",!1),f(this,"initWithVideoMuted",!1),f(this,"initCallFeedPromise",void 0),f(this,"_livekitServiceURL",void 0),f(this,"stats",void 0),f(this,"statsCollectIntervalTime",0),f(this,"onConnectionStats",p=>{this.emit(Ko.ConnectionStats,{report:p})}),f(this,"onByteSentStats",p=>{this.emit(Ko.ByteSentStats,{report:p})}),f(this,"onSummaryStats",p=>{Tc.extendSummaryReport(p,this.participants),this.emit(Ko.SummaryStats,{report:p})}),f(this,"onCallFeedReport",p=>{this.localCallFeed&&(p=jl.expandCallFeedReport(p,[this.localCallFeed],"from-local-feed"));var m=[];this.forEachCall(w=>{w.callId===p.callId&&w.getFeeds().forEach(y=>m.push(y))}),p=jl.expandCallFeedReport(p,m,"from-call-feed"),this.emit(Ko.CallFeedStats,{report:p})}),f(this,"_state",at.LocalCallFeedUninitialized),f(this,"_participants",new Map),f(this,"_creationTs",null),f(this,"_enteredViaAnotherSession",!1),f(this,"onIncomingCall",p=>{var m,w;if(p.roomId===this.room.roomId){if(p.state!==Ie.Ringing){I.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!p.groupCallId||p.groupCallId!==this.groupCallId){I.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),p.reject();return}var y=(m=p.getOpponentMember())===null||m===void 0?void 0:m.userId;if(y===void 0){I.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){I.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var S=(w=this.calls.get(y))!==null&&w!==void 0?w:new Map,T=S.get(p.getOpponentDeviceId());if((T==null?void 0:T.callId)!==p.callId){I.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(y,", callId=").concat(p.callId,")")),T&&T.hangup(Pe.Replaced,!1),S.set(p.getOpponentDeviceId(),p),this.calls.set(y,S),this.initCall(p);var C=this.getLocalFeeds().map(_=>_.clone());if(!this.callExpected(p))for(var M of C)St(M.stream.getAudioTracks(),!1),St(M.stream.getVideoTracks(),!1);p.answerWithCallFeeds(C),this.emit(ze.CallsChanged,this.calls)}}}),f(this,"onRetryCallLoop",()=>{var p=!1;for(var[{userId:m},w]of this.participants){var y=this.calls.get(m),S=this.retryCallCounts.get(m);for(var[T,C]of w){var M,_,O=y==null?void 0:y.get(T),b=(M=(_=S)===null||_===void 0?void 0:_.get(T))!==null&&M!==void 0?M:0;(O==null?void 0:O.getOpponentSessionId())!==C.sessionId&&this.wantsOutgoingCall(m,T)&&b<3&&(S===void 0&&(S=new Map,this.retryCallCounts.set(m,S)),S.set(T,b+1),p=!0)}}p&&this.placeOutgoingCalls()}),f(this,"onCallFeedsChanged",p=>{var m=Hu(p),w=p.getOpponentDeviceId();if(!m)throw new Error("Cannot change call feeds without user id");var y=this.getUserMediaFeed(m,w),S=p.remoteUsermediaFeed,T=S!==y,C=this.calls.get(m),M=C==null?void 0:C.get(w);if((M==null?void 0:M.callId)===p.callId){T&&(!y&&S?this.addUserMediaFeed(S):y&&S?this.replaceUserMediaFeed(y,S):y&&!S&&this.removeUserMediaFeed(y));var _=this.getScreenshareFeed(m,w),O=p.remoteScreensharingFeed,b=O!==_;b&&(!_&&O?this.addScreenshareFeed(O):_&&O?this.replaceScreenshareFeed(_,O):_&&!O&&this.removeScreenshareFeed(_))}}),f(this,"onCallStateChanged",(p,m,w)=>{var y;if(m!==Ie.Ended){var S=this.localCallFeed.isAudioMuted();p.localUsermediaStream&&p.isMicrophoneMuted()!==S&&p.setMicrophoneMuted(S);var T=this.localCallFeed.isVideoMuted();p.localUsermediaStream&&p.isLocalVideoMuted()!==T&&p.setLocalVideoMuted(T);var C=(y=p.getOpponentMember())===null||y===void 0?void 0:y.userId;if(m===Ie.Connected&&C){var M=this.retryCallCounts.get(C);M==null||M.delete(p.getOpponentDeviceId()),(M==null?void 0:M.size)===0&&this.retryCallCounts.delete(C)}}}),f(this,"onCallHangup",p=>{var m,w;if(p.hangupReason!==Pe.Replaced){var y=(m=(w=p.getOpponentMember())===null||w===void 0?void 0:w.userId)!==null&&m!==void 0?m:this.room.getMember(p.invitee).userId,S=this.calls.get(y);(S==null?void 0:S.get(p.getOpponentDeviceId()))===p&&(this.disposeCall(p,p.hangupReason),S.delete(p.getOpponentDeviceId()),S.size===0&&this.calls.delete(y),this.emit(ze.CallsChanged,this.calls))}}),f(this,"onCallReplaced",(p,m)=>{var w=p.getOpponentMember().userId,y=this.calls.get(w);y===void 0&&(y=new Map,this.calls.set(w,y)),p.hangup(Pe.Replaced,!1),this.initCall(m),y.set(p.getOpponentDeviceId(),m),this.emit(ze.CallsChanged,this.calls)}),f(this,"onActiveSpeakerLoop",()=>{var p=void 0,m=void 0;for(var w of this.userMediaFeeds)if(!(w.isLocal()&&this.userMediaFeeds.length>1)){var y=w.speakingVolumeSamples.reduce((T,C)=>T+Math.max(C,Wp)),S=y/w.speakingVolumeSamples.length;(!p||S>p)&&(p=S,m=w)}m&&this.activeSpeaker!==m&&p&&p>Wp&&(this.activeSpeaker=m,this.emit(ze.ActiveSpeakerChanged,this.activeSpeaker))}),f(this,"onRoomState",()=>this.updateParticipants()),f(this,"onParticipantsChanged",()=>{this.forEachCall(p=>{var m=this.callExpected(p);for(var w of p.getLocalFeeds())St(w.stream.getAudioTracks(),!w.isAudioMuted()&&m),St(w.stream.getVideoTracks(),!w.isVideoMuted()&&m)}),this.state===at.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),f(this,"onStateChanged",(p,m)=>{(p===at.Entered||m===at.Entered||p===at.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(w=>I.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),w)))}),f(this,"onLocalFeedsChanged",()=>{this.state===at.Entered&&this.updateMemberState().catch(p=>I.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),p))}),this.reEmitter=new cc(this),this.groupCallId=s??Xi(),this._livekitServiceURL=g,this.creationTs=(c=(h=t.currentState.getStateEvents(F.GroupCallPrefix,this.groupCallId))===null||h===void 0?void 0:h.getTs())!==null&&c!==void 0?c:null,this.updateParticipants(),t.on(De.Update,this.onRoomState),this.on(ze.ParticipantsChanged,this.onParticipantsChanged),this.on(ze.GroupCallStateChanged,this.onStateChanged),this.on(ze.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!d}create(){var e=this;return R(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(Gp.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return R(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,F.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(ze.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,n=o((a,s)=>a.sessionId===s.sessionId&&a.screensharing===s.screensharing,"participantStateEqual"),i=o((a,s)=>X_(a,s,n),"deviceMapsEqual");X_(e,t,i)||(this._participants=e,this.emit(ze.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var n of t.values())e(n)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,n=Hu(e),i=n===null?null:this.room.getMember(n),a=e.getOpponentDeviceId();return i!==null&&a!==void 0&&((t=this.participants.get(i))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return R(function*(){if(e.useLivekit){I.info("Livekit group call: not starting local call feed.");return}if(e.state!==at.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=at.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return R(function*(){I.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===xh.Video)}catch(i){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=at.LocalCallFeedUninitialized,i}if(e._state!==at.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var n=new Dn({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Je.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});St(t.getAudioTracks(),!n.isAudioMuted()),St(t.getVideoTracks(),!n.isVideoMuted()),e.localCallFeed=n,e.addUserMediaFeed(n),e.state=at.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return R(function*(){if(t.localCallFeed){var n=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var i=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();I.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(n.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(i,", vidShouldBeMuted=").concat(a,")")),St(e.getAudioTracks(),!i),St(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(n)}})()}enter(){var e=this;return R(function*(){if(e.state===at.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==at.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));I.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=at.Entered,e.client.on(Kp.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===at.Entered&&(this.forEachCall(t=>t.hangup(Pe.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Kp.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=at.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(De.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(Gp.Ended,t),t.state=at.Ended,n){var i=t.room.currentState.getStateEvents(F.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,F.GroupCallPrefix,qu(qu({},i.getContent()),{},{"m.terminated":G1.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(s=>{var l;return(l=s.localUsermediaFeed)===null||l===void 0?void 0:l.setAudioVideoMuted(e,null)});var i=function(){var s=R(function*(){var l=[];t.forEachCall(u=>l.push(u.sendMetadataUpdate())),yield Promise.all(l).catch(u=>I.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),u))});return o(function(){return s.apply(this,arguments)},"sendUpdates")}();if(n&&(yield i()),t.localCallFeed){I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),St(t.localCallFeed.stream.getAudioTracks(),!e)}else I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(s=>St(s.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(s))),t.emit(ze.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield i()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return R(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((n==null?void 0:n.getTracks().length)===0)return I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return I.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return R(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var n=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(n),t.localCallFeed.setAudioVideoMuted(null,e),St(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else I.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var i=[];return t.forEachCall(a=>i.push(a.setLocalVideoMuted(e))),yield Promise.all(i),t.forEachCall(a=>St(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(ze.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(e===n.isScreensharing())return e;if(e)try{I.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield n.client.getMediaHandler().getScreensharingStream(i),s=o(function*(d){var c=o(()=>{n.setScreensharingEnabled(!1),d.removeEventListener("ended",c)},"onTrackEnded");d.addEventListener("ended",c)},"_loop");for(var l of a.getTracks())yield*s(l);return I.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=i.desktopCapturerSourceId,n.localScreenshareFeed=new Dn({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:a,purpose:Je.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(ze.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(u=>u.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(u){if(i.throwOnFail)throw u;return I.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),u),n.emit(ze.Error,new Fl(ol.NoUserMedia,"Failed to get screen-sharing stream: ",u)),!1}else return n.forEachCall(u=>{u.localScreensharingFeed&&u.removeLocalFeed(u.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(ze.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var n=this.client.getUserId(),i=this.client.getDeviceId();return e>=n&&(e!==n||t>i)}placeOutgoingCalls(){var e=this,t=!1,n=o(function(l){var u,d=(u=e.calls.get(l))!==null&&u!==void 0?u:new Map,c=o(function(p){var m=d.get(p);if((m==null?void 0:m.getOpponentSessionId())!==v.sessionId&&e.wantsOutgoingCall(l,p)){t=!0,m!==void 0&&(I.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(l,", deviceId=").concat(p,", callId=").concat(m.callId,")")),m.hangup(Pe.NewSession,!1));var w=$l(e.client,e.room.roomId,{invitee:l,opponentDeviceId:p,opponentSessionId:v.sessionId,groupCallId:e.groupCallId});w===null?(I.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(l,", device=").concat(p,")")),d.delete(p)):(e.initCall(w),d.set(p,w),I.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(l,", deviceId=").concat(p,", sessionId=").concat(v.sessionId,")")),w.placeCallWithCallFeeds(e.getLocalFeeds().map(y=>y.clone()),v.screensharing).then(()=>{e.dataChannelsEnabled&&w.createDataChannel("datachannel",e.dataChannelOptions)}).catch(y=>{I.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(l,")"),y),y instanceof qr&&y.code===ol.UnknownDevice?e.emit(ze.Error,y):e.emit(ze.Error,new Fl(ol.PlaceCallFailed,"Failed to place call to ".concat(l))),w.hangup(Pe.SignallingFailed,!1),d.get(p)===w&&d.delete(p)}))}},"_loop3");for(var[h,v]of a)c(h);d.size>0?e.calls.set(l,d):e.calls.delete(l)},"_loop2");for(var[{userId:i},a]of this.participants)n(i);t&&this.emit(ze.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(F.GroupCallMemberPrefix):this.room.currentState.getStateEvents(F.GroupCallMemberPrefix,e)}initCall(e){var t=Hu(e);if(!t)throw new Error("Cannot init call without user id");var n=o(()=>this.onCallFeedsChanged(e),"onCallFeedsChanged"),i=o((u,d)=>this.onCallStateChanged(e,u,d),"onCallStateChanged"),a=this.onCallHangup,s=o(u=>this.onCallReplaced(e,u),"onCallReplaced"),l=this.callHandlers.get(t);l===void 0&&(l=new Map,this.callHandlers.set(t,l)),l.set(e.getOpponentDeviceId(),{onCallFeedsChanged:n,onCallStateChanged:i,onCallHangup:a,onCallReplaced:s}),e.on(xe.FeedsChanged,n),e.on(xe.State,i),e.on(xe.Hangup,a),e.on(xe.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(xe)),e.initStats(this.getGroupCallStats()),n()}disposeCall(e,t){var n=Hu(e),i=e.getOpponentDeviceId();if(!n)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(n),{onCallFeedsChanged:s,onCallStateChanged:l,onCallHangup:u,onCallReplaced:d}=a.get(i);if(e.removeListener(xe.FeedsChanged,s),e.removeListener(xe.State,l),e.removeListener(xe.Hangup,u),e.removeListener(xe.Replaced,d),a.delete(n),a.size===0&&this.callHandlers.delete(n),e.hangupReason!==Pe.Replaced){var c=this.getUserMediaFeed(n,i);c&&this.removeUserMediaFeed(c);var h=this.getScreenshareFeed(n,i);h&&this.removeScreenshareFeed(h)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(n=>n.userId===e&&n.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(ze.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var n=this.userMediaFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(n,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(ze.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(ze.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(ze.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(n=>n.userId===e&&n.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(ze.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var n=this.screenshareFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(n===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(n,1,t),e.dispose(),this.emit(ze.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(ze.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){I.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===at.Ended){this.participants=new Map;return}var t=new Map,n=Date.now(),i=this.state===at.Entered||this.enteredViaAnotherSession,a=1/0;for(var s of this.getMemberStateEvents()){var l=this.room.getMember(s.getStateKey()),u=s.getContent(),d=Array.isArray(u["m.calls"])?u["m.calls"]:[],c=d.find(w=>w["m.call_id"]===this.groupCallId),h=Array.isArray(c==null?void 0:c["m.devices"])?c["m.devices"]:[],v=h.filter(w=>typeof w.device_id=="string"&&typeof w.session_id=="string"&&typeof w.expires_ts=="number"&&w.expires_ts>n&&Array.isArray(w.feeds));if(!i&&(l==null?void 0:l.userId)===this.client.getUserId()&&(v=v.filter(w=>w.device_id!==this.client.getDeviceId())),v.length>0&&(l==null?void 0:l.membership)===ke.Join){var g=new Map;t.set(l,g);for(var p of v)g.set(p.device_id,{sessionId:p.session_id,screensharing:p.feeds.some(w=>w.purpose===Je.Screenshare)}),p.expires_ts<a&&(a=p.expires_ts)}}if(i){var m=t.get(e);m===void 0&&(m=new Map,t.set(e,m)),m.has(this.client.getDeviceId())||m.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(w=>w.purpose===Je.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-n))}updateDevices(e){var t=arguments,n=this;return R(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1,s=Date.now(),l=n.client.getUserId(),u=n.getMemberStateEvents(l),d=(i=u==null?void 0:u.getContent())!==null&&i!==void 0?i:{},c=Array.isArray(d["m.calls"])?d["m.calls"]:[],h=null,v=[];for(var g of c)g["m.call_id"]===n.groupCallId?h=g:v.push(g);h===null&&(h={});var p=Array.isArray(h["m.devices"])?h["m.devices"]:[],m=p.filter(T=>typeof T.device_id=="string"&&typeof T.session_id=="string"&&typeof T.expires_ts=="number"&&T.expires_ts>s&&Array.isArray(T.feeds)),w=e(m);if(w!==null){var y=[...v];w.length>0&&y.push(qu(qu({},h),{},{"m.call_id":n.groupCallId,"m.devices":w}));var S={"m.calls":y};yield n.client.sendStateEvent(n.room.roomId,F.GroupCallMemberPrefix,S,l,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return R(function*(){yield e.updateDevices(t=>[...t.filter(n=>n.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+Gb,feeds:e.getLocalFeeds().map(n=>({purpose:n.purpose}))}])})()}updateMemberState(){var e=this;return R(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===at.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(R(function*(){I.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){I.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),Gb*3/4)):yield e.updateDevices(t=>t.filter(n=>n.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return R(function*(){var{devices:t}=yield e.client.getDevices(),n=new Map(t.map(i=>[i.device_id,i]));yield e.updateDevices(i=>{var a=i.filter(s=>{var l=n.get(s.device_id);return(l==null?void 0:l.last_seen_ts)!==void 0&&!(s.device_id===e.client.getDeviceId()&&e.state!==at.Entered&&!e.enteredViaAnotherSession)});return a.length===i.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new nm(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(jn.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(jn.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(jn.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(jn.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}};o(SS,"GroupCall");let Bl=SS;function qb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(qb,"ownKeys$9");function zu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?qb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):qb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(zu,"_objectSpread$9");var Ie=function(r){return r.Fledgling="fledgling",r.InviteSent="invite_sent",r.WaitLocalMedia="wait_local_media",r.CreateOffer="create_offer",r.CreateAnswer="create_answer",r.Connecting="connecting",r.Connected="connected",r.Ringing="ringing",r.Ended="ended",r}({}),Hb=function(r){return r.Voice="voice",r.Video="video",r}({}),oi=function(r){return r.Inbound="inbound",r.Outbound="outbound",r}({}),ct=function(r){return r.Local="local",r.Remote="remote",r}({}),xe=function(r){return r.Hangup="hangup",r.State="state",r.Error="error",r.Replaced="replaced",r.LocalHoldUnhold="local_hold_unhold",r.RemoteHoldUnhold="remote_hold_unhold",r.HoldUnhold="hold_unhold",r.FeedsChanged="feeds_changed",r.AssertedIdentityChanged="asserted_identity_changed",r.LengthChanged="length_changed",r.DataChannel="datachannel",r.SendVoipEvent="send_voip_event",r.PeerConnectionCreated="peer_connection_created",r}({}),Pe=function(r){return r.UserHangup="user_hangup",r.LocalOfferFailed="local_offer_failed",r.NoUserMedia="no_user_media",r.UnknownDevices="unknown_devices",r.SendInvite="send_invite",r.CreateAnswer="create_answer",r.CreateOffer="create_offer",r.SendAnswer="send_answer",r.SetRemoteDescription="set_remote_description",r.SetLocalDescription="set_local_description",r.AnsweredElsewhere="answered_elsewhere",r.IceFailed="ice_failed",r.InviteTimeout="invite_timeout",r.Replaced="replaced",r.SignallingFailed="signalling_timeout",r.UserBusy="user_busy",r.Transferred="transferred",r.NewSession="new_session",r}({}),q1="1",H1="stun:turn.matrix.org",Df=60*1e3,z1=1e3,J1=30*1e3,Q1=2*1e3;const ES=class ES extends Error{constructor(e,t,n){super(t+": "+n),f(this,"code",void 0),this.code=e}};o(ES,"CallError");let qr=ES;function Xi(){return Date.now().toString()+ki(16)}o(Xi,"genCallID");function zb(r){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:r?12e3:void 0}];return e}o(zb,"getCodecParamMods");function Wr(r,e){return r+":"+e}o(Wr,"getTransceiverKey");const _S=class _S extends Qe{constructor(e){var t,n;if(super(),t=this,f(this,"roomId",void 0),f(this,"callId",void 0),f(this,"invitee",void 0),f(this,"hangupParty",void 0),f(this,"hangupReason",void 0),f(this,"direction",void 0),f(this,"ourPartyId",void 0),f(this,"peerConn",void 0),f(this,"toDeviceSeq",0),f(this,"isPtt",!1),f(this,"_state",Ie.Fledgling),f(this,"client",void 0),f(this,"forceTURN",void 0),f(this,"turnServers",void 0),f(this,"candidateSendQueue",[]),f(this,"candidateSendTries",0),f(this,"candidatesEnded",!1),f(this,"feeds",[]),f(this,"transceivers",new Map),f(this,"inviteOrAnswerSent",!1),f(this,"waitForLocalAVStream",!1),f(this,"successor",void 0),f(this,"opponentMember",void 0),f(this,"opponentVersion",void 0),f(this,"opponentPartyId",void 0),f(this,"opponentCaps",void 0),f(this,"iceDisconnectedTimeout",void 0),f(this,"iceReconnectionTimeOut",void 0),f(this,"inviteTimeout",void 0),f(this,"removeTrackListeners",new Map),f(this,"remoteOnHold",!1),f(this,"callStatsAtEnd",void 0),f(this,"makingOffer",!1),f(this,"ignoreOffer",!1),f(this,"isSettingRemoteAnswerPending",!1),f(this,"responsePromiseChain",void 0),f(this,"remoteCandidateBuffer",new Map),f(this,"remoteAssertedIdentity",void 0),f(this,"remoteSDPStreamMetadata",void 0),f(this,"callLengthInterval",void 0),f(this,"callStartTime",void 0),f(this,"opponentDeviceId",void 0),f(this,"hasOpponentDeviceInfo",void 0),f(this,"opponentSessionId",void 0),f(this,"groupCallId",void 0),f(this,"stopVideoTrackTimer",void 0),f(this,"isOnlyDataChannelAllowed",void 0),f(this,"stats",void 0),f(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&I.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),I.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),f(this,"onIceGatheringStateChange",a=>{var s;I.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((s=this.peerConn)===null||s===void 0?void 0:s.iceGatheringState)==="complete"&&(this.queueCandidate(null),I.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),f(this,"getLocalOfferFailed",a=>{I.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(xe.Error,new qr(Pe.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate(ct.Local,Pe.LocalOfferFailed,!1)}),f(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}I.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(xe.Error,new qr(Pe.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate(ct.Local,Pe.NoUserMedia,!1)}),f(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}I.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(xe.Error,new qr(Pe.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate(ct.Local,Pe.IceFailed,!1)}),f(this,"onIceConnectionStateChanged",()=>{var a,s,l,u,d,c;if(!this.callHasEnded()){if(I.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((s=this.peerConn)===null||s===void 0?void 0:s.connectionState,")")),["connected","completed"].includes((l=(u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)!==null&&l!==void 0?l:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=Ie.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(xe.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},z1));else if(((d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)=="failed"){var h;if(this.candidatesEnded=!1,(h=this.peerConn)!==null&&h!==void 0&&h.restartIce){var v;this.candidatesEnded=!1,I.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,")")),this.peerConn.restartIce()}else I.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Pe.IceFailed,!1)}else((c=this.peerConn)===null||c===void 0?void 0:c.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var p,m,w;I.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((p=this.peerConn)===null||p===void 0?void 0:p.iceConnectionState,", conn=").concat((m=this.peerConn)===null||m===void 0?void 0:m.connectionState,")")),(w=this.peerConn)!==null&&w!==void 0&&w.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},Q1),this.iceDisconnectedTimeout=setTimeout(()=>{I.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Pe.IceFailed,!1)},J1),this.state=Ie.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var g of this.getRemoteFeeds())g.setAudioVideoMuted(!0,!0)}}),f(this,"onSignallingStateChanged",()=>{var a;I.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),f(this,"onTrack",a=>{if(a.streams.length===0){I.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var s=a.streams[0];if(this.pushRemoteFeed(s),!this.removeTrackListeners.has(s)){var l=o(()=>{s.getTracks().length===0&&(I.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(s.id,")")),this.deleteFeedByStream(s),s.removeEventListener("removetrack",l),this.removeTrackListeners.delete(s))},"onRemoveTrack");s.addEventListener("removetrack",l),this.removeTrackListeners.set(s,l)}}),f(this,"onDataChannel",a=>{this.emit(xe.DataChannel,a.channel,this)}),f(this,"onNegotiationNeeded",R(function*(){if(I.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==Ie.CreateOffer&&t.opponentVersion===0){I.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),f(this,"onHangupReceived",a=>{I.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===Ie.Ringing?this.terminate(ct.Remote,a.reason||Pe.UserHangup,!0):I.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),f(this,"onRejectReceived",a=>{I.debug("Call ".concat(this.callId," onRejectReceived() running"));var s=[Ie.InviteSent,Ie.Ringing].includes(this.state)||this.state===Ie.Fledgling&&this.direction===oi.Inbound;s?this.terminate(ct.Remote,a.reason||Pe.UserHangup,!0):I.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),f(this,"onAnsweredElsewhere",a=>{I.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(ct.Remote,Pe.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(n=e.forceTURN)!==null&&n!==void 0?n:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[H1]});for(var i of this.turnServers)yR(i,["urls"]);this.callId=Xi(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return R(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return R(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var n=this.peerConn.createDataChannel(e,t);return this.emit(xe.DataChannel,n,this),n}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(xe.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?Hb.Video:Hb.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Je.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Je.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(Wr(Je.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(Wr(Je.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Je.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Je.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Je.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Je.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return R(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var n=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw n?(e.hasOpponentDeviceInfo=!1,new Rc(n)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var n of this.getLocalFeeds())e&&(n.sdpMetadataStreamId=n.stream.id),t[n.sdpMetadataStreamId]={purpose:n.purpose,audio_muted:n.isAudioMuted(),video_muted:n.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,n=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!n){I.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Dn({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n,audioMuted:i,videoMuted:a})),this.emit(xe.FeedsChanged,this.feeds,this),I.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(n,")"))}pushRemoteFeedWithoutMetadata(e){var t,n=this.getOpponentMember().userId,i=Je.Usermedia,a=(t=this.feeds.find(s=>!s.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){I.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new Dn({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(xe.FeedsChanged,this.feeds,this),I.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.client.getUserId();if(St(e.getAudioTracks(),!0),St(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){I.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new Dn({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),n)}pushLocalFeed(e){var t=this,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(s=>e.stream.id===s.stream.id)){I.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),n){var i=o(function(){I.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var l=Wr(e.purpose,a.kind);if(t.transceivers.has(l)){var u=t.transceivers.get(l);u.sender.replaceTrack(a),u.direction=u.direction==="inactive"?"sendonly":"sendrecv"}else{var d=t.peerConn.addTrack(a,e.stream),c=t.peerConn.getTransceivers().find(h=>h.sender===d);c?t.transceivers.set(l,c):I.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}},"_loop2");for(var a of e.stream.getTracks())i()}I.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(xe.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=Wr(e.purpose,"audio"),n=Wr(e.purpose,"video");for(var i of[t,n])if(this.transceivers.has(i)){var a=this.transceivers.get(i);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===Je.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(xe.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){I.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(xe.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return R(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return R(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),n=[];return t.forEach(i=>{n.push(i)}),n}})()}initWithInvite(e){var t=this;return R(function*(){var n,i=e.getContent();t.direction=oi.Inbound;var a=yield t.client.checkTurnServers();a||I.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var s=i[ni];s?t.updateRemoteSDPStreamMetadata(s):I.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(xe.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(i.offer),I.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(i.offer.type)),yield t.addBufferedIceCandidates()}catch(c){I.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),c),t.terminate(ct.Local,Pe.SetRemoteDescription,!1);return}var l=(n=t.feeds.find(c=>!c.isLocal()))===null||n===void 0?void 0:n.stream;if(!t.isOnlyDataChannelAllowed&&(!l||l.getTracks().length===0)){I.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(ct.Local,Pe.SetRemoteDescription,!1);return}if(t.state=Ie.Ringing,e.getLocalAge()){var u=setTimeout(()=>{if(t.state==Ie.Ringing){var c;I.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=ct.Remote,t.state=Ie.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(c=t.stats)===null||c===void 0||c.removeStatsReportGatherer(t.callId),t.emit(xe.Hangup,t)}},i.lifetime-e.getLocalAge()),d=o(c=>{c!==Ie.Ringing&&(clearTimeout(u),t.off(xe.State,d))},"onState");t.on(xe.State,d)}})()}initWithHangup(e){this.state=Ie.Ended}shouldAnswerWithMediaType(e,t,n){return e&&!t?(I.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n," because the other side isn't sending it either.")),!1):!_R(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(I.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(n,"=").concat(e," because the other side doesn't support it. Answering with ").concat(n,"=").concat(t,".")),t):e??t}answer(e,t){var n=this;return R(function*(){if(!n.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!n.localUsermediaStream&&!n.waitForLocalAVStream){var i=n.state,a=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),s=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=Ie.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var l,u=yield n.client.getMediaHandler().getUserMediaStream(a,s);n.waitForLocalAVStream=!1;var d=new Dn({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(l=n.client.getDeviceId())!==null&&l!==void 0?l:void 0,stream:u,purpose:Je.Usermedia,audioMuted:!1,videoMuted:!1}),c=[d];n.localScreensharingFeed&&c.push(n.localScreensharingFeed),n.answerWithCallFeeds(c)}catch(h){if(s)I.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=i,n.waitForLocalAVStream=!1,yield n.answer(a,!1);else{n.getUserMediaFailed(h);return}}}else n.waitForLocalAVStream&&(n.state=Ie.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){I.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===Ie.WaitLocalMedia?(I.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[Ie.CreateOffer,Ie.InviteSent].includes(this.state)&&(e.direction===oi.Outbound?e.queueGotCallFeedsForAnswer([]):(I.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(xe.Replaced,e,this),this.hangup(Pe.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(I.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(ct.Local,e,!t),![Ie.Fledgling,Ie.WaitLocalMedia].includes(this.state))){var n={};(this.opponentVersion&&this.opponentVersion!==0||e!==Pe.UserHangup)&&(n.reason=e),this.sendVoipEvent(F.CallHangup,n)}}reject(){if(this.state!==Ie.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){I.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Pe.UserHangup,!0);return}I.debug("Rejecting call: "+this.callId),this.terminate(ct.Local,Pe.UserHangup,!0),this.sendVoipEvent(F.CallReject,{})}upgradeCall(e,t){var n=this;return R(function*(){if(!(!e&&!t)&&n.opponentSupportsSDPStreamMetadata())try{I.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var i=e||n.hasLocalUserMediaAudioTrack,a=t||n.hasLocalUserMediaVideoTrack,s=yield n.client.getMediaHandler().getUserMediaStream(i,a,!1);yield n.updateLocalUsermediaStream(s,e,t)}catch(l){I.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),l),n.emit(xe.Error,new qr(Pe.NoUserMedia,"Failed to get camera access: ",l),n)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var n=this;return R(function*(){if(e&&n.isScreensharing())return I.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return I.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(I.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var i=yield n.client.getMediaHandler().getScreensharingStream(t);return i?(n.pushNewLocalFeed(i,Je.Screenshare),!0):!1}catch(u){return I.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),u),!1}else{var a=n.transceivers.get(Wr(Je.Screenshare,"audio")),s=n.transceivers.get(Wr(Je.Screenshare,"video"));for(var l of[a,s])l&&l.sender&&n.peerConn.removeTrack(l.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return R(function*(){if(I.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var i,a=yield n.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var s=a.getTracks().find(v=>v.kind==="video"),l=(i=n.transceivers.get(Wr(Je.Usermedia,"video")))===null||i===void 0?void 0:i.sender;return l==null||l.replaceTrack(s??null),n.pushNewLocalFeed(a,Je.Screenshare,!1),!0}catch(v){return I.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),v),!1}else{var u,d,c=(u=n.localUsermediaStream)===null||u===void 0?void 0:u.getTracks().find(v=>v.kind==="video"),h=(d=n.transceivers.get(Wr(Je.Usermedia,"video")))===null||d===void 0?void 0:d.sender;return h==null||h.replaceTrack(c??null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,s=n.localUsermediaFeed,l=i||!s.isAudioMuted()&&!n.remoteOnHold,u=a||!s.isVideoMuted()&&!n.remoteOnHold;I.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(l,", video=").concat(u,")")),St(e.getAudioTracks(),l),St(e.getVideoTracks(),u);for(var d of n.localUsermediaStream.getTracks())n.localUsermediaStream.removeTrack(d),d.stop();for(var c of e.getTracks())n.localUsermediaStream.addTrack(c);var h=o(function*(){var p=Wr(Je.Usermedia,v.kind),m=n.transceivers.get(p),w=m==null?void 0:m.sender,y=!1;if(w)try{I.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")")),yield w.replaceTrack(v),m.direction=m.direction==="inactive"?"sendonly":"sendrecv",y=!0}catch(C){I.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),C)}if(!y){I.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")"));var S=n.peerConn.addTrack(v,n.localUsermediaStream),T=n.peerConn.getTransceivers().find(C=>C.sender===S);T?n.transceivers.set(p,T):I.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}},"_loop22");for(var v of e.getTracks())yield*h()})()}setLocalVideoMuted(e){var t=this;return R(function*(){var n;if(I.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var i;return(i=t.localUsermediaFeed)===null||i===void 0||i.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var s of t.localUsermediaStream.getVideoTracks())s.stop(),t.localUsermediaStream.removeTrack(s)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return R(function*(){var n;return I.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(xe.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==Ie.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var n=["inactive","recvonly"].includes(t.currentDirection);n||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var n;if(((n=t.track)===null||n===void 0?void 0:n.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;I.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),St(this.localUsermediaStream.getAudioTracks(),!e),St(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return R(function*(){yield e.sendVoipEvent(F.CallSDPStreamMetadataChangedPrefix,{[ni]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var n of e)this.pushLocalFeed(n);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=Ie.CreateOffer,I.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return R(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[ni]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var n=e.discardDuplicateCandidates();I.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(n," candidates that will be sent in answer"));try{yield e.sendVoipEvent(F.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(s){e.state=Ie.Ringing,s instanceof ft&&s.event&&e.client.cancelPendingEvent(s.event);var i=Pe.SendAnswer,a="Failed to send answer";throw s.name=="UnknownDeviceError"&&(i=Pe.UnknownDevices,a="Unknown devices present in the room"),e.emit(xe.Error,new qr(i,a,s),e),s}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var n=TI(e.sdp);n.media.forEach(i=>{var a=new Map,s=new Map;for(var l of i.rtp)a.set(l.payload,l.codec),s.set(l.codec,l.payload);for(var u of t)if(u.mediaType===i.type){if(!s.has(u.codec)){I.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(u.codec," as it's not present."));continue}var d=[];u.enableDtx!==void 0&&d.push("usedtx=".concat(u.enableDtx?"1":"0")),u.maxAverageBitrate!==void 0&&d.push("maxaveragebitrate=".concat(u.maxAverageBitrate));var c=!1;for(var h of i.fmtp)a.get(h.payload)===u.codec&&(c=!0,h.config+=";"+d.join(";"));c||i.fmtp.push({payload:s.get(u.codec),config:d.join(";")})}}),e.sdp=x1(n)}createOffer(){var e=this;return R(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,zb(e.isPtt)),t})()}createAnswer(){var e=this;return R(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,zb(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return R(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var n of e)t.pushLocalFeed(n);t.state=Ie.CreateAnswer;var i;try{t.getRidOfRTXCodecs(),i=yield t.createAnswer()}catch(a){I.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate(ct.Local,Pe.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(i),t.callHasEnded()||(t.state=Ie.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){I.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate(ct.Local,Pe.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return R(function*(){if(!t.callHasEnded()){var n=e.getContent(),i=n.candidates;if(!i){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=n.version===0?null:n.party_id||null;if(t.opponentPartyId===void 0){if(a){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(i.length," candidates until we pick an opponent"));var s=t.remoteCandidateBuffer.get(a)||[];s.push(...i),t.remoteCandidateBuffer.set(a,s)}return}if(!t.partyIdMatches(n)){I.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(n.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(i)}})()}onAnswerReceived(e){var t=this;return R(function*(){var n=e.getContent();if(I.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(n.party_id,")")),t.callHasEnded()){I.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){I.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(n.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=Ie.Connecting;var i=n[ni];i?t.updateRemoteSDPStreamMetadata(i):I.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(n.answer),t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(n.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate(ct.Local,Pe.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(F.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){I.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return R(function*(){if(t.direction!==oi.Inbound){I.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var n=e.getContent().selected_party_id;if(n==null){I.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}n!==t.ourPartyId&&(I.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(n,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(ct.Remote,Pe.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return R(function*(){var n=e.getContent(),i=n.description;if(!i||!i.sdp||!i.type){I.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===oi.Inbound,s=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),l=i.type==="offer"&&!s;if(t.ignoreOffer=!a&&l,t.ignoreOffer){I.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var u=t.isLocalOnHold(),d=n[ni];d?t.updateRemoteSDPStreamMetadata(d):I.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=i.type=="answer",yield t.peerConn.setRemoteDescription(i),t.isSettingRemoteAnswerPending=!1,I.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(i.type)),i.type==="offer"){var c,h;try{t.getRidOfRTXCodecs(),h=yield t.createAnswer()}catch(g){I.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),g),t.terminate(ct.Local,Pe.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(h),I.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(F.CallNegotiate,{lifetime:Df,description:(c=t.peerConn.localDescription)===null||c===void 0?void 0:c.toJSON(),[ni]:t.getLocalSDPStreamMetadata(!0)})}}catch(g){t.isSettingRemoteAnswerPending=!1,I.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),g)}var v=t.isLocalOnHold();u!==v&&(t.emit(xe.LocalHoldUnhold,v,t),t.emit(xe.HoldUnhold,v))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=bR(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var n,i=t.stream.id,a=this.remoteSDPStreamMetadata[i];t.setAudioVideoMuted(a==null?void 0:a.audio_muted,a==null?void 0:a.video_muted),t.purpose=(n=this.remoteSDPStreamMetadata[i])===null||n===void 0?void 0:n.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),n=t[ni];this.updateRemoteSDPStreamMetadata(n)}onAssertedIdentityReceived(e){var t=this;return R(function*(){var n=e.getContent();n.asserted_identity&&(t.remoteAssertedIdentity={id:n.asserted_identity.id,displayName:n.asserted_identity.display_name},t.emit(xe.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===Ie.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return R(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return R(function*(){if(I.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){I.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(c){I.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),c),e.terminate(ct.Local,Pe.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(c){I.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),c),e.terminate(ct.Local,Pe.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(c=>{setTimeout(c,200)})),!e.callHasEnded()){var n=e.state===Ie.CreateOffer?F.CallInvite:F.CallNegotiate,i={lifetime:Df};if(n===F.CallInvite&&e.invitee&&(i.invitee=e.invitee),e.state===Ie.CreateOffer){var a;i.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var s;i.description=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}i.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},i[ni]=e.getLocalSDPStreamMetadata(!0);var l=e.discardDuplicateCandidates();I.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(l," candidates that will be sent in offer"));try{yield e.sendVoipEvent(n,i)}catch(c){I.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),c),c instanceof ft&&c.event&&e.client.cancelPendingEvent(c.event);var u=Pe.SignallingFailed,d="Signalling failed";e.state===Ie.CreateOffer&&(u=Pe.SendInvite,d="Failed to send invite"),c.name=="UnknownDeviceError"&&(u=Pe.UnknownDevices,d="Unknown devices present in the room"),e.emit(xe.Error,new qr(u,d,c),e),e.terminate(ct.Local,u,!1);return}e.sendCandidateQueue(),e.state===Ie.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=Ie.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===Ie.InviteSent&&e.hangup(Pe.InviteTimeout,!1)},Df))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(Wr(Je.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,n=RTCRtpSender.getCapabilities("video").codecs,i=[];for(var a of[...t,...n])if(a.mimeType!=="video/rtx"){i.push(a);try{e.setCodecPreferences(i)}catch(s){I.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,s),i.pop()}}}}}sendVoipEvent(e,t){var n=this;return R(function*(){var i=zu(zu({},t),{},{version:q1,call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var a,s=n.toDeviceSeq++,l=zu(zu({},i),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:s,[Ch]:I1()});n.emit(xe.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||((a=n.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:n.opponentDeviceId,content:l},n);var u=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo){I.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield n.client.sendToDevice(e,new Map([[u,new Map([[n.opponentDeviceId,l]])]]))}else{var d;n.emit(xe.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:i,userId:n.invitee||((d=n.getOpponentMember())===null||d===void 0?void 0:d.userId)},n),yield n.client.sendEvent(n.roomId,e,i)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===Ie.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===oi.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],n=0;n<this.candidateSendQueue.length;n++){var i=this.candidateSendQueue[n];i.candidate===""?t.push(i):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return R(function*(){var n=yield t.client.getProfileInfo(e),i=Xi(),a={replacement_id:Xi(),target_user:{id:e,display_name:n.displayname,avatar_url:n.avatar_url},create_call:i};yield t.sendVoipEvent(F.CallReplaces,a),yield t.terminate(ct.Local,Pe.Transferred,!0)})()}transferToCall(e){var t=this;return R(function*(){var n,i,a=(n=e.getOpponentMember())===null||n===void 0?void 0:n.userId,s=a?yield t.client.getProfileInfo(a):void 0,l=(i=t.getOpponentMember())===null||i===void 0?void 0:i.userId,u=l?yield t.client.getProfileInfo(l):void 0,d=Xi(),c={replacement_id:Xi(),target_user:{id:l,display_name:u==null?void 0:u.displayname,avatar_url:u==null?void 0:u.avatar_url},await_call:d};yield e.sendVoipEvent(F.CallReplaces,c);var h={replacement_id:Xi(),target_user:{id:a,display_name:s==null?void 0:s.displayname,avatar_url:s==null?void 0:s.avatar_url},create_call:d};yield t.sendVoipEvent(F.CallReplaces,h),yield t.terminate(ct.Local,Pe.Transferred,!0),yield e.terminate(ct.Local,Pe.Transferred,!0)})()}terminate(e,t,n){var i=this;return R(function*(){var a;if(!i.callHasEnded()){i.hangupParty=e,i.hangupReason=t,i.state=Ie.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),i.iceDisconnectedTimeout!==void 0&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),i.stopVideoTrackTimer!==void 0&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0);for(var[s,l]of i.removeTrackListeners)s.removeEventListener("removetrack",l);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&i.peerConn.signalingState!=="closed"&&i.peerConn.close(),(a=i.stats)===null||a===void 0||a.removeStatsReportGatherer(i.callId),n&&i.emit(xe.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}})()}stopAllMedia(){I.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Je.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Je.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){I.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(DR.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return R(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var n={candidates:t.map(l=>l.toJSON())};e.candidatesEnded&&n.candidates.push({candidate:""}),I.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(F.CallCandidates,n),e.candidateSendTries=0,e.sendCandidateQueue()}catch(l){if(l instanceof ft&&l.event&&e.client.cancelPendingEvent(l.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){I.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),l);var i=Pe.SignallingFailed,a="Signalling failed";e.emit(xe.Error,new qr(i,a,l),e),e.hangup(i,!1);return}var s=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,I.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(s,"ms"),l),setTimeout(()=>{e.sendCandidateQueue()},s)}}})()}placeCall(e,t){var n=this;return R(function*(){if(!e)throw new Error("You CANNOT start a call without audio");n.state=Ie.WaitLocalMedia;var i;try{var a,s=yield n.client.getMediaHandler().getUserMediaStream(e,t);St(s.getAudioTracks(),!0),St(s.getVideoTracks(),!0),i=new Dn({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:(a=n.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:s,purpose:Je.Usermedia,audioMuted:!1,videoMuted:!1})}catch(l){n.getUserMediaFailed(l);return}try{yield n.placeCallWithCallFeeds([i])}catch(l){n.placeCallFailed(l);return}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;n.checkForErrorListener(),n.direction=oi.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n);var a=yield n.client.checkTurnServers();a||I.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(xe.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,i)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var n=this.getOpponentMember(),i=n?n.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,i,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,n=e.getContent();if(I.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var i;(i=this.stats)===null||i===void 0||i.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return R(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(I.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return R(function*(){for(var n of e){(n.sdpMid===null||n.sdpMid===void 0)&&(n.sdpMLineIndex===null||n.sdpMLineIndex===void 0)?I.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):I.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(n.sdpMid,", candidate=").concat(n.candidate,")"));try{yield t.peerConn.addIceCandidate(n)}catch(i){t.ignoreOffer?I.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),i):I.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),i)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}};o(_S,"MatrixCall");let im=_S;function St(r,e){for(var t of r)t.enabled=e}o(St,"setTracksEnabled");function am(){if(typeof window>"u"||typeof document>"u")return!1;try{var r,e,t,n=!!((r=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&r!==void 0?r:navigator.mediaDevices);if(!n)return I.error("WebRTC is not supported in this browser / environment"),!1}catch(i){return I.error("Exception thrown when trying to access WebRTC",i),!1}return!0}o(am,"supportsMatrixCall");function $l(r,e,t){if(!am())return null;var n=t?t.forceTURN:!1,i={client:r,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:r.getTurnServers(),forceTURN:r.forceTURN||n,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},a=new im(i);return r.reEmitter.reEmit(a,Object.values(xe)),a}o($l,"createNewMatrixCall");var Pi=function(r){return r.DontNotify="dont_notify",r.Notify="notify",r.Coalesce="coalesce",r}({}),ay=function(r){return r.Highlight="highlight",r.Sound="sound",r}({}),Y1=function(r){return r.ExactEquals="==",r.LessThan="<",r.GreaterThan=">",r.GreaterThanOrEqual=">=",r.LessThanOrEqual="<=",r}({}),X1="2";function Z1(r){return r==="==2"||r==="2"}o(Z1,"isDmMemberCountCondition");var Et=function(r){return r.EventMatch="event_match",r.EventPropertyIs="event_property_is",r.EventPropertyContains="event_property_contains",r.ContainsDisplayName="contains_display_name",r.RoomMemberCount="room_member_count",r.SenderNotificationPermission="sender_notification_permission",r.CallStarted="call_started",r.CallStartedPrefix="org.matrix.msc3914.call_started",r}({}),Dt=function(r){return r.Override="override",r.ContentSpecific="content",r.RoomSpecific="room",r.SenderSpecific="sender",r.Underride="underride",r}({}),At=function(r){return r.Master=".m.rule.master",r.IsUserMention=".m.rule.is_user_mention",r.IsRoomMention=".m.rule.is_room_mention",r.ContainsDisplayName=".m.rule.contains_display_name",r.ContainsUserName=".m.rule.contains_user_name",r.AtRoomNotification=".m.rule.roomnotif",r.DM=".m.rule.room_one_to_one",r.EncryptedDM=".m.rule.encrypted_room_one_to_one",r.Message=".m.rule.message",r.EncryptedMessage=".m.rule.encrypted",r.InviteToSelf=".m.rule.invite_for_me",r.MemberEvent=".m.rule.member_event",r.IncomingCall=".m.rule.call",r.SuppressNotices=".m.rule.suppress_notices",r.Tombstone=".m.rule.tombstone",r.PollStart=".m.rule.poll_start",r.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",r.PollEnd=".m.rule.poll_end",r.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",r.PollStartOneToOne=".m.rule.poll_start_one_to_one",r.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",r.PollEndOneToOne=".m.rule.poll_end_one_to_one",r.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",r}({});function Jb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Jb,"ownKeys$8");function Qb(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Jb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Jb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Qb,"_objectSpread$8");var Yb=[Dt.Override,Dt.ContentSpecific,Dt.RoomSpecific,Dt.SenderSpecific,Dt.Underride],eN={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:Et.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:Et.SenderNotificationPermission,key:"room"}],actions:[Pi.Notify,{set_tweak:ay.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:Et.EventMatch,key:"type",pattern:"m.reaction"}],actions:[Pi.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:Et.EventMatch,key:"type",pattern:F.RoomServerAcl},{kind:Et.EventMatch,key:"state_key",pattern:""}],actions:[]}},sy=Symbol("UserDefinedRules"),tN=[At.Master,sy,At.SuppressNotices,At.InviteToSelf,At.MemberEvent,At.IsUserMention,At.ContainsDisplayName,At.IsRoomMention,At.AtRoomNotification,At.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],rN={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:Et.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:Et.CallStarted}],actions:[Pi.Notify,{set_tweak:ay.Sound,value:"default"}]}},nN=[sy,At.IncomingCall,".org.matrix.msc3914.rule.room.call",At.EncryptedDM,At.DM,At.Message,At.EncryptedMessage];function Xb(r,e,t,n,i){var a=t.filter(p=>p.default),s=t.filter(p=>!p.default);function l(p){p===sy?d.push(...s):p in n?(r.warn("Adding default global ".concat(e," push rule ").concat(p)),d.push(n[p])):r.warn("Missing default global ".concat(e," push rule ").concat(p))}o(l,"insertDefaultPushRule");var u=0,d=[];for(var c of a){var h=i.indexOf(c.rule_id);if(h===-1){d.push(c);continue}for(;h>u;){var v=i[u];l(v),u+=1}d.push(c),u+=1}for(var g of i.slice(u))l(g);return d}o(Xb,"mergeRulesWithDefaults");const hn=class hn{constructor(e){this.client=e,f(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var n of e)n===Pi.Notify?t.notify=!0:typeof n=="object"&&(n.value===void 0&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t){var n=JSON.parse(JSON.stringify(t));return n||(n={}),n.global||(n.global={}),n.global.override||(n.global.override=[]),n.global.underride||(n.global.underride=[]),n.global.override=Xb(e,Dt.Override,n.global.override,eN,tN),n.global.underride=Xb(e,Dt.Underride,n.global.underride,rN,nN),n}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[i,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],s="".concat(t,"-").concat(n,"-").concat(e);return hn.cachedGlobToRegex[s]||(hn.cachedGlobToRegex[s]=new RegExp(i+"("+ER(e)+")"+a,n)),hn.cachedGlobToRegex[s]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var n of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var i of n)if(i.conditions)for(var a of i.conditions)a.kind===Et.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,hn.partsForDottedKey(a.key)));t.forEach(s=>this.parsedKeys.delete(s))}matchingRuleFromKindSet(e,t){for(var n of Yb){var i=t[n];if(i){for(var a of i)if(a.enabled){var s=this.templateRuleToRaw(n,a);if(s&&this.ruleMatchesEvent(s,e))return Qb(Qb({},a),{},{kind:n})}}}return null}templateRuleToRaw(e,t){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case Dt.Underride:case Dt.Override:n.conditions=t.conditions;break;case Dt.RoomSpecific:if(!t.rule_id)return null;n.conditions.push({kind:Et.EventMatch,key:"room_id",value:t.rule_id});break;case Dt.SenderSpecific:if(!t.rule_id)return null;n.conditions.push({kind:Et.EventMatch,key:"user_id",value:t.rule_id});break;case Dt.ContentSpecific:if(!t.pattern)return null;n.conditions.push({kind:Et.EventMatch,key:"content.body",pattern:t.pattern});break}return n}eventFulfillsCondition(e,t){switch(e.kind){case Et.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case Et.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case Et.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case Et.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case Et.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case Et.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case Et.CallStarted:case Et.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var n=e.key;if(!n)return!1;var i=this.client.getRoom(t.getRoomId());return i!=null&&i.currentState?i.currentState.mayTriggerNotifOfType(n,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var s=a[1],l=parseInt(a[2]);if(isNaN(l))return!1;switch(s){case"":case"==":return i==l;case"<":return i<l;case">":return i>l;case"<=":return i<=l;case">=":return i>=l;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n,i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||typeof i.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),s=a==null||(n=a.currentState)===null||n===void 0?void 0:n.getMember(this.client.credentials.userId);if(!s)return!1;var l=s.name,u=new RegExp("(^|\\W)"+SR(l)+"(\\W|$)","i");return i.body.search(u)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var n=this.valueForDottedKey(e.key,t);if(typeof n!="string")return!1;if(e.value)return e.value===n;if(typeof e.pattern!="string")return!1;var i=hn.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!n.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var n=this.valueForDottedKey(e.key,t);return Array.isArray(n)?n.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Hs(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],n="",i=!1;for(var a of e){if(i){a==="\\"||a==="."?n+=a:n+="\\"+a,i=!1;continue}a=="."?(t.push(n),n=""):a=="\\"?i=!0:n+=a}return i&&(n+="\\"),t.push(n),t}valueForDottedKey(e,t){var n=this.parsedKeys.get(e);n===void 0&&(n=hn.partsForDottedKey(e),this.parsedKeys.set(e,n));var i,a=n[0],s=0;for(a==="content"?(i=t.getContent(),++s):a==="type"?(i=t.getType(),++s):i=t.event;s<n.length;++s){if(_R(i))return;var l=n[s];i=i[l]}return i}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var n=this.matchingRuleForEventWithRulesets(e,t);if(!n)return{};var i=hn.actionListToActionsObject(n.actions);return i.tweaks.highlight===void 0&&(i.tweaks.highlight=n.kind==Dt.ContentSpecific),{actions:i,rule:n}}ruleMatchesEvent(e,t){var n;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===At.ContainsUserName||e.rule_id===At.ContainsDisplayName||e.rule_id===At.AtRoomNotification)?!1:!((n=e.conditions)!==null&&n!==void 0&&n.some(i=>!this.eventFulfillsCondition(i,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,n=this.getPushRuleAndKindById(e);return(t=n==null?void 0:n.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var n;if(((n=this.client.pushRules)===null||n===void 0?void 0:n[t])!==void 0){for(var i of Yb)if(this.client.pushRules[t][i]!==void 0){for(var a of this.client.pushRules[t][i])if(a.rule_id===e)return{rule:a,kind:i}}}}return null}};o(hn,"PushProcessor");let Wl=hn;f(Wl,"cachedGlobToRegex",{});var Kl=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],iN=Kl[0],aN=Kl[Kl.length-1],br=function(r){return r.SUCCESS="SUCCESS",r.IGNORE="IGNORE",r.PROMPT="PROMPT",r.FAIL_PROMPT="FAIL_PROMPT",r.FAIL_ERROR="FAIL_ERROR",r}({}),Br=function(r){return r.Invalid="Invalid homeserver discovery response",r.GenericFailure="Failed to get autodiscovery configuration from server",r.InvalidHsBaseUrl="Invalid base_url for m.homeserver",r.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",r.InvalidIsBaseUrl="Invalid base_url for m.identity_server",r.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",r.InvalidIs="Invalid identity server discovery response",r.MissingWellknown="No .well-known JSON file found",r.InvalidJson="Invalid JSON",r.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",r}({});const $e=class $e{static fromDiscoveryConfig(e){var t=this;return R(function*(){var n,i={"m.homeserver":{state:$e.FAIL_ERROR,error:$e.ERROR_INVALID,base_url:null},"m.identity_server":{state:$e.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return I.error("No m.homeserver key in config"),i["m.homeserver"].state=$e.FAIL_PROMPT,i["m.homeserver"].error=$e.ERROR_INVALID,Promise.resolve(i);if(!e["m.homeserver"].base_url)return I.error("No m.homeserver base_url in config"),i["m.homeserver"].state=$e.FAIL_PROMPT,i["m.homeserver"].error=$e.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return I.error("Invalid base_url for m.homeserver"),i["m.homeserver"].error=$e.ERROR_INVALID_HS_BASE_URL,Promise.resolve(i);var s=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!s||!Array.isArray((n=s.raw)===null||n===void 0?void 0:n.versions))return I.error("Invalid /versions response"),i["m.homeserver"].error=$e.ERROR_INVALID_HOMESERVER,i["m.homeserver"].base_url=a,Promise.resolve(i);var l=new Set(s.raw.versions),u=!1;for(var d of Kl)if(l.has(d)){u=!0;break}if(!u)return I.error("Homeserver does not meet version requirements"),i["m.homeserver"].error=$e.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,i["m.homeserver"].base_url=a,Promise.resolve(i);i["m.homeserver"]={state:$e.SUCCESS,error:null,base_url:a};var c="";if(e["m.identity_server"]){var h={"m.homeserver":i["m.homeserver"],"m.identity_server":{state:$e.FAIL_PROMPT,error:$e.ERROR_INVALID_IS,base_url:null}};if(c=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!c)return I.error("Invalid base_url for m.identity_server"),h["m.identity_server"].error=$e.ERROR_INVALID_IS_BASE_URL,Promise.resolve(h);var v=yield t.fetchWellKnownObject("".concat(c,"/_matrix/identity/v2"));if(!(v!=null&&v.raw)||v.action!==br.SUCCESS)return I.error("Invalid /v2 response"),h["m.identity_server"].error=$e.ERROR_INVALID_IDENTITY_SERVER,h["m.identity_server"].base_url=c,Promise.resolve(h)}return c&&c.toString().length>0&&(i["m.identity_server"]={state:$e.SUCCESS,error:null,base_url:c}),Object.keys(e).forEach(g=>{if(g==="m.homeserver"||g==="m.identity_server"){var p=["error","state","base_url"];for(var m of Object.keys(e[g]))p.includes(m)||(i[g][m]=e[g][m])}else i[g]=e[g]}),Promise.resolve(i)})()}static findClientConfig(e){var t=this;return R(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n={"m.homeserver":{state:$e.FAIL_ERROR,error:$e.ERROR_INVALID,base_url:null},"m.identity_server":{state:$e.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(i,"/.well-known/matrix/client"));return!a||a.action!==br.SUCCESS?(I.error("No response or error when parsing .well-known"),a.reason&&I.error(a.reason),a.action===br.IGNORE?n["m.homeserver"]={state:$e.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=$e.FAIL_PROMPT,n["m.homeserver"].error=$e.ERROR_INVALID),Promise.resolve(n)):$e.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return R(function*(){var n;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var i=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return i?(n=i.raw)!==null&&n!==void 0?n:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,n;try{n=new URL(e)}catch(l){I.error("Could not parse url",l)}if(!((t=n)!==null&&t!==void 0&&t.hostname)||n.protocol!=="http:"&&n.protocol!=="https:")return!1;var i=n.port?":".concat(n.port):"",a=n.pathname?n.pathname:"",s="".concat(n.protocol,"//").concat(n.hostname).concat(i).concat(a);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(l){return I.error(l),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){$e.fetchFn=e}static fetchWellKnownObject(e){return R(function*(){var t;try{if(t=yield $e.fetch(e,{method:G.Get,signal:Mh(5e3)}),t.status===404)return{raw:{},action:br.IGNORE,reason:$e.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:br.FAIL_PROMPT,reason:"General failure"}}catch(s){var n=s,i="";return typeof n=="object"&&(i=n==null?void 0:n.message),{error:n,raw:{},action:br.FAIL_PROMPT,reason:i||"General failure"}}try{return{raw:yield t.json(),action:br.SUCCESS}}catch(s){var a=s;return{error:a,raw:{},action:br.FAIL_PROMPT,reason:(a==null?void 0:a.name)==="SyntaxError"?$e.ERROR_INVALID_JSON:$e.ERROR_INVALID}}})()}};o($e,"AutoDiscovery");let wt=$e;f(wt,"ERROR_INVALID",Br.Invalid);f(wt,"ERROR_GENERIC_FAILURE",Br.GenericFailure);f(wt,"ERROR_INVALID_HS_BASE_URL",Br.InvalidHsBaseUrl);f(wt,"ERROR_INVALID_HOMESERVER",Br.InvalidHomeserver);f(wt,"ERROR_INVALID_IS_BASE_URL",Br.InvalidIsBaseUrl);f(wt,"ERROR_INVALID_IDENTITY_SERVER",Br.InvalidIdentityServer);f(wt,"ERROR_INVALID_IS",Br.InvalidIs);f(wt,"ERROR_MISSING_WELLKNOWN",Br.MissingWellknown);f(wt,"ERROR_INVALID_JSON",Br.InvalidJson);f(wt,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Br.UnsupportedHomeserverSpecVersion);f(wt,"ALL_ERRORS",Object.keys(Br));f(wt,"FAIL_ERROR",br.FAIL_ERROR);f(wt,"FAIL_PROMPT",br.FAIL_PROMPT);f(wt,"PROMPT",br.PROMPT);f(wt,"SUCCESS",br.SUCCESS);f(wt,"fetchFn",void 0);var sm=function(r){return r.IS="SERVICE_TYPE_IS",r.IM="SERVICE_TYPE_IM",r}({});const bS=class bS{constructor(e){this.ourEvent=e,f(this,"timeline",void 0),f(this,"ourEventIndex",0),f(this,"paginateTokens",{[Me.Backward]:null,[Me.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?Me.Backward:Me.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?Me.Backward:Me.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}};o(bS,"EventContext");let om=bS;const Zc=class Zc{static fromJson(e,t){var n=e.context||{},i=(n.events_before||[]).map(t),a=(n.events_after||[]).map(t),s=new om(t(e.result)),l=s.ourEvent.threadRootId;return i=i.filter(u=>u.threadRootId===l),a=a.filter(u=>u.threadRootId===l),s.setPaginateToken(n.start,!0),s.addEvents(i,!0),s.addEvents(a,!1),s.setPaginateToken(n.end,!1),new Zc(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}};o(Zc,"SearchResult");let Ic=Zc;var sN=function(r){return r.Public="public",r.Private="private",r}({}),oy=function(r){return r.PrivateChat="private_chat",r.TrustedPrivateChat="trusted_private_chat",r.PublicChat="public_chat",r}({}),CI=function(r){return r.Public="public",r.Invite="invite",r.Private="private",r.Knock="knock",r.Restricted="restricted",r}({}),oN=function(r){return r.RoomMembership="m.room_membership",r}({}),Cc=function(r){return r.CanJoin="can_join",r.Forbidden="forbidden",r}({}),ly=function(r){return r.Invited="invited",r.Joined="joined",r.Shared="shared",r.WorldReadable="world_readable",r}({});function Zb(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(Zb,"ownKeys$7");function e0(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Zb(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Zb(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(e0,"_objectSpread$7");function lN(r,e){var t=!!e.preventReEmit,n=e.decrypt!==!1;function i(a){var s=r.getRoom(a.room_id),l;s&&a.state_key===void 0&&(l=s.findEventById(a.event_id)),!l||l.status?l=new Ht(a):(l.setUnsigned(e0(e0({},l.getUnsigned()),a.unsigned)),t=!0);var u=l.getServerAggregatedRelation(tt.Replace);if(u!=null&&u.content){var d=i(u);l.makeReplaced(d)}var c=s==null?void 0:s.findThreadForEvent(l);return c&&l.setThread(c),l.isEncrypted()&&(t||r.reEmitter.reEmit(l,[We.Decrypted]),n&&r.decryptEventIfNeeded(l)),t||(r.reEmitter.reEmit(l,[We.Replaced,We.VisibilityChange]),s==null||s.reEmitter.reEmit(l,[We.BeforeRedaction])),l}return o(i,"mapper"),i}o(lN,"eventMapperFor");function t0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(t0,"ownKeys$6");function ii(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?t0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):t0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(ii,"_objectSpread$6");const wS=class wS{constructor(e,t,n){this.client=e,this.indexEvent=t,this.directory=n}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return R(function*(){yield e.client.sendStateEvent(e.roomId,xn.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,xn.name,ii(ii({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,xn.name,ii(ii({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return R(function*(){var t=yield e.getFileEvent(),n=t.getOriginalContent().file,i=e.client.mxcUrlToHttp(n.url);if(!i)throw new Error("No HTTP URL available for ".concat(n.url));return{info:n,httpUrl:i}})()}getFileEvent(){var e=this;return R(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var n=t.getUnfilteredTimelineSet().findEventById(e.id);!n&&t.getLiveTimeline().getState(me.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),n=t.getUnfilteredTimelineSet().findEventById(e.id);if(!n)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(n),n})()}createNewVersion(e,t,n,i){var a=this;return R(function*(){var s=yield a.directory.createFile(e,t,n,ii(ii({},i??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:tt.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,xn.name,{active:!0,name:e,version:a.version+1},s.event_id),yield a.client.sendStateEvent(a.roomId,xn.name,ii(ii({},a.indexEvent.getContent()),{},{active:!1}),a.id),s})()}getVersionHistory(){var e=this;return R(function*(){var t=[];t.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw new Error("Invalid or unknown room");var i=[...n.getLiveTimeline().getEvents()].reverse(),a,s=yield e.getFileEvent();do if(a=i.find(u=>u.replacingEventId()===s.getId()),a){var l=e.directory.getFile(a.getId());if(l)t.push(l),s=a;else break}while(a);return t})()}};o(wS,"MSC3089Branch");let Oc=wS;function r0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(r0,"ownKeys$5");function Vi(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?r0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):r0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Vi,"_objectSpread$5");var uN={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[F.RoomPowerLevels]:100,[F.RoomHistoryVisibility]:100,[F.RoomTombstone]:100,[F.RoomEncryption]:100,[F.RoomName]:50,[F.RoomMessage]:50,[F.RoomMessageEncrypted]:50,[F.Sticker]:50},users:{}},La=function(r){return r.Viewer="viewer",r.Editor="editor",r.Owner="owner",r}({});const TS=class TS{constructor(e,t){if(this.client=e,this.roomId=t,f(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(F.SpaceParent);return e!=null&&e.length?e.every(t=>{var n;return!((n=t.getContent())!==null&&n!==void 0&&n.via)}):!0}setName(e){var t=this;return R(function*(){yield t.client.sendStateEvent(t.roomId,F.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=[n.retryInvite(e)];i&&a.push(...n.getDirectories().map(s=>s.invite(e,i))),yield Promise.all(a)})()}retryInvite(e){var t=this;return WM(R(function*(){yield t.client.invite(t.roomId,e).catch(n=>{throw(n==null?void 0:n.errcode)==="M_FORBIDDEN"?new gR.AbortError(n):n})}))}setPermissions(e,t){var n=this;return R(function*(){var i,a=n.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var s=(a==null?void 0:a.getContent())||{},l=s.users_default||0,u=s.events_default||50,d=((i=s.events)===null||i===void 0?void 0:i[F.RoomPowerLevels])||100,c=s.users||{};switch(t){case La.Viewer:c[e]=l;break;case La.Editor:c[e]=u;break;case La.Owner:c[e]=d;break;default:throw new Error("Invalid role: "+t)}s.users=c,yield n.client.sendStateEvent(n.roomId,F.RoomPowerLevels,s,"")})()}getPermissions(e){var t,n,i=this.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var a=(i==null?void 0:i.getContent())||{},s=a.users_default||0,l=a.events_default||50,u=((t=a.events)===null||t===void 0?void 0:t[F.RoomPowerLevels])||100,d=((n=a.users)===null||n===void 0?void 0:n[e])||s;return d>=u?La.Owner:d>=l?La.Editor:La.Viewer}createDirectory(e){var t=this;return R(function*(){var n=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,F.SpaceChild,{via:[t.client.getDomain()]},n.roomId),yield t.client.sendStateEvent(n.roomId,F.SpaceParent,{via:[t.client.getDomain()]},t.roomId),n})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(F.SpaceChild);for(var n of t)try{var i=n.getStateKey();if(i){var a=this.client.unstableGetFileTreeSpace(i);a&&e.push(a)}}catch(s){I.warn("Unable to create tree space instance for listing. Are we joined?",s)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return R(function*(){var t=e.getDirectories();for(var n of t)yield n.delete();var i=[ke.Invite,ke.Knock,ke.Join],a=e.room.currentState.getStateEvents(F.RoomMember);for(var s of a){var l=s.getStateKey()!==e.client.getUserId();if(l&&i.includes(s.getContent().membership)){var u=s.getStateKey();if(!u)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,u,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(n=>({roomId:n.getStateKey(),order:n.getContent().order})).filter(n=>n.roomId);return t.sort((n,i)=>{if(n.order&&!i.order)return-1;if(!n.order&&i.order)return 1;if(!n.order&&!i.order){var a,s,l,u,d=this.client.getRoom(n.roomId),c=this.client.getRoom(i.roomId);if(!d||!c)return cd(n.roomId,i.roomId);var h=(a=(s=d.currentState.getStateEvents(F.RoomCreate,""))===null||s===void 0?void 0:s.getTs())!==null&&a!==void 0?a:0,v=(l=(u=c.currentState.getStateEvents(F.RoomCreate,""))===null||u===void 0?void 0:u.getTs())!==null&&l!==void 0?l:0;return h===v?cd(n.roomId,i.roomId):h-v}else return cd(n.order,i.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(F.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var n=t.getStateKey();if(!n)throw new Error("No state key found for parent");var i=this.client.getRoom(n);if(!i)throw new Error("Unable to locate room for parent");return i}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(F.SpaceChild),n=this.getOrderedChildren(t);return n.findIndex(i=>i.roomId===this.roomId)}setOrder(e){var t=this;return R(function*(){var n;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var i=t.getParentRoom(),a=i.currentState.getStateEvents(F.SpaceChild),s=t.getOrderedChildren(a);e=Math.max(Math.min(e,s.length-1),0);var l=t.getOrder(),u=l<e;u&&e===s.length-1?e--:!u&&e===0&&e++;var d=s[u?e:e-1],c=s[u?e+1:e],h=Ni[0],v=!1;if(!d)c!=null&&c.order&&(h=Q_(c.order));else if(e===s.length-1)c!=null&&c.order&&(h=Io(c.order));else{var g=d==null?void 0:d.order,p=c==null?void 0:c.order;g&&p?g===p?h=Io(g):h=KM(g,p):g?h=Io(g):p?h=Q_(p):v=!0}if(v){for(var m,w=0;w<=e;w++){var y=s[w];if(w===0&&(m=y.order),y.order)m=y.order;else{var S;m=m?Io(m):Ni[0];var T=i.currentState.getStateEvents(F.SpaceChild,y.roomId),C=(S=T==null?void 0:T.getContent())!==null&&S!==void 0?S:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,F.SpaceChild,Vi(Vi({},C),{},{order:m}),y.roomId)}}m&&(h=Io(m))}var M=i.currentState.getStateEvents(F.SpaceChild,t.roomId),_=(n=M==null?void 0:M.getContent())!==null&&n!==void 0?n:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(i.roomId,F.SpaceChild,Vi(Vi({},_),{},{order:h}),t.roomId)})()}createFile(e,t,n,i){var a=this;return R(function*(){var{content_uri:s}=yield a.client.uploadContent(t,{includeFilename:!1});n.url=s;var l={msgtype:Rn.File,body:e,url:s,file:n};i=i??{},i["m.new_content"]&&(i["m.new_content"]=l);var u=yield a.client.sendMessage(a.roomId,Vi(Vi(Vi({},i),l),{},{[NR.name]:{}}));return yield a.client.sendStateEvent(a.roomId,xn.name,{active:!0,name:e},u.event_id),u})()}getFile(e){var t=this.room.currentState.getStateEvents(xn.name,e);return t?new Oc(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(xn.name))!==null&&e!==void 0?e:[];return t.map(n=>new Oc(this.client,n,this))}};o(TS,"MSC3089TreeSpace");let kc=TS;var OI=function(r){return r.Recent="recent",r.Rank="rank",r}({}),Zi=function(r){return r.LocalStreamsChanged="local_streams_changed",r}({});const RS=class RS extends Qe{constructor(e){super(),this.client=e,f(this,"audioInput",void 0),f(this,"audioSettings",void 0),f(this,"videoInput",void 0),f(this,"localUserMediaStream",void 0),f(this,"userMediaStreams",[]),f(this,"screensharingStreams",[]),f(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return R(function*(){I.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return R(function*(){I.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return R(function*(){I.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return R(function*(){I.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return R(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var n of e.client.callEventHandler.calls.values())t.set(n.callId,{audio:n.hasLocalUserMediaAudioTrack,video:n.hasLocalUserMediaVideoTrack});for(var i of e.userMediaStreams){I.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(i.id,")"));for(var a of i.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var s of e.client.callEventHandler.calls.values())if(!(s.callHasEnded()||!t.has(s.callId))){var{audio:l,video:u}=t.get(s.callId);I.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(s.callId,")"));var d=yield e.getUserMediaStream(l,u);s.callHasEnded()||(yield s.updateLocalUsermediaStream(d))}for(var c of e.client.groupCallEventHandler.groupCalls.values())if(c.localCallFeed){I.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(c.groupCallId,")"));var h=yield e.getUserMediaStream(!0,c.type===xh.Video);c.state!==at.Ended&&(yield c.updateLocalUsermediaStream(h))}e.emit(Zi.LocalStreamsChanged)}})()}hasAudioDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return I.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return R(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return I.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0;return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,a)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,a),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var i=this;return R(function*(){var a=e&&(yield i.hasAudioDevice()),s=t&&(yield i.hasVideoDevice()),l,u=!0;if(i.localUserMediaStream){var d,c;a!==i.localUserMediaStream.getAudioTracks().length>0&&(u=!1),s!==i.localUserMediaStream.getVideoTracks().length>0&&(u=!1),a&&((d=i.localUserMediaStream.getAudioTracks()[0])===null||d===void 0||(d=d.getSettings())===null||d===void 0?void 0:d.deviceId)!==i.audioInput&&(u=!1),s&&((c=i.localUserMediaStream.getVideoTracks()[0])===null||c===void 0||(c=c.getSettings())===null||c===void 0?void 0:c.deviceId)!==i.videoInput&&(u=!1)}else u=!1;if(u){var p;if(l=i.localUserMediaStream.clone(),I.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((p=i.localUserMediaStream)===null||p===void 0?void 0:p.id," newStreamId=").concat(l.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(s,")")),!a)for(var m of l.getAudioTracks())l.removeTrack(m);if(!s)for(var w of l.getVideoTracks())l.removeTrack(w)}else{var h=i.getUserMediaContraints(a,s);l=yield navigator.mediaDevices.getUserMedia(h),I.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(l.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(s,", constraints=").concat(JSON.stringify(h),")"));for(var v of l.getTracks()){var g=v.getSettings();v.kind==="audio"?i.audioInput=g.deviceId:v.kind==="video"&&(i.videoInput=g.deviceId)}n&&(i.localUserMediaStream=l)}return n&&i.userMediaStreams.push(l),i.emit(Zi.LocalStreamsChanged),l})()}stopUserMediaStream(e){I.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.userMediaStreams.indexOf(e);if(n!==-1&&(I.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(Zi.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var i of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(i.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{},i=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var s=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(I.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getUserMedia(s)):(I.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),a=yield navigator.mediaDevices.getDisplayMedia(s))}else{var l=t.screensharingStreams[t.screensharingStreams.length-1];I.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(l.id,")")),a=l.clone()}return i&&t.screensharingStreams.push(a),t.emit(Zi.LocalStreamsChanged),a})()}stopScreensharingStream(e){I.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var n=this.screensharingStreams.indexOf(e);n!==-1&&(I.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(n,1)),this.emit(Zi.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){I.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var n of this.screensharingStreams)for(var i of n.getTracks())i.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(Zi.LocalStreamsChanged)}getUserMediaContraints(e,t){var n=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:n}=e;return t?{audio:n??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:n??!1,video:!0}}};o(RS,"MediaHandler");let lm=RS;var n0=function(r){return r.RequestFinished="FINISHED",r.Complete="COMPLETE",r}({}),gu=function(r){return r.PreProcess="ExtState.PreProcess",r.PostProcess="ExtState.PostProcess",r}({}),um=function(r){return r.RoomData="SlidingSync.RoomData",r.Lifecycle="SlidingSync.Lifecycle",r}({}),dN=3;const IS=class IS{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return gu.PreProcess}onRequest(e){var t=this;return R(function*(){return e&&(I.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}};o(IS,"ExtensionE2EE");let dm=IS;const CS=class CS{constructor(e,t){this.client=e,this.cryptoCallbacks=t,f(this,"nextBatch",null)}name(){return"to_device"}when(){return gu.PreProcess}onRequest(e){var t=this;return R(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return R(function*(){var n=e.events||[],i;t.cryptoCallbacks?i=yield t.cryptoCallbacks.preprocessToDeviceMessages(n):i=n.map(a=>({message:a,encryptionInfo:null})),EI(i,t.client),t.nextBatch=e.next_batch})()}};o(CS,"ExtensionToDevice");let cm=CS;const OS=class OS{constructor(e){this.client=e}name(){return"account_data"}when(){return gu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var n in e.rooms){var i=cs(t.client,n,e.rooms[n]),a=t.client.getRoom(n);if(!a){I.warn("got account data for room but room doesn't exist on client:",n);continue}a.addAccountData(i),i.forEach(s=>{t.client.emit(ve.Event,s)})}})()}processGlobalAccountData(e){var t=cs(this.client,void 0,e),n=t.reduce((i,a)=>(i[a.getType()]=this.client.store.getAccountData(a.getType()),i),{});this.client.store.storeAccountDataEvents(t),t.forEach(i=>{if(i.getType()===F.PushRules){var a=i.getContent();this.client.setPushRules(a)}var s=n[i.getType()];return this.client.emit(ve.AccountData,i,s),i})}};o(OS,"ExtensionAccountData");let hm=OS;const kS=class kS{constructor(e){this.client=e}name(){return"typing"}when(){return gu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)kI(t.client,n,[e.rooms[n]])})()}};o(kS,"ExtensionTyping");let fm=kS;const PS=class PS{constructor(e){this.client=e}name(){return"receipts"}when(){return gu.PostProcess}onRequest(e){return R(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return R(function*(){if(e!=null&&e.rooms)for(var n in e.rooms)kI(t.client,n,[e.rooms[n]])})()}};o(PS,"ExtensionReceipts");let vm=PS;const MS=class MS{constructor(e,t,n,i){this.slidingSync=e,this.client=t,f(this,"opts",void 0),f(this,"syncOpts",void 0),f(this,"syncState",null),f(this,"syncStateData",void 0),f(this,"lastPos",null),f(this,"failCount",0),f(this,"notifEvents",[]),this.opts=gI(n),this.syncOpts=yI(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[fe.Timeline,fe.TimelineReset]),this.slidingSync.on(um.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(um.RoomData,this.onRoomData.bind(this));var a=[new cm(this.client,this.syncOpts.cryptoCallbacks),new hm(this.client),new fm(this.client),new vm(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new dm(this.syncOpts.cryptoCallbacks)),a.forEach(s=>{this.slidingSync.registerExtension(s)})}onRoomData(e,t){var n=this;return R(function*(){var i=n.client.store.getRoom(e);if(!i){if(!t.initial){n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}i=SI(n.client,e,n.opts)}yield n.processRoomData(n.client,i,t)})()}onLifecycle(e,t,n){switch(n&&this.syncOpts.logger.debug("onLifecycle",e,n),e){case n0.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(Ve.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(Ve.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case n0.RequestFinished:if(n){if(this.failCount+=1,this.updateSyncState(this.failCount>dN?Ve.Error:Ve.Reconnecting,{error:new ft(n)}),this.shouldAbortSync(new ft(n)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys((t==null?void 0:t.rooms)||[]).length," rooms"));break}}syncLeftRooms(){return R(function*(){return[]})()}peek(e){return R(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,n=new Ys(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(n,[fe.Name,fe.Redaction,fe.RedactionCancelled,fe.Receipt,fe.Tags,fe.LocalEchoUpdated,fe.AccountData,fe.MyMembership,fe.Timeline,fe.TimelineReset]),this.registerStateListeners(n),n}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[De.Events,De.Members,De.NewMember,De.Update]),e.currentState.on(De.NewMember,(t,n,i)=>{var a;i.user=(a=this.client.getUser(i.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(i,[cr.Name,cr.Typing,cr.PowerLevel,cr.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Ve.Error,{error:e}),!0):!1}processRoomData(e,t,n){var i=this;return R(function*(){n=cN(e,t.roomId,n);var a=cs(i.client,t.roomId,n.required_state),s=cs(i.client,t.roomId,n.timeline,!1),l=[];if(n.limited||n.initial){var u=new Set;t.getLiveTimeline().getEvents().forEach(S=>{u.add(S.getId())});for(var d=[],c=[],h=!1,v=s.length-1;v>=0;v--){var g=s[v];if(u.has(g.getId())){h=!0;continue}h?d.push(g):c.unshift(g)}s=c,d.length>0&&t.addEventsToTimeline(d,!0,!1,t.getLiveTimeline(),n.prev_batch)}var p=t.hasEncryptionStateEvent();if(n.notification_count!=null&&t.setUnreadNotificationCount(Be.Total,n.notification_count),n.highlight_count!=null&&(!p||p&&t.getUnreadNotificationCount(Be.Highlight)<=0)&&t.setUnreadNotificationCount(Be.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var m=cs(i.client,t.roomId,n.invite_state);yield i.injectRoomEvents(t,m),n.initial&&(t.recalculate(),i.client.store.storeRoom(t),i.client.emit(ve.Room,t)),m.forEach(S=>{i.client.emit(ve.Event,S)});return}if(n.limited){var w;t.getLiveTimeline().setPaginationToken((w=n.prev_batch)!==null&&w!==void 0?w:null,me.BACKWARDS)}yield i.injectRoomEvents(t,a,s,n.num_live),t.addEphemeralEvents(l),t.updateMyMembership(ke.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(ve.Room,t)),i.addNotifications(s);var y=function(){var S=R(function*(T){e.emit(ve.Event,T),T.isState()&&T.getType()==F.RoomEncryption&&i.syncOpts.cryptoCallbacks&&(yield i.syncOpts.cryptoCallbacks.onCryptoEvent(t,T))});return o(function(C){return S.apply(this,arguments)},"processRoomEvent")}();yield Xa(a,y),yield Xa(s,y),l.forEach(function(S){e.emit(ve.Event,S)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:[],s=n.length>3&&n[3]!==void 0?n[3]:0,l=e.getLiveTimeline(),u=l.getEvents().length==0;if(u){for(var d of t)i.client.getPushActionsForEvent(d);l.initialiseState(t)}u||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var c=[];s>0&&(c=a.slice(-1*s),a=a.slice(0,-1*c.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),c.length>0&&(yield e.addLiveEvents(c,{fromCache:!1,addToState:!1})),e.recalculate(),i.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(ke.Invite).forEach(function(n){if(!n.requestedProfileInfo){n.requestedProfileInfo=!0;var i=t.getUser(n.userId),a;i?a=Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):a=t.getProfileInfo(n.userId),a.then(function(s){var l=n.events.member;l.getContent().membership===ke.Invite&&(l.getContent().avatar_url=s.avatar_url,l.getContent().displayname=s.displayname,n.setMembershipEvent(l,e.currentState))},function(s){})}})}}retryImmediately(){return!0}sync(){var e=this;return R(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(n){if(e.syncOpts.logger.error("Getting push rules failed",n),e.shouldAbortSync(n))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var n=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ve.Sync,this.syncState,n,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var n=this.client.getPushActionsForEvent(t);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}};o(MS,"SlidingSyncSdk");let Pc=MS;function cN(r,e,t){if(!t.name)return t;for(var n of t.required_state)if(n.type===F.RoomName&&n.state_key==="")return n.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:F.RoomName,content:{name:t.name},sender:r.getUserId(),origin_server_ts:new Date().getTime()}),t}o(cN,"ensureNameEvent");function cs(r,e,t){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,i=r.getEventMapper({decrypt:n});return t.map(function(a){return a.room_id=e,i(a)})}o(cs,"mapEvents");function kI(r,e,t){var n=cs(r,e,t),i=r.getRoom(e);if(!i){I.warn("got ephemeral events for room but room doesn't exist on client:",e);return}i.addEphemeralEvents(n),n.forEach(a=>{r.emit(ve.Event,a)})}o(kI,"processEphemeralEvents");var uy=new gt("m.beacon_info","org.matrix.msc3672.beacon_info"),pm=new gt("m.beacon","org.matrix.msc3672.beacon");const ul=class ul{static RETRY_BACKOFF_RATELIMIT(e,t,n){return fI(n,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===F.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ul.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ul.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,f(this,"queues",{}),f(this,"activeQueues",[]),f(this,"procFn",null),f(this,"processQueue",n=>{var i=this.peekNextEvent(n);if(!i){this.disableQueue(n);return}this.queues[n].length,Promise.resolve().then(()=>this.procFn(i.event)).then(a=>{this.removeNextEvent(n),i.event.getId(),i.resolvers.resolve(a),this.processQueue(n)},a=>{i.attempts+=1;var s=this.retryAlgorithm(i.event,i.attempts,a);i.attempts,i.event.getId(),s===-1?(I.info("Queue '%s' giving up on event %s",n,i.event.getId()),this.clearQueue(n,a)):setTimeout(this.processQueue,s,n)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(n){return n.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var n=!1;return Zd(this.queues[t],i=>i.event.getId()===e.getId()?(n=!0,!0):!1),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var n=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),I.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){I.info("clearing queue '%s'",e);for(var n;n=this.removeNextEvent(e);)n.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}};o(ul,"MatrixScheduler");let Vl=ul;var i0=20;const AS=class AS{constructor(e,t){var n=this;this.client=e,this.logger=t,f(this,"sending",!1),f(this,"running",!0),f(this,"retryTimeout",null),f(this,"retryAttempts",0),f(this,"sendQueue",R(function*(){if(n.retryTimeout!==null&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!(n.sending||!n.running)){n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;var i;try{for(;n.running&&(i=yield n.client.store.getOldestToDeviceBatch(),i!==null);)yield n.sendBatch(i),yield n.client.store.removeToDeviceBatch(i.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(s){++n.retryAttempts;var a=Vl.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,s);if(a===-1){Math.floor(s.httpStatus/100)===4?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield n.client.store.removeToDeviceBatch(i.id)):n.logger.info("Automatic retry limit reached for to-device messages.");return}n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(a,"ms"),s),n.retryTimeout=setTimeout(n.sendQueue,a)}finally{n.sending=!1}}})),f(this,"onResumedSync",(i,a)=>{i===Ve.Syncing&&a!==Ve.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ve.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ve.Sync,this.onResumedSync)}queueBatch(e){var t=this;return R(function*(){for(var n=[],i=0;i<e.batch.length;i+=i0){var a={eventType:e.eventType,batch:e.batch.slice(i,i+i0),txnId:t.client.makeTxnId()};n.push(a);var s=a.batch.map(l=>"".concat(l.userId,"/").concat(l.deviceId," (msgid ").concat(l.payload[Ch],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),s)}yield t.client.store.saveToDeviceBatches(n),t.sendQueue()})()}sendBatch(e){var t=this;return R(function*(){var n=new Yr(()=>new Map);for(var i of e.batch)n.getOrCreate(i.userId).set(i.deviceId,i.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,n,e.txnId)})()}};o(AS,"ToDeviceMessageQueue");let mm=AS;var Nf=new ar.UnstableValue("m.policies","org.matrix.msc3847.policies"),Ju=new ar.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),a0=function(r){return r.Ban="m.ban",r}({}),hs=function(r){return r.User="m.policy.user",r.Room="m.policy.room",r.Server="m.policy.server",r}({}),s0={[hs.User]:F.PolicyRuleUser,[hs.Room]:F.PolicyRuleRoom,[hs.Server]:F.PolicyRuleServer};const xS=class xS{constructor(e){this.client=e}addRule(e,t,n){var i=this;return R(function*(){var a=yield i.getOrCreateTargetRoom(),s=yield i.client.sendStateEvent(a.roomId,s0[e],{entity:t,reason:n,recommendation:a0.Ban});return s.event_id})()}removeRule(e){var t=this;return R(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return R(function*(){yield t.client.joinRoom(e);var n=(yield t.getOrCreateSourceRooms()).map(i=>i.roomId);return n.includes(e)?!1:(n.push(e),yield t.withIgnoreInvitesPolicies(i=>{i.sources=n}),!0)})()}getRuleForInvite(e){var t=this;return R(function*(){var{sender:n,roomId:i}=e,a=yield t.getOrCreateSourceRooms(),s=n.split(":")[1],l=i.split(":")[1];for(var u of a){var d=u.getUnfilteredTimelineSet().getLiveTimeline().getState(me.FORWARDS);for(var{scope:c,entities:h}of[{scope:hs.Room,entities:[i]},{scope:hs.User,entities:[n]},{scope:hs.Server,entities:[s,l]}]){var v=d.getStateEvents(s0[c]);for(var g of v){var p=g.getContent();if((p==null?void 0:p.recommendation)==a0.Ban){var m=p==null?void 0:p.entity;if(m){var w=void 0;try{w=new RegExp(ER(m))}catch{continue}for(var y of h)if(y&&w.test(y))return g}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.target;if(typeof n!="string"&&(n=null),n){var i=e.client.getRoom(n);if(i)return i;n=null}return n=(yield e.client.createRoom({name:"Individual Policy Room",preset:oy.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=n}),e.client.getRoom(n)})()}getOrCreateSourceRooms(){var e=this;return R(function*(){var t=e.getIgnoreInvitesPolicies(),n=t.sources,i=!1;Array.isArray(n)||(i=!0,n=[]);var a=n.filter(l=>typeof l=="string").map(l=>e.client.getRoom(l)).filter(l=>!!l);if(a.length!=n.length&&(i=!0),a.length==0){var s=yield e.getOrCreateTargetRoom();i=!0,a=[s]}return i&&(yield e.withIgnoreInvitesPolicies(l=>{l.sources=n})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return R(function*(){var{policies:n,ignoreInvitesPolicies:i}=t.getPoliciesAndIgnoreInvitesPolicies();e(i),n[Ju.name]=i,yield t.client.setAccountData(Nf.name,n)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Nf.name,Nf.altName]){var n;if(t){var i=(n=this.client.getAccountData(t))===null||n===void 0?void 0:n.getContent();if(i){e=i;break}}}var a={},s=!1;for(var l of[Ju.name,Ju.altName])if(l){var u=e[l];if(u&&typeof u=="object"){a=u,s=!0;break}}return s||(e[Ju.name]=a),{policies:e,ignoreInvitesPolicies:a}}};o(xS,"IgnoredInvites");let gm=xS;var Lf="matrix-js-sdk",AU=function(r){return r.Change="change",r}({}),hN=function(r){return r[r.Unsent=1]="Unsent",r[r.Requested=2]="Requested",r[r.Ready=3]="Ready",r[r.Started=4]="Started",r[r.Cancelled=5]="Cancelled",r[r.Done=6]="Done",r}({}),Uf=function(r){return r.Cancel="cancel",r.ShowSas="show_sas",r.ShowReciprocateQr="show_reciprocate_qr",r}({});function fN(r){return r.phase<hN.Ready&&!r.accepting&&!r.declining}o(fN,"canAcceptVerificationRequest");function vN(r){if(r.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let d=0;d<e.length;d++)e[d]=255;for(let d=0;d<r.length;d++){const c=r.charAt(d),h=c.charCodeAt(0);if(e[h]!==255)throw new TypeError(c+" is ambiguous");e[h]=d}const t=r.length,n=r.charAt(0),i=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function s(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";let c=0,h=0,v=0;const g=d.length;for(;v!==g&&d[v]===0;)v++,c++;const p=(g-v)*a+1>>>0,m=new Uint8Array(p);for(;v!==g;){let S=d[v],T=0;for(let C=p-1;(S!==0||T<h)&&C!==-1;C--,T++)S+=256*m[C]>>>0,m[C]=S%t>>>0,S=S/t>>>0;if(S!==0)throw new Error("Non-zero carry");h=T,v++}let w=p-h;for(;w!==p&&m[w]===0;)w++;let y=n.repeat(c);for(;w<p;++w)y+=r.charAt(m[w]);return y}o(s,"encode");function l(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;let c=0,h=0,v=0;for(;d[c]===n;)h++,c++;const g=(d.length-c)*i+1>>>0,p=new Uint8Array(g);for(;c<d.length;){const S=d.charCodeAt(c);if(S>255)return;let T=e[S];if(T===255)return;let C=0;for(let M=g-1;(T!==0||C<v)&&M!==-1;M--,C++)T+=t*p[M]>>>0,p[M]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");v=C,c++}let m=g-v;for(;m!==g&&p[m]===0;)m++;const w=new Uint8Array(h+(g-m));let y=h;for(;m!==g;)w[y++]=p[m++];return w}o(l,"decodeUnsafe");function u(d){const c=l(d);if(c)return c;throw new Error("Non-base"+t+" character")}return o(u,"decode"),{encode:s,decodeUnsafe:l,decode:u}}o(vN,"base");var pN="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const xU=vN(pN);var Ct=function(r){return r.UserTrustStatusChanged="userTrustStatusChanged",r.KeyBackupStatus="crypto.keyBackupStatus",r.KeyBackupFailed="crypto.keyBackupFailed",r.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",r.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",r.VerificationRequestReceived="crypto.verificationRequestReceived",r.WillUpdateDevices="crypto.willUpdateDevices",r.DevicesUpdated="crypto.devicesUpdated",r.KeysChanged="crossSigning.keysChanged",r.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",r.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",r.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",r.RehydrationStarted="dehydration.RehydrationStarted",r.RehydrationProgress="dehydration.RehydrationProgress",r.RehydrationCompleted="dehydration.RehydrationCompleted",r.RehydrationError="dehydration.RehydrationError",r.DehydrationKeyCached="dehydration.DehydrationKeyCached",r.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",r}({}),o0=function(r){return r.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",r.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",r.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",r.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",r.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",r.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",r.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",r.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",r.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",r.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",r.UNKNOWN_ERROR="UNKNOWN_ERROR",r.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",r.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",r.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",r.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",r.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",r.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",r.OLM_BAD_ROOM="OLM_BAD_ROOM",r.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",r.OLM_BAD_SENDER="OLM_BAD_SENDER",r.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",r.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",r.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",r.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",r}({}),mN=function(r){return r[r.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",r[r.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",r}({});const DS=class DS{constructor(e){this.errorOnVerifiedUserProblems=e,f(this,"kind",mN.AllDevicesIsolationMode)}};o(DS,"AllDevicesIsolationMode");let l0=DS;const NS=class NS{constructor(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=n,f(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}};o(NS,"UserVerificationStatus");let u0=NS;const LS=class LS{constructor(e){var t,n,i,a,s;f(this,"signedByOwner",void 0),f(this,"crossSigningVerified",void 0),f(this,"tofu",void 0),f(this,"localVerified",void 0),f(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(n=e.crossSigningVerified)!==null&&n!==void 0?n:!1,this.tofu=(i=e.tofu)!==null&&i!==void 0?i:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(s=e.trustCrossSignedDevices)!==null&&s!==void 0?s:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}};o(LS,"DeviceVerificationStatus");let d0=LS;var DU=function(r){return r.Fetch="fetch",r.LoadKeys="load_keys",r}({}),NU=function(r){return r.Master="master",r.SelfSigning="self_signing",r.UserSigning="user_signing",r}({}),LU=function(r){return r[r.NONE=0]="NONE",r[r.GREY=1]="GREY",r[r.RED=2]="RED",r}({}),UU=function(r){return r[r.UNKNOWN=0]="UNKNOWN",r[r.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",r[r.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",r[r.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",r[r.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",r[r.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",r[r.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",r[r.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",r[r.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",r}({}),gN=new Uint8Array(8);function PI(r,e){return ym.apply(this,arguments)}o(PI,"deriveKeys");function ym(){return ym=R(function*(r,e){var t=yield globalThis.crypto.subtle.importKey("raw",r,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:gN,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),i=n.slice(0,32),a=n.slice(32),s=globalThis.crypto.subtle.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),l=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,l])}),ym.apply(this,arguments)}o(ym,"_deriveKeys");function MI(r,e,t,n){return Sm.apply(this,arguments)}o(MI,"encryptAESSecretStorageItem");function Sm(){return Sm=R(function*(r,e,t,n){var i;n?i=ha(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var[a,s]=yield PI(e,t),l=new TextEncoder().encode(r),u=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},a,l),d=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,u);return{iv:al(i),ciphertext:al(new Uint8Array(u)),mac:al(new Uint8Array(d))}}),Sm.apply(this,arguments)}o(Sm,"_encryptAESSecretStorageItem");function yN(r,e,t){return Em.apply(this,arguments)}o(yN,"decryptAESSecretStorageItem");function Em(){return Em=R(function*(r,e,t){var[n,i]=yield PI(e,t),a=ha(r.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},i,ha(r.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:ha(r.iv),length:64},n,a);return new TextDecoder().decode(new Uint8Array(s))}),Em.apply(this,arguments)}o(Em,"_decryptAESSecretStorageItem");var ea="m.secret_storage.v1.aes-hmac-sha2";const US=class US{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return R(function*(){var t,n=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return n&&(t=n.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,n)=>{var i=o(s=>{if(s.getType()==="m.secret_storage.default_key"){var l=s.getContent(),u=e===null?Object.keys(l).length===0:l.key===e;u&&(this.accountDataAdapter.removeListener(ve.AccountData,i),t())}},"listener");this.accountDataAdapter.on(ve.AccountData,i);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(s=>{this.accountDataAdapter.removeListener(ve.AccountData,i),n(s)})})}addKey(e,t,n){var i=this;return R(function*(){if(e!==ea)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:s,mac:l}=yield bm(t.key);if(a.iv=s,a.mac=l,!n)do n=ki(32);while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),a),{keyId:n,keyInfo:a}})()}getKey(e){var t=this;return R(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var n=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return n?[e,n]:null})()}hasKey(e){var t=this;return R(function*(){var n=yield t.getKey(e);return!!n})()}checkKey(e,t){return R(function*(){if(t.algorithm===ea)if(t.mac){var{mac:n}=yield bm(e,t.iv);return _m(t.mac)===_m(n)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,n){var i=this;return R(function*(){if(t===null){yield i.accountDataAdapter.setAccountData(e,{});return}var a={};if(!n){var s=yield i.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");n=[s]}if(n.length===0)throw new Error("Zero keys given to encrypt with!");for(var l of n){var u=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(l));if(!u)throw new Error("Unknown key: "+l);if(u.algorithm===ea){var d={[l]:u},[,c]=yield i.getSecretStorageKey(d,e);a[l]=yield c.encrypt(t)}else I.warn("unknown algorithm for secret storage key "+l+": "+u.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return R(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(n){if(!n.encrypted)throw new Error("Content is not encrypted!");var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),l=n.encrypted[a];(s==null?void 0:s.algorithm)===ea&&l.iv&&l.ciphertext&&l.mac&&(i[a]=s)}if(Object.keys(i).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[u,d]=yield t.getSecretStorageKey(i,e),c=n.encrypted[u];return d.decrypt(c)}})()}isStored(e){var t=this;return R(function*(){var n=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(n!=null&&n.encrypted))return null;var i={};for(var a of Object.keys(n.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(s){var l=n.encrypted[a];s.algorithm===ea&&l.iv&&l.ciphertext&&l.mac&&(i[a]=s)}}return Object.keys(i).length?i:null})()}getSecretStorageKey(e,t){var n=this;return R(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var i=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,s]=i;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===ea){var l={encrypt:o(function(d){return MI(d,s,t)},"encrypt"),decrypt:o(function(d){return yN(d,s,t)},"decrypt")};return[a,l]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}};o(US,"ServerSideSecretStorageImpl");let Mc=US;function _m(r){for(var e=r.length;e>=1&&r.charCodeAt(e-1)==61;)e--;return e<r.length?r.substring(0,e):r}o(_m,"trimTrailingEquals");var SN="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function bm(r,e){return MI(SN,r,"",e)}o(bm,"calculateKeyCheck");const EN=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:ea,ServerSideSecretStorageImpl:Mc,calculateKeyCheck:bm,trimTrailingEquals:_m},Symbol.toStringTag,{value:"Module"}));var AI=o(r=>r.type==="livekit"&&"focus_selection"in r,"isLivekitFocusActive"),xI=1e3*60*60*4,_N=o((r,e)=>{var t,n="Malformed session membership event: ";return typeof r.device_id!="string"&&e.push(n+"device_id must be string"),typeof r.call_id!="string"&&e.push(n+"call_id must be string"),typeof r.application!="string"&&e.push(n+"application must be a string"),typeof((t=r.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(n+"focus_active.type must be a string"),Array.isArray(r.foci_preferred)||e.push(n+"foci_preferred must be an array"),r.created_ts&&typeof r.created_ts!="number"&&e.push(n+"created_ts must be number"),r.scope&&typeof r.scope!="string"&&e.push(n+"scope must be string"),e.length===0},"checkSessionsMembershipData");const jS=class jS{static equal(e,t){return Hs(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,f(this,"membershipData",void 0);var n=[];if(_N(t,n))this.membershipData=t;else throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(n.join(" & "),") events this could be a legacy membership event: (").concat(t,")"))}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+((e=this.membershipData.expires)!==null&&e!==void 0?e:xI)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(AI(e))return e.focus_selection}};o(jS,"CallMembership");let Ac=jS;var yd=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({}),dy=function(r){return r.TooNew="TOO_NEW",r}({});const FS=class FS extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}};o(FS,"InvalidCryptoStoreError");let Gl=FS;f(Gl,"TOO_NEW",dy.TooNew);const BS=class BS extends Error{constructor(e,t){super(e),this.value=t}};o(BS,"KeySignatureUploadError");let wm=BS;const $S=class $S extends Error{constructor(){super("MatrixClient has been stopped")}};o($S,"ClientStoppedError");let Tm=$S;const WS=class WS extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}};o(WS,"UnsupportedDelayedEventsEndpointError");let gn=WS;var Gi=function(r){return r.Disconnected="Disconnected",r.Connecting="Connecting",r.ConnectingFailed="ConnectingFailed",r.Connected="Connected",r.Reconnecting="Reconnecting",r.Disconnecting="Disconnecting",r.Stuck="Stuck",r.Unknown="Unknown",r}({}),Sd=o((r,e,t)=>r.sender===e&&r.deviceId===t,"isMyMembership");const KS=class KS{constructor(e,t){this.membershipLoopHandler=e,f(this,"logger",void 0),f(this,"running",!1),f(this,"wakeup",n=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),f(this,"_actions",[]),this.logger=(t??I).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return R(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:Re.SendDelayedEvent}];try{for(var t=o(function*(){e._actions.sort((d,c)=>d.ts-c.ts);var i=e._actions[0],a=void 0,s=new Promise(d=>{e.wakeup=c=>{a=c,d()}});i.ts>Date.now()&&(yield Promise.race([s,du(i.ts-Date.now())]));var l={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(i.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{l=yield e.membershipLoopHandler(i.type)}catch(d){throw Error("The MembershipManager shut down because of the end condition: ".concat(d))}}e._actions.splice(0,1);var u=a??l;"replace"in u?e._actions=u.replace:"insert"in u&&e._actions.push(...u.insert)},"_loop");e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Re.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Re.SendScheduledDelayedLeaveEvent}]})}};o(KS,"ActionScheduler");let Rm=KS;var c0=function(r){return r.StatusChanged="StatusChanged",r}({}),Re=function(r){return r.SendDelayedEvent="SendDelayedEvent",r.SendJoinEvent="SendJoinEvent",r.RestartDelayedEvent="RestartDelayedEvent",r.UpdateExpiry="UpdateExpiry",r.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",r.SendLeaveEvent="SendLeaveEvent",r}({});const dl=class dl extends Qe{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,n){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.focusActive=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=dl.defaultState,this.scheduler.startWithJoin().catch(i=>{this.logger.error("MembershipManager stopped because: ",i),n==null||n(i)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(c0.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var i;(i=this.leavePromiseResolvers)===null||i===void 0||i.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){var t=this;return R(function*(){var n=t.client.getUserId(),i=t.client.getDeviceId();if(!n||!i)return t.logger.error("MembershipManager.onRTCSessionMemberUpdate called without user or device id"),Promise.resolve();if(t._ownMembership=e.find(s=>Sd(s,n,i)),t.isActivated()&&!t._ownMembership){var a=[Re.SendDelayedEvent,Re.SendJoinEvent];t.logger.warn("Missing own membership: force re-join"),t.state.hasMemberStateEvent=!1,t.scheduler.actions.some(s=>a.includes(s.type))?t.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",t.scheduler.actions):t.scheduler.initiateJoin()}return Promise.resolve()})()}getActiveFocus(){if(this.focusActive)if(AI(this.focusActive)){if(this.focusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e==null?void 0:e.getPreferredFoci()[0]}}else this.logger.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.");else{var t=this.getOldestMembership();return t==null?void 0:t.getPreferredFoci()[0]}}constructor(e,t,n,i,a){super(),this.joinConfig=e,this.room=t,this.client=n,this.getOldestMembership=i,f(this,"activated",!1),f(this,"logger",void 0),f(this,"leavePromiseResolvers",void 0),f(this,"_ownMembership",void 0),f(this,"oldStatus",void 0),f(this,"scheduler",void 0),f(this,"state",void 0),f(this,"deviceId",void 0),f(this,"stateKey",void 0),f(this,"fociPreferred",void 0),f(this,"focusActive",void 0),f(this,"delayedLeaveEventDelayMsOverride",void 0),this.logger=(a??I).getChild("[MembershipManager]");var[s,l]=[this.client.getUserId(),this.client.getDeviceId()];if(s===null)throw Error("Missing userId in client");if(l===null)throw Error("Missing deviceId in client");this.deviceId=l,this.stateKey=this.makeMembershipStateKey(s,l),this.state=dl.defaultState,this.scheduler=new Rm(u=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(c0.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(u)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1}}get networkErrorRetryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.networkErrorRetryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeout)!==null&&e!==void 0?e:xI}get membershipEventExpiryHeadroomMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.membershipEventExpiryHeadroomMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipExpiryTimeoutHeadroom)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+this.membershipEventExpiryMs*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,n,i,a;return(e=(t=(n=this.delayedLeaveEventDelayMsOverride)!==null&&n!==void 0?n:(i=this.joinConfig)===null||i===void 0?void 0:i.delayedLeaveEventDelayMs)!==null&&t!==void 0?t:(a=this.joinConfig)===null||a===void 0?void 0:a.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t,n,i;return(e=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventRestartMs)!==null&&t!==void 0?t:(i=this.joinConfig)===null||i===void 0?void 0:i.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return R(function*(){switch(e){case Re.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Re.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):kr(Re.SendDelayedEvent);case Re.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):kr(Re.SendLeaveEvent):{replace:[]};case Re.SendJoinEvent:return t.sendJoinEvent();case Re.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Re.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return R(function*(){return yield e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},F.GroupCallMemberPrefix,{},e.stateKey).then(t=>(e.resetRateLimitCounter(Re.SendDelayedEvent),e.state.delayId=t.delay_id,e.state.hasMemberStateEvent?kr(Re.RestartDelayedEvent,e.delayedLeaveEventRestartMs):kr(Re.SendJoinEvent))).catch(t=>{var n=Re.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return kr(n);var i=e.actionUpdateFromErrors(t,n,"sendDelayedStateEvent");if(i)return i;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),kr(Re.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return R(function*(){return yield t.client._unstable_updateDelayedEvent(e,yd.Cancel).then(()=>(t.state.delayId=void 0,t.resetRateLimitCounter(Re.SendDelayedEvent),jf(Re.SendDelayedEvent))).catch(n=>{var i=Re.SendDelayedEvent,a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");if(a)return a;if(t.isNotFoundError(n))return t.state.delayId=void 0,jf(i);if(t.isUnsupportedDelayedEndpoint(n))return jf(Re.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}restartDelayedEvent(e){var t=this;return R(function*(){var n=new Promise((i,a)=>{setTimeout(()=>{a(new UM("Restart delayed event timed out before the HS responded"))},t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_updateDelayedEvent(e,yd.Restart),n]).then(()=>(t.resetRateLimitCounter(Re.RestartDelayedEvent),kr(Re.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(i=>{var a=Re.RestartDelayedEvent;if(t.isNotFoundError(i))return t.state.delayId=void 0,kr(Re.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(i))return{};var s=t.actionUpdateFromErrors(i,a,"updateDelayedEvent");if(s)return s;throw Error("Could not restart delayed event, even though delayed events are supported. "+i)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return R(function*(){return yield t.client._unstable_updateDelayedEvent(e,yd.Send).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(Re.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(n=>{var i=Re.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(n))return{};if(t.isNotFoundError(n))return t.state.delayId=void 0,kr(i);var a=t.actionUpdateFromErrors(n,i,"updateDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",n),kr(i))})})()}sendJoinEvent(){var e=this;return R(function*(){return yield e.client.sendStateEvent(e.room.roomId,F.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs),e.stateKey).then(()=>{e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Re.SendJoinEvent);var t=e.scheduler.actions.filter(n=>n.type!==Re.UpdateExpiry&&n.type!==Re.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:Re.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Re.UpdateExpiry}]}}).catch(t=>{var n=e.actionUpdateFromErrors(t,Re.SendJoinEvent,"sendStateEvent");if(n)return n;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return R(function*(){var t=e.state.expireUpdateIterations+1;return yield e.client.sendStateEvent(e.room.roomId,F.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs*t),e.stateKey).then(()=>(e.resetRateLimitCounter(Re.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Re.UpdateExpiry}]})).catch(n=>{var i=e.actionUpdateFromErrors(n,Re.UpdateExpiry,"sendStateEvent");if(i)return i;throw n})})()}sendFallbackLeaveEvent(){var e=this;return R(function*(){return yield e.client.sendStateEvent(e.room.roomId,F.GroupCallMemberPrefix,{},e.stateKey).then(()=>(e.resetRateLimitCounter(Re.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var n=e.actionUpdateFromErrors(t,Re.SendLeaveEvent,"sendStateEvent");if(n)return n;throw t})})()}makeMembershipStateKey(e,t){var n="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?n:"_".concat(n)}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:this.deviceId,expires:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}}isNotFoundError(e){return e instanceof ft&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof ft&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,n){var i=this.actionUpdateFromRateLimitError(e,n,t);if(i)return i;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,n){var i;if((e instanceof Hn||e instanceof ft)&&e.isRateLimitError()){var a=(i=this.state.rateLimitRetries.get(n))!==null&&i!==void 0?i:0;if(a<this.maximumRateLimitRetryCount){var s,l=5e3;try{var u;s=(u=e.getRetryAfterMs())!==null&&u!==void 0?u:l,this.logger.info("Rate limited by server, retrying in ".concat(s,"ms"))}catch(d){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(l),d),s=l}return this.state.rateLimitRetries.set(n,a+1),kr(n,s)}throw Error("Exceeded maximum retries for "+n+" attempts (client."+t+"): "+e)}}actionUpdateFromNetworkErrorRetry(e,t){var n,i=(n=this.state.networkErrorRetries.get(t))!==null&&n!==void 0?n:0,a=this.networkErrorRetryMs/1e3+"s",s="("+i+"/"+this.maximumNetworkErrorRetryCount+")",l=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")l=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+s+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+s,e);else if(e instanceof zn)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+s,e);else if((e instanceof Hn||e instanceof ft)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+s,e);else return;if(i<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,i+1),kr(t,l);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof gn}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case Re.SendDelayedEvent:case Re.SendJoinEvent:return Gi.Connecting;case Re.UpdateExpiry:return Gi.Connected;case Re.SendScheduledDelayedLeaveEvent:case Re.SendLeaveEvent:return Gi.Disconnecting}}else if(e.length===2){var n=e.map(a=>a.type);if((n.includes(Re.RestartDelayedEvent)||n.includes(Re.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&n.includes(Re.UpdateExpiry))return Gi.Connected}else if(e.length===3){var i=e.map(a=>a.type);if(i.filter(a=>a===Re.RestartDelayedEvent).length===2&&i.includes(Re.UpdateExpiry))return Gi.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Gi.Unknown):Gi.Disconnected}};o(dl,"MembershipManager");let Im=dl;function kr(r,e){return{insert:[{ts:Date.now()+(e??0),type:r}]}}o(kr,"createInsertActionUpdate");function jf(r,e){return{replace:[{ts:Date.now()+0,type:r}]}}o(jf,"createReplaceActionUpdate");var yn=function(r){return r.ReceivedKeys="received_keys",r.NotSupportedError="not_supported_error",r}({});const VS=class VS{constructor(){f(this,"tsBuffer",new Map)}isOutdated(e,t){var n;this.tsBuffer.has(e)||this.tsBuffer.set(e,new Map);var i=(n=this.tsBuffer.get(e))===null||n===void 0?void 0:n.get(t.keyIndex);return i&&i>t.creationTS?!0:(this.tsBuffer.get(e).set(t.keyIndex,t.creationTS),!1)}};o(VS,"OutdatedKeyFilter");let Cm=VS;function fa(r,e){return"".concat(r,":").concat(e)}o(fa,"getParticipantId");const GS=class GS extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}};o(GS,"NotSupportedError");let xc=GS;const qS=class qS extends Qe{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,n,i,a,s){super(),this.userId=e,this.deviceId=t,this.roomId=n,this.client=i,this.statistics=a,f(this,"logger",I),f(this,"onToDeviceEvent",l=>{if(l.getType()===F.CallEncryptionKeysPrefix){var u=this.getValidEventContent(l);u&&l.getSender()&&this.receiveCallKeyEvent(l.getSender(),u)}}),this.setParentLogger(s??I)}start(){this.client.on(ve.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(ve.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var i=this;return R(function*(){var a={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.deviceId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},s=n.map(l=>({userId:l.userId,deviceId:l.deviceId})).filter(l=>!(l.userId==i.userId&&l.deviceId==i.deviceId));s.length>0?(yield i.client.encryptAndSendToDevice(F.CallEncryptionKeysPrefix,s,a).catch(l=>{var u=l.message;if(u.includes("unknown variant")&&u.includes("send_to_device")||u.includes("not supported"))throw new xc("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var n=Date.now(),i=n-(typeof t.sent_ts=="number"?t.sent_ts:n);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=i,this.emit(yn.ReceivedKeys,e,t.member.claimed_device_id,t.keys.key,t.keys.index,n)}getValidEventContent(e){var t=e.getContent(),n=t.room_id;if(!n){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(n!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}};o(qS,"ToDeviceKeyTransport");let Om=qS;var Dh=function(r){return r.EnabledTransportsChanged="enabled_transports_changed",r}({});const HS=class HS extends Qe{constructor(e,t,n){var i;super(),i=this,this.toDeviceTransport=e,this.roomKeyTransport=t,f(this,"logger",void 0),f(this,"_enabled",{toDevice:!0,room:!1}),this.logger=(n??I).getChild("[RoomAndToDeviceTransport]"),this.toDeviceTransport.setParentLogger(this.logger),this.roomKeyTransport.setParentLogger(this.logger),this.roomKeyTransport.on(yn.ReceivedKeys,function(){i._enabled.room||(i.logger.debug("Received room key, enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}));for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i.emit(yn.ReceivedKeys,...s)}),this.toDeviceTransport.on(yn.ReceivedKeys,function(){if(i._enabled.toDevice){for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];i.emit(yn.ReceivedKeys,...s)}else i.logger.debug("To Device transport is disabled, ignoring received keys")})}setEnabled(e){(this.enabled.toDevice!==e.toDevice||this.enabled.room!==e.room)&&(this._enabled=e,this.emit(Dh.EnabledTransportsChanged,e))}get enabled(){return this._enabled}start(){this.roomKeyTransport.start(),this.toDeviceTransport.start()}stop(){this.roomKeyTransport.stop(),this.toDeviceTransport.stop()}sendKey(e,t,n){var i=this;return R(function*(){if(i.logger.debug("Sending key with index ".concat(t," to call members (count=").concat(n.length,") via:")+(i._enabled.room?"room transport":"")+(i._enabled.room&&i._enabled.toDevice?"and":"")+(i._enabled.toDevice?"to device transport":"")),i._enabled.room&&(yield i.roomKeyTransport.sendKey(e,t,n)),i._enabled.toDevice)try{yield i.toDeviceTransport.sendKey(e,t,n)}catch(a){a instanceof xc&&!i._enabled.room&&(i.logger.warn("To device is not supported enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}),yield i.sendKey(e,t,n))}})()}};o(HS,"RoomAndToDeviceTransport");let ql=HS;const zS=class zS{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,n,i,a,s,l){var u=this;this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,f(this,"manageMediaKeys",!1),f(this,"keysEventUpdateTimeout",void 0),f(this,"makeNewKeyTimeout",void 0),f(this,"setNewKeyTimeouts",new Set),f(this,"encryptionKeys",new Map),f(this,"lastEncryptionKeyUpdateRequest",void 0),f(this,"lastMembershipFingerprints",void 0),f(this,"latestGeneratedKeyIndex",-1),f(this,"joinConfig",void 0),f(this,"logger",void 0),f(this,"joined",!1),f(this,"sendEncryptionKeysEvent",function(){var d=R(function*(c){if(u.keysEventUpdateTimeout!==void 0&&(clearTimeout(u.keysEventUpdateTimeout),u.keysEventUpdateTimeout=void 0),u.lastEncryptionKeyUpdateRequest=Date.now(),!!u.joined){var h=u.getKeysForParticipant(u.userId,u.deviceId);if(!h){u.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof c!="number"&&u.latestGeneratedKeyIndex===-1){u.logger.warn("Tried to send encryption keys event but no current key index found!");return}var v=c??u.latestGeneratedKeyIndex;u.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(v," (method parameter: ").concat(c,")"));var g=h[v];try{u.statistics.counters.roomEventEncryptionKeysSent+=1;var p=u.getMemberships().filter(w=>w.sender!=null).map(w=>({userId:w.sender,deviceId:w.deviceId,membershipTs:w.createdTs()}));yield u.transport.sendKey(RI(g),v,p),u.logger.debug("sendEncryptionKeysEvent participantId=".concat(u.userId,":").concat(u.deviceId," numKeys=").concat(h.length," currentKeyIndex=").concat(u.latestGeneratedKeyIndex," keyIndexToSend=").concat(v))}catch(w){if(u.keysEventUpdateTimeout===void 0){var m=ty(w,5e3);u.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(m),w),u.keysEventUpdateTimeout=setTimeout(()=>void u.sendEncryptionKeysEvent(),m)}else u.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(c){return d.apply(this,arguments)}}()),f(this,"onTransportChanged",()=>{this.requestSendCurrentKey()}),f(this,"onNewKeyReceived",(d,c,h,v,g)=>{this.logger.debug("Received key over key transport ".concat(d,":").concat(c," at index ").concat(v)),this.setEncryptionKey(d,c,v,h,g)}),f(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var d=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(d)}}),this.logger=(l??I).getChild("[EncryptionManager]")}getEncryptionKeys(){var e=new Map;for(var[t,n]of this.encryptionKeys){var i=n.map((a,s)=>({key:a.key,keyIndex:s}));e.set(t,i)}return e}join(e){var t,n,i;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(n=this.joinConfig)===null||n===void 0?void 0:n.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(yn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof ql&&this.transport.on(Dh.EnabledTransportsChanged,this.onTransportChanged),this.transport.start(),(i=this.joinConfig)!==null&&i!==void 0&&i.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(fa(this.userId,this.deviceId),[]),this.transport.off(yn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(d=>!Sd(d,this.userId,this.deviceId)).map(Ff)),n=new Set(this.getMemberships().filter(d=>!Sd(d,this.userId,this.deviceId)).map(Ff)),i=Array.from(t).some(d=>!n.has(d)),a=Array.from(n).some(d=>!t.has(d)),s=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),i)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(s){var l=this.lastMembershipFingerprints,u=Array.from(s).some(d=>!l.has(d))||Array.from(l).some(d=>!s.has(d));u&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=j1(16),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.userId,this.deviceId,n,t,Date.now(),e),n}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>void this.sendEncryptionKeysEvent(),this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e,t){var n;return(n=this.encryptionKeys.get(fa(e,t)))===null||n===void 0?void 0:n.map(i=>i.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!Sd(e,this.userId,this.deviceId)).map(e=>"".concat(Ff(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,n,i,a){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1;this.logger.debug("Setting encryption key for ".concat(e,":").concat(t," at index ").concat(n));var l=ha(i),u=fa(e,t);this.encryptionKeys.has(u)||this.encryptionKeys.set(u,[]);var d=this.encryptionKeys.get(u),c=d[n];if(c){if(c.timestamp>a){this.logger.info("Ignoring new key at index ".concat(n," for ").concat(u," as it is older than existing known key"));return}if(bN(c.key,l)){c.timestamp=a;return}}if(e===this.userId&&t===this.deviceId&&(this.latestGeneratedKeyIndex=n),d[n]={key:l,timestamp:a},s){var h=setTimeout(()=>{this.setNewKeyTimeouts.delete(h),this.logger.info("Delayed-emitting key changed event for ".concat(u," index ").concat(n)),this.onEncryptionKeysChanged(l,n,u)},this.useKeyDelay);this.setNewKeyTimeouts.add(h)}else this.onEncryptionKeysChanged(l,n,u)}};o(zS,"EncryptionManager");let km=zS;function bN(r,e){return r===e?!0:!!r&&!!e&&r.length===e.length&&r.every((t,n)=>t===e[n])}o(bN,"keysEqual");var Ff=o(r=>fa(r.sender,r.deviceId),"getParticipantIdFromMembership");const JS=class JS extends Qe{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,n,i){super(),this.room=e,this.client=t,this.statistics=n,f(this,"logger",I),this.setParentLogger(i??I)}start(){this.room.on(fe.Timeline,e=>void this.consumeCallEncryptionEvent(e))}stop(){this.room.off(fe.Timeline,e=>void this.consumeCallEncryptionEvent(e))}consumeCallEncryptionEvent(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield n.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){i?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>void n.consumeCallEncryptionEvent(e,!0),1e3));return}else i&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==F.CallEncryptionKeysPrefix)return Promise.resolve();if(!n.room)return n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();n.onEncryptionEvent(e)})()}sendKey(e,t,n){var i=this;return R(function*(){var a={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,F.CallEncryptionKeysPrefix,a)}catch(l){i.logger.error("Failed to send call encryption keys",l);var s=l;throw s.event&&i.client.cancelPendingEvent(s.event),l}})()}onEncryptionEvent(e){var t=e.getSender(),n=e.getContent(),i=n.device_id,a=n.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(i,", callId=").concat(a));return}if(!Array.isArray(n.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&i===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var s=Date.now()-(typeof n.sent_ts=="number"?n.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=s;for(var l of n.keys){if(!l){this.logger.info("Ignoring false-y key in keys event");continue}var u=l.key,d=l.index;!u||d===void 0||d===null||a===void 0||a===null||typeof i!="string"||typeof a!="string"||typeof u!="string"||typeof d!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(i,", encryptionKeyIndex=").concat(d," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(i," encryptionKeyIndex=").concat(d," age=").concat(s,"ms")),this.emit(yn.ReceivedKeys,t,i,u,d,e.getTs()))}}};o(JS,"RoomKeyTransport");let Dc=JS;const QS=class QS{constructor(e,t,n,i,a,s,l){this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=a,this.onEncryptionKeysChanged=s,f(this,"manageMediaKeys",!1),f(this,"participantKeyRings",new Map),f(this,"outboundSession",null),f(this,"currentKeyDistributionPromise",null),f(this,"useKeyDelay",5e3),f(this,"keyRotationGracePeriodMs",1e4),f(this,"needToEnsureKeyAgain",!1),f(this,"keyBuffer",new Cm),f(this,"logger",void 0),f(this,"onTransportChanged",()=>{var u;(u=this.logger)===null||u===void 0||u.info("Transport change detected, restarting key distribution"),this.currentKeyDistributionPromise?this.currentKeyDistributionPromise.then(()=>{this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}).catch(d=>{var c;(c=this.logger)===null||c===void 0||c.error("Failed to restart key distribution",d)}):this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}),f(this,"onNewKeyReceived",(u,d,c,h,v)=>{var g;if(!this.manageMediaKeys){var p;(p=this.logger)===null||p===void 0||p.warn("Received key over transport ".concat(u,":").concat(d," at index ").concat(h," but media keys are disabled"));return}(g=this.logger)===null||g===void 0||g.debug("Received key over transport ".concat(u,":").concat(d," at index ").concat(h));var m=fa(u,d),w=ha(c),y={key:w,participantId:m,keyIndex:h,creationTS:v},S=this.keyBuffer.isOutdated(m,y);if(!S)this.addKeyToParticipant(y.key,y.keyIndex,y.participantId),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var T;(T=this.logger)===null||T===void 0||T.info("Received an out of order key for ".concat(u,":").concat(d,", dropping it"))}}),this.logger=l==null?void 0:l.getChild("[EncryptionManager]")}getEncryptionKeys(){return new Map(this.participantKeyRings)}addKeyToParticipant(e,t,n){this.participantKeyRings.has(n)||this.participantKeyRings.set(n,[]),this.participantKeyRings.get(n).push({key:e,keyIndex:t}),this.onEncryptionKeysChanged(e,t,n)}join(e){var t,n,i,a;this.manageMediaKeys=(t=e==null?void 0:e.manageMediaKeys)!==null&&t!==void 0?t:!0,(n=this.logger)===null||n===void 0||n.info("Joining room"),this.useKeyDelay=(i=e==null?void 0:e.useKeyDelay)!==null&&i!==void 0?i:1e3,this.keyRotationGracePeriodMs=(a=e==null?void 0:e.keyRotationGracePeriodMs)!==null&&a!==void 0?a:1e4,this.transport.on(yn.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof ql&&this.transport.on(Dh.EnabledTransportsChanged,this.onTransportChanged),this.transport.start()}leave(){this.transport.off(yn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var n;if((n=this.logger)===null||n===void 0||n.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var i;(i=this.logger)===null||i===void 0||i.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution()}rolloutOutboundKey(){var e=this;return R(function*(){var t,n,i=e.outboundSession==null;i&&(e.outboundSession={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0},e.addKeyToParticipant(e.outboundSession.key,e.outboundSession.keyId,fa(e.userId,e.deviceId)));var a=e.getMemberships().filter(O=>O.sender!=null).map(O=>({userId:O.sender,deviceId:O.deviceId,membershipTs:O.createdTs()})),s=(t=(n=e.outboundSession)===null||n===void 0?void 0:n.sharedWith)!==null&&t!==void 0?t:[];s=s.filter(O=>!a.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs!=b.membershipTs));var l=s.filter(O=>!a.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs==b.membershipTs)),u=a.filter(O=>!s.some(b=>O.userId==b.userId&&O.deviceId==b.deviceId&&O.membershipTs==b.membershipTs)),d=[],c,h=!1;if(l.length>0){var v=e.createNewOutboundSession();h=!0,d=a,c=v}else if(u.length>0){var g=Date.now(),p=g-e.outboundSession.creationTS;if(p<e.keyRotationGracePeriodMs){var m;(m=e.logger)===null||m===void 0||m.debug("New joiners detected, but the key is recent enough (age:".concat(p,"), keeping it")),d=u,c=e.outboundSession}else{var w;(w=e.logger)===null||w===void 0||w.debug("New joiners detected, rotating the key");var y=e.createNewOutboundSession();h=!0,d=a,c=y}}else return;try{var S,T;if((S=e.logger)===null||S===void 0||S.trace("Sending key..."),yield e.transport.sendKey(al(c.key),c.keyId,d),e.statistics.counters.roomEventEncryptionKeysSent+=1,c.sharedWith.push(...d),(T=e.logger)===null||T===void 0||T.trace("key index:".concat(c.keyId," sent to ").concat(c.sharedWith.map(O=>"".concat(O.userId,":").concat(O.deviceId)).join(","))),h){var C,M;(C=e.logger)===null||C===void 0||C.trace("Delay Rollout for key:".concat(c.keyId,"...")),yield du(e.useKeyDelay),(M=e.logger)===null||M===void 0||M.trace("...Delayed rollout of index:".concat(c.keyId," ")),e.addKeyToParticipant(c.key,c.keyId,fa(e.userId,e.deviceId))}}catch(O){var _;(_=e.logger)===null||_===void 0||_.error("Failed to rollout key",O)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}};o(QS,"RTCEncryptionManager");let Pm=QS;var ai=function(r){return r.MembershipsChanged="memberships_changed",r.JoinStateChanged="join_state_changed",r.EncryptionKeyChanged="encryption_key_changed",r.MembershipManagerError="membership_manager_error",r}({});const es=class es extends Qe{get callId(){return this._callId}static callMembershipsForRoom(e){var t=I.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),n=e.getLiveTimeline().getState(me.FORWARDS);if(!n)throw t.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var i=n.getStateEvents(F.GroupCallMemberPrefix),a=[];for(var s of i){var l=s.getContent(),u=Object.keys(l).length;if(u!==0){var d=[];if(u>1&&"focus_active"in l?d.push(l):u===1&&"memberships"in l&&t.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),d.length!==0)for(var c of d)try{var h,v=new Ac(s,c);if(v.callId!==""||v.scope!=="m.room"){t.info("Ignoring user-scoped call");continue}if(v.isExpired()){t.info("Ignoring expired device membership ".concat(v.sender,"/").concat(v.deviceId));continue}if(!e.hasMembershipState((h=v.sender)!==null&&h!==void 0?h:"",ke.Join)){t.info("Ignoring membership of user ".concat(v.sender," who is not in the room."));continue}a.push(v)}catch(g){t.warn("Couldn't construct call membership: ",g)}}}return a.sort((g,p)=>g.createdTs()-p.createdTs()),a.length>1&&t.debug("Call memberships in room ".concat(e.roomId,", in order: "),a.map(g=>[g.createdTs(),g.sender])),a}static roomSessionForRoom(e,t){var n=es.callMembershipsForRoom(t);return new es(e,t,n)}get room(){return this.roomSubset}constructor(e,t,n){var i;super(),this.client=e,this.roomSubset=t,this.memberships=n,f(this,"membershipManager",void 0),f(this,"encryptionManager",void 0),f(this,"_callId",void 0),f(this,"joinConfig",void 0),f(this,"logger",void 0),f(this,"pendingNotificationToSend",void 0),f(this,"expiryTimeout",void 0),f(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),f(this,"reEmitter",new Li(this)),f(this,"onRoomMemberUpdate",()=>{this.recalculateSessionMembers()}),f(this,"onRTCSessionMemberUpdate",()=>{this.recalculateSessionMembers()}),f(this,"recalculateSessionMembers",()=>{var s,l,u,d=this.memberships;this.memberships=es.callMembershipsForRoom(this.room),this._callId=(s=this._callId)!==null&&s!==void 0?s:(l=this.memberships[0])===null||l===void 0?void 0:l.callId;var c=d.length!=this.memberships.length||d.some((m,w)=>!Ac.equal(m,this.memberships[w]));if(c){var h,v;this.logger.info("Memberships for call in room ".concat(this.roomSubset.roomId," have changed: emitting (").concat(this.memberships.length," members)")),$M(this.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{this.emit(ai.MembershipsChanged,d,this.memberships)}),(h=this.membershipManager)===null||h===void 0||h.onRTCSessionMemberUpdate(this.memberships);var g=(v=this.membershipManager)===null||v===void 0?void 0:v.ownMembership;if(this.pendingNotificationToSend&&g&&d.length===0){var p;g.eventId&&(p=this.joinConfig)!==null&&p!==void 0&&p.notificationType?this.sendCallNotify(g.eventId,this.joinConfig.notificationType):this.logger.warn("Own membership eventId is undefined, cannot send call notification")}this.memberships.length>0&&(this.pendingNotificationToSend=void 0)}(u=this.encryptionManager)===null||u===void 0||u.onMembershipsUpdate(d),this.setExpiryTimer()}),this.logger=I.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this._callId=(i=n[0])===null||i===void 0?void 0:i.callId;var a=this.roomSubset.getLiveTimeline().getState(me.FORWARDS);a==null||a.on(De.Members,this.onRoomMemberUpdate),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return R(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var n=e.roomSubset.getLiveTimeline().getState(me.FORWARDS);n==null||n.off(De.Members,e.onRoomMemberUpdate)})()}joinRoomSession(e,t,n){var i;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=new Im(n,this.roomSubset,this.client,()=>this.getOldestMembership(),this.logger);var a;if(n!=null&&n.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[s,l]=[this.client.getUserId(),this.client.getDeviceId()],[u,d,c]=[this.roomSubset,this.client,this.statistics],h=new Dc(u,d,c),v=new Om(s,l,u.roomId,d,c);a=new ql(v,h,this.logger),this.reEmitter.reEmit(a,[Dh.EnabledTransportsChanged]),this.encryptionManager=new Pm(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(g,p,m)=>{this.emit(ai.EncryptionKeyChanged,g,p,m)},this.logger)}else a=new Dc(this.roomSubset,this.client,this.statistics),this.encryptionManager=new km(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(g,p,m)=>{this.emit(ai.EncryptionKeyChanged,g,p,m)})}this.joinConfig=n,this.pendingNotificationToSend=(i=this.joinConfig)===null||i===void 0?void 0:i.notificationType,this.membershipManager.join(e,t,g=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",g),this.emit(ai.MembershipManagerError,g),this.emit(ai.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(n),this.emit(ai.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var i=t.membershipManager.leave(n);return t.emit(ai.JoinStateChanged,!1),yield i})()}getActiveFocus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if((e==null?void 0:e.getFocusSelection())==="oldest_membership")return e.getPreferredFoci()[0]}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,n)=>{t.forEach(i=>{this.emit(ai.EncryptionKeyChanged,i.key,i.keyIndex,n)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var n=t.getMsUntilExpiry();n!==void 0&&(e===void 0||n<e)&&(e=n)}e!=null&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}sendCallNotify(e,t){this.client.sendEvent(this.roomSubset.roomId,F.CallNotify,{application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:t==="notification"?"notify":t,call_id:this.callId}).catch(n=>this.logger.error("Failed to send call notification",n)),this.client.sendEvent(this.roomSubset.roomId,F.RTCNotification,{"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:tt.unstable_RTCNotificationParent},sender_ts:Date.now(),lifetime:3e4}).catch(n=>this.logger.error("Failed to send call notification",n))}};o(es,"MatrixRTCSession");let Nc=es;var h0=function(r){return r.SessionStarted="session_started",r.SessionEnded="session_ended",r}({});const YS=class YS extends Qe{constructor(e,t){super(),this.client=t,f(this,"roomSessions",new Map),f(this,"logger",void 0),f(this,"onRoom",n=>{this.refreshRoom(n)}),f(this,"onRoomState",(n,i)=>{var a=this.client.getRoom(n.getRoomId());if(!a){this.logger.error("Got room state event for unknown room ".concat(n.getRoomId(),"!"));return}n.getType()==F.GroupCallMemberPrefix&&this.refreshRoom(a)}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,n=Nc.roomSessionForRoom(this.client,e);n.memberships.length>0&&this.roomSessions.set(e.roomId,n)}this.client.on(ve.Room,this.onRoom),this.client.on(De.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ve.Room,this.onRoom),this.client.off(De.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,Nc.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),n=this.getRoomSession(e),i=n.memberships.length>0&&!t;n.onRTCSessionMemberUpdate();var a=n.memberships.length>0;i&&!a?(this.logger.trace("Session ended for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(h0.SessionEnded,e.roomId,this.roomSessions.get(e.roomId))):!i&&a&&(this.logger.trace("Session started for ".concat(e.roomId," (").concat(n.memberships.length," members)")),this.emit(h0.SessionStarted,e.roomId,this.roomSessions.get(e.roomId)))}};o(YS,"MatrixRTCSessionManager");let Mm=YS;function Bf(r){return e=>{var t,n;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==r||((n=e.content)===null||n===void 0||(n=n["m.relates_to"])===null||n===void 0?void 0:n.rel_type)===qe.name}}o(Bf,"getRelationsThreadFilter");function DI(r){return Am.apply(this,arguments)}o(DI,"sha256");function Am(){return Am=R(function*(r){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(r),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),Am.apply(this,arguments)}o(Am,"_sha");const XS=class XS extends Error{};o(XS,"InvalidTokenError");let la=XS;la.prototype.name="InvalidTokenError";function wN(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}o(wN,"b64DecodeUnicode");function TN(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return wN(e)}catch{return atob(e)}}o(TN,"base64UrlDecode");function NI(r,e){if(typeof r!="string")throw new la("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=r.split(".")[t];if(typeof n!="string")throw new la(`Invalid token specified: missing part #${t+1}`);let i;try{i=TN(n)}catch(a){throw new la(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(i)}catch(a){throw new la(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}o(NI,"jwtDecode");var RN={debug:o(()=>{},"debug"),info:o(()=>{},"info"),warn:o(()=>{},"warn"),error:o(()=>{},"error")},dn,cn,Hl=(r=>(r[r.NONE=0]="NONE",r[r.ERROR=1]="ERROR",r[r.WARN=2]="WARN",r[r.INFO=3]="INFO",r[r.DEBUG=4]="DEBUG",r))(Hl||{});(r=>{function e(){dn=3,cn=RN}o(e,"reset"),r.reset=e;function t(i){if(!(0<=i&&i<=4))throw new Error("Invalid log level");dn=i}o(t,"setLevel"),r.setLevel=t;function n(i){cn=i}o(n,"setLogger"),r.setLogger=n})(Hl||(Hl={}));var Yt,mt=(Yt=class{constructor(e){this._name=e}debug(...e){dn>=4&&cn.debug(Yt._format(this._name,this._method),...e)}info(...e){dn>=3&&cn.info(Yt._format(this._name,this._method),...e)}warn(...e){dn>=2&&cn.warn(Yt._format(this._name,this._method),...e)}error(...e){dn>=1&&cn.error(Yt._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const n=new Yt(`${e}.${t}`);return n.debug("begin"),n}static _format(e,t){const n=`[${e}]`;return t?`${n} ${t}:`:n}static debug(e,...t){dn>=4&&cn.debug(Yt._format(e),...t)}static info(e,...t){dn>=3&&cn.info(Yt._format(e),...t)}static warn(e,...t){dn>=2&&cn.warn(Yt._format(e),...t)}static error(e,...t){dn>=1&&cn.error(Yt._format(e),...t)}},o(Yt,"_Logger"),Yt);Hl.reset();var gs,Lc=(gs=class{static decode(e){try{return NI(e)}catch(t){throw mt.error("JwtUtils.decode",t),t}}static async generateSignedJwt(e,t,n){const i=Xr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=Xr.encodeBase64Url(new TextEncoder().encode(JSON.stringify(t))),s=`${i}.${a}`,l=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,new TextEncoder().encode(s)),u=Xr.encodeBase64Url(new Uint8Array(l));return`${s}.${u}`}},o(gs,"JwtUtils"),gs),IN="10000000-1000-4000-8000-100000000000",xm=o(r=>btoa([...new Uint8Array(r)].map(e=>String.fromCharCode(e)).join("")),"toBase64"),Xt,LI=(Xt=class{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return IN.replace(/[018]/g,t=>(+t^Xt._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return Xt.generateUUIDv4()+Xt.generateUUIDv4()+Xt.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const n=new TextEncoder().encode(e),i=await crypto.subtle.digest("SHA-256",n);return xm(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw mt.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const i=new TextEncoder().encode([e,t].join(":"));return xm(i)}static async hash(e,t){const n=new TextEncoder().encode(t),i=await crypto.subtle.digest(e,n);return new Uint8Array(i)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const n=await Xt.hash("SHA-256",JSON.stringify(t));return Xt.encodeBase64Url(n)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:n,keyPair:i,nonce:a}){let s,l;const u={jti:window.crypto.randomUUID(),htm:n??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(s=await Xt.hash("SHA-256",t),l=Xt.encodeBase64Url(s),u.ath=l),a&&(u.nonce=a);try{const d=await crypto.subtle.exportKey("jwk",i.publicKey),c={alg:"ES256",typ:"dpop+jwt",jwk:{crv:d.crv,kty:d.kty,x:d.x,y:d.y}};return await Lc.generateSignedJwt(c,u,i.privateKey)}catch(d){throw d instanceof TypeError?new Error(`Error exporting dpop public key: ${d.message}`):d}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await Xt.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}},o(Xt,"_CryptoUtils"),Xt);LI.encodeBase64Url=r=>xm(r).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var Xr=LI,ys,CN=(ys=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new mt(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},o(ys,"Event"),ys),Bn,Uc=(Bn=class extends CN{constructor(){super(...arguments),this._logger=new mt(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Bn.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Bn.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const n=Bn.getEpochTime()+e;if(this.expiration===n&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=n;const i=Math.min(e,5);this._timerHandle=setInterval(this._callback,i*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},o(Bn,"_Timer"),Bn),Ss,f0=(Ss=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");const i=new URL(e,"http://127.0.0.1")[t==="fragment"?"hash":"search"];return new URLSearchParams(i.slice(1))}},o(Ss,"UrlUtils"),Ss),Xs=";",Es,Zs=(Es=class extends Error{constructor(e,t){var n,i,a;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw mt.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=(n=e.error_description)!=null?n:null,this.error_uri=(i=e.error_uri)!=null?i:null,this.state=e.userState,this.session_state=(a=e.session_state)!=null?a:null,this.url_state=e.url_state}},o(Es,"ErrorResponse"),Es),_s,ON=(_s=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},o(_s,"ErrorTimeout"),_s),bs,kN=(bs=class{constructor(){this._logger=new mt("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},o(bs,"InMemoryWebStorage"),bs),ws,Dm=(ws=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},o(ws,"ErrorDPoPNonce"),ws),Ts,cy=(Ts=class{constructor(e=[],t=null,n={}){this._jwtHandler=t,this._extraHeaders=n,this._logger=new mt("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){const{timeoutInSeconds:n,...i}=t;if(!n)return await fetch(e,i);const a=new AbortController,s=setTimeout(()=>a.abort(),n*1e3);try{return await fetch(e,{...t,signal:a.signal})}catch(l){throw l instanceof DOMException&&l.name==="AbortError"?new ON("Network timed out"):l}finally{clearTimeout(s)}}async getJson(e,{token:t,credentials:n,timeoutInSeconds:i}={}){const a=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};t&&(a.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+t),this._appendExtraHeaders(s);let l;try{a.debug("url:",e),l=await this.fetchWithTimeout(e,{method:"GET",headers:s,timeoutInSeconds:i,credentials:n})}catch(c){throw a.error("Network Error"),c}a.debug("HTTP response received, status",l.status);const u=l.headers.get("Content-Type");if(u&&!this._contentTypes.find(c=>u.startsWith(c))&&a.throw(new Error(`Invalid response Content-Type: ${u??"undefined"}, from URL: ${e}`)),l.ok&&this._jwtHandler&&(u!=null&&u.startsWith("application/jwt")))return await this._jwtHandler(await l.text());let d;try{d=await l.json()}catch(c){throw a.error("Error parsing JSON response",c),l.ok?c:new Error(`${l.statusText} (${l.status})`)}if(!l.ok)throw a.error("Error from server:",d),d.error?new Zs(d):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(d)}`);return d}async postForm(e,{body:t,basicAuth:n,timeoutInSeconds:i,initCredentials:a,extraHeaders:s}){const l=this._logger.create("postForm"),u={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...s};n!==void 0&&(u.Authorization="Basic "+n),this._appendExtraHeaders(u);let d;try{l.debug("url:",e),d=await this.fetchWithTimeout(e,{method:"POST",headers:u,body:t,timeoutInSeconds:i,credentials:a})}catch(g){throw l.error("Network error"),g}l.debug("HTTP response received, status",d.status);const c=d.headers.get("Content-Type");if(c&&!this._contentTypes.find(g=>c.startsWith(g)))throw new Error(`Invalid response Content-Type: ${c??"undefined"}, from URL: ${e}`);const h=await d.text();let v={};if(h)try{v=JSON.parse(h)}catch(g){throw l.error("Error parsing JSON response",g),d.ok?g:new Error(`${d.statusText} (${d.status})`)}if(!d.ok){if(l.error("Error from server:",v),d.headers.has("dpop-nonce")){const g=d.headers.get("dpop-nonce");throw new Dm(g,`${JSON.stringify(v)}`)}throw v.error?new Zs(v,t):new Error(`${d.statusText} (${d.status}): ${JSON.stringify(v)}`)}return v}_appendExtraHeaders(e){const t=this._logger.create("appendExtraHeaders"),n=Object.keys(this._extraHeaders),i=["accept","content-type"],a=["authorization"];n.length!==0&&n.forEach(s=>{if(i.includes(s.toLocaleLowerCase())){t.warn("Protected header could not be set",s,i);return}if(a.includes(s.toLocaleLowerCase())&&Object.keys(e).includes(s)){t.warn("Header could not be overridden",s,a);return}const l=typeof this._extraHeaders[s]=="function"?this._extraHeaders[s]():this._extraHeaders[s];l&&l!==""&&(e[s]=l)})}},o(Ts,"JsonService"),Ts),Rs,UI=(Rs=class{constructor(e){this._settings=e,this._logger=new mt("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new cy(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);const t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},t,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){const n=this._logger.create(`_getMetadataProperty('${e}')`),i=await this.getMetadata();if(n.debug("resolved"),i[e]===void 0){if(t===!0){n.warn("Metadata does not contain optional property");return}n.throw(new Error("Metadata does not contain property "+e))}return i[e]}async getSigningKeys(){const e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;const t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);const n=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",n),!Array.isArray(n.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=n.keys,this._signingKeys}},o(Rs,"MetadataService"),Rs),Is,Nh=(Is=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new mt("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){return this._logger.create(`get('${e}')`),e=this._prefix+e,await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");const e=await this._store.length,t=[];for(let n=0;n<e;n++){const i=await this._store.key(n);i&&i.indexOf(this._prefix)===0&&t.push(i.substr(this._prefix.length))}return t}},o(Is,"WebStorageStateStore"),Is),PN="code",MN="openid",AN="client_secret_post",xN=60*15,Cs,Nm=(Cs=class{constructor({authority:e,metadataUrl:t,metadata:n,signingKeys:i,metadataSeed:a,client_id:s,client_secret:l,response_type:u=PN,scope:d=MN,redirect_uri:c,post_logout_redirect_uri:h,client_authentication:v=AN,prompt:g,display:p,max_age:m,ui_locales:w,acr_values:y,resource:S,response_mode:T,filterProtocolClaims:C=!0,loadUserInfo:M=!1,requestTimeoutInSeconds:_,staleStateAgeInSeconds:O=xN,mergeClaimsStrategy:b={array:"replace"},disablePKCE:j=!1,stateStore:B,revokeTokenAdditionalContentTypes:q,fetchRequestCredentials:oe,refreshTokenAllowedScope:de,extraQueryParams:Ne={},extraTokenParams:Oe={},extraHeaders:Ae={},dpop:ae,omitScopeWhenRequesting:X=!1}){var ue;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=n,this.metadataSeed=a,this.signingKeys=i,this.client_id=s,this.client_secret=l,this.response_type=u,this.scope=d,this.redirect_uri=c,this.post_logout_redirect_uri=h,this.client_authentication=v,this.prompt=g,this.display=p,this.max_age=m,this.ui_locales=w,this.acr_values=y,this.resource=S,this.response_mode=T,this.filterProtocolClaims=C??!0,this.loadUserInfo=!!M,this.staleStateAgeInSeconds=O,this.mergeClaimsStrategy=b,this.omitScopeWhenRequesting=X,this.disablePKCE=!!j,this.revokeTokenAdditionalContentTypes=q,this.fetchRequestCredentials=oe||"same-origin",this.requestTimeoutInSeconds=_,B)this.stateStore=B;else{const ge=typeof window<"u"?window.localStorage:new kN;this.stateStore=new Nh({store:ge})}if(this.refreshTokenAllowedScope=de,this.extraQueryParams=Ne,this.extraTokenParams=Oe,this.extraHeaders=Ae,this.dpop=ae,this.dpop&&!((ue=this.dpop)!=null&&ue.store))throw new Error("A DPoPStore is required when dpop is enabled")}},o(Cs,"OidcClientSettingsStore"),Cs),Os,DN=(Os=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new mt("UserInfoService"),this._getClaimsFromJwt=async n=>{const i=this._logger.create("_getClaimsFromJwt");try{const a=Lc.decode(n);return i.debug("JWT decoding successful"),a}catch(a){throw i.error("Error parsing JWT response"),a}},this._jsonService=new cy(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){const t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));const n=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",n);const i=await this._jsonService.getJson(n,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",i),i}},o(Os,"UserInfoService"),Os),ks,jI=(ks=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new mt("TokenClient"),this._jsonService=new cy(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:n=this._settings.client_id,client_secret:i=this._settings.client_secret,extraHeaders:a,...s}){const l=this._logger.create("exchangeCode");n||l.throw(new Error("A client_id is required")),t||l.throw(new Error("A redirect_uri is required")),s.code||l.throw(new Error("A code is required"));const u=new URLSearchParams({grant_type:e,redirect_uri:t});for(const[v,g]of Object.entries(s))g!=null&&u.set(v,g);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(i==null)throw l.throw(new Error("A client_secret is required")),null;d=Xr.generateBasicAuth(n,i);break;case"client_secret_post":u.append("client_id",n),i&&u.append("client_secret",i);break}const c=await this._metadataService.getTokenEndpoint(!1);l.debug("got token endpoint");const h=await this._jsonService.postForm(c,{body:u,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:a});return l.debug("got response"),h}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,scope:i=this._settings.scope,...a}){const s=this._logger.create("exchangeCredentials");t||s.throw(new Error("A client_id is required"));const l=new URLSearchParams({grant_type:e});this._settings.omitScopeWhenRequesting||l.set("scope",i);for(const[h,v]of Object.entries(a))v!=null&&l.set(h,v);let u;switch(this._settings.client_authentication){case"client_secret_basic":if(n==null)throw s.throw(new Error("A client_secret is required")),null;u=Xr.generateBasicAuth(t,n);break;case"client_secret_post":l.append("client_id",t),n&&l.append("client_secret",n);break}const d=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const c=await this._jsonService.postForm(d,{body:l,basicAuth:u,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return s.debug("got response"),c}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:n=this._settings.client_secret,timeoutInSeconds:i,extraHeaders:a,...s}){const l=this._logger.create("exchangeRefreshToken");t||l.throw(new Error("A client_id is required")),s.refresh_token||l.throw(new Error("A refresh_token is required"));const u=new URLSearchParams({grant_type:e});for(const[v,g]of Object.entries(s))Array.isArray(g)?g.forEach(p=>u.append(v,p)):g!=null&&u.set(v,g);let d;switch(this._settings.client_authentication){case"client_secret_basic":if(n==null)throw l.throw(new Error("A client_secret is required")),null;d=Xr.generateBasicAuth(t,n);break;case"client_secret_post":u.append("client_id",t),n&&u.append("client_secret",n);break}const c=await this._metadataService.getTokenEndpoint(!1);l.debug("got token endpoint");const h=await this._jsonService.postForm(c,{body:u,basicAuth:d,timeoutInSeconds:i,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:a});return l.debug("got response"),h}async revoke(e){var t;const n=this._logger.create("revoke");e.token||n.throw(new Error("A token is required"));const i=await this._metadataService.getRevocationEndpoint(!1);n.debug(`got revocation endpoint, revoking ${(t=e.token_type_hint)!=null?t:"default token type"}`);const a=new URLSearchParams;for(const[s,l]of Object.entries(e))l!=null&&a.set(s,l);a.set("client_id",this._settings.client_id),this._settings.client_secret&&a.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(i,{body:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),n.debug("got response")}},o(ks,"TokenClient"),ks),Ps,NN=(Ps=class{constructor(e,t,n){this._settings=e,this._metadataService=t,this._claimsService=n,this._logger=new mt("ResponseValidator"),this._userInfoService=new DN(this._settings,this._metadataService),this._tokenClient=new jI(this._settings,this._metadataService)}async validateSigninResponse(e,t,n){const i=this._logger.create("validateSigninResponse");this._processSigninState(e,t),i.debug("state processed"),await this._processCode(e,t,n),i.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),i.debug("tokens validated"),await this._processClaims(e,t==null?void 0:t.skipUserInfo,e.isOpenId),i.debug("claims processed")}async validateCredentialsResponse(e,t){const n=this._logger.create("validateCredentialsResponse"),i=e.isOpenId&&!!e.id_token;i&&this._validateIdTokenAttributes(e),n.debug("tokens validated"),await this._processClaims(e,t,i),n.debug("claims processed")}async validateRefreshResponse(e,t){var n,i;const a=this._logger.create("validateRefreshResponse");e.userState=t.data,(n=e.session_state)!=null||(e.session_state=t.session_state),(i=e.scope)!=null||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),a.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);const s=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,s),a.debug("claims processed")}validateSignoutResponse(e,t){const n=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&n.throw(new Error("State does not match")),n.debug("state validated"),e.userState=t.data,e.error)throw n.warn("Response was error",e.error),new Zs(e)}_processSigninState(e,t){var n;const i=this._logger.create("_processSigninState");if(t.id!==e.state&&i.throw(new Error("State does not match")),t.client_id||i.throw(new Error("No client_id on state")),t.authority||i.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&i.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&i.throw(new Error("client_id mismatch on settings vs. signin state")),i.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,(n=e.scope)!=null||(e.scope=t.scope),e.error)throw i.warn("Response was error",e.error),new Zs(e);t.code_verifier&&!e.code&&i.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,n=!0){const i=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token){i.debug("not loading user info");return}i.debug("loading user info");const a=await this._userInfoService.getClaims(e.access_token);i.debug("user info claims received from user info endpoint"),n&&a.sub!==e.profile.sub&&i.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(a)),i.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,n){const i=this._logger.create("_processCode");if(e.code){i.debug("Validating code");const a=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:n,...t.extraTokenParams});Object.assign(e,a)}else i.debug("No code to process")}_validateIdTokenAttributes(e,t){var n;const i=this._logger.create("_validateIdTokenAttributes");i.debug("decoding ID Token JWT");const a=Lc.decode((n=e.id_token)!=null?n:"");if(a.sub||i.throw(new Error("ID Token is missing a subject claim")),t){const s=Lc.decode(t);a.sub!==s.sub&&i.throw(new Error("sub in id_token does not match current sub")),a.auth_time&&a.auth_time!==s.auth_time&&i.throw(new Error("auth_time in id_token does not match original auth_time")),a.azp&&a.azp!==s.azp&&i.throw(new Error("azp in id_token does not match original azp")),!a.azp&&s.azp&&i.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=a}},o(Ps,"ResponseValidator"),Ps),Mi,jc=(Mi=class{constructor(e){this.id=e.id||Xr.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=Uc.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new mt("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return mt.createStatic("State","fromStorageString"),Promise.resolve(new Mi(JSON.parse(e)))}static async clearStaleState(e,t){const n=mt.createStatic("State","clearStaleState"),i=Uc.getEpochTime()-t,a=await e.getAllKeys();n.debug("got keys",a);for(let s=0;s<a.length;s++){const l=a[s],u=await e.get(l);let d=!1;if(u)try{const c=await Mi.fromStorageString(u);n.debug("got item from key:",l,c.created),c.created<=i&&(d=!0)}catch(c){n.error("Error parsing state for key:",l,c),d=!0}else n.debug("no item in storage for key:",l),d=!0;d&&(n.debug("removed item for key:",l),e.remove(l))}}},o(Mi,"_State"),Mi),Ai,hy=(Ai=class extends jc{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?Xr.generateCodeVerifier():e.code_verifier||void 0,n=t?await Xr.generateCodeChallenge(t):void 0;return new Ai({...e,code_verifier:t,code_challenge:n})}toStorageString(){return new mt("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){mt.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return Ai.create(t)}},o(Ai,"_SigninState"),Ai),va,FI=(va=class{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:n,redirect_uri:i,response_type:a,scope:s,state_data:l,response_mode:u,request_type:d,client_secret:c,nonce:h,url_state:v,resource:g,skipUserInfo:p,extraQueryParams:m,extraTokenParams:w,disablePKCE:y,dpopJkt:S,omitScopeWhenRequesting:T,...C}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const M=await hy.create({data:l,request_type:d,url_state:v,code_verifier:!y,client_id:n,authority:t,redirect_uri:i,response_mode:u,client_secret:c,scope:s,extraTokenParams:w,skipUserInfo:p}),_=new URL(e);_.searchParams.append("client_id",n),_.searchParams.append("redirect_uri",i),_.searchParams.append("response_type",a),T||_.searchParams.append("scope",s),h&&_.searchParams.append("nonce",h),S&&_.searchParams.append("dpop_jkt",S);let O=M.id;v&&(O=`${O}${Xs}${v}`),_.searchParams.append("state",O),M.code_challenge&&(_.searchParams.append("code_challenge",M.code_challenge),_.searchParams.append("code_challenge_method","S256")),g&&(Array.isArray(g)?g:[g]).forEach(j=>_.searchParams.append("resource",j));for(const[b,j]of Object.entries({response_mode:u,...C,...m}))j!=null&&_.searchParams.append(b,j.toString());return new va({url:_.href,state:M})}},o(va,"_SigninRequest"),va);FI._logger=new mt("SigninRequest");var LN=FI,UN="openid",Ms,Ed=(Ms=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){const t=decodeURIComponent(this.state).split(Xs);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(Xs))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-Uc.getEpochTime()}set expires_in(e){typeof e=="string"&&(e=Number(e)),e!==void 0&&e>=0&&(this.expires_at=Math.floor(e)+Uc.getEpochTime())}get isOpenId(){var e;return((e=this.scope)==null?void 0:e.split(" ").includes(UN))||!!this.id_token}},o(Ms,"SigninResponse"),Ms),As,jN=(As=class{constructor({url:e,state_data:t,id_token_hint:n,post_logout_redirect_uri:i,extraQueryParams:a,request_type:s,client_id:l,url_state:u}){if(this._logger=new mt("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");const d=new URL(e);if(n&&d.searchParams.append("id_token_hint",n),l&&d.searchParams.append("client_id",l),i&&(d.searchParams.append("post_logout_redirect_uri",i),t||u)){this.state=new jc({data:t,request_type:s,url_state:u});let c=this.state.id;u&&(c=`${c}${Xs}${u}`),d.searchParams.append("state",c)}for(const[c,h]of Object.entries({...a}))h!=null&&d.searchParams.append(c,h.toString());this.url=d.href}},o(As,"SignoutRequest"),As),xs,FN=(xs=class{constructor(e){if(this.state=e.get("state"),this.state){const t=decodeURIComponent(this.state).split(Xs);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(Xs))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},o(xs,"SignoutResponse"),xs),BN=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],$N=["sub","iss","aud","exp","iat"],Ds,WN=(Ds=class{constructor(e){this._settings=e,this._logger=new mt("ClaimsService")}filterProtocolClaims(e){const t={...e};if(this._settings.filterProtocolClaims){let n;Array.isArray(this._settings.filterProtocolClaims)?n=this._settings.filterProtocolClaims:n=BN;for(const i of n)$N.includes(i)||delete t[i]}return t}mergeClaims(e,t){const n={...e};for(const[i,a]of Object.entries(t))if(n[i]!==a)if(Array.isArray(n[i])||Array.isArray(a))if(this._settings.mergeClaimsStrategy.array=="replace")n[i]=a;else{const s=Array.isArray(n[i])?n[i]:[n[i]];for(const l of Array.isArray(a)?a:[a])s.includes(l)||s.push(l);n[i]=s}else typeof n[i]=="object"&&typeof a=="object"?n[i]=this.mergeClaims(n[i],a):n[i]=a;return n}},o(Ds,"ClaimsService"),Ds),Ns,KN=(Ns=class{constructor(e,t){this.keys=e,this.nonce=t}},o(Ns,"DPoPState"),Ns),Ls,fy=(Ls=class{constructor(e,t){this._logger=new mt("OidcClient"),this.settings=e instanceof Nm?e:new Nm(e),this.metadataService=t??new UI(this.settings),this._claimsService=new WN(this.settings),this._validator=new NN(this.settings,this.metadataService,this._claimsService),this._tokenClient=new jI(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:n,request_type:i,id_token_hint:a,login_hint:s,skipUserInfo:l,nonce:u,url_state:d,response_type:c=this.settings.response_type,scope:h=this.settings.scope,redirect_uri:v=this.settings.redirect_uri,prompt:g=this.settings.prompt,display:p=this.settings.display,max_age:m=this.settings.max_age,ui_locales:w=this.settings.ui_locales,acr_values:y=this.settings.acr_values,resource:S=this.settings.resource,response_mode:T=this.settings.response_mode,extraQueryParams:C=this.settings.extraQueryParams,extraTokenParams:M=this.settings.extraTokenParams,dpopJkt:_,omitScopeWhenRequesting:O=this.settings.omitScopeWhenRequesting}){const b=this._logger.create("createSigninRequest");if(c!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const j=await this.metadataService.getAuthorizationEndpoint();b.debug("Received authorization endpoint",j);const B=await LN.create({url:j,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:v,response_type:c,scope:h,state_data:e,url_state:d,prompt:g,display:p,max_age:m,ui_locales:w,id_token_hint:a,login_hint:s,acr_values:y,dpopJkt:_,resource:S,request:t,request_uri:n,extraQueryParams:C,extraTokenParams:M,request_type:i,response_mode:T,client_secret:this.settings.client_secret,skipUserInfo:l,nonce:u,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:O});await this.clearStaleState();const q=B.state;return await this.settings.stateStore.set(q.id,q.toStorageString()),B}async readSigninResponseState(e,t=!1){const n=this._logger.create("readSigninResponseState"),i=new Ed(f0.readParams(e,this.settings.response_mode));if(!i.state)throw n.throw(new Error("No state in response")),null;const a=await this.settings.stateStore[t?"remove":"get"](i.state);if(!a)throw n.throw(new Error("No matching state found in storage")),null;return{state:await hy.fromStorageString(a),response:i}}async processSigninResponse(e,t,n=!0){const i=this._logger.create("processSigninResponse"),{state:a,response:s}=await this.readSigninResponseState(e,n);if(i.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const l=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:l}}try{await this._validator.validateSigninResponse(s,a,t)}catch(l){if(l instanceof Dm&&this.settings.dpop){const u=await this.getDpopProof(this.settings.dpop.store,l.nonce);t.DPoP=u,await this._validator.validateSigninResponse(s,a,t)}else throw l}return s}async getDpopProof(e,t){let n,i;return(await e.getAllKeys()).includes(this.settings.client_id)?(i=await e.get(this.settings.client_id),i.nonce!==t&&t&&(i.nonce=t,await e.set(this.settings.client_id,i))):(n=await Xr.generateDPoPKeys(),i=new KN(n,t),await e.set(this.settings.client_id,i)),await Xr.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:i.keys,nonce:i.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:n=!1,extraTokenParams:i={}}){const a=await this._tokenClient.exchangeCredentials({username:e,password:t,...i}),s=new Ed(new URLSearchParams);return Object.assign(s,a),await this._validator.validateCredentialsResponse(s,n),s}async useRefreshToken({state:e,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,extraTokenParams:s}){var l;const u=this._logger.create("useRefreshToken");let d;if(this.settings.refreshTokenAllowedScope===void 0)d=e.scope;else{const v=this.settings.refreshTokenAllowedScope.split(" ");d=(((l=e.scope)==null?void 0:l.split(" "))||[]).filter(p=>v.includes(p)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const v=await this.getDpopProof(this.settings.dpop.store);a={...a,DPoP:v}}let c;try{c=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:d,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,...s})}catch(v){if(v instanceof Dm&&this.settings.dpop)a.DPoP=await this.getDpopProof(this.settings.dpop.store,v.nonce),c=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:d,redirect_uri:t,resource:n,timeoutInSeconds:i,extraHeaders:a,...s});else throw v}const h=new Ed(new URLSearchParams);return Object.assign(h,c),u.debug("validating response",h),await this._validator.validateRefreshResponse(h,{...e,scope:d}),h}async createSignoutRequest({state:e,id_token_hint:t,client_id:n,request_type:i,url_state:a,post_logout_redirect_uri:s=this.settings.post_logout_redirect_uri,extraQueryParams:l=this.settings.extraQueryParams}={}){const u=this._logger.create("createSignoutRequest"),d=await this.metadataService.getEndSessionEndpoint();if(!d)throw u.throw(new Error("No end session endpoint")),null;u.debug("Received end session endpoint",d),!n&&s&&!t&&(n=this.settings.client_id);const c=new jN({url:d,id_token_hint:t,client_id:n,post_logout_redirect_uri:s,state_data:e,extraQueryParams:l,request_type:i,url_state:a});await this.clearStaleState();const h=c.state;return h&&(u.debug("Signout request has state to persist"),await this.settings.stateStore.set(h.id,h.toStorageString())),c}async readSignoutResponseState(e,t=!1){const n=this._logger.create("readSignoutResponseState"),i=new FN(f0.readParams(e,this.settings.response_mode));if(!i.state){if(n.debug("No state in response"),i.error)throw n.warn("Response was error:",i.error),new Zs(i);return{state:void 0,response:i}}const a=await this.settings.stateStore[t?"remove":"get"](i.state);if(!a)throw n.throw(new Error("No matching state found in storage")),null;return{state:await jc.fromStorageString(a),response:i}}async processSignoutResponse(e){const t=this._logger.create("processSignoutResponse"),{state:n,response:i}=await this.readSignoutResponseState(e,!0);return n?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(i,n)):t.debug("No state from storage; skipping response validation"),i}clearStaleState(){return this._logger.create("clearStaleState"),jc.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}},o(Ls,"OidcClient"),Ls),qt=function(r){return r.NotSupported="OIDC authentication not supported",r.Misconfigured="OIDC is misconfigured",r.General="Something went wrong with OIDC discovery",r.OpSupport="Configured OIDC OP does not support required functions",r.DynamicRegistrationNotSupported="Dynamic registration not supported",r.DynamicRegistrationFailed="Dynamic registration failed",r.DynamicRegistrationInvalid="Dynamic registration invalid response",r.CodeExchangeFailed="Failed to exchange code for token",r.InvalidBearerTokenResponse="Invalid bearer token response",r.InvalidIdToken="Invalid ID token",r.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",r}({}),vy=o(r=>!!r&&typeof r=="object"&&!Array.isArray(r),"isRecord"),Fn=o((r,e)=>!r[e]||!ll(r,e)?(I.error("Missing or invalid property: ".concat(e)),!1):!0,"requiredStringProperty"),ll=o((r,e)=>r[e]&&typeof r[e]!="string"?(I.error("Invalid property: ".concat(e)),!1):!0,"optionalStringProperty"),v0=o((r,e)=>r[e]&&(!Array.isArray(r[e])||!r[e].every(t=>typeof t=="string"))?(I.error("Invalid property: ".concat(e)),!1):!0,"optionalStringArrayProperty"),$f=o((r,e,t)=>{var n=r[e];return!n||!Array.isArray(n)||!n.includes(t)?(I.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},"requiredArrayValue"),BI=o(r=>{if(!vy(r))throw I.error("Issuer configuration not found or malformed"),new Error(qt.OpSupport);var e=[Fn(r,"issuer"),Fn(r,"authorization_endpoint"),Fn(r,"token_endpoint"),Fn(r,"revocation_endpoint"),ll(r,"registration_endpoint"),ll(r,"account_management_uri"),ll(r,"device_authorization_endpoint"),v0(r,"account_management_actions_supported"),$f(r,"response_types_supported","code"),$f(r,"grant_types_supported","authorization_code"),$f(r,"code_challenge_methods_supported","S256"),v0(r,"prompt_values_supported")].some(t=>!t);if(!e)return r;throw I.error("Issuer configuration not valid"),new Error(qt.OpSupport)},"validateAuthMetadata"),$I=o(r=>{try{return NI(r)}catch(e){throw I.error("Could not decode id_token",e),e}},"decodeIdToken"),WI=o((r,e,t,n)=>{try{if(!r)throw new Error("No ID token");var i=$I(r);if(i.iss!==e)throw new Error("Invalid issuer");var a=typeof i.aud=="string"?[i.aud]:i.aud;if(!a.includes(t))throw new Error("Invalid audience");if(n!==void 0&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>i.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw I.error("Invalid ID token",s),new Error(qt.InvalidIdToken)}},"validateIdToken");function KI(r){if(!vy(r))throw I.error("Stored user state not found"),new Error(qt.MissingOrInvalidStoredState);var e=[Fn(r,"homeserverUrl"),Fn(r,"nonce"),ll(r,"identityServerUrl")].some(t=>!t);if(e)throw new Error(qt.MissingOrInvalidStoredState)}o(KI,"validateStoredUserState");var VN=o(r=>vy(r)&&Fn(r,"token_type")&&r.token_type.toLowerCase()==="bearer"&&Fn(r,"access_token")&&Fn(r,"refresh_token")&&(!("expires_in"in r)||typeof r.expires_in=="number"),"isValidBearerTokenResponse");function VI(r){if(!VN(r))throw new Error(qt.InvalidBearerTokenResponse)}o(VI,"validateBearerTokenResponse");function p0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(p0,"ownKeys$4");function Fc(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?p0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):p0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Fc,"_objectSpread$4");var Lh=o(r=>{var e=r??ki(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},"generateScope"),GN=function(){var r=R(function*(e){if(!globalThis.crypto.subtle)return I.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield DI(e);return Ah(t)});return o(function(t){return r.apply(this,arguments)},"generateCodeChallenge")}(),qN=o(r=>{var{redirectUri:e}=r;return{scope:Lh(),redirectUri:e,state:ki(8),nonce:ki(8),codeVerifier:ki(64)}},"generateAuthorizationParams"),HN=function(){var r=R(function*(e,t,n){var{scope:i,redirectUri:a,state:s,nonce:l,codeVerifier:u}=n,d=new URL(e);return d.searchParams.append("response_mode","query"),d.searchParams.append("response_type","code"),d.searchParams.append("redirect_uri",a),d.searchParams.append("client_id",t),d.searchParams.append("state",s),d.searchParams.append("scope",i),d.searchParams.append("nonce",l),d.searchParams.append("code_challenge_method","S256"),d.searchParams.append("code_challenge",yield GN(u)),d.toString()});return o(function(t,n,i){return r.apply(this,arguments)},"generateAuthorizationUrl")}(),zN=function(){var r=R(function*(e){var{metadata:t,redirectUri:n,clientId:i,homeserverUrl:a,identityServerUrl:s,nonce:l,prompt:u,urlState:d}=e,c=Lh(),h=new fy(Fc(Fc({},t),{},{client_id:i,redirect_uri:n,authority:t.issuer,response_mode:"query",response_type:"code",scope:c,stateStore:new Nh({prefix:"mx_oidc_",store:window.sessionStorage})})),v={homeserverUrl:a,nonce:l,identityServerUrl:s},g=yield h.createSigninRequest({state:v,nonce:l,prompt:u,url_state:d});return g.url});return o(function(t){return r.apply(this,arguments)},"generateOidcAuthorizationUrl")}(),JN=o(r=>({id_token:r.id_token,scope:r.scope,expires_at:r.expires_at,refresh_token:r.refresh_token,access_token:r.access_token,token_type:"Bearer"}),"normalizeBearerTokenResponseTokenType"),QN=function(){var r=R(function*(e,t){var n=new URL(window.location.origin);n.searchParams.append("code",e),n.searchParams.append("state",t),Hl.setLogger(I);try{var i=new Ed(n.searchParams),a=new Nh({prefix:"mx_oidc_",store:window.sessionStorage}),s=yield a.get(i.state);if(!s)throw new Error(qt.MissingOrInvalidStoredState);var l=yield hy.fromStorageString(s),u=new fy(Fc(Fc({},l),{},{stateStore:a})),d=yield u.processSigninResponse(n.href),c=d.userState;KI(c),VI(d),WI(d.id_token,u.settings.authority,u.settings.client_id,c.nonce);var h=JN(d);return{oidcClientSettings:{clientId:u.settings.client_id,issuer:u.settings.authority},tokenResponse:h,homeserverUrl:c.homeserverUrl,identityServerUrl:c.identityServerUrl,idTokenClaims:d.profile}}catch(g){I.error("Oidc login failed",g);var v=g.message;throw Object.values(qt).includes(v)?g:new Error(qt.CodeExchangeFailed)}});return o(function(t,n){return r.apply(this,arguments)},"completeAuthorizationCodeGrant")}();function m0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(m0,"ownKeys$3");function g0(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?m0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):m0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(g0,"_objectSpread$3");var py=function(){var r=R(function*(e){var t=new URL(".well-known/openid-configuration",e),n=yield fetch(t,{method:G.Get,signal:Mh(5e3)}),i=yield n.json();return my(i)});return o(function(t){return r.apply(this,arguments)},"discoverAndValidateOIDCIssuerWellKnown")}(),my=function(){var r=R(function*(e){var t=BI(e),n=new Nm({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),i=new UI(n);return g0(g0({},t),{},{signingKeys:yield i.getSigningKeys()})});return o(function(t){return r.apply(this,arguments)},"validateAuthMetadataAndKeys")}(),YN="urn:ietf:params:oauth:grant-type:device_code",Wf=o((r,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==r.protocol||t.hostname!==r.hostname&&!t.hostname.endsWith(".".concat(r.hostname)))},"urlHasCommonBase"),XN=function(){var r=R(function*(e,t){if(!e.registration_endpoint)throw new Error(qt.DynamicRegistrationNotSupported);var n=["authorization_code","refresh_token"];if(n.some(c=>!e.grant_types_supported.includes(c)))throw new Error(qt.DynamicRegistrationNotSupported);var i=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:n,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:Wf(i,t.logoUri)?t.logoUri:void 0,policy_uri:Wf(i,t.policyUri)?t.policyUri:void 0,tos_uri:Wf(i,t.tosUri)?t.tosUri:void 0},s={Accept:"application/json","Content-Type":"application/json"};try{var l=yield fetch(e.registration_endpoint,{method:G.Post,headers:s,body:JSON.stringify(a)});if(l.status>=400)throw new Error(qt.DynamicRegistrationFailed);var u=yield l.json(),d=u.client_id;if(!d||typeof d!="string")throw new Error(qt.DynamicRegistrationInvalid);return d}catch(c){throw Object.values(qt).includes(c.message)?c:(I.error("Dynamic registration request failed",c),new Error(qt.DynamicRegistrationFailed))}});return o(function(t,n){return r.apply(this,arguments)},"registerOidcClient")}();const ZS=class ZS{constructor(e,t,n,i,a){this.idTokenClaims=a,f(this,"oidcClientReady",void 0),f(this,"oidcClient",void 0),f(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,i,n)}initialiseOidcClient(e,t,n,i){var a=this;return R(function*(){try{var s,l=yield py(e),u=Lh(n);a.oidcClient=new fy({metadata:l,signingKeys:(s=l.signingKeys)!==null&&s!==void 0?s:void 0,client_id:t,scope:u,redirect_uri:i,authority:l.issuer,stateStore:new Nh({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(d){throw I.error("Failed to initialise OIDC client.",d),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return R(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var n=yield t.inflightRefreshRequest;return n}catch(i){throw i instanceof Zs?new Ul(i):i}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return R(function*(){})()}getNewTokens(e){var t=this;return R(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var n={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},i=Date.now(),a=yield t.oidcClient.useRefreshToken({state:n,timeoutInSeconds:300}),s={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(i+a.expires_in*1e3):void 0};return yield t.persistTokens(s),s})()}};o(ZS,"OidcTokenRefresher");let Lm=ZS;var ZN=["server","limit","since"];function y0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(y0,"ownKeys$2");function Tt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?y0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):y0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Tt,"_objectSpread$2");var eL=3e3,S0=10*60*1e3,tL=new gt("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),eo=function(r){return r.Chronological="chronological",r.Detached="detached",r}({}),rL=new au("m.get_login_token","org.matrix.msc3882.get_login_token"),GI="uk.half-shot.msc2666",qI="uk.half-shot.msc2666.mutual_rooms",HI="uk.half-shot.msc2666.query_mutual_rooms",vn="org.matrix.msc4140",zI="uk.tcpip.msc4133",an="$",ve=function(r){return r.Sync="sync",r.Event="event",r.ToDeviceEvent="toDeviceEvent",r.ReceivedToDeviceMessage="receivedToDeviceMessage",r.AccountData="accountData",r.Room="Room",r.DeleteRoom="deleteRoom",r.SyncUnexpectedError="sync.unexpectedError",r.ClientWellKnown="WellKnown.client",r.ReceivedVoipEvent="received_voip_event",r.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",r.TurnServers="turnServers",r.TurnServersError="turnServers.error",r}({}),nL=new gt("action","org.matrix.msc3824.action");const eE=class eE extends Qe{constructor(e){var t,n,i,a;super(),i=this,f(this,"logger",void 0),f(this,"reEmitter",new Li(this)),f(this,"olmVersion",null),f(this,"usingExternalCrypto",!1),f(this,"_store",void 0),f(this,"deviceId",void 0),f(this,"credentials",void 0),f(this,"legacyPickleKey",void 0),f(this,"scheduler",void 0),f(this,"clientRunning",!1),f(this,"timelineSupport",!1),f(this,"urlPreviewCache",{}),f(this,"identityServer",void 0),f(this,"http",void 0),f(this,"cryptoBackend",void 0),f(this,"cryptoCallbacks",void 0),f(this,"callEventHandler",void 0),f(this,"groupCallEventHandler",void 0),f(this,"supportsCallTransfer",!1),f(this,"forceTURN",!1),f(this,"iceCandidatePoolSize",0),f(this,"idBaseUrl",void 0),f(this,"baseUrl",void 0),f(this,"isVoipWithNoMediaAllowed",void 0),f(this,"useLivekitForGroupCalls",void 0),f(this,"canSupportVoip",!1),f(this,"peekSync",null),f(this,"isGuestAccount",!1),f(this,"ongoingScrollbacks",{}),f(this,"notifTimelineSet",null),f(this,"legacyCryptoStore",void 0),f(this,"verificationMethods",void 0),f(this,"fallbackICEServerAllowed",!1),f(this,"syncApi",void 0),f(this,"roomNameGenerator",void 0),f(this,"pushRules",void 0),f(this,"syncLeftRoomsPromise",void 0),f(this,"syncedLeftRooms",!1),f(this,"clientOpts",void 0),f(this,"clientWellKnownIntervalID",void 0),f(this,"canResetTimelineCallback",void 0),f(this,"canSupport",new Map),f(this,"pushProcessor",new Wl(this)),f(this,"serverVersionsPromise",void 0),f(this,"clientWellKnown",void 0),f(this,"clientWellKnownPromise",void 0),f(this,"turnServers",[]),f(this,"turnServersExpiry",0),f(this,"checkTurnServersIntervalID",void 0),f(this,"txnCtr",0),f(this,"mediaHandler",new lm(this)),f(this,"sessionId",void 0),f(this,"eventsBeingEncrypted",new Set),f(this,"useE2eForGroupCall",!0),f(this,"toDeviceMessageQueue",void 0),f(this,"livekitServiceURL",void 0),f(this,"_secretStorage",void 0),f(this,"ignoredInvites",void 0),f(this,"matrixRTC",void 0),f(this,"serverCapabilitiesService",void 0),f(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(am()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ve.Sync,this.startCallEventHandler))}),f(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ve.Sync,this.startMatrixRTC))}),f(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var l,u=((l=this.getRooms())!==null&&l!==void 0?l:[]).filter(h=>h.getUnreadNotificationCount(Be.Total)>0);for(var d of u){var c=this.getSafeUserId();d.fixupNotifications(c)}this.off(ve.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:I,e.baseUrl=_f(e.baseUrl),e.idBaseUrl=_f(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(n=e.usingExternalCrypto)!==null&&n!==void 0?n:!1,this.store=e.store||new Bp,this.deviceId=e.deviceId||null,this.sessionId=ki(10);var s=e.userId||null;this.credentials={userId:s},this.http=new _c(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:It.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var l=R(function*(u){var d=i.getRoom(u.getRoomId());u.status!==we.SENDING&&i.updatePendingEventStatus(d,u,we.SENDING);var c=yield i.sendEventHttpRequest(u);return d&&d.updatePendingEvent(u,we.SENT,c.event_id),c});return function(u){return l.apply(this,arguments)}}()),am()&&(this.callEventHandler=new Vp(this),this.groupCallEventHandler=new qp(this),this.canSupportVoip=!0,this.on(ve.Sync,this.startCallEventHandler)),this.matrixRTC=new Mm(this.logger,this),this.serverCapabilitiesService=new bc(this.logger,this.http),this.on(ve.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new mm(this,this.logger),this.on(We.Decrypted,l=>{JI(this,l)}),this.ignoredInvites=new gm(this),this._secretStorage=new Mc(this,(a=e.cryptoCallbacks)!==null&&a!==void 0?a:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Wn.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return R(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ve.Sync,t.startMatrixRTC);var n=t.getUserId();n&&t.store.storeUser(new Wn(n)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},S0),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:i,list:a,fwdPagination:s}=yield t.doesServerSupportThread();_t.setServerSideSupport(i),_t.setServerSideListSupport(a),_t.setServerSideFwdPaginationSupport(s)}catch(l){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",l)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new Pc(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new mn(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(l=>t.logger.info("Sync startup aborted with an error:",l)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:o(e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,"canResetEntireTimeline"),logger:this.logger.getChild("sync")}}stopClient(){var e,t,n,i,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(ve.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(n=this.peekSync)===null||n===void 0||n.stopPeeking(),(i=this.callEventHandler)===null||i===void 0||i.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var i=function(){var a=R(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var l=o(function*(v){var g=new Promise((p,m)=>{e.logger.info("Removing IndexedDB instance ".concat(v));var w=s.deleteDatabase(v);w.onsuccess=y=>{e.logger.info("Removed IndexedDB instance ".concat(v)),p(0)},w.onerror=y=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(v,":"),y),p(0)},w.onblocked=y=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(v))}});yield g},"_loop");for(var u of["".concat((d=t.cryptoDatabasePrefix)!==null&&d!==void 0?d:Lf,"::matrix-sdk-crypto"),"".concat((c=t.cryptoDatabasePrefix)!==null&&c!==void 0?c:Lf,"::matrix-sdk-crypto-meta")]){var d,c;yield*l(u)}});return o(function(){return a.apply(this,arguments)},"deleteRustSdkStore")}();return n.push(i()),Promise.all(n).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return $l(this,e)}createGroupCall(e,t,n,i,a,s){var l=this;return R(function*(){if(l.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var u=l.getRoom(e);if(!u)throw new Error("Cannot find room ".concat(e));return new Bl(l,u,t,n,i,void 0,a||l.isVoipWithNoMediaAllowed,s,l.isVoipWithNoMediaAllowed,l.useLivekitForGroupCalls,l.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===Ve.Prepared||e===Ve.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return R(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return R(function*(){var n,i,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var l=t.getDeviceId();if(l===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var u=yield PD(()=>import("./index-CVURC0t9.js"),[]),d=yield u.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:l,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(n=a.cryptoDatabasePrefix)!==null&&n!==void 0?n:Lf,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(i=t.legacyPickleKey)!==null&&i!==void 0?i:"DEFAULT_KEY",legacyMigrationProgressListener:o((c,h)=>{t.emit(Ct.LegacyCryptoStoreMigrationProgress,c,h)},"legacyMigrationProgressListener")});d.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=d,t.on(cr.Membership,d.onRoomMembership.bind(d)),t.on(ve.Event,c=>{d.onLiveEventFromSync(c)}),t.reEmitter.reEmit(d,[Ct.VerificationRequestReceived,Ct.UserTrustStatusChanged,Ct.KeyBackupStatus,Ct.KeyBackupSessionsRemaining,Ct.KeyBackupFailed,Ct.KeyBackupDecryptionKeyCached,Ct.KeysChanged,Ct.DevicesUpdated,Ct.WillUpdateDevices,Ct.DehydratedDeviceCreated,Ct.DehydratedDeviceUploaded,Ct.RehydrationStarted,Ct.RehydrationProgress,Ct.RehydrationCompleted,Ct.RehydrationError,Ct.DehydrationKeyCached,Ct.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,n){var i;t!==void 0?i=se("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?i=se("/room_keys/keys/$roomId",{$roomId:e}):i="/room_keys/keys";var a=n===void 0?void 0:{version:n};return{path:i,queryData:a}}deleteKeysFromBackup(e,t,n){var i=this;return R(function*(){var a=i.makeKeyBackupPath(e,t,n);yield i.http.authedRequest(G.Delete,a.path,a.queryData,void 0,{prefix:It.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:e?It.V1:ds.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),n=new Set;for(var i of t){var a,s=(a=i.findPredecessor(e))===null||a===void 0?void 0:a.roomId;s&&n.add(s)}return t.filter(l=>{var u=l.currentState.getStateEvents(F.RoomTombstone,"");return!(u&&n.has(l.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return R(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield Np(5,()=>n.setAccountDataRaw(e,t));var i=n.store.getAccountData(e);if(i&&Hs(i.event.content,t))return{};var a=Promise.withResolvers();function s(u){u.getType()===e&&a.resolve()}o(s,"accountDataListener"),n.addListener(ve.AccountData,s);try{var l=yield Np(5,()=>n.setAccountDataRaw(e,t));return yield a.promise,l}finally{n.removeListener(ve.AccountData,s)}})()}setAccountDataRaw(e,t){var n=se("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(G.Put,n,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return R(function*(){if(t.isInitialSyncComplete()){var n=t.store.getAccountData(e);return n?n.getContent():null}var i=se("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(G.Get,i)}catch(s){var a;if(((a=s.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw s}})()}deleteAccountData(e){var t=this;return R(function*(){var n=t.canSupport.get(Pt.AccountDataDeletion);if(n===Ot.Unsupported){yield t.setAccountData(e,{});return}var i=se("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=n===Ot.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(G.Delete,i,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(F.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(n=>{t.ignored_users[n]={}}),this.setAccountData(F.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return R(function*(){var i,a,s=t.length>1&&t[1]!==void 0?t[1]:{},l=n.getRoom(e),u=l==null?void 0:l.getMember(n.getSafeUserId()),d=u==null?void 0:u.membership,c=d==ke.Invite&&(i=u==null||(a=u.events.member)===null||a===void 0?void 0:a.getSender())!==null&&i!==void 0?i:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(d,", inviter=").concat(c,", opts=").concat(JSON.stringify(s))),d==ke.Join)return l;var h=Promise.resolve();if(s.inviteSignUrl){var v=new URL(s.inviteSignUrl);v.searchParams.set("mxid",n.credentials.userId),h=n.http.requestOtherUrl(G.Post,v)}var g={};s.viaServers&&(g.server_name=s.viaServers,g.via=s.viaServers);var p={},m=yield h;m&&(p.third_party_signed=m);var w=se("/join/$roomid",{$roomid:e}),y=yield n.http.authedRequest(G.Post,w,g,p),S=y.room_id;s.acceptSharedHistory&&c&&n.cryptoBackend&&(yield n.cryptoBackend.maybeAcceptKeyBundle(S,c));var T=n.getRoom(S);if(T!=null&&T.hasMembershipState(n.credentials.userId,ke.Join))return T;var C=new mn(n,n.clientOpts,n.buildSyncApiOptions());return C.createRoom(S)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=this.getRoom(e);if(n!=null&&n.hasMembershipState(this.credentials.userId,ke.Knock))return Promise.resolve({room_id:n.roomId});var i=se("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};t.viaServers&&(a.server_name=t.viaServers,a.via=t.viaServers);var s={};return t.reason&&(s.reason=t.reason),this.http.authedRequest(G.Post,i,a,s)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,we.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![we.QUEUED,we.NOT_SENT,we.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===we.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===we.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,we.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,F.RoomName,{name:t})}setRoomTopic(e,t,n){var i=oI(t,n);return this.sendStateEvent(e,F.RoomTopic,i)}getRoomTags(e){var t=se("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(G.Get,t)}setRoomTag(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=se("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(G.Put,i,void 0,n)}deleteRoomTag(e,t){var n=se("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(G.Delete,n)}setRoomAccountData(e,t,n){var i=se("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(G.Put,i,void 0,n)}setPowerLevel(e,t,n){var i=this;return R(function*(){var a,s;if(i.clientRunning&&i.isInitialSyncComplete()){var l;s=(l=i.getRoom(e))===null||l===void 0||(l=l.currentState)===null||l===void 0||(l=l.getStateEvents(F.RoomPowerLevels,""))===null||l===void 0?void 0:l.getContent()}if(!s)try{s=yield i.getStateEvent(e,F.RoomPowerLevels,"")}catch(c){if(c instanceof ft&&c.errcode==="M_NOT_FOUND")s={};else throw c}s=uu(s),(a=s)!==null&&a!==void 0&&a.users||(s.users={});var u=Array.isArray(t)?t:[t];for(var d of u)n==null?delete s.users[d]:s.users[d]=n;return i.sendStateEvent(e,F.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var n=this;return R(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return R(function*(){return n.sendStateEvent(e,uy.name,t,n.getUserId())})()}sendEvent(e,t,n,i,a){var s,l,u,d;return!(t!=null&&t.startsWith(an))&&t!==null?(d=i,u=n,l=t,s=null):(d=a,u=i,l=n,s=t),this.addThreadRelationIfNeeded(u,s,e),this.sendCompleteEvent(e,s,{type:l,content:u},d)}addThreadRelationIfNeeded(e,t,n){var i;if(t&&!((i=e["m.relates_to"])!==null&&i!==void 0&&i.rel_type)){var a,s,l=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=Tt(Tt({},e["m.relates_to"]),{},{rel_type:qe.name,event_id:t,is_falling_back:!l});var u=(s=this.getRoom(n))===null||s===void 0?void 0:s.getThread(t);if(u&&!l){var d,c;e["m.relates_to"]["m.in_reply_to"]={event_id:(d=(c=u.lastReply(h=>h.isRelation(qe.name)&&!h.status))===null||c===void 0?void 0:c.getId())!==null&&d!==void 0?d:t}}}}sendCompleteEvent(e,t,n,i,a){var s,l;typeof i=="string"?l=i:(s=i,l=a),l||(l=this.makeTxnId());var u=new Ht(Object.assign(n,{event_id:"~"+e+":"+l,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),d=this.getRoom(e),c=t?d==null?void 0:d.getThread(t):void 0;c&&u.setThread(c),s||(this.reEmitter.reEmit(u,[We.Replaced,We.VisibilityChange]),d==null||d.reEmitter.reEmit(u,[We.BeforeRedaction]));var h=u.getAssociatedId();if(h!=null&&h.startsWith("~")){var v=d==null?void 0:d.getPendingEvents().find(p=>p.getId()===h);v==null||v.once(We.LocalEventIdReplaced,()=>{u.updateAssociatedId(v.getId())})}var g=u.getType();return this.logger.debug("sendEvent of type ".concat(g," in ").concat(e," with txnId ").concat(l).concat(s?" (delayed event)":"")),u.setTxnId(l),u.setStatus(we.SENDING),s?this.encryptAndSendEvent(d,u,s):(d==null||d.addPendingEvent(u,l),u.status===we.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(d,u))}encryptAndSendEvent(e,t,n){var i=this;return R(function*(){if(n)return i.sendEventHttpRequest(t,n);try{var a;i.eventsBeingEncrypted.add(t.getId());try{yield i.encryptEventIfNeeded(t,e??void 0)}finally{a=!i.eventsBeingEncrypted.delete(t.getId())}if(a)return{};t.status===we.ENCRYPTING&&i.updatePendingEventStatus(e,t,we.SENDING);var s=null;return i.scheduler&&(s=i.scheduler.queueEvent(t),s&&i.scheduler.getQueueForEvent(t).length>1&&i.updatePendingEventStatus(e,t,we.QUEUED)),s||(s=i.sendEventHttpRequest(t),e&&(s=s.then(l=>(e.updatePendingEvent(t,we.SENT,l.event_id),l)))),yield s}catch(l){i.logger.error("Error sending event",l);try{t.error=l,i.updatePendingEventStatus(e,t,we.NOT_SENT)}catch(u){i.logger.error("Exception in error handler!",u)}throw l instanceof ft&&(l.event=t),l}})()}encryptEventIfNeeded(e,t){var n=this;return R(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&!(!n.cryptoBackend&&n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,we.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return R(function*(){var i;return e.isEncrypted()||e.getType()===F.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(i=n.cryptoBackend)===null||i===void 0?void 0:i.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var n;return t===F.Reaction?t:(n=this.getRoom(e))!==null&&n!==void 0&&n.hasEncryptionStateEvent()?F.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e,t){var n=e.getTxnId();n||(n=this.makeTxnId(),e.setTxnId(n));var i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:n},a;if(e.isState()){var s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),a=se(s,i)}else if(e.isRedaction()&&e.event.redacts){var l="/rooms/$roomId/redact/$redactsEventId/$txnId";a=se(l,Tt({$redactsEventId:e.event.redacts},i))}else a=se("/rooms/$roomId/send/$eventType/$txnId",i);var u=e.getWireContent();return t?this.http.authedRequest(G.Put,a,E0(t),u):this.http.authedRequest(G.Put,a,void 0,u).then(d=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(d.event_id)),d))}redactEvent(e,t,n,i,a){var s,l,u;(s=n)!==null&&s!==void 0&&s.startsWith(an)||(a=i,i=n,n=t,t=null);var d=(l=a)===null||l===void 0?void 0:l.reason,c={reason:d};if(((u=a)===null||u===void 0?void 0:u.with_rel_types)!==void 0){if(this.canSupport.get(Pt.RelationBasedRedactions)===Ot.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(n," txnId: ").concat(i," threadId ").concat(t));var h=this.canSupport.get(Pt.RelationBasedRedactions)===Ot.Stable?np.stable:np.unstable;c[h]=a.with_rel_types}return this.sendCompleteEvent(e,t,{type:F.RoomRedaction,content:c,redacts:n},i)}sendMessage(e,t,n,i){typeof t!="string"&&t!==null&&(i=n,n=t,t=null);var a=F.RoomMessage,s=n;return this.sendEvent(e,t,a,s,i)}sendTextMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=rI(n);return this.sendMessage(e,t,s,i)}sendNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=nI(n);return this.sendMessage(e,t,s,i)}sendEmoteMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=iI(n);return this.sendMessage(e,t,s,i)}sendImageMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(s=i||"Image",i=n,n=t,t=null);var l={msgtype:Rn.Image,url:n,info:i,body:s};return this.sendMessage(e,t,l)}sendStickerMessage(e,t,n,i){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(s=i||"Sticker",i=n,n=t,t=null);var l={url:n,info:i,body:s};return this.sendEvent(e,t,F.Sticker,l)}sendHtmlMessage(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=ZR(n,i);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=eI(n,i);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,n,i){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(an))&&t!==null&&(i=n,n=t,t=null);var s=tI(n,i);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,n,i,a,s){var l=this;return R(function*(){if(!(yield l.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","sendDelayedEvent");return l.addThreadRelationIfNeeded(a,n,e),l.sendCompleteEvent(e,n,{type:i,content:a},t,s)})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:"",u=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield s.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","sendDelayedStateEvent");var d={$roomId:e,$eventType:n,$stateKey:l},c=se("/rooms/$roomId/state/$eventType",d);return l!==void 0&&(c=se(c+"/$stateKey",d)),s.http.authedRequest(G.Put,c,E0(t),i,u)})()}_unstable_getDelayedEvents(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","getDelayedEvents");var n=e?{from:e}:void 0;return yield t.http.authedRequest(G.Get,"/delayed_events",n,void 0,{prefix:"".concat(It.Unstable,"/").concat(vn)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","updateDelayedEvent");var s=se("/delayed_events/$delayId",{$delayId:e}),l={action:t};return yield i.http.authedRequest(G.Post,s,void 0,l,Tt(Tt({},a),{},{prefix:"".concat(It.Unstable,"/").concat(vn)}))})()}sendReceipt(e,t,n){var i=arguments,a=this;return R(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:!1;if(a.isGuest())return Promise.resolve({});var l=se("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),u=!s&&a.supportsThreads(),d=u?Tt(Tt({},n),{},{thread_id:ro(e)}):n,c=a.http.authedRequest(G.Post,l,void 0,d||{}),h=a.getRoom(e.getRoomId());return h&&a.credentials.userId&&h.addLocalEchoReceipt(a.credentials.userId,e,t,s),c})()}sendReadReceipt(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:er.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var s=e.getId(),l=n.getRoom(e.getRoomId());if(l!=null&&l.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));return n.sendReceipt(e,i,{},a)}})()}setRoomReadMarkers(e,t,n,i){var a=this;return R(function*(){var s=a.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var l;if(n){if(l=n.getId(),s!=null&&s.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,n,er.Read)}var u;if(i){if(u=i.getId(),s!=null&&s.hasPendingEvent(u))throw new Error("Cannot set read receipt to a pending event (".concat(u,")"));s==null||s.addLocalEchoReceipt(a.credentials.userId,i,er.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,l,u)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var n=new URL(e);n.hash="",e=n.toString();var i=t+"_"+e;if(i in this.urlPreviewCache)return this.urlPreviewCache[i];var a=this.http.authedRequest(G.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:ds.V3,priority:"low"});return this.urlPreviewCache[i]=a,a}sendTyping(e,t,n){if(this.isGuest())return Promise.resolve({});var i=se("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=n||2e4),this.http.authedRequest(G.Put,i,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=this.getRoom(e);if(!i)return[];var a=this.findPredecessorRooms(i,t,n),s=this.findSuccessorRooms(i,t,n);return[...a,i,...s]}findPredecessorRooms(e,t,n){for(var i,a=[],s=new Set([e.roomId]),l=(i=e.findPredecessor(n))===null||i===void 0?void 0:i.roomId;l!==null;){var u;if(l){if(s.has(l))break;s.add(l)}var d=this.getRoom(l);if(d===null)break;if(t){var c=d.currentState.getStateEvents(F.RoomTombstone,"");if(!c||c.getContent().replacement_room!==e.roomId)break}a.splice(0,0,d),e=d,l=(u=e.findPredecessor(n))===null||u===void 0?void 0:u.roomId}return a}findSuccessorRooms(e,t,n){for(var i=[],a=e.currentState.getStateEvents(F.RoomTombstone,"");a;){var s=this.getRoom(a.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var l,u=(l=s.findPredecessor(n))===null||l===void 0?void 0:l.roomId;if(!u||u!==e.roomId)break}i.push(s);var d=new Set(i.map(c=>c.roomId));if(d.size<i.length)return i.slice(0,i.length-1);e=s,a=e.currentState.getStateEvents(F.RoomTombstone,"")}return i}invite(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:{};if(typeof a!="object"&&(a={reason:a}),a.shareEncryptedHistory){var s;yield(s=i.cryptoBackend)===null||s===void 0?void 0:s.shareRoomHistoryWithUser(e,t)}return yield i.membershipChange(e,t,ke.Invite,a.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var i=this;return R(function*(){var a,s=se("/rooms/$roomId/invite",{$roomId:e}),l=i.getIdentityServerUrl(!0);if(!l)return Promise.reject(new ft({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var u={id_server:l,medium:t,address:n};if((a=i.identityServer)!==null&&a!==void 0&&a.getAccessToken){var d=yield i.identityServer.getAccessToken();d&&(u.id_access_token=d)}return i.http.authedRequest(G.Post,s,void 0,u)})()}leave(e){return this.membershipChange(e,void 0,ke.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,n=this.getRoomUpgradeHistory(e),i=n;if(!t){i=[];for(var a of n)if(i.push(a),a.roomId===e)break}var s={},l=[],u=o(c=>this.leave(c).then(()=>{delete s[c]}).catch(h=>{s[c]=h}),"doLeave");for(var d of i)l.push(u(d.roomId));return Promise.all(l).then(()=>s)}ban(e,t,n){return this.membershipChange(e,t,ke.Ban,n)}forget(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!0,a=se("/rooms/$room_id/forget",{$room_id:e}),s=yield n.http.authedRequest(G.Post,a);return i&&(n.store.removeRoom(e),n.emit(ve.DeleteRoom,e)),s})()}unban(e,t){var n=se("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(G.Post,n,void 0,i)}kick(e,t,n){var i=se("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:n};return this.http.authedRequest(G.Post,i,void 0,a)}membershipChange(e,t,n,i){var a=se("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest(G.Post,a,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:n,rule:i}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(n,i)}return e.getPushDetails()}setProfileInfo(e,t){var n=se("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(G.Put,n,void 0,t)}setDisplayName(e){var t=this;return R(function*(){var n=yield t.setProfileInfo("displayname",{displayname:e}),i=t.getUser(t.getUserId());return i&&(i.displayName=e,i.emit(Er.DisplayName,i.events.presence,i)),n})()}setAvatarUrl(e){var t=this;return R(function*(){var n=yield t.setProfileInfo("avatar_url",{avatar_url:e}),i=t.getUser(t.getUserId());return i&&(i.avatarUrl=e,i.emit(Er.AvatarUrl,i.events.presence,i)),n})()}mxcUrlToHttp(e,t,n,i,a,s,l){return Th(this.baseUrl,e,t,n,i,a,s,l)}setSyncPresence(e){var t=this;return R(function*(){var n;(n=t.syncApi)===null||n===void 0||n.setPresence(e)})()}setPresence(e){var t=this;return R(function*(){var n=se("/presence/$userId/status",{$userId:t.credentials.userId}),i=["offline","online","unavailable"];if(i.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(G.Put,n,void 0,e)})()}getPresence(e){var t=se("/presence/$userId/status",{$userId:e});return this.http.authedRequest(G.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var a=Date.now()-i.errorTs;n=Math.max(eL-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;var l=new Promise((u,d)=>{du(n).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,Me.Backward)).then(c=>{var h,v,g=c.chunk.map(this.getEventMapper());if(c.state){var p=c.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(p)}var[m,w,y]=e.partitionThreadedEvents(g);this.processAggregatedTimelineEvents(e,m),e.addEventsToTimeline(m,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,w,!0),y.forEach(S=>e.relations.aggregateChildEvent(S)),e.oldState.paginationToken=(h=c.end)!==null&&h!==void 0?h:null,c.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,g,(v=c.end)!==null&&v!==void 0?v:null,!0),delete this.ongoingScrollbacks[e.roomId],u(e)}).catch(c=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},d(c)})});return i={promise:l},this.ongoingScrollbacks[e.roomId]=i,l}getEventMapper(e){return lN(this,e||{})}getEventTimeline(e,t){var n=this;return R(function*(){var i,a,s,l;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads())return n.getThreadTimeline(e,t);var u=se("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),d=void 0;(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(d={filter:JSON.stringify(lr.LAZY_LOADING_MESSAGES_FILTER)});var c=yield n.http.authedRequest(G.Get,u,d);if(!c.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var h=n.getEventMapper(),v=h(c.event);if(v.isRelation(qe.name)){n.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var g=[...c.events_after.reverse().map(h),v,...c.events_before.map(h)],p=e.getTimelineForEvent(g[0].getId());p?p.getState(me.BACKWARDS).setUnknownStateEvents(c.state.map(h)):(p=e.addTimeline(),p.initialiseState(c.state.map(h)),p.getState(me.FORWARDS).paginationToken=c.end);var[m,w,y]=e.room.partitionThreadedEvents(g);return e.addEventsToTimeline(m,!0,!1,p,c.start),n.processThreadEvents(e.room,w,!0),n.processAggregatedTimelineEvents(e.room,m),y.forEach(S=>e.relations.aggregateChildEvent(S)),(a=(s=e.getTimelineForEvent(t))!==null&&s!==void 0?s:(l=e.room.findThreadForEvent(v))===null||l===void 0?void 0:l.liveTimeline)!==null&&a!==void 0?a:p})()}getThreadTimeline(e,t){var n=this;return R(function*(){var i;if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var a=se("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),s={limit:"0"};(i=n.clientOpts)!==null&&i!==void 0&&i.lazyLoadMembers&&(s.filter=JSON.stringify(lr.LAZY_LOADING_MESSAGES_FILTER));var l=yield n.http.authedRequest(G.Get,a,s),u=n.getEventMapper(),d=u(l.event);if(e.canContain(d)){var c=n.canSupport.get(Pt.RelationsRecursion)!==Ot.Unsupported;if(_t.hasServerSideSupport)if(_t.hasServerSideFwdPaginationSupport){var h,v,g;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var p=e.thread,m=yield n.fetchRelations(e.room.roomId,p.id,null,null,{dir:Me.Backward,from:l.start,recurse:c||void 0}),w=yield n.fetchRelations(e.room.roomId,p.id,null,null,{dir:Me.Forward,from:l.end,recurse:c||void 0}),y=[...w.chunk.reverse().filter(Bf(p.id)).map(u),d,...m.chunk.filter(Bf(p.id)).map(u)];for(var S of y){var T;yield(T=e.thread)===null||T===void 0?void 0:T.processEvent(S)}var C=e.getTimelineForEvent(d.getId());if(C?C.getState(me.BACKWARDS).setUnknownStateEvents(l.state.map(u)):(C=e.addTimeline(),C.initialiseState(l.state.map(u))),e.addEventsToTimeline(y,!0,!1,C,w.next_batch),!m.next_batch){var M=yield n.fetchRoomEvent(e.room.roomId,p.id);e.addEventsToTimeline([u(M)],!0,!1,C,null)}return C.setPaginationToken((h=m.next_batch)!==null&&h!==void 0?h:null,Me.Backward),C.setPaginationToken((v=w.next_batch)!==null&&v!==void 0?v:null,Me.Forward),n.processAggregatedTimelineEvents(e.room,y),(g=e.getTimelineForEvent(t))!==null&&g!==void 0?g:C}else{for(var _,O=e.thread,b=yield n.fetchRelations(e.room.roomId,O.id,qe.name,null,{dir:Me.Backward,from:l.start,recurse:c||void 0}),j=[],B=l.end;B;){var q,oe=yield n.fetchRelations(e.room.roomId,O.id,qe.name,null,{dir:Me.Forward,from:B,recurse:c||void 0});B=(q=oe.next_batch)!==null&&q!==void 0?q:null,j.push(...oe.chunk)}var de=[...j.reverse().map(u),d,...b.chunk.map(u)];for(var Ne of de){var Oe;yield(Oe=e.thread)===null||Oe===void 0?void 0:Oe.processEvent(Ne)}var Ae=e.getLiveTimeline();if(Ae.getState(me.BACKWARDS).setUnknownStateEvents(l.state.map(u)),e.addEventsToTimeline(de,!0,!1,Ae,null),!b.next_batch){var ae=yield n.fetchRoomEvent(e.room.roomId,O.id);e.addEventsToTimeline([u(ae)],!0,!1,Ae,null)}return Ae.setPaginationToken((_=b.next_batch)!==null&&_!==void 0?_:null,Me.Backward),Ae.setPaginationToken(null,Me.Forward),n.processAggregatedTimelineEvents(e.room,de),Ae}}})()}getLatestTimeline(e){var t=this;return R(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var n;if(e.threadListType!==null){var i,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,Me.Backward,e.threadListType,e.getFilter());n=(i=a.chunk)===null||i===void 0?void 0:i[0]}else if(e.thread&&_t.hasServerSideSupport){var s,l=t.canSupport.get(Pt.RelationsRecursion)!==Ot.Unsupported,u=yield t.fetchRelations(e.room.roomId,e.thread.id,qe.name,null,{dir:Me.Backward,limit:1,recurse:l||void 0});n=(s=u.chunk)===null||s===void 0?void 0:s[0]}else{var d,c,h=se("/rooms/$roomId/messages",{$roomId:e.room.roomId}),v={dir:"b"};(d=t.clientOpts)!==null&&d!==void 0&&d.lazyLoadMembers&&(v.filter=JSON.stringify(lr.LAZY_LOADING_MESSAGES_FILTER));var g=yield t.http.authedRequest(G.Get,h,v);n=(c=g.chunk)===null||c===void 0?void 0:c[0]}if(!n)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,n.event_id)})()}createMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,l=se("/rooms/$roomId/messages",{$roomId:e}),u={limit:i.toString(),dir:a};t&&(u.from=t);var d=null;if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(d=Object.assign({},lr.LAZY_LOADING_MESSAGES_FILTER)),s){var c;d=d||{},Object.assign(d,(c=s.getRoomTimelineFilterComponent())===null||c===void 0?void 0:c.toJSON())}return d&&(u.filter=JSON.stringify(d)),this.http.authedRequest(G.Get,l,u)}createThreadListMessagesRequest(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Me.Backward,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Vr.All,l=arguments.length>5?arguments[5]:void 0,u=se("/rooms/$roomId/threads",{$roomId:e}),d={limit:i.toString(),dir:a,include:QI(s)};t&&(d.from=t);var c={};if((n=this.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(c=Tt({},lr.LAZY_LOADING_MESSAGES_FILTER)),l){var h;c=Tt(Tt({},c),(h=l.getRoomTimelineFilterComponent())===null||h===void 0?void 0:h.toJSON())}Object.keys(c).length&&(d.filter=JSON.stringify(c));var v={prefix:_t.hasServerSideListSupport===Vt.Stable?It.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(G.Get,u,d,void 0,v).then(g=>{var p;return Tt(Tt({},g),{},{chunk:(p=g.chunk)===null||p===void 0?void 0:p.reverse(),start:g.prev_batch,end:g.next_batch})})}paginateEventTimeline(e,t){var n=this,i=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,l=e.getTimelineSet().thread;t=t||{};var u=t.backwards||!1;if(i&&!u)throw new Error("paginateNotifTimeline can only paginate backwards");var d=u?me.BACKWARDS:me.FORWARDS,c=e.getPaginationToken(d),h=e.paginationRequests[d];if(h)return h;var v,g,p;if(i){var m;v="/notifications",g={limit:((m=t.limit)!==null&&m!==void 0?m:30).toString(),only:"highlight"},c&&c!=="end"&&(g.from=c),p=this.http.authedRequest(G.Get,v,g).then(function(){var C=R(function*(M){var _=M.next_token,O=[];M.notifications=M.notifications.filter(zr);for(var b=0;b<M.notifications.length;b++){var j=M.notifications[b],B=n.getEventMapper()(j.event);n.getPushDetailsForEvent(B,!0),B.event.room_id=j.room_id,O[b]=B}var q=e.getTimelineSet();return q.addEventsToTimeline(O,u,!1,e,_),n.processAggregatedTimelineEvents(q.room,O),u&&!M.next_token&&e.setPaginationToken(null,d),!!M.next_token});return function(M){return C.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else if(s!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!_t.hasServerSideFwdPaginationSupport&&d===Me.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");p=this.createThreadListMessagesRequest(e.getRoomId(),c,t.limit,d,s,e.getFilter()).then(C=>{if(C.state){var M=e.getState(d),_=C.state.filter(zr).map(this.getEventMapper());M.setUnknownStateEvents(_)}var O=C.end,b=C.chunk.filter(zr).map(this.getEventMapper()),j=e.getTimelineSet();return j.addEventsToTimeline(b,u,!1,e,O),this.processAggregatedTimelineEvents(a,b),this.processThreadRoots(a,b,u),u&&C.end==C.start&&e.setPaginationToken(null,d),C.end!==C.start}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else if(l){var w,y,S=this.getRoom((w=e.getRoomId())!==null&&w!==void 0?w:void 0);if(!S)throw new Error("Unknown room "+e.getRoomId());var T=this.canSupport.get(Pt.RelationsRecursion)!==Ot.Unsupported;p=this.fetchRelations((y=e.getRoomId())!==null&&y!==void 0?y:"",l.id,null,null,{dir:d,limit:t.limit,from:c??void 0,recurse:T||void 0}).then(function(){var C=R(function*(M){var _=n.getEventMapper(),O=M.chunk.filter(zr).filter(Bf(l.id)).map(_);for(var b of O.slice().reverse()){yield l==null?void 0:l.processEvent(b);var j=b.getSender();(!u||(l==null?void 0:l.getEventReadUpTo(j))===null)&&S.addLocalEchoReceipt(j,b,er.Read)}var B=M.next_batch,q=e.getTimelineSet();if(q.addEventsToTimeline(O,u,!1,e,B??null),!B&&u){var oe,de,Ne=(oe=l.rootEvent)!==null&&oe!==void 0?oe:_(yield n.fetchRoomEvent((de=e.getRoomId())!==null&&de!==void 0?de:"",l.id));q.addEventsToTimeline([Ne],!0,!1,e,null)}return n.processAggregatedTimelineEvents(q.room,O),u&&!B&&e.setPaginationToken(null,d),!!B});return function(M){return C.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}else{if(!a)throw new Error("Unknown room "+e.getRoomId());p=this.createMessagesRequest(e.getRoomId(),c,t.limit,d,e.getFilter()).then(C=>{if(C.state){var M=e.getState(d),_=C.state.filter(zr).map(this.getEventMapper());M.setUnknownStateEvents(_)}var O=C.end,b=C.chunk.filter(zr).map(this.getEventMapper()),j=e.getTimelineSet(),[B,,q]=a.partitionThreadedEvents(b);j.addEventsToTimeline(B,u,!1,e,O),this.processAggregatedTimelineEvents(a,B),this.processThreadRoots(a,B.filter(de=>de.getServerAggregatedRelation(qe.name)),!1),q.forEach(de=>a.relations.aggregateChildEvent(de));var oe=C.end===void 0||C.end===C.start;return u&&oe&&e.setPaginationToken(null,d),!oe}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=p}return p}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new mn(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,n)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var n=this.sendStateEvent(e,F.RoomGuestAccess,{guest_access:t.allowJoin?Cc.CanJoin:Cc.Forbidden},""),i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,F.RoomHistoryVisibility,{history_visibility:ly.WorldReadable},"")),Promise.all([i,n]).then()}requestRegisterEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestRegisterMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestAdd3pidEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestAdd3pidMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestPasswordEmailToken(e,t,n,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:i})}requestPasswordMsisdnToken(e,t,n,i,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:i,next_link:a})}requestTokenFromEndpoint(e,t){var n=this;return R(function*(){var i=Object.assign({},t);return n.http.request(G.Post,e,void 0,i)})()}getRoomPushRule(e,t){if(this.pushRules){var n;return(n=this.pushRules[e])===null||n===void 0||(n=n.room)===null||n===void 0?void 0:n.find(i=>i.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,n){var i,a=!1,s=this.getRoomPushRule(e,t);if(s!=null&&s.actions.includes(Pi.DontNotify)&&(a=!0),!n)a&&(i=this.deletePushRule(e,Dt.RoomSpecific,s.rule_id));else if(!s)i=this.addPushRule(e,Dt.RoomSpecific,t,{actions:[Pi.DontNotify]});else if(!a){var l=Promise.withResolvers();this.deletePushRule(e,Dt.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,Dt.RoomSpecific,t,{actions:[Pi.DontNotify]}).then(()=>{l.resolve()}).catch(u=>{l.reject(u)})}).catch(u=>{l.reject(u)}),i=l.promise}if(i)return new Promise((u,d)=>{i.then(()=>{this.getPushRules().then(c=>{this.pushRules=c,u()}).catch(c=>{d(c)})}).catch(c=>{this.getPushRules().then(h=>{this.pushRules=h,d(c)}).catch(h=>{d(c)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:OI.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(i=>this.processRoomEventsSearch(n,i))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t,e.abortSignal).then(i=>this.processRoomEventsSearch(e,i)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=n,n}processRoomEventsSearch(e,t){var n,i,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var s=new Set(a.highlights);e.highlights.forEach(g=>{s.add(g)}),e.highlights=Array.from(s);for(var l=this.getEventMapper(),u=(n=(i=a.results)===null||i===void 0?void 0:i.length)!==null&&n!==void 0?n:0,d=0;d<u;d++){var c=Ic.fromJson(a.results[d],l),h=this.getRoom(c.context.getEvent().getRoomId());if(h)for(var v of c.context.getTimeline())v.setMetadata(h.currentState,!1);e.results.push(c)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new mn(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=se("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(G.Post,t,void 0,e).then(n=>{var i=lr.fromJson(this.credentials.userId,n.filter_id,e);return this.store.storeFilter(i),i})}getFilter(e,t,n){if(n){var i=this.store.getFilter(e,t);if(i)return Promise.resolve(i)}var a=se("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(G.Get,a).then(s=>{var l=lr.fromJson(e,t,s);return this.store.storeFilter(l),l})}getOrCreateFilter(e,t){var n=this;return R(function*(){var i=n.store.getFilterIdByName(e),a;if(i){try{var s=yield n.getFilter(n.credentials.userId,i,!0);if(s){var l=s.getDefinition(),u=t.getDefinition();Hs(l,u)&&(a=i)}}catch(c){if(c.errcode!=="M_UNKNOWN"&&c.errcode!=="M_NOT_FOUND")throw c}a||n.store.setFilterIdByName(e,void 0)}if(a)return a;var d=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,d.filterId),d.filterId})()}getOpenIdToken(){var e=se("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(G.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(G.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return R(function*(){if(e.canSupportVoip){var t=!1,n=e.turnServersExpiry-Date.now();if(n>S0)e.logger.debug("TURN creds are valid for another "+n+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var i=yield e.turnServer();if(i.uris){e.logger.debug("Got TURN URIs: "+i.uris+" refresh in "+i.ttl+" secs");var a={urls:i.uris,username:i.username,credential:i.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+i.ttl*1e3,t=!0,e.emit(ve.TurnServers,e.turnServers)}}catch(s){e.logger.error("Failed to get TURN URIs",s),s.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ve.TurnServersError,s,!0)):e.emit(ve.TurnServersError,s,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=se("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(G.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=se("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=se("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(G.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return R(function*(){var t;e.clientWellKnownPromise=wt.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ve.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(n=>{var[i,a]=n;return e.includes(typeof a)}).reduce((n,i)=>{var[a,s]=i;return n[a]=s,n},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return R(function*(){var n=yield t.doesServerSupportUnstableFeature(GI),i=yield t.doesServerSupportUnstableFeature(qI),a=yield t.doesServerSupportUnstableFeature(HI);if(!n&&!i&&!a)throw Error("Server does not support the Mutual Rooms API");var s,l;a?(s="/uk.half-shot.msc2666/user/mutual_rooms",l={user_id:e}):(s=se("/uk.half-shot.msc2666/user/".concat(i?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),l={});var u=[],d=null;do{var c={};d!=null&&a&&(c.batch_token=d);var h=yield t.http.authedRequest(G.Get,s,Tt(Tt({},l),c),void 0,{prefix:It.Unstable});u.push(...h.joined),h.next_batch_token!==void 0?d=h.next_batch_token:d=null}while(d!=null);return u})()}getVersions(){var e=this;return R(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(G.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(n=>{throw e.serverVersionsPromise=void 0,n});var t=yield e.serverVersionsPromise;return e.canSupport=yield S1(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return R(function*(){var{versions:n}=yield t.getVersions();return n&&n.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return R(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features;return i&&!!i[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return R(function*(){var n=yield t.getVersions();if(!n)return!1;var i=n.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return R(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Vt.Stable,list:Vt.Stable,fwdPagination:Vt.Stable};try{var[t,n,i,a,s,l]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:_d(n,t),list:_d(a,i),fwdPagination:_d(l,s)}}catch{return{threads:Vt.None,list:Vt.None,fwdPagination:Vt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,i){var a=arguments,s=this;return R(function*(){var l,u,d=a.length>4&&a[4]!==void 0?a[4]:{dir:Me.Backward},c=i?s.getEncryptedIfNeededEventType(e,i):null,[h,v]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,n,c,d)]),g=s.getEventMapper(),p=h?g(h):void 0,m=v.chunk.map(g);if(c===F.RoomMessageEncrypted){var w=p?m.concat(p):m;yield Promise.all(w.map(y=>s.decryptEventIfNeeded(y))),i!==null&&(m=m.filter(y=>y.getType()===i))}return p&&n===tt.Replace&&(m=m.filter(y=>y.getSender()===p.getSender())),{originalEvent:p??null,events:m,nextBatch:(l=v.next_batch)!==null&&l!==void 0?l:null,prevBatch:(u=v.prev_batch)!==null&&u!==void 0?u:null}})()}generateClientSecret(){return ki(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case sm.IS:return this.http.getUrl("/terms",void 0,On.V2,t);case sm.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return n&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=_f(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(G.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,n,i,a,s,l){n&&(i.session=n);var u={auth:i,refresh_token:!0};return e!=null&&(u.username=e),t!=null&&(u.password=t),s!=null&&(u.guest_access_token=s),l!=null&&(u.inhibit_login=l),this.registerRequest(u)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var n={};return t&&(n.kind=t),this.http.request(G.Post,"/register",n,e)}refreshToken(e){var t=o(n=>this.http.authedRequest(G.Post,"/refresh",void 0,{refresh_token:e},{prefix:n,inhibitLogoutEmit:!0}),"performRefreshRequestWithPrefix");return t(It.V3).catch(n=>{if(n.errcode==="M_UNRECOGNIZED")return t(It.V1);throw n})}loginFlows(){return this.http.request(G.Get,"/login")}login(e,t){return this.loginRequest(Tt(Tt({},t),{},{type:e})).then(n=>(n.access_token&&n.user_id&&(this.http.opts.accessToken=n.access_token,this.credentials={userId:n.user_id}),n))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";n&&(a+="/"+n);var s={redirectUrl:e,[nL.unstable]:i};return this.http.getUrl(a,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return R(function*(){return yield t.http.authedRequest(G.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:!1;return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(G.Post,"/logout")})()}deactivateAccount(e,t){var n={};return e&&(n.auth=e),t!==void 0&&(n.erase=t),this.http.authedRequest(G.Post,"/account/deactivate",void 0,n)}requestLoginToken(e){var t=this;return R(function*(){var n={auth:e};return t.http.authedRequest(G.Post,"/login/get_token",void 0,n,{prefix:It.V1})})()}getFallbackAuthUrl(e,t){var n=se("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(n,{session:t}).href}createRoom(e){var t=this;return R(function*(){var n,i=(e.invite_3pid||[]).filter(l=>!l.id_access_token);if(i.length>0&&(n=t.identityServer)!==null&&n!==void 0&&n.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var s of i)s.id_access_token=a}return t.http.authedRequest(G.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,n,i){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:Me.Backward},s=a;_t.hasServerSideFwdPaginationSupport===Vt.Experimental&&(s=H_("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(Pt.RelationsRecursion)===Ot.Unstable&&(s=H_("recurse","org.matrix.msc3981.recurse",s));var l=qv(s),u="/rooms/$roomId/relations/$eventId";n!==null?(u+="/$relationType",i!==null&&(u+="/$eventType")):i!==null&&(this.logger.warn("eventType: ".concat(i,` ignored when fetching
            relations as relationType is null`)),i=null);var d=se(u+"?"+l,{$roomId:e,$eventId:t,$relationType:n,$eventType:i});return this.http.authedRequest(G.Get,d,void 0,void 0,{prefix:It.V1})}roomState(e){var t=se("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(G.Get,t)}fetchRoomEvent(e,t){var n=se("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(G.Get,n)}members(e,t,n,i){var a={};t&&(a.membership=t),n&&(a.not_membership=n),i&&(a.at=i);var s=qv(a),l=se("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(G.Get,l)}upgradeRoom(e,t){var n=se("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(G.Post,n,void 0,{new_version:t})}getStateEvent(e,t,n){var i={$roomId:e,$eventType:t,$stateKey:n},a=se("/rooms/$roomId/state/$eventType",i);return n!==void 0&&(a=se(a+"/$stateKey",i)),this.http.authedRequest(G.Get,a)}sendStateEvent(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},s={$roomId:e,$eventType:t,$stateKey:i},l=se("/rooms/$roomId/state/$eventType",s);return i!==void 0&&(l=se(l+"/$stateKey",s)),this.http.authedRequest(G.Put,l,void 0,n,a)}roomInitialSync(e,t){var n,i=se("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(G.Get,i,{limit:(n=t==null?void 0:t.toString())!==null&&n!==void 0?n:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){var a=this;return R(function*(){var s=se("/rooms/$roomId/read_markers",{$roomId:e}),l={[er.FullyRead]:t,[er.Read]:n};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(l[er.ReadPrivate]=i),a.http.authedRequest(G.Post,s,void 0,l)})()}getJoinedRooms(){var e=se("/joined_rooms",{});return this.http.authedRequest(G.Get,e)}getJoinedRoomMembers(e){var t=se("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(G.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:n,since:i}=e,a=AD(e,ZN);if(Object.keys(a).length===0){var s={server:t,limit:n,since:i};return this.http.authedRequest(G.Get,"/publicRooms",s)}else{var l={server:t},u=Tt({limit:n,since:i},a);return this.http.authedRequest(G.Post,"/publicRooms",l,u)}}createAlias(e,t){var n=se("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(G.Put,n,void 0,i)}deleteAlias(e){var t=se("/directory/room/$alias",{$alias:e});return this.http.authedRequest(G.Delete,t)}getLocalAliases(e){var t=se("/rooms/$roomId/aliases",{$roomId:e}),n=It.V3;return this.http.authedRequest(G.Get,t,void 0,void 0,{prefix:n})}getRoomIdForAlias(e){var t=se("/directory/room/$alias",{$alias:e});return this.http.authedRequest(G.Get,t)}getRoomDirectoryVisibility(e){var t=se("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(G.Get,t)}setRoomDirectoryVisibility(e,t){var n=se("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(G.Put,n,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:n}=e,i={search_term:t};return n!==void 0&&(i.limit=n),this.http.authedRequest(G.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var n=t?se("/profile/$userId/$info",{$userId:e,$info:t}):se("/profile/$userId",{$userId:e});return this.http.authedRequest(G.Get,n)}doesServerSupportExtendedProfiles(){var e=this;return R(function*(){return e.doesServerSupportUnstableFeature(zI)})()}getExtendedProfileRequestPrefix(){var e=this;return R(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?It.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(G.Get,se("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=yield n.http.authedRequest(G.Get,se("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()});return i[t]})()}setExtendedProfileProperty(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var i=n.getUserId();yield n.http.authedRequest(G.Put,se("/profile/$userId/$key",{$userId:i,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(G.Delete,se("/profile/$userId/$key",{$userId:n,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();return t.http.authedRequest(G.Patch,se("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return R(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=t.getUserId();yield t.http.authedRequest(G.Put,se("/profile/$userId",{$userId:n}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(G.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return R(function*(){var n="/account/3pid/add";return t.http.authedRequest(G.Post,n,void 0,e)})()}bindThreePid(e){var t=this;return R(function*(){var n="/account/3pid/bind";return t.http.authedRequest(G.Post,n,void 0,e)})()}unbindThreePid(e,t){var n=this;return R(function*(){var i="/account/3pid/unbind",a={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest(G.Post,i,void 0,a)})()}deleteThreePid(e,t){var n="/account/3pid/delete";return this.http.authedRequest(G.Post,n,void 0,{medium:e,address:t})}setPassword(e,t,n){var i="/account/password",a={auth:e,new_password:t,logout_devices:n};return this.http.authedRequest(G.Post,i,void 0,a)}getDevices(){return this.http.authedRequest(G.Get,"/devices")}getDevice(e){var t=se("/devices/$device_id",{$device_id:e});return this.http.authedRequest(G.Get,t)}setDeviceDetails(e,t){var n=se("/devices/$device_id",{$device_id:e});return this.http.authedRequest(G.Put,n,void 0,t)}deleteDevice(e,t){var n=se("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(G.Delete,n,void 0,i)}deleteMultipleDevices(e,t){var n={devices:e};t&&(n.auth=t);var i="/delete_devices";return this.http.authedRequest(G.Post,i,void 0,n)}getPushers(){var e=this;return R(function*(){var t=yield e.http.authedRequest(G.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(n=>(n.hasOwnProperty(ip.name)||(n[ip.name]=!0),n))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(G.Post,t,void 0,e)}removePusher(e,t){var n="/pushers/set",i={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(G.Post,n,void 0,i)}setLocalNotificationSettings(e,t){var n="".concat(jR.name,".").concat(e);return this.setAccountData(n,t)}getPushRules(){return this.http.authedRequest(G.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Wl.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,n,i){var a=se("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,i)}deletePushRule(e,t,n){var i=se("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Delete,i)}setPushRuleEnabled(e,t,n,i){var a=se("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,{enabled:i})}setPushRuleActions(e,t,n,i){var a=se("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this.http.authedRequest(G.Put,a,void 0,{actions:i})}search(e,t){var{body:n,next_batch:i}=e,a={};return i&&(a.next_batch=i),this.http.authedRequest(G.Post,"/search",a,n,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(G.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(G.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={device_keys:{}};return t!==void 0&&(n.token=t),e.forEach(i=>{n.device_keys[i]=[]}),this.http.authedRequest(G.Post,"/keys/query",void 0,n)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",n=arguments.length>2?arguments[2]:void 0,i={};t===void 0&&(t="signed_curve25519");for(var[a,s]of e){var l=i[a]||{};tc(i,a,l),tc(l,s,t)}var u={one_time_keys:i};n&&(u.timeout=n);var d="/keys/claim";return this.http.authedRequest(G.Post,d,void 0,u)}getKeyChanges(e,t){var n={from:e,to:t};return this.http.authedRequest(G.Get,"/keys/changes",n)}uploadDeviceSigningKeys(e,t){var n=Object.assign({},t);return e&&Object.assign(n,{auth:e}),this.http.authedRequest(G.Post,"/keys/device_signing/upload",void 0,n,{prefix:It.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,On.V2,this.idBaseUrl);return this.http.requestOtherUrl(G.Post,t,e)}requestEmailToken(e,t,n,i,a){var s={client_secret:t,email:e,send_attempt:n==null?void 0:n.toString()};return i&&(s.next_link=i),this.http.idServerRequest(G.Post,"/validate/email/requestToken",s,On.V2,a)}requestMsisdnToken(e,t,n,i,a,s){var l={client_secret:n,country:e,phone_number:t,send_attempt:i==null?void 0:i.toString()};return a&&(l.next_link=a),this.http.idServerRequest(G.Post,"/validate/msisdn/requestToken",l,On.V2,s)}submitMsisdnToken(e,t,n,i){var a={sid:e,client_secret:t,token:n};return this.http.idServerRequest(G.Post,"/validate/msisdn/submitToken",a,On.V2,i??void 0)}submitMsisdnTokenOtherUrl(e,t,n,i){var a={sid:t,client_secret:n,token:i};return this.http.requestOtherUrl(G.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest(G.Get,"/hash_details",void 0,On.V2,e)}identityHashedLookup(e,t){var n=this;return R(function*(){var i={},a=yield n.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=a.lookup_pepper;var s={};if(a.algorithms.includes("sha256"))i.addresses=yield Promise.all(e.map(function(){var v=R(function*(g){var p=g[0].toLowerCase(),m=g[1].toLowerCase(),w=yield DI("".concat(p," ").concat(m," ").concat(i.pepper)),y=Ah(w);return s[y]=g[0],y});return function(g){return v.apply(this,arguments)}}())),i.algorithm="sha256";else if(a.algorithms.includes("none"))i.addresses=e.map(v=>{var g=v[0].toLowerCase(),p=v[1].toLowerCase(),m="".concat(g," ").concat(p);return s[m]=v[0],m}),i.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var l=yield n.http.idServerRequest(G.Post,"/lookup",i,On.V2,t);if(!(l!=null&&l.mappings))return[];var u=[];for(var d of Object.keys(l.mappings)){var c=l.mappings[d],h=s[d];if(!h)throw new Error("Identity server returned more results than expected");u.push({address:h,mxid:c})}return u})()}lookupThreePid(e,t,n){var i=this;return R(function*(){var a=yield i.identityHashedLookup([[t,e]],n),s=a.find(u=>u.address===t);if(!s)return{};var l={address:t,medium:e,mxid:s.mxid};return l})()}bulkLookupThreePids(e,t){var n=this;return R(function*(){var i=yield n.identityHashedLookup(e.map(u=>[u[1],u[0]]),t),a=[],s=o(function*(d){var c=e.find(h=>h[1]===d.address);if(!c)throw new Error("Identity sever returned unexpected results");a.push([c[0],d.address,d.mxid])},"_loop2");for(var l of i)yield*s(l);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest(G.Get,"/account",void 0,On.V2,e)}sendToDevice(e,t,n){var i=se("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),a={messages:sa(t)},s=new Map;for(var[l,u]of t)s.set(l,Array.from(u.keys()));return this.logger.debug("PUT ".concat(i),s),this.http.authedRequest(G.Put,i,void 0,a)}encryptAndSendToDevice(e,t,n){var i=this;return R(function*(){if(!i.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield i.cryptoBackend.encryptToDeviceMessages(e,t,n);yield i.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(G.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var n=se("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(G.Get,n,t)}getThirdpartyUser(e,t){var n=se("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(G.Get,n,t)}getTerms(e,t){var n=this.termsUrlForService(e,t);return this.http.requestOtherUrl(G.Get,n)}agreeToTerms(e,t,n,i){var a=this.termsUrlForService(e,t),s={Authorization:"Bearer "+n};return this.http.requestOtherUrl(G.Post,a,{user_accepts:i},{headers:s})}reportEvent(e,t,n,i){var a=se("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(G.Post,a,void 0,{score:n,reason:i})}reportRoom(e,t){var n=se("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(G.Post,n,void 0,{reason:t})}getRoomHierarchy(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,s=se("/rooms/$roomId/hierarchy",{$roomId:e}),l={suggested_only:String(i),max_depth:n==null?void 0:n.toString(),from:a,limit:t==null?void 0:t.toString()};return this.http.authedRequest(G.Get,s,l,void 0,{prefix:It.V1}).catch(u=>{if(u.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(G.Get,s,l,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw u})}unstableCreateFileTree(e){var t=this;return R(function*(){var{room_id:n}=yield t.createRoom({name:e,preset:oy.PrivateChat,power_level_content_override:Tt(Tt({},uN),{},{users:{[t.getUserId()]:100}}),creation_content:{[rc]:ls.Space},initial_state:[{type:ep.name,state_key:rp.name,content:{[tp.name]:!0}},{type:F.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new kc(t,n)})()}unstableGetFileTreeSpace(e){var t,n,i=this.getRoom(e);if((i==null?void 0:i.getMyMembership())!==ke.Join)return null;var a=i.currentState.getStateEvents(F.RoomCreate,""),s=i.currentState.getStateEvents(ep.name,rp.name);if(!a)throw new Error("Expected single room create event");return!(s!=null&&(t=s.getContent())!==null&&t!==void 0&&t[tp.name])||((n=a.getContent())===null||n===void 0?void 0:n[rc])!==ls.Space?null:new kc(this,e)}slidingSync(e,t,n){var i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(G.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:n})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(Pt.IntentionalMentions)!==Ot.Unsupported}getRoomSummary(e,t){var n=this;return R(function*(){var i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=se("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest(G.Get,a,{via:t},void 0,i)}catch(l){if(l instanceof ft&&l.errcode==="M_UNRECOGNIZED"){var s=se("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest(G.Get,s,{via:t},void 0,i)}else throw l}})()}processThreadEvents(e,t,n){e.processThreadedEvents(t,n)}processThreadRoots(e,t,n){this.supportsThreads()&&e.processThreadRoots(t,n)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return R(function*(){return e.http.authedRequest(G.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var i=this;return R(function*(){var a=se("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:n};try{return yield i.http.authedRequest(G.Get,a,s,void 0,{prefix:It.V1})}catch(l){if(l.errcode==="M_UNRECOGNIZED"&&(l.httpStatus===400||l.httpStatus===404||l.httpStatus===405))return yield i.http.authedRequest(G.Get,a,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw l}})()}getAuthIssuer(){var e=this;return R(function*(){return e.http.request(G.Get,"/auth_issuer",void 0,void 0,{prefix:It.Unstable+"/org.matrix.msc2965"})})()}getAuthMetadata(){var e=this;return R(function*(){var t;try{t=yield e.http.request(G.Get,"/auth_metadata",void 0,void 0,{prefix:It.Unstable+"/org.matrix.msc2965"})}catch(i){if(i instanceof ft&&i.errcode==="M_UNRECOGNIZED"){var{issuer:n}=yield e.getAuthIssuer();return py(n)}throw i}return my(t)})()}};o(eE,"MatrixClient");let to=eE;f(to,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function E0(r){return Object.fromEntries(Object.entries(r).map(e=>{var[t,n]=e;return["".concat(vn,".").concat(t),n]}))}o(E0,"getUnstableDelayQueryOpts");function JI(r,e){var t,n=r.getUserId(),i=e.getId(),a=r.getRoom(e.getRoomId());if(!(!a||!n||!i)){if(!a.findEventById(i)){I.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var s=!!e.threadRootId&&!e.isThreadRoot,l;if(s){var u=a.getThread(e.threadRootId);l=u?u.hasUserReadEvent(n,i):!0}else l=a.hasUserReadEvent(n,i);if(!l){var d=r.getPushActionsForEvent(e,!0),c=!!(d!=null&&(t=d.tweaks)!==null&&t!==void 0&&t.highlight);if(c){var h=a.getUnreadCountForEventContext(Be.Highlight,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,Be.Highlight,h):a.setUnreadNotificationCount(Be.Highlight,h)}var v=!!(d!=null&&d.notify);if(v){var g=a.getUnreadCountForEventContext(Be.Total,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,Be.Total,g):a.setUnreadNotificationCount(Be.Total,g)}}}}o(JI,"fixNotificationCountOnDecryption");function ro(r){return zl(r)?lu:r.threadRootId}o(ro,"threadIdForReceipt");function zl(r){if(!r.threadRootId||r.isThreadRoot)return!0;if(!r.isRelation())return I.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(r.getId())),!0;if(r.isRelation(qe.name))return!1;var e=r.relationEventId===r.threadRootId;return e}o(zl,"inMainTimelineForReceipt");function _0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(_0,"ownKeys$1");function b0(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?_0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):_0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(b0,"_objectSpread$1");var tr=function(r){return r.New="Thread.new",r.Update="Thread.update",r.NewReply="Thread.newReply",r.ViewThread="Thread.viewThread",r.Delete="Thread.delete",r}({}),Vt=function(r){return r[r.None=0]="None",r[r.Experimental=1]="Experimental",r[r.Stable=2]="Stable",r}({});function _d(r,e){return r?Vt.Stable:e?Vt.Experimental:Vt.None}o(_d,"determineFeatureSupport");const fn=class fn extends mc{constructor(e,t,n){var i,a;if(super(),i=this,this.id=e,this.rootEvent=t,f(this,"timelineSet",void 0),f(this,"_currentUserParticipated",!1),f(this,"reEmitter",void 0),f(this,"lastEvent",void 0),f(this,"replyCount",0),f(this,"lastPendingEvent",void 0),f(this,"pendingReplyCount",0),f(this,"room",void 0),f(this,"client",void 0),f(this,"pendingEventOrdering",void 0),f(this,"processRootEventPromise",void 0),f(this,"initialEventsFetched",!fn.hasServerSideSupport),f(this,"initalEventFetchProm",void 0),f(this,"replayEvents",[]),f(this,"onTimelineReset",R(function*(){yield i.processRootEventPromise,i.processRootEventPromise=void 0})),f(this,"onBeforeRedaction",(s,l)=>{s!=null&&s.isRelation(qe.name)&&this.room.eventShouldLiveIn(s).threadId===this.id&&s.getId()!==this.id&&!l.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(tr.Update,this))}),f(this,"onRedaction",function(){var s=R(function*(l,u,d){if(d===i.id)if(i.replyCount<=0){for(var c of i.timeline)i.clearEventMetadata(c);i.lastEvent=i.rootEvent,i._currentUserParticipated=!1,i.emit(tr.Delete,i)}else{var h;((h=i.lastEvent)===null||h===void 0?void 0:h.getId())===l.getAssociatedId()&&(yield i.processRootEventPromise,i.processRootEventPromise=void 0),yield i.updateThreadMetadata()}});return function(l,u,d){return s.apply(this,arguments)}}()),f(this,"onTimelineEvent",(s,l,u)=>{if(!u){var d=s.getSender();d&&l&&this.shouldSendLocalEchoReceipt(d,s)&&l.addLocalEchoReceipt(d,s,er.Read),s.getId()!==this.id&&s.isRelation(qe.name)&&this.replyCount++}this.onEcho(s,u??!1)}),f(this,"onLocalEcho",s=>{this.onEcho(s,!1)}),f(this,"onEcho",function(){var s=R(function*(l,u){l.threadRootId===i.id&&i.lastEvent!==l&&(yield i.updateThreadMetadata(),l.isRelation(qe.name)&&(u||(i.lastEvent=void 0,i.emit(tr.NewReply,i,l))))});return function(l,u){return s.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(n!=null&&n.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=(a=n.pendingEventOrdering)!==null&&a!==void 0?a:eo.Chronological,this.timelineSet=new Si(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Li(this),this.reEmitter.reEmit(this.timelineSet,[fe.Timeline,fe.TimelineReset]),this.room.on(We.BeforeRedaction,this.onBeforeRedaction),this.room.on(fe.Redaction,this.onRedaction),this.room.on(fe.LocalEchoUpdated,this.onLocalEcho),this.room.on(fe.TimelineReset,this.onTimelineReset),this.timelineSet.on(fe.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return R(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),n=e.client.getEventMapper();e.rootEvent=n(t)}catch(i){I.error("Failed to fetch thread root to construct thread with",i)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){fn.hasServerSideSupport=e,e!==Vt.Stable&&(fs.setPreferUnstable(!0),vs.setPreferUnstable(!0),qe.setPreferUnstable(!0))}static setServerSideListSupport(e){fn.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){fn.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n,i=(n=this.client.canSupport.get(Pt.RelationsRecursion))!==null&&n!==void 0?n:Ot.Unsupported;if(i===Ot.Unsupported){var a,s=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(s){var l=this.findEventById(s);if(l&&l.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(me.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(n=>this.addEvent(n,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var i=this.lastReply(),a=!i||e.localTimestamp>=i.localTimestamp;if(!fn.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(tt.Annotation)||e.isRelation(tt.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(qe.name)&&!t&&a&&(this.lastEvent=void 0),n&&(this.emit(tr.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var n,i;if(this.initialEventsFetched){var s,l=(s=this.client.canSupport.get(Pt.RelationsRecursion))!==null&&s!==void 0?s:Ot.Unsupported;l===Ot.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var a;(a=this.replayEvents)===null||a===void 0||a.push(e)}(n=this.timelineSet.relations)===null||n===void 0||n.aggregateParentEvent(e),(i=this.timelineSet.relations)===null||i===void 0||i.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return R(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:n,userId:i,receipt:a,synthetic:s}of e)this.addReceiptToStructure(t,n,i,a,s)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e==null?void 0:e.getServerAggregatedRelation(qe.name)}processRootEvent(){var e=this;return R(function*(){var t=e.getRootEventBundledRelationship();if(fn.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var n=e.client.getEventMapper();e.lastEvent=n(b0(b0({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===eo.Detached?this.room.getPendingEvents():this.events,t=e.filter(n=>{var i;return n.threadRootId===this.id&&n.isRelation(qe.name)&&n.status!==null&&n.getId()!==((i=this.lastEvent)===null||i===void 0?void 0:i.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var n=this;return R(function*(){var i=n.liveTimeline;n.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=n.liveTimeline,s,l;if(e){var u=yield n.client.createMessagesRequest(n.roomId,e,1,Me.Forward);s=u.end}if(t){var d=yield n.client.createMessagesRequest(n.roomId,t,1,Me.Backward);l=d.start}t&&i.getPaginationToken(Me.Forward)===t&&i.setPaginationToken(l??null,Me.Forward),e&&a.getPaginationToken(Me.Backward)===e&&a.setPaginationToken(s??null,Me.Backward)})()}updateThreadFromRootEvent(){var e=this;return R(function*(){fn.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return R(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,Me.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(fe.TimelineReset,e.room,e.timelineSet,!0)}catch(n){I.error("Failed to load start of newly created thread: ",n),e.initialEventsFetched=!1}e.emit(tr.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return R(function*(){var n,i=(n=t.client.canSupport.get(Pt.RelationsRecursion))!==null&&n!==void 0?n:Ot.Unsupported;if(i===Ot.Unsupported){for(var a=e.length,s=new Array(a),l=0;l<a;l++)s[l]=e[l];return Promise.all(s.filter(iL).map(function(){var u=R(function*(d){try{var c=yield t.client.relations(t.roomId,d.getId(),tt.Replace,d.getType(),{limit:1});if(c.events.length){var h=c.events[0];d.makeReplaced(h),t.insertEventIntoTimeline(h)}}catch(v){I.error("Failed to load edits for encrypted thread event",v)}});return function(d){return u.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(me.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[qe.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:i=>i.isRelation(qe.name),t=this.timeline.length-1;t>=0;t--){var n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof Ht}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(n&&i){var a=i.getTs()<this.room.getOldestThreadedReceiptTs(),s=i.getId();if(a&&s)return s}var l=super.getEventReadUpTo(e,t);if(i){var u=this.room.getLastUnthreadedReceiptFor(e);if(!u)return l;for(var d=((c=this.timeline)===null||c===void 0?void 0:c.length)-1;d>=0;--d){var c,h,v=this.timeline[d];if(v.getId()===l)return l;if(v.getTs()<u.ts)return(h=v.getId())!==null&&h!==void 0?h:l}}return l}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var n,i,a,s,l,u,d=((n=(i=this.lastReply())===null||i===void 0?void 0:i.getTs())!==null&&n!==void 0?n:0)<this.room.getOldestThreadedReceiptTs(),c=(a=(s=this.room.getLastUnthreadedReceiptFor(e))===null||s===void 0?void 0:s.ts)!==null&&a!==void 0?a:0,h=((l=this===null||this===void 0||(u=this.lastReply())===null||u===void 0?void 0:u.getTs())!==null&&l!==void 0?l:0)<c;if(d||h)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}};o(fn,"Thread");let _t=fn;f(_t,"hasServerSideSupport",Vt.None);f(_t,"hasServerSideListSupport",Vt.None);f(_t,"hasServerSideFwdPaginationSupport",Vt.None);function iL(r){return r.isEncrypted()&&(r.isRelation(qe.name)||r.isThreadRoot)}o(iL,"isAnEncryptedThreadMessage");var fs=new Gs("related_by_senders","io.element.relation_senders"),vs=new Gs("related_by_rel_types","io.element.relation_types"),qe=new Gs("m.thread","io.element.thread"),Vr=function(r){return r[r.My=0]="My",r[r.All=1]="All",r}({});function QI(r){switch(r){case Vr.My:return"participated";default:return"all"}}o(QI,"threadFilterTypeToFilter");const tE=class tE extends Error{constructor(e,t,n){super(t),this.code=e,f(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=aL(this,n)}};o(tE,"DecryptionError");let Bc=tE;function aL(r,e){var t=r.name+"[msg: "+r.message;return e&&(t+=", "+Object.keys(e).map(n=>n+": "+e[n]).join(", ")),t+="]",t}o(aL,"detailedStringForDecryptionError");var w0=Object.freeze({visible:!0}),We=function(r){return r.Decrypted="Event.decrypted",r.BeforeRedaction="Event.beforeRedaction",r.VisibilityChange="Event.visibilityChange",r.LocalEventIdReplaced="Event.localEventIdReplaced",r.Status="Event.status",r.Replaced="Event.replaced",r.RelationsCreated="Event.relationsCreated",r.SentinelUpdated="Event.sentinelUpdated",r}({});const eh=class eh extends Qe{setMetadata(e,t){var n,i,a=this.isState()&&this.getType()===F.RoomMember&&this.getSender()===this.getStateKey(),s=!1;if(a||!((n=this.sender)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)){var l=e.getSentinelMember(this.getSender());l!==this.sender&&(s=!0),this.sender=l}if(a||!((i=this.target)!==null&&i!==void 0&&(i=i.events)!==null&&i!==void 0&&i.member)&&this.getType()===F.RoomMember){var u=e.getSentinelMember(this.getStateKey());u!==this.target&&(s=!0),this.target=u}this.isState()&&t&&(this.forwardLooking=!1),s&&this.emit(We.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,f(this,"pushDetails",{}),f(this,"_replacingEvent",null),f(this,"_localRedactionEvent",null),f(this,"_isCancelled",!1),f(this,"clearEvent",void 0),f(this,"visibility",w0),f(this,"_hasCachedExtEv",!1),f(this,"_cachedExtEv",void 0),f(this,"_decryptionFailureReason",null),f(this,"senderCurve25519Key",null),f(this,"claimedEd25519Key",null),f(this,"forwardingCurve25519KeyChain",[]),f(this,"untrusted",null),f(this,"decryptionPromise",null),f(this,"retryDecryption",!1),f(this,"txnId",void 0),f(this,"thread",void 0),f(this,"threadId",void 0),f(this,"localTimestamp",void 0),f(this,"sender",null),f(this,"target",null),f(this,"status",null),f(this,"error",null),f(this,"forwardLooking",!0),f(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(i=>{typeof t[i]=="string"&&(t[i]=Ef(t[i]))}),["membership","avatar_url","displayname"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0?void 0:a[i])=="string"&&(t.content[i]=Ef(t.content[i]))}),["rel_type"].forEach(i=>{var a;typeof((a=t.content)===null||a===void 0||(a=a["m.relates_to"])===null||a===void 0?void 0:a[i])=="string"&&(t.content["m.relates_to"][i]=Ef(t.content["m.relates_to"][i]))}),this.txnId=t.txn_id;var n=this.getAge();this.localTimestamp=n!==void 0?Date.now()-n:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new Li(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=ar.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===F.RoomMessageEncrypted)for(var[t,n]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=n);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var n=this.getContent()[Ch];return"msgid=".concat(n," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if((t==null?void 0:t.rel_type)===qe.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var n=this.getUnsigned();if(typeof n[nc.name]=="string")return n[nc.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(qe.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return FR.findIn(e)}makeEncrypted(e,t,n,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=n,this.claimedEd25519Key=i}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===o0.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=n.clearEvent&&!n.isDecryptionFailure(),s=i.forceRedecryptIfUntrusted&&n.isKeySourceUntrusted();if(a&&!s)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(I.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,i),n.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var a=void 0;try{var s=yield e.decryptEvent(n);i.isRetry===!0&&I.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(s),n._decryptionFailureReason=null}catch(u){var l=u instanceof Bc?u.detailedString:String(u);if(a=u,n.retryDecryption){I.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(l));continue}I.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(l)),n.setClearDataForDecryptionFailure(String(u)),n._decryptionFailureReason=u instanceof Bc?u.code:o0.UNKNOWN_ERROR}n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),i.emit!==!1&&n.emit(We.Decrypted,n,a);return}})()}setClearData(e){var t,n;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(n=e.claimedEd25519Key)!==null&&n!==void 0?n:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:F.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===F.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(We.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n,i=(t=e==null?void 0:e.visible)!==null&&t!==void 0?t:!0,a=(n=e==null?void 0:e.reason)!==null&&n!==void 0?n:null,s=!1;(this.visibility.visible!==i||!this.visibility.visible&&this.visibility.reason!==a)&&(s=!0),s&&(i?this.visibility=w0:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(We.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(We.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var n in this.event)this.event.hasOwnProperty(n)&&!sL.has(n)&&delete this.event[n];this.isEncrypted()&&(this.clearEvent=void 0);var i=this.getType()in T0?T0[this.getType()]:{},a=this.getContent();for(var s in a)a.hasOwnProperty(s)&&!i[s]&&delete a[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var n of t.events){var i;((i=n.getRelation())===null||i===void 0?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var n=e.getLiveTimeline();n.getTimelineSet().insertEventIntoTimeline(this,n,n.getState(me.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===F.RoomRedaction}asVisibilityChange(){if(!oa.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var n=this.getWireContent(),i=!!n.visible,a=n.reason;return a&&typeof a!="string"?null:{visible:i,reason:a,eventId:t}}isVisibilityEvent(){return oa.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var n,i;return(n=(i=this.clearEvent)===null||i===void 0?void 0:i.unsigned.redacted_because)!==null&&n!==void 0?n:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,n=this.getUnsigned(),i=this.getId();this.event=e,n.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=n.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit(We.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(We.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(We.LocalEventIdReplaced,this)}isRelation(e){var t,n=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(n!=null&&n.rel_type)&&[tt.Replace,tt.Thread].includes(n.rel_type)?!1:!!(n!=null&&n.rel_type&&n.event_id&&(!e||n.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(We.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(tt.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(tt.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var n;return(n=this._replacingEvent.getDate())!==null&&n!==void 0?n:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new eh(JSON.parse(JSON.stringify(this.event)));for(var[t,n]of Object.entries(this))t!=="event"&&(e[t]=n);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=Hv(this.event),n=Hv(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[tr.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[tr.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}};o(eh,"MatrixEvent");let Ht=eh;var sL=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),T0={[F.RoomMember]:{membership:1},[F.RoomJoinRules]:{join_rule:1},[F.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},oL=["org.matrix.hydra.11","12"];function lL(r){return oL.includes(r)}o(lL,"shouldUseHydraForRoomVersion");var mr=function(r){return r[r.NotStarted=0]="NotStarted",r[r.InProgress=1]="InProgress",r[r.Finished=2]="Finished",r}(mr||{}),De=function(r){return r.Events="RoomState.events",r.Members="RoomState.members",r.NewMember="RoomState.newMember",r.Update="RoomState.update",r.BeaconLiveness="RoomState.BeaconLiveness",r.Marker="RoomState.Marker",r}({});const th=class th extends Qe{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:mr.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,f(this,"reEmitter",new Li(this)),f(this,"sentinels",{}),f(this,"displayNameToUserIds",new Map),f(this,"userIdsToDisplayNames",{}),f(this,"tokenToInvite",{}),f(this,"joinedMemberCount",null),f(this,"summaryJoinedMemberCount",null),f(this,"invitedMemberCount",null),f(this,"summaryInvitedMemberCount",null),f(this,"modified",-1),f(this,"members",{}),f(this,"events",new Map),f(this,"paginationToken",null),f(this,"beacons",new Map),f(this,"_liveBeaconIds",[]),f(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(F.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(I.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===ke.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===ke.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new Ea(this.roomId,e);var n=this.members[e];n!=null&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var n=this.events.get(e).get(t);return n||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new th(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=mr.NotStarted,Array.from(this.events.values()).forEach(n=>{e.setStateEvents(Array.from(n.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==mr.Finished&&this.getMembers().forEach(n=>{if(n.isOutOfBand()){var i;(i=e.getMember(n.userId))===null||i===void 0||i.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(n=>!this.events.has(n.getType())||!this.events.get(n.getType()).has(n.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState())){uy.matches(n.getType())&&this.setBeacon(n);var i=this.getStateEventMatching(n);if(this.setStateEvent(n),n.getType()===F.RoomMember){var a;this.updateDisplayNameCache(n.getStateKey(),(a=n.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(n)}this.emit(De.Events,n,this,i)}}),this.onBeaconLivenessChange(),e.forEach(n=>{if(!(n.getRoomId()!==this.roomId||!n.isState()))if(n.getType()===F.RoomMember){var i=n.getStateKey();(n.getContent().membership===ke.Leave||n.getContent().membership===ke.Ban)&&(n.getContent().avatar_url=n.getContent().avatar_url||n.getPrevContent().avatar_url,n.getContent().displayname=n.getContent().displayname||n.getPrevContent().displayname);var a=this.getOrCreateMember(i,n);a.setMembershipEvent(n,this),this.updateMember(a),this.emit(De.Members,n,this,a)}else if(n.getType()===F.RoomPowerLevels){if(n.getStateKey()!=="")return;var s=Object.values(this.members),l=this.getStateEvents(F.RoomCreate,""),u=R0(this.getRoomVersion(),l);s.forEach(d=>{var c=d.getLastModifiedTime();if(l){var h=I0(d.userId,n,u);d.setPowerLevel(h,n)}c!==d.getLastModifiedTime()&&this.emit(De.Members,n,this,d)}),this.sentinels={}}else LR.matches(n.getType())&&this.emit(De.Marker,n,t)}),this.emit(De.Update,this)}processBeaconEvents(e,t){var n=this;return R(function*(){if(!(!e.length||!n.beacons.size)){var i=[...n.beacons.values()].reduce((d,c)=>(d[c.beaconInfoId]=c,d),{}),a=o((d,c)=>{if(pm.matches(c.getType())){var h=i[d];h&&h.addLocations([c])}},"processBeaconRelation"),s=o(function*(c){var h,v=(h=c.getRelation())===null||h===void 0?void 0:h.event_id;if(!v||!i[v])return{v:void 0};if(!pm.matches(c.getType())&&!c.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(c),a(v,c)}catch{c.isDecryptionFailure()&&c.once(We.Decrypted,R(function*(){a(v,c)}))}},"_loop"),l;for(var u of e)if(l=yield*s(u),l)return l.v}})()}getOrCreateMember(e,t){var n=this.members[e];return n||(n=new Ea(this.roomId,e),this.members[e]=n,this.emit(De.NewMember,t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=vc(e);if(this.beacons.has(t)){var n=this.beacons.get(t);if(e.isRedacted()){var i;n.beaconInfoId===((i=e.getRedactionEvent())===null||i===void 0?void 0:i.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var a=new pc(e);this.reEmitter.reEmit(a,[Ze.New,Ze.Update,Ze.Destroy,Ze.LivenessChange]),this.emit(Ze.New,e,a),a.on(Ze.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(Ze.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(De.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,n;return(t=(n=this.events.get(e.getType()))===null||n===void 0?void 0:n.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(F.RoomCreate,""),n=this.getStateEvents(F.RoomPowerLevels,"");if(n&&t){var i=I0(e.userId,n,R0(this.getRoomVersion(),t));e.setPowerLevel(i,n)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===mr.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===mr.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===mr.NotStarted&&(this.oobMemberFlags.status=mr.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===mr.InProgress&&(this.oobMemberFlags.status=mr.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var n=this.members[t];n.isOutOfBand()&&(++e,delete this.members[t])}),I.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=mr.NotStarted}setOutOfBandMembers(e){I.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===mr.InProgress&&(I.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=mr.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(De.Update,this))}setOutOfBandMember(e){if(e.getType()===F.RoomMember){var t=e.getStateKey(),n=this.getMember(t);if(!(n&&!n.isOutOfBand())){var i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(De.Members,e,this,i)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(ca(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var n=this.getMember(t);if(!n||n.membership===ke.Leave||e.status||e.isRedacted())return!1;var i=this.maySendEvent(F.RoomRedaction,t);return i?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",n.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var n=this.getStateEvents(F.RoomPowerLevels,""),i={};n&&(i=n.getContent());var a=50;return z_(i[e])&&(a=i[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(F.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){var i,a=this.getStateEvents(F.RoomPowerLevels,""),s,l={},u=0,d=0;a&&(s=a.getContent(),l=s.events||{},Number.isSafeInteger(s.state_default)?u=s.state_default:u=50,Number.isSafeInteger(s.events_default)&&(d=s.events_default));var c=n?u:d;Number.isSafeInteger(l[e])&&(c=l[e]);var h=this.getMember(t),v=(i=h==null?void 0:h.powerLevel)!==null&&i!==void 0?i:0;return v>=c}mayTriggerNotifOfType(e,t){var n=this.getMember(t);if(!n)return!1;var i=this.getStateEvents(F.RoomPowerLevels,""),a=50;return i&&i.getContent()&&i.getContent().notifications&&z_(i.getContent().notifications[e])&&(a=i.getContent().notifications[e]),n.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(F.RoomJoinRules,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.join_rule||CI.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(F.RoomHistoryVisibility,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.history_visibility||ly.Shared}getGuestAccess(){var e,t=this.getStateEvents(F.RoomGuestAccess,""),n=(e=t==null?void 0:t.getContent())!==null&&e!==void 0?e:{};return n.guest_access||Cc.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(F.RoomPredecessor,"");if(t){var n=t.getContent(),i=n.predecessor_room_id,a=n.last_known_event_id;typeof a!="string"&&(a=void 0);var s=n.via_servers;if(Array.isArray(s)||(s=void 0),typeof i=="string")return{roomId:i,eventId:a,viaServers:s}}}var l=this.getStateEvents(F.RoomCreate,"");if(l){var u=l.getContent().predecessor;if(u){var d=u.room_id;if(typeof d=="string"){var c=u.event_id;return(typeof c!="string"||c==="")&&(c=void 0),{roomId:d,eventId:c}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var n=this.getStateEvents(F.RoomThirdPartyInvite,t);n&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var n=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],n){var i=ca(n),a=this.displayNameToUserIds.get(i);if(a){var s=a.filter(c=>c!==e);this.displayNameToUserIds.set(i,s)}}this.userIdsToDisplayNames[e]=t;var l=t&&ca(t);if(l){var u,d=(u=this.displayNameToUserIds.get(l))!==null&&u!==void 0?u:[];d.push(e),this.displayNameToUserIds.set(l,d)}}};o(th,"RoomState");let Jl=th;function R0(r,e){var t=new Set;if(lL(r)&&e){var n=e.getSender();n&&t.add(n);var i=e.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(a=>t.add(a))}return t}o(R0,"getCreators");function I0(r,e,t){if(t.has(r))return 1/0;var n=e.getDirectionalContent(),i=n.users||{};return i[r]!==void 0&&Number.isInteger(i[r])?i[r]:n.users_default!==void 0?n.users_default:0}o(I0,"powerLevelForUserId");function C0(r){var e=typeof r=="string"&&!!r&&r!=="undefined"&&r!=="null";return e||typeof r=="number"}o(C0,"isValidFilterId");const rE=class rE{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};f(this,"rooms",{}),f(this,"users",{}),f(this,"syncToken",null),f(this,"filters",new Yr(()=>new Map)),f(this,"accountData",new Map),f(this,"localStorage",void 0),f(this,"oobMembers",new Map),f(this,"pendingEvents",{}),f(this,"clientOptions",void 0),f(this,"pendingToDeviceBatches",[]),f(this,"nextToDeviceBatchId",0),f(this,"createUser",void 0),f(this,"onRoomMember",(t,n,i)=>{var a;if(i.membership!==ke.Invite){var s=this.users[i.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,i.userId));i.name&&(s.setDisplayName(i.name),i.events.member&&s.setRawDisplayName(i.events.member.getDirectionalContent().displayname)),i.events.member&&i.events.member.getContent().avatar_url&&s.setAvatarUrl(i.events.member.getContent().avatar_url),this.users[s.userId]=s}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(De.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(De.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,n,i){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var n;return((n=this.filters.get(e))===null||n===void 0?void 0:n.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var n=this.localStorage.getItem(t);if(C0(n))return n}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var n="mxjssdk_memory_filter_"+e;try{C0(t)?this.localStorage.setItem(n,t):this.localStorage.removeItem(n)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var n=!Object.keys(t.getContent()).length;n?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new Yr(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return R(function*(){var n;return(n=t.pendingEvents[e])!==null&&n!==void 0?n:[]})()}setPendingEvents(e,t){var n=this;return R(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return R(function*(){})()}};o(rE,"MemoryStore");let Ql=rE;var Kf={},qi={},Oa={};Object.defineProperty(Oa,"__esModule",{value:!0});Oa.WidgetApiDirection=void 0;Oa.invertedDirection=uL;var Vo=function(r){return r.ToWidget="toWidget",r.FromWidget="fromWidget",r}({});Oa.WidgetApiDirection=Vo;function uL(r){if(r===Vo.ToWidget)return Vo.FromWidget;if(r===Vo.FromWidget)return Vo.ToWidget;throw new Error("Invalid direction")}o(uL,"invertedDirection");var _n={};Object.defineProperty(_n,"__esModule",{value:!0});_n.UnstableApiVersion=_n.MatrixApiVersion=_n.CurrentApiVersions=void 0;var Um=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});_n.MatrixApiVersion=Um;var gr=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});_n.UnstableApiVersion=gr;var dL=[Um.Prerelease1,Um.Prerelease2,gr.MSC2762,gr.MSC2762_UPDATE_STATE,gr.MSC2871,gr.MSC2873,gr.MSC2931,gr.MSC2974,gr.MSC2876,gr.MSC3819,gr.MSC3846,gr.MSC3869,gr.MSC3973,gr.MSC4039];_n.CurrentApiVersions=dL;var Ao={},O0;function gy(){if(O0)return Ao;O0=1,Object.defineProperty(Ao,"__esModule",{value:!0}),Ao.PostmessageTransport=void 0;var r=Ih,e=Wh(),t=["message"];function n(_){"@babel/helpers - typeof";return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(O){return typeof O}:function(O){return O&&typeof Symbol=="function"&&O.constructor===Symbol&&O!==Symbol.prototype?"symbol":typeof O},n(_)}o(n,"_typeof");function i(_,O){if(_==null)return{};var b=a(_,O),j,B;if(Object.getOwnPropertySymbols){var q=Object.getOwnPropertySymbols(_);for(B=0;B<q.length;B++)j=q[B],!(O.indexOf(j)>=0)&&Object.prototype.propertyIsEnumerable.call(_,j)&&(b[j]=_[j])}return b}o(i,"_objectWithoutProperties");function a(_,O){if(_==null)return{};var b={},j=Object.keys(_),B,q;for(q=0;q<j.length;q++)B=j[q],!(O.indexOf(B)>=0)&&(b[B]=_[B]);return b}o(a,"_objectWithoutPropertiesLoose");function s(_,O){var b=Object.keys(_);if(Object.getOwnPropertySymbols){var j=Object.getOwnPropertySymbols(_);O&&(j=j.filter(function(B){return Object.getOwnPropertyDescriptor(_,B).enumerable})),b.push.apply(b,j)}return b}o(s,"ownKeys");function l(_){for(var O=1;O<arguments.length;O++){var b=arguments[O]!=null?arguments[O]:{};O%2?s(Object(b),!0).forEach(function(j){S(_,j,b[j])}):Object.getOwnPropertyDescriptors?Object.defineProperties(_,Object.getOwnPropertyDescriptors(b)):s(Object(b)).forEach(function(j){Object.defineProperty(_,j,Object.getOwnPropertyDescriptor(b,j))})}return _}o(l,"_objectSpread");function u(_,O){if(!(_ instanceof O))throw new TypeError("Cannot call a class as a function")}o(u,"_classCallCheck");function d(_,O){for(var b=0;b<O.length;b++){var j=O[b];j.enumerable=j.enumerable||!1,j.configurable=!0,"value"in j&&(j.writable=!0),Object.defineProperty(_,T(j.key),j)}}o(d,"_defineProperties");function c(_,O,b){return O&&d(_.prototype,O),Object.defineProperty(_,"prototype",{writable:!1}),_}o(c,"_createClass");function h(_,O){if(typeof O!="function"&&O!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(O&&O.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),O&&v(_,O)}o(h,"_inherits");function v(_,O){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(j,B){return j.__proto__=B,j},"_setPrototypeOf"),v(_,O)}o(v,"_setPrototypeOf");function g(_){var O=w();return o(function(){var j=y(_),B;if(O){var q=y(this).constructor;B=Reflect.construct(j,arguments,q)}else B=j.apply(this,arguments);return p(this,B)},"_createSuperInternal")}o(g,"_createSuper");function p(_,O){if(O&&(n(O)==="object"||typeof O=="function"))return O;if(O!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(_)}o(p,"_possibleConstructorReturn");function m(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}o(m,"_assertThisInitialized");function w(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(w,"_isNativeReflectConstruct");function y(_){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(b){return b.__proto__||Object.getPrototypeOf(b)},"_getPrototypeOf"),y(_)}o(y,"_getPrototypeOf");function S(_,O,b){return O=T(O),O in _?Object.defineProperty(_,O,{value:b,enumerable:!0,configurable:!0,writable:!0}):_[O]=b,_}o(S,"_defineProperty");function T(_){var O=C(_,"string");return n(O)==="symbol"?O:String(O)}o(T,"_toPropertyKey");function C(_,O){if(n(_)!=="object"||_===null)return _;var b=_[Symbol.toPrimitive];if(b!==void 0){var j=b.call(_,O);if(n(j)!=="object")return j;throw new TypeError("@@toPrimitive must return a primitive value.")}return(O==="string"?String:Number)(_)}o(C,"_toPrimitive");var M=function(_){h(b,_);var O=g(b);function b(j,B,q,oe){var de;return u(this,b),de=O.call(this),de.sendDirection=j,de.initialWidgetId=B,de.transportWindow=q,de.inboundWindow=oe,S(m(de),"strictOriginCheck",!1),S(m(de),"targetOrigin","*"),S(m(de),"timeoutSeconds",10),S(m(de),"_ready",!1),S(m(de),"_widgetId",null),S(m(de),"outboundRequests",new Map),S(m(de),"stopController",new AbortController),de._widgetId=B,de}return o(b,"PostmessageTransport"),c(b,[{key:"ready",get:o(function(){return this._ready},"get")},{key:"widgetId",get:o(function(){return this._widgetId||null},"get")},{key:"nextRequestId",get:o(function(){for(var B="widgetapi-".concat(Date.now()),q=0,oe=B;this.outboundRequests.has(oe);)oe="".concat(B,"-").concat(q++);return this.outboundRequests.set(oe,null),oe},"get")},{key:"sendInternal",value:o(function(B){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),B),this.transportWindow.postMessage(B,this.targetOrigin)},"sendInternal")},{key:"reply",value:o(function(B,q){return this.sendInternal(l(l({},B),{},{response:q}))},"reply")},{key:"send",value:o(function(B,q){return this.sendComplete(B,q).then(function(oe){return oe.response})},"send")},{key:"sendComplete",value:o(function(B,q){var oe=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var de={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:B,data:q};return B===e.WidgetApiToWidgetAction.UpdateVisibility&&(de.visible=q.visible),new Promise(function(Ne,Oe){var Ae=o(function(J){ge(),Ne(J)},"resolve"),ae=o(function(J){ge(),Oe(J)},"reject"),X=setTimeout(function(){return ae(new Error("Request timed out"))},(oe.timeoutSeconds||1)*1e3),ue=o(function(){return ae(new Error("Transport stopped"))},"onStop");oe.stopController.signal.addEventListener("abort",ue);var ge=o(function(){oe.outboundRequests.delete(de.requestId),clearTimeout(X),oe.stopController.signal.removeEventListener("abort",ue)},"cleanUp");oe.outboundRequests.set(de.requestId,{request:de,resolve:Ae,reject:ae}),oe.sendInternal(de)})},"sendComplete")},{key:"start",value:o(function(){var B=this;this.inboundWindow.addEventListener("message",function(q){B.handleMessage(q)}),this._ready=!0},"start")},{key:"stop",value:o(function(){this._ready=!1,this.stopController.abort()},"stop")},{key:"handleMessage",value:o(function(B){if(!this.stopController.signal.aborted&&B.data&&!(this.strictOriginCheck&&B.origin!==window.origin)){var q=B.data;if(!(!q.action||!q.requestId||!q.widgetId))if(q.response){if(q.api!==this.sendDirection)return;this.handleResponse(q)}else{var oe=q;if(oe.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(oe)}}},"handleMessage")},{key:"handleRequest",value:o(function(B){if(this.widgetId){if(this.widgetId!==B.widgetId)return}else this._widgetId=B.widgetId;this.emit("message",new CustomEvent("message",{detail:B}))},"handleRequest")},{key:"handleResponse",value:o(function(B){if(B.widgetId===this.widgetId){var q=this.outboundRequests.get(B.requestId);if(q)if((0,e.isErrorResponse)(B.response)){var oe=B.response.error,de=oe.message,Ne=i(oe,t);q.reject(new e.WidgetApiResponseError(de,Ne))}else q.resolve(B)}},"handleResponse")}]),b}(r.EventEmitter);return Ao.PostmessageTransport=M,Ao}o(gy,"requirePostmessageTransport");var Ui={};Object.defineProperty(Ui,"__esModule",{value:!0});Ui.WidgetApiToWidgetAction=Ui.WidgetApiFromWidgetAction=void 0;var cL=function(r){return r.SupportedApiVersions="supported_api_versions",r.Capabilities="capabilities",r.NotifyCapabilities="notify_capabilities",r.ThemeChange="theme_change",r.LanguageChange="language_change",r.TakeScreenshot="screenshot",r.UpdateVisibility="visibility",r.OpenIDCredentials="openid_credentials",r.WidgetConfig="widget_config",r.CloseModalWidget="close_modal",r.ButtonClicked="button_clicked",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.UpdateState="update_state",r.UpdateTurnServers="update_turn_servers",r}({});Ui.WidgetApiToWidgetAction=cL;var hL=function(r){return r.SupportedApiVersions="supported_api_versions",r.ContentLoaded="content_loaded",r.SendSticker="m.sticker",r.UpdateAlwaysOnScreen="set_always_on_screen",r.GetOpenIDCredentials="get_openid",r.CloseModalWidget="close_modal",r.OpenModalWidget="open_modal",r.SetModalButtonEnabled="set_button_enabled",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.WatchTurnServers="watch_turn_servers",r.UnwatchTurnServers="unwatch_turn_servers",r.BeeperReadRoomAccountData="com.beeper.read_room_account_data",r.MSC2876ReadEvents="org.matrix.msc2876.read_events",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",r.MSC3869ReadRelations="org.matrix.msc3869.read_relations",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",r.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",r.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});Ui.WidgetApiFromWidgetAction=hL;var po={};Object.defineProperty(po,"__esModule",{value:!0});po.OpenIDRequestState=void 0;var fL=function(r){return r.Allowed="allowed",r.Blocked="blocked",r.PendingUserConfirmation="request",r}({});po.OpenIDRequestState=fL;var yu={};Object.defineProperty(yu,"__esModule",{value:!0});yu.MatrixWidgetType=void 0;var vL=function(r){return r.Custom="m.custom",r.JitsiMeet="m.jitsi",r.Stickerpicker="m.stickerpicker",r}({});yu.MatrixWidgetType=vL;var Su={};Object.defineProperty(Su,"__esModule",{value:!0});Su.BuiltInModalButtonID=void 0;var pL=function(r){return r.Close="m.close",r}({});Su.BuiltInModalButtonID=pL;var bn={};Object.defineProperty(bn,"__esModule",{value:!0});bn.WidgetEventCapability=bn.EventKind=bn.EventDirection=void 0;function Yl(r){"@babel/helpers - typeof";return Yl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yl(r)}o(Yl,"_typeof$2");function mL(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=gL(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(mL,"_createForOfIteratorHelper$1");function gL(r,e){if(r){if(typeof r=="string")return k0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return k0(r,e)}}o(gL,"_unsupportedIterableToArray$1");function k0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(k0,"_arrayLikeToArray$1");function yL(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(yL,"_classCallCheck$1");function P0(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,EL(n.key),n)}}o(P0,"_defineProperties$1");function SL(r,e,t){return e&&P0(r.prototype,e),t&&P0(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}o(SL,"_createClass$1");function EL(r){var e=_L(r,"string");return Yl(e)==="symbol"?e:String(e)}o(EL,"_toPropertyKey$1");function _L(r,e){if(Yl(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Yl(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}o(_L,"_toPrimitive$1");var yr=function(r){return r.Event="event",r.State="state_event",r.ToDevice="to_device",r.RoomAccount="room_account",r}({});bn.EventKind=yr;var li=function(r){return r.Send="send",r.Receive="receive",r}({});bn.EventDirection=li;var bL=function(){function r(e,t,n,i,a){yL(this,r),this.direction=e,this.eventType=t,this.kind=n,this.keyStr=i,this.raw=a}return o(r,"WidgetEventCapability"),SL(r,[{key:"matchesAsStateEvent",value:o(function(t,n,i){return this.kind!==yr.State||this.direction!==t||this.eventType!==n?!1:this.keyStr===null||this.keyStr===i},"matchesAsStateEvent")},{key:"matchesAsToDeviceEvent",value:o(function(t,n){return!(this.kind!==yr.ToDevice||this.direction!==t||this.eventType!==n)},"matchesAsToDeviceEvent")},{key:"matchesAsRoomEvent",value:o(function(t,n){var i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==yr.Event||this.direction!==t||this.eventType!==n)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===i)return!0}else return!0;return!1},"matchesAsRoomEvent")},{key:"matchesAsRoomAccountData",value:o(function(t,n){return!(this.kind!==yr.RoomAccount||this.direction!==t||this.eventType!==n)},"matchesAsRoomAccountData")}],[{key:"forStateEvent",value:o(function(t,n,i){n=n.replace(/#/g,"\\#"),i=i!=null?"#".concat(i):"";var a="org.matrix.msc2762.".concat(t,".state_event:").concat(n).concat(i);return r.findEventCapabilities([a])[0]},"forStateEvent")},{key:"forToDeviceEvent",value:o(function(t,n){var i="org.matrix.msc3819.".concat(t,".to_device:").concat(n);return r.findEventCapabilities([i])[0]},"forToDeviceEvent")},{key:"forRoomEvent",value:o(function(t,n){var i="org.matrix.msc2762.".concat(t,".event:").concat(n);return r.findEventCapabilities([i])[0]},"forRoomEvent")},{key:"forRoomMessageEvent",value:o(function(t,n){n=n??"";var i="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(n);return r.findEventCapabilities([i])[0]},"forRoomMessageEvent")},{key:"forRoomAccountData",value:o(function(t,n){var i="com.beeper.capabilities.".concat(t,".room_account_data:").concat(n);return r.findEventCapabilities([i])[0]},"forRoomAccountData")},{key:"findEventCapabilities",value:o(function(t){var n=[],i=mL(t),a;try{for(i.s();!(a=i.n()).done;){var s=a.value,l=null,u=void 0,d=null;if(s.startsWith("org.matrix.msc2762.send.event:")?(l=li.Send,d=yr.Event,u=s.substring(30)):s.startsWith("org.matrix.msc2762.send.state_event:")?(l=li.Send,d=yr.State,u=s.substring(36)):s.startsWith("org.matrix.msc3819.send.to_device:")?(l=li.Send,d=yr.ToDevice,u=s.substring(34)):s.startsWith("org.matrix.msc2762.receive.event:")?(l=li.Receive,d=yr.Event,u=s.substring(33)):s.startsWith("org.matrix.msc2762.receive.state_event:")?(l=li.Receive,d=yr.State,u=s.substring(39)):s.startsWith("org.matrix.msc3819.receive.to_device:")?(l=li.Receive,d=yr.ToDevice,u=s.substring(37)):s.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(l=li.Receive,d=yr.RoomAccount,u=s.substring(50)),!(l===null||d===null||u===void 0)){var c=u.startsWith("m.room.message#")||d===yr.State,h=null;if(u.includes("#")&&c){var v=u.split("#"),g=v.findIndex(function(p){return!p.endsWith("\\")});u=v.slice(0,g+1).map(function(p){return p.endsWith("\\")?p.substring(0,p.length-1):p}).join("#"),h=v.slice(g+1).join("#")}n.push(new r(l,u,d,h,s))}}}catch(p){i.e(p)}finally{i.f()}return n},"findEventCapabilities")}]),r}();bn.WidgetEventCapability=bL;var mo={};Object.defineProperty(mo,"__esModule",{value:!0});mo.Symbols=void 0;var wL=function(r){return r.AnyRoom="*",r}({});mo.Symbols=wL;var M0;function TL(){if(M0)return qi;M0=1;function r(J){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(ee){return typeof ee}:function(ee){return ee&&typeof Symbol=="function"&&ee.constructor===Symbol&&ee!==Symbol.prototype?"symbol":typeof ee},r(J)}o(r,"_typeof"),Object.defineProperty(qi,"__esModule",{value:!0}),qi.WidgetApiResponseError=qi.WidgetApi=void 0;var e=Ih,t=Oa,n=_n,i=gy(),a=Ui,s=po,l=yu,u=Su,d=bn,c=mo;function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=o(function(){return J},"_regeneratorRuntime");var J={},ee=Object.prototype,N=ee.hasOwnProperty,D=Object.defineProperty||function(he,re,V){he[re]=V.value},A=typeof Symbol=="function"?Symbol:{},x=A.iterator||"@@iterator",P=A.asyncIterator||"@@asyncIterator",U=A.toStringTag||"@@toStringTag";function k(he,re,V){return Object.defineProperty(he,re,{value:V,enumerable:!0,configurable:!0,writable:!0}),he[re]}o(k,"define");try{k({},"")}catch{k=o(function(V,H,Y){return V[H]=Y},"define")}function W(he,re,V,H){var Y=re&&re.prototype instanceof Z?re:Z,ne=Object.create(Y.prototype),Se=new $t(H||[]);return D(ne,"_invoke",{value:le(he,V,Se)}),ne}o(W,"wrap");function L(he,re,V){try{return{type:"normal",arg:he.call(re,V)}}catch(H){return{type:"throw",arg:H}}}o(L,"tryCatch"),J.wrap=W;var K={};function Z(){}o(Z,"Generator");function Q(){}o(Q,"GeneratorFunction");function z(){}o(z,"GeneratorFunctionPrototype");var Te={};k(Te,x,function(){return this});var ce=Object.getPrototypeOf,te=ce&&ce(ce(yt([])));te&&te!==ee&&N.call(te,x)&&(Te=te);var pe=z.prototype=Z.prototype=Object.create(Te);function be(he){["next","throw","return"].forEach(function(re){k(he,re,function(V){return this._invoke(re,V)})})}o(be,"defineIteratorMethods");function _e(he,re){function V(Y,ne,Se,Ee){var Ue=L(he[Y],he,ne);if(Ue.type!=="throw"){var nt=Ue.arg,it=nt.value;return it&&r(it)=="object"&&N.call(it,"__await")?re.resolve(it.__await).then(function(Jt){V("next",Jt,Se,Ee)},function(Jt){V("throw",Jt,Se,Ee)}):re.resolve(it).then(function(Jt){nt.value=Jt,Se(nt)},function(Jt){return V("throw",Jt,Se,Ee)})}Ee(Ue.arg)}o(V,"invoke");var H;D(this,"_invoke",{value:o(function(ne,Se){function Ee(){return new re(function(Ue,nt){V(ne,Se,Ue,nt)})}return o(Ee,"callInvokeWithMethodAndArg"),H=H?H.then(Ee,Ee):Ee()},"value")})}o(_e,"AsyncIterator");function le(he,re,V){var H="suspendedStart";return function(Y,ne){if(H==="executing")throw new Error("Generator is already running");if(H==="completed"){if(Y==="throw")throw ne;return ka()}for(V.method=Y,V.arg=ne;;){var Se=V.delegate;if(Se){var Ee=je(Se,V);if(Ee){if(Ee===K)continue;return Ee}}if(V.method==="next")V.sent=V._sent=V.arg;else if(V.method==="throw"){if(H==="suspendedStart")throw H="completed",V.arg;V.dispatchException(V.arg)}else V.method==="return"&&V.abrupt("return",V.arg);H="executing";var Ue=L(he,re,V);if(Ue.type==="normal"){if(H=V.done?"completed":"suspendedYield",Ue.arg===K)continue;return{value:Ue.arg,done:V.done}}Ue.type==="throw"&&(H="completed",V.method="throw",V.arg=Ue.arg)}}}o(le,"makeInvokeMethod");function je(he,re){var V=re.method,H=he.iterator[V];if(H===void 0)return re.delegate=null,V==="throw"&&he.iterator.return&&(re.method="return",re.arg=void 0,je(he,re),re.method==="throw")||V!=="return"&&(re.method="throw",re.arg=new TypeError("The iterator does not provide a '"+V+"' method")),K;var Y=L(H,he.iterator,re.arg);if(Y.type==="throw")return re.method="throw",re.arg=Y.arg,re.delegate=null,K;var ne=Y.arg;return ne?ne.done?(re[he.resultName]=ne.value,re.next=he.nextLoc,re.method!=="return"&&(re.method="next",re.arg=void 0),re.delegate=null,K):ne:(re.method="throw",re.arg=new TypeError("iterator result is not an object"),re.delegate=null,K)}o(je,"maybeInvokeDelegate");function rn(he){var re={tryLoc:he[0]};1 in he&&(re.catchLoc=he[1]),2 in he&&(re.finallyLoc=he[2],re.afterLoc=he[3]),this.tryEntries.push(re)}o(rn,"pushTryEntry");function Zn(he){var re=he.completion||{};re.type="normal",delete re.arg,he.completion=re}o(Zn,"resetTryEntry");function $t(he){this.tryEntries=[{tryLoc:"root"}],he.forEach(rn,this),this.reset(!0)}o($t,"Context");function yt(he){if(he){var re=he[x];if(re)return re.call(he);if(typeof he.next=="function")return he;if(!isNaN(he.length)){var V=-1,H=o(function Y(){for(;++V<he.length;)if(N.call(he,V))return Y.value=he[V],Y.done=!1,Y;return Y.value=void 0,Y.done=!0,Y},"next");return H.next=H}}return{next:ka}}o(yt,"values");function ka(){return{value:void 0,done:!0}}return o(ka,"doneResult"),Q.prototype=z,D(pe,"constructor",{value:z,configurable:!0}),D(z,"constructor",{value:Q,configurable:!0}),Q.displayName=k(z,U,"GeneratorFunction"),J.isGeneratorFunction=function(he){var re=typeof he=="function"&&he.constructor;return!!re&&(re===Q||(re.displayName||re.name)==="GeneratorFunction")},J.mark=function(he){return Object.setPrototypeOf?Object.setPrototypeOf(he,z):(he.__proto__=z,k(he,U,"GeneratorFunction")),he.prototype=Object.create(pe),he},J.awrap=function(he){return{__await:he}},be(_e.prototype),k(_e.prototype,P,function(){return this}),J.AsyncIterator=_e,J.async=function(he,re,V,H,Y){Y===void 0&&(Y=Promise);var ne=new _e(W(he,re,V,H),Y);return J.isGeneratorFunction(re)?ne:ne.next().then(function(Se){return Se.done?Se.value:ne.next()})},be(pe),k(pe,U,"Generator"),k(pe,x,function(){return this}),k(pe,"toString",function(){return"[object Generator]"}),J.keys=function(he){var re=Object(he),V=[];for(var H in re)V.push(H);return V.reverse(),o(function Y(){for(;V.length;){var ne=V.pop();if(ne in re)return Y.value=ne,Y.done=!1,Y}return Y.done=!0,Y},"next")},J.values=yt,$t.prototype={constructor:$t,reset:o(function(re){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Zn),!re)for(var V in this)V.charAt(0)==="t"&&N.call(this,V)&&!isNaN(+V.slice(1))&&(this[V]=void 0)},"reset"),stop:o(function(){this.done=!0;var re=this.tryEntries[0].completion;if(re.type==="throw")throw re.arg;return this.rval},"stop"),dispatchException:o(function(re){if(this.done)throw re;var V=this;function H(nt,it){return Se.type="throw",Se.arg=re,V.next=nt,it&&(V.method="next",V.arg=void 0),!!it}o(H,"handle");for(var Y=this.tryEntries.length-1;Y>=0;--Y){var ne=this.tryEntries[Y],Se=ne.completion;if(ne.tryLoc==="root")return H("end");if(ne.tryLoc<=this.prev){var Ee=N.call(ne,"catchLoc"),Ue=N.call(ne,"finallyLoc");if(Ee&&Ue){if(this.prev<ne.catchLoc)return H(ne.catchLoc,!0);if(this.prev<ne.finallyLoc)return H(ne.finallyLoc)}else if(Ee){if(this.prev<ne.catchLoc)return H(ne.catchLoc,!0)}else{if(!Ue)throw new Error("try statement without catch or finally");if(this.prev<ne.finallyLoc)return H(ne.finallyLoc)}}}},"dispatchException"),abrupt:o(function(re,V){for(var H=this.tryEntries.length-1;H>=0;--H){var Y=this.tryEntries[H];if(Y.tryLoc<=this.prev&&N.call(Y,"finallyLoc")&&this.prev<Y.finallyLoc){var ne=Y;break}}ne&&(re==="break"||re==="continue")&&ne.tryLoc<=V&&V<=ne.finallyLoc&&(ne=null);var Se=ne?ne.completion:{};return Se.type=re,Se.arg=V,ne?(this.method="next",this.next=ne.finallyLoc,K):this.complete(Se)},"abrupt"),complete:o(function(re,V){if(re.type==="throw")throw re.arg;return re.type==="break"||re.type==="continue"?this.next=re.arg:re.type==="return"?(this.rval=this.arg=re.arg,this.method="return",this.next="end"):re.type==="normal"&&V&&(this.next=V),K},"complete"),finish:o(function(re){for(var V=this.tryEntries.length-1;V>=0;--V){var H=this.tryEntries[V];if(H.finallyLoc===re)return this.complete(H.completion,H.afterLoc),Zn(H),K}},"finish"),catch:o(function(re){for(var V=this.tryEntries.length-1;V>=0;--V){var H=this.tryEntries[V];if(H.tryLoc===re){var Y=H.completion;if(Y.type==="throw"){var ne=Y.arg;Zn(H)}return ne}}throw new Error("illegal catch attempt")},"_catch"),delegateYield:o(function(re,V,H){return this.delegate={iterator:yt(re),resultName:V,nextLoc:H},this.method==="next"&&(this.arg=void 0),K},"delegateYield")},J}o(h,"_regeneratorRuntime");function v(J,ee,N,D,A,x,P){try{var U=J[x](P),k=U.value}catch(W){N(W);return}U.done?ee(k):Promise.resolve(k).then(D,A)}o(v,"asyncGeneratorStep");function g(J){return function(){var ee=this,N=arguments;return new Promise(function(D,A){var x=J.apply(ee,N);function P(k){v(x,D,A,P,U,"next",k)}o(P,"_next");function U(k){v(x,D,A,P,U,"throw",k)}o(U,"_throw"),P(void 0)})}}o(g,"_asyncToGenerator");function p(J,ee){var N=Object.keys(J);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(J);ee&&(D=D.filter(function(A){return Object.getOwnPropertyDescriptor(J,A).enumerable})),N.push.apply(N,D)}return N}o(p,"ownKeys");function m(J){for(var ee=1;ee<arguments.length;ee++){var N=arguments[ee]!=null?arguments[ee]:{};ee%2?p(Object(N),!0).forEach(function(D){w(J,D,N[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(J,Object.getOwnPropertyDescriptors(N)):p(Object(N)).forEach(function(D){Object.defineProperty(J,D,Object.getOwnPropertyDescriptor(N,D))})}return J}o(m,"_objectSpread");function w(J,ee,N){return ee=T(ee),ee in J?Object.defineProperty(J,ee,{value:N,enumerable:!0,configurable:!0,writable:!0}):J[ee]=N,J}o(w,"_defineProperty");function y(J,ee){for(var N=0;N<ee.length;N++){var D=ee[N];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(J,T(D.key),D)}}o(y,"_defineProperties");function S(J,ee,N){return ee&&y(J.prototype,ee),Object.defineProperty(J,"prototype",{writable:!1}),J}o(S,"_createClass");function T(J){var ee=C(J,"string");return r(ee)==="symbol"?ee:String(ee)}o(T,"_toPropertyKey");function C(J,ee){if(r(J)!=="object"||J===null)return J;var N=J[Symbol.toPrimitive];if(N!==void 0){var D=N.call(J,ee);if(r(D)!=="object")return D;throw new TypeError("@@toPrimitive must return a primitive value.")}return(ee==="string"?String:Number)(J)}o(C,"_toPrimitive");function M(J,ee){if(!(J instanceof ee))throw new TypeError("Cannot call a class as a function")}o(M,"_classCallCheck");function _(J,ee){if(typeof ee!="function"&&ee!==null)throw new TypeError("Super expression must either be null or a function");J.prototype=Object.create(ee&&ee.prototype,{constructor:{value:J,writable:!0,configurable:!0}}),Object.defineProperty(J,"prototype",{writable:!1}),ee&&Ne(J,ee)}o(_,"_inherits");function O(J){var ee=oe();return o(function(){var D=Oe(J),A;if(ee){var x=Oe(this).constructor;A=Reflect.construct(D,arguments,x)}else A=D.apply(this,arguments);return b(this,A)},"_createSuperInternal")}o(O,"_createSuper");function b(J,ee){if(ee&&(r(ee)==="object"||typeof ee=="function"))return ee;if(ee!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return j(J)}o(b,"_possibleConstructorReturn");function j(J){if(J===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return J}o(j,"_assertThisInitialized");function B(J){var ee=typeof Map=="function"?new Map:void 0;return B=o(function(D){if(D===null||!de(D))return D;if(typeof D!="function")throw new TypeError("Super expression must either be null or a function");if(typeof ee<"u"){if(ee.has(D))return ee.get(D);ee.set(D,A)}function A(){return q(D,arguments,Oe(this).constructor)}return o(A,"Wrapper"),A.prototype=Object.create(D.prototype,{constructor:{value:A,enumerable:!1,writable:!0,configurable:!0}}),Ne(A,D)},"_wrapNativeSuper"),B(J)}o(B,"_wrapNativeSuper");function q(J,ee,N){return oe()?q=Reflect.construct.bind():q=o(function(A,x,P){var U=[null];U.push.apply(U,x);var k=Function.bind.apply(A,U),W=new k;return P&&Ne(W,P.prototype),W},"_construct"),q.apply(null,arguments)}o(q,"_construct");function oe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(oe,"_isNativeReflectConstruct");function de(J){return Function.toString.call(J).indexOf("[native code]")!==-1}o(de,"_isNativeFunction");function Ne(J,ee){return Ne=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(D,A){return D.__proto__=A,D},"_setPrototypeOf"),Ne(J,ee)}o(Ne,"_setPrototypeOf");function Oe(J){return Oe=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(N){return N.__proto__||Object.getPrototypeOf(N)},"_getPrototypeOf"),Oe(J)}o(Oe,"_getPrototypeOf");function Ae(J){return new ue(J,0)}o(Ae,"_awaitAsyncGenerator");function ae(J){return function(){return new X(J.apply(this,arguments))}}o(ae,"_wrapAsyncGenerator");function X(J){var ee,N;function D(x,P){try{var U=J[x](P),k=U.value,W=k instanceof ue;Promise.resolve(W?k.v:k).then(function(L){if(W){var K=x==="return"?"return":"next";if(!k.k||L.done)return D(K,L);L=J[K](L).value}A(U.done?"return":"normal",L)},function(L){D("throw",L)})}catch(L){A("throw",L)}}o(D,"resume");function A(x,P){switch(x){case"return":ee.resolve({value:P,done:!0});break;case"throw":ee.reject(P);break;default:ee.resolve({value:P,done:!1})}(ee=ee.next)?D(ee.key,ee.arg):N=null}o(A,"settle"),this._invoke=function(x,P){return new Promise(function(U,k){var W={key:x,arg:P,resolve:U,reject:k,next:null};N?N=N.next=W:(ee=N=W,D(x,P))})},typeof J.return!="function"&&(this.return=void 0)}o(X,"_AsyncGenerator"),X.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},X.prototype.next=function(J){return this._invoke("next",J)},X.prototype.throw=function(J){return this._invoke("throw",J)},X.prototype.return=function(J){return this._invoke("return",J)};function ue(J,ee){this.v=J,this.k=ee}o(ue,"_OverloadYield");var ge=function(J){_(N,J);var ee=O(N);function N(D,A){var x;return M(this,N),x=ee.call(this,D),x.data=A,x}return o(N,"WidgetApiResponseError"),S(N)}(B(Error));qi.WidgetApiResponseError=ge,ge.prototype.name=ge.name;var Ce=function(J){_(N,J);var ee=O(N);function N(){var D,A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,x=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(M(this,N),D=ee.call(this),D.clientOrigin=x,w(j(D),"transport",void 0),w(j(D),"capabilitiesFinished",!1),w(j(D),"supportsMSC2974Renegotiate",!1),w(j(D),"requestedCapabilities",[]),w(j(D),"approvedCapabilities",void 0),w(j(D),"cachedClientVersions",void 0),w(j(D),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return D.transport=new i.PostmessageTransport(t.WidgetApiDirection.FromWidget,A,window.parent,window),D.transport.targetOrigin=x,D.transport.on("message",D.handleMessage.bind(j(D))),D}return o(N,"WidgetApi"),S(N,[{key:"hasCapability",value:o(function(A){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(A):this.requestedCapabilities.includes(A)},"hasCapability")},{key:"requestCapability",value:o(function(A){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(A)},"requestCapability")},{key:"requestCapabilities",value:o(function(A){var x=this;A.forEach(function(P){return x.requestCapability(P)})},"requestCapabilities")},{key:"requestCapabilityForRoomTimeline",value:o(function(A){this.requestCapability("org.matrix.msc2762.timeline:".concat(A))},"requestCapabilityForRoomTimeline")},{key:"requestCapabilityToSendState",value:o(function(A,x){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Send,A,x).raw)},"requestCapabilityToSendState")},{key:"requestCapabilityToReceiveState",value:o(function(A,x){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Receive,A,x).raw)},"requestCapabilityToReceiveState")},{key:"requestCapabilityToSendToDevice",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Send,A).raw)},"requestCapabilityToSendToDevice")},{key:"requestCapabilityToReceiveToDevice",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Receive,A).raw)},"requestCapabilityToReceiveToDevice")},{key:"requestCapabilityToSendEvent",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Send,A).raw)},"requestCapabilityToSendEvent")},{key:"requestCapabilityToReceiveEvent",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Receive,A).raw)},"requestCapabilityToReceiveEvent")},{key:"requestCapabilityToSendMessage",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Send,A).raw)},"requestCapabilityToSendMessage")},{key:"requestCapabilityToReceiveMessage",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Receive,A).raw)},"requestCapabilityToReceiveMessage")},{key:"requestCapabilityToReceiveRoomAccountData",value:o(function(A){this.requestCapability(d.WidgetEventCapability.forRoomAccountData(d.EventDirection.Receive,A).raw)},"requestCapabilityToReceiveRoomAccountData")},{key:"requestOpenIDConnectToken",value:o(function(){var A=this;return new Promise(function(x,P){A.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(U){var k=U.response;if(k.state===s.OpenIDRequestState.Allowed)x(k);else if(k.state===s.OpenIDRequestState.Blocked)P(new Error("User declined to verify their identity"));else if(k.state===s.OpenIDRequestState.PendingUserConfirmation){var W=o(function L(K){K.preventDefault();var Z=K.detail;Z.data.original_request_id===U.requestId&&(Z.data.state===s.OpenIDRequestState.Allowed?(x(Z.data),A.transport.reply(Z,{})):Z.data.state===s.OpenIDRequestState.Blocked?(P(new Error("User declined to verify their identity")),A.transport.reply(Z,{})):(P(new Error("Invalid state on reply: "+k.state)),A.transport.reply(Z,{error:{message:"Invalid state"}})),A.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),L))},"handlerFn");A.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),W)}else P(new Error("Invalid state: "+k.state))}).catch(P)})},"requestOpenIDConnectToken")},{key:"updateRequestedCapabilities",value:o(function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()},"updateRequestedCapabilities")},{key:"sendContentLoaded",value:o(function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()},"sendContentLoaded")},{key:"sendSticker",value:o(function(A){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,A).then()},"sendSticker")},{key:"setAlwaysOnScreen",value:o(function(A){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:A}).then(function(x){return x.success})},"setAlwaysOnScreen")},{key:"openModalWidget",value:o(function(A,x){var P=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],U=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},k=arguments.length>4&&arguments[4]!==void 0?arguments[4]:l.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:k,url:A,name:x,buttons:P,data:U}).then()},"openModalWidget")},{key:"closeModalWidget",value:o(function(){var A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,A).then()},"closeModalWidget")},{key:"sendRoomEvent",value:o(function(A,x,P,U,k){return this.sendEvent(A,void 0,x,P,U,k)},"sendRoomEvent")},{key:"sendStateEvent",value:o(function(A,x,P,U,k,W){return this.sendEvent(A,x,P,U,k,W)},"sendStateEvent")},{key:"sendEvent",value:o(function(A,x,P,U,k,W){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,m(m(m(m({type:A,content:P},x!==void 0&&{state_key:x}),U!==void 0&&{room_id:U}),k!==void 0&&{delay:k}),W!==void 0&&{parent_delay_id:W}))},"sendEvent")},{key:"updateDelayedEvent",value:o(function(A,x){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:A,action:x})},"updateDelayedEvent")},{key:"sendToDevice",value:o(function(A,x,P){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:A,encrypted:x,messages:P})},"sendToDevice")},{key:"readRoomAccountData",value:o(function(A,x){var P={type:A};return x&&(x.includes(c.Symbols.AnyRoom)?P.room_ids=c.Symbols.AnyRoom:P.room_ids=x),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,P).then(function(U){return U.events})},"readRoomAccountData")},{key:"readRoomEvents",value:o(function(A,x,P,U,k){var W={type:A,msgtype:P};return x!==void 0&&(W.limit=x),U&&(U.includes(c.Symbols.AnyRoom)?W.room_ids=c.Symbols.AnyRoom:W.room_ids=U),k&&(W.since=k),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,W).then(function(L){return L.events})},"readRoomEvents")},{key:"readEventRelations",value:function(){var D=g(h().mark(o(function x(P,U,k,W,L,K,Z,Q){var z,Te;return h().wrap(o(function(te){for(;;)switch(te.prev=te.next){case 0:return te.next=2,this.getClientVersions();case 2:if(z=te.sent,z.includes(n.UnstableApiVersion.MSC3869)){te.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return Te={event_id:P,rel_type:k,event_type:W,room_id:U,to:Z,from:K,limit:L,direction:Q},te.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,Te));case 7:case"end":return te.stop()}},"_callee$"),x,this)},"_callee")));function A(x,P,U,k,W,L,K,Z){return D.apply(this,arguments)}return o(A,"readEventRelations"),A}()},{key:"readStateEvents",value:o(function(A,x,P,U){var k={type:A,state_key:P===void 0?!0:P};return x!==void 0&&(k.limit=x),U&&(U.includes(c.Symbols.AnyRoom)?k.room_ids=c.Symbols.AnyRoom:k.room_ids=U),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,k).then(function(W){return W.events})},"readStateEvents")},{key:"setModalButtonEnabled",value:o(function(A,x){if(A===u.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:A,enabled:x}).then()},"setModalButtonEnabled")},{key:"navigateTo",value:o(function(A){if(!A||!A.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:A}).then()},"navigateTo")},{key:"getTurnServers",value:o(function(){var A=this;return ae(h().mark(o(function x(){var P,U;return h().wrap(o(function(W){for(;;)switch(W.prev=W.next){case 0:if(U=function(){var L=g(h().mark(o(function K(Z){return h().wrap(o(function(z){for(;;)switch(z.prev=z.next){case 0:return Z.preventDefault(),P(Z.detail.data),z.next=4,A.transport.reply(Z.detail,{});case 4:case"end":return z.stop()}},"_callee2$"),K)},"_callee2")));return o(function(Z){return L.apply(this,arguments)},"onUpdateTurnServers")}(),A.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),A.turnServerWatchers!==0){W.next=12;break}return W.prev=3,W.next=6,Ae(A.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:W.next=12;break;case 8:throw W.prev=8,W.t0=W.catch(3),A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),W.t0;case 12:A.turnServerWatchers++,W.prev=13;case 14:return W.next=17,Ae(new Promise(function(L){return P=L}));case 17:return W.next=19,W.sent;case 19:W.next=14;break;case 21:if(W.prev=21,A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),U),A.turnServerWatchers--,A.turnServerWatchers!==0){W.next=27;break}return W.next=27,Ae(A.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return W.finish(21);case 28:case"end":return W.stop()}},"_callee3$"),x,null,[[3,8],[13,,21,28]])},"_callee3")))()},"getTurnServers")},{key:"searchUserDirectory",value:function(){var D=g(h().mark(o(function x(P,U){var k,W;return h().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:return K.next=2,this.getClientVersions();case 2:if(k=K.sent,k.includes(n.UnstableApiVersion.MSC3973)){K.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return W={search_term:P,limit:U},K.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,W));case 7:case"end":return K.stop()}},"_callee4$"),x,this)},"_callee4")));function A(x,P){return D.apply(this,arguments)}return o(A,"searchUserDirectory"),A}()},{key:"getMediaConfig",value:function(){var D=g(h().mark(o(function x(){var P,U;return h().wrap(o(function(W){for(;;)switch(W.prev=W.next){case 0:return W.next=2,this.getClientVersions();case 2:if(P=W.sent,P.includes(n.UnstableApiVersion.MSC4039)){W.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return U={},W.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,U));case 7:case"end":return W.stop()}},"_callee5$"),x,this)},"_callee5")));function A(){return D.apply(this,arguments)}return o(A,"getMediaConfig"),A}()},{key:"uploadFile",value:function(){var D=g(h().mark(o(function x(P){var U,k;return h().wrap(o(function(L){for(;;)switch(L.prev=L.next){case 0:return L.next=2,this.getClientVersions();case 2:if(U=L.sent,U.includes(n.UnstableApiVersion.MSC4039)){L.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return k={file:P},L.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,k));case 7:case"end":return L.stop()}},"_callee6$"),x,this)},"_callee6")));function A(x){return D.apply(this,arguments)}return o(A,"uploadFile"),A}()},{key:"downloadFile",value:function(){var D=g(h().mark(o(function x(P){var U,k;return h().wrap(o(function(L){for(;;)switch(L.prev=L.next){case 0:return L.next=2,this.getClientVersions();case 2:if(U=L.sent,U.includes(n.UnstableApiVersion.MSC4039)){L.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return k={content_uri:P},L.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,k));case 7:case"end":return L.stop()}},"_callee7$"),x,this)},"_callee7")));function A(x){return D.apply(this,arguments)}return o(A,"downloadFile"),A}()},{key:"start",value:o(function(){var A=this;this.transport.start(),this.getClientVersions().then(function(x){x.includes(n.UnstableApiVersion.MSC2974)&&(A.supportsMSC2974Renegotiate=!0)})},"start")},{key:"handleMessage",value:o(function(A){var x=new CustomEvent("action:".concat(A.detail.action),{detail:A.detail,cancelable:!0});if(this.emit("action:".concat(A.detail.action),x),!x.defaultPrevented)switch(A.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(A.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(A.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(A.detail,{});case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(A.detail,{});default:return this.transport.reply(A.detail,{error:{message:"Unknown or unsupported action: "+A.detail.action}})}},"handleMessage")},{key:"replyVersions",value:o(function(A){this.transport.reply(A,{supported_versions:n.CurrentApiVersions})},"replyVersions")},{key:"getClientVersions",value:o(function(){var A=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(x){return A.cachedClientVersions=x.supported_versions,x.supported_versions}).catch(function(x){return console.warn("non-fatal error getting supported client versions: ",x),[]})},"getClientVersions")},{key:"handleCapabilities",value:o(function(A){var x=this;return this.capabilitiesFinished?this.transport.reply(A,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(P){return P.includes(n.UnstableApiVersion.MSC2871)?x.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(U){x.approvedCapabilities=U.detail.data.approved,x.emit("ready")}):x.emit("ready"),x.capabilitiesFinished=!0,x.transport.reply(A,{capabilities:x.requestedCapabilities})})},"handleCapabilities")}]),N}(e.EventEmitter);return qi.WidgetApi=Ce,qi}o(TL,"requireWidgetApi");var xo={},Lr={};Object.defineProperty(Lr,"__esModule",{value:!0});Lr.VideoConferenceCapabilities=Lr.StickerpickerCapabilities=Lr.MatrixCapabilities=void 0;Lr.getTimelineRoomIDFromCapability=kL;Lr.isTimelineCapability=CL;Lr.isTimelineCapabilityFor=OL;var yy=function(r){return r.Screenshots="m.capability.screenshot",r.StickerSending="m.sticker",r.AlwaysOnScreen="m.always_on_screen",r.RequiresClient="io.element.requires_client",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC3846TurnServers="town.robin.msc3846.turn_servers",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039UploadFile="org.matrix.msc4039.upload_file",r.MSC4039DownloadFile="org.matrix.msc4039.download_file",r.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",r.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",r}({});Lr.MatrixCapabilities=yy;var RL=[yy.StickerSending];Lr.StickerpickerCapabilities=RL;var IL=[yy.AlwaysOnScreen];Lr.VideoConferenceCapabilities=IL;function CL(r){return r==null?void 0:r.startsWith("org.matrix.msc2762.timeline:")}o(CL,"isTimelineCapability");function OL(r,e){return r==="org.matrix.msc2762.timeline:".concat(e)}o(OL,"isTimelineCapabilityFor");function kL(r){return r.substring(r.indexOf(":")+1)}o(kL,"getTimelineRoomIDFromCapability");var Eu={};Object.defineProperty(Eu,"__esModule",{value:!0});Eu.SimpleObservable=void 0;function Xl(r){"@babel/helpers - typeof";return Xl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Xl(r)}o(Xl,"_typeof$1");function PL(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=ML(r))||e){t&&(r=t);var n=0,i=o(function(){},"F");return{s:i,n:o(function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},"n"),e:o(function(d){throw d},"e"),f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,l;return{s:o(function(){t=t.call(r)},"s"),n:o(function(){var d=t.next();return a=d.done,d},"n"),e:o(function(d){s=!0,l=d},"e"),f:o(function(){try{!a&&t.return!=null&&t.return()}finally{if(s)throw l}},"f")}}o(PL,"_createForOfIteratorHelper");function ML(r,e){if(r){if(typeof r=="string")return A0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return A0(r,e)}}o(ML,"_unsupportedIterableToArray");function A0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}o(A0,"_arrayLikeToArray");function AL(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}o(AL,"_classCallCheck");function xL(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,YI(n.key),n)}}o(xL,"_defineProperties");function DL(r,e,t){return e&&xL(r.prototype,e),Object.defineProperty(r,"prototype",{writable:!1}),r}o(DL,"_createClass");function NL(r,e,t){return e=YI(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}o(NL,"_defineProperty");function YI(r){var e=LL(r,"string");return Xl(e)==="symbol"?e:String(e)}o(YI,"_toPropertyKey");function LL(r,e){if(Xl(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(Xl(n)!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}o(LL,"_toPrimitive");var UL=function(){function r(e){AL(this,r),NL(this,"listeners",[]),e&&this.listeners.push(e)}return o(r,"SimpleObservable"),DL(r,[{key:"onUpdate",value:o(function(t){this.listeners.push(t)},"onUpdate")},{key:"update",value:o(function(t){var n=PL(this.listeners),i;try{for(n.s();!(i=n.n()).done;){var a=i.value;a(t)}}catch(s){n.e(s)}finally{n.f()}},"update")},{key:"close",value:o(function(){this.listeners=[]},"close")}]),r}();Eu.SimpleObservable=UL;var _u={};Object.defineProperty(_u,"__esModule",{value:!0});_u.UpdateDelayedEventAction=void 0;var jL=function(r){return r.Cancel="cancel",r.Restart="restart",r.Send="send",r}({});_u.UpdateDelayedEventAction=jL;var x0;function FL(){if(x0)return xo;x0=1,Object.defineProperty(xo,"__esModule",{value:!0}),xo.ClientWidgetApi=void 0;var r=Ih,e=gy(),t=Oa,n=Ui,i=Lr,a=_n,s=bn,l=po,u=Eu,d=mo,c=_u;function h(N){"@babel/helpers - typeof";return h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},h(N)}o(h,"_typeof");function v(N,D){var A=Object.keys(N);if(Object.getOwnPropertySymbols){var x=Object.getOwnPropertySymbols(N);D&&(x=x.filter(function(P){return Object.getOwnPropertyDescriptor(N,P).enumerable})),A.push.apply(A,x)}return A}o(v,"ownKeys");function g(N){for(var D=1;D<arguments.length;D++){var A=arguments[D]!=null?arguments[D]:{};D%2?v(Object(A),!0).forEach(function(x){X(N,x,A[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(N,Object.getOwnPropertyDescriptors(A)):v(Object(A)).forEach(function(x){Object.defineProperty(N,x,Object.getOwnPropertyDescriptor(A,x))})}return N}o(g,"_objectSpread");function p(N,D){var A=typeof Symbol<"u"&&N[Symbol.iterator]||N["@@iterator"];if(!A){if(Array.isArray(N)||(A=y(N))||D){A&&(N=A);var x=0,P=o(function(){},"F");return{s:P,n:o(function(){return x>=N.length?{done:!0}:{done:!1,value:N[x++]}},"n"),e:o(function(K){throw K},"e"),f:P}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var U=!0,k=!1,W;return{s:o(function(){A=A.call(N)},"s"),n:o(function(){var K=A.next();return U=K.done,K},"n"),e:o(function(K){k=!0,W=K},"e"),f:o(function(){try{!U&&A.return!=null&&A.return()}finally{if(k)throw W}},"f")}}o(p,"_createForOfIteratorHelper");function m(N){return T(N)||S(N)||y(N)||w()}o(m,"_toConsumableArray");function w(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}o(w,"_nonIterableSpread");function y(N,D){if(N){if(typeof N=="string")return C(N,D);var A=Object.prototype.toString.call(N).slice(8,-1);if(A==="Object"&&N.constructor&&(A=N.constructor.name),A==="Map"||A==="Set")return Array.from(N);if(A==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(A))return C(N,D)}}o(y,"_unsupportedIterableToArray");function S(N){if(typeof Symbol<"u"&&N[Symbol.iterator]!=null||N["@@iterator"]!=null)return Array.from(N)}o(S,"_iterableToArray");function T(N){if(Array.isArray(N))return C(N)}o(T,"_arrayWithoutHoles");function C(N,D){(D==null||D>N.length)&&(D=N.length);for(var A=0,x=new Array(D);A<D;A++)x[A]=N[A];return x}o(C,"_arrayLikeToArray");function M(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */M=o(function(){return N},"_regeneratorRuntime");var N={},D=Object.prototype,A=D.hasOwnProperty,x=Object.defineProperty||function(V,H,Y){V[H]=Y.value},P=typeof Symbol=="function"?Symbol:{},U=P.iterator||"@@iterator",k=P.asyncIterator||"@@asyncIterator",W=P.toStringTag||"@@toStringTag";function L(V,H,Y){return Object.defineProperty(V,H,{value:Y,enumerable:!0,configurable:!0,writable:!0}),V[H]}o(L,"define");try{L({},"")}catch{L=o(function(Y,ne,Se){return Y[ne]=Se},"define")}function K(V,H,Y,ne){var Se=H&&H.prototype instanceof z?H:z,Ee=Object.create(Se.prototype),Ue=new ka(ne||[]);return x(Ee,"_invoke",{value:rn(V,Y,Ue)}),Ee}o(K,"wrap");function Z(V,H,Y){try{return{type:"normal",arg:V.call(H,Y)}}catch(ne){return{type:"throw",arg:ne}}}o(Z,"tryCatch"),N.wrap=K;var Q={};function z(){}o(z,"Generator");function Te(){}o(Te,"GeneratorFunction");function ce(){}o(ce,"GeneratorFunctionPrototype");var te={};L(te,U,function(){return this});var pe=Object.getPrototypeOf,be=pe&&pe(pe(he([])));be&&be!==D&&A.call(be,U)&&(te=be);var _e=ce.prototype=z.prototype=Object.create(te);function le(V){["next","throw","return"].forEach(function(H){L(V,H,function(Y){return this._invoke(H,Y)})})}o(le,"defineIteratorMethods");function je(V,H){function Y(Se,Ee,Ue,nt){var it=Z(V[Se],V,Ee);if(it.type!=="throw"){var Jt=it.arg,ei=Jt.value;return ei&&h(ei)=="object"&&A.call(ei,"__await")?H.resolve(ei.__await).then(function(Ki){Y("next",Ki,Ue,nt)},function(Ki){Y("throw",Ki,Ue,nt)}):H.resolve(ei).then(function(Ki){Jt.value=Ki,Ue(Jt)},function(Ki){return Y("throw",Ki,Ue,nt)})}nt(it.arg)}o(Y,"invoke");var ne;x(this,"_invoke",{value:o(function(Ee,Ue){function nt(){return new H(function(it,Jt){Y(Ee,Ue,it,Jt)})}return o(nt,"callInvokeWithMethodAndArg"),ne=ne?ne.then(nt,nt):nt()},"value")})}o(je,"AsyncIterator");function rn(V,H,Y){var ne="suspendedStart";return function(Se,Ee){if(ne==="executing")throw new Error("Generator is already running");if(ne==="completed"){if(Se==="throw")throw Ee;return re()}for(Y.method=Se,Y.arg=Ee;;){var Ue=Y.delegate;if(Ue){var nt=Zn(Ue,Y);if(nt){if(nt===Q)continue;return nt}}if(Y.method==="next")Y.sent=Y._sent=Y.arg;else if(Y.method==="throw"){if(ne==="suspendedStart")throw ne="completed",Y.arg;Y.dispatchException(Y.arg)}else Y.method==="return"&&Y.abrupt("return",Y.arg);ne="executing";var it=Z(V,H,Y);if(it.type==="normal"){if(ne=Y.done?"completed":"suspendedYield",it.arg===Q)continue;return{value:it.arg,done:Y.done}}it.type==="throw"&&(ne="completed",Y.method="throw",Y.arg=it.arg)}}}o(rn,"makeInvokeMethod");function Zn(V,H){var Y=H.method,ne=V.iterator[Y];if(ne===void 0)return H.delegate=null,Y==="throw"&&V.iterator.return&&(H.method="return",H.arg=void 0,Zn(V,H),H.method==="throw")||Y!=="return"&&(H.method="throw",H.arg=new TypeError("The iterator does not provide a '"+Y+"' method")),Q;var Se=Z(ne,V.iterator,H.arg);if(Se.type==="throw")return H.method="throw",H.arg=Se.arg,H.delegate=null,Q;var Ee=Se.arg;return Ee?Ee.done?(H[V.resultName]=Ee.value,H.next=V.nextLoc,H.method!=="return"&&(H.method="next",H.arg=void 0),H.delegate=null,Q):Ee:(H.method="throw",H.arg=new TypeError("iterator result is not an object"),H.delegate=null,Q)}o(Zn,"maybeInvokeDelegate");function $t(V){var H={tryLoc:V[0]};1 in V&&(H.catchLoc=V[1]),2 in V&&(H.finallyLoc=V[2],H.afterLoc=V[3]),this.tryEntries.push(H)}o($t,"pushTryEntry");function yt(V){var H=V.completion||{};H.type="normal",delete H.arg,V.completion=H}o(yt,"resetTryEntry");function ka(V){this.tryEntries=[{tryLoc:"root"}],V.forEach($t,this),this.reset(!0)}o(ka,"Context");function he(V){if(V){var H=V[U];if(H)return H.call(V);if(typeof V.next=="function")return V;if(!isNaN(V.length)){var Y=-1,ne=o(function Se(){for(;++Y<V.length;)if(A.call(V,Y))return Se.value=V[Y],Se.done=!1,Se;return Se.value=void 0,Se.done=!0,Se},"next");return ne.next=ne}}return{next:re}}o(he,"values");function re(){return{value:void 0,done:!0}}return o(re,"doneResult"),Te.prototype=ce,x(_e,"constructor",{value:ce,configurable:!0}),x(ce,"constructor",{value:Te,configurable:!0}),Te.displayName=L(ce,W,"GeneratorFunction"),N.isGeneratorFunction=function(V){var H=typeof V=="function"&&V.constructor;return!!H&&(H===Te||(H.displayName||H.name)==="GeneratorFunction")},N.mark=function(V){return Object.setPrototypeOf?Object.setPrototypeOf(V,ce):(V.__proto__=ce,L(V,W,"GeneratorFunction")),V.prototype=Object.create(_e),V},N.awrap=function(V){return{__await:V}},le(je.prototype),L(je.prototype,k,function(){return this}),N.AsyncIterator=je,N.async=function(V,H,Y,ne,Se){Se===void 0&&(Se=Promise);var Ee=new je(K(V,H,Y,ne),Se);return N.isGeneratorFunction(H)?Ee:Ee.next().then(function(Ue){return Ue.done?Ue.value:Ee.next()})},le(_e),L(_e,W,"Generator"),L(_e,U,function(){return this}),L(_e,"toString",function(){return"[object Generator]"}),N.keys=function(V){var H=Object(V),Y=[];for(var ne in H)Y.push(ne);return Y.reverse(),o(function Se(){for(;Y.length;){var Ee=Y.pop();if(Ee in H)return Se.value=Ee,Se.done=!1,Se}return Se.done=!0,Se},"next")},N.values=he,ka.prototype={constructor:ka,reset:o(function(H){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(yt),!H)for(var Y in this)Y.charAt(0)==="t"&&A.call(this,Y)&&!isNaN(+Y.slice(1))&&(this[Y]=void 0)},"reset"),stop:o(function(){this.done=!0;var H=this.tryEntries[0].completion;if(H.type==="throw")throw H.arg;return this.rval},"stop"),dispatchException:o(function(H){if(this.done)throw H;var Y=this;function ne(Jt,ei){return Ue.type="throw",Ue.arg=H,Y.next=Jt,ei&&(Y.method="next",Y.arg=void 0),!!ei}o(ne,"handle");for(var Se=this.tryEntries.length-1;Se>=0;--Se){var Ee=this.tryEntries[Se],Ue=Ee.completion;if(Ee.tryLoc==="root")return ne("end");if(Ee.tryLoc<=this.prev){var nt=A.call(Ee,"catchLoc"),it=A.call(Ee,"finallyLoc");if(nt&&it){if(this.prev<Ee.catchLoc)return ne(Ee.catchLoc,!0);if(this.prev<Ee.finallyLoc)return ne(Ee.finallyLoc)}else if(nt){if(this.prev<Ee.catchLoc)return ne(Ee.catchLoc,!0)}else{if(!it)throw new Error("try statement without catch or finally");if(this.prev<Ee.finallyLoc)return ne(Ee.finallyLoc)}}}},"dispatchException"),abrupt:o(function(H,Y){for(var ne=this.tryEntries.length-1;ne>=0;--ne){var Se=this.tryEntries[ne];if(Se.tryLoc<=this.prev&&A.call(Se,"finallyLoc")&&this.prev<Se.finallyLoc){var Ee=Se;break}}Ee&&(H==="break"||H==="continue")&&Ee.tryLoc<=Y&&Y<=Ee.finallyLoc&&(Ee=null);var Ue=Ee?Ee.completion:{};return Ue.type=H,Ue.arg=Y,Ee?(this.method="next",this.next=Ee.finallyLoc,Q):this.complete(Ue)},"abrupt"),complete:o(function(H,Y){if(H.type==="throw")throw H.arg;return H.type==="break"||H.type==="continue"?this.next=H.arg:H.type==="return"?(this.rval=this.arg=H.arg,this.method="return",this.next="end"):H.type==="normal"&&Y&&(this.next=Y),Q},"complete"),finish:o(function(H){for(var Y=this.tryEntries.length-1;Y>=0;--Y){var ne=this.tryEntries[Y];if(ne.finallyLoc===H)return this.complete(ne.completion,ne.afterLoc),yt(ne),Q}},"finish"),catch:o(function(H){for(var Y=this.tryEntries.length-1;Y>=0;--Y){var ne=this.tryEntries[Y];if(ne.tryLoc===H){var Se=ne.completion;if(Se.type==="throw"){var Ee=Se.arg;yt(ne)}return Ee}}throw new Error("illegal catch attempt")},"_catch"),delegateYield:o(function(H,Y,ne){return this.delegate={iterator:he(H),resultName:Y,nextLoc:ne},this.method==="next"&&(this.arg=void 0),Q},"delegateYield")},N}o(M,"_regeneratorRuntime");function _(N,D,A,x,P,U,k){try{var W=N[U](k),L=W.value}catch(K){A(K);return}W.done?D(L):Promise.resolve(L).then(x,P)}o(_,"asyncGeneratorStep");function O(N){return function(){var D=this,A=arguments;return new Promise(function(x,P){var U=N.apply(D,A);function k(L){_(U,x,P,k,W,"next",L)}o(k,"_next");function W(L){_(U,x,P,k,W,"throw",L)}o(W,"_throw"),k(void 0)})}}o(O,"_asyncToGenerator");function b(N,D){if(!(N instanceof D))throw new TypeError("Cannot call a class as a function")}o(b,"_classCallCheck");function j(N,D){for(var A=0;A<D.length;A++){var x=D[A];x.enumerable=x.enumerable||!1,x.configurable=!0,"value"in x&&(x.writable=!0),Object.defineProperty(N,ue(x.key),x)}}o(j,"_defineProperties");function B(N,D,A){return D&&j(N.prototype,D),Object.defineProperty(N,"prototype",{writable:!1}),N}o(B,"_createClass");function q(N,D){if(typeof D!="function"&&D!==null)throw new TypeError("Super expression must either be null or a function");N.prototype=Object.create(D&&D.prototype,{constructor:{value:N,writable:!0,configurable:!0}}),Object.defineProperty(N,"prototype",{writable:!1}),D&&oe(N,D)}o(q,"_inherits");function oe(N,D){return oe=Object.setPrototypeOf?Object.setPrototypeOf.bind():o(function(x,P){return x.__proto__=P,x},"_setPrototypeOf"),oe(N,D)}o(oe,"_setPrototypeOf");function de(N){var D=Ae();return o(function(){var x=ae(N),P;if(D){var U=ae(this).constructor;P=Reflect.construct(x,arguments,U)}else P=x.apply(this,arguments);return Ne(this,P)},"_createSuperInternal")}o(de,"_createSuper");function Ne(N,D){if(D&&(h(D)==="object"||typeof D=="function"))return D;if(D!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Oe(N)}o(Ne,"_possibleConstructorReturn");function Oe(N){if(N===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return N}o(Oe,"_assertThisInitialized");function Ae(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}o(Ae,"_isNativeReflectConstruct");function ae(N){return ae=Object.setPrototypeOf?Object.getPrototypeOf.bind():o(function(A){return A.__proto__||Object.getPrototypeOf(A)},"_getPrototypeOf"),ae(N)}o(ae,"_getPrototypeOf");function X(N,D,A){return D=ue(D),D in N?Object.defineProperty(N,D,{value:A,enumerable:!0,configurable:!0,writable:!0}):N[D]=A,N}o(X,"_defineProperty");function ue(N){var D=ge(N,"string");return h(D)==="symbol"?D:String(D)}o(ue,"_toPropertyKey");function ge(N,D){if(h(N)!=="object"||N===null)return N;var A=N[Symbol.toPrimitive];if(A!==void 0){var x=A.call(N,D);if(h(x)!=="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(D==="string"?String:Number)(N)}o(ge,"_toPrimitive");function Ce(N){var D,A,x,P=2;for(typeof Symbol<"u"&&(A=Symbol.asyncIterator,x=Symbol.iterator);P--;){if(A&&(D=N[A])!=null)return D.call(N);if(x&&(D=N[x])!=null)return new J(D.call(N));A="@@asyncIterator",x="@@iterator"}throw new TypeError("Object is not async iterable")}o(Ce,"_asyncIterator");function J(N){function D(A){if(Object(A)!==A)return Promise.reject(new TypeError(A+" is not an object."));var x=A.done;return Promise.resolve(A.value).then(function(P){return{value:P,done:x}})}return o(D,"AsyncFromSyncIteratorContinuation"),J=o(function(x){this.s=x,this.n=x.next},"AsyncFromSyncIterator"),J.prototype={s:null,n:null,next:o(function(){return D(this.n.apply(this.s,arguments))},"next"),return:o(function(x){var P=this.s.return;return P===void 0?Promise.resolve({value:x,done:!0}):D(P.apply(this.s,arguments))},"_return"),throw:o(function(x){var P=this.s.return;return P===void 0?Promise.reject(x):D(P.apply(this.s,arguments))},"_throw")},new J(N)}o(J,"AsyncFromSyncIterator");var ee=function(N){q(A,N);var D=de(A);function A(x,P,U){var k;if(b(this,A),k=D.call(this),k.widget=x,k.iframe=P,k.driver=U,X(Oe(k),"transport",void 0),X(Oe(k),"cachedWidgetVersions",null),X(Oe(k),"contentLoadedActionSent",!1),X(Oe(k),"allowedCapabilities",new Set),X(Oe(k),"allowedEvents",[]),X(Oe(k),"isStopped",!1),X(Oe(k),"turnServers",null),X(Oe(k),"contentLoadedWaitTimer",void 0),X(Oe(k),"pushRoomStateTasks",new Set),X(Oe(k),"pushRoomStateResult",new Map),X(Oe(k),"flushRoomStateTask",null),X(Oe(k),"viewedRoomId",null),!(P!=null&&P.contentWindow))throw new Error("No iframe supplied");if(!x)throw new Error("Invalid widget");if(!U)throw new Error("Invalid driver");return k.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,x.id,P.contentWindow,window),k.transport.targetOrigin=x.origin,k.transport.on("message",k.handleMessage.bind(Oe(k))),P.addEventListener("load",k.onIframeLoad.bind(Oe(k))),k.transport.start(),k}return o(A,"ClientWidgetApi"),B(A,[{key:"hasCapability",value:o(function(P){return this.allowedCapabilities.has(P)},"hasCapability")},{key:"canUseRoomTimeline",value:o(function(P){return this.hasCapability("org.matrix.msc2762.timeline:".concat(d.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(P))},"canUseRoomTimeline")},{key:"canSendRoomEvent",value:o(function(P){var U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(k){return k.matchesAsRoomEvent(s.EventDirection.Send,P,U)})},"canSendRoomEvent")},{key:"canSendStateEvent",value:o(function(P,U){return this.allowedEvents.some(function(k){return k.matchesAsStateEvent(s.EventDirection.Send,P,U)})},"canSendStateEvent")},{key:"canSendToDeviceEvent",value:o(function(P){return this.allowedEvents.some(function(U){return U.matchesAsToDeviceEvent(s.EventDirection.Send,P)})},"canSendToDeviceEvent")},{key:"canReceiveRoomEvent",value:o(function(P){var U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(k){return k.matchesAsRoomEvent(s.EventDirection.Receive,P,U)})},"canReceiveRoomEvent")},{key:"canReceiveStateEvent",value:o(function(P,U){return this.allowedEvents.some(function(k){return k.matchesAsStateEvent(s.EventDirection.Receive,P,U)})},"canReceiveStateEvent")},{key:"canReceiveToDeviceEvent",value:o(function(P){return this.allowedEvents.some(function(U){return U.matchesAsToDeviceEvent(s.EventDirection.Receive,P)})},"canReceiveToDeviceEvent")},{key:"canReceiveRoomAccountData",value:o(function(P){return this.allowedEvents.some(function(U){return U.matchesAsRoomAccountData(s.EventDirection.Receive,P)})},"canReceiveRoomAccountData")},{key:"stop",value:o(function(){this.isStopped=!0,this.transport.stop()},"stop")},{key:"getWidgetVersions",value:function(){var x=O(M().mark(o(function U(){var k;return M().wrap(o(function(L){for(;;)switch(L.prev=L.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){L.next=2;break}return L.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return L.prev=2,L.next=5,this.transport.send(n.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return k=L.sent,this.cachedWidgetVersions=k.supported_versions,L.abrupt("return",k.supported_versions);case 10:return L.prev=10,L.t0=L.catch(2),console.warn("non-fatal error getting supported widget versions: ",L.t0),L.abrupt("return",[]);case 14:case"end":return L.stop()}},"_callee$"),U,this,[[2,10]])},"_callee")));function P(){return x.apply(this,arguments)}return o(P,"getWidgetVersions"),P}()},{key:"beginCapabilities",value:o(function(){var P=this;this.emit("preparing");var U;this.transport.send(n.WidgetApiToWidgetAction.Capabilities,{}).then(function(k){return U=k.capabilities,P.driver.validateCapabilities(new Set(k.capabilities))}).then(function(k){P.allowCapabilities(m(k),U),P.emit("ready")}).catch(function(k){P.emit("error:preparing",k)})},"beginCapabilities")},{key:"allowCapabilities",value:o(function(P,U){var k,W=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),P);var L=p(P),K;try{for(L.s();!(K=L.n()).done;){var Z=K.value;this.allowedCapabilities.add(Z)}}catch(le){L.e(le)}finally{L.f()}var Q=s.WidgetEventCapability.findEventCapabilities(P);(k=this.allowedEvents).push.apply(k,m(Q)),this.transport.send(n.WidgetApiToWidgetAction.NotifyCapabilities,{requested:U,approved:Array.from(this.allowedCapabilities)}).catch(function(le){console.warn("non-fatal error notifying widget of approved capabilities:",le)}).then(function(){W.emit("capabilitiesNotified")});var z=p(P),Te;try{for(z.s();!(Te=z.n()).done;){var ce=Te.value;if((0,i.isTimelineCapability)(ce)){var te=(0,i.getTimelineRoomIDFromCapability)(ce);if(te===d.Symbols.AnyRoom){var pe=p(this.driver.getKnownRooms()),be;try{for(pe.s();!(be=pe.n()).done;){var _e=be.value;this.pushRoomState(_e)}}catch(le){pe.e(le)}finally{pe.f()}}else this.pushRoomState(te)}}}catch(le){z.e(le)}finally{z.f()}Q.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)},"allowCapabilities")},{key:"onIframeLoad",value:o(function(P){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)},"onIframeLoad")},{key:"handleContentLoadedAction",value:o(function(P){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(P,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(P,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0},"handleContentLoadedAction")},{key:"replyVersions",value:o(function(P){this.transport.reply(P,{supported_versions:a.CurrentApiVersions})},"replyVersions")},{key:"supportsUpdateState",value:function(){var x=O(M().mark(o(function U(){return M().wrap(o(function(W){for(;;)switch(W.prev=W.next){case 0:return W.next=2,this.getWidgetVersions();case 2:return W.abrupt("return",W.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return W.stop()}},"_callee2$"),U,this)},"_callee2")));function P(){return x.apply(this,arguments)}return o(P,"supportsUpdateState"),P}()},{key:"handleCapabilitiesRenegotiate",value:o(function(P){var U,k=this;this.transport.reply(P,{});var W=((U=P.data)===null||U===void 0?void 0:U.capabilities)||[],L=new Set(W.filter(function(K){return!k.hasCapability(K)}));L.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(L).then(function(K){return k.allowCapabilities(m(K),m(L))})},"handleCapabilitiesRenegotiate")},{key:"handleNavigate",value:o(function(P){var U,k,W=this;if(!this.hasCapability(i.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(P,{error:{message:"Missing capability"}});if(!((U=P.data)!==null&&U!==void 0&&U.uri)||!((k=P.data)!==null&&k!==void 0&&k.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(P,{error:{message:"Invalid matrix.to URI"}});var L=o(function(Z){console.error("[ClientWidgetApi] Failed to handle navigation: ",Z),W.handleDriverError(Z,P,"Error handling navigation")},"onErr");try{this.driver.navigate(P.data.uri.toString()).catch(function(K){return L(K)}).then(function(){return W.transport.reply(P,{})})}catch(K){return L(K)}},"handleNavigate")},{key:"handleOIDC",value:o(function(P){var U=this,k=1,W=o(function(Q,z){return z=z||{},k>1?U.transport.send(n.WidgetApiToWidgetAction.OpenIDCredentials,g({state:Q,original_request_id:P.requestId},z)):U.transport.reply(P,g({state:Q},z))},"replyState"),L=o(function(Q){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",Q),k>1?W(l.OpenIDRequestState.Blocked):U.transport.reply(P,{error:{message:Q}})},"replyError"),K=new u.SimpleObservable(function(Z){if(Z.state===l.OpenIDRequestState.PendingUserConfirmation&&k>1)return K.close(),L("client provided out-of-phase response to OIDC flow");if(Z.state===l.OpenIDRequestState.PendingUserConfirmation){W(Z.state),k++;return}return Z.state===l.OpenIDRequestState.Allowed&&!Z.token?L("client provided invalid OIDC token for an allowed request"):(Z.state===l.OpenIDRequestState.Blocked&&(Z.token=void 0),K.close(),W(Z.state,Z.token))});this.driver.askOpenID(K)},"handleOIDC")},{key:"handleReadRoomAccountData",value:o(function(P){var U=this,k=Promise.resolve([]);return k=this.driver.readRoomAccountData(P.data.type),this.canReceiveRoomAccountData(P.data.type)?k.then(function(W){U.transport.reply(P,{events:W})}):this.transport.reply(P,{error:{message:"Cannot read room account data of this type"}})},"handleReadRoomAccountData")},{key:"handleReadEvents",value:function(){var x=O(M().mark(o(function U(k){var W=this,L,K,Z,Q,z,Te,ce,te,pe,be;return M().wrap(o(function(le){for(;;)switch(le.prev=le.next){case 0:if(k.data.type){le.next=2;break}return le.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(k.data.limit!==void 0&&(!k.data.limit||k.data.limit<0))){le.next=4;break}return le.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 4:if(k.data.room_ids!==void 0){le.next=8;break}L=this.viewedRoomId===null?[]:[this.viewedRoomId],le.next=30;break;case 8:if(k.data.room_ids!==d.Symbols.AnyRoom){le.next=12;break}L=this.driver.getKnownRooms().filter(function(je){return W.canUseRoomTimeline(je)}),le.next=30;break;case 12:L=k.data.room_ids,K=p(L),le.prev=14,K.s();case 16:if((Z=K.n()).done){le.next=22;break}if(Q=Z.value,this.canUseRoomTimeline(Q)){le.next=20;break}return le.abrupt("return",this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(Q)}}));case 20:le.next=16;break;case 22:le.next=27;break;case 24:le.prev=24,le.t0=le.catch(14),K.e(le.t0);case 27:return le.prev=27,K.f(),le.finish(27);case 30:if(z=k.data.limit||0,Te=k.data.since,ce=void 0,te=void 0,k.data.state_key===void 0){le.next=40;break}if(ce=k.data.state_key===!0?void 0:k.data.state_key.toString(),this.canReceiveStateEvent(k.data.type,(pe=ce)!==null&&pe!==void 0?pe:null)){le.next=38;break}return le.abrupt("return",this.transport.reply(k,{error:{message:"Cannot read state events of this type"}}));case 38:le.next=43;break;case 40:if(te=k.data.msgtype,this.canReceiveRoomEvent(k.data.type,te)){le.next=43;break}return le.abrupt("return",this.transport.reply(k,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(k.data.room_ids===void 0&&L.length===0)){le.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),le.next=47,k.data.state_key===void 0?this.driver.readRoomEvents(k.data.type,te,z,null,Te):this.driver.readStateEvents(k.data.type,ce,z,null);case 47:be=le.sent,le.next=68;break;case 50:return le.next=52,this.supportsUpdateState();case 52:if(!le.sent){le.next=58;break}return le.next=55,Promise.all(L.map(function(je){return W.driver.readRoomTimeline(je,k.data.type,te,ce,z,Te)}));case 55:be=le.sent.flat(1),le.next=68;break;case 58:if(k.data.state_key!==void 0){le.next=64;break}return le.next=61,Promise.all(L.map(function(je){return W.driver.readRoomTimeline(je,k.data.type,te,ce,z,Te)}));case 61:le.t1=le.sent,le.next=67;break;case 64:return le.next=66,Promise.all(L.map(function(je){return W.driver.readRoomState(je,k.data.type,ce)}));case 66:le.t1=le.sent;case 67:be=le.t1.flat(1);case 68:this.transport.reply(k,{events:be});case 69:case"end":return le.stop()}},"_callee3$"),U,this,[[14,24,27,30]])},"_callee3")));function P(U){return x.apply(this,arguments)}return o(P,"handleReadEvents"),P}()},{key:"handleSendEvent",value:o(function(P){var U=this;if(!P.data.type)return this.transport.reply(P,{error:{message:"Invalid request - missing event type"}});if(P.data.room_id&&!this.canUseRoomTimeline(P.data.room_id))return this.transport.reply(P,{error:{message:"Unable to access room timeline: ".concat(P.data.room_id)}});var k=P.data.delay!==void 0||P.data.parent_delay_id!==void 0;if(k&&!this.hasCapability(i.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(P,{error:{message:"Missing capability"}});var W;if(P.data.state_key!==void 0){if(!this.canSendStateEvent(P.data.type,P.data.state_key))return this.transport.reply(P,{error:{message:"Cannot send state events of this type"}});if(!k)W=this.driver.sendEvent(P.data.type,P.data.content||{},P.data.state_key,P.data.room_id);else{var L,K;W=this.driver.sendDelayedEvent((L=P.data.delay)!==null&&L!==void 0?L:null,(K=P.data.parent_delay_id)!==null&&K!==void 0?K:null,P.data.type,P.data.content||{},P.data.state_key,P.data.room_id)}}else{var Z=P.data.content||{},Q=Z.msgtype;if(!this.canSendRoomEvent(P.data.type,Q))return this.transport.reply(P,{error:{message:"Cannot send room events of this type"}});if(!k)W=this.driver.sendEvent(P.data.type,Z,null,P.data.room_id);else{var z,Te;W=this.driver.sendDelayedEvent((z=P.data.delay)!==null&&z!==void 0?z:null,(Te=P.data.parent_delay_id)!==null&&Te!==void 0?Te:null,P.data.type,Z,null,P.data.room_id)}}W.then(function(ce){return U.transport.reply(P,g({room_id:ce.roomId},"eventId"in ce?{event_id:ce.eventId}:{delay_id:ce.delayId}))}).catch(function(ce){console.error("error sending event: ",ce),U.handleDriverError(ce,P,"Error sending event")})},"handleSendEvent")},{key:"handleUpdateDelayedEvent",value:o(function(P){var U=this;if(!P.data.delay_id)return this.transport.reply(P,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(i.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(P,{error:{message:"Missing capability"}});switch(P.data.action){case c.UpdateDelayedEventAction.Cancel:case c.UpdateDelayedEventAction.Restart:case c.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(P.data.delay_id,P.data.action).then(function(){return U.transport.reply(P,{})}).catch(function(k){console.error("error updating delayed event: ",k),U.handleDriverError(k,P,"Error updating delayed event")});break;default:return this.transport.reply(P,{error:{message:"Invalid request - unsupported action"}})}},"handleUpdateDelayedEvent")},{key:"handleSendToDevice",value:function(){var x=O(M().mark(o(function U(k){return M().wrap(o(function(L){for(;;)switch(L.prev=L.next){case 0:if(k.data.type){L.next=5;break}return L.next=3,this.transport.reply(k,{error:{message:"Invalid request - missing event type"}});case 3:L.next=31;break;case 5:if(k.data.messages){L.next=10;break}return L.next=8,this.transport.reply(k,{error:{message:"Invalid request - missing event contents"}});case 8:L.next=31;break;case 10:if(typeof k.data.encrypted=="boolean"){L.next=15;break}return L.next=13,this.transport.reply(k,{error:{message:"Invalid request - missing encryption flag"}});case 13:L.next=31;break;case 15:if(this.canSendToDeviceEvent(k.data.type)){L.next=20;break}return L.next=18,this.transport.reply(k,{error:{message:"Cannot send to-device events of this type"}});case 18:L.next=31;break;case 20:return L.prev=20,L.next=23,this.driver.sendToDevice(k.data.type,k.data.encrypted,k.data.messages);case 23:return L.next=25,this.transport.reply(k,{});case 25:L.next=31;break;case 27:L.prev=27,L.t0=L.catch(20),console.error("error sending to-device event",L.t0),this.handleDriverError(L.t0,k,"Error sending event");case 31:case"end":return L.stop()}},"_callee4$"),U,this,[[20,27]])},"_callee4")));function P(U){return x.apply(this,arguments)}return o(P,"handleSendToDevice"),P}()},{key:"pollTurnServers",value:function(){var x=O(M().mark(o(function U(k,W){var L,K,Z,Q,z,Te;return M().wrap(o(function(te){for(;;)switch(te.prev=te.next){case 0:return te.prev=0,te.next=3,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,W);case 3:L=!1,K=!1,te.prev=5,Q=Ce(k);case 7:return te.next=9,Q.next();case 9:if(!(L=!(z=te.sent).done)){te.next=16;break}return Te=z.value,te.next=13,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,Te);case 13:L=!1,te.next=7;break;case 16:te.next=22;break;case 18:te.prev=18,te.t0=te.catch(5),K=!0,Z=te.t0;case 22:if(te.prev=22,te.prev=23,!(L&&Q.return!=null)){te.next=27;break}return te.next=27,Q.return();case 27:if(te.prev=27,!K){te.next=30;break}throw Z;case 30:return te.finish(27);case 31:return te.finish(22);case 32:te.next=37;break;case 34:te.prev=34,te.t1=te.catch(0),console.error("error polling for TURN servers",te.t1);case 37:case"end":return te.stop()}},"_callee5$"),U,this,[[0,34],[5,18,22,32],[23,,27,31]])},"_callee5")));function P(U,k){return x.apply(this,arguments)}return o(P,"pollTurnServers"),P}()},{key:"handleWatchTurnServers",value:function(){var x=O(M().mark(o(function U(k){var W,L,K,Z;return M().wrap(o(function(z){for(;;)switch(z.prev=z.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){z.next=5;break}return z.next=3,this.transport.reply(k,{error:{message:"Missing capability"}});case 3:z.next=30;break;case 5:if(!this.turnServers){z.next=10;break}return z.next=8,this.transport.reply(k,{});case 8:z.next=30;break;case 10:return z.prev=10,W=this.driver.getTurnServers(),z.next=14,W.next();case 14:if(L=z.sent,K=L.done,Z=L.value,!K){z.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return z.next=21,this.transport.reply(k,{});case 21:this.pollTurnServers(W,Z),this.turnServers=W,z.next=30;break;case 25:return z.prev=25,z.t0=z.catch(10),console.error("error getting first TURN server results",z.t0),z.next=30,this.transport.reply(k,{error:{message:"TURN servers not available"}});case 30:case"end":return z.stop()}},"_callee6$"),U,this,[[10,25]])},"_callee6")));function P(U){return x.apply(this,arguments)}return o(P,"handleWatchTurnServers"),P}()},{key:"handleUnwatchTurnServers",value:function(){var x=O(M().mark(o(function U(k){return M().wrap(o(function(L){for(;;)switch(L.prev=L.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){L.next=5;break}return L.next=3,this.transport.reply(k,{error:{message:"Missing capability"}});case 3:L.next=15;break;case 5:if(this.turnServers){L.next=10;break}return L.next=8,this.transport.reply(k,{});case 8:L.next=15;break;case 10:return L.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,L.next=15,this.transport.reply(k,{});case 15:case"end":return L.stop()}},"_callee7$"),U,this)},"_callee7")));function P(U){return x.apply(this,arguments)}return o(P,"handleUnwatchTurnServers"),P}()},{key:"handleReadRelations",value:function(){var x=O(M().mark(o(function U(k){var W=this,L,K;return M().wrap(o(function(Q){for(;;)switch(Q.prev=Q.next){case 0:if(k.data.event_id){Q.next=2;break}return Q.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(k.data.limit!==void 0&&k.data.limit<0)){Q.next=4;break}return Q.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(k.data.room_id!==void 0&&!this.canUseRoomTimeline(k.data.room_id))){Q.next=6;break}return Q.abrupt("return",this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(k.data.room_id)}}));case 6:return Q.prev=6,Q.next=9,this.driver.readEventRelations(k.data.event_id,k.data.room_id,k.data.rel_type,k.data.event_type,k.data.from,k.data.to,k.data.limit,k.data.direction);case 9:return L=Q.sent,K=L.chunk.filter(function(z){return z.state_key!==void 0?W.canReceiveStateEvent(z.type,z.state_key):W.canReceiveRoomEvent(z.type,z.content.msgtype)}),Q.abrupt("return",this.transport.reply(k,{chunk:K,prev_batch:L.prevBatch,next_batch:L.nextBatch}));case 14:Q.prev=14,Q.t0=Q.catch(6),console.error("error getting the relations",Q.t0),this.handleDriverError(Q.t0,k,"Unexpected error while reading relations");case 18:case"end":return Q.stop()}},"_callee8$"),U,this,[[6,14]])},"_callee8")));function P(U){return x.apply(this,arguments)}return o(P,"handleReadRelations"),P}()},{key:"handleUserDirectorySearch",value:function(){var x=O(M().mark(o(function U(k){var W;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3973UserDirectorySearch)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:if(typeof k.data.search_term=="string"){K.next=4;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(k.data.limit!==void 0&&k.data.limit<0)){K.next=6;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Invalid request - limit out of range"}}));case 6:return K.prev=6,K.next=9,this.driver.searchUserDirectory(k.data.search_term,k.data.limit);case 9:return W=K.sent,K.abrupt("return",this.transport.reply(k,{limited:W.limited,results:W.results.map(function(Z){return{user_id:Z.userId,display_name:Z.displayName,avatar_url:Z.avatarUrl}})}));case 13:K.prev=13,K.t0=K.catch(6),console.error("error searching in the user directory",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while searching in the user directory");case 17:case"end":return K.stop()}},"_callee9$"),U,this,[[6,13]])},"_callee9")));function P(U){return x.apply(this,arguments)}return o(P,"handleUserDirectorySearch"),P}()},{key:"handleGetMediaConfig",value:function(){var x=O(M().mark(o(function U(k){var W;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.getMediaConfig();case 5:return W=K.sent,K.abrupt("return",this.transport.reply(k,W));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while getting the media configuration",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while getting the media configuration");case 13:case"end":return K.stop()}},"_callee10$"),U,this,[[2,9]])},"_callee10")));function P(U){return x.apply(this,arguments)}return o(P,"handleGetMediaConfig"),P}()},{key:"handleUploadFile",value:function(){var x=O(M().mark(o(function U(k){var W;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.uploadFile(k.data.file);case 5:return W=K.sent,K.abrupt("return",this.transport.reply(k,{content_uri:W.contentUri}));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while uploading a file",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while uploading a file");case 13:case"end":return K.stop()}},"_callee11$"),U,this,[[2,9]])},"_callee11")));function P(U){return x.apply(this,arguments)}return o(P,"handleUploadFile"),P}()},{key:"handleDownloadFile",value:function(){var x=O(M().mark(o(function U(k){var W;return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039DownloadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(k,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.downloadFile(k.data.content_uri);case 5:return W=K.sent,K.abrupt("return",this.transport.reply(k,{file:W.file}));case 9:K.prev=9,K.t0=K.catch(2),console.error("error while downloading a file",K.t0),this.handleDriverError(K.t0,k,"Unexpected error while downloading a file");case 13:case"end":return K.stop()}},"_callee12$"),U,this,[[2,9]])},"_callee12")));function P(U){return x.apply(this,arguments)}return o(P,"handleDownloadFile"),P}()},{key:"handleDriverError",value:o(function(P,U,k){var W=this.driver.processError(P);this.transport.reply(U,{error:g({message:k},W)})},"handleDriverError")},{key:"handleMessage",value:o(function(P){if(!this.isStopped){var U=new CustomEvent("action:".concat(P.detail.action),{detail:P.detail,cancelable:!0});if(this.emit("action:".concat(P.detail.action),U),!U.defaultPrevented)switch(P.detail.action){case n.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(P.detail);case n.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(P.detail);case n.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(P.detail);case n.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(P.detail);case n.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(P.detail);case n.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(P.detail);case n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(P.detail);case n.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(P.detail);case n.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(P.detail);case n.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(P.detail);case n.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(P.detail);case n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(P.detail);case n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(P.detail);case n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(P.detail);case n.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(P.detail);case n.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(P.detail);case n.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(P.detail);default:return this.transport.reply(P.detail,{error:{message:"Unknown or unsupported action: "+P.detail.action}})}}},"handleMessage")},{key:"updateTheme",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.ThemeChange,P)},"updateTheme")},{key:"updateLanguage",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.LanguageChange,{lang:P})},"updateLanguage")},{key:"takeScreenshot",value:o(function(){return this.transport.send(n.WidgetApiToWidgetAction.TakeScreenshot,{})},"takeScreenshot")},{key:"updateVisibility",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.UpdateVisibility,{visible:P})},"updateVisibility")},{key:"sendWidgetConfig",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.WidgetConfig,P).then()},"sendWidgetConfig")},{key:"notifyModalWidgetButtonClicked",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.ButtonClicked,{id:P}).then()},"notifyModalWidgetButtonClicked")},{key:"notifyModalWidgetClose",value:o(function(P){return this.transport.send(n.WidgetApiToWidgetAction.CloseModalWidget,P).then()},"notifyModalWidgetClose")},{key:"feedEvent",value:function(){var x=O(M().mark(o(function U(k,W){var L;return M().wrap(o(function(Z){for(;;)switch(Z.prev=Z.next){case 0:if(W!==void 0&&this.setViewedRoomId(W),!(k.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(k.room_id))){Z.next=3;break}return Z.abrupt("return");case 3:if(!(k.state_key!==void 0&&k.state_key!==null)){Z.next=8;break}if(this.canReceiveStateEvent(k.type,k.state_key)){Z.next=6;break}return Z.abrupt("return");case 6:Z.next=10;break;case 8:if(this.canReceiveRoomEvent(k.type,(L=k.content)===null||L===void 0?void 0:L.msgtype)){Z.next=10;break}return Z.abrupt("return");case 10:return Z.next=12,this.transport.send(n.WidgetApiToWidgetAction.SendEvent,k);case 12:case"end":return Z.stop()}},"_callee13$"),U,this)},"_callee13")));function P(U,k){return x.apply(this,arguments)}return o(P,"feedEvent"),P}()},{key:"feedToDevice",value:function(){var x=O(M().mark(o(function U(k,W){return M().wrap(o(function(K){for(;;)switch(K.prev=K.next){case 0:if(!this.canReceiveToDeviceEvent(k.type)){K.next=3;break}return K.next=3,this.transport.send(n.WidgetApiToWidgetAction.SendToDevice,g(g({},k),{},{encrypted:W}));case 3:case"end":return K.stop()}},"_callee14$"),U,this)},"_callee14")));function P(U,k){return x.apply(this,arguments)}return o(P,"feedToDevice"),P}()},{key:"setViewedRoomId",value:o(function(P){this.viewedRoomId=P,P!==null&&!this.canUseRoomTimeline(P)&&this.pushRoomState(P)},"setViewedRoomId")},{key:"flushRoomState",value:function(){var x=O(M().mark(o(function U(){var k,W,L,K,Z,Q,z;return M().wrap(o(function(ce){for(;;)switch(ce.prev=ce.next){case 0:ce.prev=0;case 1:return ce.next=3,Promise.all(m(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){ce.next=1;break}case 4:k=[],W=p(this.pushRoomStateResult.values());try{for(W.s();!(L=W.n()).done;){K=L.value,Z=p(K.values());try{for(Z.s();!(Q=Z.n()).done;)z=Q.value,k.push.apply(k,m(z.values()))}catch(te){Z.e(te)}finally{Z.f()}}}catch(te){W.e(te)}finally{W.f()}return ce.next=9,this.getWidgetVersions();case 9:if(!ce.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){ce.next=12;break}return ce.next=12,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:k});case 12:return ce.prev=12,this.flushRoomStateTask=null,ce.finish(12);case 15:case"end":return ce.stop()}},"_callee15$"),U,this,[[0,,12,15]])},"_callee15")));function P(){return x.apply(this,arguments)}return o(P,"flushRoomState"),P}()},{key:"pushRoomState",value:o(function(P){var U=this,k=p(this.allowedEvents),W;try{var L=o(function(){var Z=W.value;if(Z.kind===s.EventKind.State&&Z.direction===s.EventDirection.Receive){var Q,z,Te=U.driver.readRoomState(P,Z.eventType,(Q=Z.keyStr)!==null&&Q!==void 0?Q:void 0),ce=Te.then(function(te){var pe=p(te),be;try{for(pe.s();!(be=pe.n()).done;){var _e=be.value,le=U.pushRoomStateResult.get(P);le===void 0&&(le=new Map,U.pushRoomStateResult.set(P,le));var je=le.get(Z.eventType);je===void 0&&(je=new Map,le.set(Z.eventType,je)),je.has(_e.state_key)||je.set(_e.state_key,_e)}}catch(rn){pe.e(rn)}finally{pe.f()}},function(te){return console.error("Failed to read room state for ".concat(P," (").concat(Z.eventType,", ").concat(Z.keyStr,")"),te)}).then(function(){U.pushRoomStateTasks.delete(ce)});U.pushRoomStateTasks.add(ce),(z=U.flushRoomStateTask)!==null&&z!==void 0||(U.flushRoomStateTask=U.flushRoomState()),U.flushRoomStateTask.catch(function(te){return console.error("Failed to push room state",te)})}},"_loop");for(k.s();!(W=k.n()).done;)L()}catch(K){k.e(K)}finally{k.f()}},"pushRoomState")},{key:"feedStateUpdate",value:function(){var x=O(M().mark(o(function U(k){var W,L;return M().wrap(o(function(Z){for(;;)switch(Z.prev=Z.next){case 0:if(k.state_key!==void 0){Z.next=2;break}throw new Error("Not a state event");case 2:if(!((k.room_id===this.viewedRoomId||this.canUseRoomTimeline(k.room_id))&&this.canReceiveStateEvent(k.type,k.state_key))){Z.next=21;break}if(this.pushRoomStateTasks.size!==0){Z.next=11;break}return Z.next=6,this.getWidgetVersions();case 6:if(!Z.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){Z.next=9;break}return Z.next=9,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:[k]});case 9:Z.next=21;break;case 11:W=this.pushRoomStateResult.get(k.room_id),W===void 0&&(W=new Map,this.pushRoomStateResult.set(k.room_id,W)),L=W.get(k.type),L===void 0&&(L=new Map,W.set(k.type,L)),L.has(k.type)||L.set(k.state_key,k);case 16:return Z.next=18,Promise.all(m(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){Z.next=16;break}case 19:return Z.next=21,this.flushRoomStateTask;case 21:case"end":return Z.stop()}},"_callee16$"),U,this)},"_callee16")));function P(U){return x.apply(this,arguments)}return o(P,"feedStateUpdate"),P}()}]),A}(r.EventEmitter);return xo.ClientWidgetApi=ee,xo}o(FL,"requireClientWidgetApi");var Sy={};Object.defineProperty(Sy,"__esModule",{value:!0});Sy.isErrorResponse=BL;function jm(r){"@babel/helpers - typeof";return jm=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jm(r)}o(jm,"_typeof");function BL(r){var e=r.error;return jm(e)==="object"&&e!==null&&"message"in e&&typeof e.message=="string"}o(BL,"isErrorResponse");var Uh={};Object.defineProperty(Uh,"__esModule",{value:!0});Uh.WidgetKind=void 0;var $L=function(r){return r.Room="room",r.Account="account",r.Modal="modal",r}({});Uh.WidgetKind=$L;var jh={};Object.defineProperty(jh,"__esModule",{value:!0});jh.ModalButtonKind=void 0;var WL=function(r){return r.Primary="m.primary",r.Secondary="m.secondary",r.Warning="m.warning",r.Danger="m.danger",r.Link="m.link",r}({});jh.ModalButtonKind=WL;var Fh={};Object.defineProperty(Fh,"__esModule",{value:!0});Fh.isValidUrl=KL;function KL(r){if(!r)return!1;try{var e=new URL(r);return!(e.protocol!=="http"&&e.protocol!=="https")}catch(t){if(t instanceof TypeError)return!1;throw t}}o(KL,"isValidUrl");var Bh={};Object.defineProperty(Bh,"__esModule",{value:!0});Bh.assertPresent=VL;function VL(r,e){if(!r[e])throw new Error("".concat(String(e)," is required"))}o(VL,"assertPresent");var Do={},D0;function XI(){if(D0)return Do;D0=1,Object.defineProperty(Do,"__esModule",{value:!0}),Do.Widget=void 0;var r=Bh,e=Wh();function t(d){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(c){return typeof c}:function(c){return c&&typeof Symbol=="function"&&c.constructor===Symbol&&c!==Symbol.prototype?"symbol":typeof c},t(d)}o(t,"_typeof");function n(d,c){if(!(d instanceof c))throw new TypeError("Cannot call a class as a function")}o(n,"_classCallCheck");function i(d,c){for(var h=0;h<c.length;h++){var v=c[h];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(d,s(v.key),v)}}o(i,"_defineProperties");function a(d,c,h){return c&&i(d.prototype,c),Object.defineProperty(d,"prototype",{writable:!1}),d}o(a,"_createClass");function s(d){var c=l(d,"string");return t(c)==="symbol"?c:String(c)}o(s,"_toPropertyKey");function l(d,c){if(t(d)!=="object"||d===null)return d;var h=d[Symbol.toPrimitive];if(h!==void 0){var v=h.call(d,c);if(t(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(d)}o(l,"_toPrimitive");var u=function(){function d(c){if(n(this,d),this.definition=c,!this.definition)throw new Error("Definition is required");(0,r.assertPresent)(c,"id"),(0,r.assertPresent)(c,"creatorUserId"),(0,r.assertPresent)(c,"type"),(0,r.assertPresent)(c,"url")}return o(d,"Widget"),a(d,[{key:"creatorUserId",get:o(function(){return this.definition.creatorUserId},"get")},{key:"type",get:o(function(){return this.definition.type},"get")},{key:"id",get:o(function(){return this.definition.id},"get")},{key:"name",get:o(function(){return this.definition.name||null},"get")},{key:"title",get:o(function(){return this.rawData.title||null},"get")},{key:"templateUrl",get:o(function(){return this.definition.url},"get")},{key:"origin",get:o(function(){return new URL(this.templateUrl).origin},"get")},{key:"waitForIframeLoad",get:o(function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)},"get")},{key:"rawData",get:o(function(){return this.definition.data||{}},"get")},{key:"getCompleteUrl",value:o(function(h){return(0,e.runTemplate)(this.templateUrl,this.definition,h)},"getCompleteUrl")}]),d}();return Do.Widget=u,Do}o(XI,"requireWidget");var No={},N0;function GL(){if(N0)return No;N0=1,Object.defineProperty(No,"__esModule",{value:!0}),No.WidgetParser=void 0;var r=XI(),e=Fh;function t(v){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},t(v)}o(t,"_typeof");function n(v,g){var p=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!p){if(Array.isArray(v)||(p=i(v))||g){p&&(v=p);var m=0,w=o(function(){},"F");return{s:w,n:o(function(){return m>=v.length?{done:!0}:{done:!1,value:v[m++]}},"n"),e:o(function(M){throw M},"e"),f:w}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var y=!0,S=!1,T;return{s:o(function(){p=p.call(v)},"s"),n:o(function(){var M=p.next();return y=M.done,M},"n"),e:o(function(M){S=!0,T=M},"e"),f:o(function(){try{!y&&p.return!=null&&p.return()}finally{if(S)throw T}},"f")}}o(n,"_createForOfIteratorHelper");function i(v,g){if(v){if(typeof v=="string")return a(v,g);var p=Object.prototype.toString.call(v).slice(8,-1);if(p==="Object"&&v.constructor&&(p=v.constructor.name),p==="Map"||p==="Set")return Array.from(v);if(p==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(p))return a(v,g)}}o(i,"_unsupportedIterableToArray");function a(v,g){(g==null||g>v.length)&&(g=v.length);for(var p=0,m=new Array(g);p<g;p++)m[p]=v[p];return m}o(a,"_arrayLikeToArray");function s(v,g){if(!(v instanceof g))throw new TypeError("Cannot call a class as a function")}o(s,"_classCallCheck");function l(v,g){for(var p=0;p<g.length;p++){var m=g[p];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(v,d(m.key),m)}}o(l,"_defineProperties");function u(v,g,p){return p&&l(v,p),Object.defineProperty(v,"prototype",{writable:!1}),v}o(u,"_createClass");function d(v){var g=c(v,"string");return t(g)==="symbol"?g:String(g)}o(d,"_toPropertyKey");function c(v,g){if(t(v)!=="object"||v===null)return v;var p=v[Symbol.toPrimitive];if(p!==void 0){var m=p.call(v,g);if(t(m)!=="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}o(c,"_toPrimitive");var h=function(){function v(){s(this,v)}return o(v,"WidgetParser"),u(v,null,[{key:"parseAccountData",value:o(function(p){if(!p)return[];for(var m=[],w=0,y=Object.keys(p);w<y.length;w++){var S=y[w],T=p[S];if(T&&!(T.type!=="m.widget"&&T.type!=="im.vector.modular.widgets")&&T.sender){var C=T.state_key||T.id;if(C===S){var M={content:T.content,sender:T.sender,type:"m.widget",state_key:S,event_id:"$example",room_id:"!example",origin_server_ts:1},_=v.parseRoomWidget(M);_&&m.push(_)}}}return m},"parseAccountData")},{key:"parseWidgetsFromRoomState",value:o(function(p){if(!p)return[];var m=[],w=n(p),y;try{for(w.s();!(y=w.n()).done;){var S=y.value,T=v.parseRoomWidget(S);T&&m.push(T)}}catch(C){w.e(C)}finally{w.f()}return m},"parseWidgetsFromRoomState")},{key:"parseRoomWidget",value:o(function(p){if(!p||p.type!=="m.widget"&&p.type!=="im.vector.modular.widgets")return null;var m=p.content||{},w={id:p.state_key,creatorUserId:m.creatorUserId||p.sender,name:m.name,type:m.type,url:m.url,waitForIframeLoad:m.waitForIframeLoad,data:m.data};return v.processEstimatedWidget(w)},"parseRoomWidget")},{key:"processEstimatedWidget",value:o(function(p){return!p.id||!p.creatorUserId||!p.type||!(0,e.isValidUrl)(p.url)?null:new r.Widget(p)},"processEstimatedWidget")}]),v}();return No.WidgetParser=h,No}o(GL,"requireWidgetParser");var $h={};Object.defineProperty($h,"__esModule",{value:!0});$h.runTemplate=qL;$h.toString=ZI;function qL(r,e,t){for(var n=Object.assign({},e.data,{matrix_room_id:t.widgetRoomId||"",matrix_user_id:t.currentUserId,matrix_display_name:t.userDisplayName||t.currentUserId,matrix_avatar_url:t.userHttpAvatarUrl||"",matrix_widget_id:e.id,"org.matrix.msc2873.client_id":t.clientId||"","org.matrix.msc2873.client_theme":t.clientTheme||"","org.matrix.msc2873.client_language":t.clientLanguage||"","org.matrix.msc3819.matrix_device_id":t.deviceId||"","org.matrix.msc4039.matrix_base_url":t.baseUrl||""}),i=r,a=0,s=Object.keys(n);a<s.length;a++){var l=s[a],u="$".concat(l).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(u,"g");i=i.replace(d,encodeURIComponent(ZI(n[l])))}return i}o(qL,"runTemplate");function ZI(r){return r==null?"".concat(r):String(r)}o(ZI,"toString");var Lo={},L0;function HL(){if(L0)return Lo;L0=1,Object.defineProperty(Lo,"__esModule",{value:!0}),Lo.WidgetDriver=void 0;var r=Wh();function e(u){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(d){return typeof d}:function(d){return d&&typeof Symbol=="function"&&d.constructor===Symbol&&d!==Symbol.prototype?"symbol":typeof d},e(u)}o(e,"_typeof");function t(u,d){if(!(u instanceof d))throw new TypeError("Cannot call a class as a function")}o(t,"_classCallCheck");function n(u,d){for(var c=0;c<d.length;c++){var h=d[c];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(u,a(h.key),h)}}o(n,"_defineProperties");function i(u,d,c){return d&&n(u.prototype,d),Object.defineProperty(u,"prototype",{writable:!1}),u}o(i,"_createClass");function a(u){var d=s(u,"string");return e(d)==="symbol"?d:String(d)}o(a,"_toPropertyKey");function s(u,d){if(e(u)!=="object"||u===null)return u;var c=u[Symbol.toPrimitive];if(c!==void 0){var h=c.call(u,d);if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(u)}o(s,"_toPrimitive");var l=function(){function u(){t(this,u)}return o(u,"WidgetDriver"),i(u,[{key:"validateCapabilities",value:o(function(c){return Promise.resolve(new Set)},"validateCapabilities")},{key:"sendEvent",value:o(function(c,h){return Promise.reject(new Error("Failed to override function"))},"sendEvent")},{key:"sendDelayedEvent",value:o(function(c,h,v,g){return Promise.reject(new Error("Failed to override function"))},"sendDelayedEvent")},{key:"updateDelayedEvent",value:o(function(c,h){return Promise.reject(new Error("Failed to override function"))},"updateDelayedEvent")},{key:"sendToDevice",value:o(function(c,h,v){return Promise.reject(new Error("Failed to override function"))},"sendToDevice")},{key:"readRoomAccountData",value:o(function(c){return Promise.resolve([])},"readRoomAccountData")},{key:"readRoomEvents",value:o(function(c,h,v){return Promise.resolve([])},"readRoomEvents")},{key:"readStateEvents",value:o(function(c,h,v){return Promise.resolve([])},"readStateEvents")},{key:"readRoomTimeline",value:o(function(c,h,v,g,p,m){return g===void 0?this.readRoomEvents(h,v,p,[c],m):this.readStateEvents(h,g,p,[c])},"readRoomTimeline")},{key:"readRoomState",value:o(function(c,h,v){return this.readStateEvents(h,v,Number.MAX_SAFE_INTEGER,[c])},"readRoomState")},{key:"readEventRelations",value:o(function(c,h,v,g,p,m,w,y){return Promise.resolve({chunk:[]})},"readEventRelations")},{key:"askOpenID",value:o(function(c){c.update({state:r.OpenIDRequestState.Blocked})},"askOpenID")},{key:"navigate",value:o(function(c){throw new Error("Navigation is not implemented")},"navigate")},{key:"getTurnServers",value:o(function(){throw new Error("TURN server support is not implemented")},"getTurnServers")},{key:"searchUserDirectory",value:o(function(c,h){return Promise.resolve({limited:!1,results:[]})},"searchUserDirectory")},{key:"getMediaConfig",value:o(function(){throw new Error("Get media config is not implemented")},"getMediaConfig")},{key:"uploadFile",value:o(function(c){throw new Error("Upload file is not implemented")},"uploadFile")},{key:"downloadFile",value:o(function(c){throw new Error("Download file is not implemented")},"downloadFile")},{key:"getKnownRooms",value:o(function(){throw new Error("Querying known rooms is not implemented")},"getKnownRooms")},{key:"processError",value:o(function(c){},"processError")}]),u}();return Lo.WidgetDriver=l,Lo}o(HL,"requireWidgetDriver");var U0;function Wh(){return U0||(U0=1,function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=TL();Object.keys(e).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===e[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return e[b]},"get")})});var t=FL();Object.keys(t).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===t[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return t[b]},"get")})});var n=mo;Object.keys(n).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===n[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return n[b]},"get")})});var i=gy();Object.keys(i).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===i[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return i[b]},"get")})});var a=yu;Object.keys(a).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===a[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return a[b]},"get")})});var s=Sy;Object.keys(s).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===s[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return s[b]},"get")})});var l=Ui;Object.keys(l).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===l[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return l[b]},"get")})});var u=Oa;Object.keys(u).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===u[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return u[b]},"get")})});var d=_n;Object.keys(d).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===d[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return d[b]},"get")})});var c=Lr;Object.keys(c).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===c[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return c[b]},"get")})});var h=po;Object.keys(h).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===h[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return h[b]},"get")})});var v=Uh;Object.keys(v).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===v[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return v[b]},"get")})});var g=jh;Object.keys(g).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===g[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return g[b]},"get")})});var p=Su;Object.keys(p).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===p[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return p[b]},"get")})});var m=_u;Object.keys(m).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===m[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return m[b]},"get")})});var w=bn;Object.keys(w).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===w[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return w[b]},"get")})});var y=Fh;Object.keys(y).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===y[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return y[b]},"get")})});var S=Bh;Object.keys(S).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===S[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return S[b]},"get")})});var T=XI();Object.keys(T).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===T[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return T[b]},"get")})});var C=GL();Object.keys(C).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===C[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return C[b]},"get")})});var M=$h;Object.keys(M).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===M[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return M[b]},"get")})});var _=Eu;Object.keys(_).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===_[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return _[b]},"get")})});var O=HL();Object.keys(O).forEach(function(b){b==="default"||b==="__esModule"||b in r&&r[b]===O[b]||Object.defineProperty(r,b,{enumerable:!0,get:o(function(){return O[b]},"get")})})}(Kf)),Kf}o(Wh,"requireLib");var Mr=Wh();function j0(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,n)}return t}o(j0,"ownKeys");function Qu(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?j0(Object(t),!0).forEach(function(n){f(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):j0(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}o(Qu,"_objectSpread");function zL(r){var e,t,n,i=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(t&&(e=r[t])!=null)return e.call(r);if(n&&(e=r[n])!=null)return new bd(e.call(r));t="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}o(zL,"_asyncIterator");function bd(r){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(i){return{value:i,done:n}})}return o(e,"AsyncFromSyncIteratorContinuation"),bd=o(function(n){this.s=n,this.n=n.next},"AsyncFromSyncIterator"),bd.prototype={s:null,n:null,next:o(function(){return e(this.n.apply(this.s,arguments))},"next"),return:o(function(n){var i=this.s.return;return i===void 0?Promise.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},"_return"),throw:o(function(n){var i=this.s.return;return i===void 0?Promise.reject(n):e(i.apply(this.s,arguments))},"_throw")},new bd(r)}o(bd,"AsyncFromSyncIterator");var wd=function(r){return r.PendingEventsChanged="PendingEvent.pendingEventsChanged",r}({});const nE=class nE extends to{constructor(e,t,n,i,a){var s,l,u,d,c,h,v,g,p,m,w,y,S,T;super(i),s=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,f(this,"room",void 0),f(this,"widgetApiReady",void 0),f(this,"roomStateSynced",void 0),f(this,"lifecycle",void 0),f(this,"syncState",null),f(this,"pendingSendingEventsTxId",[]),f(this,"eventEmitter",new Qe),f(this,"updateTxId",function(){var _=R(function*(O){if(O.getSender()===s.getUserId()&&s.pendingSendingEventsTxId.some(q=>O.getType()===q.type)){for(var b,j=(b=s.pendingSendingEventsTxId.find(q=>q.id===O.getId()))===null||b===void 0?void 0:b.txId;!j&&s.pendingSendingEventsTxId.length>0;){var B;yield new Promise(q=>s.eventEmitter.once(wd.PendingEventsChanged,()=>q())),j=(B=s.pendingSendingEventsTxId.find(q=>q.id===O.getId()))===null||B===void 0?void 0:B.txId}j&&(O.setTxnId(j),O.setUnsigned(Qu(Qu({},O.getUnsigned()),{},{transaction_id:j}))),s.pendingSendingEventsTxId=s.pendingSendingEventsTxId.filter(q=>q.id!==O.getId()),s.pendingSendingEventsTxId.length===0&&s.eventEmitter.emit(wd.PendingEventsChanged)}});return function(O){return _.apply(this,arguments)}}()),f(this,"onEvent",function(){var _=R(function*(O){if(O.preventDefault(),O.detail.data.room_id===s.roomId){var b=new Ht(O.detail.data);yield s.updateTxId(b),s.syncApi instanceof mn?(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,void 0,[],[b]):yield s.syncApi.injectRoomEvents(s.room,[],void 0,[b]):(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,[],[b]):I.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),s.emit(ve.Event,b),s.setSyncState(Ve.Syncing),I.info("Received event ".concat(b.getId()," ").concat(b.getType()))}else{var{event_id:j,room_id:B}=O.detail.data;I.info("Received event ".concat(j," for a different room ").concat(B,"; discarding"))}yield s.ack(O)});return function(O){return _.apply(this,arguments)}}()),f(this,"onToDevice",function(){var _=R(function*(O){O.preventDefault();var b=new Ht({type:O.detail.data.type,sender:O.detail.data.sender,content:O.detail.data.content});O.detail.data.encrypted&&b.makeEncrypted(F.RoomMessageEncrypted,{},"",""),s.emit(ve.ToDeviceEvent,b),s.setSyncState(Ve.Syncing),yield s.ack(O)});return function(O){return _.apply(this,arguments)}}()),f(this,"onStateUpdate",function(){var _=R(function*(O){O.preventDefault(),(yield s.supportUpdateState())||I.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var b of O.detail.data.state)if(b.room_id===s.roomId){var j=new Ht(b);s.syncApi instanceof mn?yield s.syncApi.injectRoomEvents(s.room,void 0,[j]):yield s.syncApi.injectRoomEvents(s.room,[j]),I.info("Updated state entry ".concat(j.getType()," ").concat(j.getStateKey()," to ").concat(j.getId()))}else{var{event_id:B,room_id:q}=O.detail.data;I.info("Received state entry ".concat(B," for a different room ").concat(q,"; discarding"))}yield s.ack(O)});return function(O){return _.apply(this,arguments)}}());var C=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var _=R(function*(O,b){try{return yield C(O,b)}catch(j){F0(j)}});return function(O,b){return _.apply(this,arguments)}}();var M=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var _=R(function*(O,b){try{return yield M(O,b)}catch(j){F0(j)}});return function(O,b){return _.apply(this,arguments)}}(),this.widgetApiReady=new Promise(_=>this.widgetApi.once("ready",_)),this.roomStateSynced=(l=t.receiveState)!==null&&l!==void 0&&l.length?new Promise(_=>this.widgetApi.once("action:".concat(Mr.WidgetApiToWidgetAction.UpdateState),_)):Promise.resolve(),((u=t.sendEvent)!==null&&u!==void 0&&u.length||(d=t.receiveEvent)!==null&&d!==void 0&&d.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(c=t.sendState)!==null&&c!==void 0&&c.length||(h=t.receiveState)!==null&&h!==void 0&&h.length)&&e.requestCapabilityForRoomTimeline(n),(v=t.sendEvent)===null||v===void 0||v.forEach(_=>e.requestCapabilityToSendEvent(_)),(g=t.receiveEvent)===null||g===void 0||g.forEach(_=>e.requestCapabilityToReceiveEvent(_)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(_=>e.requestCapabilityToSendMessage(_)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(_=>e.requestCapabilityToReceiveMessage(_)),(p=t.sendState)===null||p===void 0||p.forEach(_=>{var{eventType:O,stateKey:b}=_;return e.requestCapabilityToSendState(O,b)}),(m=t.receiveState)===null||m===void 0||m.forEach(_=>{var{eventType:O,stateKey:b}=_;return e.requestCapabilityToReceiveState(O,b)}),(w=t.sendToDevice)===null||w===void 0||w.forEach(_=>e.requestCapabilityToSendToDevice(_)),(y=t.receiveToDevice)===null||y===void 0||y.forEach(_=>e.requestCapabilityToReceiveToDevice(_)),t.sendDelayedEvents&&((S=t.sendEvent)!==null&&S!==void 0&&S.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(T=t.sendState)!==null&&T!==void 0&&T.length)&&e.requestCapability(Mr.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(Mr.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(Mr.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(Mr.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(Mr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(Mr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}supportUpdateState(){var e=this;return R(function*(){return(yield e.widgetApi.getClientVersions()).includes(Mr.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return R(function*(){var n=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var i=t.getUserId();if(i&&t.store.storeUser(new Wn(i)),n.slidingSync?t.syncApi=new Pc(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new mn(t,n,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,s;yield Promise.all((a=(s=t.capabilities.receiveState)===null||s===void 0?void 0:s.map(function(){var l=R(function*(u){var{eventType:d,stateKey:c}=u,h=yield t.widgetApi.readStateEvents(d,void 0,c,[t.roomId]),v=h.map(g=>new Ht(g));t.syncApi instanceof mn?yield t.syncApi.injectRoomEvents(t.room,void 0,v):yield t.syncApi.injectRoomEvents(t.room,v),v.forEach(g=>{t.emit(ve.Event,g),I.info("Backfilled event ".concat(g.getId()," ").concat(g.getType()," ").concat(g.getStateKey()))})});return function(u){return l.apply(this,arguments)}}()))!==null&&a!==void 0?a:[])}n.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(Ve.Syncing),I.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(Mr.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(Mr.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(Mr.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return R(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n){var i=this;return R(function*(){var a=t.event.redacts?Qu(Qu({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(n){var s=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId,"delay"in n?n.delay:void 0,"parent_delay_id"in n?n.parent_delay_id:void 0).catch(sn);return i.validateSendDelayedEventResponse(s)}var l=t.getTxnId();l&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:l});var u;try{u=yield i.widgetApi.sendRoomEvent(t.getType(),a,e.roomId).catch(sn)}catch(d){throw i.updatePendingEventStatus(e,t,we.NOT_SENT),d}return e.updatePendingEvent(t,we.SENT,u.event_id),i.pendingSendingEventsTxId.forEach(d=>{d.txId===l&&(d.id=u.event_id)}),i.eventEmitter.emit(wd.PendingEventsChanged),{event_id:u.event_id}})()}sendStateEvent(e,t,n){var i=arguments,a=this;return R(function*(){var s=i.length>3&&i[3]!==void 0?i[3]:"",l=yield a.widgetApi.sendStateEvent(t,s,n,e).catch(sn);if(l.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:l.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,i){var a=arguments,s=this;return R(function*(){var l=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield s.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","sendDelayedStateEvent");var u=yield s.widgetApi.sendStateEvent(n,l,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(sn);return s.validateSendDelayedEventResponse(u)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return R(function*(){if(!(yield n.doesServerSupportUnstableFeature(vn)))throw new gn("Server does not support the delayed events API","updateDelayedEvent");return yield n.widgetApi.updateDelayedEvent(e,t).catch(sn),{}})()}encryptAndSendToDevice(e,t,n){var i=this;return R(function*(){var a=new Yr(()=>new Map);for(var{userId:s,deviceId:l}of t)a.getOrCreate(s).set(l,n);yield i.widgetApi.sendToDevice(e,!0,sa(a)).catch(sn)})()}sendToDevice(e,t){var n=this;return R(function*(){return yield n.widgetApi.sendToDevice(e,!1,sa(t)).catch(sn),{}})()}getOpenIdToken(){var e=this;return R(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(sn);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return R(function*(){var{eventType:n,batch:i}=e,a=new Yr(()=>new Map);for(var{userId:s,deviceId:l,payload:u}of i)a.getOrCreate(s).set(l,u);yield t.widgetApi.sendToDevice(n,!1,sa(a)).catch(sn)})()}sendToDeviceViaWidgetApi(e,t,n){var i=this;return R(function*(){yield i.widgetApi.sendToDevice(e,t,sa(n)).catch(sn)})()}checkTurnServers(){var e=this;return R(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(ve.Sync,e,t)}ack(e){var t=this;return R(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return R(function*(){var t=e.widgetApi.getTurnServers(),n=o(()=>{t.return(void 0)},"onClientStopped");e.lifecycle.signal.addEventListener("abort",n);try{var i=!1,a=!1,s;try{for(var l=zL(t),u;i=!(u=yield l.next()).done;i=!1){var d=u.value;e.turnServers=[{urls:d.uris,username:d.username,credential:d.password}],e.emit(ve.TurnServers,e.turnServers),I.log("Received TURN server: ".concat(d.uris))}}catch(c){a=!0,s=c}finally{try{i&&l.return!=null&&(yield l.return())}finally{if(a)throw s}}}catch(c){I.warn("Error watching TURN servers",c)}finally{e.lifecycle.signal.removeEventListener("abort",n)}})()}};o(nE,"RoomWidgetClient");let $c=nE;function F0(r){throw r instanceof Mr.WidgetApiResponseError&&r.data.matrix_api_error?ft.fromWidgetApiErrorData(r.data.matrix_api_error):r}o(F0,"processAndThrow");function sn(r){throw r instanceof Error&&r.message==="Request timed out"?new zn("widget api timeout"):r}o(sn,"timeoutToConnectionError");const iE=class iE{constructor(){f(this,"unthreadedReadReceipts",new Map),f(this,"threadedReadReceipts",new Yr(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e==null||e.forEach(t=>{t.type!==F.Receipt||!t.content||Object.keys(t.content).forEach(n=>{Object.entries(t.content[n]).forEach(i=>{var[a,s]=i;if(Qg(a))for(var l of Object.keys(s)){var u=t.content[n][a][l],d={data:t.content[n][a][l],type:a,eventId:n};u.thread_id?this.setThreaded(u.thread_id,l,d):this.setUnthreaded(l,d)}})})})}buildAccumulatedReceiptEvent(e){var t={type:F.Receipt,room_id:e,content:{}},n=new Yr(()=>new Yr(()=>new Map));for(var[i,a]of this.allUnthreaded())n.getOrCreate(a.eventId).getOrCreate(a.type).set(i,a.data);for(var[s,l]of this.allThreaded())n.getOrCreate(l.eventId).getOrCreate(l.type).set(s,l.data);return t.content=sa(n),n.size>0?t:null}};o(iE,"ReceiptAccumulator");let Fm=iE;var kn=function(r){return r.Invite="invite",r.Leave="leave",r.Join="join",r.Knock="knock",r}({});function JL(r){return"_localTs"in r&&r._localTs!==void 0}o(JL,"isTaggedEvent");const aE=class aE{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,f(this,"accountData",{}),f(this,"inviteRooms",{}),f(this,"knockRooms",{}),f(this,"joinRooms",{}),f(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(n=>{this.accumulateRoom(n,kn.Invite,e.rooms.invite[n],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(n=>{this.accumulateRoom(n,kn.Join,e.rooms.join[n],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(n=>{this.accumulateRoom(n,kn.Leave,e.rooms.leave[n],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(n=>{this.accumulateRoom(n,kn.Knock,e.rooms.knock[n],t)}))}accumulateRoom(e,t,n){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case kn.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,n);break;case kn.Knock:this.accumulateKnockState(e,n);break;case kn.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,n,i);break;case kn.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:I.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var n=this.inviteRooms[e];t.invite_state.events.forEach(i=>{for(var a=!1,s=0;s<n.invite_state.events.length;s++){var l=n.invite_state.events[s];l.type===i.type&&l.state_key==i.state_key&&(n.invite_state.events[s]=i,a=!0)}a||n.invite_state.events.push(i)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var n=this.knockRooms[e];t.knock_state.events.forEach(i=>{for(var a=!1,s=0;s<n.knock_state.events.length;s++){var l=n.knock_state.events[s];l.type===i.type&&l.state_key==i.state_key&&(n.knock_state.events[s]=i,a=!0)}a||n.knock_state.events.push(i)})}}accumulateJoinState(e,t){var n,i,a,s,l,u,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new Fm});var c=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(M=>{c._accountData[M.type]=M}),t.unread_notifications&&(c._unreadNotifications=t.unread_notifications),c._unreadThreadNotifications=(n=(i=t[Nl.stable])!==null&&i!==void 0?i:t[Nl.unstable])!==null&&n!==void 0?n:void 0,t.summary){var h,v,g,p="m.heroes",m="m.invited_member_count",w="m.joined_member_count",y=c._summary,S=t.summary;y[p]=(h=S[p])!==null&&h!==void 0?h:y[p],y[w]=(v=S[w])!==null&&v!==void 0?v:y[w],y[m]=(g=S[m])!==null&&g!==void 0?g:y[m]}if(c._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(c._timeline=[]),(s=t.state)===null||s===void 0||(s=s.events)===null||s===void 0||s.forEach(M=>{Yu(c._currentState,M)}),(l=t["org.matrix.msc4222.state_after"])===null||l===void 0||(l=l.events)===null||l===void 0||l.forEach(M=>{Yu(c._currentState,M)}),(u=t.timeline)===null||u===void 0||(u=u.events)===null||u===void 0||u.forEach((M,_)=>{var O;t["org.matrix.msc4222.state_after"]||Yu(c._currentState,M);var b;if(d)b=M;else{var j;b=Object.assign({},M),b.unsigned!==void 0&&(b.unsigned=Object.assign({},b.unsigned));var B=(j=M.unsigned)===null||j===void 0?void 0:j.age;B!==void 0&&(b._localTs=Date.now()-B)}c._timeline.push({event:b,token:_===0&&(O=t.timeline.prev_batch)!==null&&O!==void 0?O:null})}),c._timeline.length>this.opts.maxTimelineEntries){for(var T=c._timeline.length-this.opts.maxTimelineEntries,C=T;C<c._timeline.length;C++)if(c._timeline[C].token){c._timeline=c._timeline.slice(C,c._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(i=>{t.invite[i]=this.inviteRooms[i]}),Object.keys(this.knockRooms).forEach(i=>{t.knock[i]=this.knockRooms[i]}),Object.keys(this.joinRooms).forEach(i=>{var a=this.joinRooms[i],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:a._unreadNotifications,unread_thread_notifications:a._unreadThreadNotifications,summary:a._summary};Object.keys(a._accountData).forEach(v=>{s.account_data.events.push(a._accountData[v])});var l=a._receipts.buildAccumulatedReceiptEvent(i);l&&s.ephemeral.events.push(l),a._timeline.forEach(v=>{if(!s.timeline.prev_batch){if(!v.token)return;s.timeline.prev_batch=v.token}var g;!e&&JL(v.event)?(g=Object.assign({},v.event),g.unsigned!==void 0&&(g.unsigned=Object.assign({},g.unsigned)),delete g._localTs,g.unsigned=g.unsigned||{},g.unsigned.age=Date.now()-v.event._localTs):g=v.event,s.timeline.events.push(g)});for(var u=Object.create(null),d=s.timeline.events.length-1;d>=0;d--){var c=s.timeline.events[d];if(!(c.state_key===null||c.state_key===void 0)){var h=uu(c);h.unsigned&&(h.unsigned.prev_content&&(h.content=h.unsigned.prev_content),h.unsigned.prev_sender&&(h.sender=h.unsigned.prev_sender)),Yu(u,h)}}Object.keys(a._currentState).forEach(v=>{Object.keys(a._currentState[v]).forEach(g=>{var p=a._currentState[v][g];s["org.matrix.msc4222.state_after"].events.push(p),u[v]&&u[v][g]&&(p=u[v][g]),s.state.events.push(p)})}),t.join[i]=s});var n=[];return Object.keys(this.accountData).forEach(i=>{n.push(this.accountData[i])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}getNextBatchToken(){return this.nextBatch}};o(aE,"SyncAccumulator");let Wc=aE;function Yu(r,e){e.state_key===null||e.state_key===void 0||!e.type||(r[e.type]||(r[e.type]=Object.create(null)),r[e.type][e.state_key]=e)}o(Yu,"setState");var eC=function(r){return r[r.Blocked=-1]="Blocked",r[r.Unverified=0]="Unverified",r[r.Verified=1]="Verified",r}({});const sE=class sE{constructor(e){f(this,"deviceId",void 0),f(this,"userId",void 0),f(this,"algorithms",void 0),f(this,"keys",void 0),f(this,"verified",void 0),f(this,"signatures",void 0),f(this,"displayName",void 0),f(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||eC.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}};o(sE,"Device");let Bm=sE;var B0=o(function(){},"debuglog"),QL=10;const oE=class oE{constructor(e,t){var n,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,f(this,"windowLimit",void 0),f(this,"start",void 0),f(this,"end",void 0),f(this,"eventCount",0),this.windowLimit=i.windowLimit||1e3,(n=t.room)===null||n===void 0||n.on(fe.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,n=o(i=>{if(!i)throw new Error("No timeline given to initFields");var a,s=i.getEvents();if(!e)a=s.length;else if(a=s.findIndex(d=>d.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var l=Math.min(s.length,a+Math.ceil(t/2)),u=Math.max(0,l-t);this.start=new Zl(i,u-i.getBaseIndex()),this.end=new Zl(i,l-i.getBaseIndex()),this.eventCount=l-u},"initFields");return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==me.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==me.FORWARDS){var n;return(n=this.end)!==null&&n!==void 0?n:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var n=this.getTimelineIndex(e);if(!n)return!1;var i=e==me.BACKWARDS?n.retreat(t):n.advance(t);if(i){this.eventCount+=i,B0("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=me.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,i){i&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==me.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var n=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return!!n||!!i}paginate(e,t){var n=arguments,i=this;return R(function*(){var a=n.length>2&&n[2]!==void 0?n[2]:!0,s=n.length>3&&n[3]!==void 0?n[3]:QL,l=i.getTimelineIndex(e);if(!l)return!1;if(l.pendingPaginate)return l.pendingPaginate;if(i.extend(e,t))return!0;if(!a||s===0)return!1;var u=l.timeline.getPaginationToken(e);if(!u)return!1;var d=i.client.paginateEventTimeline(l.timeline,{backwards:e==me.BACKWARDS,limit:t}).finally(function(){l.pendingPaginate=void 0}).then(c=>c?i.paginate(e,t,!0,s-1):i.paginate(e,t,!1,0));return l.pendingPaginate=d,d})()}unpaginate(e,t){var n=t?this.start:this.end;if(!n)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var i=t?n.advance(e):n.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,B0("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var n,i,a=t.getEvents(),s=0,l=a.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===((n=this.end)===null||n===void 0?void 0:n.timeline)&&(l=this.end.index+t.getBaseIndex());for(var u=s;u<l;u++)e.push(a[u]);if(t===((i=this.end)===null||i===void 0?void 0:i.timeline))break;t=t.getNeighbouringTimeline(me.FORWARDS)}return e}};o(oE,"TimelineWindow");let $m=oE;const lE=class lE{constructor(e,t){this.timeline=e,this.index=t,f(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?me.BACKWARDS:me.FORWARDS);return n?(this.timeline=n,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}};o(lE,"TimelineIndex");let Zl=lE;var Uo="m.login.email.identity",$0="m.login.msisdn",Wm=function(r){return r.Password="m.login.password",r.Recaptcha="m.login.recaptcha",r.Terms="m.login.terms",r.Email="m.login.email.identity",r.Msisdn="m.login.msisdn",r.Sso="m.login.sso",r.SsoUnstable="org.matrix.login.sso",r.Dummy="m.login.dummy",r.RegistrationToken="m.login.registration_token",r.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",r}({});const uE=class uE extends Error{constructor(e,t,n){super(e),this.required_stages=t,this.flows=n,f(this,"name","NoAuthFlowFoundError")}};o(uE,"NoAuthFlowFoundError");let Kc=uE;const dE=class dE{constructor(e){var t=this;f(this,"matrixClient",void 0),f(this,"inputs",void 0),f(this,"clientSecret",void 0),f(this,"requestCallback",void 0),f(this,"busyChangedCallback",void 0),f(this,"stateUpdatedCallback",void 0),f(this,"requestEmailTokenCallback",void 0),f(this,"supportedStages",void 0),f(this,"data",void 0),f(this,"emailSid",void 0),f(this,"requestingEmailToken",!1),f(this,"attemptAuthDeferred",null),f(this,"chosenFlow",null),f(this,"currentStage",null),f(this,"emailAttempt",1),f(this,"submitPromise",null),f(this,"requestEmailToken",R(function*(){if(t.requestingEmailToken)I.warn("Could not request email token: Already requesting");else{I.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var n=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=n.sid,I.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return R(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var n=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var i;(i=e.busyChangedCallback)===null||i===void 0||i.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var s;(s=e.busyChangedCallback)===null||s===void 0||s.call(e,!1)})}return n})()}poll(){var e=this;return R(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Uo&&e.emailSid){var n={sid:e.emailSid,client_secret:e.clientSecret},i=e.matrixClient.getIdentityServerUrl();i&&(n.id_server=new URL(i).host),t={type:Uo,threepid_creds:n}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return R(function*(){var i,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var s;(s=n.busyChangedCallback)===null||s===void 0||s.call(n,!0)}for(;n.submitPromise;)try{yield n.submitPromise}catch{}var l;(i=n.data)!==null&&i!==void 0&&i.session?l=Object.assign({session:n.data.session},e):l=e;try{n.submitPromise=n.doRequest(l,a),yield n.submitPromise}finally{if(n.submitPromise=null,!a){var u;(u=n.busyChangedCallback)===null||u===void 0||u.call(n,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return R(function*(){var i=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield n.requestCallback(e,i);n.attemptAuthDeferred.resolve(a),n.attemptAuthDeferred=null}catch(p){var s,l,u,d,c=p instanceof ft?p:null,h=(s=c==null||(l=c.data)===null||l===void 0?void 0:l.flows)!==null&&s!==void 0?s:null,v=((u=n.data)===null||u===void 0?void 0:u.flows)||!!h;if(!c||c.httpStatus!==401||!c.data||!v)if(i)I.log("Background poll request failed doing UI auth: ignoring",p);else{var g;(g=n.attemptAuthDeferred)===null||g===void 0||g.reject(p)}c&&!c.data&&(c.data={}),c&&!c.data.flows&&!c.data.completed&&!c.data.session&&(c.data.flows=n.data.flows,c.data.completed=n.data.completed,c.data.session=n.data.session),c&&(n.data=c.data);try{n.startNextAuthStage()}catch(m){n.attemptAuthDeferred.reject(m),n.attemptAuthDeferred=null;return}if(!n.emailSid&&(d=n.chosenFlow)!==null&&d!==void 0&&d.stages.includes(Wm.Email))try{yield n.requestEmailToken()}catch(m){n.attemptAuthDeferred.reject(m),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,n=this.chooseStage();if(!n)throw new Error("No incomplete flows from the server");if(this.currentStage=n,n===Wm.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var i,a;this.stateUpdatedCallback(n,{errcode:((i=this.data)===null||i===void 0?void 0:i.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(n,n===Uo?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),I.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return I.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(n=>!this.supportedStages.has(n)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],n=!!this.inputs.emailAddress||!!this.emailSid,i=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((c,h)=>this.scoreFlow(c)-this.scoreFlow(h));for(var a of t){var s=!1,l=!1;for(var u of a.stages)u===Uo?s=!0:u==$0&&(l=!0);if(s==n&&l==i)return a}var d=[];throw n&&d.push(Uo),i&&d.push($0),new Kc("No appropriate authentication flow found",d,t)}firstUncompletedStage(e){var t,n=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(i=>!n.includes(i))}};o(dE,"InteractiveAuth");let Km=dE;function tC(r,e){return new Promise((t,n)=>{var i=!0,a=r.open(e);a.onupgradeneeded=()=>{i=!1},a.onblocked=()=>n(a.error),a.onsuccess=()=>{var s=a.result;s.close(),i||r.deleteDatabase(e),t(i)},a.onerror=()=>n(a.error)})}o(tC,"exists");var rC=[r=>{r.createObjectStore("users",{keyPath:["userId"]}),r.createObjectStore("accountData",{keyPath:["type"]}),r.createObjectStore("sync",{keyPath:["clobber"]})},r=>{var e=r.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},r=>{r.createObjectStore("client_options",{keyPath:["clobber"]})},r=>{r.createObjectStore("to_device_queue",{autoIncrement:!0})}],YL=rC.length;function Xu(r,e,t){var n=r.openCursor(e);return new Promise((i,a)=>{var s=[];n.onerror=()=>{var l;a(new Error("Query failed: "+((l=n.error)===null||l===void 0?void 0:l.name)))},n.onsuccess=()=>{var l=n.result;if(!l){i(s);return}s.push(t(l)),l.continue()}})}o(Xu,"selectQuery");function Hi(r){return new Promise((e,t)=>{r.oncomplete=function(n){e(n)},r.onerror=function(){t(r.error)}})}o(Hi,"txnAsPromise");function nC(r){return new Promise((e,t)=>{r.onsuccess=function(n){e(n)},r.onerror=function(){t(r.error)}})}o(nC,"reqAsEventPromise");function XL(r){return new Promise((e,t)=>{r.onsuccess=()=>e(r),r.onerror=n=>t(n)})}o(XL,"reqAsPromise");function Vf(r){return nC(r).then(e=>r.result)}o(Vf,"reqAsCursorPromise");const cE=class cE{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),tC(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,f(this,"dbName",void 0),f(this,"syncAccumulator",void 0),f(this,"db",void 0),f(this,"disconnected",!0),f(this,"_isNewlyCreated",!1),f(this,"syncToDatabasePromise",void 0),f(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new Wc}connect(e){var t=this;if(!this.disconnected)return I.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,I.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,YL);return n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;I.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(s)),s<1&&(this._isNewlyCreated=!0),rC.forEach((l,u)=>{s<=u&&l(a)})},n.onblocked=()=>{I.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},I.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),nC(n).then(R(function*(){I.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var i;(i=t.db)===null||i===void 0||i.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e==null||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,n]=e;I.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:n.nextBatch,rooms:n.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,n)=>{var i=this.db.transaction(["oob_membership_events"],"readonly"),a=i.objectStore("oob_membership_events"),s=a.index("room"),l=IDBKeyRange.only(e),u=s.openCursor(l),d=[],c=!1;u.onsuccess=()=>{var h=u.result;if(!h)return!d.length&&!c?t(null):t(d);var v=h.value;v.oob_written?c=!0:d.push(v),h.continue()},u.onerror=h=>{n(h)}}).then(t=>(I.log("LL: got ".concat(t==null?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return R(function*(){I.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var i=n.db.transaction(["oob_membership_events"],"readwrite"),a=i.objectStore("oob_membership_events");t.forEach(l=>{a.put(l)});var s={room_id:e,oob_written:!0,state_key:0};a.put(s),yield Hi(i),I.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return R(function*(){var n=t.db.transaction(["oob_membership_events"],"readonly"),i=n.objectStore("oob_membership_events"),a=i.index("room"),s=IDBKeyRange.only(e),l=Vf(a.openKeyCursor(s,"next")).then(p=>(p==null?void 0:p.primaryKey)[1]),u=Vf(a.openKeyCursor(s,"prev")).then(p=>(p==null?void 0:p.primaryKey)[1]),[d,c]=yield Promise.all([l,u]),h=t.db.transaction(["oob_membership_events"],"readwrite"),v=h.objectStore("oob_membership_events"),g=IDBKeyRange.bound([e,d],[e,c]);I.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,d],[e,c]),yield XL(v.delete(g))})()}clearDatabase(){return new Promise(e=>{var t;I.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{I.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},n.onerror=()=>{var i;I.warn("unable to delete js-sdk store indexeddb: ".concat((i=n.error)===null||i===void 0?void 0:i.name)),e()},n.onsuccess=()=>{I.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(uu(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return R(function*(){return t.syncToDatabasePromise?(I.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return R(function*(){try{var n=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(n.accountData),t.persistSyncData(n.nextBatch,n.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return I.log("Persisting sync data up to",e),Ma(()=>{var n=this.db.transaction(["sync"],"readwrite"),i=n.objectStore("sync");return i.put({clobber:"-",nextBatch:e,roomsData:t}),Hi(n).then(()=>{I.log("Persisted sync data up to",e)})})}persistAccountData(e){return Ma(()=>{var t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(var i of e)n.put(i);return Hi(t).then()})}persistUserPresenceEvents(e){return Ma(()=>{var t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(var i of e)n.put({userId:i[0],event:i[1]});return Hi(t).then()})}getUserPresenceEvents(){return Ma(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return Xu(t,void 0,n=>[n.value.userId,n.value.event])})}loadAccountData(){return I.log("LocalIndexedDBStoreBackend: loading account data..."),Ma(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return Xu(t,void 0,n=>n.value).then(n=>(I.log("LocalIndexedDBStoreBackend: loaded account data"),n))})}loadSyncData(){return I.log("LocalIndexedDBStoreBackend: loading sync data..."),Ma(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return Xu(t,void 0,n=>n.value).then(n=>(I.log("LocalIndexedDBStoreBackend: loaded sync data"),n.length>1&&I.warn("loadSyncData: More than 1 sync row found."),n.length>0?n[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return Xu(t,void 0,n=>{var i;return(i=n.value)===null||i===void 0?void 0:i.options}).then(n=>n[0])})}storeClientOptions(e){var t=this;return R(function*(){var n=t.db.transaction(["client_options"],"readwrite"),i=n.objectStore("client_options");i.put({clobber:"-",options:e}),yield Hi(n)})()}saveToDeviceBatches(e){var t=this;return R(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");for(var a of e)i.add(a);yield Hi(n)})()}getOldestToDeviceBatch(){var e=this;return R(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),n=t.objectStore("to_device_queue"),i=yield Vf(n.openCursor());if(!i)return null;var a=i.value;return{id:i.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return R(function*(){var n=t.db.transaction(["to_device_queue"],"readwrite"),i=n.objectStore("to_device_queue");i.delete(e),yield Hi(n)})()}destroy(){var e=this;return R(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}};o(cE,"LocalIndexedDBStoreBackend");let Vc=cE;const hE=class hE{constructor(e,t){this.workerFactory=e,this.dbName=t,f(this,"worker",void 0),f(this,"nextSeq",0),f(this,"inFlight",{}),f(this,"startPromise",void 0),f(this,"onWorkerMessage",n=>{var i=n.data;if(i.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(i.command=="cmd_success"||i.command=="cmd_fail"){if(i.seq===void 0){I.error("Got reply from worker with no seq");return}var s=this.inFlight[i.seq];if(s===void 0){I.error("Got reply for unknown seq "+i.seq);return}if(delete this.inFlight[i.seq],i.command=="cmd_success")s.resolve(i.result);else{var l=new Error(i.error.message);l.name=i.error.name,s.reject(l)}}else I.warn("Unrecognised message from worker: ",i)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return R(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return R(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return R(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{I.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var n,i=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[i]=a,(n=this.worker)===null||n===void 0||n.postMessage({command:e,seq:i,args:t}),a.promise})}destroy(){var e=this;return R(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}};o(hE,"RemoteIndexedDBStoreBackend");let Vm=hE;var ZL=1e3*60*5;const fE=class fE extends Ql{static exists(e,t){return Vc.exists(e,t)}constructor(e){if(super(e),f(this,"backend",void 0),f(this,"startedUp",!1),f(this,"syncTs",0),f(this,"userModifiedMap",{}),f(this,"emitter",new Qe),f(this,"onClose",()=>{this.emitter.emit("closed")}),f(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),f(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),f(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),f(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{I.log("Deleted indexeddb data.")},t=>{throw I.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),f(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var n of this.getUsers())this.userModifiedMap[n.userId]!==n.getLastModifiedTime()&&n.events.presence&&(t.push([n.userId,n.events.presence.event]),this.userModifiedMap[n.userId]=n.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),f(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),f(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),f(this,"setOutOfBandMembers",this.degradable((t,n)=>(super.setOutOfBandMembers(t,n),this.backend.setOutOfBandMembers(t,n)),"setOutOfBandMembers")),f(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),f(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),f(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Vm(e.workerFactory,e.dbName):this.backend=new Vc(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(I.log("IndexedDBStore.startup: already started"),Promise.resolve()):(I.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(I.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{I.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[n,i]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(n);i&&a.setPresenceEvent(new Ht(i)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>ZL}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,i=t?super[t]:null;return R(function*(){for(var a=arguments.length,s=new Array(a),l=0;l<a;l++)s[l]=arguments[l];try{return yield e.call(n,...s)}catch(u){I.error("IndexedDBStore failure, degrading to MemoryStore",u),n.emitter.emit("degraded",u);try{I.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),I.log("IndexedDBStore delete after degrading succeeded")}catch(d){I.warn("IndexedDBStore delete after degrading failed",d)}if(i)return i.call(n,...s)}})}getPendingEvents(e){var t=o(()=>super.getPendingEvents,"_superprop_getGetPendingEvents"),n=this;return R(function*(){if(!n.localStorage)return t().call(n,e);var i=n.localStorage.getItem(Gf(e));if(i)try{return JSON.parse(i)}catch(a){I.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var n=o(()=>super.setPendingEvents,"_superprop_getSetPendingEvents"),i=this;return R(function*(){if(!i.localStorage)return n().call(i,e,t);t.length>0?i.localStorage.setItem(Gf(e),JSON.stringify(t)):i.localStorage.removeItem(Gf(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}};o(fE,"IndexedDBStore");let Gc=fE;function Gf(r){return"mx_pending_events_".concat(r)}o(Gf,"pendingEventsKey");var Zr="crypto.",W0=Zr+"migration",qf=Zr+"account",eU=Zr+"cross_signing_keys",Td=Zr+"inboundgroupsessions/",tU=Zr+"inboundgroupsessions.withheld/",rU=Zr+"rooms/",Hf=Zr+"sessionsneedingbackup";function Ua(r){return Zr+"sessions/"+r}o(Ua,"keyEndToEndSessions");function zf(r,e){return Td+r+"/"+e}o(zf,"keyEndToEndInboundGroupSession");function nU(r,e){return tU+r+"/"+e}o(nU,"keyEndToEndInboundGroupSessionWithheld");function iU(r){return rU+r}o(iU,"keyEndToEndRoomsPrefix");const rh=class rh extends Qs{static exists(e){for(var t=e.length,n=0;n<t;n++){var i;if((i=e.key(n))!==null&&i!==void 0&&i.startsWith(Zr))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return R(function*(){return rh.exists(e.store)})()}getMigrationState(){var e=this;return R(function*(){var t;return(t=Pr(e.store,W0))!==null&&t!==void 0?t:zs.NOT_STARTED})()}setMigrationState(e){var t=this;return R(function*(){zi(t.store,W0,e)})()}countEndToEndSessions(e,t){for(var n=0,i=0;i<this.store.length;++i){var a=this.store.key(i);if(a!=null&&a.startsWith(Ua(""))){var s=Pr(this.store,a);n+=Object.keys(s??{}).length}}t(n)}_getEndToEndSessions(e){var t=Pr(this.store,Ua(e)),n={};for(var[i,a]of Object.entries(t||{}))typeof a=="string"?n[i]={session:a}:n[i]=a;return n}getEndToEndSession(e,t,n,i){var a,s=this._getEndToEndSessions(e);i((a=s[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,n){var i;n((i=this._getEndToEndSessions(e))!==null&&i!==void 0?i:{})}storeEndToEndSession(e,t,n,i){var a=this._getEndToEndSessions(e)||{};a[t]=n,zi(this.store,Ua(e),a)}getEndToEndSessionsBatch(){var e=this;return R(function*(){for(var t=[],n=0;n<e.store.length;++n){var i;if((i=e.store.key(n))!==null&&i!==void 0&&i.startsWith(Ua(""))){var a=e.store.key(n).split("/")[1];for(var s of Object.values(e._getEndToEndSessions(a)))if(t.push(s),t.length>=Js)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){for(var{deviceKey:n,sessionId:i}of e){var a=t._getEndToEndSessions(n)||{};delete a[i],Object.keys(a).length===0?t.store.removeItem(Ua(n)):zi(t.store,Ua(n),a)}})()}getEndToEndInboundGroupSession(e,t,n,i){i(Pr(this.store,zf(e,t)),Pr(this.store,nU(e,t)))}storeEndToEndInboundGroupSession(e,t,n,i){zi(this.store,zf(e,t),n)}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){for(var t=0,n=0;n<e.store.length;++n){var i=e.store.key(n);i!=null&&i.startsWith(Td)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){for(var t=Pr(e.store,Hf)||{},n=[],i=0;i<e.store.length;++i){var a=e.store.key(i);if(a!=null&&a.startsWith(Td)){var s=a.slice(Td.length);if(n.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:Pr(e.store,a),needsBackup:s in t}),n.length>=Js)return n}}return n.length===0?null:n})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){for(var{senderKey:n,sessionId:i}of e){var a=zf(n,i);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var n={},i=iU(""),a=0;a<this.store.length;++a){var s=this.store.key(a);if(s!=null&&s.startsWith(i)){var l=s.slice(i.length);n[l]=Pr(this.store,s)}}t(n)}markSessionsNeedingBackup(e){var t=Pr(this.store,Hf)||{};for(var n of e)t[n.senderKey+"/"+n.sessionId]=!0;return zi(this.store,Hf,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(qf),Promise.resolve()}getAccount(e,t){var n=Pr(this.store,qf);t(n)}storeAccount(e,t){zi(this.store,qf,t)}getCrossSigningKeys(e,t){var n=Pr(this.store,eU);t(n)}getSecretStorePrivateKey(e,t,n){var i=Pr(this.store,Zr+"ssss_cache.".concat(n));t(i)}storeSecretStorePrivateKey(e,t,n){zi(this.store,Zr+"ssss_cache.".concat(t),n)}doTxn(e,t,n){return Promise.resolve(n(null))}};o(rh,"LocalStorageCryptoStore");let qc=rh;function Pr(r,e){try{return JSON.parse(r.getItem(e))}catch(t){I.log("Error: Failed to get key %s: %s",e,t.message),I.log(t.stack)}return null}o(Pr,"getJsonItem");function zi(r,e,t){r.setItem(e,JSON.stringify(t))}o(zi,"setJsonItem");const vE=class vE{constructor(e){this.db=e,f(this,"nextTxnId",0),e.onversionchange=()=>{I.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return R(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return R(function*(){return e})()}deleteAllData(){return R(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return R(function*(){var t=zs.NOT_STARTED;return yield e.doTxn("readonly",[Ke.STORE_ACCOUNT],n=>{var i=n.objectStore(Ke.STORE_ACCOUNT),a=i.get(Yv);a.onsuccess=()=>{var s;t=(s=a.result)!==null&&s!==void 0?s:zs.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Ke.STORE_ACCOUNT],n=>{var i=n.objectStore(Ke.STORE_ACCOUNT);i.put(e,Yv)})})()}getAccount(e,t){var n=e.objectStore("account"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){sr(e,a)}}}storeAccount(e,t){var n=e.objectStore("account");n.put(t,"-")}getCrossSigningKeys(e,t){var n=e.objectStore("account"),i=n.get("crossSigningKeys");i.onsuccess=function(){try{t(i.result||null)}catch(a){sr(e,a)}}}getSecretStorePrivateKey(e,t,n){var i=e.objectStore("account"),a=i.get("ssss_cache:".concat(n));a.onsuccess=function(){try{t(a.result||null)}catch(s){sr(e,s)}}}storeSecretStorePrivateKey(e,t,n){var i=e.objectStore("account");i.put(n,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var n=e.objectStore("sessions"),i=n.count();i.onsuccess=function(){try{t(i.result)}catch(a){sr(e,a)}}}getEndToEndSessions(e,t,n){var i=t.objectStore("sessions"),a=i.index("deviceKey"),s=a.openCursor(e),l={};s.onsuccess=function(){var u=s.result;if(u)l[u.value.sessionId]={session:u.value.session,lastReceivedMessageTs:u.value.lastReceivedMessageTs},u.continue();else try{n(l)}catch(d){sr(t,d)}}}getEndToEndSession(e,t,n,i){var a=n.objectStore("sessions"),s=a.get([e,t]);s.onsuccess=function(){try{s.result?i({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):i(null)}catch(l){sr(n,l)}}}storeEndToEndSession(e,t,n,i){var a=i.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Ke.STORE_SESSIONS],n=>{var i=n.objectStore(Ke.STORE_SESSIONS),a=i.openCursor();a.onsuccess=function(){try{var s=a.result;s&&(t.push(s.value),t.length<Js&&s.continue())}catch(l){sr(n,l)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Ke.STORE_SESSIONS],function(){var n=R(function*(i){try{var a=i.objectStore(Ke.STORE_SESSIONS),s=o(function*(){var c=a.delete([l,u]);yield new Promise(h=>{c.onsuccess=h})},"_loop");for(var{deviceKey:l,sessionId:u}of e)yield*s()}catch(d){sr(i,d)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,n,i){var a=!1,s=!1,l=n.objectStore("inbound_group_sessions"),u=l.get([e,t]);u.onsuccess=function(){try{u.result?a=u.result.session:a=null,s!==!1&&i(a,s)}catch(h){sr(n,h)}};var d=n.objectStore("inbound_group_sessions_withheld"),c=d.get([e,t]);c.onsuccess=function(){try{c.result?s=c.result.session:s=null,a!==!1&&i(a,s)}catch(h){sr(n,h)}}}storeEndToEndInboundGroupSession(e,t,n,i){var a=i.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:n})}countEndToEndInboundGroupSessions(){var e=this;return R(function*(){var t=0;return yield e.doTxn("readonly",[Ke.STORE_INBOUND_GROUP_SESSIONS],n=>{var i=n.objectStore(Ke.STORE_INBOUND_GROUP_SESSIONS),a=i.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return R(function*(){var t=[];return yield e.doTxn("readonly",[Ke.STORE_INBOUND_GROUP_SESSIONS,Ke.STORE_BACKUP],n=>{var i=n.objectStore(Ke.STORE_INBOUND_GROUP_SESSIONS),a=n.objectStore(Ke.STORE_BACKUP),s=i.openCursor();s.onsuccess=function(){try{var l=s.result;if(l){var u=a.get(l.key);u.onsuccess=()=>{t.push({senderKey:l.value.senderCurve25519Key,sessionId:l.value.sessionId,sessionData:l.value.session,needsBackup:u.result!==void 0}),t.length<Js&&l.continue()}}}catch(d){sr(n,d)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return R(function*(){yield t.doTxn("readwrite",[Ke.STORE_INBOUND_GROUP_SESSIONS],function(){var n=R(function*(i){try{var a=i.objectStore(Ke.STORE_INBOUND_GROUP_SESSIONS),s=o(function*(){var c=a.delete([l,u]);yield new Promise(h=>{c.onsuccess=h})},"_loop2");for(var{senderKey:l,sessionId:u}of e)yield*s()}catch(d){sr(i,d)}});return function(i){return n.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var n=e.objectStore("device_data"),i=n.get("-");i.onsuccess=function(){try{t(i.result||null)}catch(a){sr(e,a)}}}getEndToEndRooms(e,t){var n={},i=e.objectStore("rooms"),a=i.openCursor();a.onsuccess=function(){var s=a.result;if(s)n[s.key]=s.value,s.continue();else try{t(n)}catch(l){sr(e,l)}}}markSessionsNeedingBackup(e,t){var n=this;return R(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var i=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((s,l)=>{var u=i.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});u.onsuccess=s,u.onerror=l})))})()}doTxn(e,t,n){var i=this.db.transaction(t,e),a=oU(i),s=n(i);return a.then(()=>s)}};o(vE,"Backend");let Gm=vE;var iC=[r=>{sU(r)},r=>{r.createObjectStore("account")},r=>{var e=r.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},r=>{r.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("device_data")},r=>{r.createObjectStore("rooms")},r=>{r.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{var e=r.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),r.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},r=>{r.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r=>{r.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],aC=iC.length;function aU(r,e){I.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(aC)),iC.forEach((t,n)=>{e<=n&&t(r)})}o(aU,"upgradeDatabase");function sU(r){var e=r.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}o(sU,"createDatabase");function sr(r,e){r._mx_abortexception=e;try{r.abort()}catch{}}o(sr,"abortWithException");function oU(r){return new Promise((e,t)=>{r.oncomplete=()=>{r._mx_abortexception!==void 0&&t(r._mx_abortexception),e(null)},r.onerror=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(I.log("Error performing indexeddb txn",n),t(r.error))},r.onabort=n=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(I.log("Error performing indexeddb txn",n),t(r.error))}})}o(oU,"promiseifyTxn");const fi=class fi{static exists(e,t){return tC(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((n,i)=>{var a=!0,s=e.open(t);s.onupgradeneeded=()=>{a=!1},s.onblocked=()=>i(s.error),s.onsuccess=()=>{var l=s.result;if(!a)l.close(),e.deleteDatabase(t),n(!1);else{var u=l.transaction([fi.STORE_ACCOUNT],"readonly"),d=u.objectStore(fi.STORE_ACCOUNT),c=d.get(Yv);c.onsuccess=()=>{var h,v=(h=c.result)!==null&&h!==void 0?h:zs.NOT_STARTED;n(v===zs.NOT_STARTED)},c.onerror=()=>{i(c.error)},l.close()}},s.onerror=()=>i(s.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,f(this,"backendPromise",void 0),f(this,"backend",void 0)}containsData(){var e=this;return R(function*(){return fi.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}I.log("connecting to indexeddb ".concat(this.dbName));var n=this.indexedDB.open(this.dbName,aC);n.onupgradeneeded=i=>{var a=n.result,s=i.oldVersion;aU(a,s)},n.onblocked=()=>{I.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{I.log("Error connecting to indexeddb",i),t(n.error)},n.onsuccess=()=>{var i=n.result;I.log("connected to indexeddb ".concat(this.dbName)),e(new Gm(i))}}).then(e=>e.doTxn("readonly",[fi.STORE_INBOUND_GROUP_SESSIONS,fi.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw I.warn("Crypto DB is too new for us to use!",e),new Gl(dy.TooNew);I.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new qc(globalThis.localStorage)}catch(t){return I.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new Qs}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}I.log("Removing indexeddb instance: ".concat(this.dbName));var n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{I.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=i=>{I.log("Error deleting data from indexeddb",i),t(n.error)},n.onsuccess=()=>{I.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{I.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,n){this.backend.getSecretStorePrivateKey(e,t,n)}storeSecretStorePrivateKey(e,t,n){this.backend.storeSecretStorePrivateKey(e,t,n)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,n,i){this.backend.getEndToEndSession(e,t,n,i)}getEndToEndSessions(e,t,n){this.backend.getEndToEndSessions(e,t,n)}storeEndToEndSession(e,t,n,i){this.backend.storeEndToEndSession(e,t,n,i)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,n,i){this.backend.getEndToEndInboundGroupSession(e,t,n,i)}storeEndToEndInboundGroupSession(e,t,n,i){this.backend.storeEndToEndInboundGroupSession(e,t,n,i)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,n,i){return this.backend.doTxn(e,t,n,i)}};o(fi,"IndexedDBCryptoStore");let Ke=fi;f(Ke,"STORE_ACCOUNT","account");f(Ke,"STORE_SESSIONS","sessions");f(Ke,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");f(Ke,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");f(Ke,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");f(Ke,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");f(Ke,"STORE_DEVICE_DATA","device_data");f(Ke,"STORE_ROOMS","rooms");f(Ke,"STORE_BACKUP","sessions_needing_backup");var lU=function(r){return r.Email="email",r.Phone="msisdn",r}({}),uU=new gt("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),dU=function(r){return r.Gitlab="gitlab",r.Github="github",r.Apple="apple",r.Google="google",r.Facebook="facebook",r.Twitter="twitter",r}({}),cU=function(r){return r.LOGIN="login",r.REGISTER="register",r}({}),hU="us.cloke.msc4175.tz";const pE=class pE{constructor(e){f(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(n=>n.on(e,t))}off(e,t){this.relations.forEach(n=>n.off(e,t))}};o(pE,"RelatedRelations");let qm=pE;var fU=function(r){return r.Global="Global",r.SetItemError="setItem",r.GetItemError="getItem",r.RemoveItemError="removeItem",r.ClearError="clear",r.QuotaExceededError="QuotaExceededError",r}({});const mE=class mE extends Qe{};o(mE,"LocalStorageErrorsEventsEmitter");let Hm=mE;var vU=new Hm,sC=o(()=>new Qs,"cryptoStoreFactory");function oC(r){sC=r}o(oC,"setCryptoStoreFactory");function lC(r){var e,t,n;return r.store=(e=r.store)!==null&&e!==void 0?e:new Ql({localStorage:globalThis.localStorage}),r.scheduler=(t=r.scheduler)!==null&&t!==void 0?t:new Vl,r.cryptoStore=(n=r.cryptoStore)!==null&&n!==void 0?n:sC(),r}o(lC,"amendClientOpts");function zm(r){return new to(lC(r))}o(zm,"createClient");function pU(r,e,t,n){var i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new $c(r,e,t,lC(n),i)}o(pU,"createRoomWidgetClient");const mU=Object.freeze(Object.defineProperty({__proto__:null,AuthType:Wm,AutoDiscovery:wt,AutoDiscoveryAction:br,AutoDiscoveryError:Br,Beacon:pc,BeaconEvent:Ze,CallEvent:xe,CallFeedEvent:ln,Category:kn,ClientEvent:ve,ClientPrefix:It,ClientStoppedError:Tm,ConditionKind:Et,ConditionOperator:Y1,ConnectionError:zn,ContentHelpers:KD,DELEGATED_OIDC_COMPATIBILITY:uU,DEVICE_CODE_SCOPE:YN,DMMemberCountCondition:X1,DebugLogger:Zv,Device:Bm,DeviceVerification:eC,Direction:Me,DuplicateStrategy:il,EVENT_VISIBILITY_CHANGE_TYPE:oa,EventEmitterEvents:DR,EventStatus:we,EventTimeline:me,EventTimelineSet:Si,EventType:F,FILTER_RELATED_BY_REL_TYPES:vs,FILTER_RELATED_BY_SENDERS:fs,FeatureSupport:Vt,Filter:lr,GET_LOGIN_TOKEN_CAPABILITY:rL,GroupCall:Bl,GroupCallEvent:ze,GroupCallIntent:II,GroupCallState:at,GroupCallStatsReportEvent:Ko,GroupCallType:xh,GuestAccess:Cc,HTTPError:Hn,HistoryVisibility:ly,HttpApiEvent:Dp,IdentityPrefix:On,IdentityProviderBrand:dU,IndexedDBCryptoStore:Ke,IndexedDBStore:Gc,InteractiveAuth:Km,InvalidCryptoStoreError:Gl,InvalidCryptoStoreState:dy,JoinRule:CI,KNOWN_SAFE_ROOM_VERSION:pI,KeySignatureUploadError:wm,KnownMembership:ke,LOCAL_NOTIFICATION_SETTINGS_PREFIX:jR,LocalStorageCryptoStore:qc,LocalStorageErrors:fU,LocationAssetType:qs,MAIN_ROOM_TIMELINE:lu,MAXIMUM_MATRIX_VERSION:aN,MINIMUM_MATRIX_VERSION:iN,MSC3912_RELATION_BASED_REDACTIONS_PROP:np,M_ASSET:su,M_BEACON:pm,M_BEACON_INFO:uy,M_HTML:LD,M_LOCATION:ou,M_MESSAGE:ND,M_POLL_END:gc,M_POLL_KIND_DISCLOSED:GD,M_POLL_KIND_UNDISCLOSED:qD,M_POLL_RESPONSE:Ll,M_POLL_START:HD,M_TEXT:Xg,M_TIMESTAMP:$i,M_TOPIC:Zg,MatrixClient:to,MatrixError:ft,MatrixEvent:Ht,MatrixEventEvent:We,MatrixHttpApi:_c,MatrixScheduler:Vl,MediaHandlerEvent:Zi,MediaPrefix:ds,MemoryCryptoStore:Qs,MemoryStore:Ql,Method:G,MsgType:Rn,NoAuthFlowFoundError:Kc,NotificationCountType:Be,OidcError:qt,OidcTokenRefresher:Lm,PUSHER_DEVICE_ID:iA,PUSHER_ENABLED:ip,PendingEventOrdering:eo,Poll:yc,PollEvent:ci,Preset:oy,ProfileKeyMSC4175Timezone:hU,PushRuleActionName:Pi,PushRuleKind:Dt,REFERENCE_RELATION:XR,ReceiptType:er,RelatedRelations:qm,RelationType:tt,Relations:Dl,RelationsEvent:gd,RestrictedAllowType:oN,Room:Ys,RoomCreateTypeField:rc,RoomEvent:fe,RoomMember:Ea,RoomMemberEvent:cr,RoomNameType:on,RoomState:Jl,RoomStateEvent:De,RoomSummary:dc,RoomType:ls,RoomVersionStability:vI,RoomWidgetClient:$c,RoomWidgetClientEvent:wd,RuleId:At,SERVICE_TYPES:sm,SSOAction:cU,SUPPORTED_MATRIX_VERSIONS:Kl,SearchOrderBy:OI,SearchResult:Ic,SecretStorage:EN,ServerCapabilities:bc,SetPresence:mI,SlidingSyncEvent:um,StatsReport:jn,SyncAccumulator:Wc,SyncState:Ve,THREAD_RELATION_TYPE:qe,Thread:_t,ThreadEvent:tr,ThreadFilterType:Vr,ThreepidMedium:lU,TimelineIndex:Zl,TimelineWindow:$m,ToDeviceMessageId:Ch,TokenRefreshError:Ec,TokenRefreshLogoutError:Ul,TweakName:ay,TypedEventEmitter:Qe,UNSIGNED_MEMBERSHIP_FIELD:FR,UNSIGNED_THREAD_ID_FIELD:nc,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:UR,UNSTABLE_MSC2666_MUTUAL_ROOMS:qI,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:HI,UNSTABLE_MSC2666_SHARED_ROOMS:GI,UNSTABLE_MSC2716_MARKER:LR,UNSTABLE_MSC3088_ENABLED:tp,UNSTABLE_MSC3088_PURPOSE:ep,UNSTABLE_MSC3089_BRANCH:xn,UNSTABLE_MSC3089_LEAF:NR,UNSTABLE_MSC3089_TREE_SUBTYPE:rp,UNSTABLE_MSC3852_LAST_SEEN_UA:tL,UNSTABLE_MSC4133_EXTENDED_PROFILES:zI,UNSTABLE_MSC4140_DELAYED_EVENTS:vn,UnsupportedDelayedEventsEndpointError:gn,UpdateDelayedEventAction:yd,User:Wn,UserEvent:Er,Visibility:sN,anySignal:hI,calculateRetryBackoff:fI,completeAuthorizationCodeGrant:QN,createClient:zm,createNewMatrixCall:$l,createRoomWidgetClient:pU,decodeBase64:ha,decodeIdToken:$I,determineFeatureSupport:_d,discoverAndValidateOIDCIssuerWellKnown:py,encodeBase64:al,encodeUnpaddedBase64:RI,encodeUnpaddedBase64Url:Ah,fixNotificationCountOnDecryption:JI,generateAuthorizationParams:qN,generateAuthorizationUrl:HN,generateOidcAuthorizationUrl:zN,generateScope:Lh,getBeaconInfoIdentifier:vc,getHttpUriForMxc:Th,inMainTimelineForReceipt:zl,isDmMemberCountCondition:Z1,isEventTypeSame:UD,isPollEvent:dI,isTimestampInDuration:Ip,localStorageErrorsEventsEmitter:vU,parseErrorResponse:ry,registerOidcClient:XN,retryNetworkOperation:Np,safeGetRetryAfterMs:ty,setCryptoStoreFactory:oC,threadFilterTypeToFilter:QI,threadIdForReceipt:ro,timeoutSignal:Mh,validateAuthMetadata:BI,validateAuthMetadataAndKeys:my,validateBearerTokenResponse:VI,validateIdToken:WI,validateStoredUserState:KI},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var Jm;try{Jm=globalThis.indexedDB}catch{}Jm&&oC(()=>new Ke(Jm,"matrix-js-sdk:crypto"));globalThis.matrixcs=mU;function gU(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch{return e}}o(gU,"readJSON");function yU(){const r=(window.location.hash||"").match(/#\/org\/([^/]+)/i);return r?decodeURIComponent(r[1]):null}o(yU,"parseOrgIdFromHash");const SU=o(()=>new Date().toLocaleTimeString(),"ts");function EU(){const e=lo().orgId||yU(),t=gU(`bf_matrix_${e}`,null),[n,i]=$.useState(""),[a,s]=$.useState(""),[l,u]=$.useState(""),[d,c]=$.useState((t==null?void 0:t.userId)||""),[h,v]=$.useState((t==null?void 0:t.accessToken)||""),[g,p]=$.useState((t==null?void 0:t.deviceId)||""),[m,w]=$.useState(""),[y,S]=$.useState(!1),[T,C]=$.useState(!1),[M,_]=$.useState(null),[O,b]=$.useState(null),[j,B]=$.useState(""),[q,oe]=$.useState([]),[de,Ne]=$.useState(null),[Oe,Ae]=$.useState([]),[ae,X]=$.useState(""),ue=$.useRef(null),ge=$.useRef(null),Ce=o((...Q)=>w(`[${SU()}] ${Q.join(" ")}`),"log"),J=o((Q,z)=>`bf_mx_store_${Q}_${z||"nodev"}`,"storeDbName"),ee=o((Q,z)=>`bf_mx_crypto_${Q}_${z||"nodev"}`,"cryptoDbName");$.useEffect(()=>{if(!(t!=null&&t.hsUrl)||!d||!h)return;const Q=t.hsUrl,z=new Gc({indexedDB:window.indexedDB,localStorage:window.localStorage,dbName:J(d,g)}),Te=new Ke(window.indexedDB,ee(d,g)),ce=zm({baseUrl:Q,accessToken:h,userId:d,deviceId:g||void 0,store:z,cryptoStore:Te});return ue.current=ce,Ce("Connecting"),(async()=>{try{await z.startup()}catch(pe){Ce("Store startup failed:",(pe==null?void 0:pe.message)||pe)}try{typeof ce.initRustCrypto=="function"?(await ce.initRustCrypto(),C(!0)):typeof ce.initCrypto=="function"?(await ce.initCrypto(),C(!0)):(C(!1),Ce("Crypto init not available on this build"))}catch(pe){C(!1),Ce("Crypto init failed:",(pe==null?void 0:pe.message)||pe)}ce.on("sync",pe=>{pe==="PREPARED"&&(S(!0),te())}),ce.on(Ct.VerificationRequestReceived,pe=>{var be;_(pe),b(null),B(""),Ce("Verification request from",pe.otherUserId,pe.otherDeviceId),(be=pe.on)==null||be.call(pe,"change",()=>{try{const _e=pe.phase,le=typeof pe.isDone=="function"?pe.isDone():pe.done,je=typeof pe.isCancelled=="function"?pe.isCancelled():pe.cancelled;le||_e===4?(B("Verified "),setTimeout(()=>B(""),1200),b(null),_(null)):je&&(B("Cancelled"),setTimeout(()=>B(""),1200),b(null),_(null))}catch{}_(pe)})}),ce.on("Room.timeline",(pe,be,_e)=>{_e||!de||be.roomId!==de||pe.getType()==="m.room.message"&&Ae(le=>{var je,rn;return[...le,{id:pe.getId(),body:((je=pe.getContent())==null?void 0:je.body)||"",sender:pe.getSender(),ts:pe.getTs(),encrypted:!!((rn=pe.isEncrypted)!=null&&rn.call(pe))}]})}),ce.startClient({initialSyncLimit:30});function te(){const pe=ce.getVisibleRooms().filter(be=>["join","invite"].includes(be.getMyMembership())).sort((be,_e)=>(_e.getLastActiveTimestamp()||0)-(be.getLastActiveTimestamp()||0));oe(pe.map(be=>{var _e;return{id:be.roomId,name:be.name||be.getCanonicalAlias()||be.roomId,encrypted:(_e=be.isEncrypted)==null?void 0:_e.call(be)}}))}o(te,"refreshRooms")})(),()=>{try{ce.stopClient(),ce.removeAllListeners()}catch{}ue.current=null}},[t==null?void 0:t.hsUrl,d,h,g]);async function N(){const Q=M;if(Q)try{if(!fN(Q)){B("Cannot accept: request is already in progress.");return}await Q.accept(),B("Accepted. Now click Start SAS.")}catch(z){B((z==null?void 0:z.message)||String(z))}}o(N,"acceptVerification");async function D(){var z,Te,ce;const Q=M;if(Q)try{const te=await Q.startVerification("m.sas.v1");ge.current=te;const pe=o(async be=>{const _e=be!=null&&be.sas?be.sas:be;let le=null,je=null;try{if(Array.isArray(_e==null?void 0:_e.emoji))le=_e.emoji.map($t=>[$t.emoji||$t[0],$t.description||$t[1]]);else if(typeof(_e==null?void 0:_e.getEmoji)=="function"){const $t=await Promise.resolve(_e.getEmoji());Array.isArray($t)&&(le=$t.map(yt=>Array.isArray(yt)?[yt[0],yt[1]]:[yt==null?void 0:yt.emoji,(yt==null?void 0:yt.description)||(yt==null?void 0:yt.name)]))}}catch{}try{if(Array.isArray(_e==null?void 0:_e.decimal))je=_e.decimal;else if(typeof(_e==null?void 0:_e.getDecimal)=="function"){const $t=await Promise.resolve(_e.getDecimal());Array.isArray($t)&&(je=$t)}}catch{}const rn=(be==null?void 0:be.confirm)||(_e==null?void 0:_e.confirm),Zn=(be==null?void 0:be.mismatch)||(_e==null?void 0:_e.mismatch);b({emoji:le,decimal:je,confirm:rn,mismatch:Zn})},"handleShowSas");te.on(Uf.ShowSas,pe),te.on(Uf.Done,()=>{B("Verified "),setTimeout(()=>B(""),1200),b(null),_(null),ge.current=null}),te.on(Uf.Cancel,be=>{B(`Cancelled: ${(be==null?void 0:be.reason)||"unknown"}`),setTimeout(()=>B(""),1500),b(null),_(null),ge.current=null}),(z=te.on)==null||z.call(te,"show_sas",pe),(Te=te.on)==null||Te.call(te,"done",()=>{B("Verified "),setTimeout(()=>B(""),1200),b(null),_(null),ge.current=null}),(ce=te.on)==null||ce.call(te,"cancel",()=>{B("Cancelled"),setTimeout(()=>B(""),1500),b(null),_(null),ge.current=null}),await te.verify()}catch(te){B((te==null?void 0:te.message)||String(te))}}o(D,"startSas");async function A(){var Q;try{await((Q=O==null?void 0:O.confirm)==null?void 0:Q.call(O)),B("Confirmed. Waiting for other device"),window.setTimeout(()=>{B(z=>z!=null&&z.includes("Waiting")?"":z)},6e3)}catch(z){B((z==null?void 0:z.message)||String(z))}}o(A,"confirmSas");async function x(){const Q=d||(t==null?void 0:t.userId),z=g||(t==null?void 0:t.deviceId);try{localStorage.removeItem(`bf_matrix_${e}`)}catch{}try{const Te=new Set([J(Q,z),ee(Q,z),`bf_mx_store_${Q}`,`bf_mx_crypto_${Q}`]);for(const ce of Te)try{window.indexedDB.deleteDatabase(ce)}catch{}}catch{}k(),Ce("Matrix storage reset")}o(x,"resetMatrixStorage");async function P(){var Q;try{await((Q=O==null?void 0:O.mismatch)==null?void 0:Q.call(O))}catch(z){B((z==null?void 0:z.message)||String(z))}}o(P,"mismatchSas");const U=o(async Q=>{Q.preventDefault();try{const z=n.trim(),Te=a.trim(),te=await zm({baseUrl:z}).login("m.login.password",{identifier:{type:"m.id.user",user:Te},password:l});c(te.user_id),v(te.access_token),p(te.device_id||""),localStorage.setItem(`bf_matrix_${e}`,JSON.stringify({hsUrl:z,userId:te.user_id,accessToken:te.access_token,deviceId:te.device_id||""})),u(""),window.location.hash=window.location.hash}catch(z){Ce("Login failed:",(z==null?void 0:z.message)||"Unknown error")}},"login"),k=o(()=>{try{localStorage.removeItem(`bf_matrix_${e}`)}catch{}c(""),v(""),p(""),S(!1),C(!1),_(null),b(null),B(""),oe([]),Ae([]),X(""),ue.current&&(ue.current.stopClient(),ue.current.removeAllListeners(),ue.current=null),Ce("Logged out")},"logout"),W=o(async Q=>{var pe,be;Ne(Q),Ae([]);const z=ue.current;if(!z)return;const Te=z.getRoom(Q);if(!Te)return;const ce=(pe=Te.getLiveTimeline)==null?void 0:pe.call(Te),te=(((be=ce==null?void 0:ce.getEvents)==null?void 0:be.call(ce))||[]).filter(_e=>_e.getType()==="m.room.message");Ae(te.map(_e=>{var le,je;return{id:_e.getId(),body:((le=_e.getContent())==null?void 0:le.body)||"",sender:_e.getSender(),ts:_e.getTs(),encrypted:!!((je=_e.isEncrypted)!=null&&je.call(_e))}}))},"selectRoom"),L=o(async Q=>{Q.preventDefault();const z=ue.current;if(!(!z||!de||!ae.trim()))try{await z.sendEvent(de,"m.room.message",{msgtype:"m.text",body:ae.trim()},""),X("")}catch(Te){Ce("Send failed:",(Te==null?void 0:Te.message)||"Unknown error")}},"send"),K=!!(t!=null&&t.hsUrl&&d&&h),Z=$.useMemo(()=>q.find(Q=>Q.id===de)||null,[q,de]);return E.jsxs("div",{style:{maxWidth:1100,margin:"0 auto",padding:16},children:[E.jsxs("header",{style:{display:"flex",alignItems:"center",gap:8,marginTop:0,borderBottom:"1px solid #222",paddingBottom:12},children:[E.jsx("button",{className:"btn",onClick:k,children:"Logout"}),E.jsx("button",{className:"btn",onClick:x,children:"Reset Matrix storage"}),E.jsx("div",{className:"helper",style:{marginLeft:"auto"},children:m})]}),K&&E.jsxs("div",{className:"helper",style:{marginTop:8},children:[E.jsx("strong",{children:"Signed in as:"})," ",d,"  ",E.jsx("strong",{children:"Device:"})," ",g||"(loading)"," ",T?"":""]}),M&&E.jsxs("div",{className:"card",style:{padding:12,marginTop:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Verify this session (so Element stops judging you)"}),E.jsxs("div",{className:"helper",children:["From: ",M.otherUserId,"  ",M.otherDeviceId]}),O!=null&&O.emoji||O!=null&&O.decimal?E.jsxs(E.Fragment,{children:[O.emoji?E.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center",marginTop:12},children:O.emoji.map(([Q,z],Te)=>E.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:56},children:[E.jsx("div",{style:{fontSize:28,lineHeight:1},children:Q}),E.jsx("div",{style:{fontSize:11,opacity:.8},children:z})]},Te))}):E.jsxs("div",{className:"helper",style:{marginTop:12},children:["Code: ",Array.isArray(O.decimal)?O.decimal.join(" "):""]}),E.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[E.jsx("button",{className:"btn",onClick:A,children:"Confirm match"}),E.jsx("button",{className:"btn",onClick:P,children:"Doesnt match"})]})]}):E.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[E.jsx("button",{className:"btn",onClick:N,children:"Accept"}),E.jsx("button",{className:"btn",onClick:D,children:"Start SAS"})]}),j&&E.jsx("div",{className:"helper",style:{marginTop:8},children:j})]}),K?E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"280px 1fr",gap:12,marginTop:12},children:[E.jsxs("aside",{className:"card",style:{padding:12,minHeight:420},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Rooms"}),E.jsxs("ul",{style:{paddingLeft:18},children:[q.map(Q=>E.jsx("li",{children:E.jsxs("a",{href:"#",onClick:o(z=>{z.preventDefault(),W(Q.id)},"onClick"),children:[Q.name,Q.encrypted?" ":""]})},Q.id)),q.length===0&&E.jsx("li",{className:"helper",children:"No rooms yet."})]})]}),E.jsxs("main",{className:"card",style:{padding:12,minHeight:420,display:"flex",flexDirection:"column"},children:[E.jsxs("h3",{className:"section-title",style:{marginTop:0,marginBottom:8},children:[Z?Z.name:"Select a room",Z!=null&&Z.encrypted?" ":""]}),E.jsx("div",{style:{flex:1,overflow:"auto",border:"1px solid #222",borderRadius:8,padding:8},children:Oe.length===0?E.jsx("div",{className:"helper",children:"No messages yet."}):Oe.sort((Q,z)=>Q.ts-z.ts).map(Q=>E.jsxs("div",{style:{marginBottom:8},children:[E.jsxs("div",{style:{fontSize:12,color:"#6b7280"},children:[Q.sender,"  ",new Date(Q.ts).toLocaleString()," ",Q.encrypted?"":""]}),E.jsx("div",{children:Q.body})]},Q.id))}),E.jsxs("form",{onSubmit:L,className:"row",style:{gap:8,marginTop:8},children:[E.jsx("input",{className:"input",placeholder:Z?"Type a message":"Pick a room first",value:ae,onChange:o(Q=>X(Q.target.value),"onChange"),disabled:!Z}),E.jsx("button",{className:"btn",disabled:!Z||!ae.trim(),children:"Send"})]})]})]}):E.jsxs("section",{className:"card",style:{marginTop:12,padding:12},children:[E.jsx("h3",{className:"section-title",style:{marginTop:0},children:"Sign in to your Matrix homeserver"}),E.jsxs("form",{onSubmit:U,className:"grid",style:{gap:8,maxWidth:520},children:[E.jsx("input",{className:"input",placeholder:"Homeserver base URL (e.g. https://matrix.org)",value:n,onChange:o(Q=>i(Q.target.value),"onChange"),required:!0}),E.jsx("input",{className:"input",placeholder:"Username (localpart, without @ and domain)",value:a,onChange:o(Q=>s(Q.target.value),"onChange"),required:!0}),E.jsx("input",{className:"input",type:"password",placeholder:"Password",value:l,onChange:o(Q=>u(Q.target.value),"onChange"),required:!0}),E.jsx("button",{className:"btn",children:"Login"})]})]})]})}o(EU,"BondfireChat");function _U(){const r=oo(),e=Tn(),t=new URLSearchParams(e.search).get("next")||"/orgs",[n,i]=$.useState("login"),[a,s]=$.useState(""),[l,u]=$.useState(""),[d,c]=$.useState(""),[h,v]=$.useState(""),[g,p]=$.useState("Bondfire"),[m,w]=$.useState(""),[y,S]=$.useState(!1);async function T(M){var _,O;M.preventDefault(),w(""),S(!0);try{const B=await fetch(n==="register"?"/api/auth/register":"/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n==="register"?{email:a,password:l,name:h,orgName:g}:{email:a,password:l})}),q=await B.json().catch(()=>({}));if(!B.ok||!(q!=null&&q.ok)||!(q!=null&&q.token))throw new Error((q==null?void 0:q.error)||(n==="register"?"Register failed":"Login failed"));if(localStorage.setItem("bf_auth_token",q.token),sessionStorage.removeItem("bf_auth_token"),localStorage.removeItem("demo_user"),n==="register"&&((_=q==null?void 0:q.org)!=null&&_.id)){localStorage.setItem("bf_orgs",JSON.stringify([q.org])),r(`/org/${q.org.id}`,{replace:!0});return}const oe=(d||"").trim();if(oe){const Oe=await fetch("/api/invites/redeem",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${q.token}`},body:JSON.stringify({code:oe})}),Ae=await Oe.json().catch(()=>({}));if(!Oe.ok||!(Ae!=null&&Ae.ok))throw new Error((Ae==null?void 0:Ae.error)||"Invite code was not accepted");if((O=Ae==null?void 0:Ae.org)!=null&&O.id){r(`/org/${Ae.org.id}`,{replace:!0});return}}const de=await fetch("/api/orgs",{headers:{Authorization:`Bearer ${q.token}`}}),Ne=await de.json().catch(()=>({}));de.ok&&(Ne!=null&&Ne.ok)&&Array.isArray(Ne.orgs)&&localStorage.setItem("bf_orgs",JSON.stringify(Ne.orgs)),r("/orgs",{replace:!0})}catch(b){w(typeof b=="string"?b:(b==null?void 0:b.message)||"Auth failed")}finally{S(!1)}}o(T,"handleSubmit");function C(){localStorage.setItem("demo_user","true"),localStorage.removeItem("bf_auth_token"),r(t,{replace:!0})}return o(C,"handleDemo"),E.jsxs("div",{style:{maxWidth:520,margin:"8vh auto",padding:16},children:[E.jsx("h1",{style:{marginBottom:6},children:"Welcome to Bondfire"}),E.jsx("p",{className:"helper",style:{marginTop:0},children:n==="login"?"Sign in to continue, or try the demo mode.":"Create your account and your first org."}),E.jsxs("div",{style:{display:"flex",gap:8,marginTop:12},children:[E.jsx("button",{type:"button",className:n==="login"?"btn-red":"btn",onClick:o(()=>{w(""),i("login")},"onClick"),disabled:y,children:"Sign in"}),E.jsx("button",{type:"button",className:n==="register"?"btn-red":"btn",onClick:o(()=>{w(""),i("register")},"onClick"),disabled:y,children:"Create account"})]}),E.jsxs("form",{onSubmit:T,className:"grid",style:{gap:10,marginTop:12},children:[n==="register"&&E.jsxs(E.Fragment,{children:[E.jsx("input",{className:"input",type:"text",placeholder:"Name",value:h,onChange:o(M=>v(M.target.value),"onChange"),autoFocus:!0}),E.jsx("input",{className:"input",type:"text",placeholder:"Org name",value:g,onChange:o(M=>p(M.target.value),"onChange"),required:!0})]}),E.jsx("input",{className:"input",type:"email",placeholder:"Email",value:a,onChange:o(M=>s(M.target.value),"onChange"),required:!0,autoFocus:n==="login"}),E.jsx("input",{className:"input",type:"password",placeholder:"Password",value:l,onChange:o(M=>u(M.target.value),"onChange"),required:!0}),n==="login"&&E.jsx("input",{className:"input",type:"text",placeholder:"Invite code (optional)",value:d,onChange:o(M=>c(M.target.value),"onChange")}),E.jsx("button",{className:"btn",disabled:y,children:y?"Working":n==="login"?"Sign in":"Create account"})]}),m&&E.jsx("div",{className:"helper",style:{color:"tomato",marginTop:10},children:m}),E.jsx("div",{style:{marginTop:14,display:"flex",gap:8},children:E.jsx("button",{type:"button",className:"btn",onClick:C,disabled:y,children:"Continue as demo"})})]})}o(_U,"SignIn");function uC(){const{pathname:r=""}=Tn(),e=r.match(/\/org\/([^/]+)/i);return e?decodeURIComponent(e[1]):null}o(uC,"useOrgIdFromPath");const bU=o(({logoSrc:r="/logo-bondfire.png"})=>{const e=uC(),t=e?`/org/${e}/overview`:"/orgs";return E.jsxs(Jg,{to:t,className:"brand",style:{display:"flex",alignItems:"center",gap:10,textDecoration:"none"},children:[E.jsx("img",{src:r,alt:"Bondfire",width:28,height:28,onError:o(n=>{n.currentTarget.style.display="none"},"onError"),style:{display:"block"}}),E.jsx("span",{style:{color:"var(--bfBrand, #fff)",fontWeight:700},children:"Bondfire"})]})},"Brand");function wU(){const r=uC();if(!r)return null;const e=`/org/${r}`,t={padding:"8px 12px",borderRadius:8,background:"#a40b12",color:"#fff",border:"1px solid #7a0c12",textDecoration:"none",fontWeight:500,transition:"background 0.2s ease, transform 0.1s ease"},n={background:"#8e0a10"},i={background:"#cc0f1a",fontWeight:700};return E.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginRight:12},children:[["Dashboard",`${e}/overview`],["People",`${e}/people`],["Inventory",`${e}/inventory`],["Needs",`${e}/needs`],["Meetings",`${e}/meetings`],["Settings",`${e}/settings`],["Public",`${e}/public`],["Chat",`${e}/chat`]].map(([a,s])=>E.jsx(WP,{to:s,className:"btn",style:o(({isActive:l})=>({...t,...l?i:{}}),"style"),onMouseEnter:o(l=>Object.assign(l.currentTarget.style,n),"onMouseEnter"),onMouseLeave:o(l=>Object.assign(l.currentTarget.style,t),"onMouseLeave"),children:a},s))})}o(wU,"OrgNav");function TU({onLogout:r,showLogout:e}){return E.jsxs("header",{style:{position:"sticky",top:0,zIndex:30,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 14px",borderBottom:"1px solid #1f2937",background:"#0f0f10"},children:[E.jsx(bU,{}),E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx(wU,{}),e&&E.jsx("button",{onClick:r,className:"btn",style:{padding:"8px 12px",borderRadius:8,background:"#a40b12",color:"#fff",border:"1px solid #7a0c12",cursor:"pointer",transition:"background 0.2s ease, transform 0.1s ease"},onMouseEnter:o(t=>t.currentTarget.style.background="#8e0a10","onMouseEnter"),onMouseLeave:o(t=>t.currentTarget.style.background="#a40b12","onMouseLeave"),title:"Logout",children:"Logout"})]})]})}o(TU,"AppHeader");function RU({children:r}){var i,a;if(!((((a=(i=import.meta)==null?void 0:i.env)==null?void 0:a.VITE_REQUIRE_ORG_SECRET)||"off")==="on"))return r;const t=localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token"),n=localStorage.getItem("bf_org_secret");return t&&n?r:E.jsx(el,{to:"/signin",replace:!0})}o(RU,"OrgSecretGuard");const gE=class gE extends tg.Component{constructor(e){super(e),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,t){console.error("App error boundary:",e),console.error("App error boundary stack:",e==null?void 0:e.stack),console.error("App error boundary component stack:",t==null?void 0:t.componentStack)}render(){return this.state.error?E.jsxs("div",{style:{padding:16},children:[E.jsx("h2",{style:{color:"crimson"},children:"Something broke."}),E.jsx("pre",{style:{whiteSpace:"pre-wrap"},children:String(this.state.error)})]}):this.props.children}};o(gE,"ErrorBoundary");let Qm=gE;function Ey(){return localStorage.getItem("bf_auth_token")||sessionStorage.getItem("bf_auth_token")}o(Ey,"getToken");function K0({children:r}){const e=Ey(),t=localStorage.getItem("demo_user");return!e&&!t?E.jsx(el,{to:"/signin",replace:!0}):r}o(K0,"RequireAuth");function IU(){try{localStorage.removeItem("bf_auth_token"),sessionStorage.removeItem("bf_auth_token"),localStorage.removeItem("demo_user")}catch{}window.location.hash="#/signin",window.location.reload()}o(IU,"logoutEverywhere");function CU(){const r=Tn(),e=Ey(),t=r.pathname||"/",n=t==="/"||t==="/orgs"||t.startsWith("/p/")||t==="/signin";if(!e||n)return null;const i={position:"fixed",top:10,left:140,zIndex:1e3,padding:"6px 10px",fontSize:12,borderRadius:8,background:"#111",color:"#eee",border:"1px solid #333",cursor:"pointer",opacity:.9};return E.jsx("button",{title:"Logout",style:i,onClick:IU,children:"Logout"})}o(CU,"GlobalLogoutButton");function OU(){const e=Tn().pathname||"/",t=!!Ey(),n=o(()=>t?E.jsx(el,{to:"/orgs",replace:!0}):E.jsx(el,{to:"/signin",replace:!0}),"HomeRoute"),i=e==="/"||e.startsWith("/p/")||e==="/signin";return E.jsxs(E.Fragment,{children:[!i&&E.jsx(TU,{}),E.jsx(CU,{}),E.jsxs(MP,{children:[E.jsx(Rt,{path:"/p/:slug",element:E.jsx(Yd,{})}),E.jsx(Rt,{path:"/p/*",element:E.jsx(Yd,{})}),E.jsx(Rt,{path:"/signin",element:E.jsx(_U,{})}),E.jsx(Rt,{path:"/",element:E.jsx(n,{})}),E.jsx(Rt,{path:"/orgs",element:E.jsx(K0,{children:E.jsx(nM,{})})}),E.jsxs(Rt,{path:"/org/:orgId/*",element:E.jsx(K0,{children:E.jsx(sM,{})}),children:[E.jsx(Rt,{index:!0,element:E.jsx(N_,{})}),E.jsx(Rt,{path:"overview",element:E.jsx(N_,{})}),E.jsx(Rt,{path:"people",element:E.jsx(lM,{})}),E.jsx(Rt,{path:"inventory",element:E.jsx(dM,{})}),E.jsx(Rt,{path:"needs",element:E.jsx(mM,{})}),E.jsx(Rt,{path:"meetings",element:E.jsx(hM,{})}),E.jsx(Rt,{path:"meetings/:meetingId",element:E.jsx(vM,{})}),E.jsx(Rt,{path:"settings",element:E.jsx(SM,{})}),E.jsx(Rt,{path:"public",element:E.jsx(XP,{})}),E.jsx(Rt,{path:"chat",element:E.jsx(EU,{})}),E.jsx(Rt,{path:"guard/*",element:E.jsx(RU,{})})]}),E.jsx(Rt,{path:"*",element:E.jsx(el,{to:"/",replace:!0})})]})]})}o(OU,"Shell");function kU(){return E.jsx(FP,{children:E.jsx(Qm,{children:E.jsx(OU,{})})})}o(kU,"App");const dC=new Date().toISOString()+" #"+Math.floor(Math.random()*1e6);console.log("BOND build:",dC);window.__BF_BUILD=dC;rR(document.getElementById("root")).render(E.jsx(tg.StrictMode,{children:E.jsx(kU,{})}));export{l0 as A,o0 as B,Ct as C,mN as D,F as E,LU as F,UU as G,ly as H,DU as I,Ke as J,ke as K,tb as L,G as M,zs as N,yN as O,ea as S,Qe as T,u0 as U,AU as V,R as _,f as a,xU as b,Ch as c,ha as d,se as e,fI as f,nh as g,eC as h,Bm as i,Li as j,hN as k,MU as l,Rn as m,Uf as n,ft as o,It as p,Tm as q,al as r,du as s,Th as t,d0 as u,NU as v,ki as w,We as x,Yr as y,Bc as z};
//# sourceMappingURL=index-Cre-vLzQ.js.map
